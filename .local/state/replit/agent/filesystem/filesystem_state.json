{"file_contents":{"client/src/pages/Clients.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { ClientCard } from \"@/components/clients/ClientCard\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { StatusBadge } from \"@/components/shared/StatusBadge\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n  DialogDescription,\n} from \"@/components/ui/dialog\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Plus,\n  Search,\n  Phone,\n  Mail,\n  MapPin,\n  FileText,\n  Briefcase,\n  DollarSign,\n  Users,\n  Pencil,\n  Trash2,\n  Download,\n} from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Client, Quote, Job, InsertClient } from \"@shared/schema\";\n\ninterface DisplayClient {\n  id: string;\n  name: string;\n  phone: string;\n  email: string;\n  address: string;\n  clientType: \"public\" | \"trade\";\n  tradeDiscountLevel?: number;\n  totalQuotes: number;\n  totalJobs: number;\n  totalSpent: number;\n  notes?: string;\n  createdAt: string;\n}\n\nexport default function Clients() {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [selectedClientId, setSelectedClientId] = useState<string | null>(null);\n  const [filterType, setFilterType] = useState<\"all\" | \"public\" | \"trade\">(\"all\");\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);\n  const [editingClient, setEditingClient] = useState<Client | null>(null);\n  const [formData, setFormData] = useState({\n    name: \"\",\n    phone: \"\",\n    email: \"\",\n    address: \"\",\n    clientType: \"public\" as \"public\" | \"trade\",\n    tradeDiscountLevel: \"\",\n    notes: \"\",\n  });\n\n  const { data: clients = [], isLoading: clientsLoading } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const { data: quotes = [] } = useQuery<Quote[]>({\n    queryKey: [\"/api/quotes\"],\n  });\n\n  const { data: jobs = [] } = useQuery<Job[]>({\n    queryKey: [\"/api/jobs\"],\n  });\n\n  const createClientMutation = useMutation({\n    mutationFn: async (data: InsertClient) => {\n      return apiRequest(\"POST\", \"/api/clients\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/clients\"] });\n      toast({\n        title: \"Client Created\",\n        description: \"New client has been added successfully\",\n      });\n      setIsDialogOpen(false);\n      resetForm();\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to create client\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateClientMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<InsertClient> }) => {\n      return apiRequest(\"PATCH\", `/api/clients/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/clients\"] });\n      toast({\n        title: \"Client Updated\",\n        description: \"Client information has been updated\",\n      });\n      setIsEditDialogOpen(false);\n      setEditingClient(null);\n      resetForm();\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to update client\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteClientMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/clients/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/clients\"] });\n      toast({\n        title: \"Client Deleted\",\n        description: \"Client has been removed\",\n      });\n      setIsDeleteDialogOpen(false);\n      setSelectedClientId(null);\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to delete client\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleEditClient = (client: Client) => {\n    setEditingClient(client);\n    setFormData({\n      name: client.name,\n      phone: client.phone || \"\",\n      email: client.email || \"\",\n      address: client.address || \"\",\n      clientType: client.clientType as \"public\" | \"trade\",\n      tradeDiscountLevel: client.tradeDiscountLevel || \"\",\n      notes: client.notes || \"\",\n    });\n    setIsEditDialogOpen(true);\n  };\n\n  const handleSubmitEdit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!editingClient || !formData.name || !formData.phone) {\n      toast({\n        title: \"Error\",\n        description: \"Name and phone are required\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    updateClientMutation.mutate({\n      id: editingClient.id,\n      data: {\n        name: formData.name,\n        phone: formData.phone,\n        email: formData.email || undefined,\n        address: formData.address || undefined,\n        clientType: formData.clientType,\n        tradeDiscountLevel: formData.clientType === \"trade\" && formData.tradeDiscountLevel\n          ? (formData.tradeDiscountLevel as \"gold\" | \"silver\" | \"bronze\") \n          : undefined,\n        notes: formData.notes || undefined,\n      },\n    });\n  };\n\n  const resetForm = () => {\n    setFormData({\n      name: \"\",\n      phone: \"\",\n      email: \"\",\n      address: \"\",\n      clientType: \"public\",\n      tradeDiscountLevel: \"\",\n      notes: \"\",\n    });\n  };\n\n  const getDiscountPercent = (level: string | null): number | undefined => {\n    switch (level) {\n      case \"gold\": return 20;\n      case \"silver\": return 15;\n      case \"bronze\": return 10;\n      default: return undefined;\n    }\n  };\n\n  const displayClients: DisplayClient[] = clients.map((client) => {\n    const clientQuotes = quotes.filter(q => q.clientId === client.id);\n    const clientJobs = jobs.filter(j => j.clientId === client.id);\n    const completedStatuses = [\"install_complete\", \"final_payment_pending\", \"completed\"];\n    const totalSpent = clientJobs\n      .filter(j => completedStatuses.includes(j.status))\n      .reduce((sum, j) => sum + parseFloat(j.totalAmount), 0);\n\n    return {\n      id: client.id,\n      name: client.name,\n      phone: client.phone || \"\",\n      email: client.email || \"\",\n      address: client.address || \"\",\n      clientType: client.clientType as \"public\" | \"trade\",\n      tradeDiscountLevel: getDiscountPercent(client.tradeDiscountLevel),\n      totalQuotes: clientQuotes.length,\n      totalJobs: clientJobs.length,\n      totalSpent,\n      notes: client.notes || undefined,\n      createdAt: new Date(client.createdAt).toLocaleDateString(\"en-AU\", { month: \"short\", year: \"numeric\" }),\n    };\n  });\n\n  const selectedClient = displayClients.find(c => c.id === selectedClientId) || null;\n\n  const filteredClients = displayClients.filter((client) => {\n    const matchesSearch =\n      client.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      client.email.toLowerCase().includes(searchQuery.toLowerCase());\n    const matchesType =\n      filterType === \"all\" || client.clientType === filterType;\n    return matchesSearch && matchesType;\n  });\n\n  const handleClientClick = (client: DisplayClient) => {\n    setSelectedClientId(client.id);\n  };\n\n  const handleSubmitClient = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!formData.name || !formData.phone) {\n      toast({\n        title: \"Error\",\n        description: \"Name and phone are required\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    createClientMutation.mutate({\n      name: formData.name,\n      phone: formData.phone,\n      email: formData.email || undefined,\n      address: formData.address || undefined,\n      clientType: formData.clientType,\n      tradeDiscountLevel: formData.clientType === \"trade\" && formData.tradeDiscountLevel\n        ? (formData.tradeDiscountLevel as \"gold\" | \"silver\" | \"bronze\") \n        : undefined,\n      notes: formData.notes || undefined,\n    });\n  };\n\n  if (clientsLoading) {\n    return (\n      <div className=\"flex h-[calc(100vh-3.5rem)]\">\n        <div className=\"w-96 border-r p-4\">\n          <Skeleton className=\"h-10 w-full mb-4\" />\n          <Skeleton className=\"h-10 w-full mb-4\" />\n          <Skeleton className=\"h-24 mb-2\" />\n          <Skeleton className=\"h-24 mb-2\" />\n          <Skeleton className=\"h-24\" />\n        </div>\n        <div className=\"flex-1 p-6\">\n          <Skeleton className=\"h-full\" />\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex h-[calc(100vh-3.5rem)]\">\n      <div className=\"w-96 border-r flex flex-col\">\n        <div className=\"p-4 border-b space-y-4\">\n          <div className=\"flex items-center justify-between gap-2\">\n            <h1 className=\"text-xl font-semibold\" data-testid=\"text-clients-title\">Clients</h1>\n            <div className=\"flex gap-1\">\n              <Button \n                variant=\"outline\" \n                size=\"sm\"\n                onClick={() => window.open(\"/api/export/clients\", \"_blank\")}\n                data-testid=\"button-export-clients\"\n              >\n                <Download className=\"h-4 w-4\" />\n              </Button>\n              <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n                <DialogTrigger asChild>\n                  <Button size=\"sm\" data-testid=\"button-new-client\">\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    New Client\n                  </Button>\n                </DialogTrigger>\n              <DialogContent className=\"sm:max-w-md\">\n                <DialogHeader>\n                  <DialogTitle>Add New Client</DialogTitle>\n                </DialogHeader>\n                <form onSubmit={handleSubmitClient} className=\"space-y-4\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"name\">Client Name</Label>\n                    <Input \n                      id=\"name\" \n                      placeholder=\"Enter name\" \n                      value={formData.name}\n                      onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                      data-testid=\"input-client-name\" \n                    />\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"phone\">Phone</Label>\n                      <Input \n                        id=\"phone\" \n                        placeholder=\"0400 000 000\" \n                        value={formData.phone}\n                        onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\n                        data-testid=\"input-phone\" \n                      />\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"email\">Email</Label>\n                      <Input \n                        id=\"email\" \n                        type=\"email\" \n                        placeholder=\"email@example.com\" \n                        value={formData.email}\n                        onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                        data-testid=\"input-email\" \n                      />\n                    </div>\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"address\">Address</Label>\n                    <Input \n                      id=\"address\" \n                      placeholder=\"Enter address\" \n                      value={formData.address}\n                      onChange={(e) => setFormData({ ...formData, address: e.target.value })}\n                      data-testid=\"input-address\" \n                    />\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"clientType\">Client Type</Label>\n                      <Select \n                        value={formData.clientType}\n                        onValueChange={(value: \"public\" | \"trade\") => setFormData({ ...formData, clientType: value })}\n                      >\n                        <SelectTrigger data-testid=\"select-client-type\">\n                          <SelectValue placeholder=\"Select type\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"public\">Public</SelectItem>\n                          <SelectItem value=\"trade\">Trade</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    {formData.clientType === \"trade\" && (\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"discount\">Trade Level</Label>\n                        <Select \n                          value={formData.tradeDiscountLevel}\n                          onValueChange={(value) => setFormData({ ...formData, tradeDiscountLevel: value })}\n                        >\n                          <SelectTrigger data-testid=\"select-discount\">\n                            <SelectValue placeholder=\"Select level\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"bronze\">Bronze (10%)</SelectItem>\n                            <SelectItem value=\"silver\">Silver (15%)</SelectItem>\n                            <SelectItem value=\"gold\">Gold (20%)</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n                    )}\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"notes\">Notes</Label>\n                    <Textarea \n                      id=\"notes\" \n                      placeholder=\"Add notes...\" \n                      value={formData.notes}\n                      onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n                      data-testid=\"textarea-notes\" \n                    />\n                  </div>\n                  <div className=\"flex justify-end gap-2\">\n                    <Button type=\"button\" variant=\"outline\" onClick={() => setIsDialogOpen(false)}>\n                      Cancel\n                    </Button>\n                    <Button \n                      type=\"submit\" \n                      disabled={createClientMutation.isPending}\n                      data-testid=\"button-submit-client\"\n                    >\n                      {createClientMutation.isPending ? \"Adding...\" : \"Add Client\"}\n                    </Button>\n                  </div>\n                </form>\n              </DialogContent>\n            </Dialog>\n            </div>\n          </div>\n          <div className=\"relative\">\n            <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n            <Input\n              placeholder=\"Search clients...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"pl-9\"\n              data-testid=\"input-search-clients\"\n            />\n          </div>\n          <Tabs value={filterType} onValueChange={(v) => setFilterType(v as typeof filterType)}>\n            <TabsList className=\"w-full\">\n              <TabsTrigger value=\"all\" className=\"flex-1\" data-testid=\"tab-all-clients\">All</TabsTrigger>\n              <TabsTrigger value=\"public\" className=\"flex-1\" data-testid=\"tab-public-clients\">Public</TabsTrigger>\n              <TabsTrigger value=\"trade\" className=\"flex-1\" data-testid=\"tab-trade-clients\">Trade</TabsTrigger>\n            </TabsList>\n          </Tabs>\n        </div>\n        <ScrollArea className=\"flex-1\">\n          <div className=\"p-4 space-y-3\">\n            {filteredClients.map((client) => (\n              <div\n                key={client.id}\n                className={`cursor-pointer ${selectedClientId === client.id ? \"ring-2 ring-accent rounded-md\" : \"\"}`}\n                onClick={() => handleClientClick(client)}\n              >\n                <ClientCard\n                  client={client}\n                  onCreateQuote={() => toast({ title: \"Creating quote\" })}\n                  onAddNote={() => toast({ title: \"Adding note\" })}\n                  onViewHistory={() => toast({ title: \"Viewing history\" })}\n                />\n              </div>\n            ))}\n            {filteredClients.length === 0 && (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <p className=\"text-sm\">No clients found</p>\n              </div>\n            )}\n          </div>\n        </ScrollArea>\n      </div>\n\n      <div className=\"flex-1 overflow-auto\">\n        {selectedClient ? (\n          <div className=\"p-6 space-y-6\">\n            <div className=\"flex items-start justify-between\">\n              <div>\n                <div className=\"flex items-center gap-3 mb-2\">\n                  <StatusBadge status={selectedClient.clientType} />\n                  {selectedClient.tradeDiscountLevel && (\n                    <Badge variant=\"secondary\">\n                      {selectedClient.tradeDiscountLevel}% Trade Discount\n                    </Badge>\n                  )}\n                </div>\n                <h2 className=\"text-2xl font-semibold\">{selectedClient.name}</h2>\n                <p className=\"text-muted-foreground\">Client since {selectedClient.createdAt}</p>\n              </div>\n              <div className=\"flex gap-2\">\n                <Button \n                  variant=\"outline\" \n                  size=\"icon\"\n                  onClick={() => {\n                    const client = clients.find(c => c.id === selectedClient.id);\n                    if (client) handleEditClient(client);\n                  }}\n                  data-testid=\"button-edit-client\"\n                >\n                  <Pencil className=\"h-4 w-4\" />\n                </Button>\n                <Button \n                  variant=\"outline\" \n                  size=\"icon\"\n                  onClick={() => setIsDeleteDialogOpen(true)}\n                  data-testid=\"button-delete-client\"\n                >\n                  <Trash2 className=\"h-4 w-4\" />\n                </Button>\n                <Button variant=\"outline\" data-testid=\"button-add-note\">Add Note</Button>\n                <Button data-testid=\"button-create-quote\">Create Quote</Button>\n              </div>\n            </div>\n\n            <div className=\"grid grid-cols-3 gap-6\">\n              <Card>\n                <CardHeader className=\"pb-3\">\n                  <CardTitle className=\"text-sm font-medium\">Contact Information</CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div className=\"flex items-center gap-2 text-sm\">\n                    <Phone className=\"h-4 w-4 text-muted-foreground\" />\n                    <span>{selectedClient.phone || \"No phone\"}</span>\n                  </div>\n                  <div className=\"flex items-center gap-2 text-sm\">\n                    <Mail className=\"h-4 w-4 text-muted-foreground\" />\n                    <span>{selectedClient.email || \"No email\"}</span>\n                  </div>\n                  <div className=\"flex items-start gap-2 text-sm\">\n                    <MapPin className=\"h-4 w-4 text-muted-foreground mt-0.5\" />\n                    <span>{selectedClient.address || \"No address\"}</span>\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader className=\"pb-3\">\n                  <CardTitle className=\"text-sm font-medium\">Activity Summary</CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div className=\"flex items-center justify-between text-sm\">\n                    <div className=\"flex items-center gap-2\">\n                      <FileText className=\"h-4 w-4 text-muted-foreground\" />\n                      <span>Total Quotes</span>\n                    </div>\n                    <span className=\"font-semibold\">{selectedClient.totalQuotes}</span>\n                  </div>\n                  <div className=\"flex items-center justify-between text-sm\">\n                    <div className=\"flex items-center gap-2\">\n                      <Briefcase className=\"h-4 w-4 text-muted-foreground\" />\n                      <span>Total Jobs</span>\n                    </div>\n                    <span className=\"font-semibold\">{selectedClient.totalJobs}</span>\n                  </div>\n                  <div className=\"flex items-center justify-between text-sm\">\n                    <div className=\"flex items-center gap-2\">\n                      <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n                      <span>Total Spent</span>\n                    </div>\n                    <span className=\"font-semibold\">${selectedClient.totalSpent.toLocaleString()}</span>\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader className=\"pb-3\">\n                  <CardTitle className=\"text-sm font-medium\">Notes</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {selectedClient.notes ? (\n                    <p className=\"text-sm text-muted-foreground\">{selectedClient.notes}</p>\n                  ) : (\n                    <p className=\"text-sm text-muted-foreground italic\">No notes added</p>\n                  )}\n                </CardContent>\n              </Card>\n            </div>\n\n            <Tabs defaultValue=\"quotes\">\n              <TabsList>\n                <TabsTrigger value=\"quotes\" data-testid=\"tab-quotes\">Quotes</TabsTrigger>\n                <TabsTrigger value=\"jobs\" data-testid=\"tab-jobs\">Jobs</TabsTrigger>\n                <TabsTrigger value=\"documents\" data-testid=\"tab-documents\">Documents</TabsTrigger>\n              </TabsList>\n\n              <TabsContent value=\"quotes\" className=\"mt-6\">\n                <Card>\n                  <CardContent className=\"p-6\">\n                    {quotes.filter(q => q.clientId === selectedClient.id).length > 0 ? (\n                      <div className=\"space-y-2\">\n                        {quotes.filter(q => q.clientId === selectedClient.id).map((quote) => (\n                          <div key={quote.id} className=\"flex items-center justify-between p-3 border rounded hover-elevate cursor-pointer\">\n                            <div>\n                              <p className=\"font-mono text-sm\">{quote.quoteNumber}</p>\n                              <p className=\"text-sm text-muted-foreground\">{quote.siteAddress}</p>\n                            </div>\n                            <div className=\"text-right\">\n                              <p className=\"font-semibold\">${parseFloat(quote.totalAmount).toLocaleString()}</p>\n                              <StatusBadge status={quote.status} />\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    ) : (\n                      <div className=\"text-center py-8 text-muted-foreground\">\n                        <FileText className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n                        <p className=\"text-sm\">No quotes yet</p>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              </TabsContent>\n\n              <TabsContent value=\"jobs\" className=\"mt-6\">\n                <Card>\n                  <CardContent className=\"p-6\">\n                    {jobs.filter(j => j.clientId === selectedClient.id).length > 0 ? (\n                      <div className=\"space-y-2\">\n                        {jobs.filter(j => j.clientId === selectedClient.id).map((job) => (\n                          <div key={job.id} className=\"flex items-center justify-between p-3 border rounded hover-elevate cursor-pointer\">\n                            <div>\n                              <p className=\"font-mono text-sm\">{job.jobNumber}</p>\n                              <p className=\"text-sm text-muted-foreground\">{job.siteAddress}</p>\n                            </div>\n                            <div className=\"text-right\">\n                              <p className=\"font-semibold\">${parseFloat(job.totalAmount).toLocaleString()}</p>\n                              <StatusBadge status={job.status} />\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    ) : (\n                      <div className=\"text-center py-8 text-muted-foreground\">\n                        <Briefcase className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n                        <p className=\"text-sm\">No jobs yet</p>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              </TabsContent>\n\n              <TabsContent value=\"documents\" className=\"mt-6\">\n                <Card>\n                  <CardContent className=\"p-6\">\n                    <div className=\"text-center py-8 text-muted-foreground\">\n                      <FileText className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n                      <p className=\"text-sm\">Documents will appear here</p>\n                    </div>\n                  </CardContent>\n                </Card>\n              </TabsContent>\n            </Tabs>\n          </div>\n        ) : (\n          <div className=\"flex items-center justify-center h-full text-muted-foreground\">\n            <div className=\"text-center\">\n              <Users className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n              <p className=\"text-sm\">Select a client to view details</p>\n            </div>\n          </div>\n        )}\n      </div>\n\n      <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Edit Client</DialogTitle>\n            <DialogDescription>Update client information</DialogDescription>\n          </DialogHeader>\n          <form onSubmit={handleSubmitEdit} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-name\">Client Name</Label>\n              <Input \n                id=\"edit-name\" \n                placeholder=\"Enter name\" \n                value={formData.name}\n                onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                data-testid=\"input-edit-client-name\" \n              />\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-phone\">Phone</Label>\n                <Input \n                  id=\"edit-phone\" \n                  placeholder=\"0400 000 000\" \n                  value={formData.phone}\n                  onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\n                  data-testid=\"input-edit-phone\" \n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-email\">Email</Label>\n                <Input \n                  id=\"edit-email\" \n                  type=\"email\" \n                  placeholder=\"email@example.com\" \n                  value={formData.email}\n                  onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                  data-testid=\"input-edit-email\" \n                />\n              </div>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-address\">Address</Label>\n              <Input \n                id=\"edit-address\" \n                placeholder=\"Enter address\" \n                value={formData.address}\n                onChange={(e) => setFormData({ ...formData, address: e.target.value })}\n                data-testid=\"input-edit-address\" \n              />\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-clientType\">Client Type</Label>\n                <Select \n                  value={formData.clientType}\n                  onValueChange={(value: \"public\" | \"trade\") => setFormData({ ...formData, clientType: value })}\n                >\n                  <SelectTrigger data-testid=\"select-edit-client-type\">\n                    <SelectValue placeholder=\"Select type\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"public\">Public</SelectItem>\n                    <SelectItem value=\"trade\">Trade</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              {formData.clientType === \"trade\" && (\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"edit-discount\">Trade Level</Label>\n                  <Select \n                    value={formData.tradeDiscountLevel}\n                    onValueChange={(value) => setFormData({ ...formData, tradeDiscountLevel: value })}\n                  >\n                    <SelectTrigger data-testid=\"select-edit-discount\">\n                      <SelectValue placeholder=\"Select level\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"bronze\">Bronze (10%)</SelectItem>\n                      <SelectItem value=\"silver\">Silver (15%)</SelectItem>\n                      <SelectItem value=\"gold\">Gold (20%)</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              )}\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-notes\">Notes</Label>\n              <Textarea \n                id=\"edit-notes\" \n                placeholder=\"Add notes...\" \n                value={formData.notes}\n                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n                data-testid=\"textarea-edit-notes\" \n              />\n            </div>\n            <div className=\"flex justify-end gap-2\">\n              <Button type=\"button\" variant=\"outline\" onClick={() => setIsEditDialogOpen(false)}>\n                Cancel\n              </Button>\n              <Button \n                type=\"submit\" \n                disabled={updateClientMutation.isPending}\n                data-testid=\"button-save-client\"\n              >\n                {updateClientMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n              </Button>\n            </div>\n          </form>\n        </DialogContent>\n      </Dialog>\n\n      <AlertDialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Delete Client</AlertDialogTitle>\n            <AlertDialogDescription>\n              Are you sure you want to delete \"{selectedClient?.name}\"? This action cannot be undone.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => selectedClientId && deleteClientMutation.mutate(selectedClientId)}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              data-testid=\"button-confirm-delete\"\n            >\n              {deleteClientMutation.isPending ? \"Deleting...\" : \"Delete\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":32339,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, integer, decimal, boolean, timestamp, jsonb, pgEnum } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Enums\nexport const userRoleEnum = pgEnum(\"user_role\", [\n  \"admin\",\n  \"sales\",\n  \"scheduler\",\n  \"production_manager\",\n  \"warehouse\",\n  \"installer\",\n  \"trade_client\"\n]);\n\nexport const clientTypeEnum = pgEnum(\"client_type\", [\"public\", \"trade\"]);\n\nexport const tradeDiscountLevelEnum = pgEnum(\"trade_discount_level\", [\n  \"bronze\",\n  \"silver\",\n  \"gold\",\n  \"platinum\"\n]);\n\nexport const leadStageEnum = pgEnum(\"lead_stage\", [\n  \"new\",\n  \"contacted\",\n  \"needs_quote\",\n  \"quote_sent\",\n  \"follow_up\",\n  \"won\",\n  \"lost\"\n]);\n\nexport const leadSourceEnum = pgEnum(\"lead_source\", [\n  \"website\",\n  \"phone\",\n  \"referral\",\n  \"trade\",\n  \"walk_in\",\n  \"social_media\",\n  \"other\",\n  \"direct_job\"\n]);\n\nexport const quoteStatusEnum = pgEnum(\"quote_status\", [\n  \"draft\",\n  \"sent\",\n  \"send_failed\",\n  \"approved\",\n  \"declined\",\n  \"expired\",\n  \"rejected\"\n]);\n\nexport const jobTypeEnum = pgEnum(\"job_type\", [\"supply_only\", \"supply_install\"]);\n\nexport const jobStatusEnum = pgEnum(\"job_status\", [\n  \"accepted\",\n  \"awaiting_deposit\",\n  \"deposit_paid\",\n  \"ready_for_production\",\n  \"manufacturing_posts\",\n  \"manufacturing_panels\",\n  \"manufacturing_gates\",\n  \"qa_check\",\n  \"ready_for_scheduling\",\n  \"scheduled\",\n  \"install_posts\",\n  \"install_panels\",\n  \"install_gates\",\n  \"install_complete\",\n  \"awaiting_final_payment\",\n  \"paid_in_full\",\n  \"archived\"\n]);\n\nexport const productCategoryEnum = pgEnum(\"product_category\", [\n  \"posts\",\n  \"rails\",\n  \"pickets\",\n  \"caps\",\n  \"gates\",\n  \"hardware\",\n  \"accessories\"\n]);\n\nexport const productionTaskTypeEnum = pgEnum(\"production_task_type\", [\n  \"cutting\",\n  \"routing\",\n  \"assembly\",\n  \"qa\"\n]);\n\nexport const productionTaskStatusEnum = pgEnum(\"production_task_status\", [\n  \"pending\",\n  \"in_progress\",\n  \"completed\",\n  \"on_hold\"\n]);\n\nexport const installTaskStatusEnum = pgEnum(\"install_task_status\", [\n  \"scheduled\",\n  \"on_site\",\n  \"in_progress\",\n  \"completed\",\n  \"rescheduled\"\n]);\n\nexport const paymentTypeEnum = pgEnum(\"payment_type\", [\n  \"deposit\",\n  \"final\",\n  \"refund\",\n  \"credit_note\",\n  \"adjustment\"\n]);\n\nexport const paymentMethodEnum = pgEnum(\"payment_method\", [\n  \"stripe\",\n  \"bank_transfer\",\n  \"cash\",\n  \"cheque\"\n]);\n\nexport const scheduleEventTypeEnum = pgEnum(\"schedule_event_type\", [\n  \"install\",\n  \"site_measure\",\n  \"pickup\",\n  \"delivery\",\n  \"production\"\n]);\n\n// Job Setup Document status enum\nexport const jobSetupStatusEnum = pgEnum(\"job_setup_status\", [\n  \"draft\",\n  \"in_progress\",\n  \"ready_for_production\",\n  \"ready_for_scheduling\",\n  \"ready_for_install\",\n  \"completed\"\n]);\n\n// Old fence material enum for job setup\nexport const oldFenceMaterialEnum = pgEnum(\"old_fence_material\", [\n  \"wood\",\n  \"colorbond\",\n  \"limestone\",\n  \"brick\",\n  \"other\",\n  \"none\"\n]);\n\n// Job setup product category enum\nexport const jobSetupProductCategoryEnum = pgEnum(\"job_setup_product_category\", [\n  \"post\",\n  \"rail\",\n  \"panel\",\n  \"cap\",\n  \"gate\",\n  \"hardware\",\n  \"accessory\",\n  \"cement\",\n  \"pallet\",\n  \"other\"\n]);\n\n// Lead activity type enum\nexport const leadActivityTypeEnum = pgEnum(\"lead_activity_type\", [\n  \"call_logged\",\n  \"call_missed\",\n  \"call_scheduled\",\n  \"email_sent\",\n  \"email_received\",\n  \"sms_sent\",\n  \"note_added\",\n  \"quote_created\",\n  \"quote_sent\",\n  \"quote_approved\",\n  \"quote_declined\",\n  \"site_visit_scheduled\",\n  \"site_visit_completed\",\n  \"catalogue_sent\",\n  \"form_sent\",\n  \"lead_created\",\n  \"lead_updated\",\n  \"stage_changed\",\n  \"assigned_changed\",\n  \"converted_to_job\"\n]);\n\n// Lead task status enum\nexport const leadTaskStatusEnum = pgEnum(\"lead_task_status\", [\n  \"pending\",\n  \"in_progress\",\n  \"completed\",\n  \"cancelled\"\n]);\n\n// Lead task priority enum\nexport const leadTaskPriorityEnum = pgEnum(\"lead_task_priority\", [\n  \"low\",\n  \"medium\",\n  \"high\",\n  \"urgent\"\n]);\n\n// Call direction enum for call logs\nexport const callDirectionEnum = pgEnum(\"call_direction\", [\n  \"outbound\",\n  \"inbound\",\n  \"missed\"\n]);\n\n// Transcription status enum for call logs\nexport const transcriptionStatusEnum = pgEnum(\"transcription_status\", [\n  \"pending\",\n  \"processing\",\n  \"completed\",\n  \"failed\",\n  \"not_applicable\"\n]);\n\n// Users table\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  username: text(\"username\").notNull().unique(),\n  password: text(\"password\").notNull(),\n  email: text(\"email\").notNull().unique(),\n  firstName: text(\"first_name\").notNull(),\n  lastName: text(\"last_name\").notNull(),\n  phone: text(\"phone\"),\n  role: userRoleEnum(\"role\").notNull().default(\"sales\"),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  // Staff profile fields\n  positionTitle: text(\"position_title\"),\n  profilePhotoUrl: text(\"profile_photo_url\"),\n  // Bank card number (last 6 digits) for auto-allocating transactions\n  bankCardNumber: varchar(\"bank_card_number\", { length: 6 }),\n});\n\n// Staff Leave Balances table\nexport const staffLeaveBalances = pgTable(\"staff_leave_balances\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id).notNull().unique(),\n  annualLeaveBalanceHours: decimal(\"annual_leave_balance_hours\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  sickLeaveBalanceHours: decimal(\"sick_leave_balance_hours\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  upcomingLeaveStart: timestamp(\"upcoming_leave_start\"),\n  upcomingLeaveEnd: timestamp(\"upcoming_leave_end\"),\n  upcomingLeaveType: text(\"upcoming_leave_type\"), // 'annual' | 'sick' | 'other'\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// Clients table\nexport const clients = pgTable(\"clients\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  phone: text(\"phone\").notNull(),\n  email: text(\"email\"),\n  address: text(\"address\"),\n  clientType: clientTypeEnum(\"client_type\").notNull().default(\"public\"),\n  tradeDiscountLevel: tradeDiscountLevelEnum(\"trade_discount_level\"),\n  companyName: text(\"company_name\"),\n  abn: text(\"abn\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Leads table\nexport const leads = pgTable(\"leads\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  leadNumber: text(\"lead_number\").notNull().unique(),\n  clientId: varchar(\"client_id\").references(() => clients.id),\n  source: leadSourceEnum(\"source\").notNull().default(\"website\"),\n  leadType: clientTypeEnum(\"lead_type\").notNull().default(\"public\"),\n  jobFulfillmentType: jobTypeEnum(\"job_fulfillment_type\").default(\"supply_install\"),\n  description: text(\"description\"),\n  siteAddress: text(\"site_address\"),\n  measurementsProvided: boolean(\"measurements_provided\").default(false),\n  fenceLength: decimal(\"fence_length\", { precision: 10, scale: 2 }),\n  fenceStyle: text(\"fence_style\"),\n  stage: leadStageEnum(\"stage\").notNull().default(\"new\"),\n  assignedTo: varchar(\"assigned_to\").references(() => users.id),\n  followUpDate: timestamp(\"follow_up_date\"),\n  notes: text(\"notes\"),\n  // Opportunity value tracking\n  opportunityValue: decimal(\"opportunity_value\", { precision: 10, scale: 2 }),\n  primaryQuoteId: varchar(\"primary_quote_id\"), // References quotes.id - no FK to avoid circular ref\n  // Analytics timestamp fields for KPI tracking\n  firstResponseAt: timestamp(\"first_response_at\"), // When lead was first contacted\n  quoteSentAt: timestamp(\"quote_sent_at\"), // When first quote was sent\n  wonAt: timestamp(\"won_at\"), // When lead was converted to job\n  lostAt: timestamp(\"lost_at\"), // When lead was marked as lost\n  lostReason: text(\"lost_reason\"), // Reason for losing the lead\n  // Soil/site assessment data\n  soilWarning: text(\"soil_warning\"), // Short label: LIMESTONE, CLAY, ROCK, etc.\n  soilInstallNotes: text(\"soil_install_notes\"), // Full installation notes\n  siteLatitude: decimal(\"site_latitude\", { precision: 10, scale: 7 }),\n  siteLongitude: decimal(\"site_longitude\", { precision: 10, scale: 7 }),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// Lead Activities table - activity log for leads\nexport const leadActivities = pgTable(\"lead_activities\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  leadId: varchar(\"lead_id\").references(() => leads.id).notNull(),\n  activityType: leadActivityTypeEnum(\"activity_type\").notNull(),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  metadata: jsonb(\"metadata\").$type<Record<string, unknown>>(),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  \n  // Call-specific fields (used when activityType is call_logged/call_missed/call_scheduled)\n  callDirection: callDirectionEnum(\"call_direction\"),\n  callTimestamp: timestamp(\"call_timestamp\"),\n  callDurationSeconds: integer(\"call_duration_seconds\"),\n  staffMemberId: varchar(\"staff_member_id\").references(() => users.id),\n  callNotes: text(\"call_notes\"),\n  audioRecordingUrl: text(\"audio_recording_url\"),\n  aiSummaryText: text(\"ai_summary_text\"),\n  callTranscriptionText: text(\"call_transcription_text\"),\n  transcriptionStatus: transcriptionStatusEnum(\"transcription_status\").default(\"not_applicable\"),\n});\n\n// Lead Tasks table - follow-up reminders and tasks for leads\nexport const leadTasks = pgTable(\"lead_tasks\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  leadId: varchar(\"lead_id\").references(() => leads.id).notNull(),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  dueDate: timestamp(\"due_date\"),\n  priority: leadTaskPriorityEnum(\"priority\").notNull().default(\"medium\"),\n  status: leadTaskStatusEnum(\"status\").notNull().default(\"pending\"),\n  assignedTo: varchar(\"assigned_to\").references(() => users.id),\n  completedAt: timestamp(\"completed_at\"),\n  completedBy: varchar(\"completed_by\").references(() => users.id),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n  // Link task back to a specific activity (e.g., task created from a call log)\n  sourceActivityId: varchar(\"source_activity_id\").references(() => leadActivities.id),\n});\n\n// Fence Styles table\nexport const fenceStyles = pgTable(\"fence_styles\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull().unique(),\n  description: text(\"description\"),\n  standardHeights: jsonb(\"standard_heights\").$type<number[]>(),\n  postTypes: jsonb(\"post_types\").$type<string[]>(),\n  picketSpacingOptions: jsonb(\"picket_spacing_options\").$type<number[]>(),\n  basePrice: decimal(\"base_price\", { precision: 10, scale: 2 }),\n  isActive: boolean(\"is_active\").notNull().default(true),\n});\n\n// Products table\nexport const products = pgTable(\"products\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  sku: text(\"sku\").notNull().unique(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  category: productCategoryEnum(\"category\").notNull(),\n  dimensions: text(\"dimensions\"),\n  color: text(\"color\"),\n  costPrice: decimal(\"cost_price\", { precision: 10, scale: 2 }).notNull(),\n  sellPrice: decimal(\"sell_price\", { precision: 10, scale: 2 }).notNull(),\n  tradePrice: decimal(\"trade_price\", { precision: 10, scale: 2 }),\n  stockOnHand: integer(\"stock_on_hand\").notNull().default(0),\n  reorderPoint: integer(\"reorder_point\").notNull().default(10),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Quotes table\nexport const quotes = pgTable(\"quotes\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  quoteNumber: text(\"quote_number\").notNull().unique(),\n  clientId: varchar(\"client_id\").references(() => clients.id).notNull(),\n  leadId: varchar(\"lead_id\").references(() => leads.id),\n  fenceStyleId: varchar(\"fence_style_id\").references(() => fenceStyles.id),\n  siteAddress: text(\"site_address\"),\n  totalLength: decimal(\"total_length\", { precision: 10, scale: 2 }),\n  fenceHeight: decimal(\"fence_height\", { precision: 10, scale: 2 }),\n  lineItems: jsonb(\"line_items\").$type<QuoteLineItem[]>(),\n  materialsSubtotal: decimal(\"materials_subtotal\", { precision: 10, scale: 2 }),\n  labourEstimate: decimal(\"labour_estimate\", { precision: 10, scale: 2 }),\n  totalAmount: decimal(\"total_amount\", { precision: 10, scale: 2 }).notNull(),\n  depositRequired: decimal(\"deposit_required\", { precision: 10, scale: 2 }),\n  depositPercent: integer(\"deposit_percent\").default(50),\n  status: quoteStatusEnum(\"status\").notNull().default(\"draft\"),\n  isPrimary: boolean(\"is_primary\").default(false),\n  isTradeQuote: boolean(\"is_trade_quote\").default(false),\n  tradeDiscount: decimal(\"trade_discount\", { precision: 5, scale: 2 }),\n  validUntil: timestamp(\"valid_until\"),\n  notes: text(\"notes\"),\n  internalNotes: text(\"internal_notes\"),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  sentAt: timestamp(\"sent_at\"),\n  approvedAt: timestamp(\"approved_at\"),\n});\n\n// Quote Line Item type\nexport type QuoteLineItem = {\n  productId: string;\n  productName: string;\n  quantity: number;\n  unitPrice: number;\n  totalPrice: number;\n  notes?: string;\n};\n\n// Jobs table\nexport const jobs = pgTable(\"jobs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  jobNumber: text(\"job_number\").notNull().unique(),\n  invoiceNumber: text(\"invoice_number\").unique(),\n  clientId: varchar(\"client_id\").references(() => clients.id).notNull(),\n  leadId: varchar(\"lead_id\").references(() => leads.id),\n  quoteId: varchar(\"quote_id\").references(() => quotes.id).notNull(),\n  jobType: jobTypeEnum(\"job_type\").notNull().default(\"supply_install\"),\n  siteAddress: text(\"site_address\").notNull(),\n  status: jobStatusEnum(\"status\").notNull().default(\"accepted\"),\n  fenceStyle: text(\"fence_style\"),\n  totalLength: decimal(\"total_length\", { precision: 10, scale: 2 }),\n  fenceHeight: decimal(\"fence_height\", { precision: 10, scale: 2 }),\n  totalAmount: decimal(\"total_amount\", { precision: 10, scale: 2 }).notNull(),\n  depositAmount: decimal(\"deposit_amount\", { precision: 10, scale: 2 }),\n  depositPaid: boolean(\"deposit_paid\").default(false),\n  depositPaidAt: timestamp(\"deposit_paid_at\"),\n  finalAmount: decimal(\"final_amount\", { precision: 10, scale: 2 }),\n  finalPaid: boolean(\"final_paid\").default(false),\n  finalPaidAt: timestamp(\"final_paid_at\"),\n  assignedInstaller: varchar(\"assigned_installer\").references(() => users.id),\n  scheduledStartDate: timestamp(\"scheduled_start_date\"),\n  scheduledEndDate: timestamp(\"scheduled_end_date\"),\n  actualStartDate: timestamp(\"actual_start_date\"),\n  completionDate: timestamp(\"completion_date\"),\n  notes: text(\"notes\"),\n  installerNotes: text(\"installer_notes\"),\n  variationNotes: text(\"variation_notes\"),\n  photos: jsonb(\"photos\").$type<JobPhoto[]>(),\n  hasGate: boolean(\"has_gate\").default(false),\n  isDelayed: boolean(\"is_delayed\").default(false),\n  pipelineId: varchar(\"pipeline_id\").references(() => jobPipelines.id),\n  isWaitingOnClient: boolean(\"is_waiting_on_client\").default(false),\n  stagesCompleted: jsonb(\"stages_completed\").$type<number[]>().default([]),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// Job Photo type\nexport type JobPhoto = {\n  url: string;\n  type: \"before\" | \"during\" | \"after\" | \"variation\";\n  caption?: string;\n  uploadedAt: string;\n  uploadedBy: string;\n};\n\n// Bill of Materials (BOM) table\nexport const bom = pgTable(\"bom\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  jobId: varchar(\"job_id\").references(() => jobs.id).notNull(),\n  items: jsonb(\"items\").$type<BOMItem[]>(),\n  wastagePercent: decimal(\"wastage_percent\", { precision: 5, scale: 2 }).default(\"5\"),\n  estimatedMachineTime: decimal(\"estimated_machine_time\", { precision: 10, scale: 2 }),\n  estimatedLabourTime: decimal(\"estimated_labour_time\", { precision: 10, scale: 2 }),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// BOM Item type\nexport type BOMItem = {\n  productId: string;\n  productName: string;\n  sku: string;\n  quantity: number;\n  cutLength?: number;\n  notes?: string;\n};\n\n// ============================================\n// JOB SETUP DOCUMENT TYPES (JSONB Sections)\n// ============================================\n\n// Section 1: Sales Setup - Site Conditions & Requirements\nexport type JobSetupSection1Sales = {\n  // Property & Access\n  oldFenceBeingRemoved?: boolean;\n  oldFenceMaterial?: string;\n  oldFenceAgeYears?: string;\n  allFootingsRemoved?: boolean;\n  reticInGround?: boolean;\n  reticNotes?: string;\n  undergroundServicesKnown?: boolean;\n  undergroundServicesNotes?: string;\n  poolArea?: boolean;\n  dogsOnSite?: boolean;\n  lockedGatesOrRestrictedAccess?: boolean;\n  someoneHomeOnInstallDay?: boolean;\n  drivewayAccessDescription?: string;\n  steepOrSlopingSite?: boolean;\n  siteHazardsNotes?: string;\n  \n  // Equipment Required\n  needsCoreDrill?: boolean;\n  needsChainsaw?: boolean;\n  needsAuger?: boolean;\n  needsSkipBin?: boolean;\n  needsExtraLabor?: boolean;\n  equipmentOtherNotes?: string;\n  \n  // Measurements / Fence Layout\n  fenceTotalMetres?: number;\n  fenceHeightMm?: number;\n  numGates?: number;\n  gateOpeningsDescription?: string;\n  rakedOrStepped?: string;\n  panelsLayoutNotes?: string;\n  \n  // Site Plan / Visual\n  sitePlanImageUrl?: string;\n  additionalPhotosUrls?: string[];\n  \n  // Client Confirmation\n  clientConfirmationText?: string;\n  clientSignedSalesSetup?: boolean;\n  clientSignedAt?: string;\n};\n\n// Section 2: Product List / BOM metadata (actual products in job_setup_products table)\nexport type JobSetupSection2ProductsMeta = {\n  autoPopulatedFromQuote?: boolean;\n  quoteId?: string;\n  lastUpdatedBy?: string;\n  lastUpdatedAt?: string;\n  notes?: string;\n};\n\n// Section 3: Production Handover\nexport type JobSetupSection3Production = {\n  postsManufactured?: boolean;\n  panelsManufactured?: boolean;\n  gatesFabricated?: boolean;\n  hardwarePacked?: boolean;\n  accessoriesPacked?: boolean;\n  cementAndMaterialsPrepared?: boolean;\n  productionSpecialNotes?: string;\n  productionCompletedBy?: string;\n  productionCompletedAt?: string;\n};\n\n// Section 4: Scheduling Setup\nexport type JobSetupSection4Schedule = {\n  schedulingReadyForInstall?: boolean;\n  proposedInstallDate?: string;\n  confirmInstallDateWithClient?: boolean;\n  installTimeWindow?: string;\n  installerTeamAssigned?: string;\n  isSupplyOnlyPickup?: boolean;\n  pickupOrDeliveryNotes?: string;\n  schedulerNotes?: string;\n  scheduledBy?: string;\n  scheduledAt?: string;\n  \n  // Equipment summary (derived from Section 1 for visibility)\n  requiresCoreDrill?: boolean;\n  requiresChainsaw?: boolean;\n  requiresAuger?: boolean;\n  requiresSkipBin?: boolean;\n};\n\n// Section 5: Installer Checklist & Client Signoff\nexport type JobSetupSection5Install = {\n  // Pre-start checklist\n  installerCheckedMaterialsComplete?: boolean;\n  installerCheckedToolsLoaded?: boolean;\n  installerConfirmedSiteAccessOk?: boolean;\n  installerReadSiteNotes?: boolean;\n  installerPrestartNotes?: string;\n  installerPrestartCompletedBy?: string;\n  installerPrestartCompletedAt?: string;\n  \n  // Completion on site\n  installCompleted?: boolean;\n  installPhotosUrls?: string[];\n  completionNotes?: string;\n  clientSignedCompletion?: boolean;\n  clientSignedCompletionAt?: string;\n  installerCompletionBy?: string;\n  installerCompletionAt?: string;\n};\n\n// ============================================\n// LIVE DOCUMENT TEMPLATES\n// ============================================\n\n// Template section configuration type\nexport type TemplateSectionConfig = {\n  title?: string;\n  description?: string;\n  enabledFields?: string[];\n  defaultValues?: Record<string, unknown>;\n  requiredBeforeComplete?: string[];\n};\n\n// Live Document Templates - reusable templates for job setup documents\nexport const liveDocumentTemplates = pgTable(\"live_document_templates\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  isDefault: boolean(\"is_default\").default(false),\n  isActive: boolean(\"is_active\").default(true),\n  \n  // Section configurations (customize which fields are shown/required)\n  section1Config: jsonb(\"section1_config\").$type<TemplateSectionConfig>(),\n  section2Config: jsonb(\"section2_config\").$type<TemplateSectionConfig>(),\n  section3Config: jsonb(\"section3_config\").$type<TemplateSectionConfig>(),\n  section4Config: jsonb(\"section4_config\").$type<TemplateSectionConfig>(),\n  section5Config: jsonb(\"section5_config\").$type<TemplateSectionConfig>(),\n  \n  // Default values for new documents\n  section1Defaults: jsonb(\"section1_defaults\").$type<JobSetupSection1Sales>(),\n  section2Defaults: jsonb(\"section2_defaults\").$type<JobSetupSection2ProductsMeta>(),\n  section3Defaults: jsonb(\"section3_defaults\").$type<JobSetupSection3Production>(),\n  section4Defaults: jsonb(\"section4_defaults\").$type<JobSetupSection4Schedule>(),\n  section5Defaults: jsonb(\"section5_defaults\").$type<JobSetupSection5Install>(),\n  \n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\nexport const insertLiveDocumentTemplateSchema = createInsertSchema(liveDocumentTemplates).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertLiveDocumentTemplate = z.infer<typeof insertLiveDocumentTemplateSchema>;\nexport type LiveDocumentTemplate = typeof liveDocumentTemplates.$inferSelect;\n\n// ============================================\n// JOB SETUP DOCUMENT TABLES\n// ============================================\n\n// Job Setup Documents - main document table (now supports lead-level documents too)\nexport const jobSetupDocuments = pgTable(\"job_setup_documents\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  // Can be linked to either a job OR a lead (one must be set)\n  jobId: varchar(\"job_id\").references(() => jobs.id).unique(),\n  leadId: varchar(\"lead_id\").references(() => leads.id),\n  templateId: varchar(\"template_id\").references(() => liveDocumentTemplates.id),\n  jobType: jobTypeEnum(\"job_type\").notNull(),\n  status: jobSetupStatusEnum(\"status\").notNull().default(\"draft\"),\n  \n  // Section completion flags\n  section1Complete: boolean(\"section1_complete\").default(false),\n  section2Complete: boolean(\"section2_complete\").default(false),\n  section3Complete: boolean(\"section3_complete\").default(false),\n  section4Complete: boolean(\"section4_complete\").default(false),\n  section5Complete: boolean(\"section5_complete\").default(false),\n  \n  // JSONB sections\n  section1Sales: jsonb(\"section1_sales\").$type<JobSetupSection1Sales>(),\n  section2ProductsMeta: jsonb(\"section2_products_meta\").$type<JobSetupSection2ProductsMeta>(),\n  section3Production: jsonb(\"section3_production\").$type<JobSetupSection3Production>(),\n  section4Schedule: jsonb(\"section4_schedule\").$type<JobSetupSection4Schedule>(),\n  section5Install: jsonb(\"section5_install\").$type<JobSetupSection5Install>(),\n  \n  // Audit fields\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// Job Setup Products - BOM items for the job setup document\nexport const jobSetupProducts = pgTable(\"job_setup_products\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  jobSetupDocumentId: varchar(\"job_setup_document_id\").references(() => jobSetupDocuments.id).notNull(),\n  productId: varchar(\"product_id\").references(() => products.id),\n  productName: text(\"product_name\").notNull(),\n  sku: text(\"sku\"),\n  category: jobSetupProductCategoryEnum(\"category\").notNull(),\n  quantity: integer(\"quantity\").notNull().default(0),\n  unitInfo: text(\"unit_info\"),\n  notes: text(\"notes\"),\n  sourceQuoteLineId: varchar(\"source_quote_line_id\"),\n  addedBy: varchar(\"added_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// Production Tasks table\nexport const productionTasks = pgTable(\"production_tasks\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  jobId: varchar(\"job_id\").references(() => jobs.id).notNull(),\n  taskType: productionTaskTypeEnum(\"task_type\").notNull(),\n  status: productionTaskStatusEnum(\"status\").notNull().default(\"pending\"),\n  assignedTo: varchar(\"assigned_to\").references(() => users.id),\n  machineUsed: text(\"machine_used\"),\n  startTime: timestamp(\"start_time\"),\n  endTime: timestamp(\"end_time\"),\n  timeSpentMinutes: integer(\"time_spent_minutes\"),\n  notes: text(\"notes\"),\n  qaResult: text(\"qa_result\"),\n  qaPassedAt: timestamp(\"qa_passed_at\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Install Tasks table\nexport const installTasks = pgTable(\"install_tasks\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  jobId: varchar(\"job_id\").references(() => jobs.id).notNull(),\n  scheduledDate: timestamp(\"scheduled_date\").notNull(),\n  installerId: varchar(\"installer_id\").references(() => users.id).notNull(),\n  status: installTaskStatusEnum(\"status\").notNull().default(\"scheduled\"),\n  checkInTime: timestamp(\"check_in_time\"),\n  checkOutTime: timestamp(\"check_out_time\"),\n  notes: text(\"notes\"),\n  variationsFound: text(\"variations_found\"),\n  photos: jsonb(\"photos\").$type<JobPhoto[]>(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Schedule Events table\nexport const scheduleEvents = pgTable(\"schedule_events\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  jobId: varchar(\"job_id\").references(() => jobs.id),\n  eventType: scheduleEventTypeEnum(\"event_type\").notNull(),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  startDate: timestamp(\"start_date\").notNull(),\n  endDate: timestamp(\"end_date\").notNull(),\n  assignedTo: varchar(\"assigned_to\").references(() => users.id),\n  isConfirmed: boolean(\"is_confirmed\").default(false),\n  clientNotified: boolean(\"client_notified\").default(false),\n  installerNotified: boolean(\"installer_notified\").default(false),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Payments table\nexport const payments = pgTable(\"payments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  clientId: varchar(\"client_id\").references(() => clients.id).notNull(),\n  jobId: varchar(\"job_id\").references(() => jobs.id),\n  quoteId: varchar(\"quote_id\").references(() => quotes.id),\n  invoiceNumber: text(\"invoice_number\"),\n  amount: decimal(\"amount\", { precision: 10, scale: 2 }).notNull(),\n  paymentType: paymentTypeEnum(\"payment_type\").notNull(),\n  paymentMethod: paymentMethodEnum(\"payment_method\"),\n  stripePaymentIntentId: text(\"stripe_payment_intent_id\"),\n  stripeSessionId: text(\"stripe_session_id\"),\n  status: text(\"status\").notNull().default(\"pending\"),\n  paidAt: timestamp(\"paid_at\"),\n  xeroInvoiceId: text(\"xero_invoice_id\"),\n  xeroSyncStatus: text(\"xero_sync_status\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Notifications table\nexport const notifications = pgTable(\"notifications\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id),\n  type: text(\"type\").notNull(),\n  title: text(\"title\").notNull(),\n  message: text(\"message\").notNull(),\n  relatedEntityType: text(\"related_entity_type\"),\n  relatedEntityId: varchar(\"related_entity_id\"),\n  isRead: boolean(\"is_read\").default(false),\n  readAt: timestamp(\"read_at\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// SMS Log table\nexport const smsLogs = pgTable(\"sms_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  recipientPhone: text(\"recipient_phone\").notNull(),\n  recipientName: text(\"recipient_name\"),\n  message: text(\"message\").notNull(),\n  twilioMessageSid: text(\"twilio_message_sid\"),\n  status: text(\"status\").notNull().default(\"pending\"),\n  isOutbound: boolean(\"is_outbound\").notNull().default(true),\n  isRead: boolean(\"is_read\").notNull().default(false),\n  relatedEntityType: text(\"related_entity_type\"),\n  relatedEntityId: varchar(\"related_entity_id\"),\n  sentAt: timestamp(\"sent_at\"),\n  deliveredAt: timestamp(\"delivered_at\"),\n  errorMessage: text(\"error_message\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// SMS Conversations table - tracks conversation metadata per phone number\nexport const smsConversations = pgTable(\"sms_conversations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  phoneNumber: text(\"phone_number\").notNull().unique(),\n  clientId: varchar(\"client_id\").references(() => clients.id),\n  assignedTo: varchar(\"assigned_to\").references(() => users.id),\n  isResolved: boolean(\"is_resolved\").notNull().default(false),\n  resolvedAt: timestamp(\"resolved_at\"),\n  resolvedBy: varchar(\"resolved_by\").references(() => users.id),\n  lastMessageAt: timestamp(\"last_message_at\").notNull().defaultNow(),\n  unreadCount: integer(\"unread_count\").notNull().default(0),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Message Ranges - bundles of messages attached to opportunities\nexport const messageRanges = pgTable(\"message_ranges\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  conversationId: varchar(\"conversation_id\").references(() => smsConversations.id).notNull(),\n  leadId: varchar(\"lead_id\").references(() => leads.id),\n  jobId: varchar(\"job_id\").references(() => jobs.id),\n  quoteId: varchar(\"quote_id\").references(() => quotes.id),\n  startMessageId: varchar(\"start_message_id\").references(() => smsLogs.id).notNull(),\n  endMessageId: varchar(\"end_message_id\").references(() => smsLogs.id).notNull(),\n  startDate: timestamp(\"start_date\").notNull(),\n  endDate: timestamp(\"end_date\").notNull(),\n  messageCount: integer(\"message_count\").notNull(),\n  summary: text(\"summary\"),\n  attachedBy: varchar(\"attached_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Activity Log table\nexport const activityLogs = pgTable(\"activity_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id),\n  action: text(\"action\").notNull(),\n  entityType: text(\"entity_type\").notNull(),\n  entityId: varchar(\"entity_id\"),\n  details: jsonb(\"details\"),\n  ipAddress: text(\"ip_address\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Documents table\nexport const documents = pgTable(\"documents\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  clientId: varchar(\"client_id\").references(() => clients.id),\n  jobId: varchar(\"job_id\").references(() => jobs.id),\n  quoteId: varchar(\"quote_id\").references(() => quotes.id),\n  name: text(\"name\").notNull(),\n  type: text(\"type\").notNull(),\n  url: text(\"url\").notNull(),\n  size: integer(\"size\"),\n  uploadedBy: varchar(\"uploaded_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Quote Follow-ups table - track follow-up activities for quotes\nexport const quoteFollowUps = pgTable(\"quote_follow_ups\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  quoteId: varchar(\"quote_id\").references(() => quotes.id).notNull(),\n  scheduledDate: timestamp(\"scheduled_date\").notNull(),\n  completedAt: timestamp(\"completed_at\"),\n  followUpType: text(\"follow_up_type\").notNull(), // call, email, sms, meeting\n  notes: text(\"notes\"),\n  outcome: text(\"outcome\"), // no_answer, left_message, spoke_with_client, meeting_scheduled, quote_approved, quote_declined\n  assignedTo: varchar(\"assigned_to\").references(() => users.id),\n  completedBy: varchar(\"completed_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Automation campaign status enum\nexport const campaignStatusEnum = pgEnum(\"campaign_status\", [\n  \"active\",\n  \"paused\",\n  \"completed\",\n  \"cancelled\"\n]);\n\n// Automation campaign trigger enum\nexport const campaignTriggerEnum = pgEnum(\"campaign_trigger\", [\n  \"quote_sent\",\n  \"quote_no_response_3_days\",\n  \"quote_no_response_7_days\",\n  \"quote_expiring_soon\",\n  \"quote_expired\",\n  \"lead_new\",\n  \"lead_no_contact_24h\",\n  \"job_completed\",\n  \"payment_due\"\n]);\n\n// Automation Campaigns table - define automated message sequences\nexport const automationCampaigns = pgTable(\"automation_campaigns\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  trigger: campaignTriggerEnum(\"trigger\").notNull(),\n  clientType: clientTypeEnum(\"client_type\"), // null means apply to all\n  isActive: boolean(\"is_active\").notNull().default(true),\n  messageTemplate: text(\"message_template\").notNull(),\n  delayDays: integer(\"delay_days\").notNull().default(0), // days after trigger to send\n  delayHours: integer(\"delay_hours\").notNull().default(0), // additional hours\n  sendWindow: text(\"send_window\"), // e.g. \"09:00-17:00\" to only send during business hours\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// ============================================\n// PROFIT & LOSS COST TRACKING SYSTEM\n// ============================================\n\n// Trip type enum - different types of site visits\nexport const tripTypeEnum = pgEnum(\"trip_type\", [\n  \"site_quote\",        // Initial site measurement/quote\n  \"post_install\",      // Installing posts\n  \"panel_install\",     // Installing panels\n  \"gate_install\",      // Installing sliding gate\n  \"welder_dropoff\",    // Dropping materials at welder\n  \"welder_pickup\",     // Picking up from welder\n  \"powder_coat_dropoff\", // Dropping at powder coater\n  \"powder_coat_pickup\",  // Picking up from powder coater\n  \"supplier_delivery\",   // Supplier delivering materials\n  \"follow_up\",           // Follow-up visit\n  \"warranty\"             // Warranty/repair visit\n]);\n\n// Admin activity type enum\nexport const adminActivityEnum = pgEnum(\"admin_activity_type\", [\n  \"quote_creation\",      // Time spent creating the quote\n  \"client_messaging\",    // SMS/email correspondence\n  \"client_call\",         // Phone calls\n  \"spec_gathering\",      // Getting fence specifications\n  \"scheduling\",          // Scheduling activities\n  \"invoicing\",           // Creating/sending invoices\n  \"follow_up\",           // Following up on quote/payment\n  \"general_admin\"        // Other admin tasks\n]);\n\n// Travel status enum\nexport const travelStatusEnum = pgEnum(\"travel_status\", [\n  \"not_started\",\n  \"in_transit\",\n  \"arrived\",\n  \"completed\",\n  \"cancelled\"\n]);\n\n// Ground condition enum - affects installation costs\nexport const groundConditionEnum = pgEnum(\"ground_condition\", [\n  \"standard\",           // Normal ground, no obstacles\n  \"rocky\",              // Rocky ground - extra work\n  \"concrete\",           // Existing concrete/footings\n  \"existing_fence\",     // Need to remove existing fence\n  \"existing_footings\",  // Need to remove existing footings\n  \"sloped\",             // Sloped ground\n  \"sandy\",              // Sandy soil\n  \"clay\"                // Clay soil\n]);\n\n// Material source enum - where products come from\nexport const materialSourceEnum = pgEnum(\"material_source\", [\n  \"manufactured\",       // Made in-house (PVC)\n  \"glass_supplier\",     // External glass supplier\n  \"colorbond_supplier\", // External colorbond supplier\n  \"hardware_supplier\",  // Hardware/accessories\n  \"other\"\n]);\n\n// Staff Rate Cards - configurable hourly rates by role\nexport const staffRateCards = pgTable(\"staff_rate_cards\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id),\n  role: userRoleEnum(\"role\"),\n  rateType: text(\"rate_type\").notNull(), // manufacturing, installation, admin, travel\n  hourlyRate: decimal(\"hourly_rate\", { precision: 10, scale: 2 }).notNull(),\n  effectiveFrom: timestamp(\"effective_from\").notNull().defaultNow(),\n  effectiveUntil: timestamp(\"effective_until\"),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Quote Cost Components - individual cost line items for a quote/job\nexport const quoteCostComponents = pgTable(\"quote_cost_components\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  quoteId: varchar(\"quote_id\").references(() => quotes.id).notNull(),\n  jobId: varchar(\"job_id\").references(() => jobs.id),\n  category: text(\"category\").notNull(), // materials, manufacturing_labour, install_labour, travel, admin, supplier_fees, third_party\n  description: text(\"description\").notNull(),\n  quantity: decimal(\"quantity\", { precision: 10, scale: 2 }).notNull().default(\"1\"),\n  unitCost: decimal(\"unit_cost\", { precision: 10, scale: 2 }).notNull(),\n  totalCost: decimal(\"total_cost\", { precision: 10, scale: 2 }).notNull(),\n  staffId: varchar(\"staff_id\").references(() => users.id),\n  materialSource: materialSourceEnum(\"material_source\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// Quote Trips - track each site visit with time and mileage\nexport const quoteTrips = pgTable(\"quote_trips\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  quoteId: varchar(\"quote_id\").references(() => quotes.id),\n  jobId: varchar(\"job_id\").references(() => jobs.id),\n  tripType: tripTypeEnum(\"trip_type\").notNull(),\n  staffId: varchar(\"staff_id\").references(() => users.id).notNull(),\n  scheduledDate: timestamp(\"scheduled_date\"),\n  actualDate: timestamp(\"actual_date\"),\n  departureTime: timestamp(\"departure_time\"),\n  arrivalTime: timestamp(\"arrival_time\"),\n  departureReturnTime: timestamp(\"departure_return_time\"),\n  returnArrivalTime: timestamp(\"return_arrival_time\"),\n  startLocation: text(\"start_location\"),\n  endLocation: text(\"end_location\"),\n  distanceKm: decimal(\"distance_km\", { precision: 10, scale: 2 }),\n  durationMinutes: integer(\"duration_minutes\"),\n  fuelCost: decimal(\"fuel_cost\", { precision: 10, scale: 2 }),\n  travelCostTotal: decimal(\"travel_cost_total\", { precision: 10, scale: 2 }),\n  status: travelStatusEnum(\"status\").notNull().default(\"not_started\"),\n  clientNotified: boolean(\"client_notified\").default(false),\n  clientNotifiedAt: timestamp(\"client_notified_at\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Quote Admin Time - track time spent on admin activities\nexport const quoteAdminTime = pgTable(\"quote_admin_time\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  quoteId: varchar(\"quote_id\").references(() => quotes.id),\n  jobId: varchar(\"job_id\").references(() => jobs.id),\n  staffId: varchar(\"staff_id\").references(() => users.id).notNull(),\n  activityType: adminActivityEnum(\"activity_type\").notNull(),\n  durationMinutes: integer(\"duration_minutes\").notNull(),\n  description: text(\"description\"),\n  hourlyRate: decimal(\"hourly_rate\", { precision: 10, scale: 2 }),\n  totalCost: decimal(\"total_cost\", { precision: 10, scale: 2 }),\n  startTime: timestamp(\"start_time\"),\n  endTime: timestamp(\"end_time\"),\n  isAutoTracked: boolean(\"is_auto_tracked\").default(false),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Travel Sessions - active navigation sessions for real-time tracking\nexport const travelSessions = pgTable(\"travel_sessions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tripId: varchar(\"trip_id\").references(() => quoteTrips.id).notNull(),\n  staffId: varchar(\"staff_id\").references(() => users.id).notNull(),\n  clientId: varchar(\"client_id\").references(() => clients.id),\n  startLatitude: decimal(\"start_latitude\", { precision: 10, scale: 7 }),\n  startLongitude: decimal(\"start_longitude\", { precision: 10, scale: 7 }),\n  currentLatitude: decimal(\"current_latitude\", { precision: 10, scale: 7 }),\n  currentLongitude: decimal(\"current_longitude\", { precision: 10, scale: 7 }),\n  endLatitude: decimal(\"end_latitude\", { precision: 10, scale: 7 }),\n  endLongitude: decimal(\"end_longitude\", { precision: 10, scale: 7 }),\n  estimatedArrivalTime: timestamp(\"estimated_arrival_time\"),\n  actualArrivalTime: timestamp(\"actual_arrival_time\"),\n  status: travelStatusEnum(\"status\").notNull().default(\"not_started\"),\n  clientNotificationSent: boolean(\"client_notification_sent\").default(false),\n  clientNotificationSentAt: timestamp(\"client_notification_sent_at\"),\n  twilioMessageSid: text(\"twilio_message_sid\"),\n  routeData: jsonb(\"route_data\"),\n  startedAt: timestamp(\"started_at\"),\n  completedAt: timestamp(\"completed_at\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Quote Ground Conditions - track site conditions affecting costs\nexport const quoteGroundConditions = pgTable(\"quote_ground_conditions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  quoteId: varchar(\"quote_id\").references(() => quotes.id).notNull(),\n  condition: groundConditionEnum(\"condition\").notNull(),\n  affectedLengthMeters: decimal(\"affected_length_meters\", { precision: 10, scale: 2 }),\n  additionalCost: decimal(\"additional_cost\", { precision: 10, scale: 2 }),\n  additionalTimeMinutes: integer(\"additional_time_minutes\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Quote P&L Summary - aggregated profit/loss data for quick access\nexport const quotePLSummary = pgTable(\"quote_pl_summary\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  quoteId: varchar(\"quote_id\").references(() => quotes.id).notNull().unique(),\n  jobId: varchar(\"job_id\").references(() => jobs.id),\n  \n  // Revenue\n  totalRevenue: decimal(\"total_revenue\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  \n  // Costs by category\n  materialsCost: decimal(\"materials_cost\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  manufacturingLabourCost: decimal(\"manufacturing_labour_cost\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  installationLabourCost: decimal(\"installation_labour_cost\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  travelCost: decimal(\"travel_cost\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  adminCost: decimal(\"admin_cost\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  supplierDeliveryFees: decimal(\"supplier_delivery_fees\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  thirdPartyCost: decimal(\"third_party_cost\", { precision: 10, scale: 2 }).notNull().default(\"0\"), // welder, powder coater\n  groundConditionsCost: decimal(\"ground_conditions_cost\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  \n  // Totals\n  totalCost: decimal(\"total_cost\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  profitAmount: decimal(\"profit_amount\", { precision: 10, scale: 2 }).notNull().default(\"0\"),\n  profitMarginPercent: decimal(\"profit_margin_percent\", { precision: 5, scale: 2 }).notNull().default(\"0\"),\n  \n  // Metadata\n  isSupplyOnly: boolean(\"is_supply_only\").default(false),\n  estimatedTripCount: integer(\"estimated_trip_count\").default(1),\n  actualTripCount: integer(\"actual_trip_count\").default(0),\n  totalManufacturingMinutes: integer(\"total_manufacturing_minutes\").default(0),\n  totalInstallMinutes: integer(\"total_install_minutes\").default(0),\n  totalAdminMinutes: integer(\"total_admin_minutes\").default(0),\n  totalTravelMinutes: integer(\"total_travel_minutes\").default(0),\n  \n  lastCalculatedAt: timestamp(\"last_calculated_at\").notNull().defaultNow(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// Campaign Enrollments table - track entities enrolled in campaigns\nexport const campaignEnrollments = pgTable(\"campaign_enrollments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  campaignId: varchar(\"campaign_id\").references(() => automationCampaigns.id).notNull(),\n  clientId: varchar(\"client_id\").references(() => clients.id).notNull(),\n  quoteId: varchar(\"quote_id\").references(() => quotes.id),\n  leadId: varchar(\"lead_id\").references(() => leads.id),\n  jobId: varchar(\"job_id\").references(() => jobs.id),\n  status: campaignStatusEnum(\"status\").notNull().default(\"active\"),\n  enrolledAt: timestamp(\"enrolled_at\").notNull().defaultNow(),\n  scheduledSendAt: timestamp(\"scheduled_send_at\"),\n  sentAt: timestamp(\"sent_at\"),\n  messageId: varchar(\"message_id\").references(() => smsLogs.id),\n  cancelledAt: timestamp(\"cancelled_at\"),\n  cancelReason: text(\"cancel_reason\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Insert Schemas\nexport const insertUserSchema = createInsertSchema(users).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertStaffLeaveBalanceSchema = createInsertSchema(staffLeaveBalances).omit({\n  id: true,\n  updatedAt: true,\n});\n\nexport const insertClientSchema = createInsertSchema(clients).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertLeadSchema = createInsertSchema(leads).omit({\n  id: true,\n  leadNumber: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertLeadActivitySchema = createInsertSchema(leadActivities).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertLeadTaskSchema = createInsertSchema(leadTasks).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertFenceStyleSchema = createInsertSchema(fenceStyles).omit({\n  id: true,\n});\n\nexport const insertProductSchema = createInsertSchema(products).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertQuoteSchema = createInsertSchema(quotes).omit({\n  id: true,\n  createdAt: true,\n  sentAt: true,\n  approvedAt: true,\n});\n\nexport const insertJobSchema = createInsertSchema(jobs).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertBOMSchema = createInsertSchema(bom).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertProductionTaskSchema = createInsertSchema(productionTasks).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertInstallTaskSchema = createInsertSchema(installTasks).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertScheduleEventSchema = createInsertSchema(scheduleEvents).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertPaymentSchema = createInsertSchema(payments).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertNotificationSchema = createInsertSchema(notifications).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertSMSLogSchema = createInsertSchema(smsLogs).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertSMSConversationSchema = createInsertSchema(smsConversations).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertMessageRangeSchema = createInsertSchema(messageRanges).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertActivityLogSchema = createInsertSchema(activityLogs).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertDocumentSchema = createInsertSchema(documents).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertQuoteFollowUpSchema = createInsertSchema(quoteFollowUps).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertAutomationCampaignSchema = createInsertSchema(automationCampaigns).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertCampaignEnrollmentSchema = createInsertSchema(campaignEnrollments).omit({\n  id: true,\n  createdAt: true,\n  enrolledAt: true,\n});\n\n// P&L System Insert Schemas\nexport const insertStaffRateCardSchema = createInsertSchema(staffRateCards).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertQuoteCostComponentSchema = createInsertSchema(quoteCostComponents).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertQuoteTripSchema = createInsertSchema(quoteTrips).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertQuoteAdminTimeSchema = createInsertSchema(quoteAdminTime).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertTravelSessionSchema = createInsertSchema(travelSessions).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertQuoteGroundConditionSchema = createInsertSchema(quoteGroundConditions).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertQuotePLSummarySchema = createInsertSchema(quotePLSummary).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  lastCalculatedAt: true,\n});\n\n// Types\nexport type InsertUser = z.infer<typeof insertUserSchema>;\nexport type User = typeof users.$inferSelect;\n\nexport type InsertStaffLeaveBalance = z.infer<typeof insertStaffLeaveBalanceSchema>;\nexport type StaffLeaveBalance = typeof staffLeaveBalances.$inferSelect;\n\nexport type InsertClient = z.infer<typeof insertClientSchema>;\nexport type Client = typeof clients.$inferSelect;\n\nexport type InsertLead = z.infer<typeof insertLeadSchema>;\nexport type Lead = typeof leads.$inferSelect;\n\nexport type InsertLeadActivity = z.infer<typeof insertLeadActivitySchema>;\nexport type LeadActivity = typeof leadActivities.$inferSelect;\n\nexport type InsertLeadTask = z.infer<typeof insertLeadTaskSchema>;\nexport type LeadTask = typeof leadTasks.$inferSelect;\n\nexport type InsertFenceStyle = z.infer<typeof insertFenceStyleSchema>;\nexport type FenceStyle = typeof fenceStyles.$inferSelect;\n\nexport type InsertProduct = z.infer<typeof insertProductSchema>;\nexport type Product = typeof products.$inferSelect;\n\nexport type InsertQuote = z.infer<typeof insertQuoteSchema>;\nexport type Quote = typeof quotes.$inferSelect;\n\nexport type InsertJob = z.infer<typeof insertJobSchema>;\nexport type Job = typeof jobs.$inferSelect;\n\nexport type InsertBOM = z.infer<typeof insertBOMSchema>;\nexport type BOM = typeof bom.$inferSelect;\n\nexport type InsertProductionTask = z.infer<typeof insertProductionTaskSchema>;\nexport type ProductionTask = typeof productionTasks.$inferSelect;\n\nexport type InsertInstallTask = z.infer<typeof insertInstallTaskSchema>;\nexport type InstallTask = typeof installTasks.$inferSelect;\n\nexport type InsertScheduleEvent = z.infer<typeof insertScheduleEventSchema>;\nexport type ScheduleEvent = typeof scheduleEvents.$inferSelect;\n\nexport type InsertPayment = z.infer<typeof insertPaymentSchema>;\nexport type Payment = typeof payments.$inferSelect;\n\nexport type InsertNotification = z.infer<typeof insertNotificationSchema>;\nexport type Notification = typeof notifications.$inferSelect;\n\nexport type InsertSMSLog = z.infer<typeof insertSMSLogSchema>;\nexport type SMSLog = typeof smsLogs.$inferSelect;\n\nexport type InsertSMSConversation = z.infer<typeof insertSMSConversationSchema>;\nexport type SMSConversation = typeof smsConversations.$inferSelect;\n\nexport type InsertMessageRange = z.infer<typeof insertMessageRangeSchema>;\nexport type MessageRange = typeof messageRanges.$inferSelect;\n\nexport type InsertActivityLog = z.infer<typeof insertActivityLogSchema>;\nexport type ActivityLog = typeof activityLogs.$inferSelect;\n\nexport type InsertDocument = z.infer<typeof insertDocumentSchema>;\nexport type Document = typeof documents.$inferSelect;\n\nexport type InsertQuoteFollowUp = z.infer<typeof insertQuoteFollowUpSchema>;\nexport type QuoteFollowUp = typeof quoteFollowUps.$inferSelect;\n\nexport type InsertAutomationCampaign = z.infer<typeof insertAutomationCampaignSchema>;\nexport type AutomationCampaign = typeof automationCampaigns.$inferSelect;\n\nexport type InsertCampaignEnrollment = z.infer<typeof insertCampaignEnrollmentSchema>;\nexport type CampaignEnrollment = typeof campaignEnrollments.$inferSelect;\n\n// P&L System Types\nexport type InsertStaffRateCard = z.infer<typeof insertStaffRateCardSchema>;\nexport type StaffRateCard = typeof staffRateCards.$inferSelect;\n\nexport type InsertQuoteCostComponent = z.infer<typeof insertQuoteCostComponentSchema>;\nexport type QuoteCostComponent = typeof quoteCostComponents.$inferSelect;\n\nexport type InsertQuoteTrip = z.infer<typeof insertQuoteTripSchema>;\nexport type QuoteTrip = typeof quoteTrips.$inferSelect;\n\nexport type InsertQuoteAdminTime = z.infer<typeof insertQuoteAdminTimeSchema>;\nexport type QuoteAdminTime = typeof quoteAdminTime.$inferSelect;\n\nexport type InsertTravelSession = z.infer<typeof insertTravelSessionSchema>;\nexport type TravelSession = typeof travelSessions.$inferSelect;\n\nexport type InsertQuoteGroundCondition = z.infer<typeof insertQuoteGroundConditionSchema>;\nexport type QuoteGroundCondition = typeof quoteGroundConditions.$inferSelect;\n\nexport type InsertQuotePLSummary = z.infer<typeof insertQuotePLSummarySchema>;\nexport type QuotePLSummary = typeof quotePLSummary.$inferSelect;\n\n// ============================================\n// ORGANISATION HUB MODULE\n// ============================================\n\n// Organisation Hub Enums\nexport const orgContentStatusEnum = pgEnum(\"org_content_status\", [\"active\", \"draft\", \"archived\"]);\nexport const workflowCategoryEnum = pgEnum(\"workflow_category\", [\"sales\", \"production\", \"install\", \"warehouse\", \"admin\", \"hr\", \"safety\", \"other\"]);\nexport const policyCategoryEnum = pgEnum(\"policy_category\", [\"safety\", \"hr\", \"warehouse\", \"vehicles\", \"equipment\", \"operations\", \"other\"]);\nexport const hrFormTypeEnum = pgEnum(\"hr_form_type\", [\"incident_report\", \"leave_request\", \"training_request\", \"other\"]);\nexport const hrFormStatusEnum = pgEnum(\"hr_form_status\", [\"open\", \"under_review\", \"approved\", \"rejected\", \"closed\"]);\nexport const employmentTypeEnum = pgEnum(\"employment_type\", [\"full_time\", \"part_time\", \"casual\", \"contractor\"]);\nexport const documentTypeEnum = pgEnum(\"document_type\", [\"contract\", \"license\", \"certificate\", \"other\"]);\nexport const onboardingStatusEnum = pgEnum(\"onboarding_status\", [\"not_started\", \"in_progress\", \"complete\"]);\nexport const sessionStatusEnum = pgEnum(\"session_status\", [\"scheduled\", \"completed\", \"cancelled\"]);\nexport const noteVisibilityEnum = pgEnum(\"note_visibility\", [\"shared_with_employee\", \"manager_only\", \"hr_only\"]);\nexport const actionItemStatusEnum = pgEnum(\"action_item_status\", [\"open\", \"in_progress\", \"done\"]);\nexport const mediaEntityTypeEnum = pgEnum(\"media_entity_type\", [\"one_on_one_session\", \"hr_form\", \"workflow\", \"policy\", \"other\"]);\nexport const mediaFileTypeEnum = pgEnum(\"media_file_type\", [\"audio\", \"video\", \"image\", \"pdf\", \"other\"]);\nexport const diagramTypeEnum = pgEnum(\"diagram_type\", [\"uploaded_image\", \"embedded_tool\", \"json_flow\"]);\nexport const resourceTypeEnum = pgEnum(\"resource_type\", [\"file\", \"link\"]);\nexport const knowledgeSourceTypeEnum = pgEnum(\"knowledge_source_type\", [\"manual\", \"imported_from_workflow\", \"imported_from_policy\", \"external\"]);\n\n// Departments table - organisational structure\nexport const departments = pgTable(\"departments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  managerUserId: varchar(\"manager_user_id\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// Workflows table - standard operating procedures\nexport const workflows = pgTable(\"workflows\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  departmentId: varchar(\"department_id\").references(() => departments.id),\n  category: workflowCategoryEnum(\"category\").notNull(),\n  status: orgContentStatusEnum(\"status\").notNull().default(\"draft\"),\n  currentVersionId: varchar(\"current_version_id\"),\n  createdByUserId: varchar(\"created_by_user_id\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// Workflow versions - version history for workflows\nexport const workflowVersions = pgTable(\"workflow_versions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  workflowId: varchar(\"workflow_id\").references(() => workflows.id).notNull(),\n  versionNumber: integer(\"version_number\").notNull(),\n  contentMarkdown: text(\"content_markdown\"),\n  jsonSteps: jsonb(\"json_steps\"),\n  changeSummary: text(\"change_summary\"),\n  createdByUserId: varchar(\"created_by_user_id\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  isPublished: boolean(\"is_published\").notNull().default(false),\n});\n\n// Policies table - company policies\nexport const policies = pgTable(\"policies\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull(),\n  category: policyCategoryEnum(\"category\").notNull(),\n  departmentId: varchar(\"department_id\").references(() => departments.id),\n  status: orgContentStatusEnum(\"status\").notNull().default(\"draft\"),\n  currentVersionId: varchar(\"current_version_id\"),\n  createdByUserId: varchar(\"created_by_user_id\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// Policy versions - version history for policies\nexport const policyVersions = pgTable(\"policy_versions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  policyId: varchar(\"policy_id\").references(() => policies.id).notNull(),\n  versionNumber: integer(\"version_number\").notNull(),\n  contentMarkdown: text(\"content_markdown\"),\n  fileUrl: text(\"file_url\"),\n  changeSummary: text(\"change_summary\"),\n  effectiveFrom: timestamp(\"effective_from\"),\n  createdByUserId: varchar(\"created_by_user_id\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  isPublished: boolean(\"is_published\").notNull().default(false),\n});\n\n// Policy acknowledgements - track who has read/acknowledged policies\nexport const policyAcknowledgements = pgTable(\"policy_acknowledgements\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  policyId: varchar(\"policy_id\").references(() => policies.id).notNull(),\n  policyVersionId: varchar(\"policy_version_id\").references(() => policyVersions.id).notNull(),\n  userId: varchar(\"user_id\").references(() => users.id).notNull(),\n  acknowledgedAt: timestamp(\"acknowledged_at\").notNull().defaultNow(),\n});\n\n// Knowledge articles - internal how-to content\nexport const knowledgeArticles = pgTable(\"knowledge_articles\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull(),\n  slug: text(\"slug\").notNull(),\n  contentMarkdown: text(\"content_markdown\"),\n  departmentId: varchar(\"department_id\").references(() => departments.id),\n  tags: jsonb(\"tags\"),\n  sourceType: knowledgeSourceTypeEnum(\"source_type\").notNull().default(\"manual\"),\n  relatedWorkflowId: varchar(\"related_workflow_id\").references(() => workflows.id),\n  relatedPolicyId: varchar(\"related_policy_id\").references(() => policies.id),\n  isPublished: boolean(\"is_published\").notNull().default(false),\n  createdByUserId: varchar(\"created_by_user_id\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// HR Forms - generic form submissions\nexport const hrForms = pgTable(\"hr_forms\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  type: hrFormTypeEnum(\"type\").notNull(),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  status: hrFormStatusEnum(\"status\").notNull().default(\"open\"),\n  submittedByUserId: varchar(\"submitted_by_user_id\").references(() => users.id).notNull(),\n  assignedToUserId: varchar(\"assigned_to_user_id\").references(() => users.id),\n  departmentId: varchar(\"department_id\").references(() => departments.id),\n  payloadJson: jsonb(\"payload_json\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// Staff Records - HR profile for employees\nexport const staffRecords = pgTable(\"staff_records\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id).notNull(),\n  positionTitle: text(\"position_title\"),\n  startDate: timestamp(\"start_date\"),\n  endDate: timestamp(\"end_date\"),\n  employmentType: employmentTypeEnum(\"employment_type\"),\n  managerUserId: varchar(\"manager_user_id\").references(() => users.id),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// Staff Documents - contracts, licenses, certificates\nexport const staffDocuments = pgTable(\"staff_documents\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  staffRecordId: varchar(\"staff_record_id\").references(() => staffRecords.id).notNull(),\n  documentType: documentTypeEnum(\"document_type\").notNull(),\n  title: text(\"title\").notNull(),\n  fileUrl: text(\"file_url\"),\n  issuedDate: timestamp(\"issued_date\"),\n  expiryDate: timestamp(\"expiry_date\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Onboarding Checklists - templates for onboarding\nexport const onboardingChecklists = pgTable(\"onboarding_checklists\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  departmentId: varchar(\"department_id\").references(() => departments.id),\n  createdByUserId: varchar(\"created_by_user_id\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// Onboarding Tasks - tasks in a checklist template\nexport const onboardingTasks = pgTable(\"onboarding_tasks\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  onboardingChecklistId: varchar(\"onboarding_checklist_id\").references(() => onboardingChecklists.id).notNull(),\n  taskOrder: integer(\"task_order\").notNull(),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  required: boolean(\"required\").notNull().default(true),\n});\n\n// Onboarding Assignments - assign checklist to staff member\nexport const onboardingAssignments = pgTable(\"onboarding_assignments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  staffRecordId: varchar(\"staff_record_id\").references(() => staffRecords.id).notNull(),\n  onboardingChecklistId: varchar(\"onboarding_checklist_id\").references(() => onboardingChecklists.id).notNull(),\n  assignedDate: timestamp(\"assigned_date\").notNull().defaultNow(),\n  completedDate: timestamp(\"completed_date\"),\n  status: onboardingStatusEnum(\"status\").notNull().default(\"not_started\"),\n});\n\n// Onboarding Assignment Tasks - individual task completion\nexport const onboardingAssignmentTasks = pgTable(\"onboarding_assignment_tasks\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  onboardingAssignmentId: varchar(\"onboarding_assignment_id\").references(() => onboardingAssignments.id).notNull(),\n  onboardingTaskId: varchar(\"onboarding_task_id\").references(() => onboardingTasks.id).notNull(),\n  status: onboardingStatusEnum(\"status\").notNull().default(\"not_started\"),\n  completedAt: timestamp(\"completed_at\"),\n  completedByUserId: varchar(\"completed_by_user_id\").references(() => users.id),\n});\n\n// One-on-One Sessions - 1:1 meetings\nexport const oneOnOneSessions = pgTable(\"one_on_one_sessions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  employeeUserId: varchar(\"employee_user_id\").references(() => users.id).notNull(),\n  managerUserId: varchar(\"manager_user_id\").references(() => users.id).notNull(),\n  scheduledAt: timestamp(\"scheduled_at\").notNull(),\n  durationMinutes: integer(\"duration_minutes\"),\n  location: text(\"location\"),\n  status: sessionStatusEnum(\"status\").notNull().default(\"scheduled\"),\n  overallSummary: text(\"overall_summary\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// One-on-One Notes - notes from meetings\nexport const oneOnOneNotes = pgTable(\"one_on_one_notes\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  sessionId: varchar(\"session_id\").references(() => oneOnOneSessions.id).notNull(),\n  authorUserId: varchar(\"author_user_id\").references(() => users.id).notNull(),\n  visibility: noteVisibilityEnum(\"visibility\").notNull().default(\"shared_with_employee\"),\n  noteText: text(\"note_text\").notNull(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// One-on-One Action Items - action items from meetings\nexport const oneOnOneActionItems = pgTable(\"one_on_one_action_items\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  sessionId: varchar(\"session_id\").references(() => oneOnOneSessions.id).notNull(),\n  description: text(\"description\").notNull(),\n  assignedToUserId: varchar(\"assigned_to_user_id\").references(() => users.id).notNull(),\n  dueDate: timestamp(\"due_date\"),\n  status: actionItemStatusEnum(\"status\").notNull().default(\"open\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  completedAt: timestamp(\"completed_at\"),\n});\n\n// Media Files - attachments for various entities\nexport const orgMediaFiles = pgTable(\"org_media_files\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  entityType: mediaEntityTypeEnum(\"entity_type\").notNull(),\n  entityId: varchar(\"entity_id\").notNull(),\n  fileUrl: text(\"file_url\").notNull(),\n  fileName: text(\"file_name\"),\n  fileType: mediaFileTypeEnum(\"file_type\").notNull(),\n  uploadedByUserId: varchar(\"uploaded_by_user_id\").references(() => users.id),\n  uploadedAt: timestamp(\"uploaded_at\").notNull().defaultNow(),\n});\n\n// Visual Flows - process diagrams\nexport const visualFlows = pgTable(\"visual_flows\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  departmentId: varchar(\"department_id\").references(() => departments.id),\n  diagramType: diagramTypeEnum(\"diagram_type\").notNull(),\n  fileUrl: text(\"file_url\"),\n  jsonDefinition: jsonb(\"json_definition\"),\n  createdByUserId: varchar(\"created_by_user_id\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// Resources - central resource library\nexport const resources = pgTable(\"resources\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  resourceType: resourceTypeEnum(\"resource_type\").notNull(),\n  fileUrl: text(\"file_url\"),\n  externalUrl: text(\"external_url\"),\n  tags: jsonb(\"tags\"),\n  departmentId: varchar(\"department_id\").references(() => departments.id),\n  uploadedByUserId: varchar(\"uploaded_by_user_id\").references(() => users.id),\n  uploadedAt: timestamp(\"uploaded_at\").notNull().defaultNow(),\n});\n\n// ============================================\n// ORGANISATION HUB INSERT SCHEMAS\n// ============================================\n\nexport const insertDepartmentSchema = createInsertSchema(departments).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertWorkflowSchema = createInsertSchema(workflows).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertWorkflowVersionSchema = createInsertSchema(workflowVersions).omit({ id: true, createdAt: true });\nexport const insertPolicySchema = createInsertSchema(policies).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertPolicyVersionSchema = createInsertSchema(policyVersions).omit({ id: true, createdAt: true });\nexport const insertPolicyAcknowledgementSchema = createInsertSchema(policyAcknowledgements).omit({ id: true, acknowledgedAt: true });\nexport const insertKnowledgeArticleSchema = createInsertSchema(knowledgeArticles).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertHRFormSchema = createInsertSchema(hrForms).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertStaffRecordSchema = createInsertSchema(staffRecords).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertStaffDocumentSchema = createInsertSchema(staffDocuments).omit({ id: true, createdAt: true });\nexport const insertOnboardingChecklistSchema = createInsertSchema(onboardingChecklists).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertOnboardingTaskSchema = createInsertSchema(onboardingTasks).omit({ id: true });\nexport const insertOnboardingAssignmentSchema = createInsertSchema(onboardingAssignments).omit({ id: true, assignedDate: true });\nexport const insertOnboardingAssignmentTaskSchema = createInsertSchema(onboardingAssignmentTasks).omit({ id: true });\nexport const insertOneOnOneSessionSchema = createInsertSchema(oneOnOneSessions).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertOneOnOneNoteSchema = createInsertSchema(oneOnOneNotes).omit({ id: true, createdAt: true });\nexport const insertOneOnOneActionItemSchema = createInsertSchema(oneOnOneActionItems).omit({ id: true, createdAt: true });\nexport const insertOrgMediaFileSchema = createInsertSchema(orgMediaFiles).omit({ id: true, uploadedAt: true });\nexport const insertVisualFlowSchema = createInsertSchema(visualFlows).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertResourceSchema = createInsertSchema(resources).omit({ id: true, uploadedAt: true });\n\n// ============================================\n// ORGANISATION HUB TYPES\n// ============================================\n\nexport type InsertDepartment = z.infer<typeof insertDepartmentSchema>;\nexport type Department = typeof departments.$inferSelect;\n\nexport type InsertWorkflow = z.infer<typeof insertWorkflowSchema>;\nexport type Workflow = typeof workflows.$inferSelect;\n\nexport type InsertWorkflowVersion = z.infer<typeof insertWorkflowVersionSchema>;\nexport type WorkflowVersion = typeof workflowVersions.$inferSelect;\n\nexport type InsertPolicy = z.infer<typeof insertPolicySchema>;\nexport type Policy = typeof policies.$inferSelect;\n\nexport type InsertPolicyVersion = z.infer<typeof insertPolicyVersionSchema>;\nexport type PolicyVersion = typeof policyVersions.$inferSelect;\n\nexport type InsertPolicyAcknowledgement = z.infer<typeof insertPolicyAcknowledgementSchema>;\nexport type PolicyAcknowledgement = typeof policyAcknowledgements.$inferSelect;\n\nexport type InsertKnowledgeArticle = z.infer<typeof insertKnowledgeArticleSchema>;\nexport type KnowledgeArticle = typeof knowledgeArticles.$inferSelect;\n\nexport type InsertHRForm = z.infer<typeof insertHRFormSchema>;\nexport type HRForm = typeof hrForms.$inferSelect;\n\nexport type InsertStaffRecord = z.infer<typeof insertStaffRecordSchema>;\nexport type StaffRecord = typeof staffRecords.$inferSelect;\n\nexport type InsertStaffDocument = z.infer<typeof insertStaffDocumentSchema>;\nexport type StaffDocument = typeof staffDocuments.$inferSelect;\n\nexport type InsertOnboardingChecklist = z.infer<typeof insertOnboardingChecklistSchema>;\nexport type OnboardingChecklist = typeof onboardingChecklists.$inferSelect;\n\nexport type InsertOnboardingTask = z.infer<typeof insertOnboardingTaskSchema>;\nexport type OnboardingTask = typeof onboardingTasks.$inferSelect;\n\nexport type InsertOnboardingAssignment = z.infer<typeof insertOnboardingAssignmentSchema>;\nexport type OnboardingAssignment = typeof onboardingAssignments.$inferSelect;\n\nexport type InsertOnboardingAssignmentTask = z.infer<typeof insertOnboardingAssignmentTaskSchema>;\nexport type OnboardingAssignmentTask = typeof onboardingAssignmentTasks.$inferSelect;\n\nexport type InsertOneOnOneSession = z.infer<typeof insertOneOnOneSessionSchema>;\nexport type OneOnOneSession = typeof oneOnOneSessions.$inferSelect;\n\nexport type InsertOneOnOneNote = z.infer<typeof insertOneOnOneNoteSchema>;\nexport type OneOnOneNote = typeof oneOnOneNotes.$inferSelect;\n\nexport type InsertOneOnOneActionItem = z.infer<typeof insertOneOnOneActionItemSchema>;\nexport type OneOnOneActionItem = typeof oneOnOneActionItems.$inferSelect;\n\nexport type InsertOrgMediaFile = z.infer<typeof insertOrgMediaFileSchema>;\nexport type OrgMediaFile = typeof orgMediaFiles.$inferSelect;\n\nexport type InsertVisualFlow = z.infer<typeof insertVisualFlowSchema>;\nexport type VisualFlow = typeof visualFlows.$inferSelect;\n\nexport type InsertResource = z.infer<typeof insertResourceSchema>;\nexport type Resource = typeof resources.$inferSelect;\n\n// ============================================\n// JOB SETUP DOCUMENT INSERT SCHEMAS\n// ============================================\n\nexport const insertJobSetupDocumentSchema = createInsertSchema(jobSetupDocuments).omit({ \n  id: true, \n  createdAt: true, \n  updatedAt: true \n});\n\nexport const insertJobSetupProductSchema = createInsertSchema(jobSetupProducts).omit({ \n  id: true, \n  createdAt: true, \n  updatedAt: true \n});\n\n// Zod schemas for section validation\nexport const section1SalesSchema = z.object({\n  oldFenceBeingRemoved: z.boolean().optional(),\n  oldFenceMaterial: z.string().optional(),\n  oldFenceAgeYears: z.string().optional(),\n  allFootingsRemoved: z.boolean().optional(),\n  reticInGround: z.boolean().optional(),\n  reticNotes: z.string().optional(),\n  undergroundServicesKnown: z.boolean().optional(),\n  undergroundServicesNotes: z.string().optional(),\n  poolArea: z.boolean().optional(),\n  dogsOnSite: z.boolean().optional(),\n  lockedGatesOrRestrictedAccess: z.boolean().optional(),\n  someoneHomeOnInstallDay: z.boolean().optional(),\n  drivewayAccessDescription: z.string().optional(),\n  steepOrSlopingSite: z.boolean().optional(),\n  siteHazardsNotes: z.string().optional(),\n  needsCoreDrill: z.boolean().optional(),\n  needsChainsaw: z.boolean().optional(),\n  needsAuger: z.boolean().optional(),\n  needsSkipBin: z.boolean().optional(),\n  needsExtraLabor: z.boolean().optional(),\n  equipmentOtherNotes: z.string().optional(),\n  fenceTotalMetres: z.number().optional(),\n  fenceHeightMm: z.number().optional(),\n  numGates: z.number().optional(),\n  gateOpeningsDescription: z.string().optional(),\n  rakedOrStepped: z.string().optional(),\n  panelsLayoutNotes: z.string().optional(),\n  sitePlanImageUrl: z.string().optional(),\n  additionalPhotosUrls: z.array(z.string()).optional(),\n  clientConfirmationText: z.string().optional(),\n  clientSignedSalesSetup: z.boolean().optional(),\n  clientSignedAt: z.string().optional(),\n});\n\nexport const section2ProductsMetaSchema = z.object({\n  autoPopulatedFromQuote: z.boolean().optional(),\n  quoteId: z.string().optional(),\n  lastUpdatedBy: z.string().optional(),\n  lastUpdatedAt: z.string().optional(),\n  notes: z.string().optional(),\n});\n\nexport const section3ProductionSchema = z.object({\n  postsManufactured: z.boolean().optional(),\n  panelsManufactured: z.boolean().optional(),\n  gatesFabricated: z.boolean().optional(),\n  hardwarePacked: z.boolean().optional(),\n  accessoriesPacked: z.boolean().optional(),\n  cementAndMaterialsPrepared: z.boolean().optional(),\n  productionSpecialNotes: z.string().optional(),\n  productionCompletedBy: z.string().optional(),\n  productionCompletedAt: z.string().optional(),\n});\n\nexport const section4ScheduleSchema = z.object({\n  schedulingReadyForInstall: z.boolean().optional(),\n  proposedInstallDate: z.string().optional(),\n  confirmInstallDateWithClient: z.boolean().optional(),\n  installTimeWindow: z.string().optional(),\n  installerTeamAssigned: z.string().optional(),\n  isSupplyOnlyPickup: z.boolean().optional(),\n  pickupOrDeliveryNotes: z.string().optional(),\n  schedulerNotes: z.string().optional(),\n  scheduledBy: z.string().optional(),\n  scheduledAt: z.string().optional(),\n  requiresCoreDrill: z.boolean().optional(),\n  requiresChainsaw: z.boolean().optional(),\n  requiresAuger: z.boolean().optional(),\n  requiresSkipBin: z.boolean().optional(),\n});\n\nexport const section5InstallSchema = z.object({\n  installerCheckedMaterialsComplete: z.boolean().optional(),\n  installerCheckedToolsLoaded: z.boolean().optional(),\n  installerConfirmedSiteAccessOk: z.boolean().optional(),\n  installerReadSiteNotes: z.boolean().optional(),\n  installerPrestartNotes: z.string().optional(),\n  installerPrestartCompletedBy: z.string().optional(),\n  installerPrestartCompletedAt: z.string().optional(),\n  installCompleted: z.boolean().optional(),\n  installPhotosUrls: z.array(z.string()).optional(),\n  completionNotes: z.string().optional(),\n  clientSignedCompletion: z.boolean().optional(),\n  clientSignedCompletionAt: z.string().optional(),\n  installerCompletionBy: z.string().optional(),\n  installerCompletionAt: z.string().optional(),\n});\n\n// ============================================\n// JOB SETUP DOCUMENT TYPES\n// ============================================\n\nexport type InsertJobSetupDocument = z.infer<typeof insertJobSetupDocumentSchema>;\nexport type JobSetupDocument = typeof jobSetupDocuments.$inferSelect;\n\nexport type InsertJobSetupProduct = z.infer<typeof insertJobSetupProductSchema>;\nexport type JobSetupProduct = typeof jobSetupProducts.$inferSelect;\n\n// ============================================\n// DASHBOARD BUILDER TABLES\n// ============================================\n\nexport const widgetTypeEnum = pgEnum(\"widget_type\", [\n  \"kpi_card\",\n  \"bar_chart\",\n  \"line_chart\", \n  \"pie_chart\",\n  \"area_chart\",\n  \"table\",\n  \"recent_items\",\n  \"status_breakdown\",\n  \"trend_metric\",\n  \"progress_bar\",\n  \"weather\",\n  \"tasks\",\n  \"notifications\",\n  \"leave_balance\",\n  \"quick_actions\"\n]);\n\nexport const widgetCategoryEnum = pgEnum(\"widget_category\", [\n  \"kpis\",\n  \"charts\",\n  \"tables\",\n  \"analytics\",\n  \"personal\"\n]);\n\nexport const dashboardWidgets = pgTable(\"dashboard_widgets\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: varchar(\"name\", { length: 100 }).notNull(),\n  description: text(\"description\"),\n  widgetType: widgetTypeEnum(\"widget_type\").notNull(),\n  category: widgetCategoryEnum(\"category\").notNull(),\n  dataSource: varchar(\"data_source\", { length: 100 }).notNull(),\n  defaultWidth: integer(\"default_width\").default(1).notNull(),\n  defaultHeight: integer(\"default_height\").default(1).notNull(),\n  minWidth: integer(\"min_width\").default(1),\n  minHeight: integer(\"min_height\").default(1),\n  maxWidth: integer(\"max_width\").default(4),\n  maxHeight: integer(\"max_height\").default(4),\n  configSchema: jsonb(\"config_schema\"),\n  defaultConfig: jsonb(\"default_config\"),\n  isActive: boolean(\"is_active\").default(true).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const roleDashboardLayouts = pgTable(\"role_dashboard_layouts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  role: userRoleEnum(\"role\").notNull(),\n  name: varchar(\"name\", { length: 100 }).notNull(),\n  description: text(\"description\"),\n  isDefault: boolean(\"is_default\").default(false).notNull(),\n  isPublished: boolean(\"is_published\").default(false).notNull(),\n  gridColumns: integer(\"grid_columns\").default(12).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  updatedBy: varchar(\"updated_by\").references(() => users.id),\n});\n\nexport const dashboardWidgetInstances = pgTable(\"dashboard_widget_instances\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  layoutId: varchar(\"layout_id\").notNull().references(() => roleDashboardLayouts.id, { onDelete: \"cascade\" }),\n  widgetId: varchar(\"widget_id\").notNull().references(() => dashboardWidgets.id),\n  positionX: integer(\"position_x\").default(0).notNull(),\n  positionY: integer(\"position_y\").default(0).notNull(),\n  width: integer(\"width\").default(1).notNull(),\n  height: integer(\"height\").default(1).notNull(),\n  config: jsonb(\"config\"),\n  title: varchar(\"title\", { length: 100 }),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// Insert schemas\nexport const insertDashboardWidgetSchema = createInsertSchema(dashboardWidgets).omit({ \n  id: true, \n  createdAt: true \n});\n\nexport const insertRoleDashboardLayoutSchema = createInsertSchema(roleDashboardLayouts).omit({ \n  id: true, \n  createdAt: true, \n  updatedAt: true \n});\n\nexport const insertDashboardWidgetInstanceSchema = createInsertSchema(dashboardWidgetInstances).omit({ \n  id: true, \n  createdAt: true \n});\n\n// Types\nexport type InsertDashboardWidget = z.infer<typeof insertDashboardWidgetSchema>;\nexport type DashboardWidget = typeof dashboardWidgets.$inferSelect;\n\nexport type InsertRoleDashboardLayout = z.infer<typeof insertRoleDashboardLayoutSchema>;\nexport type RoleDashboardLayout = typeof roleDashboardLayouts.$inferSelect;\n\nexport type InsertDashboardWidgetInstance = z.infer<typeof insertDashboardWidgetInstanceSchema>;\nexport type DashboardWidgetInstance = typeof dashboardWidgetInstances.$inferSelect;\n\n// ==================== BANKING / FINANCIAL TABLES ====================\n\n// Bank connection status enum\nexport const bankConnectionStatusEnum = pgEnum(\"bank_connection_status\", [\n  \"active\",\n  \"inactive\",\n  \"invalid\",\n  \"processing\",\n  \"deleted\"\n]);\n\n// Bank account type enum\nexport const bankAccountTypeEnum = pgEnum(\"bank_account_type\", [\n  \"transaction\",\n  \"savings\",\n  \"credit_card\",\n  \"loan\",\n  \"mortgage\",\n  \"investment\",\n  \"term_deposit\",\n  \"other\"\n]);\n\n// Transaction direction enum\nexport const transactionDirectionEnum = pgEnum(\"transaction_direction\", [\n  \"credit\",\n  \"debit\"\n]);\n\n// Bank Connections - stores Basiq CDR consent info\nexport const bankConnections = pgTable(\"bank_connections\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  ownerUserId: varchar(\"owner_user_id\").references(() => users.id),\n  basiqConsentId: varchar(\"basiq_consent_id\", { length: 100 }),\n  basiqUserId: varchar(\"basiq_user_id\", { length: 100 }),\n  basiqConnectionId: varchar(\"basiq_connection_id\", { length: 100 }),\n  institutionId: varchar(\"institution_id\", { length: 50 }),\n  institutionName: varchar(\"institution_name\", { length: 100 }),\n  status: bankConnectionStatusEnum(\"status\").default(\"inactive\").notNull(),\n  consentExpiresAt: timestamp(\"consent_expires_at\"),\n  lastSyncedAt: timestamp(\"last_synced_at\"),\n  refreshJobId: varchar(\"refresh_job_id\", { length: 100 }),\n  metadata: jsonb(\"metadata\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// Bank Accounts - stores account details from Basiq\nexport const bankAccounts = pgTable(\"bank_accounts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  connectionId: varchar(\"connection_id\").notNull().references(() => bankConnections.id, { onDelete: \"cascade\" }),\n  basiqAccountId: varchar(\"basiq_account_id\", { length: 100 }).notNull(),\n  name: varchar(\"name\", { length: 200 }).notNull(),\n  accountHolder: varchar(\"account_holder\", { length: 200 }),\n  accountNumberMasked: varchar(\"account_number_masked\", { length: 50 }),\n  bsbMasked: varchar(\"bsb_masked\", { length: 20 }),\n  accountType: bankAccountTypeEnum(\"account_type\").default(\"transaction\"),\n  currency: varchar(\"currency\", { length: 10 }).default(\"AUD\"),\n  balance: decimal(\"balance\", { precision: 15, scale: 2 }),\n  availableFunds: decimal(\"available_funds\", { precision: 15, scale: 2 }),\n  lastUpdatedAt: timestamp(\"last_updated_at\"),\n  isActive: boolean(\"is_active\").default(true).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// Bank Transactions - stores transaction history from Basiq\nexport const bankTransactions = pgTable(\"bank_transactions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  accountId: varchar(\"account_id\").notNull().references(() => bankAccounts.id, { onDelete: \"cascade\" }),\n  basiqTransactionId: varchar(\"basiq_transaction_id\", { length: 100 }).notNull(),\n  description: text(\"description\").notNull(),\n  amount: decimal(\"amount\", { precision: 15, scale: 2 }).notNull(),\n  direction: transactionDirectionEnum(\"direction\").notNull(),\n  status: varchar(\"status\", { length: 50 }).default(\"posted\"),\n  transactionDate: timestamp(\"transaction_date\"),\n  postDate: timestamp(\"post_date\"),\n  category: varchar(\"category\", { length: 100 }),\n  subCategory: varchar(\"sub_category\", { length: 100 }),\n  merchantName: varchar(\"merchant_name\", { length: 200 }),\n  merchantLocation: varchar(\"merchant_location\", { length: 200 }),\n  runningBalance: decimal(\"running_balance\", { precision: 15, scale: 2 }),\n  rawData: jsonb(\"raw_data\"),\n  importedAt: timestamp(\"imported_at\").defaultNow().notNull(),\n  // Staff allocation - auto or manual assignment\n  allocatedStaffId: varchar(\"allocated_staff_id\").references(() => users.id),\n  allocatedJobId: varchar(\"allocated_job_id\").references(() => jobs.id),\n  expenseCategoryId: varchar(\"expense_category_id\"),\n  cardNumberUsed: varchar(\"card_number_used\", { length: 10 }),\n  allocationNotes: text(\"allocation_notes\"),\n  receiptId: varchar(\"receipt_id\"),\n});\n\n// Insert schemas for banking\nexport const insertBankConnectionSchema = createInsertSchema(bankConnections).omit({ \n  id: true, \n  createdAt: true,\n  updatedAt: true\n});\n\nexport const insertBankAccountSchema = createInsertSchema(bankAccounts).omit({ \n  id: true, \n  createdAt: true \n});\n\nexport const insertBankTransactionSchema = createInsertSchema(bankTransactions).omit({ \n  id: true, \n  importedAt: true \n});\n\n// Types for banking\nexport type InsertBankConnection = z.infer<typeof insertBankConnectionSchema>;\nexport type BankConnection = typeof bankConnections.$inferSelect;\n\nexport type InsertBankAccount = z.infer<typeof insertBankAccountSchema>;\nexport type BankAccount = typeof bankAccounts.$inferSelect;\n\nexport type InsertBankTransaction = z.infer<typeof insertBankTransactionSchema>;\nexport type BankTransaction = typeof bankTransactions.$inferSelect;\n\n// ==================== JOB PIPELINE CONFIGURATION ====================\n\n// Job Pipelines - represents different job workflow types\nexport const jobPipelines = pgTable(\"job_pipelines\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: varchar(\"name\", { length: 100 }).notNull(),\n  description: text(\"description\"),\n  isActive: boolean(\"is_active\").default(true).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// Stage completion type enum\nexport const stageCompletionTypeEnum = pgEnum(\"stage_completion_type\", [\n  \"manual\",\n  \"automatic\"\n]);\n\n// Job Pipeline Stages - individual steps within a pipeline\nexport const jobPipelineStages = pgTable(\"job_pipeline_stages\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  pipelineId: varchar(\"pipeline_id\").notNull().references(() => jobPipelines.id, { onDelete: \"cascade\" }),\n  name: varchar(\"name\", { length: 100 }).notNull(),\n  icon: varchar(\"icon\", { length: 50 }),\n  completionType: stageCompletionTypeEnum(\"completion_type\").default(\"manual\").notNull(),\n  isActive: boolean(\"is_active\").default(true).notNull(),\n  sortOrder: integer(\"sort_order\").default(0).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// Insert schemas for pipelines\nexport const insertJobPipelineSchema = createInsertSchema(jobPipelines).omit({ \n  id: true, \n  createdAt: true,\n  updatedAt: true\n});\n\nexport const insertJobPipelineStageSchema = createInsertSchema(jobPipelineStages).omit({ \n  id: true, \n  createdAt: true,\n  updatedAt: true\n});\n\n// Job Stage Completions - tracks which stages are completed for each job\nexport const jobStageCompletions = pgTable(\"job_stage_completions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  jobId: varchar(\"job_id\").notNull().references(() => jobs.id, { onDelete: \"cascade\" }),\n  stageId: varchar(\"stage_id\").notNull().references(() => jobPipelineStages.id, { onDelete: \"cascade\" }),\n  completedAt: timestamp(\"completed_at\").defaultNow().notNull(),\n  completedBy: varchar(\"completed_by\").references(() => users.id),\n});\n\nexport const insertJobStageCompletionSchema = createInsertSchema(jobStageCompletions).omit({ \n  id: true, \n  completedAt: true\n});\n\n// Types for pipelines\nexport type InsertJobPipeline = z.infer<typeof insertJobPipelineSchema>;\nexport type JobPipeline = typeof jobPipelines.$inferSelect;\n\nexport type InsertJobPipelineStage = z.infer<typeof insertJobPipelineStageSchema>;\nexport type JobPipelineStage = typeof jobPipelineStages.$inferSelect;\n\nexport type InsertJobStageCompletion = z.infer<typeof insertJobStageCompletionSchema>;\nexport type JobStageCompletion = typeof jobStageCompletions.$inferSelect;\n\n// Kanban Columns - configurable columns for job kanban board\nexport const kanbanColumns = pgTable(\"kanban_columns\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: varchar(\"title\", { length: 100 }).notNull(),\n  statuses: text(\"statuses\").array().notNull(),\n  defaultStatus: varchar(\"default_status\", { length: 50 }).notNull(),\n  color: varchar(\"color\", { length: 100 }).notNull(),\n  sortOrder: integer(\"sort_order\").default(0).notNull(),\n  isActive: boolean(\"is_active\").default(true).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const insertKanbanColumnSchema = createInsertSchema(kanbanColumns).omit({ \n  id: true, \n  createdAt: true,\n  updatedAt: true\n});\n\nexport type InsertKanbanColumn = z.infer<typeof insertKanbanColumnSchema>;\nexport type KanbanColumn = typeof kanbanColumns.$inferSelect;\n\n// Job Statuses - configurable statuses that jobs can be in\nexport const jobStatuses = pgTable(\"job_statuses\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  key: varchar(\"key\", { length: 50 }).notNull().unique(),\n  label: varchar(\"label\", { length: 100 }).notNull(),\n  description: varchar(\"description\", { length: 255 }),\n  sortOrder: integer(\"sort_order\").default(0).notNull(),\n  isActive: boolean(\"is_active\").default(true).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const insertJobStatusSchema = createInsertSchema(jobStatuses).omit({ \n  id: true, \n  createdAt: true,\n  updatedAt: true\n});\n\nexport type InsertJobStatus = z.infer<typeof insertJobStatusSchema>;\nexport type JobStatus = typeof jobStatuses.$inferSelect;\n\n// Job Status Dependencies - defines prerequisites between statuses\nexport const jobStatusDependencies = pgTable(\"job_status_dependencies\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  statusKey: varchar(\"status_key\", { length: 50 }).notNull().references(() => jobStatuses.key),\n  prerequisiteKey: varchar(\"prerequisite_key\", { length: 50 }).notNull().references(() => jobStatuses.key),\n  dependencyType: varchar(\"dependency_type\", { length: 20 }).default(\"mandatory\").notNull(), // \"mandatory\" or \"advisory\"\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertJobStatusDependencySchema = createInsertSchema(jobStatusDependencies).omit({ \n  id: true, \n  createdAt: true\n});\n\nexport type InsertJobStatusDependency = z.infer<typeof insertJobStatusDependencySchema>;\nexport type JobStatusDependency = typeof jobStatusDependencies.$inferSelect;\n\n// Production Stages - configurable manufacturing stages\nexport const productionStages = pgTable(\"production_stages\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  key: varchar(\"key\", { length: 100 }).notNull().unique(),\n  label: varchar(\"label\", { length: 200 }).notNull(),\n  description: text(\"description\"),\n  icon: varchar(\"icon\", { length: 100 }).default(\"Factory\"),\n  color: varchar(\"color\", { length: 100 }).default(\"bg-chart-1\"),\n  sortOrder: integer(\"sort_order\").default(0).notNull(),\n  isActive: boolean(\"is_active\").default(true).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const insertProductionStageSchema = createInsertSchema(productionStages).omit({ \n  id: true, \n  createdAt: true,\n  updatedAt: true\n});\n\nexport type InsertProductionStage = z.infer<typeof insertProductionStageSchema>;\nexport type ProductionStage = typeof productionStages.$inferSelect;\n\n// ==================== VOICE CALL & AI COACHING ====================\n\n// Voice call status enum\nexport const voiceCallStatusEnum = pgEnum(\"voice_call_status\", [\n  \"ringing\",\n  \"in_progress\",\n  \"completed\",\n  \"failed\",\n  \"busy\",\n  \"no_answer\",\n  \"canceled\"\n]);\n\n// Voice Calls - tracks all voice calls made/received\nexport const voiceCalls = pgTable(\"voice_calls\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  twilioCallSid: varchar(\"twilio_call_sid\", { length: 100 }).unique(),\n  direction: callDirectionEnum(\"direction\").notNull(),\n  status: voiceCallStatusEnum(\"status\").default(\"ringing\").notNull(),\n  fromNumber: varchar(\"from_number\", { length: 20 }).notNull(),\n  toNumber: varchar(\"to_number\", { length: 20 }).notNull(),\n  staffUserId: varchar(\"staff_user_id\").references(() => users.id),\n  clientId: varchar(\"client_id\").references(() => clients.id),\n  leadId: varchar(\"lead_id\").references(() => leads.id),\n  duration: integer(\"duration\"), // in seconds\n  recordingUrl: text(\"recording_url\"),\n  recordingSid: varchar(\"recording_sid\", { length: 100 }),\n  startedAt: timestamp(\"started_at\").defaultNow().notNull(),\n  answeredAt: timestamp(\"answered_at\"),\n  endedAt: timestamp(\"ended_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertVoiceCallSchema = createInsertSchema(voiceCalls).omit({ \n  id: true, \n  createdAt: true\n});\n\nexport type InsertVoiceCall = z.infer<typeof insertVoiceCallSchema>;\nexport type VoiceCall = typeof voiceCalls.$inferSelect;\n\n// Call Transcripts - stores transcription chunks (real-time or post-call)\nexport const callTranscripts = pgTable(\"call_transcripts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  callId: varchar(\"call_id\").notNull().references(() => voiceCalls.id, { onDelete: \"cascade\" }),\n  speaker: varchar(\"speaker\", { length: 20 }).notNull(), // \"staff\" or \"customer\"\n  text: text(\"text\").notNull(),\n  startTime: decimal(\"start_time\", { precision: 10, scale: 2 }), // seconds from call start\n  endTime: decimal(\"end_time\", { precision: 10, scale: 2 }),\n  confidence: decimal(\"confidence\", { precision: 5, scale: 4 }),\n  isInterim: boolean(\"is_interim\").default(false), // true for real-time partial transcripts\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertCallTranscriptSchema = createInsertSchema(callTranscripts).omit({ \n  id: true, \n  createdAt: true\n});\n\nexport type InsertCallTranscript = z.infer<typeof insertCallTranscriptSchema>;\nexport type CallTranscript = typeof callTranscripts.$inferSelect;\n\n// Sales Checklist Items - configurable questions staff should ask\nexport const salesChecklistItems = pgTable(\"sales_checklist_items\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  question: varchar(\"question\", { length: 255 }).notNull(),\n  description: text(\"description\"),\n  category: varchar(\"category\", { length: 50 }), // e.g., \"requirements\", \"budget\", \"timeline\"\n  keywords: text(\"keywords\").array(), // words that indicate this was asked\n  suggestedResponse: text(\"suggested_response\"), // AI can show this as a hint\n  isRequired: boolean(\"is_required\").default(false).notNull(),\n  sortOrder: integer(\"sort_order\").default(0).notNull(),\n  isActive: boolean(\"is_active\").default(true).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const insertSalesChecklistItemSchema = createInsertSchema(salesChecklistItems).omit({ \n  id: true, \n  createdAt: true,\n  updatedAt: true\n});\n\nexport type InsertSalesChecklistItem = z.infer<typeof insertSalesChecklistItemSchema>;\nexport type SalesChecklistItem = typeof salesChecklistItems.$inferSelect;\n\n// Call Checklist Status - tracks which items were covered in each call\nexport const callChecklistStatus = pgTable(\"call_checklist_status\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  callId: varchar(\"call_id\").notNull().references(() => voiceCalls.id, { onDelete: \"cascade\" }),\n  checklistItemId: varchar(\"checklist_item_id\").notNull().references(() => salesChecklistItems.id, { onDelete: \"cascade\" }),\n  isCovered: boolean(\"is_covered\").default(false).notNull(),\n  coveredAt: timestamp(\"covered_at\"),\n  detectedText: text(\"detected_text\"), // the transcript text that triggered this\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertCallChecklistStatusSchema = createInsertSchema(callChecklistStatus).omit({ \n  id: true, \n  createdAt: true\n});\n\nexport type InsertCallChecklistStatus = z.infer<typeof insertCallChecklistStatusSchema>;\nexport type CallChecklistStatus = typeof callChecklistStatus.$inferSelect;\n\n// Call Coaching Prompts - AI-generated prompts shown during calls\nexport const callCoachingPrompts = pgTable(\"call_coaching_prompts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  callId: varchar(\"call_id\").notNull().references(() => voiceCalls.id, { onDelete: \"cascade\" }),\n  promptType: varchar(\"prompt_type\", { length: 50 }).notNull(), // \"reminder\", \"suggestion\", \"warning\"\n  message: text(\"message\").notNull(),\n  relatedChecklistItemId: varchar(\"related_checklist_item_id\").references(() => salesChecklistItems.id),\n  triggerText: text(\"trigger_text\"), // what triggered this prompt\n  wasAcknowledged: boolean(\"was_acknowledged\").default(false),\n  acknowledgedAt: timestamp(\"acknowledged_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertCallCoachingPromptSchema = createInsertSchema(callCoachingPrompts).omit({ \n  id: true, \n  createdAt: true\n});\n\nexport type InsertCallCoachingPrompt = z.infer<typeof insertCallCoachingPromptSchema>;\nexport type CallCoachingPrompt = typeof callCoachingPrompts.$inferSelect;\n\n// ==================== BANKING STAFF & EXPENSE TRACKING ====================\n\n// Expense Categories - configurable categories for transactions\nexport const expenseCategories = pgTable(\"expense_categories\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: varchar(\"name\", { length: 100 }).notNull(),\n  icon: varchar(\"icon\", { length: 50 }),\n  color: varchar(\"color\", { length: 50 }),\n  keywords: text(\"keywords\").array(), // Keywords for auto-categorization (e.g., [\"fuel\", \"petrol\", \"caltex\"])\n  isDefault: boolean(\"is_default\").default(false).notNull(),\n  isActive: boolean(\"is_active\").default(true).notNull(),\n  sortOrder: integer(\"sort_order\").default(0).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const insertExpenseCategorySchema = createInsertSchema(expenseCategories).omit({ \n  id: true, \n  createdAt: true,\n  updatedAt: true\n});\n\nexport type InsertExpenseCategory = z.infer<typeof insertExpenseCategorySchema>;\nexport type ExpenseCategory = typeof expenseCategories.$inferSelect;\n\n// Receipt submission status enum\nexport const receiptStatusEnum = pgEnum(\"receipt_status\", [\n  \"pending\",\n  \"submitted\",\n  \"reviewed\",\n  \"matched\",\n  \"rejected\"\n]);\n\n// Receipt Submissions - staff can upload receipts via shareable link\nexport const receiptSubmissions = pgTable(\"receipt_submissions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  staffId: varchar(\"staff_id\").references(() => users.id),\n  submittedByStaffId: varchar(\"submitted_by_staff_id\").references(() => users.id),\n  submitterName: varchar(\"submitter_name\", { length: 200 }),\n  imageUrl: text(\"image_url\"),\n  photoUrl: text(\"photo_url\"),\n  expenseCategoryId: varchar(\"expense_category_id\").references(() => expenseCategories.id),\n  allocatedJobId: varchar(\"allocated_job_id\").references(() => jobs.id),\n  noJobAllocation: boolean(\"no_job_allocation\").default(false),\n  description: text(\"description\"),\n  expectedAmount: decimal(\"expected_amount\", { precision: 15, scale: 2 }),\n  actualAmount: decimal(\"actual_amount\", { precision: 15, scale: 2 }),\n  amount: decimal(\"amount\", { precision: 15, scale: 2 }),\n  merchantName: varchar(\"merchant_name\", { length: 200 }),\n  purchaseDate: timestamp(\"purchase_date\"),\n  notes: text(\"notes\"),\n  status: receiptStatusEnum(\"status\").default(\"pending\").notNull(),\n  matchedTransactionId: varchar(\"matched_transaction_id\"),\n  reviewedByUserId: varchar(\"reviewed_by_user_id\").references(() => users.id),\n  reviewedAt: timestamp(\"reviewed_at\"),\n  reviewNotes: text(\"review_notes\"),\n  submissionToken: varchar(\"submission_token\", { length: 100 }).notNull().unique(),\n  expiresAt: timestamp(\"expires_at\"),\n  submittedAt: timestamp(\"submitted_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const insertReceiptSubmissionSchema = createInsertSchema(receiptSubmissions).omit({ \n  id: true, \n  createdAt: true,\n  updatedAt: true\n}).partial({ photoUrl: true, imageUrl: true });\n\nexport type InsertReceiptSubmission = z.infer<typeof insertReceiptSubmissionSchema>;\nexport type ReceiptSubmission = typeof receiptSubmissions.$inferSelect;\n","path":null,"size_bytes":101986,"size_tokens":null},"client/src/pages/Jobs.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { JobCard } from \"@/components/jobs/JobCard\";\nimport { JobTimeline } from \"@/components/jobs/JobTimeline\";\nimport { JobSetupDocument } from \"@/components/jobs/JobSetupDocument\";\nimport { JobKanbanBoard } from \"@/components/jobs/JobKanbanBoard\";\nimport { ViewToggle } from \"@/components/jobs/ViewToggle\";\nimport { StatusBadge } from \"@/components/shared/StatusBadge\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Search,\n  Filter,\n  MapPin,\n  Phone,\n  Mail,\n  Calendar,\n  Package,\n  FileText,\n  Camera,\n  Briefcase,\n  Pencil,\n  Trash2,\n  Download,\n} from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Job, Client, ProductionTask, User, JobPipeline, JobPipelineStage, JobStageCompletion } from \"@shared/schema\";\nimport { Plus, UserPlus } from \"lucide-react\";\nimport { DialogTrigger } from \"@/components/ui/dialog\";\nimport { CreateClientDialog } from \"@/components/clients/CreateClientDialog\";\n\ntype JobStatus = \"in_progress\" | \"production\" | \"ready\" | \"scheduled\" | \"complete\";\n\ninterface DisplayJob {\n  id: string;\n  jobNumber: string;\n  invoiceNumber?: string;\n  clientName: string;\n  clientPhone: string;\n  clientEmail: string;\n  address: string;\n  fenceStyle: string;\n  jobType: \"supply\" | \"supply_install\";\n  status: JobStatus;\n  productionProgress: number;\n  scheduledDate?: string;\n  installer?: {\n    name: string;\n    initials: string;\n  };\n  totalValue: number;\n  depositPaid: boolean;\n  depositAmount: number;\n  balanceDue: number;\n}\n\ntype ViewMode = \"list\" | \"kanban\";\n\nexport default function Jobs() {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [selectedJobId, setSelectedJobId] = useState<string | null>(null);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);\n  const [isNewJobDialogOpen, setIsNewJobDialogOpen] = useState(false);\n  const [isCreateClientDialogOpen, setIsCreateClientDialogOpen] = useState(false);\n  const [editingJob, setEditingJob] = useState<Job | null>(null);\n  const [viewMode, setViewMode] = useState<ViewMode>(\"list\");\n  const [formData, setFormData] = useState({\n    status: \"\",\n    notes: \"\",\n    siteAddress: \"\",\n  });\n  const [newJobData, setNewJobData] = useState({\n    clientId: \"\",\n    jobType: \"supply_install\" as \"supply_only\" | \"supply_install\",\n    siteAddress: \"\",\n    notes: \"\",\n    totalAmount: \"\",\n  });\n\n  const { data: jobs = [], isLoading: jobsLoading } = useQuery<Job[]>({\n    queryKey: [\"/api/jobs\"],\n  });\n\n  const { data: users = [] } = useQuery<User[]>({\n    queryKey: [\"/api/users\"],\n  });\n\n  const { data: pipelines = [] } = useQuery<JobPipeline[]>({\n    queryKey: [\"/api/job-pipelines\"],\n  });\n\n  // Get the raw job for pipeline lookup\n  const rawSelectedJob = selectedJobId ? jobs.find(j => j.id === selectedJobId) : null;\n  const selectedPipelineId = rawSelectedJob?.pipelineId;\n\n  // Fetch stages for the selected job's pipeline\n  const { data: pipelineStages = [] } = useQuery<JobPipelineStage[]>({\n    queryKey: [\"/api/job-pipelines\", selectedPipelineId, \"stages\"],\n    enabled: !!selectedPipelineId,\n  });\n\n  // Fetch stage completions for the selected job\n  const { data: stageCompletions = [] } = useQuery<JobStageCompletion[]>({\n    queryKey: [\"/api/jobs\", selectedJobId, \"stage-completions\"],\n    enabled: !!selectedJobId,\n  });\n\n  const [loadingStageId, setLoadingStageId] = useState<string | null>(null);\n\n  const toggleStageMutation = useMutation({\n    mutationFn: async ({ jobId, stageId }: { jobId: string; stageId: string }) => {\n      setLoadingStageId(stageId);\n      return apiRequest(\"POST\", `/api/jobs/${jobId}/stage-completions/${stageId}/toggle`);\n    },\n    onSuccess: (_, variables) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/jobs\", variables.jobId, \"stage-completions\"] });\n      setLoadingStageId(null);\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to update stage\",\n        variant: \"destructive\",\n      });\n      setLoadingStageId(null);\n    },\n  });\n\n  const updateJobMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<Job> }) => {\n      return apiRequest(\"PATCH\", `/api/jobs/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/jobs\"] });\n      toast({\n        title: \"Job Updated\",\n        description: \"Job has been updated successfully\",\n      });\n      setIsEditDialogOpen(false);\n      setEditingJob(null);\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to update job\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteJobMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/jobs/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/jobs\"] });\n      toast({\n        title: \"Job Deleted\",\n        description: \"Job has been removed\",\n      });\n      setIsDeleteDialogOpen(false);\n      setSelectedJobId(null);\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to delete job\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const createDirectJobMutation = useMutation({\n    mutationFn: async (data: { clientId: string; jobType: string; siteAddress: string; notes?: string; totalAmount?: string }) => {\n      return apiRequest(\"POST\", \"/api/jobs/create-direct\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/jobs\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/leads\"] });\n      toast({\n        title: \"Job Created\",\n        description: \"New job has been created successfully\",\n      });\n      setIsNewJobDialogOpen(false);\n      setNewJobData({\n        clientId: \"\",\n        jobType: \"supply_install\",\n        siteAddress: \"\",\n        notes: \"\",\n        totalAmount: \"\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to create job\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleCreateDirectJob = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!newJobData.clientId || !newJobData.siteAddress) {\n      toast({\n        title: \"Error\",\n        description: \"Client and site address are required\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    createDirectJobMutation.mutate({\n      clientId: newJobData.clientId,\n      jobType: newJobData.jobType,\n      siteAddress: newJobData.siteAddress,\n      notes: newJobData.notes || undefined,\n      totalAmount: newJobData.totalAmount || undefined,\n    });\n  };\n\n  const handleEditJob = (job: Job) => {\n    setEditingJob(job);\n    setFormData({\n      status: job.status,\n      notes: job.notes || \"\",\n      siteAddress: job.siteAddress,\n    });\n    setIsEditDialogOpen(true);\n  };\n\n  const handleSubmitEdit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!editingJob) return;\n    \n    updateJobMutation.mutate({\n      id: editingJob.id,\n      data: {\n        status: formData.status as Job[\"status\"],\n        notes: formData.notes || undefined,\n        siteAddress: formData.siteAddress,\n      },\n    });\n  };\n\n  const { data: clients = [] } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const { data: productionTasks = [] } = useQuery<ProductionTask[]>({\n    queryKey: [\"/api/production-tasks\"],\n  });\n\n  const getClientInfo = (clientId: string | null) => {\n    if (!clientId) return { name: \"Unknown\", phone: \"\", email: \"\" };\n    const client = clients.find(c => c.id === clientId);\n    return {\n      name: client?.name || \"Unknown\",\n      phone: client?.phone || \"\",\n      email: client?.email || \"\",\n    };\n  };\n\n  const calculateProgress = (jobId: string): number => {\n    const jobTasks = productionTasks.filter(t => t.jobId === jobId);\n    if (jobTasks.length === 0) return 0;\n    const completed = jobTasks.filter(t => t.status === \"completed\").length;\n    return Math.round((completed / jobTasks.length) * 100);\n  };\n\n  const mapJobStatus = (status: string): JobStatus => {\n    switch (status) {\n      case \"pending_deposit\":\n      case \"deposit_received\":\n        return \"in_progress\";\n      case \"manufacturing_posts\":\n      case \"manufacturing_panels\":\n      case \"manufacturing_gates\":\n      case \"qa_check\":\n        return \"production\";\n      case \"ready_for_scheduling\":\n      case \"ready_for_pickup\":\n        return \"ready\";\n      case \"scheduled\":\n        return \"scheduled\";\n      case \"install_in_progress\":\n      case \"install_complete\":\n      case \"final_payment_pending\":\n      case \"completed\":\n        return \"complete\";\n      default:\n        return \"in_progress\";\n    }\n  };\n\n  const displayJobs: DisplayJob[] = jobs.map((job) => {\n    const clientInfo = getClientInfo(job.clientId);\n    const totalValue = parseFloat(job.totalAmount);\n    const depositAmount = parseFloat(job.depositAmount || \"0\");\n    \n    return {\n      id: job.id,\n      jobNumber: job.jobNumber,\n      invoiceNumber: job.invoiceNumber || undefined,\n      clientName: clientInfo.name,\n      clientPhone: clientInfo.phone,\n      clientEmail: clientInfo.email,\n      address: job.siteAddress,\n      fenceStyle: `${job.fenceStyle || \"Unknown\"} - ${job.fenceHeight}mm, ${job.totalLength}m`,\n      jobType: job.jobType === \"supply_install\" ? \"supply_install\" : \"supply\",\n      status: mapJobStatus(job.status),\n      productionProgress: calculateProgress(job.id),\n      scheduledDate: job.scheduledStartDate \n        ? new Date(job.scheduledStartDate).toLocaleDateString(\"en-AU\", { weekday: \"short\", day: \"numeric\", month: \"short\", year: \"numeric\" })\n        : undefined,\n      installer: job.assignedInstaller ? { name: \"Installer\", initials: \"IN\" } : undefined,\n      totalValue,\n      depositPaid: job.depositPaid || false,\n      depositAmount,\n      balanceDue: totalValue - depositAmount,\n    };\n  });\n\n  const selectedJob = displayJobs.find(j => j.id === selectedJobId) || null;\n\n  const jobTasks = selectedJob \n    ? productionTasks.filter(t => t.jobId === selectedJob.id)\n    : [];\n\n  // Build timeline stages from pipeline stages and completions\n  const completionMap = new Map(stageCompletions.map(c => [c.stageId, c]));\n  const timelineStages = pipelineStages\n    .filter(stage => stage.isActive)\n    .sort((a, b) => a.sortOrder - b.sortOrder)\n    .map(stage => {\n      const completion = completionMap.get(stage.id);\n      return {\n        id: stage.id,\n        title: stage.name,\n        icon: stage.icon || undefined,\n        isCompleted: !!completion,\n        completedAt: completion?.completedAt ? String(completion.completedAt) : undefined,\n      };\n    });\n\n  const handleToggleStage = (stageId: string) => {\n    if (!selectedJobId) return;\n    toggleStageMutation.mutate({ jobId: selectedJobId, stageId });\n  };\n\n  const filteredJobs = displayJobs.filter(\n    (job) =>\n      job.jobNumber.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      job.clientName.toLowerCase().includes(searchQuery.toLowerCase())\n  );\n\n  const handleJobClick = (job: DisplayJob) => {\n    setSelectedJobId(job.id);\n  };\n\n  const handleKanbanJobClick = (job: Job) => {\n    setSelectedJobId(job.id);\n    setViewMode(\"list\");\n  };\n\n  const handleJobStatusChange = (jobId: string, newStatus: string) => {\n    if (updateJobMutation.isPending) return;\n    \n    const previousJobs = queryClient.getQueryData<Job[]>([\"/api/jobs\"]);\n    \n    queryClient.setQueryData<Job[]>([\"/api/jobs\"], (old) => \n      old?.map(job => \n        job.id === jobId ? { ...job, status: newStatus as Job[\"status\"] } : job\n      )\n    );\n    \n    updateJobMutation.mutate(\n      { id: jobId, data: { status: newStatus as Job[\"status\"] } },\n      {\n        onError: () => {\n          queryClient.setQueryData([\"/api/jobs\"], previousJobs);\n          toast({\n            title: \"Error\",\n            description: \"Failed to move job. Please try again.\",\n            variant: \"destructive\",\n          });\n        },\n      }\n    );\n  };\n\n  if (viewMode === \"kanban\") {\n    return (\n      <div className=\"flex flex-col h-[calc(100vh-3.5rem)]\" data-testid=\"jobs-kanban-view\">\n        <div className=\"p-4 border-b flex items-center justify-between gap-4\">\n          <div className=\"flex items-center gap-4\">\n            <h1 className=\"text-xl font-semibold\" data-testid=\"text-jobs-title\">Jobs</h1>\n            <div className=\"relative max-w-xs\">\n              <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search jobs...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-9\"\n                data-testid=\"input-search-jobs\"\n              />\n            </div>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Button \n              size=\"sm\" \n              onClick={() => setIsNewJobDialogOpen(true)}\n              data-testid=\"button-new-job-kanban\"\n            >\n              <Plus className=\"h-4 w-4 mr-2\" />\n              New Job\n            </Button>\n            <ViewToggle viewMode={viewMode} onViewModeChange={setViewMode} />\n            <Button \n              variant=\"outline\" \n              size=\"sm\"\n              onClick={() => window.open(\"/api/export/jobs\", \"_blank\")}\n              data-testid=\"button-export-jobs\"\n            >\n              <Download className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </div>\n        <div className=\"flex-1 overflow-hidden\">\n          <JobKanbanBoard\n            jobs={searchQuery \n              ? jobs.filter(j => \n                  j.jobNumber.toLowerCase().includes(searchQuery.toLowerCase()) ||\n                  clients.find(c => c.id === j.clientId)?.name?.toLowerCase().includes(searchQuery.toLowerCase())\n                )\n              : jobs\n            }\n            clients={clients}\n            users={users}\n            isLoading={jobsLoading}\n            isUpdating={updateJobMutation.isPending}\n            onJobClick={handleKanbanJobClick}\n            onJobStatusChange={handleJobStatusChange}\n          />\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex h-[calc(100vh-3.5rem)]\">\n      <div className=\"w-96 border-r flex flex-col\">\n        <div className=\"p-4 border-b space-y-4\">\n          <div className=\"flex items-center justify-between gap-2\">\n            <h1 className=\"text-xl font-semibold\" data-testid=\"text-jobs-title\">Jobs</h1>\n            <ViewToggle viewMode={viewMode} onViewModeChange={setViewMode} />\n          </div>\n          <div className=\"relative\">\n            <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n            <Input\n              placeholder=\"Search jobs...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"pl-9\"\n              data-testid=\"input-search-jobs\"\n            />\n          </div>\n          <div className=\"flex gap-2\">\n            <Button \n              size=\"sm\" \n              onClick={() => setIsNewJobDialogOpen(true)}\n              data-testid=\"button-new-job\"\n            >\n              <Plus className=\"h-4 w-4 mr-2\" />\n              New Job\n            </Button>\n            <Button variant=\"outline\" size=\"sm\">\n              <Filter className=\"h-4 w-4 mr-2\" />\n              Filter\n            </Button>\n            <Button \n              variant=\"outline\" \n              size=\"sm\"\n              onClick={() => window.open(\"/api/export/jobs\", \"_blank\")}\n              data-testid=\"button-export-jobs\"\n            >\n              <Download className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </div>\n        <ScrollArea className=\"flex-1\">\n          <div className=\"p-4 space-y-3\">\n            {jobsLoading ? (\n              <>\n                <Skeleton className=\"h-32\" />\n                <Skeleton className=\"h-32\" />\n                <Skeleton className=\"h-32\" />\n              </>\n            ) : (\n              filteredJobs.map((job) => (\n                <div\n                  key={job.id}\n                  className={`cursor-pointer ${selectedJobId === job.id ? \"ring-2 ring-accent rounded-md\" : \"\"}`}\n                  onClick={() => handleJobClick(job)}\n                >\n                  <JobCard\n                    job={job}\n                    onUpdateStatus={() => toast({ title: \"Status updated\" })}\n                    onViewMaterials={() => toast({ title: \"Materials view\" })}\n                    onViewSchedule={() => toast({ title: \"Schedule view\" })}\n                  />\n                </div>\n              ))\n            )}\n            {!jobsLoading && filteredJobs.length === 0 && (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <p className=\"text-sm\">No jobs found</p>\n              </div>\n            )}\n          </div>\n        </ScrollArea>\n      </div>\n\n      <div className=\"flex-1 overflow-auto\">\n        {selectedJob ? (\n          <div className=\"p-6 space-y-6\">\n            <div className=\"flex items-start justify-between\">\n              <div>\n                <div className=\"flex items-center gap-3 mb-2\">\n                  <span className=\"font-mono text-sm text-muted-foreground\" data-testid=\"text-job-number\">{selectedJob.jobNumber}</span>\n                  {selectedJob.invoiceNumber && (\n                    <span className=\"font-mono text-sm text-muted-foreground\" data-testid=\"text-invoice-number\">\n                      {selectedJob.invoiceNumber}\n                    </span>\n                  )}\n                  <StatusBadge status={selectedJob.status} />\n                  <Badge variant=\"secondary\">\n                    {selectedJob.jobType === \"supply_install\" ? \"Supply + Install\" : \"Supply Only\"}\n                  </Badge>\n                </div>\n                <h2 className=\"text-2xl font-semibold\">{selectedJob.clientName}</h2>\n                <p className=\"text-muted-foreground\">{selectedJob.fenceStyle}</p>\n              </div>\n              <div className=\"flex gap-2\">\n                <Button \n                  variant=\"outline\" \n                  size=\"icon\"\n                  onClick={() => {\n                    const job = jobs.find(j => j.id === selectedJob.id);\n                    if (job) handleEditJob(job);\n                  }}\n                  data-testid=\"button-edit-job\"\n                >\n                  <Pencil className=\"h-4 w-4\" />\n                </Button>\n                <Button \n                  variant=\"outline\" \n                  size=\"icon\"\n                  onClick={() => setIsDeleteDialogOpen(true)}\n                  data-testid=\"button-delete-job\"\n                >\n                  <Trash2 className=\"h-4 w-4\" />\n                </Button>\n                <Button variant=\"outline\" data-testid=\"button-update-status\">Update Status</Button>\n                <Button data-testid=\"button-view-materials\">View Materials</Button>\n              </div>\n            </div>\n\n            <Tabs defaultValue=\"details\">\n              <TabsList>\n                <TabsTrigger value=\"details\" data-testid=\"tab-details\">Details</TabsTrigger>\n                <TabsTrigger value=\"timeline\" data-testid=\"tab-timeline\">Timeline</TabsTrigger>\n                {selectedJob.jobType === \"supply_install\" && (\n                  <TabsTrigger value=\"setup\" data-testid=\"tab-setup\">Setup & Handover</TabsTrigger>\n                )}\n                <TabsTrigger value=\"materials\" data-testid=\"tab-materials\">Materials</TabsTrigger>\n                <TabsTrigger value=\"documents\" data-testid=\"tab-documents\">Documents</TabsTrigger>\n                <TabsTrigger value=\"photos\" data-testid=\"tab-photos\">Photos</TabsTrigger>\n              </TabsList>\n\n              <TabsContent value=\"details\" className=\"space-y-6 mt-6\">\n                <div className=\"grid grid-cols-2 gap-6\">\n                  <Card>\n                    <CardHeader className=\"pb-3\">\n                      <CardTitle className=\"text-sm font-medium\">Client Information</CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-3\">\n                      <div className=\"flex items-center gap-2 text-sm\">\n                        <Phone className=\"h-4 w-4 text-muted-foreground\" />\n                        <span>{selectedJob.clientPhone || \"No phone\"}</span>\n                      </div>\n                      <div className=\"flex items-center gap-2 text-sm\">\n                        <Mail className=\"h-4 w-4 text-muted-foreground\" />\n                        <span>{selectedJob.clientEmail || \"No email\"}</span>\n                      </div>\n                      <div className=\"flex items-start gap-2 text-sm\">\n                        <MapPin className=\"h-4 w-4 text-muted-foreground mt-0.5\" />\n                        <span>{selectedJob.address}</span>\n                      </div>\n                    </CardContent>\n                  </Card>\n\n                  <Card>\n                    <CardHeader className=\"pb-3\">\n                      <CardTitle className=\"text-sm font-medium\">Financial Summary</CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-3\">\n                      <div className=\"flex items-center justify-between text-sm\">\n                        <span className=\"text-muted-foreground\">Total Value</span>\n                        <span className=\"font-semibold\">${selectedJob.totalValue.toLocaleString()}</span>\n                      </div>\n                      <div className=\"flex items-center justify-between text-sm\">\n                        <span className=\"text-muted-foreground\">Deposit</span>\n                        <div className=\"flex items-center gap-2\">\n                          <span className=\"font-medium\">${selectedJob.depositAmount.toLocaleString()}</span>\n                          <StatusBadge status={selectedJob.depositPaid ? \"paid\" : \"pending\"} />\n                        </div>\n                      </div>\n                      <div className=\"flex items-center justify-between text-sm border-t pt-3\">\n                        <span className=\"text-muted-foreground\">Balance Due</span>\n                        <span className=\"font-semibold text-lg\">${selectedJob.balanceDue.toLocaleString()}</span>\n                      </div>\n                    </CardContent>\n                  </Card>\n\n                  <Card>\n                    <CardHeader className=\"pb-3\">\n                      <CardTitle className=\"text-sm font-medium\">Schedule</CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-3\">\n                      {selectedJob.scheduledDate ? (\n                        <>\n                          <div className=\"flex items-center gap-2 text-sm\">\n                            <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                            <span>{selectedJob.scheduledDate}</span>\n                          </div>\n                          {selectedJob.installer && (\n                            <div className=\"flex items-center gap-2 text-sm\">\n                              <span className=\"text-muted-foreground\">Installer:</span>\n                              <span>{selectedJob.installer.name}</span>\n                            </div>\n                          )}\n                        </>\n                      ) : (\n                        <p className=\"text-sm text-muted-foreground\">Not yet scheduled</p>\n                      )}\n                    </CardContent>\n                  </Card>\n\n                  <Card>\n                    <CardHeader className=\"pb-3\">\n                      <CardTitle className=\"text-sm font-medium\">Production Progress</CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"space-y-2\">\n                        <div className=\"flex items-center justify-between text-sm\">\n                          <span className=\"text-muted-foreground\">Overall Progress</span>\n                          <span className=\"font-semibold\">{selectedJob.productionProgress}%</span>\n                        </div>\n                        <div className=\"h-2 bg-muted rounded-full overflow-hidden\">\n                          <div\n                            className=\"h-full bg-accent transition-all\"\n                            style={{ width: `${selectedJob.productionProgress}%` }}\n                          />\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"timeline\" className=\"mt-6\">\n                {timelineStages.length > 0 ? (\n                  <JobTimeline \n                    stages={timelineStages} \n                    onToggleStage={handleToggleStage}\n                    isLoading={toggleStageMutation.isPending}\n                    loadingStageId={loadingStageId}\n                  />\n                ) : (\n                  <Card>\n                    <CardContent className=\"py-8 text-center text-muted-foreground\">\n                      {!selectedPipelineId ? (\n                        <p>No pipeline assigned to this job. Assign a pipeline in Job Stage Configuration.</p>\n                      ) : (\n                        <p>No stages configured for this pipeline.</p>\n                      )}\n                    </CardContent>\n                  </Card>\n                )}\n              </TabsContent>\n\n              {selectedJob.jobType === \"supply_install\" && (\n                <TabsContent value=\"setup\" className=\"mt-6\">\n                  <JobSetupDocument\n                    jobId={String(selectedJob.id)}\n                    jobType={selectedJob.jobType as \"supply_only\" | \"supply_install\"}\n                  />\n                </TabsContent>\n              )}\n\n              <TabsContent value=\"materials\" className=\"mt-6\">\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                      <Package className=\"h-4 w-4\" />\n                      Bill of Materials\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center justify-between p-2 bg-muted rounded\">\n                        <span className=\"text-sm\">PVC Post 90x90 - 2.4m</span>\n                        <span className=\"font-mono text-sm\">x 15</span>\n                      </div>\n                      <div className=\"flex items-center justify-between p-2 bg-muted rounded\">\n                        <span className=\"text-sm\">PVC Rail 65x40 - 3.0m</span>\n                        <span className=\"font-mono text-sm\">x 48</span>\n                      </div>\n                      <div className=\"flex items-center justify-between p-2 bg-muted rounded\">\n                        <span className=\"text-sm\">PVC Picket 65x16 - 1.5m</span>\n                        <span className=\"font-mono text-sm\">x 180</span>\n                      </div>\n                      <div className=\"flex items-center justify-between p-2 bg-muted rounded\">\n                        <span className=\"text-sm\">Post Cap 90mm</span>\n                        <span className=\"font-mono text-sm\">x 15</span>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              </TabsContent>\n\n              <TabsContent value=\"documents\" className=\"mt-6\">\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                      <FileText className=\"h-4 w-4\" />\n                      Documents\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center justify-between p-3 border rounded hover-elevate cursor-pointer\">\n                        <div className=\"flex items-center gap-3\">\n                          <FileText className=\"h-5 w-5 text-muted-foreground\" />\n                          <div>\n                            <p className=\"text-sm font-medium\">Quote_{selectedJob.jobNumber}.pdf</p>\n                            <p className=\"text-xs text-muted-foreground\">Approved Quote</p>\n                          </div>\n                        </div>\n                        <Button variant=\"ghost\" size=\"sm\">Download</Button>\n                      </div>\n                      <div className=\"flex items-center justify-between p-3 border rounded hover-elevate cursor-pointer\">\n                        <div className=\"flex items-center gap-3\">\n                          <FileText className=\"h-5 w-5 text-muted-foreground\" />\n                          <div>\n                            <p className=\"text-sm font-medium\">Deposit_Invoice.pdf</p>\n                            <p className=\"text-xs text-muted-foreground\">Deposit Invoice</p>\n                          </div>\n                        </div>\n                        <Button variant=\"ghost\" size=\"sm\">Download</Button>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              </TabsContent>\n\n              <TabsContent value=\"photos\" className=\"mt-6\">\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                      <Camera className=\"h-4 w-4\" />\n                      Site Photos\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"text-center py-8 text-muted-foreground\">\n                      <Camera className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n                      <p className=\"text-sm\">No photos uploaded yet</p>\n                      <p className=\"text-xs\">Photos will appear here after installation begins</p>\n                    </div>\n                  </CardContent>\n                </Card>\n              </TabsContent>\n            </Tabs>\n          </div>\n        ) : (\n          <div className=\"flex items-center justify-center h-full text-muted-foreground\">\n            <div className=\"text-center\">\n              <Briefcase className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n              <p className=\"text-sm\">Select a job to view details</p>\n            </div>\n          </div>\n        )}\n      </div>\n\n      <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Edit Job</DialogTitle>\n            <DialogDescription>Update job information</DialogDescription>\n          </DialogHeader>\n          <form onSubmit={handleSubmitEdit} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-siteAddress\">Site Address</Label>\n              <Input \n                id=\"edit-siteAddress\" \n                placeholder=\"Enter site address\" \n                value={formData.siteAddress}\n                onChange={(e) => setFormData({ ...formData, siteAddress: e.target.value })}\n                data-testid=\"input-edit-job-address\" \n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-status\">Status</Label>\n              <Select \n                value={formData.status}\n                onValueChange={(value) => setFormData({ ...formData, status: value })}\n              >\n                <SelectTrigger data-testid=\"select-edit-job-status\">\n                  <SelectValue placeholder=\"Select status\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"pending_deposit\">Pending Deposit</SelectItem>\n                  <SelectItem value=\"deposit_received\">Deposit Received</SelectItem>\n                  <SelectItem value=\"manufacturing_posts\">Manufacturing Posts</SelectItem>\n                  <SelectItem value=\"manufacturing_panels\">Manufacturing Panels</SelectItem>\n                  <SelectItem value=\"manufacturing_gates\">Manufacturing Gates</SelectItem>\n                  <SelectItem value=\"qa_check\">QA Check</SelectItem>\n                  <SelectItem value=\"ready_for_scheduling\">Ready for Scheduling</SelectItem>\n                  <SelectItem value=\"ready_for_pickup\">Ready for Pickup</SelectItem>\n                  <SelectItem value=\"scheduled\">Scheduled</SelectItem>\n                  <SelectItem value=\"install_in_progress\">Install in Progress</SelectItem>\n                  <SelectItem value=\"install_complete\">Install Complete</SelectItem>\n                  <SelectItem value=\"final_payment_pending\">Final Payment Pending</SelectItem>\n                  <SelectItem value=\"completed\">Completed</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-notes\">Notes</Label>\n              <Textarea\n                id=\"edit-notes\"\n                placeholder=\"Add job notes...\"\n                value={formData.notes}\n                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n                data-testid=\"textarea-edit-job-notes\"\n              />\n            </div>\n            <div className=\"flex justify-end gap-2\">\n              <Button type=\"button\" variant=\"outline\" onClick={() => setIsEditDialogOpen(false)}>\n                Cancel\n              </Button>\n              <Button \n                type=\"submit\" \n                disabled={updateJobMutation.isPending}\n                data-testid=\"button-save-job\"\n              >\n                {updateJobMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n              </Button>\n            </div>\n          </form>\n        </DialogContent>\n      </Dialog>\n\n      <AlertDialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Delete Job {selectedJob?.jobNumber}</AlertDialogTitle>\n            <AlertDialogDescription>\n              This will permanently delete the job for \"{selectedJob?.clientName}\" at {selectedJob?.address}. \n              This action cannot be undone and will remove all associated production tasks, schedule events, and payment records.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => selectedJobId && deleteJobMutation.mutate(selectedJobId)}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              data-testid=\"button-confirm-delete-job\"\n            >\n              {deleteJobMutation.isPending ? \"Deleting...\" : \"Delete Job\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      <Dialog open={isNewJobDialogOpen} onOpenChange={setIsNewJobDialogOpen}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Create New Job</DialogTitle>\n            <DialogDescription>\n              Create a job directly without going through the leads flow. A lead will be created automatically for analytics.\n            </DialogDescription>\n          </DialogHeader>\n          <form onSubmit={handleCreateDirectJob} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"new-job-client\">Client</Label>\n              <div className=\"flex gap-2\">\n                <Select \n                  value={newJobData.clientId}\n                  onValueChange={(value) => setNewJobData({ ...newJobData, clientId: value })}\n                >\n                  <SelectTrigger data-testid=\"select-new-job-client\" className=\"flex-1\">\n                    <SelectValue placeholder=\"Select a client\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {clients.map((client) => (\n                      <SelectItem key={client.id} value={client.id}>\n                        {client.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  size=\"icon\"\n                  onClick={() => setIsCreateClientDialogOpen(true)}\n                  title=\"Create new client\"\n                  data-testid=\"button-create-new-client\"\n                >\n                  <UserPlus className=\"h-4 w-4\" />\n                </Button>\n              </div>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"new-job-type\">Job Type</Label>\n              <Select \n                value={newJobData.jobType}\n                onValueChange={(value) => setNewJobData({ ...newJobData, jobType: value as \"supply_only\" | \"supply_install\" })}\n              >\n                <SelectTrigger data-testid=\"select-new-job-type\">\n                  <SelectValue placeholder=\"Select job type\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"supply_install\">Supply + Install</SelectItem>\n                  <SelectItem value=\"supply_only\">Supply Only</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"new-job-address\">Site Address</Label>\n              <Input \n                id=\"new-job-address\" \n                placeholder=\"Enter site address\" \n                value={newJobData.siteAddress}\n                onChange={(e) => setNewJobData({ ...newJobData, siteAddress: e.target.value })}\n                data-testid=\"input-new-job-address\" \n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"new-job-amount\">Total Amount (optional)</Label>\n              <Input \n                id=\"new-job-amount\" \n                type=\"number\"\n                placeholder=\"0.00\" \n                value={newJobData.totalAmount}\n                onChange={(e) => setNewJobData({ ...newJobData, totalAmount: e.target.value })}\n                data-testid=\"input-new-job-amount\" \n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"new-job-notes\">Notes (optional)</Label>\n              <Textarea\n                id=\"new-job-notes\"\n                placeholder=\"Add job notes...\"\n                value={newJobData.notes}\n                onChange={(e) => setNewJobData({ ...newJobData, notes: e.target.value })}\n                data-testid=\"textarea-new-job-notes\"\n              />\n            </div>\n            <div className=\"flex justify-end gap-2\">\n              <Button type=\"button\" variant=\"outline\" onClick={() => setIsNewJobDialogOpen(false)}>\n                Cancel\n              </Button>\n              <Button \n                type=\"submit\" \n                disabled={createDirectJobMutation.isPending}\n                data-testid=\"button-submit-new-job\"\n              >\n                {createDirectJobMutation.isPending ? \"Creating...\" : \"Create Job\"}\n              </Button>\n            </div>\n          </form>\n        </DialogContent>\n      </Dialog>\n\n      <CreateClientDialog\n        open={isCreateClientDialogOpen}\n        onOpenChange={setIsCreateClientDialogOpen}\n        onClientCreated={(client) => {\n          setNewJobData({ ...newJobData, clientId: client.id });\n        }}\n        onSelectExistingClient={(client) => {\n          setNewJobData({ ...newJobData, clientId: client.id });\n        }}\n      />\n    </div>\n  );\n}\n\nfunction getTaskStatus(tasks: ProductionTask[], taskType: string): \"complete\" | \"current\" | \"pending\" {\n  const task = tasks.find(t => t.taskType === taskType);\n  if (!task) return \"pending\";\n  if (task.status === \"completed\") return \"complete\";\n  if (task.status === \"in_progress\") return \"current\";\n  return \"pending\";\n}\n","path":null,"size_bytes":41553,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1251,"size_tokens":null},"client/src/components/leads/LeadCard.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { StatusBadge } from \"@/components/shared/StatusBadge\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Phone, Mail, MapPin, Clock, MoreHorizontal, Pencil, Trash2, ClipboardList, Send, FileText, Pickaxe, MessageSquare, CheckSquare, User, AlertTriangle } from \"lucide-react\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\n\ninterface QuoteInfo {\n  total: number;\n  sent: number;\n  approved: number;\n  failed: number;\n  drafts: number;\n}\n\n// Soil warning display - only LIMESTONE is red badge, all others are gray text\nfunction SoilWarningDisplay({ warning }: { warning: string }) {\n  const warningUpper = warning.toUpperCase();\n  \n  // Only LIMESTONE gets red/destructive badge styling\n  if (warningUpper.includes(\"LIMESTONE\")) {\n    return (\n      <Badge variant=\"destructive\" className=\"h-5 px-1.5 text-[10px] gap-1\">\n        <Pickaxe className=\"h-3 w-3\" />\n        LIMESTONE\n      </Badge>\n    );\n  }\n  \n  // All other soil types - plain gray text\n  return (\n    <span className=\"text-xs text-muted-foreground\">{warningUpper}</span>\n  );\n}\n\ninterface Lead {\n  id: string;\n  leadNumber: string;\n  clientName: string;\n  phone: string;\n  email: string;\n  address: string;\n  source: string;\n  fenceStyle: string;\n  leadType: \"public\" | \"trade\";\n  jobFulfillmentType?: \"supply_only\" | \"supply_install\";\n  status: \"new\" | \"contacted\" | \"quoted\" | \"approved\" | \"declined\";\n  assignedTo: {\n    name: string;\n    initials: string;\n  };\n  createdAt: string;\n  quoteInfo?: QuoteInfo;\n  soilWarning?: string | null;\n  soilInstallNotes?: string | null;\n  hasUnreadMessages?: boolean;\n  hasPendingTasks?: boolean;\n  pendingTaskCount?: number;\n  isAssigned?: boolean;\n}\n\ninterface LeadCardProps {\n  lead: Lead;\n  onClick?: () => void;\n  onCreateQuote?: () => void;\n  onAddNote?: () => void;\n  onFollowUp?: () => void;\n  onEdit?: () => void;\n  onDelete?: () => void;\n  onViewSetupTemplate?: () => void;\n}\n\nexport function LeadCard({\n  lead,\n  onClick,\n  onCreateQuote,\n  onAddNote,\n  onFollowUp,\n  onEdit,\n  onDelete,\n  onViewSetupTemplate,\n}: LeadCardProps) {\n  return (\n    <Card\n      className=\"hover-elevate cursor-pointer\"\n      onClick={onClick}\n      data-testid={`lead-card-${lead.id}`}\n    >\n      <CardContent className=\"p-4\">\n        <div className=\"flex items-start justify-between mb-3\">\n          <div className=\"flex items-center gap-2 flex-wrap\">\n            <StatusBadge status={lead.leadType} />\n            <StatusBadge status={lead.status} />\n            {lead.jobFulfillmentType && (\n              <Badge \n                variant={lead.jobFulfillmentType === \"supply_install\" ? \"default\" : \"secondary\"}\n                className=\"text-xs\"\n                data-testid={`badge-job-type-${lead.id}`}\n              >\n                {lead.jobFulfillmentType === \"supply_install\" ? \"S+I\" : \"Supply\"}\n              </Badge>\n            )}\n          </div>\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>\n              <Button variant=\"ghost\" size=\"icon\" className=\"h-7 w-7\" data-testid={`button-lead-actions-${lead.id}`}>\n                <MoreHorizontal className=\"h-4 w-4\" />\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\">\n              <DropdownMenuItem onClick={(e) => { e.stopPropagation(); onEdit?.(); }} data-testid={`button-edit-lead-${lead.id}`}>\n                <Pencil className=\"h-4 w-4 mr-2\" />\n                Edit Lead\n              </DropdownMenuItem>\n              <DropdownMenuItem onClick={(e) => { e.stopPropagation(); onCreateQuote?.(); }} data-testid={`button-create-quote-${lead.id}`}>\n                Create Quote\n              </DropdownMenuItem>\n              <DropdownMenuItem onClick={(e) => { e.stopPropagation(); onAddNote?.(); }}>\n                Add Note\n              </DropdownMenuItem>\n              <DropdownMenuItem onClick={(e) => { e.stopPropagation(); onFollowUp?.(); }}>\n                Log Follow-up\n              </DropdownMenuItem>\n              {lead.jobFulfillmentType === \"supply_install\" && onViewSetupTemplate && (\n                <>\n                  <DropdownMenuSeparator />\n                  <DropdownMenuItem \n                    onClick={(e) => { e.stopPropagation(); onViewSetupTemplate?.(); }}\n                    data-testid={`button-view-setup-template-${lead.id}`}\n                  >\n                    <ClipboardList className=\"h-4 w-4 mr-2\" />\n                    View Setup Template\n                  </DropdownMenuItem>\n                </>\n              )}\n              <DropdownMenuSeparator />\n              <DropdownMenuItem \n                onClick={(e) => { e.stopPropagation(); onDelete?.(); }} \n                className=\"text-destructive focus:text-destructive\"\n                data-testid={`button-delete-lead-${lead.id}`}\n              >\n                <Trash2 className=\"h-4 w-4 mr-2\" />\n                Delete Lead\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n\n        <div className=\"flex items-center justify-between mb-1\">\n          <h3 className=\"font-semibold\">{lead.clientName}</h3>\n          <span className=\"text-xs font-mono text-muted-foreground\">{lead.leadNumber}</span>\n        </div>\n        <p className=\"text-sm text-muted-foreground mb-3\">{lead.fenceStyle}</p>\n\n        <div className=\"space-y-1.5 text-xs text-muted-foreground mb-3\">\n          <div className=\"flex items-center gap-2\">\n            <Phone className=\"h-3 w-3\" />\n            <span>{lead.phone}</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Mail className=\"h-3 w-3\" />\n            <span className=\"truncate\">{lead.email}</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <MapPin className=\"h-3 w-3\" />\n            <span className=\"truncate\">{lead.address}</span>\n          </div>\n          {lead.soilWarning && (\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <div className=\"flex items-center gap-1.5 mt-1\" data-testid={`soil-warning-${lead.id}`}>\n                  <SoilWarningDisplay warning={lead.soilWarning} />\n                </div>\n              </TooltipTrigger>\n              <TooltipContent side=\"top\" className=\"max-w-xs\">\n                <p className=\"text-xs\">{lead.soilInstallNotes || lead.soilWarning}</p>\n              </TooltipContent>\n            </Tooltip>\n          )}\n        </div>\n\n        <div className=\"flex items-center justify-between pt-3 border-t\">\n          <div className=\"flex items-center gap-2\">\n            <Avatar className=\"h-6 w-6\">\n              <AvatarFallback className=\"text-[10px] bg-muted\">\n                {lead.assignedTo.initials}\n              </AvatarFallback>\n            </Avatar>\n            <span className=\"text-xs text-muted-foreground\">{lead.assignedTo.name}</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            {lead.isAssigned && (\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div className=\"flex items-center\" data-testid={`assigned-indicator-${lead.id}`}>\n                    <Badge variant=\"secondary\" className=\"h-5 w-5 p-0 flex items-center justify-center\">\n                      <User className=\"h-3 w-3\" />\n                    </Badge>\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p className=\"font-semibold\">Staff Assigned</p>\n                  <p className=\"text-muted-foreground text-xs\">\n                    This lead has a staff member assigned to manage it\n                  </p>\n                </TooltipContent>\n              </Tooltip>\n            )}\n            {lead.hasPendingTasks && (\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div data-testid={`task-indicator-${lead.id}`}>\n                    <Badge \n                      variant=\"outline\" \n                      className=\"h-5 px-1.5 text-[10px] gap-0.5 border-warning text-warning\"\n                    >\n                      <CheckSquare className=\"h-3 w-3\" />\n                      {lead.pendingTaskCount || 0}\n                    </Badge>\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p className=\"font-semibold\">Pending Tasks</p>\n                  <p className=\"text-muted-foreground text-xs\">\n                    {lead.pendingTaskCount} task{lead.pendingTaskCount !== 1 ? 's' : ''} need{lead.pendingTaskCount === 1 ? 's' : ''} to be completed\n                  </p>\n                </TooltipContent>\n              </Tooltip>\n            )}\n            {lead.quoteInfo && lead.quoteInfo.total > 0 && (\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div className=\"flex items-center gap-1\" data-testid={`quote-indicator-${lead.id}`}>\n                    {lead.quoteInfo.approved > 0 ? (\n                      <Badge variant=\"default\" className=\"h-5 px-1.5 text-[10px] bg-success text-success-foreground\">\n                        <FileText className=\"h-3 w-3 mr-0.5\" />\n                        {lead.quoteInfo.approved}\n                      </Badge>\n                    ) : lead.quoteInfo.failed > 0 ? (\n                      <Badge variant=\"destructive\" className=\"h-5 px-1.5 text-[10px]\">\n                        <AlertTriangle className=\"h-3 w-3 mr-0.5\" />\n                        Failed\n                      </Badge>\n                    ) : lead.quoteInfo.sent > 0 ? (\n                      <Badge variant=\"default\" className=\"h-5 px-1.5 text-[10px] bg-warning text-warning-foreground\">\n                        <Send className=\"h-3 w-3 mr-0.5\" />\n                        {lead.quoteInfo.sent}\n                      </Badge>\n                    ) : lead.quoteInfo.drafts > 0 ? (\n                      <Badge variant=\"outline\" className=\"h-5 px-1.5 text-[10px]\">\n                        <FileText className=\"h-3 w-3 mr-0.5\" />\n                        {lead.quoteInfo.drafts} draft{lead.quoteInfo.drafts !== 1 ? 's' : ''}\n                      </Badge>\n                    ) : null}\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p className=\"font-semibold mb-1\">Quote Status</p>\n                  {lead.quoteInfo.approved > 0 && <p className=\"text-success\"> {lead.quoteInfo.approved} quote{lead.quoteInfo.approved !== 1 ? 's' : ''} approved</p>}\n                  {lead.quoteInfo.sent > 0 && <p className=\"text-warning\"> {lead.quoteInfo.sent} quote{lead.quoteInfo.sent !== 1 ? 's' : ''} sent to customer</p>}\n                  {lead.quoteInfo.failed > 0 && <p className=\"text-destructive\"> {lead.quoteInfo.failed} quote{lead.quoteInfo.failed !== 1 ? 's' : ''} failed to send</p>}\n                  {lead.quoteInfo.drafts > 0 && <p className=\"text-muted-foreground\"> {lead.quoteInfo.drafts} draft{lead.quoteInfo.drafts !== 1 ? 's' : ''} (not sent yet)</p>}\n                </TooltipContent>\n              </Tooltip>\n            )}\n            <div className=\"flex items-center gap-1 text-xs text-muted-foreground\">\n              <Clock className=\"h-3 w-3\" />\n              <span>{lead.createdAt}</span>\n            </div>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":11732,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"client/src/components/dashboard/AlertsPanel.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { AlertTriangle, Package, Clock, CreditCard, X } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ntype AlertType = \"stock\" | \"overdue\" | \"payment\" | \"general\";\n\ninterface Alert {\n  id: string;\n  type: AlertType;\n  title: string;\n  message: string;\n  actionLabel?: string;\n  onAction?: () => void;\n}\n\ninterface AlertsPanelProps {\n  alerts: Alert[];\n  onDismiss?: (id: string) => void;\n}\n\nconst alertConfig: Record<AlertType, { icon: typeof AlertTriangle; color: string }> = {\n  stock: {\n    icon: Package,\n    color: \"text-warning bg-warning/10\",\n  },\n  overdue: {\n    icon: Clock,\n    color: \"text-destructive bg-destructive/10\",\n  },\n  payment: {\n    icon: CreditCard,\n    color: \"text-accent bg-accent/10\",\n  },\n  general: {\n    icon: AlertTriangle,\n    color: \"text-muted-foreground bg-muted\",\n  },\n};\n\nexport function AlertsPanel({ alerts, onDismiss }: AlertsPanelProps) {\n  if (alerts.length === 0) {\n    return null;\n  }\n\n  return (\n    <Card>\n      <CardHeader className=\"pb-3\">\n        <CardTitle className=\"text-base font-semibold flex items-center gap-2\">\n          <AlertTriangle className=\"h-4 w-4 text-accent\" />\n          Alerts & Notifications\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-2\">\n        {alerts.map((alert) => {\n          const config = alertConfig[alert.type];\n          const Icon = config.icon;\n          return (\n            <div\n              key={alert.id}\n              className=\"flex items-start gap-3 p-3 rounded-md bg-muted/50\"\n              data-testid={`alert-${alert.id}`}\n            >\n              <div className={cn(\"flex h-8 w-8 items-center justify-center rounded-md\", config.color)}>\n                <Icon className=\"h-4 w-4\" />\n              </div>\n              <div className=\"flex-1 min-w-0\">\n                <p className=\"text-sm font-medium\">{alert.title}</p>\n                <p className=\"text-xs text-muted-foreground mt-0.5\">{alert.message}</p>\n                {alert.actionLabel && alert.onAction && (\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    className=\"h-auto p-0 mt-1 text-xs text-accent hover:text-accent/80\"\n                    onClick={alert.onAction}\n                  >\n                    {alert.actionLabel}\n                  </Button>\n                )}\n              </div>\n              {onDismiss && (\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  className=\"h-6 w-6\"\n                  onClick={() => onDismiss(alert.id)}\n                  data-testid={`button-dismiss-alert-${alert.id}`}\n                >\n                  <X className=\"h-3 w-3\" />\n                </Button>\n              )}\n            </div>\n          );\n        })}\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":2960,"size_tokens":null},"client/src/components/examples/ProductionOverviewExample.tsx":{"content":"import { ProductionOverview } from \"@/components/dashboard/ProductionOverview\";\n\nexport default function ProductionOverviewExample() {\n  const stages = [\n    { stage: \"cutting\" as const, jobCount: 4, progress: 75 },\n    { stage: \"routing\" as const, jobCount: 3, progress: 60 },\n    { stage: \"assembly\" as const, jobCount: 5, progress: 40 },\n    { stage: \"qa\" as const, jobCount: 2, progress: 90 },\n  ];\n\n  return (\n    <ProductionOverview\n      stages={stages}\n      totalActiveJobs={14}\n      onViewProduction={() => console.log(\"View production clicked\")}\n    />\n  );\n}\n","path":null,"size_bytes":572,"size_tokens":null},"design_guidelines.md":{"content":"# Probuild PVC ERP & CRM Design Guidelines\n\n## Design Approach\n\n**Selected Framework**: Carbon Design System (IBM) with Material Design principles for mobile components\n\n**Justification**: This enterprise manufacturing ERP requires clarity, efficiency, and scalability across multiple user roles. Carbon excels at data-heavy interfaces with complex workflows while maintaining accessibility and consistency. Material Design enhances mobile experiences for the Installer App.\n\n**Core Principles**:\n1. **Clarity over decoration** - information hierarchy drives every decision\n2. **Role-based consistency** - each user type gets optimized layouts for their tasks\n3. **Progressive disclosure** - reveal complexity only when needed\n4. **Action-oriented** - primary actions always clear and accessible\n\n---\n\n## Typography\n\n**Font Family**: \n- Primary: IBM Plex Sans (via Google Fonts)\n- Monospace: IBM Plex Mono (for job numbers, SKUs, technical data)\n\n**Type Scale**:\n- Page Titles: text-4xl font-semibold (36px)\n- Section Headers: text-2xl font-semibold (24px)\n- Card/Panel Headers: text-lg font-medium (18px)\n- Body Text: text-base (16px)\n- Secondary/Labels: text-sm (14px)\n- Helper Text: text-xs (12px)\n\n**Hierarchy Rules**:\n- All caps for status badges and category labels\n- Semibold for critical data points (totals, statuses)\n- Regular weight for descriptive content\n- Maintain 1.5 line-height for readability in data tables\n\n---\n\n## Layout System\n\n**Spacing Primitives**: Tailwind units of **2, 4, 6, 8, 12, 16** (8px base grid)\n- Component padding: p-4, p-6\n- Section spacing: space-y-6, space-y-8\n- Card margins: m-4, gap-6\n- Dense data tables: p-2, space-y-2\n\n**Grid System**:\n- Desktop: 12-column grid with max-w-7xl container\n- Tablets: 8-column grid, max-w-4xl\n- Mobile: Single column, full-width with px-4 gutters\n\n**Layout Patterns**:\n- **Dashboard**: 3-column grid (lg:grid-cols-3) for widgets, 2-column on tablets\n- **Data Tables**: Full-width with horizontal scroll on mobile\n- **Forms**: 2-column (md:grid-cols-2) with full-width on mobile\n- **Sidebars**: Fixed 256px left navigation for internal tools, collapsible on mobile\n\n---\n\n## Component Library\n\n### Navigation\n**Internal System (Admin/Production/Sales)**:\n- Fixed left sidebar (w-64) with collapsible menu\n- Top bar: breadcrumbs, user profile, notifications, quick actions\n- Bottom navigation for mobile (4-5 primary actions)\n\n**Trade Portal**:\n- Horizontal top navigation with dropdown menus\n- Sticky header on scroll\n- Mobile: hamburger menu\n\n### Data Display\n**Tables**:\n- Striped rows for readability\n- Sticky headers on scroll\n- Sortable columns with icon indicators\n- Row actions in rightmost column (kebab menu)\n- Pagination: 20/50/100 items per page\n\n**Cards**:\n- Elevated shadow (shadow-md) for clickable items\n- Flat (border border-gray-200) for static content\n- Header with title + action buttons\n- Body with consistent p-6 padding\n\n**Status Indicators**:\n- Pills/badges with icon + label\n- Size: px-3 py-1 rounded-full text-xs font-semibold\n- Icons from Heroicons (outline style)\n\n### Forms & Inputs\n**Input Fields**:\n- Height: h-10 (40px touch target)\n- Border: border-2 with focus:ring-2 states\n- Labels: text-sm font-medium mb-1\n- Helper text: text-xs below input\n- Error states: red border + message\n\n**Buttons**:\n- Primary: px-6 py-2.5 rounded-md font-medium\n- Secondary: outlined variant\n- Tertiary: text-only with underline on hover\n- Icon buttons: w-10 h-10 rounded-md (square)\n\n**Selects/Dropdowns**:\n- Match input height (h-10)\n- Chevron icon right-aligned\n- Multi-select with tag display\n\n### Specialized Components\n**Calendar (Scheduling)**:\n- Week view as default\n- Color-coded event types (Production: blue, Install: green, Delivery: orange)\n- Drag-and-drop capability\n- Mini calendar sidebar for date selection\n\n**Kanban Board (Leads)**:\n- 4-6 columns with horizontal scroll\n- Card width: w-80 (320px)\n- Drag handles, compact card design\n- Column headers with count badges\n\n**Photo Upload (Installer App)**:\n- Grid display (grid-cols-2 gap-4)\n- Thumbnail preview with expand modal\n- Camera icon for new uploads\n- Before/After labels\n\n**Production Task Lists**:\n- Checkbox with strikethrough on completion\n- Progress bar showing overall completion\n- Time tracking inline (start/stop buttons)\n- Material usage input fields\n\n---\n\n## Module-Specific Layouts\n\n### Dashboard\n- 3-column widget grid (1-2 columns on mobile)\n- Each widget: h-auto min-h-64, consistent padding\n- Quick action buttons at top right\n- Notification center: slide-out panel from right\n\n### Job Manager\n- Split view: Left 30% (job list), Right 70% (job details)\n- Tabbed interface for Details/Materials/Timeline/Documents\n- Timeline: vertical with icons and status updates\n- Mobile: stack vertically with tabs\n\n### Production Manager\n- Top: filters and date selector\n- Main: task queue as sortable table\n- Right sidebar: active timers and alerts\n- Bottom: stock usage summary\n\n### Trade Portal\n- Hero section with account overview (orders, credit, status)\n- Grid of recent quotes (3 columns desktop, 1 mobile)\n- Footer with installation resources and support links\n\n---\n\n## Mobile Strategy (Installer App)\n\n**Framework**: Material Design principles\n- Bottom navigation (4 tabs: Home, Jobs, Photos, Profile)\n- FAB (Floating Action Button) for primary actions\n- Swipe gestures for job transitions\n- Large touch targets (min 44px)\n- Bottom sheets for forms\n\n---\n\n## Animations\n\n**Minimal, purposeful only**:\n- Page transitions: fade (200ms)\n- Dropdown menus: slide down (150ms)\n- Modals: scale + fade (200ms)\n- Loading states: skeleton screens (no spinners)\n- Success confirmations: checkmark animation (300ms)\n\n**NO animations for**:\n- Table sorting\n- Form validation\n- Status updates\n- Card interactions\n\n---\n\n## Accessibility\n\n- WCAG 2.1 AA compliance minimum\n- Focus indicators: ring-2 ring-offset-2\n- Skip navigation links\n- ARIA labels on all interactive elements\n- Keyboard navigation: Tab, Enter, Escape patterns\n- Screen reader announcements for status changes\n\n---\n\n## Images\n\n**No hero images** - this is a utility application focused on data and workflows.\n\n**Image Usage**:\n- **Product thumbnails**: 80x80px in tables, 200x200px in details\n- **Job site photos**: Full-width in modals, thumbnails in grids\n- **Installer photos**: Before/after comparison layout\n- **Profile avatars**: 32px circular (navigation), 48px (profiles)\n- **Empty states**: Simple illustrations (400x300px) for empty lists/tables\n\nAll images: lazy-loaded, optimized WebP format with fallbacks.","path":null,"size_bytes":6543,"size_tokens":null},"client/src/components/examples/JobCardExample.tsx":{"content":"import { JobCard } from \"@/components/jobs/JobCard\";\n\nexport default function JobCardExample() {\n  const job = {\n    id: \"job-001\",\n    jobNumber: \"JOB-2024-089\",\n    clientName: \"Williams Family\",\n    address: \"42 Ocean Drive, Scarborough WA 6019\",\n    fenceStyle: \"Hampton Style - 1.8m height, 25m length\",\n    jobType: \"supply_install\" as const,\n    status: \"production\" as const,\n    productionProgress: 65,\n    scheduledDate: \"Wed, 11 Dec 2024\",\n    installer: {\n      name: \"Jake Morrison\",\n      initials: \"JM\",\n    },\n    totalValue: 8500,\n    depositPaid: true,\n  };\n\n  return (\n    <div className=\"p-4 max-w-sm\">\n      <JobCard\n        job={job}\n        onClick={() => console.log(\"Job clicked\")}\n        onUpdateStatus={() => console.log(\"Update status\")}\n        onViewMaterials={() => console.log(\"View materials\")}\n        onViewSchedule={() => console.log(\"View schedule\")}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":916,"size_tokens":null},"server/vite.ts":{"content":"import { type Express } from \"express\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport async function setupVite(server: Server, app: Express) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server, path: \"/vite-hmr\" },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n","path":null,"size_bytes":1534,"size_tokens":null},"client/src/components/shared/StatCard.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { cn } from \"@/lib/utils\";\nimport { LucideIcon } from \"lucide-react\";\n\ninterface StatCardProps {\n  title: string;\n  value: string | number;\n  description?: string;\n  icon?: LucideIcon;\n  trend?: {\n    value: number;\n    isPositive: boolean;\n  };\n  className?: string;\n}\n\nexport function StatCard({\n  title,\n  value,\n  description,\n  icon: Icon,\n  trend,\n  className,\n}: StatCardProps) {\n  return (\n    <Card className={cn(\"hover-elevate\", className)}>\n      <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n        <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n          {title}\n        </CardTitle>\n        {Icon && (\n          <div className=\"flex h-8 w-8 items-center justify-center rounded-md bg-muted\">\n            <Icon className=\"h-4 w-4 text-muted-foreground\" />\n          </div>\n        )}\n      </CardHeader>\n      <CardContent>\n        <div className=\"text-2xl font-bold\" data-testid={`stat-value-${title.toLowerCase().replace(/\\s+/g, '-')}`}>\n          {value}\n        </div>\n        {description && (\n          <p className=\"text-xs text-muted-foreground mt-1\">{description}</p>\n        )}\n        {trend && (\n          <p\n            className={cn(\n              \"text-xs mt-1 font-medium\",\n              trend.isPositive ? \"text-success\" : \"text-destructive\"\n            )}\n          >\n            {trend.isPositive ? \"+\" : \"-\"}{Math.abs(trend.value)}% from last month\n          </p>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":1598,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":1080,"size_tokens":null},"client/src/components/inventory/InventoryTable.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { StatusBadge } from \"@/components/shared/StatusBadge\";\nimport { DataTable, Column, Action } from \"@/components/shared/DataTable\";\nimport { Search, Plus, Filter, Download } from \"lucide-react\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\n\ninterface Product {\n  id: string;\n  sku: string;\n  name: string;\n  category: string;\n  stockOnHand: number;\n  reorderPoint: number;\n  costPrice: number;\n  sellPrice: number;\n  status: \"in_stock\" | \"low_stock\" | \"out_of_stock\";\n}\n\ninterface InventoryTableProps {\n  products: Product[];\n  onProductClick?: (product: Product) => void;\n  onAddProduct?: () => void;\n  onAdjustStock?: (product: Product) => void;\n  showCostPrice?: boolean;\n}\n\nexport function InventoryTable({\n  products,\n  onProductClick,\n  onAddProduct,\n  onAdjustStock,\n  showCostPrice = true,\n}: InventoryTableProps) {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [categoryFilter, setCategoryFilter] = useState<string>(\"all\");\n\n  const categories = Array.from(new Set(products.map((p) => p.category)));\n\n  const filteredProducts = products.filter((product) => {\n    const matchesSearch =\n      product.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      product.sku.toLowerCase().includes(searchQuery.toLowerCase());\n    const matchesCategory =\n      categoryFilter === \"all\" || product.category === categoryFilter;\n    return matchesSearch && matchesCategory;\n  });\n\n  const getStockStatus = (product: Product): \"in_stock\" | \"low_stock\" | \"out_of_stock\" => {\n    if (product.stockOnHand === 0) return \"out_of_stock\";\n    if (product.stockOnHand <= product.reorderPoint) return \"low_stock\";\n    return \"in_stock\";\n  };\n\n  const columns: Column<Product>[] = [\n    {\n      key: \"sku\",\n      header: \"SKU\",\n      sortable: true,\n      render: (product) => (\n        <span className=\"font-mono text-sm\">{product.sku}</span>\n      ),\n    },\n    {\n      key: \"name\",\n      header: \"Product Name\",\n      sortable: true,\n      render: (product) => (\n        <div>\n          <span className=\"font-medium\">{product.name}</span>\n          <Badge variant=\"secondary\" className=\"ml-2 text-[10px]\">\n            {product.category}\n          </Badge>\n        </div>\n      ),\n    },\n    {\n      key: \"stockOnHand\",\n      header: \"Stock\",\n      sortable: true,\n      render: (product) => {\n        const status = getStockStatus(product);\n        return (\n          <div className=\"flex items-center gap-2\">\n            <span className=\"font-medium\">{product.stockOnHand}</span>\n            {status === \"low_stock\" && (\n              <StatusBadge status=\"low_stock\" />\n            )}\n            {status === \"out_of_stock\" && (\n              <Badge variant=\"destructive\" className=\"text-[10px]\">OUT</Badge>\n            )}\n          </div>\n        );\n      },\n    },\n    {\n      key: \"reorderPoint\",\n      header: \"Reorder At\",\n      sortable: true,\n    },\n    ...(showCostPrice\n      ? [\n          {\n            key: \"costPrice\",\n            header: \"Cost\",\n            sortable: true,\n            render: (product: Product) => `$${product.costPrice.toFixed(2)}`,\n          } as Column<Product>,\n        ]\n      : []),\n    {\n      key: \"sellPrice\",\n      header: \"Sell Price\",\n      sortable: true,\n      render: (product) => `$${product.sellPrice.toFixed(2)}`,\n    },\n  ];\n\n  const actions: Action<Product>[] = [\n    {\n      label: \"Adjust Stock\",\n      onClick: (product) => onAdjustStock?.(product),\n    },\n    {\n      label: \"View Details\",\n      onClick: (product) => onProductClick?.(product),\n    },\n  ];\n\n  return (\n    <Card>\n      <CardHeader className=\"pb-4\">\n        <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n          <CardTitle className=\"text-base font-semibold\">Products & Inventory</CardTitle>\n          <div className=\"flex items-center gap-2\">\n            <Button variant=\"outline\" size=\"sm\">\n              <Download className=\"h-4 w-4 mr-2\" />\n              Export\n            </Button>\n            {onAddProduct && (\n              <Button size=\"sm\" onClick={onAddProduct} data-testid=\"button-add-product\">\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Add Product\n              </Button>\n            )}\n          </div>\n        </div>\n        <div className=\"flex flex-col gap-2 sm:flex-row sm:items-center mt-4\">\n          <div className=\"relative flex-1\">\n            <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n            <Input\n              placeholder=\"Search by name or SKU...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"pl-9\"\n              data-testid=\"input-search-products\"\n            />\n          </div>\n          <Select value={categoryFilter} onValueChange={setCategoryFilter}>\n            <SelectTrigger className=\"w-[180px]\" data-testid=\"select-category-filter\">\n              <Filter className=\"h-4 w-4 mr-2\" />\n              <SelectValue placeholder=\"Category\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">All Categories</SelectItem>\n              {categories.map((category) => (\n                <SelectItem key={category} value={category}>\n                  {category}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n      </CardHeader>\n      <CardContent>\n        <DataTable\n          data={filteredProducts}\n          columns={columns}\n          actions={actions}\n          onRowClick={onProductClick}\n          keyExtractor={(product) => product.id}\n          emptyMessage=\"No products found\"\n        />\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":6046,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4420,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"client/src/components/production/TaskQueue.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Play, Pause, Clock, User } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { useState } from \"react\";\n\ntype TaskType = \"cutting\" | \"routing\" | \"assembly\" | \"qa\";\ntype TaskStatus = \"pending\" | \"in_progress\" | \"complete\";\n\ninterface ProductionTask {\n  id: string;\n  jobNumber: string;\n  clientName: string;\n  taskType: TaskType;\n  status: TaskStatus;\n  assignedTo?: string;\n  estimatedTime: number;\n  timeSpent: number;\n  materials: string[];\n}\n\ninterface TaskQueueProps {\n  tasks: ProductionTask[];\n  onStartTask?: (task: ProductionTask) => void;\n  onPauseTask?: (task: ProductionTask) => void;\n  onCompleteTask?: (task: ProductionTask) => void;\n}\n\nconst taskTypeConfig: Record<TaskType, { label: string; color: string }> = {\n  cutting: { label: \"Cutting\", color: \"bg-chart-1\" },\n  routing: { label: \"Routing\", color: \"bg-chart-2\" },\n  assembly: { label: \"Assembly\", color: \"bg-chart-3\" },\n  qa: { label: \"QA\", color: \"bg-chart-4\" },\n};\n\nexport function TaskQueue({\n  tasks,\n  onStartTask,\n  onPauseTask,\n  onCompleteTask,\n}: TaskQueueProps) {\n  const [expandedTask, setExpandedTask] = useState<string | null>(null);\n\n  const formatTime = (minutes: number) => {\n    const hours = Math.floor(minutes / 60);\n    const mins = minutes % 60;\n    return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;\n  };\n\n  return (\n    <Card>\n      <CardHeader className=\"pb-3\">\n        <div className=\"flex items-center justify-between\">\n          <CardTitle className=\"text-base font-semibold\">Production Queue</CardTitle>\n          <Badge variant=\"secondary\">{tasks.filter(t => t.status !== \"complete\").length} pending</Badge>\n        </div>\n      </CardHeader>\n      <CardContent className=\"space-y-3\">\n        {tasks.map((task) => {\n          const config = taskTypeConfig[task.taskType];\n          const progress = task.estimatedTime > 0 \n            ? Math.min((task.timeSpent / task.estimatedTime) * 100, 100)\n            : 0;\n          const isExpanded = expandedTask === task.id;\n\n          return (\n            <div\n              key={task.id}\n              className={cn(\n                \"p-3 rounded-md border\",\n                task.status === \"in_progress\" && \"border-accent bg-accent/5\",\n                task.status === \"complete\" && \"opacity-60\"\n              )}\n              data-testid={`task-${task.id}`}\n            >\n              <div className=\"flex items-start gap-3\">\n                <Checkbox\n                  checked={task.status === \"complete\"}\n                  onCheckedChange={() => onCompleteTask?.(task)}\n                  disabled={task.status === \"pending\"}\n                  data-testid={`checkbox-task-${task.id}`}\n                />\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"flex items-center gap-2 mb-1\">\n                    <span className=\"font-mono text-xs text-muted-foreground\">\n                      {task.jobNumber}\n                    </span>\n                    <Badge\n                      variant=\"secondary\"\n                      className={cn(\"text-[10px]\", config.color, \"text-white\")}\n                    >\n                      {config.label}\n                    </Badge>\n                  </div>\n                  <p className={cn(\n                    \"text-sm font-medium\",\n                    task.status === \"complete\" && \"line-through\"\n                  )}>\n                    {task.clientName}\n                  </p>\n                  \n                  <div className=\"flex items-center gap-4 mt-2 text-xs text-muted-foreground\">\n                    <div className=\"flex items-center gap-1\">\n                      <Clock className=\"h-3 w-3\" />\n                      <span>{formatTime(task.timeSpent)} / {formatTime(task.estimatedTime)}</span>\n                    </div>\n                    {task.assignedTo && (\n                      <div className=\"flex items-center gap-1\">\n                        <User className=\"h-3 w-3\" />\n                        <span>{task.assignedTo}</span>\n                      </div>\n                    )}\n                  </div>\n\n                  {task.status === \"in_progress\" && (\n                    <Progress value={progress} className=\"h-1 mt-2\" />\n                  )}\n\n                  {isExpanded && (\n                    <div className=\"mt-3 pt-3 border-t\">\n                      <p className=\"text-xs font-medium mb-1\">Materials:</p>\n                      <ul className=\"text-xs text-muted-foreground space-y-0.5\">\n                        {task.materials.map((material, idx) => (\n                          <li key={idx}>- {material}</li>\n                        ))}\n                      </ul>\n                    </div>\n                  )}\n                </div>\n\n                <div className=\"flex items-center gap-1\">\n                  {task.status === \"pending\" && (\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      className=\"h-8 w-8\"\n                      onClick={() => onStartTask?.(task)}\n                      data-testid={`button-start-task-${task.id}`}\n                    >\n                      <Play className=\"h-4 w-4\" />\n                    </Button>\n                  )}\n                  {task.status === \"in_progress\" && (\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      className=\"h-8 w-8\"\n                      onClick={() => onPauseTask?.(task)}\n                      data-testid={`button-pause-task-${task.id}`}\n                    >\n                      <Pause className=\"h-4 w-4\" />\n                    </Button>\n                  )}\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => setExpandedTask(isExpanded ? null : task.id)}\n                  >\n                    {isExpanded ? \"Less\" : \"More\"}\n                  </Button>\n                </div>\n              </div>\n            </div>\n          );\n        })}\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":6346,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n  \" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n        outline:\n          // Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color.\n          \" border [border-color:var(--button-outline)]  shadow-xs active:shadow-none \",\n        secondary: \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // Add a transparent border so that when someone toggles a border on later, it doesn't shift layout/size.\n        ghost: \"border border-transparent\",\n      },\n      // Heights are set as \"min\" heights, because sometimes Ai will place large amount of content\n      // inside buttons. With a min-height they will look appropriate with small amounts of content,\n      // but will expand to fit large amounts of content.\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2359,"size_tokens":null},"client/src/components/examples/ClientCardExample.tsx":{"content":"import { ClientCard } from \"@/components/clients/ClientCard\";\n\nexport default function ClientCardExample() {\n  const client = {\n    id: \"client-001\",\n    name: \"Pacific Builders Pty Ltd\",\n    phone: \"08 9123 4567\",\n    email: \"orders@pacificbuilders.com.au\",\n    address: \"15 Industrial Way, Malaga WA 6090\",\n    clientType: \"trade\" as const,\n    tradeDiscountLevel: 15,\n    totalQuotes: 24,\n    totalJobs: 18,\n    totalSpent: 156000,\n  };\n\n  return (\n    <div className=\"p-4 max-w-sm\">\n      <ClientCard\n        client={client}\n        onClick={() => console.log(\"Client clicked\")}\n        onCreateQuote={() => console.log(\"Create quote\")}\n        onAddNote={() => console.log(\"Add note\")}\n        onViewHistory={() => console.log(\"View history\")}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":776,"size_tokens":null},"server/static.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(__dirname, \"public\");\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":547,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4885,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3848,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1202,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":1383,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1592,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport session from \"express-session\";\nimport connectPgSimple from \"connect-pg-simple\";\nimport { Pool } from \"@neondatabase/serverless\";\nimport { registerRoutes } from \"./routes\";\nimport { serveStatic } from \"./static\";\nimport { createServer } from \"http\";\nimport type { User } from \"@shared/schema\";\nimport { startAutomationProcessor } from \"./automation\";\n\nconst app = express();\nconst httpServer = createServer(app);\n\ndeclare module \"http\" {\n  interface IncomingMessage {\n    rawBody: unknown;\n  }\n}\n\ndeclare module \"express-session\" {\n  interface SessionData {\n    userId: string;\n    user: Pick<User, \"id\" | \"username\" | \"email\" | \"firstName\" | \"lastName\" | \"role\" | \"positionTitle\" | \"profilePhotoUrl\">;\n  }\n}\n\nconst PgStore = connectPgSimple(session);\nconst sessionPool = new Pool({ connectionString: process.env.DATABASE_URL });\n\napp.use(\n  session({\n    secret: process.env.SESSION_SECRET || \"probuild-pvc-secret-key-change-in-production\",\n    resave: false,\n    saveUninitialized: false,\n    store: new PgStore({\n      pool: sessionPool,\n      tableName: \"session\",\n      createTableIfMissing: true,\n    }),\n    cookie: {\n      secure: process.env.NODE_ENV === \"production\",\n      httpOnly: true,\n      maxAge: 7 * 24 * 60 * 60 * 1000, // 7 days\n    },\n  })\n);\n\napp.use(\n  express.json({\n    verify: (req, _res, buf) => {\n      req.rawBody = buf;\n    },\n  }),\n);\n\napp.use(express.urlencoded({ extended: false }));\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  await registerRoutes(httpServer, app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (process.env.NODE_ENV === \"production\") {\n    serveStatic(app);\n  } else {\n    const { setupVite } = await import(\"./vite\");\n    await setupVite(httpServer, app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || \"5000\", 10);\n  httpServer.listen(\n    {\n      port,\n      host: \"0.0.0.0\",\n      reusePort: true,\n    },\n    () => {\n      log(`serving on port ${port}`);\n      \n      startAutomationProcessor(5);\n    },\n  );\n})();\n","path":null,"size_bytes":3608,"size_tokens":null},"client/src/components/dashboard/ScheduleSnapshot.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { ChevronRight, MapPin } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface ScheduleItem {\n  id: string;\n  jobNumber: string;\n  clientName: string;\n  address: string;\n  installer: {\n    name: string;\n    initials: string;\n  };\n  time: string;\n  type: \"install\" | \"delivery\" | \"pickup\" | \"measure\";\n}\n\ninterface ScheduleSnapshotProps {\n  date: string;\n  items: ScheduleItem[];\n  onItemClick?: (item: ScheduleItem) => void;\n  onViewSchedule?: () => void;\n}\n\nconst typeColors = {\n  install: \"bg-success/10 text-success\",\n  delivery: \"bg-warning/10 text-warning\",\n  pickup: \"bg-primary/10 text-primary\",\n  measure: \"bg-accent text-accent-foreground\",\n};\n\nconst typeLabels = {\n  install: \"Install\",\n  delivery: \"Delivery\",\n  pickup: \"Pickup\",\n  measure: \"Measure\",\n};\n\nexport function ScheduleSnapshot({\n  date,\n  items,\n  onItemClick,\n  onViewSchedule,\n}: ScheduleSnapshotProps) {\n  return (\n    <Card>\n      <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-4\">\n        <div>\n          <CardTitle className=\"text-base font-semibold\">Today's Schedule</CardTitle>\n          <p className=\"text-xs text-muted-foreground mt-1\">{date}</p>\n        </div>\n        {onViewSchedule && (\n          <Button variant=\"ghost\" size=\"sm\" onClick={onViewSchedule} data-testid=\"button-view-schedule\">\n            Full Calendar\n            <ChevronRight className=\"ml-1 h-4 w-4\" />\n          </Button>\n        )}\n      </CardHeader>\n      <CardContent className=\"space-y-3\">\n        {items.length === 0 ? (\n          <p className=\"text-sm text-muted-foreground py-4 text-center\">No scheduled items for today</p>\n        ) : (\n          items.map((item) => (\n            <div\n              key={item.id}\n              className=\"flex items-start gap-3 p-3 rounded-md hover-elevate cursor-pointer\"\n              onClick={() => onItemClick?.(item)}\n              data-testid={`schedule-item-${item.id}`}\n            >\n              <div className=\"flex flex-col items-center gap-1\">\n                <span className=\"text-sm font-semibold\">{item.time}</span>\n                <span className={cn(\"text-[10px] font-medium px-2 py-0.5 rounded\", typeColors[item.type])}>\n                  {typeLabels[item.type]}\n                </span>\n              </div>\n              <div className=\"flex-1 min-w-0\">\n                <div className=\"flex items-center gap-2 mb-1\">\n                  <span className=\"font-mono text-xs text-muted-foreground\">{item.jobNumber}</span>\n                  <span className=\"font-medium text-sm truncate\">{item.clientName}</span>\n                </div>\n                <div className=\"flex items-center gap-1 text-xs text-muted-foreground\">\n                  <MapPin className=\"h-3 w-3\" />\n                  <span className=\"truncate\">{item.address}</span>\n                </div>\n              </div>\n              <Avatar className=\"h-8 w-8\">\n                <AvatarFallback className=\"text-xs bg-muted\">\n                  {item.installer.initials}\n                </AvatarFallback>\n              </Avatar>\n            </div>\n          ))\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":3340,"size_tokens":null},"client/src/components/examples/PriorityListExample.tsx":{"content":"import { PriorityList } from \"@/components/dashboard/PriorityList\";\n\nexport default function PriorityListExample() {\n  const items = [\n    {\n      id: \"1\",\n      title: \"Smith Residence\",\n      subtitle: \"Hampton Style - 25m fence\",\n      status: \"new\" as const,\n      timeAgo: \"2m ago\",\n      urgent: true,\n    },\n    {\n      id: \"2\",\n      title: \"Johnson Property\",\n      subtitle: \"Colonial - 40m with gate\",\n      status: \"contacted\" as const,\n      timeAgo: \"1h ago\",\n    },\n    {\n      id: \"3\",\n      title: \"Pacific Builders\",\n      subtitle: \"Picket Style - Trade order\",\n      status: \"quoted\" as const,\n      timeAgo: \"3h ago\",\n    },\n  ];\n\n  return (\n    <PriorityList\n      title=\"New Leads\"\n      items={items}\n      onItemClick={(item) => console.log(\"Clicked:\", item)}\n      onViewAll={() => console.log(\"View all clicked\")}\n    />\n  );\n}\n","path":null,"size_bytes":855,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"client/src/pages/Inventory.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { InventoryTable } from \"@/components/inventory/InventoryTable\";\nimport { StatCard } from \"@/components/shared/StatCard\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Package, AlertTriangle, TrendingDown, DollarSign, Download } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Product } from \"@shared/schema\";\n\ninterface DisplayProduct {\n  id: string;\n  sku: string;\n  name: string;\n  category: string;\n  stockOnHand: number;\n  reorderPoint: number;\n  costPrice: number;\n  sellPrice: number;\n  status: \"in_stock\" | \"low_stock\" | \"out_of_stock\";\n}\n\nexport default function Inventory() {\n  const { toast } = useToast();\n  const [selectedProduct, setSelectedProduct] = useState<DisplayProduct | null>(null);\n  const [isAdjustDialogOpen, setIsAdjustDialogOpen] = useState(false);\n  const [adjustmentType, setAdjustmentType] = useState<\"add\" | \"remove\">(\"add\");\n  const [adjustmentQty, setAdjustmentQty] = useState(\"\");\n\n  const { data: products = [], isLoading: productsLoading } = useQuery<Product[]>({\n    queryKey: [\"/api/products\"],\n  });\n\n  const adjustStockMutation = useMutation({\n    mutationFn: async ({ productId, adjustment }: { productId: string; adjustment: number }) => {\n      return apiRequest(\"PATCH\", `/api/products/${productId}/stock`, { adjustment });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/products\"] });\n      toast({\n        title: \"Stock Updated\",\n        description: \"Inventory has been adjusted successfully.\",\n      });\n      setIsAdjustDialogOpen(false);\n      setAdjustmentQty(\"\");\n    },\n    onError: (error) => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to adjust stock.\",\n        variant: \"destructive\",\n      });\n      console.error(\"Stock adjustment error:\", error);\n    },\n  });\n\n  const displayProducts: DisplayProduct[] = products.map((product) => {\n    const stockOnHand = product.stockOnHand ?? 0;\n    const reorderPoint = product.reorderPoint ?? 10;\n    \n    let status: \"in_stock\" | \"low_stock\" | \"out_of_stock\" = \"in_stock\";\n    if (stockOnHand === 0) {\n      status = \"out_of_stock\";\n    } else if (stockOnHand <= reorderPoint) {\n      status = \"low_stock\";\n    }\n\n    return {\n      id: product.id,\n      sku: product.sku,\n      name: product.name,\n      category: product.category,\n      stockOnHand,\n      reorderPoint,\n      costPrice: parseFloat(product.costPrice) || 0,\n      sellPrice: parseFloat(product.sellPrice) || 0,\n      status,\n    };\n  });\n\n  const totalProducts = displayProducts.length;\n  const lowStockCount = displayProducts.filter(p => p.status === \"low_stock\").length;\n  const outOfStockCount = displayProducts.filter(p => p.status === \"out_of_stock\").length;\n  const totalValue = displayProducts.reduce((acc, p) => acc + (p.stockOnHand * p.costPrice), 0);\n\n  const handleProductClick = (product: DisplayProduct) => {\n    setSelectedProduct(product);\n    toast({\n      title: \"Product Selected\",\n      description: `Viewing ${product.name}`,\n    });\n  };\n\n  const handleAdjustStock = (product: DisplayProduct) => {\n    setSelectedProduct(product);\n    setIsAdjustDialogOpen(true);\n  };\n\n  const handleSubmitAdjustment = () => {\n    if (!selectedProduct || !adjustmentQty) return;\n\n    const qty = parseInt(adjustmentQty);\n    if (isNaN(qty) || qty <= 0) {\n      toast({\n        title: \"Invalid Quantity\",\n        description: \"Please enter a valid positive number.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const adjustment = adjustmentType === \"add\" ? qty : -qty;\n    adjustStockMutation.mutate({ productId: selectedProduct.id, adjustment });\n  };\n\n  if (productsLoading) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <Skeleton className=\"h-8 w-48\" />\n        </div>\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n          {[...Array(4)].map((_, i) => (\n            <Skeleton key={i} className=\"h-24\" />\n          ))}\n        </div>\n        <Skeleton className=\"h-96\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-semibold\" data-testid=\"text-inventory-title\">Products & Inventory</h1>\n          <p className=\"text-sm text-muted-foreground\">\n            Manage stock levels, pricing, and reorder points\n          </p>\n        </div>\n        <Button \n          variant=\"outline\" \n          onClick={() => window.open(\"/api/export/products\", \"_blank\")}\n          data-testid=\"button-export-inventory\"\n        >\n          <Download className=\"h-4 w-4 mr-2\" />\n          Export\n        </Button>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <StatCard\n          title=\"Total Products\"\n          value={totalProducts}\n          description=\"Active SKUs\"\n          icon={Package}\n        />\n        <StatCard\n          title=\"Low Stock\"\n          value={lowStockCount}\n          description=\"Below reorder point\"\n          icon={AlertTriangle}\n        />\n        <StatCard\n          title=\"Out of Stock\"\n          value={outOfStockCount}\n          description=\"Needs attention\"\n          icon={TrendingDown}\n        />\n        <StatCard\n          title=\"Inventory Value\"\n          value={`$${totalValue.toLocaleString()}`}\n          description=\"At cost price\"\n          icon={DollarSign}\n        />\n      </div>\n\n      <Tabs defaultValue=\"all\">\n        <TabsList>\n          <TabsTrigger value=\"all\" data-testid=\"tab-all-products\">All Products</TabsTrigger>\n          <TabsTrigger value=\"low_stock\" data-testid=\"tab-low-stock\">Low Stock</TabsTrigger>\n          <TabsTrigger value=\"out_of_stock\" data-testid=\"tab-out-of-stock\">Out of Stock</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"all\" className=\"mt-6\">\n          <InventoryTable\n            products={displayProducts}\n            onProductClick={handleProductClick}\n            onAdjustStock={handleAdjustStock}\n            onAddProduct={() => toast({ title: \"Add product\" })}\n          />\n        </TabsContent>\n\n        <TabsContent value=\"low_stock\" className=\"mt-6\">\n          <InventoryTable\n            products={displayProducts.filter(p => p.status === \"low_stock\")}\n            onProductClick={handleProductClick}\n            onAdjustStock={handleAdjustStock}\n          />\n        </TabsContent>\n\n        <TabsContent value=\"out_of_stock\" className=\"mt-6\">\n          <InventoryTable\n            products={displayProducts.filter(p => p.status === \"out_of_stock\")}\n            onProductClick={handleProductClick}\n            onAdjustStock={handleAdjustStock}\n          />\n        </TabsContent>\n      </Tabs>\n\n      <Dialog open={isAdjustDialogOpen} onOpenChange={setIsAdjustDialogOpen}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Adjust Stock</DialogTitle>\n          </DialogHeader>\n          {selectedProduct && (\n            <div className=\"space-y-4\">\n              <div className=\"p-3 bg-muted rounded-md\">\n                <p className=\"font-mono text-sm text-muted-foreground\">{selectedProduct.sku}</p>\n                <p className=\"font-medium\">{selectedProduct.name}</p>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  Current stock: <span className=\"font-semibold\">{selectedProduct.stockOnHand}</span>\n                </p>\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Adjustment Type</Label>\n                <Select value={adjustmentType} onValueChange={(v) => setAdjustmentType(v as \"add\" | \"remove\")}>\n                  <SelectTrigger data-testid=\"select-adjustment-type\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"add\">Add Stock</SelectItem>\n                    <SelectItem value=\"remove\">Remove Stock</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Quantity</Label>\n                <Input\n                  type=\"number\"\n                  value={adjustmentQty}\n                  onChange={(e) => setAdjustmentQty(e.target.value)}\n                  placeholder=\"Enter quantity\"\n                  data-testid=\"input-adjustment-qty\"\n                />\n              </div>\n              <div className=\"flex gap-2\">\n                <Button variant=\"outline\" className=\"flex-1\" onClick={() => setIsAdjustDialogOpen(false)}>\n                  Cancel\n                </Button>\n                <Button \n                  className=\"flex-1\" \n                  onClick={handleSubmitAdjustment} \n                  disabled={adjustStockMutation.isPending}\n                  data-testid=\"button-submit-adjustment\"\n                >\n                  {adjustStockMutation.isPending ? \"Adjusting...\" : \"Confirm\"}\n                </Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":9867,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10481,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1467,"size_tokens":null},"client/src/components/examples/StatusBadgeExample.tsx":{"content":"import { StatusBadge } from \"@/components/shared/StatusBadge\";\n\nexport default function StatusBadgeExample() {\n  return (\n    <div className=\"flex flex-wrap gap-2 p-4\">\n      <StatusBadge status=\"new\" />\n      <StatusBadge status=\"contacted\" />\n      <StatusBadge status=\"quoted\" />\n      <StatusBadge status=\"approved\" />\n      <StatusBadge status=\"declined\" />\n      <StatusBadge status=\"in_progress\" />\n      <StatusBadge status=\"production\" />\n      <StatusBadge status=\"ready\" />\n      <StatusBadge status=\"scheduled\" />\n      <StatusBadge status=\"complete\" />\n      <StatusBadge status=\"paid\" />\n      <StatusBadge status=\"overdue\" />\n      <StatusBadge status=\"pending\" />\n      <StatusBadge status=\"low_stock\" />\n      <StatusBadge status=\"public\" />\n      <StatusBadge status=\"trade\" />\n    </div>\n  );\n}\n","path":null,"size_bytes":814,"size_tokens":null},"client/src/components/examples/TaskQueueExample.tsx":{"content":"import { TaskQueue } from \"@/components/production/TaskQueue\";\n\nexport default function TaskQueueExample() {\n  const tasks = [\n    {\n      id: \"task-001\",\n      jobNumber: \"JOB-2024-089\",\n      clientName: \"Williams Family - Hampton 25m\",\n      taskType: \"cutting\" as const,\n      status: \"in_progress\" as const,\n      assignedTo: \"George\",\n      estimatedTime: 120,\n      timeSpent: 45,\n      materials: [\"PVC Post 100x100 x 6\", \"PVC Rail 50x100 x 12\", \"PVC Picket x 48\"],\n    },\n    {\n      id: \"task-002\",\n      jobNumber: \"JOB-2024-091\",\n      clientName: \"Harbor Homes - Colonial 40m\",\n      taskType: \"routing\" as const,\n      status: \"pending\" as const,\n      assignedTo: \"George\",\n      estimatedTime: 90,\n      timeSpent: 0,\n      materials: [\"PVC Rail 50x100 x 20\", \"PVC Cap x 10\"],\n    },\n    {\n      id: \"task-003\",\n      jobNumber: \"JOB-2024-087\",\n      clientName: \"Pacific Builders - Picket\",\n      taskType: \"assembly\" as const,\n      status: \"complete\" as const,\n      assignedTo: \"David T\",\n      estimatedTime: 180,\n      timeSpent: 165,\n      materials: [\"Pre-cut posts x 8\", \"Pre-routed rails x 16\", \"Pickets x 64\"],\n    },\n  ];\n\n  return (\n    <div className=\"p-4 max-w-lg\">\n      <TaskQueue\n        tasks={tasks}\n        onStartTask={(task) => console.log(\"Start:\", task)}\n        onPauseTask={(task) => console.log(\"Pause:\", task)}\n        onCompleteTask={(task) => console.log(\"Complete:\", task)}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":1449,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"client/src/components/layout/AppSidebar.tsx":{"content":"import { useLocation, Link } from \"wouter\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { LucideIcon } from \"lucide-react\";\nimport {\n  Users,\n  FileText,\n  ClipboardList,\n  Briefcase,\n  Factory,\n  Calendar,\n  Package,\n  CreditCard,\n  MessageSquare,\n  Wrench,\n  Building2,\n  LogOut,\n  BarChart3,\n  Zap,\n  Building,\n  GitBranch,\n  Shield,\n  FolderOpen,\n  BookOpen,\n  FileStack,\n  User,\n  TrendingUp,\n  Upload,\n  LayoutDashboard,\n  Landmark,\n  Columns3,\n  Phone,\n  Tag,\n} from \"lucide-react\";\nimport {\n  Sidebar,\n  SidebarContent,\n  SidebarGroup,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarMenu,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarHeader,\n  SidebarFooter,\n} from \"@/components/ui/sidebar\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { type UserRole, getRolesForRoute, allInternalRoles, officeRoles } from \"@/lib/permissions\";\n\ninterface NavItem {\n  title: string;\n  url: string;\n  icon: LucideIcon;\n  badge?: \"unread-messages\";\n}\n\ninterface NavGroup {\n  label: string;\n  items: NavItem[];\n}\n\nconst navigationConfig: NavGroup[] = [\n  {\n    label: \"Main\",\n    items: [\n      { title: \"My Dashboard\", url: \"/\", icon: User },\n      { title: \"Business Dashboard\", url: \"/business-dashboard\", icon: TrendingUp },\n      { title: \"Leads\", url: \"/leads\", icon: FileText },\n      { title: \"Quotes\", url: \"/quotes\", icon: ClipboardList },\n      { title: \"Jobs\", url: \"/jobs\", icon: Briefcase },\n      { title: \"Clients\", url: \"/clients\", icon: Users },\n    ],\n  },\n  {\n    label: \"Operations\",\n    items: [\n      { title: \"Production\", url: \"/production\", icon: Factory },\n      { title: \"Schedule\", url: \"/schedule\", icon: Calendar },\n      { title: \"Inventory\", url: \"/inventory\", icon: Package },\n    ],\n  },\n  {\n    label: \"Finance\",\n    items: [\n      { title: \"Banking\", url: \"/financial\", icon: Landmark },\n      { title: \"Payments\", url: \"/payments\", icon: CreditCard },\n      { title: \"Messages\", url: \"/messages\", icon: MessageSquare, badge: \"unread-messages\" },\n      { title: \"Calls\", url: \"/calls\", icon: Phone },\n    ],\n  },\n  {\n    label: \"Analytics\",\n    items: [\n      { title: \"Quote Analytics\", url: \"/quote-analytics\", icon: BarChart3 },\n      { title: \"Automation\", url: \"/automation\", icon: Zap },\n      { title: \"Import Data\", url: \"/import\", icon: Upload },\n    ],\n  },\n  {\n    label: \"Live Documents\",\n    items: [\n      { title: \"Templates\", url: \"/live-doc-templates\", icon: FileStack },\n    ],\n  },\n  {\n    label: \"Field\",\n    items: [\n      { title: \"Installer App\", url: \"/installer\", icon: Wrench },\n    ],\n  },\n  {\n    label: \"External\",\n    items: [\n      { title: \"Trade Portal\", url: \"/trade\", icon: Building2 },\n    ],\n  },\n  {\n    label: \"Organisation\",\n    items: [\n      { title: \"Departments\", url: \"/organisation/departments\", icon: Building },\n      { title: \"Workflows & SOPs\", url: \"/organisation/workflows\", icon: GitBranch },\n      { title: \"Policies\", url: \"/organisation/policies\", icon: Shield },\n      { title: \"Resources\", url: \"/organisation/resources\", icon: FolderOpen },\n      { title: \"Knowledge Base\", url: \"/organisation/knowledge\", icon: BookOpen },\n    ],\n  },\n  {\n    label: \"Settings\",\n    items: [\n      { title: \"Dashboard Builder\", url: \"/dashboard-builder\", icon: LayoutDashboard },\n      { title: \"Job Stage Config\", url: \"/job-stage-configuration\", icon: GitBranch },\n      { title: \"Kanban Columns\", url: \"/kanban-column-settings\", icon: Columns3 },\n      { title: \"Expense Categories\", url: \"/expense-category-config\", icon: Tag },\n      { title: \"Staff Management\", url: \"/staff-management\", icon: Users },\n    ],\n  },\n];\n\nfunction formatRoleDisplay(role: string): string {\n  const roleMap: Record<string, string> = {\n    admin: \"Administrator\",\n    sales: \"Sales\",\n    scheduler: \"Scheduler\",\n    production_manager: \"Production Manager\",\n    warehouse: \"Warehouse\",\n    installer: \"Installer\",\n    trade_client: \"Trade Client\",\n  };\n  return roleMap[role] || role;\n}\n\nfunction UserSection() {\n  const { user, logout } = useAuth();\n  const [, setLocation] = useLocation();\n  \n  const initials = user \n    ? `${user.firstName?.[0] || ''}${user.lastName?.[0] || ''}`.toUpperCase() \n    : 'U';\n  \n  const handleLogout = async () => {\n    await logout();\n    setLocation(\"/login\");\n  };\n  \n  return (\n    <div className=\"flex items-center gap-3\">\n      <Avatar className=\"h-8 w-8\">\n        <AvatarFallback className=\"bg-sidebar-accent text-sidebar-accent-foreground text-xs\">\n          {initials}\n        </AvatarFallback>\n      </Avatar>\n      <div className=\"flex flex-1 flex-col\">\n        <span className=\"text-sm font-medium text-sidebar-foreground\" data-testid=\"text-user-name\">\n          {user ? `${user.firstName} ${user.lastName}` : 'Guest'}\n        </span>\n        <span className=\"text-xs text-sidebar-foreground/70\">\n          {user?.positionTitle || formatRoleDisplay(user?.role || 'user')}\n        </span>\n      </div>\n      <SidebarMenuButton \n        size=\"sm\" \n        className=\"h-8 w-8\" \n        onClick={handleLogout}\n        data-testid=\"button-logout\"\n      >\n        <LogOut className=\"h-4 w-4\" />\n      </SidebarMenuButton>\n    </div>\n  );\n}\n\nexport function AppSidebar() {\n  const [location] = useLocation();\n  const { user } = useAuth();\n  const userRole = user?.role as UserRole | undefined;\n\n  const { data: unreadData } = useQuery<{ count: number }>({\n    queryKey: ['/api/sms/unread-count'],\n    refetchInterval: 30000,\n  });\n\n  const unreadCount = unreadData?.count || 0;\n\n  const isActive = (url: string) => {\n    if (url === \"/\") return location === \"/\";\n    return location.startsWith(url);\n  };\n\n  const canAccessRoute = (route: string): boolean => {\n    if (!userRole) return false;\n    const allowedRoles = getRolesForRoute(route);\n    return allowedRoles.includes(userRole);\n  };\n\n  const getVisibleGroups = () => {\n    return navigationConfig\n      .map(group => ({\n        ...group,\n        items: group.items.filter(item => canAccessRoute(item.url)),\n      }))\n      .filter(group => group.items.length > 0);\n  };\n  \n  const visibleGroups = getVisibleGroups();\n\n  return (\n    <Sidebar>\n      <SidebarHeader className=\"p-4\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-accent text-accent-foreground font-bold text-lg\">\n            PB\n          </div>\n          <div className=\"flex flex-col\">\n            <span className=\"font-semibold text-sidebar-foreground\">Probuild PVC</span>\n            <span className=\"text-xs text-sidebar-foreground/70\">ERP & CRM</span>\n          </div>\n        </div>\n      </SidebarHeader>\n\n      <SidebarContent>\n        {visibleGroups.map((group) => (\n          <SidebarGroup key={group.label}>\n            <SidebarGroupLabel>{group.label}</SidebarGroupLabel>\n            <SidebarGroupContent>\n              <SidebarMenu>\n                {group.items.map((item) => (\n                  <SidebarMenuItem key={item.title}>\n                    <SidebarMenuButton asChild isActive={isActive(item.url)}>\n                      <Link href={item.url} data-testid={`nav-${item.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                        <item.icon className=\"h-4 w-4\" />\n                        <span>{item.title}</span>\n                        {item.badge === \"unread-messages\" && unreadCount > 0 && (\n                          <Badge \n                            variant=\"destructive\" \n                            className=\"ml-auto h-5 min-w-5 px-1.5 text-xs\"\n                            data-testid=\"badge-unread-messages\"\n                          >\n                            {unreadCount > 99 ? '99+' : unreadCount}\n                          </Badge>\n                        )}\n                      </Link>\n                    </SidebarMenuButton>\n                  </SidebarMenuItem>\n                ))}\n              </SidebarMenu>\n            </SidebarGroupContent>\n          </SidebarGroup>\n        ))}\n      </SidebarContent>\n\n      <SidebarFooter className=\"p-4\">\n        <UserSection />\n      </SidebarFooter>\n    </Sidebar>\n  );\n}\n","path":null,"size_bytes":8217,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1139,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7428,"size_tokens":null},"client/src/components/jobs/JobCard.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { StatusBadge } from \"@/components/shared/StatusBadge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { MapPin, Calendar, Package, MoreHorizontal, DollarSign } from \"lucide-react\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\n\ntype JobStatus = \"in_progress\" | \"production\" | \"ready\" | \"scheduled\" | \"complete\";\n\ninterface Job {\n  id: string;\n  jobNumber: string;\n  clientName: string;\n  address: string;\n  fenceStyle: string;\n  jobType: \"supply\" | \"supply_install\";\n  status: JobStatus;\n  productionProgress: number;\n  scheduledDate?: string;\n  installer?: {\n    name: string;\n    initials: string;\n  };\n  totalValue: number;\n  depositPaid: boolean;\n}\n\ninterface JobCardProps {\n  job: Job;\n  onClick?: () => void;\n  onUpdateStatus?: () => void;\n  onViewMaterials?: () => void;\n  onViewSchedule?: () => void;\n}\n\nexport function JobCard({\n  job,\n  onClick,\n  onUpdateStatus,\n  onViewMaterials,\n  onViewSchedule,\n}: JobCardProps) {\n  return (\n    <Card\n      className=\"hover-elevate cursor-pointer\"\n      onClick={onClick}\n      data-testid={`job-card-${job.id}`}\n    >\n      <CardContent className=\"p-4\">\n        <div className=\"flex items-start justify-between mb-3\">\n          <div>\n            <div className=\"flex items-center gap-2 mb-1\">\n              <span className=\"font-mono text-xs text-muted-foreground\">{job.jobNumber}</span>\n              <StatusBadge status={job.status} />\n            </div>\n            <h3 className=\"font-semibold\">{job.clientName}</h3>\n          </div>\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>\n              <Button variant=\"ghost\" size=\"icon\" className=\"h-7 w-7\" data-testid={`button-job-actions-${job.id}`}>\n                <MoreHorizontal className=\"h-4 w-4\" />\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\">\n              <DropdownMenuItem onClick={(e) => { e.stopPropagation(); onUpdateStatus?.(); }}>\n                Update Status\n              </DropdownMenuItem>\n              <DropdownMenuItem onClick={(e) => { e.stopPropagation(); onViewMaterials?.(); }}>\n                View Materials\n              </DropdownMenuItem>\n              <DropdownMenuItem onClick={(e) => { e.stopPropagation(); onViewSchedule?.(); }}>\n                View Schedule\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n\n        <p className=\"text-sm text-muted-foreground mb-3\">{job.fenceStyle}</p>\n\n        <div className=\"space-y-2 mb-4\">\n          <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n            <MapPin className=\"h-3 w-3\" />\n            <span className=\"truncate\">{job.address}</span>\n          </div>\n          {job.scheduledDate && (\n            <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n              <Calendar className=\"h-3 w-3\" />\n              <span>{job.scheduledDate}</span>\n            </div>\n          )}\n          <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n            <Package className=\"h-3 w-3\" />\n            <span>{job.jobType === \"supply_install\" ? \"Supply + Install\" : \"Supply Only\"}</span>\n          </div>\n        </div>\n\n        <div className=\"space-y-2 mb-4\">\n          <div className=\"flex items-center justify-between text-xs\">\n            <span className=\"text-muted-foreground\">Production Progress</span>\n            <span className=\"font-medium\">{job.productionProgress}%</span>\n          </div>\n          <Progress value={job.productionProgress} className=\"h-1.5\" />\n        </div>\n\n        <div className=\"flex items-center justify-between pt-3 border-t\">\n          <div className=\"flex items-center gap-2\">\n            {job.installer ? (\n              <>\n                <Avatar className=\"h-6 w-6\">\n                  <AvatarFallback className=\"text-[10px] bg-muted\">\n                    {job.installer.initials}\n                  </AvatarFallback>\n                </Avatar>\n                <span className=\"text-xs text-muted-foreground\">{job.installer.name}</span>\n              </>\n            ) : (\n              <span className=\"text-xs text-muted-foreground\">Unassigned</span>\n            )}\n          </div>\n          <div className=\"flex items-center gap-1\">\n            <DollarSign className=\"h-3 w-3 text-muted-foreground\" />\n            <span className=\"text-sm font-semibold\">${job.totalValue.toLocaleString()}</span>\n            {job.depositPaid && (\n              <StatusBadge status=\"paid\" className=\"ml-1\" />\n            )}\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":4927,"size_tokens":null},"client/src/pages/Leads.tsx":{"content":"import { useState, useEffect, useCallback } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useLocation, useSearch } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { AddressAutocomplete } from \"@/components/ui/address-autocomplete\";\nimport { KanbanBoard } from \"@/components/leads/KanbanBoard\";\nimport { QuoteBuilder } from \"@/components/quotes/QuoteBuilder\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Plus, Search, Filter, LayoutGrid, List, Download, Phone, Mail, MapPin, FileText, Edit, Trash2, X, ChevronRight, Calendar, DollarSign, Send, Check, Clock, ClipboardList, Package, Wrench, CalendarDays, CheckCircle } from \"lucide-react\";\nimport { Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription } from \"@/components/ui/sheet\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { JobSetupDocument } from \"@/components/jobs/JobSetupDocument\";\nimport { LeadDetailDialog } from \"@/components/leads/LeadDetailDialog\";\nimport type { Lead, Client, InsertLead, Quote, User } from \"@shared/schema\";\n\ntype LeadStatus = \"new\" | \"contacted\" | \"quoted\" | \"approved\" | \"declined\";\n\ninterface QuoteInfo {\n  total: number;\n  sent: number;\n  approved: number;\n  failed: number;\n  drafts: number;\n}\n\ninterface KanbanLead {\n  id: string;\n  leadNumber: string;\n  clientName: string;\n  phone: string;\n  email: string;\n  address: string;\n  source: string;\n  fenceStyle: string;\n  leadType: \"public\" | \"trade\";\n  jobFulfillmentType?: \"supply_only\" | \"supply_install\";\n  status: LeadStatus;\n  assignedTo: {\n    name: string;\n    initials: string;\n  };\n  soilWarning?: string | null;\n  soilInstallNotes?: string | null;\n  createdAt: string;\n  quoteInfo?: QuoteInfo;\n  hasUnreadMessages?: boolean;\n  hasPendingTasks?: boolean;\n  pendingTaskCount?: number;\n  isAssigned?: boolean;\n}\n\nexport default function Leads() {\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const searchString = useSearch();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [viewMode, setViewMode] = useState<\"kanban\" | \"list\">(\"kanban\");\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);\n  const [isQuoteBuilderOpen, setIsQuoteBuilderOpen] = useState(false);\n  const [isDetailDialogOpen, setIsDetailDialogOpen] = useState(false);\n  const [isQuoteSheetOpen, setIsQuoteSheetOpen] = useState(false);\n  const [selectedLead, setSelectedLead] = useState<Lead | null>(null);\n  const [selectedQuote, setSelectedQuote] = useState<Quote | null>(null);\n  const [editingLead, setEditingLead] = useState<Lead | null>(null);\n  const [leadToDelete, setLeadToDelete] = useState<KanbanLead | null>(null);\n  const [selectedLeadForQuote, setSelectedLeadForQuote] = useState<Lead | null>(null);\n  const [isEditingQuote, setIsEditingQuote] = useState(false);\n  const [isSetupTemplateOpen, setIsSetupTemplateOpen] = useState(false);\n  const [selectedLeadForTemplate, setSelectedLeadForTemplate] = useState<Lead | null>(null);\n  const [initialTab, setInitialTab] = useState<string | undefined>(undefined);\n  const [highlightedTaskId, setHighlightedTaskId] = useState<string | undefined>(undefined);\n  const [formData, setFormData] = useState({\n    clientName: \"\",\n    phone: \"\",\n    email: \"\",\n    address: \"\",\n    leadType: \"public\" as \"public\" | \"trade\",\n    source: \"website\" as \"website\" | \"phone\" | \"referral\" | \"trade\" | \"walk_in\" | \"social_media\" | \"other\",\n    description: \"\",\n    jobFulfillmentType: \"supply_install\" as \"supply_only\" | \"supply_install\",\n  });\n  const [siteCoordinates, setSiteCoordinates] = useState<{ lat: number; lng: number } | null>(null);\n  const [soilData, setSoilData] = useState<{ warning: string | null; notes: string | null }>({ warning: null, notes: null });\n  const [isSoilDataLoading, setIsSoilDataLoading] = useState(false);\n  const [clientSuggestions, setClientSuggestions] = useState<Client[]>([]);\n  const [showSuggestions, setShowSuggestions] = useState(false);\n  const [selectedClientId, setSelectedClientId] = useState<string | null>(null);\n\n  const { data: leads = [], isLoading: leadsLoading } = useQuery<Lead[]>({\n    queryKey: [\"/api/leads\"],\n  });\n\n  const { data: clients = [] } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const { data: quotes = [] } = useQuery<Quote[]>({\n    queryKey: [\"/api/quotes\"],\n  });\n\n  const { data: users = [] } = useQuery<User[]>({\n    queryKey: [\"/api/users\"],\n  });\n\n  const { data: allLeadTasks = [] } = useQuery<{ id: string; leadId: string; status: string }[]>({\n    queryKey: [\"/api/lead-tasks\"],\n  });\n\n  // Handle URL parameters for deep linking to specific lead/task\n  useEffect(() => {\n    if (leads.length > 0 && searchString) {\n      const params = new URLSearchParams(searchString);\n      const leadId = params.get(\"leadId\");\n      const taskId = params.get(\"taskId\");\n      const tab = params.get(\"tab\");\n      \n      if (leadId) {\n        const lead = leads.find(l => l.id === leadId);\n        if (lead) {\n          setSelectedLead(lead);\n          setInitialTab(tab || undefined);\n          setHighlightedTaskId(taskId || undefined);\n          setIsDetailDialogOpen(true);\n          // Clear the URL params after opening\n          setLocation(\"/leads\", { replace: true });\n        }\n      }\n    }\n  }, [leads, searchString, setLocation]);\n\n  const createLeadMutation = useMutation({\n    mutationFn: async (data: InsertLead) => {\n      return apiRequest(\"POST\", \"/api/leads\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leads\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/clients\"] });\n      toast({\n        title: \"Lead Created\",\n        description: \"New lead has been added successfully\",\n      });\n      setIsDialogOpen(false);\n      resetForm();\n    },\n    onError: (error) => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to create lead\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateLeadMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<Lead> }) => {\n      return apiRequest(\"PATCH\", `/api/leads/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leads\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/clients\"] });\n      toast({\n        title: \"Lead Updated\",\n        description: \"Lead has been updated successfully\",\n      });\n      setIsEditDialogOpen(false);\n      setEditingLead(null);\n      resetForm();\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to update lead\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Debounced client search effect\n  useEffect(() => {\n    const searchTerm = formData.clientName || formData.phone || formData.address;\n    if (searchTerm && searchTerm.length >= 2 && !selectedClientId) {\n      const timer = setTimeout(async () => {\n        try {\n          const response = await fetch(`/api/clients?search=${encodeURIComponent(searchTerm)}`);\n          if (response.ok) {\n            const matchingClients = await response.json();\n            setClientSuggestions(matchingClients);\n            setShowSuggestions(matchingClients.length > 0);\n          }\n        } catch (error) {\n          console.error(\"Error searching clients:\", error);\n        }\n      }, 300);\n      return () => clearTimeout(timer);\n    } else {\n      setClientSuggestions([]);\n      setShowSuggestions(false);\n    }\n  }, [formData.clientName, formData.phone, formData.address, selectedClientId]);\n\n  // Fetch soil data when coordinates change\n  useEffect(() => {\n    if (siteCoordinates) {\n      setIsSoilDataLoading(true);\n      const fetchSoilData = async () => {\n        try {\n          const response = await fetch(`/api/soil-data?lat=${siteCoordinates.lat}&lng=${siteCoordinates.lng}`);\n          if (response.ok) {\n            const data = await response.json();\n            // Determine short warning label based on installation notes\n            let warning: string | null = null;\n            if (data.installationNotes) {\n              const notes = data.installationNotes.toUpperCase();\n              if (notes.includes(\"LIMESTONE\")) warning = \"LIMESTONE\";\n              else if (notes.includes(\"ROCK\") || notes.includes(\"CALCRETE\")) warning = \"ROCK\";\n              else if (notes.includes(\"CLAY\") || notes.includes(\"HARDER\")) warning = \"CLAY\";\n              else if (notes.includes(\"GRAVEL\") || notes.includes(\"MIXED\")) warning = \"GRAVEL\";\n              else if (notes.includes(\"SAND\") || notes.includes(\"EASY\")) warning = \"SAND\";\n            }\n            setSoilData({ warning, notes: data.installationNotes });\n          }\n        } catch (error) {\n          console.error(\"Error fetching soil data:\", error);\n        } finally {\n          setIsSoilDataLoading(false);\n        }\n      };\n      fetchSoilData();\n    } else {\n      setSoilData({ warning: null, notes: null });\n      setIsSoilDataLoading(false);\n    }\n  }, [siteCoordinates]);\n\n  const handleSelectClient = (client: Client) => {\n    setFormData({\n      ...formData,\n      clientName: client.name,\n      phone: client.phone || \"\",\n      email: client.email || \"\",\n      address: client.address || formData.address,\n    });\n    setSelectedClientId(client.id);\n    setShowSuggestions(false);\n    toast({\n      title: \"Existing Client Selected\",\n      description: `${client.name} found in your client database`,\n    });\n  };\n\n  const handleClearClientSelection = () => {\n    setSelectedClientId(null);\n    setFormData({\n      ...formData,\n      clientName: \"\",\n      phone: \"\",\n      email: \"\",\n    });\n  };\n\n  const deleteLeadMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/leads/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leads\"] });\n      toast({\n        title: \"Lead Deleted\",\n        description: \"Lead has been removed\",\n      });\n      setIsDeleteDialogOpen(false);\n      setLeadToDelete(null);\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to delete lead\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateQuoteMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Record<string, unknown> }) => {\n      return apiRequest(\"PATCH\", `/api/quotes/${id}`, data);\n    },\n    onSuccess: async (_result, variables) => {\n      await queryClient.invalidateQueries({ queryKey: [\"/api/quotes\"] });\n      const updatedQuotes = queryClient.getQueryData<Quote[]>([\"/api/quotes\"]);\n      const updated = updatedQuotes?.find(q => q.id === variables.id);\n      if (updated) {\n        setSelectedQuote(updated);\n      }\n      toast({\n        title: \"Quote Updated\",\n        description: \"Quote has been updated successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to update quote\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleEditLead = (lead: KanbanLead) => {\n    const originalLead = leads.find(l => l.id === lead.id);\n    if (originalLead) {\n      setEditingLead(originalLead);\n      setFormData({\n        clientName: lead.clientName,\n        phone: lead.phone,\n        email: lead.email,\n        address: lead.address,\n        leadType: lead.leadType,\n        source: (originalLead.source as typeof formData.source) || \"website\",\n        description: originalLead.description || \"\",\n        jobFulfillmentType: (originalLead.jobFulfillmentType as \"supply_only\" | \"supply_install\") || \"supply_install\",\n      });\n      // Set selected client ID if lead already has a linked client\n      setSelectedClientId(originalLead.clientId || null);\n      setClientSuggestions([]);\n      setShowSuggestions(false);\n      setIsEditDialogOpen(true);\n    }\n  };\n\n  const handleDeleteLead = (lead: KanbanLead) => {\n    setLeadToDelete(lead);\n    setIsDeleteDialogOpen(true);\n  };\n\n  const handleLeadStatusChange = (leadId: string, newStatus: string) => {\n    if (updateLeadMutation.isPending) return;\n    \n    const previousLeads = queryClient.getQueryData<Lead[]>([\"/api/leads\"]);\n    const mappedStage = mapStatusToStage(newStatus as LeadStatus);\n    \n    queryClient.setQueryData<Lead[]>([\"/api/leads\"], (old) =>\n      old?.map(lead =>\n        lead.id === leadId ? { ...lead, stage: mappedStage as Lead[\"stage\"] } : lead\n      )\n    );\n    \n    updateLeadMutation.mutate(\n      { id: leadId, data: { stage: mappedStage as Lead[\"stage\"] } },\n      {\n        onError: () => {\n          queryClient.setQueryData([\"/api/leads\"], previousLeads);\n          toast({\n            title: \"Error\",\n            description: \"Failed to move lead. Please try again.\",\n            variant: \"destructive\",\n          });\n        },\n        onSuccess: () => {\n          toast({\n            title: \"Lead Updated\",\n            description: `Lead moved to ${newStatus}`,\n          });\n        },\n      }\n    );\n  };\n\n  const handleSubmitEdit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!editingLead) return;\n    \n    if (!formData.clientName.trim()) {\n      toast({\n        title: \"Validation Error\",\n        description: \"Client name is required\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    updateLeadMutation.mutate({\n      id: editingLead.id,\n      data: {\n        source: formData.source,\n        leadType: formData.leadType,\n        description: formData.description,\n        siteAddress: formData.address,\n        jobFulfillmentType: formData.jobFulfillmentType,\n        clientId: selectedClientId,\n        clientName: formData.clientName.trim(),\n        clientPhone: formData.phone.trim(),\n        clientEmail: formData.email.trim(),\n      } as any,\n    });\n  };\n\n  const resetForm = () => {\n    setFormData({\n      clientName: \"\",\n      phone: \"\",\n      email: \"\",\n      address: \"\",\n      leadType: \"public\",\n      source: \"website\",\n      description: \"\",\n      jobFulfillmentType: \"supply_install\",\n    });\n    setSelectedClientId(null);\n    setClientSuggestions([]);\n    setShowSuggestions(false);\n    setSiteCoordinates(null);\n    setSoilData({ warning: null, notes: null });\n  };\n\n  const getClientName = (clientId: string | null): string => {\n    if (!clientId) return \"Unknown\";\n    const client = clients.find(c => c.id === clientId);\n    return client?.name || \"Unknown\";\n  };\n\n  const getClientPhone = (clientId: string | null): string => {\n    if (!clientId) return \"\";\n    const client = clients.find(c => c.id === clientId);\n    return client?.phone || \"\";\n  };\n\n  const getClientEmail = (clientId: string | null): string => {\n    if (!clientId) return \"\";\n    const client = clients.find(c => c.id === clientId);\n    return client?.email || \"\";\n  };\n\n  const getAssignedUser = (userId: string | null): { name: string; initials: string } => {\n    if (!userId) return { name: \"Unassigned\", initials: \"\" };\n    const user = users.find(u => u.id === userId);\n    if (!user) return { name: \"Unassigned\", initials: \"\" };\n    const firstName = user.firstName || \"\";\n    const lastName = user.lastName || \"\";\n    const fullName = `${firstName} ${lastName}`.trim() || \"Unknown\";\n    const initials = firstName && lastName\n      ? `${firstName[0]}${lastName[0]}`.toUpperCase()\n      : fullName.substring(0, 2).toUpperCase();\n    return { name: fullName, initials };\n  };\n\n  const getQuoteInfo = (leadId: string): QuoteInfo => {\n    const leadQuotes = quotes.filter(q => q.leadId === leadId);\n    return {\n      total: leadQuotes.length,\n      sent: leadQuotes.filter(q => q.status === \"sent\").length,\n      approved: leadQuotes.filter(q => [\"approved\", \"accepted\"].includes(q.status as string)).length,\n      failed: leadQuotes.filter(q => q.status === \"send_failed\").length,\n      drafts: leadQuotes.filter(q => q.status === \"draft\").length,\n    };\n  };\n\n  const getPendingTaskCount = (leadId: string): number => {\n    return allLeadTasks.filter(t => t.leadId === leadId && t.status !== \"completed\").length;\n  };\n\n  const kanbanLeads: KanbanLead[] = leads.map((lead) => {\n    const pendingTaskCount = getPendingTaskCount(lead.id);\n    return {\n      id: lead.id,\n      leadNumber: lead.leadNumber,\n      clientName: getClientName(lead.clientId),\n      phone: getClientPhone(lead.clientId),\n      email: getClientEmail(lead.clientId),\n      address: lead.siteAddress || \"\",\n      source: lead.source || \"website\",\n      fenceStyle: `${lead.fenceStyle || \"Unknown\"} - ${lead.fenceLength || \"?\"}m`,\n      leadType: lead.leadType as \"public\" | \"trade\",\n      jobFulfillmentType: (lead.jobFulfillmentType as \"supply_only\" | \"supply_install\") || \"supply_install\",\n      status: mapStageToStatus(lead.stage),\n      assignedTo: getAssignedUser(lead.assignedTo),\n      createdAt: formatTimeAgo(lead.createdAt),\n      quoteInfo: getQuoteInfo(lead.id),\n      soilWarning: (lead as any).soilWarning || null,\n      soilInstallNotes: (lead as any).soilInstallNotes || null,\n      hasPendingTasks: pendingTaskCount > 0,\n      pendingTaskCount: pendingTaskCount,\n      isAssigned: !!lead.assignedTo,\n    };\n  });\n\n  const handleLeadClick = (lead: KanbanLead) => {\n    const originalLead = leads.find(l => l.id === lead.id);\n    if (originalLead) {\n      setSelectedLead(originalLead);\n      setIsDetailDialogOpen(true);\n    }\n  };\n\n  const getLeadQuotes = (leadId: string) => {\n    return quotes.filter(q => q.leadId === leadId);\n  };\n\n  const formatCurrency = (amount: string | number | null) => {\n    if (!amount) return \"$0.00\";\n    return new Intl.NumberFormat(\"en-AU\", {\n      style: \"currency\",\n      currency: \"AUD\",\n    }).format(Number(amount));\n  };\n\n  const handleCreateQuote = (lead: KanbanLead) => {\n    const originalLead = leads.find(l => l.id === lead.id);\n    if (originalLead) {\n      setSelectedLeadForQuote(originalLead);\n      setIsQuoteBuilderOpen(true);\n    }\n  };\n\n  const handleViewSetupTemplate = (lead: KanbanLead) => {\n    const originalLead = leads.find(l => l.id === lead.id);\n    if (originalLead && originalLead.jobFulfillmentType === \"supply_install\") {\n      setSelectedLeadForTemplate(originalLead);\n      setIsSetupTemplateOpen(true);\n    }\n  };\n\n  const handleQuoteCreated = () => {\n    if (selectedLeadForQuote) {\n      updateLeadMutation.mutate({\n        id: selectedLeadForQuote.id,\n        data: { stage: \"quote_sent\" },\n      });\n    }\n    setSelectedLeadForQuote(null);\n  };\n\n  const handleAddLead = () => {\n    setIsDialogOpen(true);\n  };\n\n  const handleSubmitLead = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!formData.clientName.trim()) {\n      toast({\n        title: \"Validation Error\",\n        description: \"Client name is required\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    createLeadMutation.mutate({\n      source: formData.source,\n      leadType: formData.leadType,\n      description: formData.description,\n      siteAddress: formData.address,\n      stage: \"new\",\n      jobFulfillmentType: formData.jobFulfillmentType,\n      clientId: selectedClientId,\n      clientName: formData.clientName.trim(),\n      clientPhone: formData.phone.trim(),\n      clientEmail: formData.email.trim(),\n      // Include soil/site data\n      soilWarning: soilData.warning,\n      soilInstallNotes: soilData.notes,\n      siteLatitude: siteCoordinates?.lat?.toString() || null,\n      siteLongitude: siteCoordinates?.lng?.toString() || null,\n    } as any);\n  };\n\n  const filteredLeads = kanbanLeads.filter(\n    (lead) =>\n      lead.clientName.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      lead.fenceStyle.toLowerCase().includes(searchQuery.toLowerCase())\n  );\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-semibold\" data-testid=\"text-leads-title\">Leads & Quotes</h1>\n          <p className=\"text-sm text-muted-foreground\">\n            Manage enquiries, build quotes, and track conversions\n          </p>\n        </div>\n        <div className=\"flex gap-2\">\n          <Button \n            variant=\"outline\" \n            onClick={() => window.open(\"/api/export/leads\", \"_blank\")}\n            data-testid=\"button-export-leads\"\n          >\n            <Download className=\"h-4 w-4 mr-2\" />\n            Export\n          </Button>\n          <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n            <DialogTrigger asChild>\n              <Button data-testid=\"button-new-lead\">\n                <Plus className=\"h-4 w-4 mr-2\" />\n                New Lead\n              </Button>\n            </DialogTrigger>\n            <DialogContent className=\"sm:max-w-md max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>Create New Lead</DialogTitle>\n            </DialogHeader>\n            <form onSubmit={handleSubmitLead} className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"clientName\">Client Name</Label>\n                <div className=\"relative\">\n                  <div className=\"flex gap-2\">\n                    <Input \n                      id=\"clientName\" \n                      placeholder=\"Enter client name\" \n                      value={formData.clientName}\n                      onChange={(e) => {\n                        setFormData({ ...formData, clientName: e.target.value });\n                        if (selectedClientId) setSelectedClientId(null);\n                      }}\n                      data-testid=\"input-client-name\" \n                    />\n                    {selectedClientId && (\n                      <Button \n                        type=\"button\" \n                        variant=\"ghost\" \n                        size=\"icon\"\n                        onClick={handleClearClientSelection}\n                        className=\"shrink-0\"\n                      >\n                        <X className=\"h-4 w-4\" />\n                      </Button>\n                    )}\n                  </div>\n                  {showSuggestions && clientSuggestions.length > 0 && (\n                    <div className=\"absolute z-50 w-full mt-1 bg-popover border rounded-md shadow-lg max-h-48 overflow-y-auto\">\n                      <div className=\"p-2 text-xs text-muted-foreground border-b\">\n                        Existing clients found - click to select\n                      </div>\n                      {clientSuggestions.map((client) => (\n                        <button\n                          key={client.id}\n                          type=\"button\"\n                          className=\"w-full p-3 text-left hover:bg-muted transition-colors border-b last:border-b-0\"\n                          onClick={() => handleSelectClient(client)}\n                          data-testid={`suggestion-client-${client.id}`}\n                        >\n                          <div className=\"font-medium\">{client.name}</div>\n                          <div className=\"text-sm text-muted-foreground flex gap-3\">\n                            {client.phone && <span>{client.phone}</span>}\n                            {client.email && <span>{client.email}</span>}\n                          </div>\n                          {client.address && (\n                            <div className=\"text-xs text-muted-foreground mt-1\">{client.address}</div>\n                          )}\n                        </button>\n                      ))}\n                    </div>\n                  )}\n                </div>\n                {selectedClientId && (\n                  <p className=\"text-xs text-green-600 mt-1\">\n                    Existing client selected - details auto-filled\n                  </p>\n                )}\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"phone\">Phone</Label>\n                  <Input \n                    id=\"phone\" \n                    placeholder=\"0400 000 000\" \n                    value={formData.phone}\n                    onChange={(e) => {\n                      setFormData({ ...formData, phone: e.target.value });\n                      if (selectedClientId) setSelectedClientId(null);\n                    }}\n                    data-testid=\"input-phone\" \n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"email\">Email</Label>\n                  <Input \n                    id=\"email\" \n                    type=\"email\" \n                    placeholder=\"email@example.com\" \n                    value={formData.email}\n                    onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                    data-testid=\"input-email\" \n                  />\n                </div>\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"address\">Site Address</Label>\n                <AddressAutocomplete\n                  value={formData.address}\n                  onChange={(value) => {\n                    setFormData({ ...formData, address: value });\n                    if (selectedClientId) setSelectedClientId(null);\n                  }}\n                  onCoordinatesChange={(coords) => setSiteCoordinates(coords)}\n                  placeholder=\"Enter site address\"\n                  showStreetView={true}\n                  data-testid=\"input-site-address\"\n                />\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"leadType\">Lead Type</Label>\n                  <Select \n                    value={formData.leadType}\n                    onValueChange={(value: \"public\" | \"trade\") => setFormData({ ...formData, leadType: value })}\n                  >\n                    <SelectTrigger data-testid=\"select-lead-type\">\n                      <SelectValue placeholder=\"Select type\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"public\">Public</SelectItem>\n                      <SelectItem value=\"trade\">Trade</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"source\">Source</Label>\n                  <Select \n                    value={formData.source}\n                    onValueChange={(value: any) => setFormData({ ...formData, source: value })}\n                  >\n                    <SelectTrigger data-testid=\"select-source\">\n                      <SelectValue placeholder=\"Select source\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"website\">Website</SelectItem>\n                      <SelectItem value=\"phone\">Phone</SelectItem>\n                      <SelectItem value=\"referral\">Referral</SelectItem>\n                      <SelectItem value=\"trade\">Trade</SelectItem>\n                      <SelectItem value=\"walk_in\">Walk In</SelectItem>\n                      <SelectItem value=\"social_media\">Social Media</SelectItem>\n                      <SelectItem value=\"other\">Other</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"jobFulfillmentType\">Job Type</Label>\n                <Select \n                  value={formData.jobFulfillmentType}\n                  onValueChange={(value: \"supply_only\" | \"supply_install\") => setFormData({ ...formData, jobFulfillmentType: value })}\n                >\n                  <SelectTrigger data-testid=\"select-job-fulfillment-type\">\n                    <SelectValue placeholder=\"Select job type\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"supply_install\">Supply & Install</SelectItem>\n                    <SelectItem value=\"supply_only\">Supply Only</SelectItem>\n                  </SelectContent>\n                </Select>\n                <p className=\"text-xs text-muted-foreground\">\n                  Supply & Install jobs include the Setup & Handover document\n                </p>\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"description\">Description</Label>\n                <Textarea\n                  id=\"description\"\n                  placeholder=\"Describe the fencing requirements...\"\n                  value={formData.description}\n                  onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                  data-testid=\"textarea-description\"\n                />\n              </div>\n              <div className=\"flex justify-end gap-2\">\n                <Button type=\"button\" variant=\"outline\" onClick={() => setIsDialogOpen(false)}>\n                  Cancel\n                </Button>\n                <Button \n                  type=\"submit\" \n                  disabled={createLeadMutation.isPending || (siteCoordinates !== null && isSoilDataLoading)}\n                  data-testid=\"button-submit-lead\"\n                >\n                  {createLeadMutation.isPending ? \"Creating...\" : isSoilDataLoading && siteCoordinates ? \"Loading soil data...\" : \"Create Lead\"}\n                </Button>\n              </div>\n            </form>\n            </DialogContent>\n          </Dialog>\n        </div>\n      </div>\n\n      <div className=\"flex items-center gap-4\">\n        <div className=\"relative flex-1 max-w-sm\">\n          <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search leads...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-9\"\n            data-testid=\"input-search-leads\"\n          />\n        </div>\n        <Button variant=\"outline\" size=\"sm\">\n          <Filter className=\"h-4 w-4 mr-2\" />\n          Filter\n        </Button>\n        <div className=\"flex items-center border rounded-md\">\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            className={viewMode === \"kanban\" ? \"bg-muted\" : \"\"}\n            onClick={() => setViewMode(\"kanban\")}\n            data-testid=\"button-view-kanban\"\n          >\n            <LayoutGrid className=\"h-4 w-4\" />\n          </Button>\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            className={viewMode === \"list\" ? \"bg-muted\" : \"\"}\n            onClick={() => setViewMode(\"list\")}\n            data-testid=\"button-view-list\"\n          >\n            <List className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      </div>\n\n      {leadsLoading ? (\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <Skeleton className=\"h-64\" />\n          <Skeleton className=\"h-64\" />\n          <Skeleton className=\"h-64\" />\n          <Skeleton className=\"h-64\" />\n        </div>\n      ) : (\n        <KanbanBoard\n          leads={filteredLeads}\n          onLeadClick={handleLeadClick}\n          onAddLead={handleAddLead}\n          onCreateQuote={handleCreateQuote}\n          onEditLead={handleEditLead}\n          onDeleteLead={handleDeleteLead}\n          onViewSetupTemplate={handleViewSetupTemplate}\n          onLeadStatusChange={handleLeadStatusChange}\n          isUpdating={updateLeadMutation.isPending}\n        />\n      )}\n\n      <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>\n        <DialogContent className=\"sm:max-w-md max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Edit Lead</DialogTitle>\n            <DialogDescription>\n              Update lead and client details\n            </DialogDescription>\n          </DialogHeader>\n          <form onSubmit={handleSubmitEdit} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-clientName\">Client Name</Label>\n              <Input \n                id=\"edit-clientName\" \n                placeholder=\"Enter client name\" \n                value={formData.clientName}\n                onChange={(e) => setFormData({ ...formData, clientName: e.target.value })}\n                data-testid=\"input-edit-client-name\" \n              />\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-phone\">Phone</Label>\n                <Input \n                  id=\"edit-phone\" \n                  placeholder=\"0400 000 000\" \n                  value={formData.phone}\n                  onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\n                  data-testid=\"input-edit-phone\" \n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-email\">Email</Label>\n                <Input \n                  id=\"edit-email\" \n                  type=\"email\" \n                  placeholder=\"email@example.com\" \n                  value={formData.email}\n                  onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                  data-testid=\"input-edit-email\" \n                />\n              </div>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-address\">Site Address</Label>\n              <AddressAutocomplete\n                value={formData.address}\n                onChange={(value) => setFormData({ ...formData, address: value })}\n                placeholder=\"Enter site address\"\n                showStreetView={true}\n                data-testid=\"input-edit-address\"\n              />\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-leadType\">Lead Type</Label>\n                <Select \n                  value={formData.leadType}\n                  onValueChange={(value: \"public\" | \"trade\") => setFormData({ ...formData, leadType: value })}\n                >\n                  <SelectTrigger data-testid=\"select-edit-lead-type\">\n                    <SelectValue placeholder=\"Select type\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"public\">Public</SelectItem>\n                    <SelectItem value=\"trade\">Trade</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-source\">Source</Label>\n                <Select \n                  value={formData.source}\n                  onValueChange={(value: any) => setFormData({ ...formData, source: value })}\n                >\n                  <SelectTrigger data-testid=\"select-edit-source\">\n                    <SelectValue placeholder=\"Select source\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"website\">Website</SelectItem>\n                    <SelectItem value=\"phone\">Phone</SelectItem>\n                    <SelectItem value=\"referral\">Referral</SelectItem>\n                    <SelectItem value=\"trade\">Trade</SelectItem>\n                    <SelectItem value=\"walk_in\">Walk In</SelectItem>\n                    <SelectItem value=\"social_media\">Social Media</SelectItem>\n                    <SelectItem value=\"other\">Other</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-jobFulfillmentType\">Job Type</Label>\n              <Select \n                value={formData.jobFulfillmentType}\n                onValueChange={(value: \"supply_only\" | \"supply_install\") => setFormData({ ...formData, jobFulfillmentType: value })}\n              >\n                <SelectTrigger data-testid=\"select-edit-job-fulfillment-type\">\n                  <SelectValue placeholder=\"Select job type\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"supply_install\">Supply & Install</SelectItem>\n                  <SelectItem value=\"supply_only\">Supply Only</SelectItem>\n                </SelectContent>\n              </Select>\n              <p className=\"text-xs text-muted-foreground\">\n                Supply & Install jobs include the Setup & Handover document\n              </p>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-description\">Description</Label>\n              <Textarea\n                id=\"edit-description\"\n                placeholder=\"Describe the fencing requirements...\"\n                value={formData.description}\n                onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                data-testid=\"textarea-edit-description\"\n              />\n            </div>\n            <div className=\"flex justify-end gap-2\">\n              <Button type=\"button\" variant=\"outline\" onClick={() => setIsEditDialogOpen(false)}>\n                Cancel\n              </Button>\n              <Button \n                type=\"submit\" \n                disabled={updateLeadMutation.isPending}\n                data-testid=\"button-save-lead\"\n              >\n                {updateLeadMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n              </Button>\n            </div>\n          </form>\n        </DialogContent>\n      </Dialog>\n\n      <AlertDialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Delete Lead</AlertDialogTitle>\n            <AlertDialogDescription>\n              Are you sure you want to delete the lead for \"{leadToDelete?.clientName}\"? This action cannot be undone.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => leadToDelete && deleteLeadMutation.mutate(leadToDelete.id)}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              data-testid=\"button-confirm-delete-lead\"\n            >\n              {deleteLeadMutation.isPending ? \"Deleting...\" : \"Delete\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      <QuoteBuilder\n        open={isQuoteBuilderOpen}\n        onOpenChange={setIsQuoteBuilderOpen}\n        lead={selectedLeadForQuote || undefined}\n        client={selectedLeadForQuote?.clientId \n          ? clients.find(c => c.id === selectedLeadForQuote.clientId) \n          : undefined}\n        onQuoteCreated={handleQuoteCreated}\n      />\n\n      <LeadDetailDialog\n        open={isDetailDialogOpen}\n        onOpenChange={(open) => {\n          setIsDetailDialogOpen(open);\n          if (!open) {\n            setInitialTab(undefined);\n            setHighlightedTaskId(undefined);\n          }\n        }}\n        lead={selectedLead}\n        client={selectedLead?.clientId ? clients.find(c => c.id === selectedLead.clientId) || null : null}\n        quotes={selectedLead ? getLeadQuotes(selectedLead.id) : []}\n        users={users}\n        initialTab={initialTab}\n        highlightedTaskId={highlightedTaskId}\n        onEditLead={() => {\n          setIsDetailDialogOpen(false);\n          setInitialTab(undefined);\n          setHighlightedTaskId(undefined);\n          const kanbanLead = kanbanLeads.find(l => l.id === selectedLead?.id);\n          if (kanbanLead) handleEditLead(kanbanLead);\n        }}\n        onCreateQuote={() => {\n          setSelectedLeadForQuote(selectedLead);\n          setIsDetailDialogOpen(false);\n          setInitialTab(undefined);\n          setHighlightedTaskId(undefined);\n          setIsQuoteBuilderOpen(true);\n        }}\n        onViewQuote={(quote) => {\n          setSelectedQuote(quote);\n          setIsQuoteSheetOpen(true);\n        }}\n      />\n\n      <Sheet open={isQuoteSheetOpen} onOpenChange={setIsQuoteSheetOpen}>\n        <SheetContent className=\"sm:max-w-xl overflow-y-auto\">\n          <SheetHeader>\n            <SheetTitle className=\"flex items-center gap-2\">\n              Quote {selectedQuote?.quoteNumber}\n              {selectedQuote && (\n                <Badge\n                  variant={\n                    selectedQuote.status === \"approved\"\n                      ? \"default\"\n                      : selectedQuote.status === \"sent\"\n                      ? \"secondary\"\n                      : selectedQuote.status === \"declined\"\n                      ? \"destructive\"\n                      : \"outline\"\n                  }\n                >\n                  {selectedQuote.status}\n                </Badge>\n              )}\n            </SheetTitle>\n            <SheetDescription>\n              View and manage quote details\n            </SheetDescription>\n          </SheetHeader>\n\n          {selectedQuote && (\n            <div className=\"mt-6 space-y-6\">\n              <div className=\"flex gap-2\">\n                {selectedQuote.status === \"draft\" && (\n                  <Button\n                    size=\"sm\"\n                    onClick={() => {\n                      updateQuoteMutation.mutate({\n                        id: selectedQuote.id,\n                        data: { status: \"sent\", sentAt: new Date().toISOString() },\n                      });\n                    }}\n                    disabled={updateQuoteMutation.isPending}\n                    data-testid=\"button-send-quote\"\n                  >\n                    <Send className=\"h-4 w-4 mr-1\" />\n                    Send Quote\n                  </Button>\n                )}\n                {selectedQuote.status === \"sent\" && (\n                  <>\n                    <Button\n                      size=\"sm\"\n                      onClick={() => {\n                        updateQuoteMutation.mutate({\n                          id: selectedQuote.id,\n                          data: { status: \"approved\", approvedAt: new Date().toISOString() },\n                        });\n                      }}\n                      disabled={updateQuoteMutation.isPending}\n                      data-testid=\"button-approve-quote\"\n                    >\n                      <Check className=\"h-4 w-4 mr-1\" />\n                      Mark Approved\n                    </Button>\n                    <Button\n                      size=\"sm\"\n                      variant=\"outline\"\n                      onClick={() => {\n                        updateQuoteMutation.mutate({\n                          id: selectedQuote.id,\n                          data: { status: \"declined\" },\n                        });\n                      }}\n                      disabled={updateQuoteMutation.isPending}\n                      data-testid=\"button-decline-quote\"\n                    >\n                      Declined\n                    </Button>\n                  </>\n                )}\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  onClick={() => {\n                    setSelectedLeadForQuote(selectedLead);\n                    setIsQuoteSheetOpen(false);\n                    setIsDetailDialogOpen(false);\n                    setIsQuoteBuilderOpen(true);\n                  }}\n                  data-testid=\"button-edit-quote\"\n                >\n                  <Edit className=\"h-4 w-4 mr-1\" />\n                  Edit Quote\n                </Button>\n              </div>\n\n              <Card>\n                <CardHeader className=\"pb-3\">\n                  <CardTitle className=\"text-base flex items-center gap-2\">\n                    <DollarSign className=\"h-4 w-4\" />\n                    Pricing Summary\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                    <div>\n                      <span className=\"text-muted-foreground\">Materials:</span>\n                      <div className=\"font-medium\">{formatCurrency(selectedQuote.materialsSubtotal)}</div>\n                    </div>\n                    <div>\n                      <span className=\"text-muted-foreground\">Labour:</span>\n                      <div className=\"font-medium\">{formatCurrency(selectedQuote.labourEstimate)}</div>\n                    </div>\n                    <div>\n                      <span className=\"text-muted-foreground\">Total:</span>\n                      <div className=\"font-semibold text-lg\">{formatCurrency(selectedQuote.totalAmount)}</div>\n                    </div>\n                    <div>\n                      <span className=\"text-muted-foreground\">Deposit ({selectedQuote.depositPercent}%):</span>\n                      <div className=\"font-medium\">{formatCurrency(selectedQuote.depositRequired)}</div>\n                    </div>\n                  </div>\n                  {selectedQuote.isTradeQuote && (\n                    <div className=\"pt-2 flex items-center gap-2\">\n                      <Badge variant=\"secondary\">Trade Quote</Badge>\n                      <span className=\"text-sm text-muted-foreground\">\n                        {selectedQuote.tradeDiscount}% discount applied\n                      </span>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader className=\"pb-3\">\n                  <CardTitle className=\"text-base flex items-center gap-2\">\n                    <FileText className=\"h-4 w-4\" />\n                    Project Details\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                    <div>\n                      <span className=\"text-muted-foreground\">Fence Height:</span>\n                      <div className=\"font-medium\">{selectedQuote.fenceHeight}mm</div>\n                    </div>\n                    <div>\n                      <span className=\"text-muted-foreground\">Total Length:</span>\n                      <div className=\"font-medium\">{selectedQuote.totalLength}m</div>\n                    </div>\n                  </div>\n                  <div>\n                    <span className=\"text-sm text-muted-foreground\">Site Address:</span>\n                    <div className=\"font-medium\">{selectedQuote.siteAddress}</div>\n                  </div>\n                </CardContent>\n              </Card>\n\n              {selectedQuote.lineItems && Array.isArray(selectedQuote.lineItems) && selectedQuote.lineItems.length > 0 && (\n                <Card>\n                  <CardHeader className=\"pb-3\">\n                    <CardTitle className=\"text-base\">Line Items</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-2\">\n                      {(selectedQuote.lineItems as any[]).map((item, index) => (\n                        <div key={index} className=\"flex justify-between text-sm py-2 border-b last:border-0\">\n                          <div>\n                            <div className=\"font-medium\">{item.productName || \"Product\"}</div>\n                            <div className=\"text-muted-foreground\">Qty: {item.quantity} x {formatCurrency(item.unitPrice)}</div>\n                          </div>\n                          <div className=\"font-medium\">{formatCurrency(item.totalPrice)}</div>\n                        </div>\n                      ))}\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n\n              <Card>\n                <CardHeader className=\"pb-3\">\n                  <CardTitle className=\"text-base flex items-center gap-2\">\n                    <Calendar className=\"h-4 w-4\" />\n                    Timeline\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-2 text-sm\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">Created:</span>\n                    <span>{new Date(selectedQuote.createdAt).toLocaleDateString(\"en-AU\")}</span>\n                  </div>\n                  {selectedQuote.sentAt && (\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-muted-foreground\">Sent:</span>\n                      <span>{new Date(selectedQuote.sentAt).toLocaleDateString(\"en-AU\")}</span>\n                    </div>\n                  )}\n                  {selectedQuote.approvedAt && (\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-muted-foreground\">Approved:</span>\n                      <span>{new Date(selectedQuote.approvedAt).toLocaleDateString(\"en-AU\")}</span>\n                    </div>\n                  )}\n                  {selectedQuote.validUntil && (\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-muted-foreground\">Valid Until:</span>\n                      <span>{new Date(selectedQuote.validUntil).toLocaleDateString(\"en-AU\")}</span>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n\n              {(selectedQuote.notes || selectedQuote.internalNotes) && (\n                <Card>\n                  <CardHeader className=\"pb-3\">\n                    <CardTitle className=\"text-base\">Notes</CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-3\">\n                    {selectedQuote.notes && (\n                      <div>\n                        <span className=\"text-sm text-muted-foreground\">Customer Notes:</span>\n                        <p className=\"mt-1\">{selectedQuote.notes}</p>\n                      </div>\n                    )}\n                    {selectedQuote.internalNotes && (\n                      <div>\n                        <span className=\"text-sm text-muted-foreground\">Internal Notes:</span>\n                        <p className=\"mt-1\">{selectedQuote.internalNotes}</p>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              )}\n            </div>\n          )}\n        </SheetContent>\n      </Sheet>\n\n      <Dialog open={isSetupTemplateOpen} onOpenChange={setIsSetupTemplateOpen}>\n        <DialogContent className=\"sm:max-w-4xl max-h-[90vh]\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <ClipboardList className=\"h-5 w-5\" />\n              Live Document - Setup & Handover\n            </DialogTitle>\n            <DialogDescription>\n              {selectedLeadForTemplate && (\n                <span className=\"flex items-center gap-2\">\n                  Lead: {selectedLeadForTemplate.leadNumber} - Fill in each section as you progress through the workflow\n                </span>\n              )}\n            </DialogDescription>\n          </DialogHeader>\n          \n          {selectedLeadForTemplate && (\n            <ScrollArea className=\"h-[70vh] pr-4\">\n              <JobSetupDocument\n                leadId={selectedLeadForTemplate.id}\n                jobType=\"supply_install\"\n              />\n              <div className=\"flex justify-end gap-2 pt-4 mt-4 border-t\">\n                <Button variant=\"outline\" onClick={() => setIsSetupTemplateOpen(false)}>\n                  Close\n                </Button>\n                <Button\n                  onClick={() => {\n                    setIsSetupTemplateOpen(false);\n                    setSelectedLeadForQuote(selectedLeadForTemplate);\n                    setIsQuoteBuilderOpen(true);\n                  }}\n                  data-testid=\"button-create-quote-from-template\"\n                >\n                  <FileText className=\"h-4 w-4 mr-2\" />\n                  Create Quote\n                </Button>\n              </div>\n            </ScrollArea>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n\nfunction mapStageToStatus(stage: string): LeadStatus {\n  switch (stage) {\n    case \"new\":\n      return \"new\";\n    case \"contacted\":\n    case \"site_visit_scheduled\":\n    case \"site_visit_complete\":\n    case \"needs_quote\":\n      return \"contacted\";\n    case \"quote_sent\":\n    case \"quote_revised\":\n    case \"follow_up\":\n      return \"quoted\";\n    case \"approved\":\n    case \"converted_to_job\":\n    case \"won\":\n      return \"approved\";\n    case \"declined\":\n    case \"lost\":\n      return \"declined\";\n    default:\n      return \"new\";\n  }\n}\n\nfunction mapStatusToStage(status: LeadStatus): string {\n  switch (status) {\n    case \"new\":\n      return \"new\";\n    case \"contacted\":\n      return \"contacted\";\n    case \"quoted\":\n      return \"quote_sent\";\n    case \"approved\":\n      return \"approved\";\n    case \"declined\":\n      return \"declined\";\n    default:\n      return \"new\";\n  }\n}\n\nfunction formatTimeAgo(date: Date | string): string {\n  const now = new Date();\n  const then = new Date(date);\n  const diffMs = now.getTime() - then.getTime();\n  const diffMins = Math.floor(diffMs / 60000);\n  const diffHours = Math.floor(diffMs / 3600000);\n  const diffDays = Math.floor(diffMs / 86400000);\n\n  if (diffMins < 60) return `${diffMins}m ago`;\n  if (diffHours < 24) return `${diffHours}h ago`;\n  return `${diffDays}d ago`;\n}\n","path":null,"size_bytes":54648,"size_tokens":null},"client/src/components/shared/DataTable.tsx":{"content":"import {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Button } from \"@/components/ui/button\";\nimport { MoreHorizontal, ChevronUp, ChevronDown } from \"lucide-react\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { useState } from \"react\";\n\nexport interface Column<T> {\n  key: string;\n  header: string;\n  sortable?: boolean;\n  render?: (item: T) => React.ReactNode;\n}\n\nexport interface Action<T> {\n  label: string;\n  onClick: (item: T) => void;\n  destructive?: boolean;\n}\n\ninterface DataTableProps<T> {\n  data: T[];\n  columns: Column<T>[];\n  actions?: Action<T>[];\n  onRowClick?: (item: T) => void;\n  keyExtractor: (item: T) => string;\n  emptyMessage?: string;\n}\n\nexport function DataTable<T extends object>({\n  data,\n  columns,\n  actions,\n  onRowClick,\n  keyExtractor,\n  emptyMessage = \"No data available\",\n}: DataTableProps<T>) {\n  const [sortKey, setSortKey] = useState<string | null>(null);\n  const [sortDirection, setSortDirection] = useState<\"asc\" | \"desc\">(\"asc\");\n\n  const handleSort = (key: string) => {\n    if (sortKey === key) {\n      setSortDirection(sortDirection === \"asc\" ? \"desc\" : \"asc\");\n    } else {\n      setSortKey(key);\n      setSortDirection(\"asc\");\n    }\n  };\n\n  const sortedData = [...data].sort((a, b) => {\n    if (!sortKey) return 0;\n    const aVal = (a as Record<string, unknown>)[sortKey];\n    const bVal = (b as Record<string, unknown>)[sortKey];\n    if (aVal === bVal) return 0;\n    const comparison = aVal! < bVal! ? -1 : 1;\n    return sortDirection === \"asc\" ? comparison : -comparison;\n  });\n\n  if (data.length === 0) {\n    return (\n      <div className=\"flex items-center justify-center py-12 text-muted-foreground\">\n        {emptyMessage}\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"rounded-md border\">\n      <Table>\n        <TableHeader>\n          <TableRow>\n            {columns.map((column) => (\n              <TableHead\n                key={column.key}\n                className={column.sortable ? \"cursor-pointer select-none\" : \"\"}\n                onClick={column.sortable ? () => handleSort(column.key) : undefined}\n              >\n                <div className=\"flex items-center gap-1\">\n                  {column.header}\n                  {column.sortable && sortKey === column.key && (\n                    sortDirection === \"asc\" ? (\n                      <ChevronUp className=\"h-3 w-3\" />\n                    ) : (\n                      <ChevronDown className=\"h-3 w-3\" />\n                    )\n                  )}\n                </div>\n              </TableHead>\n            ))}\n            {actions && actions.length > 0 && (\n              <TableHead className=\"w-12\" />\n            )}\n          </TableRow>\n        </TableHeader>\n        <TableBody>\n          {sortedData.map((item) => (\n            <TableRow\n              key={keyExtractor(item)}\n              className={onRowClick ? \"cursor-pointer hover-elevate\" : \"\"}\n              onClick={() => onRowClick?.(item)}\n              data-testid={`row-${keyExtractor(item)}`}\n            >\n              {columns.map((column) => (\n                <TableCell key={String(column.key)}>\n                  {column.render\n                    ? column.render(item)\n                    : String((item as Record<string, unknown>)[column.key as string] ?? \"\")}\n                </TableCell>\n              ))}\n              {actions && actions.length > 0 && (\n                <TableCell onClick={(e) => e.stopPropagation()}>\n                  <DropdownMenu>\n                    <DropdownMenuTrigger asChild>\n                      <Button variant=\"ghost\" size=\"icon\" data-testid={`button-actions-${keyExtractor(item)}`}>\n                        <MoreHorizontal className=\"h-4 w-4\" />\n                      </Button>\n                    </DropdownMenuTrigger>\n                    <DropdownMenuContent align=\"end\">\n                      {actions.map((action) => (\n                        <DropdownMenuItem\n                          key={action.label}\n                          onClick={() => action.onClick(item)}\n                          className={action.destructive ? \"text-destructive\" : \"\"}\n                        >\n                          {action.label}\n                        </DropdownMenuItem>\n                      ))}\n                    </DropdownMenuContent>\n                  </DropdownMenu>\n                </TableCell>\n              )}\n            </TableRow>\n          ))}\n        </TableBody>\n      </Table>\n    </div>\n  );\n}\n","path":null,"size_bytes":4613,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1883,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":791,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1077,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"replit.md":{"content":"# Probuild PVC - ERP & CRM System\n\n## Overview\nThis project is a comprehensive ERP & CRM system for Probuild PVC, a Western Australian PVC fencing manufacturer. The system streamlines the entire business workflow, from initial lead management and quoting to production, scheduling, installation, and payment processing. It caters to both public customers and trade clients, aiming to enhance operational efficiency and customer relationship management.\n\n## User Preferences\nI prefer simple language and detailed explanations. I want iterative development with frequent, small updates. Ask before making major architectural changes.\n\n## System Architecture\nThe system employs a modern web architecture with a clear separation of concerns.\n\n**UI/UX Decisions:**\n-   **Design System:** Adheres to Carbon Design System principles.\n-   **Color Scheme:** Utilizes a brand palette of Dark Teal (`#213d42`), Orange (`#db5c26`), and Pale Beige (`#f5e5d6`).\n-   **Components:** Leverages `shadcn/ui` for UI components.\n\n**Technical Implementations:**\n-   **Frontend:** Built with React 18, TypeScript, Vite, TanStack Query v5, and Wouter for routing.\n-   **Backend:** Developed using Express.js with Drizzle ORM.\n-   **Database:** PostgreSQL, hosted on Neon.\n-   **Styling:** Achieved with Tailwind CSS.\n\n**Feature Specifications:**\n-   **Core Modules:** Includes modules for Lead Management, Quote Builder, Job Workflow, Production Queue, Scheduling, Inventory, Payments, and CRM Messaging (SMS).\n-   **Staff Login & Personal Dashboard:** Session-based authentication system with personalized dashboard for each staff member. Features:\n    -   Login page with email/password authentication\n    -   AuthContext and useAuth hook for frontend state management\n    -   Personal Dashboard (/) with 5 widgets: My To-Do List, My Notifications, Role-Based KPIs, Weather (Perth, WA), and My Leave Balances\n    -   Business Dashboard (/business-dashboard) for company-wide metrics\n    -   Dynamic sidebar with user info display and logout functionality\n    -   Role-based KPI metrics calculated from real database data (leads, quotes, jobs, production tasks)\n    -   Leave balance tracking via staff_leave_balances table\n    -   **Role-specific Quick Actions:** Dynamic quick action buttons tailored to each user role (admin gets New Lead, Schedule, Business Dashboard; sales gets leads and quotes; scheduler gets scheduling tools; etc.)\n    -   **Task Navigation:** Click any task in the dashboard to open the corresponding lead detail dialog directly at the Activity tab with the specific task highlighted\n    -   **Completed Tasks View:** Toggle button to show/hide completed tasks on the dashboard, with count displayed in the widget header\n-   **Lead Card Detail Dialog:** Tabbed interface showing Details, Quotes, Activity (notes, tasks, activity log), and Live Document tabs. Supports adding notes, creating tasks, logging calls, and viewing/creating live documents for supply_install leads.\n-   **Call Log & Transcription System:** Full call logging with direction (inbound/outbound/missed), duration tracking, notes, and collapsible detail panels. Supports creating tasks linked to specific calls. Prepared for future AI transcription integration.\n-   **Specialized Applications:** Features a dedicated Installer Mobile App and a Trade Client Portal for self-service.\n-   **Hierarchical Numbering:** Implements a strict hierarchical numbering system for Leads (`PVC-XXX`), Quotes (`PVC-XXX-Q#`), Jobs (`PVC-XXX-JOB`), and Invoices (`PVC-XXX-INV`) to ensure consistent tracking and data linkage.\n-   **Direct Job Creation:** Allows creating jobs directly from the Jobs module without going through the leads/quotes flow:\n    -   \"New Job\" button in Jobs page (both list and kanban views)\n    -   System automatically creates a hidden Lead with source=\"direct_job\" and stage=\"won\"\n    -   Hidden leads appear in analytics (lead counts, win rates, source reporting)\n    -   Can be filtered out using lead_source if only \"normal\" leads are needed\n    -   Job and Lead share the same base ID (PVC-XXX  PVC-XXX-JOB)\n-   **Inline Client Creation:** When creating a new job, users can create clients on-the-fly:\n    -   UserPlus button next to client dropdown opens CreateClientDialog\n    -   Real-time duplicate detection checks name, email, and phone as user types\n    -   Red warning banner shows when similar clients are found\n    -   Click to view existing client card without closing the dialog\n    -   \"Use This Client\" button to select existing client instead of creating new\n    -   \"Not This Client\" button to dismiss and continue creating new client\n    -   Race condition handling prevents stale API results from appearing\n    -   Components: CreateClientDialog.tsx, use-debounce.ts hook\n    -   API: POST /api/clients/check-duplicate, checkClientDuplicates() storage method\n-   **Role-Based Access Control:** Comprehensive RBAC implementation with:\n    -   7 distinct user roles: admin, sales, scheduler, production_manager, warehouse, installer, trade_client\n    -   Centralized permissions configuration in `client/src/lib/permissions.ts`\n    -   Frontend sidebar filtering based on user role\n    -   Frontend route protection with unauthorized page redirect\n    -   Backend API protection via `requireRoles` middleware on all sensitive endpoints\n    -   Trade clients automatically redirected to `/trade` portal\n    -   Role-specific route access: admin (full), sales (leads/quotes/clients), scheduler (jobs/schedule), production_manager (jobs/production/inventory), warehouse (production/inventory), installer (installer app), trade_client (trade portal only)\n-   **Live Document System:** Manages dynamic job setup and handover documents, with template support and lead-level access.\n-   **Analytics & Automation:** Incorporates Quote Analytics Dashboard and configurable Automation Campaigns for SMS, triggered by various business events.\n-   **Core Reporting & Analytics System:** Centralized KPI logic for production-ready dashboards:\n    -   Lead Analytics: New Leads count, Total Active Leads, Leads by Stage/Source, Time to First Response, Time to Quote, Time to Close\n    -   Sales Analytics: Pending Quotes, Lead Conversion Rate (Won Leads  Leads with quotes sent), Average Deal Size, Pipeline Forecast (opportunity_value from active leads), Monthly/YTD Revenue, Won/Lost Value\n    -   Lead timestamp fields: first_response_at, quote_sent_at, won_at, lost_at, lost_reason\n    -   Analytics rules: Multiple quotes = one opportunity; conversion uses lead.status not quote status; direct job creation generates background lead with source=\"direct_job\"\n    -   API endpoints: GET /api/analytics/core, /api/analytics/leads, /api/analytics/sales (all support startDate/endDate query params)\n    -   Quote Analytics page displays both quote-level and lead-level KPIs for accurate forecasting\n-   **Opportunity Value & Primary Quote System:** Prevents forecasting inflation from multiple quotes:\n    -   Each lead has opportunity_value (set from primary quote) and primary_quote_id\n    -   Each quote has is_primary flag (only one per lead can be primary)\n    -   Setting a new primary quote updates the lead's opportunity_value automatically\n    -   Pipeline Forecast uses opportunity_value from active leads (not sum of all quotes)\n    -   Quote acceptance: sets quote as primary, marks lead as won, rejects other quotes, creates job\n    -   Quote Analytics displays: Total Quote Value (all quotes for activity metrics) and Pipeline Forecast (opportunity_value for accurate forecasting)\n-   **Internal Management:** Features an \"Organisation Hub\" for managing departments, workflows, policies, resources, and a knowledge base.\n-   **P&L Calculator:** Provides a staff-only comprehensive job costing and profit/loss analysis tool.\n-   **Job Stage Configuration:** Admin-only feature for managing job pipelines and stages:\n    -   Located at `/job-stage-configuration` (admin access only via Settings)\n    -   Create, edit, and delete job pipelines (e.g., Supply Only, Supply + Install)\n    -   Add, edit, delete, and reorder stages within each pipeline\n    -   Configure stage properties: name, icon (Lucide icon name), completion type (manual/automatic), active status\n    -   Database tables: job_pipelines (workflow definitions), job_pipeline_stages (stage definitions with sortOrder)\n    -   API routes: /api/job-pipelines, /api/job-pipelines/:id/stages, /api/job-pipeline-stages/:id, /api/job-pipelines/:id/stages/reorder\n    -   Pipelines are configured independently before being applied to job types (future enhancement)\n-   **Dashboard Builder:** Admin-only feature for configuring role-specific dashboards:\n    -   Located at `/dashboard-builder` (admin access only)\n    -   Create, edit, and delete dashboard layouts per role\n    -   Widget library with 29 pre-seeded widgets (KPIs, charts, tables, analytics)\n    -   Drag-and-drop widget arrangement with position and size configuration\n    -   Publish layouts to make them active for each role\n    -   Database tables: dashboard_widgets (widget library), role_dashboard_layouts (layout configs), dashboard_widget_instances (placed widgets)\n    -   API routes: /api/dashboard-builder/widgets, /api/dashboard-builder/layouts, /api/dashboard-builder/instances\n-   **Jobs Kanban View:** Visual job tracking with List/Kanban toggle:\n    -   View toggle button (ViewToggle component) switches between List and Kanban views\n    -   Kanban columns organized by job lifecycle: Pipeline, Production, Scheduling, Installation, Complete\n    -   Job cards with colored left borders (yellow for supply_install, green for supply_only)\n    -   Status badges: THIS WEEK (calendar icon), DELAYED (warning), WAITING ON CLIENT (hourglass)\n    -   Stage progress visualization with Lucide icons showing completion state\n    -   Stage complexity varies by job type: supply_install (5 or 8 stages with gate), supply_only (4 stages)\n    -   Components: JobKanbanBoard.tsx, JobKanbanCard.tsx, JobStageProgress.tsx, ViewToggle.tsx\n-   **Automatic Soil Type Detection:** When creating a new lead:\n    -   User enters address and selects from Google Maps autocomplete\n    -   System automatically geocodes address to get latitude/longitude\n    -   Calls CSIRO ASRIS API to fetch detailed soil information\n    -   Returns soil type (limestone, clay, gravel, sand, rock), installation notes, and geology warnings\n    -   Displays soil information preview in the lead form before saving\n    -   Saves soil type and installation notes to lead record in database\n    -   LIMESTONE zones trigger special warning due to drilling requirements\n    -   Soil types display on lead cards with LIMESTONE in red badge, others as gray text\n\n**System Design Choices:**\n-   **API:** All endpoints are prefixed with `/api/` and support standard CRUD operations.\n-   **Database Schema:** Consists of 18 main entities, including users, clients, leads, quotes, jobs, and various operational and logging tables. JSONB columns are used for flexible data storage in live documents.\n-   **Global Search:** A global search functionality is implemented to search across leads, quotes, and jobs.\n-   **Notifications:** Real-time notification system with persistent storage and UI alerts.\n\n## External Dependencies\n-   **Database:** Neon (PostgreSQL)\n-   **Payment Gateway:** Stripe\n-   **SMS Messaging:** Twilio\n-   **Open Banking:** Basiq CDR (Consumer Data Right) Integration for Westpac Business account connectivity\n\n## Banking Integration (Basiq CDR)\nThe system integrates with Basiq's CDR Open Banking API for secure bank account access:\n\n**CDR Consent Flow:**\n-   Uses hosted Consent UI - no bank credentials collected by the application\n-   POST `/api/financial/connect-bank` creates CDR consent and returns connect URL\n-   User redirected to bank's secure login (Westpac) to authorize access\n-   GET `/api/financial/callback` handles redirect after consent completion\n-   POST `/api/basiq/webhook` receives transaction update notifications\n\n**Key Features:**\n-   Account balances and transaction sync via consent\n-   365-day consent validity with renewal support\n-   Business details: Probuild PVC (ABN: 29 688 327 479)\n-   Database tracks consent lifecycle via `basiqConsentId` on `bank_connections`\n\n**Frontend (client/src/pages/Financial.tsx):**\n-   Simple \"Connect Bank Account\" button - no form fields\n-   Displays connection status, consent info, and expiry dates\n-   Overview, Accounts, Transactions, and Connections tabs\n-   Admin-only bank connection management","path":null,"size_bytes":12592,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"client/src/components/examples/AlertsPanelExample.tsx":{"content":"import { AlertsPanel } from \"@/components/dashboard/AlertsPanel\";\n\nexport default function AlertsPanelExample() {\n  const alerts = [\n    {\n      id: \"1\",\n      type: \"stock\" as const,\n      title: \"Low Stock Alert\",\n      message: \"PVC Post Cap White - Only 12 remaining\",\n      actionLabel: \"Reorder Now\",\n      onAction: () => console.log(\"Reorder clicked\"),\n    },\n    {\n      id: \"2\",\n      type: \"overdue\" as const,\n      title: \"Quote Follow-up Overdue\",\n      message: \"Johnson Property - Quote sent 5 days ago\",\n      actionLabel: \"Contact Client\",\n      onAction: () => console.log(\"Contact clicked\"),\n    },\n    {\n      id: \"3\",\n      type: \"payment\" as const,\n      title: \"Deposit Pending\",\n      message: \"Smith Residence - Awaiting deposit for 3 days\",\n    },\n  ];\n\n  return (\n    <AlertsPanel\n      alerts={alerts}\n      onDismiss={(id) => console.log(\"Dismissed:\", id)}\n    />\n  );\n}\n","path":null,"size_bytes":900,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1977,"size_tokens":null},"client/src/pages/Schedule.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { CalendarView } from \"@/components/schedule/CalendarView\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Label } from \"@/components/ui/label\";\nimport { Plus, MapPin, Clock, Wrench, Truck, Package, Ruler, Edit2, Trash2 } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { ScheduleEvent, Job, User } from \"@shared/schema\";\n\ntype CalendarEventType = \"install\" | \"delivery\" | \"pickup\" | \"measure\";\ntype DbEventType = \"install\" | \"delivery\" | \"pickup\" | \"site_measure\";\n\ninterface CalendarEvent {\n  id: string;\n  jobNumber: string;\n  clientName: string;\n  time: string;\n  type: CalendarEventType;\n  installer?: string;\n  installerRole?: string;\n  installerFullName?: string;\n  address?: string;\n}\n\ninterface Installer {\n  id: string;\n  name: string;\n  initials: string;\n  todayJobs: number;\n  weekJobs: number;\n  available: boolean;\n}\n\nconst eventFormSchema = z.object({\n  eventType: z.enum([\"install\", \"delivery\", \"pickup\", \"site_measure\"]),\n  title: z.string().min(1, \"Title is required\"),\n  description: z.string().optional(),\n  startDate: z.string().min(1, \"Start date is required\"),\n  startTime: z.string().min(1, \"Start time is required\"),\n  endDate: z.string().min(1, \"End date is required\"),\n  endTime: z.string().min(1, \"End time is required\"),\n  jobId: z.string().optional(),\n  assignedTo: z.string().optional(),\n  notes: z.string().optional(),\n  isConfirmed: z.boolean().default(false),\n});\n\ntype EventFormValues = z.infer<typeof eventFormSchema>;\n\nexport default function Schedule() {\n  const { toast } = useToast();\n  const [selectedEvent, setSelectedEvent] = useState<ScheduleEvent | null>(null);\n  const [isViewDialogOpen, setIsViewDialogOpen] = useState(false);\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [isEditMode, setIsEditMode] = useState(false);\n  const [selectedDate, setSelectedDate] = useState<Date | null>(null);\n\n  const { data: scheduleEvents = [], isLoading: eventsLoading } = useQuery<ScheduleEvent[]>({\n    queryKey: [\"/api/schedule\"],\n  });\n\n  const { data: jobs = [] } = useQuery<Job[]>({\n    queryKey: [\"/api/jobs\"],\n  });\n\n  const { data: users = [] } = useQuery<User[]>({\n    queryKey: [\"/api/users\"],\n  });\n\n  const installerUsers = users.filter(u => u.role === \"installer\");\n\n  const createEventMutation = useMutation({\n    mutationFn: async (data: EventFormValues) => {\n      const payload = {\n        eventType: data.eventType,\n        title: data.title,\n        description: data.description || null,\n        startDate: new Date(`${data.startDate}T${data.startTime}`).toISOString(),\n        endDate: new Date(`${data.endDate}T${data.endTime}`).toISOString(),\n        jobId: data.jobId && data.jobId !== \"none\" ? data.jobId : null,\n        assignedTo: data.assignedTo && data.assignedTo !== \"none\" ? data.assignedTo : null,\n        notes: data.notes || null,\n        isConfirmed: data.isConfirmed,\n        clientNotified: false,\n        installerNotified: false,\n      };\n      return apiRequest(\"POST\", \"/api/schedule\", payload);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/schedule\"] });\n      setIsCreateDialogOpen(false);\n      toast({ title: \"Event Created\", description: \"Calendar event has been created successfully.\" });\n    },\n    onError: () => {\n      toast({ title: \"Error\", description: \"Failed to create event.\", variant: \"destructive\" });\n    },\n  });\n\n  const updateEventMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: EventFormValues }) => {\n      const payload = {\n        eventType: data.eventType,\n        title: data.title,\n        description: data.description || null,\n        startDate: new Date(`${data.startDate}T${data.startTime}`).toISOString(),\n        endDate: new Date(`${data.endDate}T${data.endTime}`).toISOString(),\n        jobId: data.jobId && data.jobId !== \"none\" ? data.jobId : null,\n        assignedTo: data.assignedTo && data.assignedTo !== \"none\" ? data.assignedTo : null,\n        notes: data.notes || null,\n        isConfirmed: data.isConfirmed,\n      };\n      return apiRequest(\"PATCH\", `/api/schedule/${id}`, payload);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/schedule\"] });\n      setIsViewDialogOpen(false);\n      setIsEditMode(false);\n      setSelectedEvent(null);\n      toast({ title: \"Event Updated\", description: \"Calendar event has been updated successfully.\" });\n    },\n    onError: () => {\n      toast({ title: \"Error\", description: \"Failed to update event.\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteEventMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/schedule/${id}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/schedule\"] });\n      setIsViewDialogOpen(false);\n      setSelectedEvent(null);\n      toast({ title: \"Event Deleted\", description: \"Calendar event has been deleted.\" });\n    },\n    onError: () => {\n      toast({ title: \"Error\", description: \"Failed to delete event.\", variant: \"destructive\" });\n    },\n  });\n\n  const createForm = useForm<EventFormValues>({\n    resolver: zodResolver(eventFormSchema),\n    defaultValues: {\n      eventType: \"install\",\n      title: \"\",\n      description: \"\",\n      startDate: \"\",\n      startTime: \"09:00\",\n      endDate: \"\",\n      endTime: \"17:00\",\n      jobId: \"\",\n      assignedTo: \"\",\n      notes: \"\",\n      isConfirmed: false,\n    },\n  });\n\n  const editForm = useForm<EventFormValues>({\n    resolver: zodResolver(eventFormSchema),\n    defaultValues: {\n      eventType: \"install\",\n      title: \"\",\n      description: \"\",\n      startDate: \"\",\n      startTime: \"09:00\",\n      endDate: \"\",\n      endTime: \"17:00\",\n      jobId: \"\",\n      assignedTo: \"\",\n      notes: \"\",\n      isConfirmed: false,\n    },\n  });\n\n  const getJobInfo = (jobId: string | null) => {\n    if (!jobId) return { jobNumber: \"\", clientName: \"Event\" };\n    const job = jobs.find(j => j.id === jobId);\n    return {\n      jobNumber: job?.jobNumber || \"\",\n      clientName: job?.siteAddress?.split(\",\")[0] || \"Client\",\n    };\n  };\n\n  const getInstallerInfo = (userId: string | null) => {\n    if (!userId) return { name: undefined, role: undefined, fullName: undefined };\n    const user = users.find(u => u.id === userId);\n    if (!user) return { name: undefined, role: undefined, fullName: undefined };\n    return {\n      name: `${user.firstName} ${user.lastName?.[0] || \"\"}`,\n      role: user.role,\n      fullName: `${user.firstName} ${user.lastName}`,\n    };\n  };\n\n  const mapEventType = (dbType: string): CalendarEventType => {\n    if (dbType === \"site_measure\") return \"measure\";\n    return dbType as CalendarEventType;\n  };\n\n  const events: CalendarEvent[] = scheduleEvents.map((event) => {\n    const jobInfo = getJobInfo(event.jobId);\n    const installerInfo = getInstallerInfo(event.assignedTo);\n    return {\n      id: event.id,\n      jobNumber: jobInfo.jobNumber,\n      clientName: event.title || jobInfo.clientName,\n      time: new Date(event.startDate).toLocaleTimeString(\"en-AU\", {\n        hour: \"2-digit\",\n        minute: \"2-digit\",\n        hour12: false,\n      }),\n      type: mapEventType(event.eventType),\n      installer: installerInfo.name,\n      installerRole: installerInfo.role,\n      installerFullName: installerInfo.fullName,\n      address: event.description || \"\",\n    };\n  });\n\n  const installers: Installer[] = installerUsers.map((user) => {\n    const todayEvents = scheduleEvents.filter(e => {\n      const eventDate = new Date(e.startDate);\n      const today = new Date();\n      return e.assignedTo === user.id && \n             eventDate.toDateString() === today.toDateString();\n    });\n\n    const weekEvents = scheduleEvents.filter(e => {\n      const eventDate = new Date(e.startDate);\n      const now = new Date();\n      const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);\n      return e.assignedTo === user.id && \n             eventDate >= now && \n             eventDate <= weekFromNow;\n    });\n\n    return {\n      id: user.id,\n      name: `${user.firstName} ${user.lastName}`,\n      initials: `${user.firstName?.[0] || \"\"}${user.lastName?.[0] || \"\"}`,\n      todayJobs: todayEvents.length,\n      weekJobs: weekEvents.length,\n      available: true,\n    };\n  });\n\n  const pendingJobs = jobs\n    .filter(j => j.status === \"ready_for_scheduling\")\n    .slice(0, 5)\n    .map((job) => ({\n      id: job.id,\n      jobNumber: job.jobNumber,\n      clientName: job.siteAddress?.split(\",\")[0] || \"Client\",\n      readyDate: new Date().toLocaleDateString(\"en-AU\", { day: \"numeric\", month: \"short\" }),\n      type: job.jobType === \"supply_only\" ? \"pickup\" as const : \"install\" as const,\n    }));\n\n  const handleEventClick = (event: CalendarEvent) => {\n    const fullEvent = scheduleEvents.find(e => e.id === event.id);\n    if (fullEvent) {\n      setSelectedEvent(fullEvent);\n      setIsEditMode(false);\n      \n      const startDate = new Date(fullEvent.startDate);\n      const endDate = new Date(fullEvent.endDate);\n      \n      editForm.reset({\n        eventType: fullEvent.eventType as DbEventType,\n        title: fullEvent.title,\n        description: fullEvent.description || \"\",\n        startDate: startDate.toISOString().split(\"T\")[0],\n        startTime: startDate.toTimeString().slice(0, 5),\n        endDate: endDate.toISOString().split(\"T\")[0],\n        endTime: endDate.toTimeString().slice(0, 5),\n        jobId: fullEvent.jobId || \"\",\n        assignedTo: fullEvent.assignedTo || \"\",\n        notes: fullEvent.notes || \"\",\n        isConfirmed: fullEvent.isConfirmed || false,\n      });\n      \n      setIsViewDialogOpen(true);\n    }\n  };\n\n  const handleAddEvent = (date: Date) => {\n    setSelectedDate(date);\n    const dateStr = date.toISOString().split(\"T\")[0];\n    createForm.reset({\n      eventType: \"install\",\n      title: \"\",\n      description: \"\",\n      startDate: dateStr,\n      startTime: \"09:00\",\n      endDate: dateStr,\n      endTime: \"17:00\",\n      jobId: \"\",\n      assignedTo: \"\",\n      notes: \"\",\n      isConfirmed: false,\n    });\n    setIsCreateDialogOpen(true);\n  };\n\n  const handleCreateSubmit = (data: EventFormValues) => {\n    createEventMutation.mutate(data);\n  };\n\n  const handleEditSubmit = (data: EventFormValues) => {\n    if (selectedEvent) {\n      updateEventMutation.mutate({ id: selectedEvent.id, data });\n    }\n  };\n\n  const handleDelete = () => {\n    if (selectedEvent && confirm(\"Are you sure you want to delete this event?\")) {\n      deleteEventMutation.mutate(selectedEvent.id);\n    }\n  };\n\n  const getEventIcon = (type: string) => {\n    switch (type) {\n      case \"install\": return <Wrench className=\"h-4 w-4\" />;\n      case \"delivery\": return <Truck className=\"h-4 w-4\" />;\n      case \"pickup\": return <Package className=\"h-4 w-4\" />;\n      case \"site_measure\":\n      case \"measure\": return <Ruler className=\"h-4 w-4\" />;\n      default: return <Clock className=\"h-4 w-4\" />;\n    }\n  };\n\n  const getEventTypeLabel = (type: string) => {\n    switch (type) {\n      case \"install\": return \"Installation\";\n      case \"delivery\": return \"Delivery\";\n      case \"pickup\": return \"Pickup\";\n      case \"site_measure\":\n      case \"measure\": return \"Site Measure\";\n      default: return type;\n    }\n  };\n\n  const todayEvents = events.filter(e => {\n    const event = scheduleEvents.find(se => se.id === e.id);\n    if (!event) return false;\n    const eventDate = new Date(event.startDate);\n    const today = new Date();\n    return eventDate.toDateString() === today.toDateString();\n  });\n\n  const todaySummary = {\n    installs: todayEvents.filter(e => e.type === \"install\").length,\n    deliveries: todayEvents.filter(e => e.type === \"delivery\").length,\n    pickups: todayEvents.filter(e => e.type === \"pickup\").length,\n    measures: todayEvents.filter(e => e.type === \"measure\").length,\n  };\n\n  if (eventsLoading) {\n    return (\n      <div className=\"flex h-[calc(100vh-3.5rem)]\">\n        <div className=\"flex-1 p-6\">\n          <Skeleton className=\"h-10 w-64 mb-6\" />\n          <Skeleton className=\"h-[500px]\" />\n        </div>\n        <div className=\"w-80 border-l p-4\">\n          <Skeleton className=\"h-48 mb-4\" />\n          <Skeleton className=\"h-64\" />\n        </div>\n      </div>\n    );\n  }\n\n  const EventFormFields = ({ form, disabled = false }: { form: typeof createForm; disabled?: boolean }) => (\n    <div className=\"space-y-4\">\n      <FormField\n        control={form.control}\n        name=\"eventType\"\n        render={({ field }) => (\n          <FormItem>\n            <FormLabel>Event Type</FormLabel>\n            <Select onValueChange={field.onChange} value={field.value} disabled={disabled}>\n              <FormControl>\n                <SelectTrigger data-testid=\"select-event-type\">\n                  <SelectValue placeholder=\"Select type\" />\n                </SelectTrigger>\n              </FormControl>\n              <SelectContent>\n                <SelectItem value=\"install\">Installation</SelectItem>\n                <SelectItem value=\"delivery\">Delivery</SelectItem>\n                <SelectItem value=\"pickup\">Pickup</SelectItem>\n                <SelectItem value=\"site_measure\">Site Measure</SelectItem>\n              </SelectContent>\n            </Select>\n            <FormMessage />\n          </FormItem>\n        )}\n      />\n\n      <FormField\n        control={form.control}\n        name=\"title\"\n        render={({ field }) => (\n          <FormItem>\n            <FormLabel>Title</FormLabel>\n            <FormControl>\n              <Input {...field} placeholder=\"Event title\" disabled={disabled} data-testid=\"input-event-title\" />\n            </FormControl>\n            <FormMessage />\n          </FormItem>\n        )}\n      />\n\n      <div className=\"grid grid-cols-2 gap-4\">\n        <FormField\n          control={form.control}\n          name=\"startDate\"\n          render={({ field }) => (\n            <FormItem>\n              <FormLabel>Start Date</FormLabel>\n              <FormControl>\n                <Input type=\"date\" {...field} disabled={disabled} data-testid=\"input-start-date\" />\n              </FormControl>\n              <FormMessage />\n            </FormItem>\n          )}\n        />\n        <FormField\n          control={form.control}\n          name=\"startTime\"\n          render={({ field }) => (\n            <FormItem>\n              <FormLabel>Start Time</FormLabel>\n              <FormControl>\n                <Input type=\"time\" {...field} disabled={disabled} data-testid=\"input-start-time\" />\n              </FormControl>\n              <FormMessage />\n            </FormItem>\n          )}\n        />\n      </div>\n\n      <div className=\"grid grid-cols-2 gap-4\">\n        <FormField\n          control={form.control}\n          name=\"endDate\"\n          render={({ field }) => (\n            <FormItem>\n              <FormLabel>End Date</FormLabel>\n              <FormControl>\n                <Input type=\"date\" {...field} disabled={disabled} data-testid=\"input-end-date\" />\n              </FormControl>\n              <FormMessage />\n            </FormItem>\n          )}\n        />\n        <FormField\n          control={form.control}\n          name=\"endTime\"\n          render={({ field }) => (\n            <FormItem>\n              <FormLabel>End Time</FormLabel>\n              <FormControl>\n                <Input type=\"time\" {...field} disabled={disabled} data-testid=\"input-end-time\" />\n              </FormControl>\n              <FormMessage />\n            </FormItem>\n          )}\n        />\n      </div>\n\n      <FormField\n        control={form.control}\n        name=\"jobId\"\n        render={({ field }) => (\n          <FormItem>\n            <FormLabel>Linked Job (Optional)</FormLabel>\n            <Select onValueChange={field.onChange} value={field.value || \"none\"} disabled={disabled}>\n              <FormControl>\n                <SelectTrigger data-testid=\"select-linked-job\">\n                  <SelectValue placeholder=\"Select job\" />\n                </SelectTrigger>\n              </FormControl>\n              <SelectContent>\n                <SelectItem value=\"none\">No linked job</SelectItem>\n                {jobs.map((job) => (\n                  <SelectItem key={job.id} value={job.id}>\n                    {job.jobNumber} - {job.siteAddress?.split(\",\")[0] || \"Unknown\"}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            <FormMessage />\n          </FormItem>\n        )}\n      />\n\n      <FormField\n        control={form.control}\n        name=\"assignedTo\"\n        render={({ field }) => (\n          <FormItem>\n            <FormLabel>Assigned To (Optional)</FormLabel>\n            <Select onValueChange={field.onChange} value={field.value || \"none\"} disabled={disabled}>\n              <FormControl>\n                <SelectTrigger data-testid=\"select-assigned-to\">\n                  <SelectValue placeholder=\"Select installer\" />\n                </SelectTrigger>\n              </FormControl>\n              <SelectContent>\n                <SelectItem value=\"none\">Unassigned</SelectItem>\n                {installerUsers.map((user) => (\n                  <SelectItem key={user.id} value={user.id}>\n                    {user.firstName} {user.lastName}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            <FormMessage />\n          </FormItem>\n        )}\n      />\n\n      <FormField\n        control={form.control}\n        name=\"description\"\n        render={({ field }) => (\n          <FormItem>\n            <FormLabel>Description</FormLabel>\n            <FormControl>\n              <Textarea {...field} placeholder=\"Event description or address\" disabled={disabled} data-testid=\"input-description\" />\n            </FormControl>\n            <FormMessage />\n          </FormItem>\n        )}\n      />\n\n      <FormField\n        control={form.control}\n        name=\"notes\"\n        render={({ field }) => (\n          <FormItem>\n            <FormLabel>Notes</FormLabel>\n            <FormControl>\n              <Textarea {...field} placeholder=\"Additional notes\" disabled={disabled} data-testid=\"input-notes\" />\n            </FormControl>\n            <FormMessage />\n          </FormItem>\n        )}\n      />\n    </div>\n  );\n\n  return (\n    <div className=\"flex h-[calc(100vh-3.5rem)]\">\n      <div className=\"flex-1 p-6 overflow-auto\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <div>\n            <h1 className=\"text-2xl font-semibold\" data-testid=\"text-schedule-title\">Schedule</h1>\n            <p className=\"text-sm text-muted-foreground\">\n              Manage installs, deliveries, pickups, and site measures\n            </p>\n          </div>\n          <Button onClick={() => handleAddEvent(new Date())} data-testid=\"button-add-event\">\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Add Event\n          </Button>\n        </div>\n\n        <CalendarView\n          events={events}\n          onEventClick={handleEventClick}\n          onAddEvent={handleAddEvent}\n        />\n      </div>\n\n      <div className=\"w-80 border-l bg-card p-4 space-y-6 overflow-auto\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium\">Installers</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            {installers.length > 0 ? (\n              installers.map((installer) => (\n                <div\n                  key={installer.id}\n                  className=\"flex items-center gap-3 p-2 rounded-md hover-elevate cursor-pointer\"\n                  data-testid={`installer-${installer.id}`}\n                >\n                  <Avatar className=\"h-8 w-8\">\n                    <AvatarFallback className=\"text-xs bg-muted\">\n                      {installer.initials}\n                    </AvatarFallback>\n                  </Avatar>\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"flex items-center gap-2\">\n                      <span className=\"text-sm font-medium truncate\">{installer.name}</span>\n                      {!installer.available && (\n                        <Badge variant=\"secondary\" className=\"text-[10px]\">OFF</Badge>\n                      )}\n                    </div>\n                    <p className=\"text-xs text-muted-foreground\">\n                      Today: {installer.todayJobs} | Week: {installer.weekJobs}\n                    </p>\n                  </div>\n                </div>\n              ))\n            ) : (\n              <p className=\"text-sm text-muted-foreground\">No installers found</p>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium\">Pending Jobs</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <ScrollArea className=\"h-64\">\n              <div className=\"space-y-2\">\n                {pendingJobs.length > 0 ? (\n                  pendingJobs.map((job) => (\n                    <div\n                      key={job.id}\n                      className=\"p-3 rounded-md border hover-elevate cursor-pointer\"\n                      data-testid={`pending-job-${job.id}`}\n                    >\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        {getEventIcon(job.type)}\n                        <span className=\"font-mono text-xs text-muted-foreground\">{job.jobNumber}</span>\n                      </div>\n                      <p className=\"text-sm font-medium\">{job.clientName}</p>\n                      <div className=\"flex items-center gap-1 mt-1 text-xs text-muted-foreground\">\n                        <Clock className=\"h-3 w-3\" />\n                        <span>Ready: {job.readyDate}</span>\n                      </div>\n                    </div>\n                  ))\n                ) : (\n                  <p className=\"text-sm text-muted-foreground text-center py-4\">\n                    No pending jobs to schedule\n                  </p>\n                )}\n              </div>\n            </ScrollArea>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium\">Today's Summary</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-2\">\n            <div className=\"flex items-center justify-between text-sm\">\n              <div className=\"flex items-center gap-2\">\n                <Wrench className=\"h-4 w-4 text-success\" />\n                <span>Installs</span>\n              </div>\n              <span className=\"font-semibold\">{todaySummary.installs}</span>\n            </div>\n            <div className=\"flex items-center justify-between text-sm\">\n              <div className=\"flex items-center gap-2\">\n                <Truck className=\"h-4 w-4 text-warning\" />\n                <span>Deliveries</span>\n              </div>\n              <span className=\"font-semibold\">{todaySummary.deliveries}</span>\n            </div>\n            <div className=\"flex items-center justify-between text-sm\">\n              <div className=\"flex items-center gap-2\">\n                <Package className=\"h-4 w-4 text-primary\" />\n                <span>Pickups</span>\n              </div>\n              <span className=\"font-semibold\">{todaySummary.pickups}</span>\n            </div>\n            <div className=\"flex items-center justify-between text-sm\">\n              <div className=\"flex items-center gap-2\">\n                <Ruler className=\"h-4 w-4 text-accent\" />\n                <span>Measures</span>\n              </div>\n              <span className=\"font-semibold\">{todaySummary.measures}</span>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n        <DialogContent className=\"max-w-lg max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Create New Event</DialogTitle>\n            <DialogDescription>Add a new event to the schedule calendar.</DialogDescription>\n          </DialogHeader>\n          <Form {...createForm}>\n            <form onSubmit={createForm.handleSubmit(handleCreateSubmit)} className=\"space-y-4\">\n              <EventFormFields form={createForm} />\n              <div className=\"flex gap-2 pt-4\">\n                <Button type=\"button\" variant=\"outline\" className=\"flex-1\" onClick={() => setIsCreateDialogOpen(false)}>\n                  Cancel\n                </Button>\n                <Button type=\"submit\" className=\"flex-1\" disabled={createEventMutation.isPending} data-testid=\"button-create-event\">\n                  {createEventMutation.isPending ? \"Creating...\" : \"Create Event\"}\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={isViewDialogOpen} onOpenChange={(open) => {\n        setIsViewDialogOpen(open);\n        if (!open) {\n          setIsEditMode(false);\n          setSelectedEvent(null);\n        }\n      }}>\n        <DialogContent className=\"max-w-lg max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center justify-between\">\n              <span>{isEditMode ? \"Edit Event\" : \"Event Details\"}</span>\n              {!isEditMode && (\n                <div className=\"flex gap-1\">\n                  <Button size=\"icon\" variant=\"ghost\" onClick={() => setIsEditMode(true)} data-testid=\"button-edit-event\">\n                    <Edit2 className=\"h-4 w-4\" />\n                  </Button>\n                  <Button size=\"icon\" variant=\"ghost\" onClick={handleDelete} data-testid=\"button-delete-event\">\n                    <Trash2 className=\"h-4 w-4 text-destructive\" />\n                  </Button>\n                </div>\n              )}\n            </DialogTitle>\n            <DialogDescription>\n              {isEditMode ? \"Update the event details below.\" : \"View and manage event details.\"}\n            </DialogDescription>\n          </DialogHeader>\n          \n          {selectedEvent && !isEditMode && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-muted\">\n                  {getEventIcon(selectedEvent.eventType)}\n                </div>\n                <div>\n                  <Badge variant=\"outline\">{getEventTypeLabel(selectedEvent.eventType)}</Badge>\n                  <p className=\"font-semibold mt-1\">{selectedEvent.title}</p>\n                </div>\n              </div>\n              \n              <div className=\"space-y-2\">\n                <div className=\"flex items-center gap-2 text-sm\">\n                  <Clock className=\"h-4 w-4 text-muted-foreground\" />\n                  <span>\n                    {new Date(selectedEvent.startDate).toLocaleDateString(\"en-AU\", {\n                      weekday: \"short\",\n                      day: \"numeric\",\n                      month: \"short\",\n                      year: \"numeric\",\n                    })} at {new Date(selectedEvent.startDate).toLocaleTimeString(\"en-AU\", {\n                      hour: \"2-digit\",\n                      minute: \"2-digit\",\n                    })}\n                  </span>\n                </div>\n                \n                {selectedEvent.description && (\n                  <div className=\"flex items-center gap-2 text-sm\">\n                    <MapPin className=\"h-4 w-4 text-muted-foreground\" />\n                    <span>{selectedEvent.description}</span>\n                  </div>\n                )}\n                \n                {selectedEvent.assignedTo && (\n                  <div className=\"flex items-center gap-2 text-sm\">\n                    <Wrench className=\"h-4 w-4 text-muted-foreground\" />\n                    <span>Assigned: {getInstallerInfo(selectedEvent.assignedTo).fullName}</span>\n                  </div>\n                )}\n                \n                {selectedEvent.jobId && (\n                  <div className=\"flex items-center gap-2 text-sm\">\n                    <Package className=\"h-4 w-4 text-muted-foreground\" />\n                    <span>Job: {getJobInfo(selectedEvent.jobId).jobNumber}</span>\n                  </div>\n                )}\n                \n                {selectedEvent.notes && (\n                  <div className=\"mt-3 p-3 bg-muted rounded-md\">\n                    <Label className=\"text-xs text-muted-foreground\">Notes</Label>\n                    <p className=\"text-sm mt-1\">{selectedEvent.notes}</p>\n                  </div>\n                )}\n                \n                <div className=\"flex items-center gap-2 mt-3\">\n                  <Badge variant={selectedEvent.isConfirmed ? \"default\" : \"secondary\"}>\n                    {selectedEvent.isConfirmed ? \"Confirmed\" : \"Unconfirmed\"}\n                  </Badge>\n                  {selectedEvent.clientNotified && (\n                    <Badge variant=\"outline\">Client Notified</Badge>\n                  )}\n                </div>\n              </div>\n              \n              <div className=\"flex gap-2 pt-4\">\n                <Button variant=\"outline\" className=\"flex-1\" onClick={() => setIsViewDialogOpen(false)}>\n                  Close\n                </Button>\n                <Button className=\"flex-1\" onClick={() => setIsEditMode(true)} data-testid=\"button-edit-event-main\">\n                  Edit Event\n                </Button>\n              </div>\n            </div>\n          )}\n          \n          {selectedEvent && isEditMode && (\n            <Form {...editForm}>\n              <form onSubmit={editForm.handleSubmit(handleEditSubmit)} className=\"space-y-4\">\n                <EventFormFields form={editForm} />\n                <div className=\"flex gap-2 pt-4\">\n                  <Button type=\"button\" variant=\"outline\" className=\"flex-1\" onClick={() => setIsEditMode(false)}>\n                    Cancel\n                  </Button>\n                  <Button type=\"submit\" className=\"flex-1\" disabled={updateEventMutation.isPending} data-testid=\"button-save-changes\">\n                    {updateEventMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":31428,"size_tokens":null},"client/src/components/examples/ScheduleSnapshotExample.tsx":{"content":"import { ScheduleSnapshot } from \"@/components/dashboard/ScheduleSnapshot\";\n\nexport default function ScheduleSnapshotExample() {\n  const items = [\n    {\n      id: \"1\",\n      jobNumber: \"JOB-2024-089\",\n      clientName: \"Williams Family\",\n      address: \"42 Ocean Drive, Scarborough\",\n      installer: { name: \"Jake M\", initials: \"JM\" },\n      time: \"8:00\",\n      type: \"install\" as const,\n    },\n    {\n      id: \"2\",\n      jobNumber: \"JOB-2024-091\",\n      clientName: \"Harbor Homes\",\n      address: \"15 Marina Bay, Fremantle\",\n      installer: { name: \"Jarrad K\", initials: \"JK\" },\n      time: \"10:30\",\n      type: \"delivery\" as const,\n    },\n    {\n      id: \"3\",\n      jobNumber: \"JOB-2024-093\",\n      clientName: \"Coastal Living\",\n      address: \"8 Sunset Blvd, Cottesloe\",\n      installer: { name: \"Jake M\", initials: \"JM\" },\n      time: \"14:00\",\n      type: \"measure\" as const,\n    },\n  ];\n\n  return (\n    <ScheduleSnapshot\n      date=\"Wednesday, 4 December 2024\"\n      items={items}\n      onItemClick={(item) => console.log(\"Clicked:\", item)}\n      onViewSchedule={() => console.log(\"View schedule clicked\")}\n    />\n  );\n}\n","path":null,"size_bytes":1128,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"client/src/components/examples/JobTimelineExample.tsx":{"content":"import { JobTimeline } from \"@/components/jobs/JobTimeline\";\n\nexport default function JobTimelineExample() {\n  const events = [\n    {\n      id: \"1\",\n      title: \"Quote Accepted\",\n      description: \"Client approved quote and paid deposit\",\n      date: \"28 Nov\",\n      status: \"complete\" as const,\n    },\n    {\n      id: \"2\",\n      title: \"Production Started\",\n      description: \"Materials allocated, cutting commenced\",\n      date: \"30 Nov\",\n      status: \"complete\" as const,\n    },\n    {\n      id: \"3\",\n      title: \"Cutting Complete\",\n      description: \"All posts and rails cut to size\",\n      date: \"2 Dec\",\n      status: \"complete\" as const,\n    },\n    {\n      id: \"4\",\n      title: \"Assembly In Progress\",\n      description: \"Panels being assembled\",\n      date: \"4 Dec\",\n      status: \"current\" as const,\n    },\n    {\n      id: \"5\",\n      title: \"QA Check\",\n      date: \"5 Dec\",\n      status: \"pending\" as const,\n    },\n    {\n      id: \"6\",\n      title: \"Ready for Install\",\n      date: \"6 Dec\",\n      status: \"pending\" as const,\n    },\n    {\n      id: \"7\",\n      title: \"Installation\",\n      description: \"Scheduled with Jake M\",\n      date: \"11 Dec\",\n      status: \"pending\" as const,\n    },\n  ];\n\n  return (\n    <div className=\"p-4 max-w-md\">\n      <JobTimeline events={events} />\n    </div>\n  );\n}\n","path":null,"size_bytes":1312,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1056,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1584,"size_tokens":null},"client/src/components/schedule/CalendarView.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ChevronLeft, ChevronRight, Truck, Wrench, Package, Ruler, Plus } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ntype EventType = \"install\" | \"delivery\" | \"pickup\" | \"measure\";\ntype JobType = \"supply_only\" | \"supply_install\";\n\ninterface CalendarEvent {\n  id: string;\n  jobNumber: string;\n  clientName: string;\n  time: string;\n  type: EventType;\n  installer?: string;\n  installerRole?: string;\n  installerFullName?: string;\n  jobType?: JobType;\n}\n\ninterface CalendarDay {\n  date: Date;\n  isCurrentMonth: boolean;\n  isToday: boolean;\n  events: CalendarEvent[];\n}\n\ninterface CalendarViewProps {\n  events: CalendarEvent[];\n  onEventClick?: (event: CalendarEvent) => void;\n  onAddEvent?: (date: Date) => void;\n}\n\nconst eventTypeConfig: Record<EventType, { icon: typeof Wrench; color: string; label: string }> = {\n  install: { icon: Wrench, color: \"bg-success text-success-foreground\", label: \"Install\" },\n  delivery: { icon: Truck, color: \"bg-warning text-warning-foreground\", label: \"Delivery\" },\n  pickup: { icon: Package, color: \"bg-primary text-primary-foreground\", label: \"Pickup\" },\n  measure: { icon: Ruler, color: \"bg-accent text-accent-foreground\", label: \"Measure\" },\n};\n\nexport function CalendarView({ events, onEventClick, onAddEvent }: CalendarViewProps) {\n  const [currentDate, setCurrentDate] = useState(new Date());\n  const [viewMode, setViewMode] = useState<\"month\" | \"week\" | \"day\">(\"month\");\n\n  const today = new Date();\n  today.setHours(0, 0, 0, 0);\n\n  // Helper: get date from event time string\n  const getEventDate = (event: CalendarEvent): Date | null => {\n    try {\n      const date = new Date(event.time);\n      if (isNaN(date.getTime())) return null;\n      date.setHours(0, 0, 0, 0);\n      return date;\n    } catch {\n      return null;\n    }\n  };\n\n  // Helper: check if date is same day\n  const isSameDay = (date1: Date, date2: Date): boolean => {\n    const d1 = new Date(date1);\n    const d2 = new Date(date2);\n    d1.setHours(0, 0, 0, 0);\n    d2.setHours(0, 0, 0, 0);\n    return d1.getTime() === d2.getTime();\n  };\n\n  // Helper: get events for a specific day\n  const getEventsForDay = (date: Date): CalendarEvent[] => {\n    return events.filter(event => {\n      const eventDate = getEventDate(event);\n      return eventDate && isSameDay(eventDate, date);\n    });\n  };\n\n  // Helper: extract hour from event time\n  const getHourFromEvent = (event: CalendarEvent): number => {\n    try {\n      const date = new Date(event.time);\n      return date.getHours();\n    } catch {\n      return 9;\n    }\n  };\n\n  const formatMonthYear = (date: Date) => {\n    return date.toLocaleDateString(\"en-AU\", { month: \"long\", year: \"numeric\" });\n  };\n\n  const formatDayDate = (date: Date) => {\n    return date.toLocaleDateString(\"en-AU\", { weekday: \"long\", day: \"numeric\", month: \"long\", year: \"numeric\" });\n  };\n\n  // Month View: Get all days in month + padding\n  const getMonthDays = (): CalendarDay[] => {\n    const year = currentDate.getFullYear();\n    const month = currentDate.getMonth();\n    \n    const firstDay = new Date(year, month, 1);\n    const lastDay = new Date(year, month + 1, 0);\n    const startDate = new Date(firstDay);\n    startDate.setDate(startDate.getDate() - firstDay.getDay());\n\n    const days: CalendarDay[] = [];\n    let date = new Date(startDate);\n\n    for (let i = 0; i < 42; i++) {\n      const dateToAdd = new Date(date);\n      dateToAdd.setHours(0, 0, 0, 0);\n      \n      days.push({\n        date: dateToAdd,\n        isCurrentMonth: dateToAdd.getMonth() === month,\n        isToday: isSameDay(dateToAdd, today),\n        events: getEventsForDay(dateToAdd),\n      });\n\n      date.setDate(date.getDate() + 1);\n    }\n\n    return days;\n  };\n\n  // Week View: Get 7 days starting Monday\n  const getWeekDays = (): CalendarDay[] => {\n    const start = new Date(currentDate);\n    const day = start.getDay();\n    start.setDate(start.getDate() - (day === 0 ? 6 : day - 1));\n    start.setHours(0, 0, 0, 0);\n\n    const days: CalendarDay[] = [];\n    for (let i = 0; i < 7; i++) {\n      const date = new Date(start);\n      date.setDate(start.getDate() + i);\n\n      days.push({\n        date,\n        isCurrentMonth: date.getMonth() === currentDate.getMonth(),\n        isToday: isSameDay(date, today),\n        events: getEventsForDay(date),\n      });\n    }\n    return days;\n  };\n\n  // Day View: Just current day\n  const getDayData = (): CalendarDay => {\n    const date = new Date(currentDate);\n    date.setHours(0, 0, 0, 0);\n    return {\n      date,\n      isCurrentMonth: true,\n      isToday: isSameDay(date, today),\n      events: getEventsForDay(date),\n    };\n  };\n\n  const navigate = (direction: number) => {\n    const newDate = new Date(currentDate);\n    if (viewMode === \"day\") {\n      newDate.setDate(newDate.getDate() + direction);\n    } else if (viewMode === \"week\") {\n      newDate.setDate(newDate.getDate() + direction * 7);\n    } else {\n      newDate.setMonth(newDate.getMonth() + direction);\n    }\n    setCurrentDate(newDate);\n  };\n\n  const goToToday = () => {\n    setCurrentDate(new Date());\n  };\n\n  const monthDays = getMonthDays();\n  const weekDays = getWeekDays();\n  const dayData = getDayData();\n  const dayNames = [\"Sun\", \"Mon\", \"Tue\", \"Wed\", \"Thu\", \"Fri\", \"Sat\"];\n  const hours = Array.from({ length: 11 }, (_, i) => i + 6); // 6am to 4pm\n\n  // Event badge component\n  const EventBadge = ({ event }: { event: CalendarEvent }) => {\n    const config = eventTypeConfig[event.type];\n    const Icon = config.icon;\n    return (\n      <div\n        className={cn(\n          \"text-[10px] p-1 rounded flex items-center gap-1 truncate cursor-pointer hover-elevate\",\n          config.color\n        )}\n        onClick={(e) => {\n          e.stopPropagation();\n          onEventClick?.(event);\n        }}\n        data-testid={`calendar-event-${event.id}`}\n      >\n        <Icon className=\"h-2.5 w-2.5 flex-shrink-0\" />\n        <span className=\"truncate\">{event.time} {event.clientName}</span>\n      </div>\n    );\n  };\n\n  return (\n    <Card>\n      <CardHeader className=\"pb-3\">\n        <div className=\"flex items-center justify-between\">\n          <CardTitle className=\"text-base font-semibold\">\n            {viewMode === \"day\" ? formatDayDate(dayData.date) : formatMonthYear(currentDate)}\n          </CardTitle>\n          <div className=\"flex items-center gap-2\">\n            <div className=\"flex items-center border rounded-md\">\n              {([\"day\", \"week\", \"month\"] as const).map((mode) => (\n                <Button\n                  key={mode}\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className={cn(\n                    \"rounded-none first:rounded-l-md last:rounded-r-md\",\n                    viewMode === mode && \"bg-muted\"\n                  )}\n                  onClick={() => setViewMode(mode)}\n                  data-testid={`button-view-${mode}`}\n                >\n                  {mode.charAt(0).toUpperCase() + mode.slice(1)}\n                </Button>\n              ))}\n            </div>\n            <div className=\"flex items-center gap-1\">\n              <Button\n                variant=\"outline\"\n                size=\"icon\"\n                onClick={() => navigate(-1)}\n                data-testid=\"button-prev\"\n              >\n                <ChevronLeft className=\"h-4 w-4\" />\n              </Button>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={goToToday}\n                data-testid=\"button-today\"\n              >\n                Today\n              </Button>\n              <Button\n                variant=\"outline\"\n                size=\"icon\"\n                onClick={() => navigate(1)}\n                data-testid=\"button-next\"\n              >\n                <ChevronRight className=\"h-4 w-4\" />\n              </Button>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"flex gap-2 mt-3\">\n          {Object.entries(eventTypeConfig).map(([type, config]) => {\n            const Icon = config.icon;\n            return (\n              <Badge key={type} variant=\"outline\" className=\"gap-1\">\n                <Icon className=\"h-3 w-3\" />\n                {config.label}\n              </Badge>\n            );\n          })}\n        </div>\n      </CardHeader>\n\n      <CardContent>\n        {viewMode === \"month\" && (\n          <div className=\"grid grid-cols-7 gap-px bg-border rounded-md overflow-hidden\">\n            {dayNames.map((day) => (\n              <div\n                key={day}\n                className=\"bg-muted p-2 text-center text-xs font-medium text-muted-foreground\"\n              >\n                {day}\n              </div>\n            ))}\n            {monthDays.map((day, idx) => (\n              <div\n                key={idx}\n                className={cn(\n                  \"bg-background min-h-[100px] p-2 cursor-pointer hover-elevate\",\n                  day.isToday && \"ring-2 ring-accent ring-inset\"\n                )}\n                onClick={() => onAddEvent?.(day.date)}\n                data-testid={`calendar-day-${idx}`}\n              >\n                <div\n                  className={cn(\n                    \"text-sm font-medium mb-2\",\n                    !day.isCurrentMonth && \"text-muted-foreground\",\n                    day.isToday && \"text-accent\"\n                  )}\n                >\n                  {day.date.getDate()}\n                </div>\n                <div className=\"space-y-1\">\n                  {day.events.slice(0, 2).map((event) => (\n                    <EventBadge key={event.id} event={event} />\n                  ))}\n                  {day.events.length > 2 && (\n                    <div className=\"text-[10px] text-muted-foreground\">\n                      +{day.events.length - 2} more\n                    </div>\n                  )}\n                </div>\n              </div>\n            ))}\n          </div>\n        )}\n\n        {viewMode === \"week\" && (\n          <div className=\"overflow-x-auto\">\n            <div className=\"inline-block min-w-full\">\n              {/* Header row with days */}\n              <div className=\"grid gap-px bg-border rounded-md overflow-hidden\" style={{ gridTemplateColumns: \"80px repeat(7, 1fr)\" }}>\n                <div className=\"bg-muted p-2 text-center text-xs font-medium text-muted-foreground\">Time</div>\n                {weekDays.map((day, idx) => (\n                  <div\n                    key={idx}\n                    className={cn(\n                      \"bg-muted p-2 text-center text-xs font-medium text-muted-foreground\",\n                      day.isToday && \"bg-accent text-accent-foreground\"\n                    )}\n                  >\n                    <div>{dayNames[day.date.getDay()]}</div>\n                    <div>{day.date.getDate()}</div>\n                  </div>\n                ))}\n              </div>\n\n              {/* Time grid */}\n              {hours.map((hour) => (\n                <div key={hour} className=\"grid gap-px bg-border\" style={{ gridTemplateColumns: \"80px repeat(7, 1fr)\" }}>\n                  <div className=\"bg-muted p-2 text-center text-xs font-medium text-muted-foreground\">\n                    {hour}:00\n                  </div>\n                  {weekDays.map((day, dayIdx) => {\n                    const dayEvents = day.events.filter(e => getHourFromEvent(e) === hour);\n                    return (\n                      <div\n                        key={dayIdx}\n                        className={cn(\n                          \"bg-background min-h-[60px] p-1 cursor-pointer hover-elevate border-b border-border\",\n                          day.isToday && \"bg-accent/5\"\n                        )}\n                        onClick={() => onAddEvent?.(day.date)}\n                        data-testid={`week-cell-${hour}-${dayIdx}`}\n                      >\n                        <div className=\"space-y-1\">\n                          {dayEvents.map((event) => {\n                            const config = eventTypeConfig[event.type];\n                            const Icon = config.icon;\n                            return (\n                              <div\n                                key={event.id}\n                                className={cn(\n                                  \"text-[10px] p-1 rounded flex items-center gap-1 truncate cursor-pointer hover-elevate\",\n                                  config.color\n                                )}\n                                onClick={(e) => {\n                                  e.stopPropagation();\n                                  onEventClick?.(event);\n                                }}\n                                data-testid={`week-event-${event.id}`}\n                              >\n                                <Icon className=\"h-2.5 w-2.5 flex-shrink-0\" />\n                                <span className=\"truncate text-xs\">{event.clientName}</span>\n                              </div>\n                            );\n                          })}\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              ))}\n            </div>\n          </div>\n        )}\n\n        {viewMode === \"day\" && (\n          <div className=\"space-y-6\">\n            {/* Supply Only Section */}\n            <div>\n              <h3 className=\"font-semibold text-sm mb-3 flex items-center gap-2\">\n                <Badge variant=\"outline\">Supply Only</Badge>\n                <span className=\"text-xs text-muted-foreground\">\n                  {dayData.events.filter(e => e.jobType === \"supply_only\").length} events\n                </span>\n              </h3>\n              {dayData.events.filter(e => e.jobType === \"supply_only\").length > 0 ? (\n                <div className=\"space-y-2\">\n                  {dayData.events\n                    .filter(e => e.jobType === \"supply_only\")\n                    .sort((a, b) => a.time.localeCompare(b.time))\n                    .map((event) => {\n                      const config = eventTypeConfig[event.type];\n                      const Icon = config.icon;\n                      return (\n                        <div\n                          key={event.id}\n                          className={cn(\n                            \"p-3 rounded-md border cursor-pointer hover-elevate flex items-start gap-3\",\n                            config.color\n                          )}\n                          onClick={() => onEventClick?.(event)}\n                          data-testid={`day-event-${event.id}`}\n                        >\n                          <Icon className=\"h-5 w-5 mt-0.5 flex-shrink-0\" />\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"font-medium text-sm\">{event.clientName}</div>\n                            <div className=\"text-xs text-muted-foreground\">\n                              {event.time}\n                            </div>\n                            {event.installerFullName && (\n                              <div className=\"text-xs text-muted-foreground mt-1\">\n                                <div>{event.installerFullName}</div>\n                                {event.installerRole && (\n                                  <div className=\"capitalize text-[11px]\">{event.installerRole.replace('_', ' ')}</div>\n                                )}\n                              </div>\n                            )}\n                            {event.jobNumber && (\n                              <div className=\"text-xs text-muted-foreground mt-1 font-mono\">\n                                {event.jobNumber}\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                      );\n                    })}\n                </div>\n              ) : (\n                <div className=\"text-sm text-muted-foreground p-3 border border-dashed rounded-md text-center\">\n                  No supply only events\n                </div>\n              )}\n            </div>\n\n            {/* Supply & Install Section */}\n            <div>\n              <h3 className=\"font-semibold text-sm mb-3 flex items-center gap-2\">\n                <Badge variant=\"outline\">Supply & Install</Badge>\n                <span className=\"text-xs text-muted-foreground\">\n                  {dayData.events.filter(e => e.jobType === \"supply_install\").length} events\n                </span>\n              </h3>\n              {dayData.events.filter(e => e.jobType === \"supply_install\").length > 0 ? (\n                <div className=\"space-y-2\">\n                  {dayData.events\n                    .filter(e => e.jobType === \"supply_install\")\n                    .sort((a, b) => a.time.localeCompare(b.time))\n                    .map((event) => {\n                      const config = eventTypeConfig[event.type];\n                      const Icon = config.icon;\n                      return (\n                        <div\n                          key={event.id}\n                          className={cn(\n                            \"p-3 rounded-md border cursor-pointer hover-elevate flex items-start gap-3\",\n                            config.color\n                          )}\n                          onClick={() => onEventClick?.(event)}\n                          data-testid={`day-event-${event.id}`}\n                        >\n                          <Icon className=\"h-5 w-5 mt-0.5 flex-shrink-0\" />\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"font-medium text-sm\">{event.clientName}</div>\n                            <div className=\"text-xs text-muted-foreground\">\n                              {event.time}\n                            </div>\n                            {event.installerFullName && (\n                              <div className=\"text-xs text-muted-foreground mt-1\">\n                                <div>{event.installerFullName}</div>\n                                {event.installerRole && (\n                                  <div className=\"capitalize text-[11px]\">{event.installerRole.replace('_', ' ')}</div>\n                                )}\n                              </div>\n                            )}\n                            {event.jobNumber && (\n                              <div className=\"text-xs text-muted-foreground mt-1 font-mono\">\n                                {event.jobNumber}\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                      );\n                    })}\n                </div>\n              ) : (\n                <div className=\"text-sm text-muted-foreground p-3 border border-dashed rounded-md text-center\">\n                  No supply & install events\n                </div>\n              )}\n            </div>\n\n            {dayData.events.length === 0 && (\n              <div className=\"text-center py-8\">\n                <p className=\"text-sm text-muted-foreground mb-3\">No events scheduled for this day</p>\n                <Button onClick={() => onAddEvent?.(dayData.date)} size=\"sm\">\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Add Event\n                </Button>\n              </div>\n            )}\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":19555,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":2695,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"client/src/components/leads/KanbanBoard.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Plus } from \"lucide-react\";\nimport { LeadCard } from \"./LeadCard\";\n\ntype LeadStatus = \"new\" | \"contacted\" | \"quoted\" | \"approved\" | \"declined\";\n\ninterface QuoteInfo {\n  total: number;\n  sent: number;\n  approved: number;\n  failed: number;\n  drafts: number;\n}\n\ninterface Lead {\n  id: string;\n  leadNumber: string;\n  clientName: string;\n  phone: string;\n  email: string;\n  address: string;\n  source: string;\n  fenceStyle: string;\n  leadType: \"public\" | \"trade\";\n  jobFulfillmentType?: \"supply_only\" | \"supply_install\";\n  status: LeadStatus;\n  assignedTo: {\n    name: string;\n    initials: string;\n  };\n  createdAt: string;\n  quoteInfo?: QuoteInfo;\n  soilWarning?: string | null;\n  soilInstallNotes?: string | null;\n  hasUnreadMessages?: boolean;\n  hasPendingTasks?: boolean;\n  pendingTaskCount?: number;\n  isAssigned?: boolean;\n}\n\ninterface KanbanColumn {\n  id: LeadStatus;\n  title: string;\n  color: string;\n}\n\ninterface KanbanBoardProps {\n  leads: Lead[];\n  onLeadClick?: (lead: Lead) => void;\n  onAddLead?: () => void;\n  onCreateQuote?: (lead: Lead) => void;\n  onEditLead?: (lead: Lead) => void;\n  onDeleteLead?: (lead: Lead) => void;\n  onViewSetupTemplate?: (lead: Lead) => void;\n  onLeadStatusChange?: (leadId: string, newStatus: LeadStatus) => void;\n  isUpdating?: boolean;\n}\n\nconst columns: KanbanColumn[] = [\n  { id: \"new\", title: \"New Leads\", color: \"bg-accent\" },\n  { id: \"contacted\", title: \"Contacted\", color: \"bg-primary\" },\n  { id: \"quoted\", title: \"Quote Sent\", color: \"bg-warning\" },\n  { id: \"approved\", title: \"Approved\", color: \"bg-success\" },\n  { id: \"declined\", title: \"Declined\", color: \"bg-destructive\" },\n];\n\nexport function KanbanBoard({\n  leads,\n  onLeadClick,\n  onAddLead,\n  onCreateQuote,\n  onEditLead,\n  onDeleteLead,\n  onViewSetupTemplate,\n  onLeadStatusChange,\n  isUpdating = false,\n}: KanbanBoardProps) {\n  const [draggedLead, setDraggedLead] = useState<Lead | null>(null);\n  const [dragOverColumn, setDragOverColumn] = useState<LeadStatus | null>(null);\n\n  const canDrag = !isUpdating;\n\n  const getLeadsForColumn = (status: LeadStatus) =>\n    leads.filter((lead) => lead.status === status);\n\n  const handleDragStart = (lead: Lead) => {\n    if (canDrag) {\n      setDraggedLead(lead);\n    }\n  };\n\n  const handleDragOver = (e: React.DragEvent, columnStatus: LeadStatus) => {\n    e.preventDefault();\n    setDragOverColumn(columnStatus);\n  };\n\n  const handleDragLeave = () => {\n    setDragOverColumn(null);\n  };\n\n  const handleDragEnd = () => {\n    setDraggedLead(null);\n    setDragOverColumn(null);\n  };\n\n  const handleDrop = (status: LeadStatus) => {\n    if (draggedLead && draggedLead.status !== status && onLeadStatusChange) {\n      onLeadStatusChange(draggedLead.id, status);\n    }\n    setDraggedLead(null);\n    setDragOverColumn(null);\n  };\n\n  return (\n    <div className=\"flex gap-4 overflow-x-auto pb-4\">\n      {columns.map((column) => {\n        const columnLeads = getLeadsForColumn(column.id);\n        const isDropTarget = dragOverColumn === column.id && draggedLead?.status !== column.id;\n        return (\n          <div\n            key={column.id}\n            className={`flex-shrink-0 w-80 transition-all duration-200 ${isDropTarget ? \"ring-2 ring-primary rounded-lg\" : \"\"}`}\n            onDragOver={(e) => handleDragOver(e, column.id)}\n            onDragLeave={handleDragLeave}\n            onDrop={() => handleDrop(column.id)}\n            data-testid={`kanban-column-${column.id}`}\n          >\n            <Card className=\"h-full\">\n              <CardHeader className=\"pb-3\">\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-2\">\n                    <div className={`h-2 w-2 rounded-full ${column.color}`} />\n                    <CardTitle className=\"text-sm font-medium\">\n                      {column.title}\n                    </CardTitle>\n                  </div>\n                  <Badge variant=\"secondary\" className=\"text-xs\">\n                    {columnLeads.length}\n                  </Badge>\n                </div>\n              </CardHeader>\n              <CardContent className=\"p-2\">\n                <ScrollArea className=\"h-[calc(100vh-280px)]\">\n                  <div className=\"space-y-3 p-1\">\n                    {column.id === \"new\" && onAddLead && (\n                      <Button\n                        variant=\"outline\"\n                        className=\"w-full border-dashed\"\n                        onClick={onAddLead}\n                        data-testid=\"button-add-lead\"\n                      >\n                        <Plus className=\"h-4 w-4 mr-2\" />\n                        Add Lead\n                      </Button>\n                    )}\n                    {columnLeads.map((lead) => (\n                      <div\n                        key={lead.id}\n                        draggable={canDrag}\n                        onDragStart={() => handleDragStart(lead)}\n                        onDragEnd={handleDragEnd}\n                        className={`${canDrag ? \"cursor-grab active:cursor-grabbing\" : \"cursor-default\"} ${draggedLead?.id === lead.id ? \"opacity-50\" : \"\"}`}\n                      >\n                        <LeadCard\n                          lead={lead}\n                          onClick={() => onLeadClick?.(lead)}\n                          onCreateQuote={() => onCreateQuote?.(lead)}\n                          onEdit={() => onEditLead?.(lead)}\n                          onDelete={() => onDeleteLead?.(lead)}\n                          onViewSetupTemplate={() => onViewSetupTemplate?.(lead)}\n                        />\n                      </div>\n                    ))}\n                    {columnLeads.length === 0 && column.id !== \"new\" && (\n                      <p className=\"text-sm text-muted-foreground text-center py-8\">\n                        No leads\n                      </p>\n                    )}\n                  </div>\n                </ScrollArea>\n              </CardContent>\n            </Card>\n          </div>\n        );\n      })}\n    </div>\n  );\n}\n","path":null,"size_bytes":6303,"size_tokens":null},"client/src/components/jobs/JobTimeline.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { CheckCircle2, Circle, Loader2 } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { Button } from \"@/components/ui/button\";\nimport * as LucideIcons from \"lucide-react\";\n\ninterface TimelineStage {\n  id: string;\n  title: string;\n  description?: string;\n  icon?: string;\n  isCompleted: boolean;\n  completedAt?: string;\n}\n\ninterface JobTimelineProps {\n  stages: TimelineStage[];\n  onToggleStage?: (stageId: string) => void;\n  isLoading?: boolean;\n  loadingStageId?: string | null;\n}\n\nfunction getIconComponent(iconName?: string) {\n  if (!iconName) return null;\n  const IconComponent = (LucideIcons as Record<string, any>)[iconName];\n  return IconComponent ? <IconComponent className=\"h-4 w-4\" /> : null;\n}\n\nexport function JobTimeline({ stages, onToggleStage, isLoading, loadingStageId }: JobTimelineProps) {\n  return (\n    <Card>\n      <CardHeader className=\"pb-3\">\n        <CardTitle className=\"text-base font-semibold\">Job Timeline</CardTitle>\n      </CardHeader>\n      <CardContent>\n        <div className=\"space-y-4\">\n          {stages.map((stage, index) => {\n            const isStageLoading = loadingStageId === stage.id;\n            \n            return (\n              <div\n                key={stage.id}\n                className=\"flex gap-3\"\n                data-testid={`timeline-stage-${stage.id}`}\n              >\n                <div className=\"flex flex-col items-center\">\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    className={cn(\n                      \"h-6 w-6 p-0 rounded-full\",\n                      stage.isCompleted \n                        ? \"text-success hover:text-success/80\" \n                        : \"text-muted-foreground hover:text-foreground\"\n                    )}\n                    onClick={() => onToggleStage?.(stage.id)}\n                    disabled={isLoading}\n                    data-testid={`toggle-stage-${stage.id}`}\n                  >\n                    {isStageLoading ? (\n                      <Loader2 className=\"h-5 w-5 animate-spin\" />\n                    ) : stage.isCompleted ? (\n                      <CheckCircle2 className=\"h-5 w-5\" />\n                    ) : (\n                      <Circle className=\"h-5 w-5\" />\n                    )}\n                  </Button>\n                  {index < stages.length - 1 && (\n                    <div\n                      className={cn(\n                        \"w-0.5 flex-1 mt-2\",\n                        stage.isCompleted ? \"bg-success\" : \"bg-muted\"\n                      )}\n                    />\n                  )}\n                </div>\n                <div className=\"flex-1 pb-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-2\">\n                      {stage.icon && (\n                        <span className={cn(\n                          \"text-muted-foreground\",\n                          stage.isCompleted && \"text-success\"\n                        )}>\n                          {getIconComponent(stage.icon)}\n                        </span>\n                      )}\n                      <span\n                        className={cn(\n                          \"font-medium text-sm\",\n                          !stage.isCompleted && \"text-muted-foreground\"\n                        )}\n                      >\n                        {stage.title}\n                      </span>\n                    </div>\n                    {stage.completedAt && (\n                      <span className=\"text-xs text-muted-foreground\">\n                        {new Date(stage.completedAt).toLocaleDateString(\"en-AU\", {\n                          day: \"numeric\",\n                          month: \"short\",\n                        })}\n                      </span>\n                    )}\n                  </div>\n                  {stage.description && (\n                    <p className=\"text-xs text-muted-foreground mt-1\">{stage.description}</p>\n                  )}\n                </div>\n              </div>\n            );\n          })}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":4234,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1280,"size_tokens":null},"client/src/components/dashboard/PriorityList.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { StatusBadge } from \"@/components/shared/StatusBadge\";\nimport { ChevronRight, Clock } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface PriorityItem {\n  id: string;\n  title: string;\n  subtitle: string;\n  status: \"new\" | \"contacted\" | \"quoted\" | \"approved\" | \"pending\" | \"overdue\";\n  timeAgo: string;\n  urgent?: boolean;\n}\n\ninterface PriorityListProps {\n  title: string;\n  items: PriorityItem[];\n  onItemClick?: (item: PriorityItem) => void;\n  onViewAll?: () => void;\n  emptyMessage?: string;\n}\n\nexport function PriorityList({\n  title,\n  items,\n  onItemClick,\n  onViewAll,\n  emptyMessage = \"No items\",\n}: PriorityListProps) {\n  return (\n    <Card>\n      <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-4\">\n        <CardTitle className=\"text-base font-semibold\">{title}</CardTitle>\n        {onViewAll && (\n          <Button variant=\"ghost\" size=\"sm\" onClick={onViewAll} data-testid={`button-view-all-${title.toLowerCase().replace(/\\s+/g, '-')}`}>\n            View All\n            <ChevronRight className=\"ml-1 h-4 w-4\" />\n          </Button>\n        )}\n      </CardHeader>\n      <CardContent className=\"space-y-2\">\n        {items.length === 0 ? (\n          <p className=\"text-sm text-muted-foreground py-4 text-center\">{emptyMessage}</p>\n        ) : (\n          items.map((item) => (\n            <div\n              key={item.id}\n              className={cn(\n                \"flex items-center justify-between p-3 rounded-md hover-elevate cursor-pointer\",\n                item.urgent && \"border-l-2 border-l-accent\"\n              )}\n              onClick={() => onItemClick?.(item)}\n              data-testid={`priority-item-${item.id}`}\n            >\n              <div className=\"flex-1 min-w-0\">\n                <div className=\"flex items-center gap-2 mb-1\">\n                  <span className=\"font-medium text-sm truncate\">{item.title}</span>\n                  <StatusBadge status={item.status} />\n                </div>\n                <p className=\"text-xs text-muted-foreground truncate\">{item.subtitle}</p>\n              </div>\n              <div className=\"flex items-center gap-1 text-xs text-muted-foreground ml-2\">\n                <Clock className=\"h-3 w-3\" />\n                <span>{item.timeAgo}</span>\n              </div>\n            </div>\n          ))\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":2509,"size_tokens":null},"client/src/components/layout/ThemeToggle.tsx":{"content":"import { Moon, Sun } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useTheme } from \"./ThemeProvider\";\n\nexport function ThemeToggle() {\n  const { theme, setTheme } = useTheme();\n\n  return (\n    <Button\n      variant=\"ghost\"\n      size=\"icon\"\n      onClick={() => setTheme(theme === \"light\" ? \"dark\" : \"light\")}\n      data-testid=\"button-theme-toggle\"\n    >\n      <Sun className=\"h-4 w-4 rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0\" />\n      <Moon className=\"absolute h-4 w-4 rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100\" />\n      <span className=\"sr-only\">Toggle theme</span>\n    </Button>\n  );\n}\n","path":null,"size_bytes":665,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":157,"size_tokens":null},"client/src/pages/Installer.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { StatusBadge } from \"@/components/shared/StatusBadge\";\nimport {\n  MapPin,\n  Phone,\n  Clock,\n  Camera,\n  CheckCircle,\n  Navigation,\n  Package,\n  AlertTriangle,\n  Plus,\n} from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Job, Client, ScheduleEvent, BOM } from \"@shared/schema\";\n\ninterface DisplayInstallerJob {\n  id: string;\n  jobNumber: string;\n  clientName: string;\n  clientPhone: string;\n  address: string;\n  fenceStyle: string;\n  scheduledTime: string;\n  status: \"upcoming\" | \"in_progress\" | \"complete\";\n  materials: string[];\n  notes?: string;\n}\n\nexport default function Installer() {\n  const { toast } = useToast();\n  const [selectedJob, setSelectedJob] = useState<DisplayInstallerJob | null>(null);\n  const [variationNotes, setVariationNotes] = useState(\"\");\n\n  const { data: jobs = [], isLoading: jobsLoading } = useQuery<Job[]>({\n    queryKey: [\"/api/jobs\"],\n  });\n\n  const { data: clients = [] } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const { data: scheduleEvents = [] } = useQuery<ScheduleEvent[]>({\n    queryKey: [\"/api/schedule\"],\n  });\n\n  const updateJobMutation = useMutation({\n    mutationFn: async ({ jobId, data }: { jobId: string; data: Partial<Job> }) => {\n      return apiRequest(\"PATCH\", `/api/jobs/${jobId}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/jobs\"] });\n    },\n  });\n\n  const getClientName = (clientId: string) => {\n    const client = clients.find(c => c.id === clientId);\n    return client?.name || \"Unknown Client\";\n  };\n\n  const getClientPhone = (clientId: string) => {\n    const client = clients.find(c => c.id === clientId);\n    return client?.phone || \"\";\n  };\n\n  const getJobStatus = (job: Job): \"upcoming\" | \"in_progress\" | \"complete\" => {\n    const status = job.status;\n    if (status === \"install_complete\" || status === \"paid_in_full\" || status === \"archived\" || status === \"awaiting_final_payment\") {\n      return \"complete\";\n    }\n    if (status === \"install_posts\" || status === \"install_panels\" || status === \"install_gates\") {\n      return \"in_progress\";\n    }\n    return \"upcoming\";\n  };\n\n  const getScheduledTime = (jobId: string) => {\n    const event = scheduleEvents.find(e => e.jobId === jobId && e.eventType === \"install\");\n    if (event) {\n      return new Date(event.startDate).toLocaleTimeString(\"en-AU\", { hour: \"numeric\", minute: \"2-digit\", hour12: true }).toUpperCase();\n    }\n    return \"TBD\";\n  };\n\n  const installerJobs = jobs.filter(job => \n    job.jobType === \"supply_install\" && \n    [\"scheduled\", \"install_posts\", \"install_panels\", \"install_gates\", \"install_complete\"].includes(job.status)\n  );\n\n  const displayJobs: DisplayInstallerJob[] = installerJobs.map((job) => ({\n    id: job.id,\n    jobNumber: job.jobNumber,\n    clientName: getClientName(job.clientId),\n    clientPhone: getClientPhone(job.clientId),\n    address: job.siteAddress,\n    fenceStyle: `${job.fenceStyle || \"PVC Fence\"} - ${job.fenceHeight ? parseFloat(job.fenceHeight) / 1000 : 1.8}m height, ${job.totalLength || \"N/A\"}m length`,\n    scheduledTime: getScheduledTime(job.id),\n    status: getJobStatus(job),\n    materials: [\n      \"PVC Posts\",\n      \"PVC Rails\",\n      \"PVC Pickets\",\n      \"Post Caps\",\n      \"Hardware Kit\",\n    ],\n    notes: job.notes || undefined,\n  }));\n\n  const handleCheckIn = (job: DisplayInstallerJob) => {\n    const originalJob = jobs.find(j => j.id === job.id);\n    if (originalJob) {\n      updateJobMutation.mutate(\n        { jobId: job.id, data: { status: \"install_posts\", actualStartDate: new Date() } },\n        {\n          onSuccess: () => {\n            toast({\n              title: \"Checked In\",\n              description: `Arrived at ${job.address}`,\n            });\n          },\n        }\n      );\n    }\n  };\n\n  const handleOpenMaps = (address: string) => {\n    window.open(`https://maps.google.com/?q=${encodeURIComponent(address)}`, \"_blank\");\n  };\n\n  const handleUploadPhoto = (type: \"before\" | \"after\" | \"progress\") => {\n    toast({\n      title: \"Upload Photo\",\n      description: `Uploading ${type} photo...`,\n    });\n  };\n\n  const handleSubmitVariation = () => {\n    if (variationNotes.trim() && selectedJob) {\n      const originalJob = jobs.find(j => j.id === selectedJob.id);\n      if (originalJob) {\n        updateJobMutation.mutate(\n          { jobId: selectedJob.id, data: { variationNotes: variationNotes } },\n          {\n            onSuccess: () => {\n              toast({\n                title: \"Variation Submitted\",\n                description: \"Admin will be notified for approval\",\n              });\n              setVariationNotes(\"\");\n            },\n          }\n        );\n      }\n    }\n  };\n\n  const handleMarkComplete = (job: DisplayInstallerJob) => {\n    updateJobMutation.mutate(\n      { jobId: job.id, data: { status: \"install_complete\", completionDate: new Date() } },\n      {\n        onSuccess: () => {\n          toast({\n            title: \"Job Completed\",\n            description: `${job.jobNumber} marked as complete`,\n          });\n          setSelectedJob(null);\n        },\n      }\n    );\n  };\n\n  if (jobsLoading) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <div className=\"p-4 border-b bg-primary text-primary-foreground\">\n          <Skeleton className=\"h-6 w-32 bg-primary-foreground/20\" />\n          <Skeleton className=\"h-4 w-48 mt-1 bg-primary-foreground/20\" />\n        </div>\n        <div className=\"p-4 space-y-4\">\n          <Skeleton className=\"h-10 w-full\" />\n          {[...Array(2)].map((_, i) => (\n            <Skeleton key={i} className=\"h-48\" />\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"p-4 border-b bg-primary text-primary-foreground\">\n        <h1 className=\"text-xl font-semibold\" data-testid=\"text-installer-title\">Installer App</h1>\n        <p className=\"text-sm opacity-80\">Today's Schedule</p>\n      </div>\n\n      <div className=\"p-4\">\n        <Tabs defaultValue=\"today\">\n          <TabsList className=\"w-full\">\n            <TabsTrigger value=\"today\" className=\"flex-1\" data-testid=\"tab-today\">Today</TabsTrigger>\n            <TabsTrigger value=\"upcoming\" className=\"flex-1\" data-testid=\"tab-upcoming\">Upcoming</TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"today\" className=\"mt-4 space-y-4\">\n            {displayJobs.length === 0 ? (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <Clock className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n                <p className=\"text-sm\">No install jobs scheduled</p>\n              </div>\n            ) : (\n              displayJobs.filter(j => j.status !== \"complete\").map((job) => (\n                <Card\n                  key={job.id}\n                  className={`cursor-pointer ${selectedJob?.id === job.id ? \"ring-2 ring-accent\" : \"\"}`}\n                  onClick={() => setSelectedJob(job)}\n                  data-testid={`installer-job-${job.id}`}\n                >\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-start justify-between mb-3\">\n                      <div>\n                        <div className=\"flex items-center gap-2 mb-1\">\n                          <span className=\"font-mono text-xs text-muted-foreground\">{job.jobNumber}</span>\n                          <StatusBadge status={job.status === \"in_progress\" ? \"in_progress\" : \"scheduled\"} />\n                        </div>\n                        <h3 className=\"font-semibold\">{job.clientName}</h3>\n                        <p className=\"text-sm text-muted-foreground\">{job.fenceStyle}</p>\n                      </div>\n                      <div className=\"text-right\">\n                        <div className=\"flex items-center gap-1 text-sm font-medium\">\n                          <Clock className=\"h-4 w-4\" />\n                          {job.scheduledTime}\n                        </div>\n                      </div>\n                    </div>\n\n                    <div className=\"flex items-center gap-2 text-sm text-muted-foreground mb-3\">\n                      <MapPin className=\"h-4 w-4\" />\n                      <span className=\"truncate\">{job.address}</span>\n                    </div>\n\n                    <div className=\"flex gap-2\">\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        className=\"flex-1\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          handleOpenMaps(job.address);\n                        }}\n                        data-testid={`button-navigate-${job.id}`}\n                      >\n                        <Navigation className=\"h-4 w-4 mr-2\" />\n                        Navigate\n                      </Button>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        className=\"flex-1\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          window.location.href = `tel:${job.clientPhone}`;\n                        }}\n                        data-testid={`button-call-${job.id}`}\n                      >\n                        <Phone className=\"h-4 w-4 mr-2\" />\n                        Call\n                      </Button>\n                      {job.status === \"upcoming\" && (\n                        <Button\n                          size=\"sm\"\n                          className=\"flex-1\"\n                          onClick={(e) => {\n                            e.stopPropagation();\n                            handleCheckIn(job);\n                          }}\n                          data-testid={`button-checkin-${job.id}`}\n                        >\n                          <CheckCircle className=\"h-4 w-4 mr-2\" />\n                          Check In\n                        </Button>\n                      )}\n                    </div>\n                  </CardContent>\n                </Card>\n              ))\n            )}\n          </TabsContent>\n\n          <TabsContent value=\"upcoming\" className=\"mt-4\">\n            {displayJobs.filter(j => j.status === \"upcoming\").length === 0 ? (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <Clock className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n                <p className=\"text-sm\">No upcoming jobs scheduled</p>\n              </div>\n            ) : (\n              displayJobs.filter(j => j.status === \"upcoming\").map((job) => (\n                <Card key={job.id} className=\"mb-4\" data-testid={`upcoming-job-${job.id}`}>\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <span className=\"font-mono text-xs text-muted-foreground\">{job.jobNumber}</span>\n                        <h3 className=\"font-semibold\">{job.clientName}</h3>\n                        <p className=\"text-sm text-muted-foreground truncate\">{job.address}</p>\n                      </div>\n                      <Badge variant=\"secondary\">{job.scheduledTime}</Badge>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))\n            )}\n          </TabsContent>\n        </Tabs>\n      </div>\n\n      {selectedJob && (\n        <div className=\"fixed inset-x-0 bottom-0 bg-background border-t max-h-[60vh] overflow-auto\">\n          <div className=\"p-4 space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <h2 className=\"font-semibold\">{selectedJob.jobNumber}</h2>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => setSelectedJob(null)}\n              >\n                Close\n              </Button>\n            </div>\n\n            <Tabs defaultValue=\"details\">\n              <TabsList className=\"w-full\">\n                <TabsTrigger value=\"details\" className=\"flex-1\">Details</TabsTrigger>\n                <TabsTrigger value=\"materials\" className=\"flex-1\">Materials</TabsTrigger>\n                <TabsTrigger value=\"photos\" className=\"flex-1\">Photos</TabsTrigger>\n                <TabsTrigger value=\"variation\" className=\"flex-1\">Variation</TabsTrigger>\n              </TabsList>\n\n              <TabsContent value=\"details\" className=\"mt-4 space-y-4\">\n                <div>\n                  <h4 className=\"text-sm font-medium mb-2\">Client</h4>\n                  <p className=\"text-sm\">{selectedJob.clientName}</p>\n                  <p className=\"text-sm text-muted-foreground\">{selectedJob.clientPhone}</p>\n                </div>\n                <div>\n                  <h4 className=\"text-sm font-medium mb-2\">Address</h4>\n                  <p className=\"text-sm\">{selectedJob.address}</p>\n                </div>\n                <div>\n                  <h4 className=\"text-sm font-medium mb-2\">Fence Style</h4>\n                  <p className=\"text-sm\">{selectedJob.fenceStyle}</p>\n                </div>\n                {selectedJob.notes && (\n                  <div>\n                    <h4 className=\"text-sm font-medium mb-2\">Notes</h4>\n                    <p className=\"text-sm text-muted-foreground\">{selectedJob.notes}</p>\n                  </div>\n                )}\n                <Button\n                  className=\"w-full\"\n                  onClick={() => handleMarkComplete(selectedJob)}\n                  disabled={updateJobMutation.isPending}\n                  data-testid=\"button-mark-complete\"\n                >\n                  <CheckCircle className=\"h-4 w-4 mr-2\" />\n                  {updateJobMutation.isPending ? \"Updating...\" : \"Mark Job Complete\"}\n                </Button>\n              </TabsContent>\n\n              <TabsContent value=\"materials\" className=\"mt-4\">\n                <div className=\"space-y-2\">\n                  {selectedJob.materials.map((material, idx) => (\n                    <div\n                      key={idx}\n                      className=\"flex items-center gap-3 p-3 bg-muted rounded-md\"\n                    >\n                      <Package className=\"h-4 w-4 text-muted-foreground\" />\n                      <span className=\"text-sm\">{material}</span>\n                    </div>\n                  ))}\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"photos\" className=\"mt-4 space-y-4\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <Button\n                    variant=\"outline\"\n                    className=\"h-24 flex-col gap-2\"\n                    onClick={() => handleUploadPhoto(\"before\")}\n                    data-testid=\"button-photo-before\"\n                  >\n                    <Camera className=\"h-6 w-6\" />\n                    <span className=\"text-xs\">Before Photo</span>\n                  </Button>\n                  <Button\n                    variant=\"outline\"\n                    className=\"h-24 flex-col gap-2\"\n                    onClick={() => handleUploadPhoto(\"progress\")}\n                    data-testid=\"button-photo-progress\"\n                  >\n                    <Camera className=\"h-6 w-6\" />\n                    <span className=\"text-xs\">Progress Photo</span>\n                  </Button>\n                  <Button\n                    variant=\"outline\"\n                    className=\"h-24 flex-col gap-2 col-span-2\"\n                    onClick={() => handleUploadPhoto(\"after\")}\n                    data-testid=\"button-photo-after\"\n                  >\n                    <Camera className=\"h-6 w-6\" />\n                    <span className=\"text-xs\">After Photo</span>\n                  </Button>\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"variation\" className=\"mt-4 space-y-4\">\n                <div className=\"flex items-start gap-2 p-3 bg-warning/10 rounded-md\">\n                  <AlertTriangle className=\"h-4 w-4 text-warning mt-0.5\" />\n                  <p className=\"text-sm text-warning\">\n                    Variations require admin approval before proceeding\n                  </p>\n                </div>\n                <Textarea\n                  placeholder=\"Describe the variation needed...\"\n                  value={variationNotes}\n                  onChange={(e) => setVariationNotes(e.target.value)}\n                  data-testid=\"textarea-variation\"\n                />\n                <Button\n                  className=\"w-full\"\n                  onClick={handleSubmitVariation}\n                  disabled={!variationNotes.trim() || updateJobMutation.isPending}\n                  data-testid=\"button-submit-variation\"\n                >\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  {updateJobMutation.isPending ? \"Submitting...\" : \"Submit Variation\"}\n                </Button>\n              </TabsContent>\n            </Tabs>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":17600,"size_tokens":null},"client/src/pages/Dashboard.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { StatCard } from \"@/components/shared/StatCard\";\nimport { PriorityList } from \"@/components/dashboard/PriorityList\";\nimport { ScheduleSnapshot } from \"@/components/dashboard/ScheduleSnapshot\";\nimport { ProductionOverview } from \"@/components/dashboard/ProductionOverview\";\nimport { AlertsPanel } from \"@/components/dashboard/AlertsPanel\";\nimport { LeadDetailDialog } from \"@/components/leads/LeadDetailDialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Users, FileText, Briefcase, DollarSign, Plus, RefreshCw } from \"lucide-react\";\nimport type { Lead, Quote, Job, ScheduleEvent, ProductionTask, Product, Payment, KanbanColumn, JobStatus, ProductionStage, Client, User as UserType } from \"@shared/schema\";\n\nexport default function Dashboard() {\n  const [, setLocation] = useLocation();\n  const [selectedLead, setSelectedLead] = useState<Lead | null>(null);\n  const [selectedLeadClient, setSelectedLeadClient] = useState<Client | null>(null);\n  const [leadDialogOpen, setLeadDialogOpen] = useState(false);\n\n  const { data: dashboardStats, isLoading: statsLoading, refetch: refetchStats } = useQuery<{\n    newLeadsCount: number;\n    quotesAwaitingFollowUp: number;\n    jobsInProduction: number;\n    jobsReadyForInstall: number;\n    todayInstalls: number;\n    pendingPaymentsTotal: number;\n  }>({\n    queryKey: [\"/api/dashboard/stats\"],\n  });\n\n  const { data: leads = [], isLoading: leadsLoading } = useQuery<Lead[]>({\n    queryKey: [\"/api/leads\"],\n  });\n\n  const { data: quotes = [], isLoading: quotesLoading } = useQuery<Quote[]>({\n    queryKey: [\"/api/quotes\"],\n  });\n\n  const { data: jobs = [], isLoading: jobsLoading } = useQuery<Job[]>({\n    queryKey: [\"/api/jobs\"],\n  });\n\n  const { data: scheduleEvents = [] } = useQuery<ScheduleEvent[]>({\n    queryKey: [\"/api/schedule\"],\n  });\n\n  const { data: productionTasks = [] } = useQuery<ProductionTask[]>({\n    queryKey: [\"/api/production-tasks\"],\n  });\n\n  const { data: lowStockProducts = [] } = useQuery<Product[]>({\n    queryKey: [\"/api/products?lowStock=true\"],\n  });\n\n  const { data: pendingPayments = [] } = useQuery<Payment[]>({\n    queryKey: [\"/api/payments?pending=true\"],\n  });\n\n  const { data: kanbanColumns = [] } = useQuery<KanbanColumn[]>({\n    queryKey: [\"/api/kanban-columns\"],\n  });\n\n  const { data: jobStatuses = [] } = useQuery<JobStatus[]>({\n    queryKey: [\"/api/job-statuses\"],\n  });\n\n  const { data: configuredStages = [] } = useQuery<ProductionStage[]>({\n    queryKey: [\"/api/production-stages\"],\n  });\n\n  const { data: clients = [] } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const { data: users = [] } = useQuery<UserType[]>({\n    queryKey: [\"/api/users\"],\n  });\n\n  const handleRefresh = () => {\n    refetchStats();\n  };\n\n  const newLeads = leads.filter(l => l.stage === \"new\");\n  const quotesFollowUp = quotes.filter(q => q.status === \"sent\");\n  \n  const getClientName = (clientId: string | null | undefined) => {\n    if (!clientId) return \"Unknown Client\";\n    const client = clients.find(c => c.id === clientId);\n    return client?.name || \"Unknown Client\";\n  };\n\n  const priorityLeads = newLeads.slice(0, 5).map((lead) => ({\n    id: lead.id,\n    title: `${lead.leadNumber} - ${getClientName(lead.clientId)}`,\n    subtitle: `${lead.fenceStyle || \"Unknown style\"} - ${lead.fenceLength || \"?\"}m`,\n    status: lead.stage as \"new\" | \"contacted\" | \"quoted\" | \"overdue\",\n    timeAgo: formatTimeAgo(lead.createdAt),\n    urgent: lead.stage === \"new\",\n  }));\n\n  const quotesFollowUpItems = quotesFollowUp.slice(0, 5).map((quote) => ({\n    id: quote.id,\n    title: `${quote.quoteNumber} - ${getClientName(quote.clientId)}`,\n    subtitle: `Quote sent - $${parseFloat(quote.totalAmount).toLocaleString()}`,\n    status: \"quoted\" as const,\n    timeAgo: quote.sentAt ? formatTimeAgo(quote.sentAt) : \"\",\n  }));\n\n  const today = new Date();\n  const todayStart = new Date(today.setHours(0, 0, 0, 0));\n  const todayEnd = new Date(today.setHours(23, 59, 59, 999));\n  \n  const todayEvents = scheduleEvents\n    .filter(e => {\n      const eventDate = new Date(e.startDate);\n      return eventDate >= todayStart && eventDate <= todayEnd;\n    })\n    .slice(0, 5)\n    .map((event) => ({\n      id: event.id,\n      jobNumber: event.jobId ? `JOB-${event.jobId.slice(0, 8)}` : \"\",\n      clientName: event.title,\n      address: event.description || \"\",\n      installer: { \n        name: event.assignedTo ? \"Installer\" : \"Unassigned\", \n        initials: event.assignedTo ? \"IN\" : \"UA\" \n      },\n      time: new Date(event.startDate).toLocaleTimeString(\"en-AU\", { \n        hour: \"2-digit\", \n        minute: \"2-digit\",\n        hour12: false \n      }),\n      type: event.eventType as \"install\" | \"delivery\" | \"measure\" | \"pickup\",\n    }));\n\n  const productionColumn = kanbanColumns.find(c => c.title.toLowerCase().includes(\"production\"));\n  const productionStatusKeys = productionColumn?.statuses || [];\n  \n  const productionStages = configuredStages.map((stage) => {\n    const jobsInStage = jobs.filter(j => j.status === stage.key);\n    const totalProductionJobs = jobs.filter(j => \n      configuredStages.some(s => s.key === j.status)\n    ).length;\n    const progress = totalProductionJobs > 0 ? Math.round((jobsInStage.length / totalProductionJobs) * 100) : 0;\n    \n    return {\n      statusKey: stage.key,\n      label: stage.label,\n      jobCount: jobsInStage.length,\n      progress,\n    };\n  });\n\n  const [alerts, setAlerts] = useState<Array<{\n    id: string;\n    type: \"stock\" | \"overdue\" | \"payment\" | \"general\";\n    title: string;\n    message: string;\n    actionLabel?: string;\n    onAction?: () => void;\n  }>>([]);\n\n  const dynamicAlerts = [\n    ...lowStockProducts.slice(0, 2).map((product, i) => ({\n      id: `stock-${product.id}`,\n      type: \"stock\" as const,\n      title: \"Low Stock Alert\",\n      message: `${product.name} - Only ${product.stockOnHand} remaining`,\n      actionLabel: \"View Inventory\",\n      onAction: () => setLocation(\"/inventory\"),\n    })),\n    ...pendingPayments.slice(0, 2).map((payment) => ({\n      id: `payment-${payment.id}`,\n      type: \"payment\" as const,\n      title: \"Payment Pending\",\n      message: `${payment.invoiceNumber || \"Invoice\"} - $${parseFloat(payment.amount).toLocaleString()} awaiting payment`,\n      actionLabel: \"View Payment\",\n      onAction: () => setLocation(\"/payments\"),\n    })),\n  ];\n\n  const handleDismissAlert = (id: string) => {\n    setAlerts(prev => prev.filter((a) => a.id !== id));\n  };\n\n  const todayFormatted = new Date().toLocaleDateString(\"en-AU\", {\n    weekday: \"long\",\n    day: \"numeric\",\n    month: \"long\",\n    year: \"numeric\",\n  });\n\n  const isLoading = statsLoading || leadsLoading || quotesLoading || jobsLoading;\n\n  const stats = {\n    newLeads: dashboardStats?.newLeadsCount || newLeads.length,\n    activeQuotes: dashboardStats?.quotesAwaitingFollowUp || quotesFollowUp.length,\n    jobsInProgress: dashboardStats?.jobsInProduction || jobs.filter(j => \n      [\"manufacturing_posts\", \"manufacturing_panels\", \"manufacturing_gates\", \"qa_check\"].includes(j.status)\n    ).length,\n    pendingPayments: dashboardStats?.pendingPaymentsTotal || 0,\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-semibold\" data-testid=\"text-dashboard-title\">Dashboard</h1>\n          <p className=\"text-sm text-muted-foreground\">{todayFormatted}</p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Button variant=\"outline\" size=\"sm\" onClick={handleRefresh} data-testid=\"button-refresh\">\n            <RefreshCw className=\"h-4 w-4 mr-2\" />\n            Refresh\n          </Button>\n          <Button size=\"sm\" onClick={() => setLocation(\"/leads\")} data-testid=\"button-new-lead\">\n            <Plus className=\"h-4 w-4 mr-2\" />\n            New Lead\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        {isLoading ? (\n          <>\n            <Skeleton className=\"h-32\" />\n            <Skeleton className=\"h-32\" />\n            <Skeleton className=\"h-32\" />\n            <Skeleton className=\"h-32\" />\n          </>\n        ) : (\n          <>\n            <StatCard\n              title=\"New Leads\"\n              value={stats.newLeads}\n              description=\"Awaiting contact\"\n              icon={Users}\n            />\n            <StatCard\n              title=\"Active Quotes\"\n              value={stats.activeQuotes}\n              description=\"Pending response\"\n              icon={FileText}\n            />\n            <StatCard\n              title=\"Jobs in Progress\"\n              value={stats.jobsInProgress}\n              description=\"In production\"\n              icon={Briefcase}\n            />\n            <StatCard\n              title=\"Pending Payments\"\n              value={`$${stats.pendingPayments.toLocaleString()}`}\n              description=\"Awaiting payment\"\n              icon={DollarSign}\n            />\n          </>\n        )}\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        <div className=\"lg:col-span-2 space-y-6\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n            <PriorityList\n              title=\"New Leads\"\n              items={priorityLeads}\n              onItemClick={(item) => {\n                const lead = leads.find(l => l.id === item.id);\n                if (lead) {\n                  const client = clients.find(c => c.id === lead.clientId);\n                  setSelectedLead(lead);\n                  setSelectedLeadClient(client || null);\n                  setLeadDialogOpen(true);\n                }\n              }}\n              onViewAll={() => setLocation(\"/leads\")}\n              emptyMessage=\"No new leads\"\n            />\n            <PriorityList\n              title=\"Quotes Awaiting Follow-Up\"\n              items={quotesFollowUpItems}\n              onItemClick={(item) => {\n                const quote = quotes.find(q => q.id === item.id);\n                if (quote && quote.leadId) {\n                  const lead = leads.find(l => l.id === quote.leadId);\n                  if (lead) {\n                    const client = clients.find(c => c.id === lead.clientId);\n                    setSelectedLead(lead);\n                    setSelectedLeadClient(client || null);\n                    setLeadDialogOpen(true);\n                  }\n                }\n              }}\n              onViewAll={() => setLocation(\"/leads\")}\n              emptyMessage=\"All quotes followed up\"\n            />\n          </div>\n          <ScheduleSnapshot\n            date={todayFormatted}\n            items={todayEvents}\n            onItemClick={() => setLocation(\"/schedule\")}\n            onViewSchedule={() => setLocation(\"/schedule\")}\n          />\n        </div>\n        <div className=\"space-y-6\">\n          <ProductionOverview\n            stages={productionStages}\n            totalActiveJobs={jobs.filter(j => configuredStages.some(s => s.key === j.status)).length}\n            onViewProduction={() => setLocation(\"/production\")}\n          />\n          <AlertsPanel \n            alerts={dynamicAlerts.length > 0 ? dynamicAlerts : alerts} \n            onDismiss={handleDismissAlert} \n          />\n        </div>\n      </div>\n\n      <LeadDetailDialog\n        open={leadDialogOpen}\n        onOpenChange={setLeadDialogOpen}\n        lead={selectedLead}\n        client={selectedLeadClient}\n        quotes={quotes.filter(q => q.leadId === selectedLead?.id)}\n        users={users}\n        onEditLead={() => {\n          setLeadDialogOpen(false);\n          if (selectedLead) {\n            setLocation(`/leads?edit=${selectedLead.id}`);\n          }\n        }}\n        onCreateQuote={() => {\n          setLeadDialogOpen(false);\n          if (selectedLead) {\n            setLocation(`/leads?newQuote=${selectedLead.id}`);\n          }\n        }}\n        onViewQuote={(quote) => {\n          setLeadDialogOpen(false);\n          setLocation(`/leads?quote=${quote.id}`);\n        }}\n      />\n    </div>\n  );\n}\n\nfunction formatTimeAgo(date: Date | string): string {\n  const now = new Date();\n  const then = new Date(date);\n  const diffMs = now.getTime() - then.getTime();\n  const diffMins = Math.floor(diffMs / 60000);\n  const diffHours = Math.floor(diffMs / 3600000);\n  const diffDays = Math.floor(diffMs / 86400000);\n\n  if (diffMins < 60) return `${diffMins}m ago`;\n  if (diffHours < 24) return `${diffHours}h ago`;\n  return `${diffDays}d ago`;\n}\n\nfunction calculateProgress(tasks: ProductionTask[], taskType: string): number {\n  const typeTasks = tasks.filter(t => t.taskType === taskType);\n  if (typeTasks.length === 0) return 0;\n  const completed = typeTasks.filter(t => t.status === \"completed\").length;\n  return Math.round((completed / typeTasks.length) * 100);\n}\n","path":null,"size_bytes":12971,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","path":null,"size_bytes":1904,"size_tokens":null},"client/src/pages/Payments.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { StatCard } from \"@/components/shared/StatCard\";\nimport { DataTable, Column, Action } from \"@/components/shared/DataTable\";\nimport { StatusBadge } from \"@/components/shared/StatusBadge\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Search, Download, CreditCard, Clock, CheckCircle, AlertTriangle } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Payment, Client, Job } from \"@shared/schema\";\n\ninterface DisplayPayment {\n  id: string;\n  invoiceNumber: string;\n  jobNumber: string;\n  clientName: string;\n  amount: number;\n  type: \"deposit\" | \"final\" | \"refund\" | \"credit_note\" | \"adjustment\";\n  status: \"pending\" | \"paid\" | \"overdue\";\n  dueDate: string;\n  paidDate?: string;\n}\n\nexport default function Payments() {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  const { data: payments = [], isLoading: paymentsLoading } = useQuery<Payment[]>({\n    queryKey: [\"/api/payments\"],\n  });\n\n  const { data: clients = [] } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const { data: jobs = [] } = useQuery<Job[]>({\n    queryKey: [\"/api/jobs\"],\n  });\n\n  const getClientName = (clientId: string) => {\n    const client = clients.find(c => c.id === clientId);\n    return client?.name || \"Unknown Client\";\n  };\n\n  const getJobNumber = (jobId: string | null) => {\n    if (!jobId) return \"N/A\";\n    const job = jobs.find(j => j.id === jobId);\n    return job?.jobNumber || \"N/A\";\n  };\n\n  const displayPayments: DisplayPayment[] = payments.map((payment) => {\n    let status: \"pending\" | \"paid\" | \"overdue\" = \"pending\";\n    if (payment.status === \"paid\" || payment.paidAt) {\n      status = \"paid\";\n    } else if (payment.status === \"overdue\") {\n      status = \"overdue\";\n    }\n\n    return {\n      id: payment.id,\n      invoiceNumber: payment.invoiceNumber || `INV-${payment.id.slice(0, 8).toUpperCase()}`,\n      jobNumber: getJobNumber(payment.jobId),\n      clientName: getClientName(payment.clientId),\n      amount: parseFloat(payment.amount) || 0,\n      type: payment.paymentType as DisplayPayment[\"type\"],\n      status,\n      dueDate: new Date(payment.createdAt).toLocaleDateString(\"en-AU\", { day: \"numeric\", month: \"short\", year: \"numeric\" }),\n      paidDate: payment.paidAt ? new Date(payment.paidAt).toLocaleDateString(\"en-AU\", { day: \"numeric\", month: \"short\", year: \"numeric\" }) : undefined,\n    };\n  });\n\n  const totalReceived = displayPayments.filter(p => p.status === \"paid\").reduce((acc, p) => acc + p.amount, 0);\n  const totalPending = displayPayments.filter(p => p.status === \"pending\").reduce((acc, p) => acc + p.amount, 0);\n  const totalOverdue = displayPayments.filter(p => p.status === \"overdue\").reduce((acc, p) => acc + p.amount, 0);\n  const pendingCount = displayPayments.filter(p => p.status === \"pending\").length;\n\n  const filteredPayments = displayPayments.filter(\n    (payment) =>\n      payment.invoiceNumber.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      payment.clientName.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      payment.jobNumber.toLowerCase().includes(searchQuery.toLowerCase())\n  );\n\n  const columns: Column<DisplayPayment>[] = [\n    {\n      key: \"invoiceNumber\",\n      header: \"Invoice\",\n      sortable: true,\n      render: (payment) => (\n        <span className=\"font-mono text-sm\">{payment.invoiceNumber}</span>\n      ),\n    },\n    {\n      key: \"jobNumber\",\n      header: \"Job\",\n      render: (payment) => (\n        <span className=\"font-mono text-xs text-muted-foreground\">{payment.jobNumber}</span>\n      ),\n    },\n    {\n      key: \"clientName\",\n      header: \"Client\",\n      sortable: true,\n    },\n    {\n      key: \"type\",\n      header: \"Type\",\n      render: (payment) => (\n        <Badge variant=\"secondary\" className=\"text-[10px] uppercase\">\n          {payment.type}\n        </Badge>\n      ),\n    },\n    {\n      key: \"amount\",\n      header: \"Amount\",\n      sortable: true,\n      render: (payment) => (\n        <span className=\"font-semibold\">${payment.amount.toLocaleString()}</span>\n      ),\n    },\n    {\n      key: \"dueDate\",\n      header: \"Due Date\",\n      sortable: true,\n    },\n    {\n      key: \"status\",\n      header: \"Status\",\n      render: (payment) => <StatusBadge status={payment.status as \"pending\" | \"paid\" | \"overdue\"} />,\n    },\n  ];\n\n  const actions: Action<DisplayPayment>[] = [\n    {\n      label: \"View Invoice\",\n      onClick: (payment) => toast({ title: \"Viewing invoice\", description: payment.invoiceNumber }),\n    },\n    {\n      label: \"Record Payment\",\n      onClick: (payment) => toast({ title: \"Recording payment\", description: payment.invoiceNumber }),\n    },\n    {\n      label: \"Send Reminder\",\n      onClick: (payment) => toast({ title: \"Sending reminder\", description: `Reminder sent for ${payment.invoiceNumber}` }),\n    },\n  ];\n\n  if (paymentsLoading) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <Skeleton className=\"h-8 w-48\" />\n          <div className=\"flex gap-2\">\n            <Skeleton className=\"h-9 w-24\" />\n            <Skeleton className=\"h-9 w-32\" />\n          </div>\n        </div>\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n          {[...Array(4)].map((_, i) => (\n            <Skeleton key={i} className=\"h-24\" />\n          ))}\n        </div>\n        <Skeleton className=\"h-96\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-semibold\" data-testid=\"text-payments-title\">Finance & Payments</h1>\n          <p className=\"text-sm text-muted-foreground\">\n            Track deposits, finals, and payment status\n          </p>\n        </div>\n        <div className=\"flex gap-2\">\n          <Button \n            variant=\"outline\" \n            data-testid=\"button-export\"\n            onClick={() => window.open(\"/api/export/payments\", \"_blank\")}\n          >\n            <Download className=\"h-4 w-4 mr-2\" />\n            Export\n          </Button>\n          <Button data-testid=\"button-record-payment\">\n            <CreditCard className=\"h-4 w-4 mr-2\" />\n            Record Payment\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <StatCard\n          title=\"Received (MTD)\"\n          value={`$${totalReceived.toLocaleString()}`}\n          description=\"This month\"\n          icon={CheckCircle}\n        />\n        <StatCard\n          title=\"Pending\"\n          value={`$${totalPending.toLocaleString()}`}\n          description={`${pendingCount} invoices`}\n          icon={Clock}\n        />\n        <StatCard\n          title=\"Overdue\"\n          value={`$${totalOverdue.toLocaleString()}`}\n          description=\"Needs attention\"\n          icon={AlertTriangle}\n        />\n        <StatCard\n          title=\"This Week\"\n          value={`$${(totalReceived * 0.3).toLocaleString()}`}\n          description=\"Payments received\"\n          icon={CreditCard}\n        />\n      </div>\n\n      <Card>\n        <CardHeader className=\"pb-4\">\n          <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n            <CardTitle className=\"text-base font-semibold\">Payment History</CardTitle>\n            <div className=\"relative w-64\">\n              <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search payments...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-9\"\n                data-testid=\"input-search-payments\"\n              />\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <Tabs defaultValue=\"all\">\n            <TabsList>\n              <TabsTrigger value=\"all\" data-testid=\"tab-all-payments\">All</TabsTrigger>\n              <TabsTrigger value=\"pending\" data-testid=\"tab-pending-payments\">Pending</TabsTrigger>\n              <TabsTrigger value=\"paid\" data-testid=\"tab-paid-payments\">Paid</TabsTrigger>\n              <TabsTrigger value=\"overdue\" data-testid=\"tab-overdue-payments\">Overdue</TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"all\" className=\"mt-4\">\n              <DataTable\n                data={filteredPayments}\n                columns={columns}\n                actions={actions}\n                onRowClick={(payment) => toast({ title: \"Payment selected\", description: payment.invoiceNumber })}\n                keyExtractor={(payment) => payment.id}\n              />\n            </TabsContent>\n\n            <TabsContent value=\"pending\" className=\"mt-4\">\n              <DataTable\n                data={filteredPayments.filter(p => p.status === \"pending\")}\n                columns={columns}\n                actions={actions}\n                onRowClick={(payment) => toast({ title: \"Payment selected\", description: payment.invoiceNumber })}\n                keyExtractor={(payment) => payment.id}\n              />\n            </TabsContent>\n\n            <TabsContent value=\"paid\" className=\"mt-4\">\n              <DataTable\n                data={filteredPayments.filter(p => p.status === \"paid\")}\n                columns={columns}\n                actions={actions}\n                onRowClick={(payment) => toast({ title: \"Payment selected\", description: payment.invoiceNumber })}\n                keyExtractor={(payment) => payment.id}\n              />\n            </TabsContent>\n\n            <TabsContent value=\"overdue\" className=\"mt-4\">\n              <DataTable\n                data={filteredPayments.filter(p => p.status === \"overdue\")}\n                columns={columns}\n                actions={actions}\n                onRowClick={(payment) => toast({ title: \"Payment selected\", description: payment.invoiceNumber })}\n                keyExtractor={(payment) => payment.id}\n              />\n            </TabsContent>\n          </Tabs>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":10553,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* LIGHT MODE - Probuild PVC Brand Colors */\n:root {\n  --button-outline: rgba(0,0,0, .10);\n  --badge-outline: rgba(0,0,0, .05);\n  --opaque-button-border-intensity: -8;\n  --elevate-1: rgba(0,0,0, .03);\n  --elevate-2: rgba(0,0,0, .08);\n  --background: 30 33% 96%;\n  --foreground: 186 33% 20%;\n  --border: 30 20% 88%;\n  --card: 30 40% 95%;\n  --card-foreground: 186 33% 20%;\n  --card-border: 30 25% 90%;\n  --sidebar: 186 33% 20%;\n  --sidebar-foreground: 30 33% 96%;\n  --sidebar-border: 186 33% 25%;\n  --sidebar-primary: 20 72% 50%;\n  --sidebar-primary-foreground: 0 0% 100%;\n  --sidebar-accent: 186 33% 28%;\n  --sidebar-accent-foreground: 30 33% 96%;\n  --sidebar-ring: 20 72% 50%;\n  --popover: 0 0% 100%;\n  --popover-foreground: 186 33% 20%;\n  --popover-border: 30 20% 88%;\n  --primary: 186 33% 20%;\n  --primary-foreground: 30 33% 96%;\n  --secondary: 30 25% 90%;\n  --secondary-foreground: 186 33% 20%;\n  --muted: 30 20% 92%;\n  --muted-foreground: 186 20% 45%;\n  --accent: 20 72% 50%;\n  --accent-foreground: 0 0% 100%;\n  --destructive: 0 72% 45%;\n  --destructive-foreground: 0 0% 100%;\n  --success: 142 50% 35%;\n  --success-foreground: 0 0% 100%;\n  --warning: 38 92% 50%;\n  --warning-foreground: 0 0% 100%;\n  --input: 30 20% 80%;\n  --ring: 186 33% 20%;\n  --chart-1: 186 33% 20%;\n  --chart-2: 20 72% 50%;\n  --chart-3: 142 50% 35%;\n  --chart-4: 38 92% 50%;\n  --chart-5: 0 72% 45%;\n  --font-sans: Inter, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: Roboto Mono, monospace;\n  --radius: .375rem;\n  --shadow-2xs: 0px 1px 2px 0px rgba(33, 61, 66, 0.05);\n  --shadow-xs: 0px 1px 3px 0px rgba(33, 61, 66, 0.08);\n  --shadow-sm: 0px 2px 4px -1px rgba(33, 61, 66, 0.08);\n  --shadow: 0px 4px 6px -2px rgba(33, 61, 66, 0.08);\n  --shadow-md: 0px 6px 10px -3px rgba(33, 61, 66, 0.10);\n  --shadow-lg: 0px 10px 15px -4px rgba(33, 61, 66, 0.12);\n  --shadow-xl: 0px 20px 25px -5px rgba(33, 61, 66, 0.15);\n  --shadow-2xl: 0px 25px 50px -12px rgba(33, 61, 66, 0.20);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n.dark {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n  --opaque-button-border-intensity: 9;\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n  --background: 186 30% 8%;\n  --foreground: 30 33% 96%;\n  --border: 186 25% 18%;\n  --card: 186 28% 12%;\n  --card-foreground: 30 33% 96%;\n  --card-border: 186 25% 16%;\n  --sidebar: 186 35% 10%;\n  --sidebar-foreground: 30 33% 96%;\n  --sidebar-border: 186 30% 15%;\n  --sidebar-primary: 20 72% 50%;\n  --sidebar-primary-foreground: 0 0% 100%;\n  --sidebar-accent: 186 30% 18%;\n  --sidebar-accent-foreground: 30 33% 96%;\n  --sidebar-ring: 20 72% 50%;\n  --popover: 186 28% 14%;\n  --popover-foreground: 30 33% 96%;\n  --popover-border: 186 25% 18%;\n  --primary: 30 33% 96%;\n  --primary-foreground: 186 33% 15%;\n  --secondary: 186 25% 18%;\n  --secondary-foreground: 30 33% 96%;\n  --muted: 186 20% 16%;\n  --muted-foreground: 30 15% 60%;\n  --accent: 20 72% 50%;\n  --accent-foreground: 0 0% 100%;\n  --destructive: 0 72% 50%;\n  --destructive-foreground: 0 0% 100%;\n  --success: 142 50% 45%;\n  --success-foreground: 0 0% 100%;\n  --warning: 38 92% 55%;\n  --warning-foreground: 0 0% 100%;\n  --input: 186 20% 28%;\n  --ring: 20 72% 50%;\n  --chart-1: 30 33% 85%;\n  --chart-2: 20 72% 55%;\n  --chart-3: 142 50% 50%;\n  --chart-4: 38 92% 55%;\n  --chart-5: 0 72% 55%;\n  --shadow-2xs: 0px 1px 2px 0px rgba(0, 0, 0, 0.15);\n  --shadow-xs: 0px 1px 3px 0px rgba(0, 0, 0, 0.20);\n  --shadow-sm: 0px 2px 4px -1px rgba(0, 0, 0, 0.22);\n  --shadow: 0px 4px 6px -2px rgba(0, 0, 0, 0.25);\n  --shadow-md: 0px 6px 10px -3px rgba(0, 0, 0, 0.28);\n  --shadow-lg: 0px 10px 15px -4px rgba(0, 0, 0, 0.32);\n  --shadow-xl: 0px 20px 25px -5px rgba(0, 0, 0, 0.38);\n  --shadow-2xl: 0px 25px 50px -12px rgba(0, 0, 0, 0.45);\n\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n\n/**\n * Using the elevate system.\n * Automatic contrast adjustment.\n *\n * <element className=\"hover-elevate\" />\n * <element className=\"active-elevate-2\" />\n *\n * // Using the tailwind utility when a data attribute is \"on\"\n * <element className=\"toggle-elevate data-[state=on]:toggle-elevated\" />\n * // Or manually controlling the toggle state\n * <element className=\"toggle-elevate toggle-elevated\" />\n *\n * Elevation systems have to handle many states.\n * - not-hovered, vs. hovered vs. active  (three mutually exclusive states)\n * - toggled or not\n * - focused or not (this is not handled with these utilities)\n *\n * Even without handling focused or not, this is six possible combinations that\n * need to be distinguished from eachother visually.\n */\n@layer utilities {\n\n  /* Hide ugly search cancel button in Chrome until we can style it properly */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable div */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  /* .no-default-hover-elevate/no-default-active-elevate is an escape hatch so consumers of\n   * buttons/badges can remove the automatic brightness adjustment on interactions\n   * and program their own. */\n  .no-default-hover-elevate {}\n\n  .no-default-active-elevate {}\n\n\n  /**\n   * Toggleable backgrounds go behind the content. Hoverable/active goes on top.\n   * This way they can stack/compound. Both will overlap the parent's borders!\n   * So borders will be automatically adjusted both on toggle, and hover/active,\n   * and they will be compounded.\n   */\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: -1;\n    /* sits behind content but above backdrop */\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  /* Does not work on elements with overflow:hidden! */\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: 999;\n    /* sits in front of content */\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after {\n    inset: -1px;\n  }\n}\n","path":null,"size_bytes":10073,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2154,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8605,"size_tokens":null},"client/src/components/layout/ThemeProvider.tsx":{"content":"import { createContext, useContext, useEffect, useState } from \"react\";\n\ntype Theme = \"dark\" | \"light\" | \"system\";\n\ntype ThemeProviderProps = {\n  children: React.ReactNode;\n  defaultTheme?: Theme;\n  storageKey?: string;\n};\n\ntype ThemeProviderState = {\n  theme: Theme;\n  setTheme: (theme: Theme) => void;\n};\n\nconst initialState: ThemeProviderState = {\n  theme: \"system\",\n  setTheme: () => null,\n};\n\nconst ThemeProviderContext = createContext<ThemeProviderState>(initialState);\n\nexport function ThemeProvider({\n  children,\n  defaultTheme = \"light\",\n  storageKey = \"probuild-ui-theme\",\n  ...props\n}: ThemeProviderProps) {\n  const [theme, setTheme] = useState<Theme>(\n    () => (localStorage.getItem(storageKey) as Theme) || defaultTheme\n  );\n\n  useEffect(() => {\n    const root = window.document.documentElement;\n    root.classList.remove(\"light\", \"dark\");\n\n    if (theme === \"system\") {\n      const systemTheme = window.matchMedia(\"(prefers-color-scheme: dark)\")\n        .matches\n        ? \"dark\"\n        : \"light\";\n      root.classList.add(systemTheme);\n      return;\n    }\n\n    root.classList.add(theme);\n  }, [theme]);\n\n  const value = {\n    theme,\n    setTheme: (theme: Theme) => {\n      localStorage.setItem(storageKey, theme);\n      setTheme(theme);\n    },\n  };\n\n  return (\n    <ThemeProviderContext.Provider {...props} value={value}>\n      {children}\n    </ThemeProviderContext.Provider>\n  );\n}\n\nexport const useTheme = () => {\n  const context = useContext(ThemeProviderContext);\n\n  if (context === undefined)\n    throw new Error(\"useTheme must be used within a ThemeProvider\");\n\n  return context;\n};\n","path":null,"size_bytes":1606,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":844,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route, useLocation, Redirect } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { SidebarProvider, SidebarInset } from \"@/components/ui/sidebar\";\nimport { ThemeProvider } from \"@/components/layout/ThemeProvider\";\nimport { AppSidebar } from \"@/components/layout/AppSidebar\";\nimport { Header } from \"@/components/layout/Header\";\nimport { NewMessageBanner } from \"@/components/layout/NewMessageBanner\";\nimport { AuthProvider, useAuth } from \"@/hooks/use-auth\";\nimport { Loader2, ShieldX } from \"lucide-react\";\nimport { type UserRole, hasRouteAccess, getDefaultRoute } from \"@/lib/permissions\";\n\nimport Login from \"@/pages/Login\";\nimport MyDashboard from \"@/pages/MyDashboard\";\nimport Dashboard from \"@/pages/Dashboard\";\nimport Leads from \"@/pages/Leads\";\nimport Quotes from \"@/pages/Quotes\";\nimport Jobs from \"@/pages/Jobs\";\nimport Clients from \"@/pages/Clients\";\nimport Production from \"@/pages/Production\";\nimport Schedule from \"@/pages/Schedule\";\nimport Inventory from \"@/pages/Inventory\";\nimport Payments from \"@/pages/Payments\";\nimport Messages from \"@/pages/Messages\";\nimport QuoteAnalytics from \"@/pages/QuoteAnalytics\";\nimport AutomationCampaigns from \"@/pages/AutomationCampaigns\";\nimport Installer from \"@/pages/Installer\";\nimport Trade from \"@/pages/Trade\";\nimport NotFound from \"@/pages/not-found\";\n\nimport OrganisationDepartments from \"@/pages/organisation/Departments\";\nimport OrganisationWorkflows from \"@/pages/organisation/Workflows\";\nimport OrganisationPolicies from \"@/pages/organisation/Policies\";\nimport OrganisationResources from \"@/pages/organisation/Resources\";\nimport OrganisationKnowledge from \"@/pages/organisation/Knowledge\";\nimport LiveDocTemplates from \"@/pages/LiveDocTemplates\";\nimport Import from \"@/pages/Import\";\nimport Unauthorized from \"@/pages/Unauthorized\";\nimport DashboardBuilder from \"@/pages/DashboardBuilder\";\nimport Financial from \"@/pages/Financial\";\nimport JobStageConfiguration from \"@/pages/JobStageConfiguration\";\nimport KanbanColumnSettings from \"@/pages/KanbanColumnSettings\";\nimport SalesChecklistConfig from \"@/pages/SalesChecklistConfig\";\nimport Calls from \"@/pages/Calls\";\nimport SubmitReceipt from \"@/pages/SubmitReceipt\";\nimport ExpenseCategoryConfig from \"@/pages/ExpenseCategoryConfig\";\nimport StaffManagement from \"@/pages/StaffManagement\";\nimport { CallWidget } from \"@/components/coaching/CallWidget\";\n\nfunction MainLayout({ children }: { children: React.ReactNode }) {\n  const style = {\n    \"--sidebar-width\": \"16rem\",\n    \"--sidebar-width-icon\": \"3rem\",\n  };\n\n  return (\n    <SidebarProvider style={style as React.CSSProperties}>\n      <div className=\"flex h-screen w-full\">\n        <AppSidebar />\n        <SidebarInset className=\"flex flex-col flex-1 overflow-hidden\">\n          <NewMessageBanner />\n          <Header />\n          <main className=\"flex-1 overflow-auto bg-background\">\n            {children}\n          </main>\n        </SidebarInset>\n      </div>\n      <CallWidget />\n    </SidebarProvider>\n  );\n}\n\nfunction InstallerLayout({ children }: { children: React.ReactNode }) {\n  return <div className=\"h-screen overflow-auto\">{children}</div>;\n}\n\nfunction TradeLayout({ children }: { children: React.ReactNode }) {\n  return <div className=\"h-screen overflow-auto\">{children}</div>;\n}\n\nfunction ProtectedRoute({ \n  children, \n  path \n}: { \n  children: React.ReactNode;\n  path: string;\n}) {\n  const { isAuthenticated, isLoading, user } = useAuth();\n  const userRole = user?.role as UserRole | undefined;\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-screen\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return <Redirect to=\"/login\" />;\n  }\n\n  if (!hasRouteAccess(userRole, path)) {\n    // Trade clients trying to access internal pages go to trade portal\n    if (userRole === \"trade_client\") {\n      return <Redirect to=\"/trade\" />;\n    }\n    // All other unauthorized access goes to unauthorized page\n    return <Redirect to=\"/unauthorized\" />;\n  }\n\n  return <>{children}</>;\n}\n\nfunction AuthenticatedRouter() {\n  return (\n    <Switch>\n      {/* Public route for receipt submission - no auth required */}\n      <Route path=\"/submit-receipt/:token\">\n        <SubmitReceipt />\n      </Route>\n      <Route path=\"/login\">\n        <LoginRedirect />\n      </Route>\n      <Route path=\"/\">\n        <ProtectedRoute path=\"/\">\n          <MainLayout>\n            <MyDashboard />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/business-dashboard\">\n        <ProtectedRoute path=\"/business-dashboard\">\n          <MainLayout>\n            <Dashboard />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/leads/:rest*\">\n        <ProtectedRoute path=\"/leads\">\n          <MainLayout>\n            <Leads />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/leads\">\n        <ProtectedRoute path=\"/leads\">\n          <MainLayout>\n            <Leads />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/quotes/:rest*\">\n        <ProtectedRoute path=\"/quotes\">\n          <MainLayout>\n            <Quotes />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/quotes\">\n        <ProtectedRoute path=\"/quotes\">\n          <MainLayout>\n            <Quotes />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/jobs/:rest*\">\n        <ProtectedRoute path=\"/jobs\">\n          <MainLayout>\n            <Jobs />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/jobs\">\n        <ProtectedRoute path=\"/jobs\">\n          <MainLayout>\n            <Jobs />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/clients/:rest*\">\n        <ProtectedRoute path=\"/clients\">\n          <MainLayout>\n            <Clients />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/clients\">\n        <ProtectedRoute path=\"/clients\">\n          <MainLayout>\n            <Clients />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/production/:rest*\">\n        <ProtectedRoute path=\"/production\">\n          <MainLayout>\n            <Production />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/production\">\n        <ProtectedRoute path=\"/production\">\n          <MainLayout>\n            <Production />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/schedule/:rest*\">\n        <ProtectedRoute path=\"/schedule\">\n          <MainLayout>\n            <Schedule />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/schedule\">\n        <ProtectedRoute path=\"/schedule\">\n          <MainLayout>\n            <Schedule />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/inventory/:rest*\">\n        <ProtectedRoute path=\"/inventory\">\n          <MainLayout>\n            <Inventory />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/inventory\">\n        <ProtectedRoute path=\"/inventory\">\n          <MainLayout>\n            <Inventory />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/financial/:rest*\">\n        <ProtectedRoute path=\"/financial\">\n          <MainLayout>\n            <Financial />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/financial\">\n        <ProtectedRoute path=\"/financial\">\n          <MainLayout>\n            <Financial />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/payments/:rest*\">\n        <ProtectedRoute path=\"/payments\">\n          <MainLayout>\n            <Payments />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/payments\">\n        <ProtectedRoute path=\"/payments\">\n          <MainLayout>\n            <Payments />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/messages/:rest*\">\n        <ProtectedRoute path=\"/messages\">\n          <MainLayout>\n            <Messages />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/messages\">\n        <ProtectedRoute path=\"/messages\">\n          <MainLayout>\n            <Messages />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/calls\">\n        <ProtectedRoute path=\"/calls\">\n          <MainLayout>\n            <Calls />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/quote-analytics\">\n        <ProtectedRoute path=\"/quote-analytics\">\n          <MainLayout>\n            <QuoteAnalytics />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/automation/:rest*\">\n        <ProtectedRoute path=\"/automation\">\n          <MainLayout>\n            <AutomationCampaigns />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/automation\">\n        <ProtectedRoute path=\"/automation\">\n          <MainLayout>\n            <AutomationCampaigns />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/installer/:rest*\">\n        <ProtectedRoute path=\"/installer\">\n          <InstallerLayout>\n            <Installer />\n          </InstallerLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/installer\">\n        <ProtectedRoute path=\"/installer\">\n          <InstallerLayout>\n            <Installer />\n          </InstallerLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/trade/:rest*\">\n        <ProtectedRoute path=\"/trade\">\n          <TradeLayout>\n            <Trade />\n          </TradeLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/trade\">\n        <ProtectedRoute path=\"/trade\">\n          <TradeLayout>\n            <Trade />\n          </TradeLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/organisation/departments\">\n        <ProtectedRoute path=\"/organisation/departments\">\n          <MainLayout>\n            <OrganisationDepartments />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/organisation/workflows/:rest*\">\n        <ProtectedRoute path=\"/organisation/workflows\">\n          <MainLayout>\n            <OrganisationWorkflows />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/organisation/workflows\">\n        <ProtectedRoute path=\"/organisation/workflows\">\n          <MainLayout>\n            <OrganisationWorkflows />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/organisation/policies/:rest*\">\n        <ProtectedRoute path=\"/organisation/policies\">\n          <MainLayout>\n            <OrganisationPolicies />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/organisation/policies\">\n        <ProtectedRoute path=\"/organisation/policies\">\n          <MainLayout>\n            <OrganisationPolicies />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/organisation/resources/:rest*\">\n        <ProtectedRoute path=\"/organisation/resources\">\n          <MainLayout>\n            <OrganisationResources />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/organisation/resources\">\n        <ProtectedRoute path=\"/organisation/resources\">\n          <MainLayout>\n            <OrganisationResources />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/organisation/knowledge/:rest*\">\n        <ProtectedRoute path=\"/organisation/knowledge\">\n          <MainLayout>\n            <OrganisationKnowledge />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/organisation/knowledge\">\n        <ProtectedRoute path=\"/organisation/knowledge\">\n          <MainLayout>\n            <OrganisationKnowledge />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/live-doc-templates/:rest*\">\n        <ProtectedRoute path=\"/live-doc-templates\">\n          <MainLayout>\n            <LiveDocTemplates />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/live-doc-templates\">\n        <ProtectedRoute path=\"/live-doc-templates\">\n          <MainLayout>\n            <LiveDocTemplates />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/import\">\n        <ProtectedRoute path=\"/import\">\n          <MainLayout>\n            <Import />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/dashboard-builder/:rest*\">\n        <ProtectedRoute path=\"/dashboard-builder\">\n          <MainLayout>\n            <DashboardBuilder />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/dashboard-builder\">\n        <ProtectedRoute path=\"/dashboard-builder\">\n          <MainLayout>\n            <DashboardBuilder />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/job-stage-configuration\">\n        <ProtectedRoute path=\"/job-stage-configuration\">\n          <MainLayout>\n            <JobStageConfiguration />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/kanban-column-settings\">\n        <ProtectedRoute path=\"/kanban-column-settings\">\n          <MainLayout>\n            <KanbanColumnSettings />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/sales-checklist-config\">\n        <ProtectedRoute path=\"/sales-checklist-config\">\n          <MainLayout>\n            <SalesChecklistConfig />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/expense-category-config\">\n        <ProtectedRoute path=\"/expense-category-config\">\n          <MainLayout>\n            <ExpenseCategoryConfig />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/staff-management\">\n        <ProtectedRoute path=\"/staff-management\">\n          <MainLayout>\n            <StaffManagement />\n          </MainLayout>\n        </ProtectedRoute>\n      </Route>\n      <Route path=\"/unauthorized\">\n        <ProtectedRoute path=\"/unauthorized\">\n          <Unauthorized />\n        </ProtectedRoute>\n      </Route>\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction LoginRedirect() {\n  const { isAuthenticated, isLoading, user } = useAuth();\n  const defaultRoute = getDefaultRoute(user?.role as UserRole | undefined);\n  \n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-screen\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n  \n  if (isAuthenticated) {\n    return <Redirect to={defaultRoute} />;\n  }\n  \n  return <Login />;\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <ThemeProvider defaultTheme=\"light\" storageKey=\"probuild-theme\">\n        <TooltipProvider>\n          <AuthProvider>\n            <Toaster />\n            <AuthenticatedRouter />\n          </AuthProvider>\n        </TooltipProvider>\n      </ThemeProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":15542,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7609,"size_tokens":null},"script/build.ts":{"content":"import { build as esbuild } from \"esbuild\";\nimport { build as viteBuild } from \"vite\";\nimport { rm, readFile } from \"fs/promises\";\n\n// server deps to bundle to reduce openat(2) syscalls\n// which helps cold start times\nconst allowlist = [\n  \"@google/generative-ai\",\n  \"@neondatabase/serverless\",\n  \"axios\",\n  \"connect-pg-simple\",\n  \"cors\",\n  \"date-fns\",\n  \"drizzle-orm\",\n  \"drizzle-zod\",\n  \"express\",\n  \"express-rate-limit\",\n  \"express-session\",\n  \"jsonwebtoken\",\n  \"memorystore\",\n  \"multer\",\n  \"nanoid\",\n  \"nodemailer\",\n  \"openai\",\n  \"passport\",\n  \"passport-local\",\n  \"stripe\",\n  \"uuid\",\n  \"ws\",\n  \"xlsx\",\n  \"zod\",\n  \"zod-validation-error\",\n];\n\nasync function buildAll() {\n  await rm(\"dist\", { recursive: true, force: true });\n\n  console.log(\"building client...\");\n  await viteBuild();\n\n  console.log(\"building server...\");\n  const pkg = JSON.parse(await readFile(\"package.json\", \"utf-8\"));\n  const allDeps = [\n    ...Object.keys(pkg.dependencies || {}),\n    ...Object.keys(pkg.devDependencies || {}),\n  ];\n  const externals = allDeps.filter((dep) => !allowlist.includes(dep));\n\n  await esbuild({\n    entryPoints: [\"server/index.ts\"],\n    platform: \"node\",\n    bundle: true,\n    format: \"cjs\",\n    outfile: \"dist/index.cjs\",\n    define: {\n      \"process.env.NODE_ENV\": '\"production\"',\n    },\n    minify: true,\n    external: externals,\n    logLevel: \"info\",\n  });\n}\n\nbuildAll().catch((err) => {\n  console.error(err);\n  process.exit(1);\n});\n","path":null,"size_bytes":1439,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1527,"size_tokens":null},"client/src/pages/Production.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { TaskQueue } from \"@/components/production/TaskQueue\";\nimport { StatCard } from \"@/components/shared/StatCard\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  Scissors,\n  Router,\n  Hammer,\n  CheckCircle,\n  Clock,\n  AlertTriangle,\n  Users,\n} from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { ProductionTask as DBProductionTask, Job } from \"@shared/schema\";\n\ntype TaskType = \"cutting\" | \"routing\" | \"assembly\" | \"qa\";\ntype TaskStatus = \"pending\" | \"in_progress\" | \"complete\";\n\ninterface DisplayTask {\n  id: string;\n  jobNumber: string;\n  clientName: string;\n  taskType: TaskType;\n  status: TaskStatus;\n  assignedTo?: string;\n  estimatedTime: number;\n  timeSpent: number;\n  materials: string[];\n}\n\nexport default function Production() {\n  const { toast } = useToast();\n\n  const { data: productionTasks = [], isLoading: tasksLoading } = useQuery<DBProductionTask[]>({\n    queryKey: [\"/api/production-tasks\"],\n  });\n\n  const { data: jobs = [] } = useQuery<Job[]>({\n    queryKey: [\"/api/jobs\"],\n  });\n\n  const updateTaskMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<DBProductionTask> }) => {\n      return apiRequest(\"PATCH\", `/api/production-tasks/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/production-tasks\"] });\n    },\n  });\n\n  const getJobInfo = (jobId: string | null) => {\n    if (!jobId) return { jobNumber: \"Unknown\", clientName: \"Unknown\" };\n    const job = jobs.find(j => j.id === jobId);\n    return {\n      jobNumber: job?.jobNumber || \"Unknown\",\n      clientName: `${job?.fenceStyle || \"Unknown\"} - ${job?.totalLength || \"?\"}m`,\n    };\n  };\n\n  const mapTaskStatus = (status: string): TaskStatus => {\n    if (status === \"completed\") return \"complete\";\n    if (status === \"in_progress\") return \"in_progress\";\n    return \"pending\";\n  };\n\n  const tasks: DisplayTask[] = productionTasks.map((task) => {\n    const jobInfo = getJobInfo(task.jobId);\n    return {\n      id: task.id,\n      jobNumber: jobInfo.jobNumber,\n      clientName: jobInfo.clientName,\n      taskType: task.taskType as TaskType,\n      status: mapTaskStatus(task.status),\n      assignedTo: task.assignedTo || undefined,\n      estimatedTime: 120,\n      timeSpent: task.timeSpentMinutes || 0,\n      materials: [],\n    };\n  });\n\n  const handleStartTask = (task: DisplayTask) => {\n    updateTaskMutation.mutate({\n      id: task.id,\n      data: { \n        status: \"in_progress\",\n        startTime: new Date(),\n      },\n    });\n    toast({\n      title: \"Task Started\",\n      description: `Started ${task.taskType} for ${task.jobNumber}`,\n    });\n  };\n\n  const handlePauseTask = (task: DisplayTask) => {\n    updateTaskMutation.mutate({\n      id: task.id,\n      data: { status: \"pending\" },\n    });\n    toast({\n      title: \"Task Paused\",\n      description: `Paused ${task.taskType} for ${task.jobNumber}`,\n    });\n  };\n\n  const handleCompleteTask = (task: DisplayTask) => {\n    updateTaskMutation.mutate({\n      id: task.id,\n      data: { \n        status: \"completed\",\n        endTime: new Date(),\n      },\n    });\n    toast({\n      title: \"Task Completed\",\n      description: `Completed ${task.taskType} for ${task.jobNumber}`,\n    });\n  };\n\n  const cuttingTasks = tasks.filter(t => t.taskType === \"cutting\");\n  const routingTasks = tasks.filter(t => t.taskType === \"routing\");\n  const assemblyTasks = tasks.filter(t => t.taskType === \"assembly\");\n  const qaTasks = tasks.filter(t => t.taskType === \"qa\");\n\n  const activeTasks = tasks.filter(t => t.status === \"in_progress\").length;\n  const pendingTasks = tasks.filter(t => t.status === \"pending\").length;\n  const completedToday = tasks.filter(t => t.status === \"complete\").length;\n  const totalTime = tasks.reduce((acc, t) => acc + t.timeSpent, 0);\n\n  if (tasksLoading) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <Skeleton className=\"h-10 w-64\" />\n        <div className=\"grid grid-cols-4 gap-4\">\n          <Skeleton className=\"h-32\" />\n          <Skeleton className=\"h-32\" />\n          <Skeleton className=\"h-32\" />\n          <Skeleton className=\"h-32\" />\n        </div>\n        <div className=\"grid grid-cols-4 gap-4\">\n          <Skeleton className=\"h-24\" />\n          <Skeleton className=\"h-24\" />\n          <Skeleton className=\"h-24\" />\n          <Skeleton className=\"h-24\" />\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-semibold\" data-testid=\"text-production-title\">Production Manager</h1>\n          <p className=\"text-sm text-muted-foreground\">\n            Track manufacturing tasks, time, and quality control\n          </p>\n        </div>\n        <div className=\"flex gap-2\">\n          <Button variant=\"outline\" data-testid=\"button-view-schedule\">View Schedule</Button>\n          <Button data-testid=\"button-allocate-staff\">\n            <Users className=\"h-4 w-4 mr-2\" />\n            Allocate Staff\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <StatCard\n          title=\"Active Tasks\"\n          value={activeTasks}\n          description=\"Currently in progress\"\n          icon={Clock}\n        />\n        <StatCard\n          title=\"Pending Tasks\"\n          value={pendingTasks}\n          description=\"Awaiting start\"\n          icon={AlertTriangle}\n        />\n        <StatCard\n          title=\"Completed Today\"\n          value={completedToday}\n          description=\"Tasks finished\"\n          icon={CheckCircle}\n        />\n        <StatCard\n          title=\"Time Logged\"\n          value={`${Math.floor(totalTime / 60)}h ${totalTime % 60}m`}\n          description=\"Today's production\"\n          icon={Clock}\n        />\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-4 gap-4\">\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n              <Scissors className=\"h-4 w-4 text-chart-1\" />\n              Cutting\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{cuttingTasks.length}</div>\n            <Progress value={cuttingTasks.length > 0 ? (cuttingTasks.filter(t => t.status === \"complete\").length / cuttingTasks.length * 100) : 0} className=\"h-1 mt-2\" />\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n              <Router className=\"h-4 w-4 text-chart-2\" />\n              Routing\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{routingTasks.length}</div>\n            <Progress value={routingTasks.length > 0 ? (routingTasks.filter(t => t.status === \"complete\").length / routingTasks.length * 100) : 0} className=\"h-1 mt-2\" />\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n              <Hammer className=\"h-4 w-4 text-chart-3\" />\n              Assembly\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{assemblyTasks.length}</div>\n            <Progress value={assemblyTasks.length > 0 ? (assemblyTasks.filter(t => t.status === \"complete\").length / assemblyTasks.length * 100) : 0} className=\"h-1 mt-2\" />\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n              <CheckCircle className=\"h-4 w-4 text-chart-4\" />\n              QA\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{qaTasks.length}</div>\n            <Progress value={qaTasks.length > 0 ? (qaTasks.filter(t => t.status === \"complete\").length / qaTasks.length * 100) : 0} className=\"h-1 mt-2\" />\n          </CardContent>\n        </Card>\n      </div>\n\n      <Tabs defaultValue=\"all\">\n        <TabsList>\n          <TabsTrigger value=\"all\" data-testid=\"tab-all-tasks\">All Tasks</TabsTrigger>\n          <TabsTrigger value=\"cutting\" data-testid=\"tab-cutting\">Cutting</TabsTrigger>\n          <TabsTrigger value=\"routing\" data-testid=\"tab-routing\">Routing</TabsTrigger>\n          <TabsTrigger value=\"assembly\" data-testid=\"tab-assembly\">Assembly</TabsTrigger>\n          <TabsTrigger value=\"qa\" data-testid=\"tab-qa\">QA</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"all\" className=\"mt-6\">\n          <TaskQueue\n            tasks={tasks}\n            onStartTask={handleStartTask}\n            onPauseTask={handlePauseTask}\n            onCompleteTask={handleCompleteTask}\n          />\n        </TabsContent>\n\n        <TabsContent value=\"cutting\" className=\"mt-6\">\n          <TaskQueue\n            tasks={cuttingTasks}\n            onStartTask={handleStartTask}\n            onPauseTask={handlePauseTask}\n            onCompleteTask={handleCompleteTask}\n          />\n        </TabsContent>\n\n        <TabsContent value=\"routing\" className=\"mt-6\">\n          <TaskQueue\n            tasks={routingTasks}\n            onStartTask={handleStartTask}\n            onPauseTask={handlePauseTask}\n            onCompleteTask={handleCompleteTask}\n          />\n        </TabsContent>\n\n        <TabsContent value=\"assembly\" className=\"mt-6\">\n          <TaskQueue\n            tasks={assemblyTasks}\n            onStartTask={handleStartTask}\n            onPauseTask={handlePauseTask}\n            onCompleteTask={handleCompleteTask}\n          />\n        </TabsContent>\n\n        <TabsContent value=\"qa\" className=\"mt-6\">\n          <TaskQueue\n            tasks={qaTasks}\n            onStartTask={handleStartTask}\n            onPauseTask={handlePauseTask}\n            onCompleteTask={handleCompleteTask}\n          />\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":10517,"size_tokens":null},"client/src/pages/Trade.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { StatusBadge } from \"@/components/shared/StatusBadge\";\nimport { StatCard } from \"@/components/shared/StatCard\";\nimport { Input } from \"@/components/ui/input\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  FileText,\n  Package,\n  CreditCard,\n  Download,\n  Search,\n  ShoppingCart,\n  Clock,\n  CheckCircle,\n  Truck,\n  HelpCircle,\n} from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Quote, Job, Client, Product } from \"@shared/schema\";\n\ninterface DisplayTradeQuote {\n  id: string;\n  quoteNumber: string;\n  description: string;\n  totalAmount: number;\n  status: \"pending\" | \"approved\" | \"declined\";\n  createdAt: string;\n  expiresAt: string;\n}\n\ninterface DisplayTradeOrder {\n  id: string;\n  orderNumber: string;\n  description: string;\n  totalAmount: number;\n  status: \"in_progress\" | \"production\" | \"ready\" | \"complete\";\n  estimatedReady: string;\n}\n\ninterface DisplayProduct {\n  id: string;\n  name: string;\n  description: string;\n  tradePrice: number;\n}\n\nexport default function Trade() {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  const { data: quotes = [], isLoading: quotesLoading } = useQuery<Quote[]>({\n    queryKey: [\"/api/quotes\"],\n  });\n\n  const { data: jobs = [], isLoading: jobsLoading } = useQuery<Job[]>({\n    queryKey: [\"/api/jobs\"],\n  });\n\n  const { data: clients = [] } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const { data: products = [] } = useQuery<Product[]>({\n    queryKey: [\"/api/products\"],\n  });\n\n  const tradeClients = clients.filter(c => c.clientType === \"trade\");\n  const tradeClientIds = tradeClients.map(c => c.id);\n\n  const tradeQuotes = quotes.filter(q => q.isTradeQuote || tradeClientIds.includes(q.clientId));\n  const tradeJobs = jobs.filter(j => tradeClientIds.includes(j.clientId));\n\n  const getQuoteStatus = (quote: Quote): \"pending\" | \"approved\" | \"declined\" => {\n    if (quote.status === \"approved\") return \"approved\";\n    if (quote.status === \"declined\" || quote.status === \"expired\") return \"declined\";\n    return \"pending\";\n  };\n\n  const getJobStatus = (job: Job): \"in_progress\" | \"production\" | \"ready\" | \"complete\" => {\n    const status = job.status;\n    if (status === \"paid_in_full\" || status === \"archived\" || status === \"install_complete\") {\n      return \"complete\";\n    }\n    if (status === \"ready_for_scheduling\") {\n      return \"ready\";\n    }\n    if (status.includes(\"manufacturing\") || status === \"qa_check\") {\n      return \"production\";\n    }\n    return \"in_progress\";\n  };\n\n  const displayQuotes: DisplayTradeQuote[] = tradeQuotes.map((quote) => ({\n    id: quote.id,\n    quoteNumber: quote.quoteNumber,\n    description: quote.siteAddress || \"Trade Order\",\n    totalAmount: parseFloat(quote.totalAmount) || 0,\n    status: getQuoteStatus(quote),\n    createdAt: new Date(quote.createdAt).toLocaleDateString(\"en-AU\", { day: \"numeric\", month: \"short\", year: \"numeric\" }),\n    expiresAt: quote.validUntil \n      ? new Date(quote.validUntil).toLocaleDateString(\"en-AU\", { day: \"numeric\", month: \"short\", year: \"numeric\" })\n      : \"14 days from creation\",\n  }));\n\n  const displayOrders: DisplayTradeOrder[] = tradeJobs.map((job) => ({\n    id: job.id,\n    orderNumber: job.jobNumber,\n    description: `${job.fenceStyle || \"PVC Fence\"} - ${job.totalLength || \"N/A\"}m`,\n    totalAmount: parseFloat(job.totalAmount) || 0,\n    status: getJobStatus(job),\n    estimatedReady: job.scheduledStartDate \n      ? new Date(job.scheduledStartDate).toLocaleDateString(\"en-AU\", { day: \"numeric\", month: \"short\", year: \"numeric\" })\n      : \"TBD\",\n  }));\n\n  const displayProducts: DisplayProduct[] = products\n    .filter(p => p.isActive)\n    .map((product) => ({\n      id: product.id,\n      name: product.name,\n      description: product.category,\n      tradePrice: parseFloat(product.tradePrice || product.sellPrice) || 0,\n    }));\n\n  const filteredProducts = displayProducts.filter(p => \n    p.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    p.description.toLowerCase().includes(searchQuery.toLowerCase())\n  );\n\n  const activeOrders = displayOrders.filter(o => o.status !== \"complete\").length;\n  const pendingQuotes = displayQuotes.filter(q => q.status === \"pending\").length;\n  const readyForPickup = displayOrders.filter(o => o.status === \"ready\").length;\n\n  const tradeClient = tradeClients[0];\n  const discountLevel = tradeClient?.tradeDiscountLevel;\n  const discountPercent = discountLevel === \"platinum\" ? \"25%\" \n    : discountLevel === \"gold\" ? \"20%\" \n    : discountLevel === \"silver\" ? \"15%\" \n    : discountLevel === \"bronze\" ? \"10%\" \n    : \"N/A\";\n\n  const handleAcceptQuote = (quote: DisplayTradeQuote) => {\n    toast({\n      title: \"Quote Accepted\",\n      description: `Processing ${quote.quoteNumber}`,\n    });\n  };\n\n  const handlePayDeposit = (quote: DisplayTradeQuote) => {\n    toast({\n      title: \"Payment\",\n      description: \"Redirecting to payment...\",\n    });\n  };\n\n  const handleTrackOrder = (order: DisplayTradeOrder) => {\n    toast({\n      title: \"Order Tracking\",\n      description: `Viewing ${order.orderNumber} status`,\n    });\n  };\n\n  const isLoading = quotesLoading || jobsLoading;\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <div className=\"p-6 border-b bg-primary text-primary-foreground\">\n          <div className=\"max-w-6xl mx-auto\">\n            <Skeleton className=\"h-8 w-32 bg-primary-foreground/20\" />\n            <Skeleton className=\"h-4 w-48 mt-1 bg-primary-foreground/20\" />\n          </div>\n        </div>\n        <div className=\"max-w-6xl mx-auto p-6 space-y-6\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n            {[...Array(4)].map((_, i) => (\n              <Skeleton key={i} className=\"h-24\" />\n            ))}\n          </div>\n          <Skeleton className=\"h-96\" />\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"p-6 border-b bg-primary text-primary-foreground\">\n        <div className=\"max-w-6xl mx-auto\">\n          <h1 className=\"text-2xl font-semibold\" data-testid=\"text-trade-title\">Trade Portal</h1>\n          <p className=\"text-sm opacity-80\">\n            Welcome back{tradeClient ? `, ${tradeClient.companyName || tradeClient.name}` : \"\"}\n          </p>\n        </div>\n      </div>\n\n      <div className=\"max-w-6xl mx-auto p-6 space-y-6\">\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n          <StatCard\n            title=\"Active Orders\"\n            value={activeOrders}\n            description=\"In production\"\n            icon={Package}\n          />\n          <StatCard\n            title=\"Pending Quotes\"\n            value={pendingQuotes}\n            description=\"Awaiting response\"\n            icon={FileText}\n          />\n          <StatCard\n            title=\"Trade Discount\"\n            value={discountPercent}\n            description=\"Your discount level\"\n            icon={CreditCard}\n          />\n          <StatCard\n            title=\"Ready for Pickup\"\n            value={readyForPickup}\n            description=\"Orders ready\"\n            icon={Truck}\n          />\n        </div>\n\n        <Tabs defaultValue=\"quotes\">\n          <TabsList>\n            <TabsTrigger value=\"quotes\" data-testid=\"tab-quotes\">\n              <FileText className=\"h-4 w-4 mr-2\" />\n              My Quotes\n            </TabsTrigger>\n            <TabsTrigger value=\"orders\" data-testid=\"tab-orders\">\n              <Package className=\"h-4 w-4 mr-2\" />\n              My Orders\n            </TabsTrigger>\n            <TabsTrigger value=\"reorder\" data-testid=\"tab-reorder\">\n              <ShoppingCart className=\"h-4 w-4 mr-2\" />\n              Reorder\n            </TabsTrigger>\n            <TabsTrigger value=\"guides\" data-testid=\"tab-guides\">\n              <Download className=\"h-4 w-4 mr-2\" />\n              Installation Guides\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"quotes\" className=\"mt-6 space-y-4\">\n            {displayQuotes.length === 0 ? (\n              <div className=\"text-center py-12 text-muted-foreground\">\n                <FileText className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n                <p>No quotes available</p>\n              </div>\n            ) : (\n              displayQuotes.map((quote) => (\n                <Card key={quote.id} data-testid={`quote-card-${quote.id}`}>\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-start justify-between gap-4 flex-wrap\">\n                      <div>\n                        <div className=\"flex items-center gap-3 mb-2\">\n                          <span className=\"font-mono text-sm text-muted-foreground\">\n                            {quote.quoteNumber}\n                          </span>\n                          <StatusBadge status={quote.status === \"pending\" ? \"quoted\" : quote.status} />\n                        </div>\n                        <h3 className=\"font-semibold mb-1\">{quote.description}</h3>\n                        <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\n                          <span>Created: {quote.createdAt}</span>\n                          <span>Expires: {quote.expiresAt}</span>\n                        </div>\n                      </div>\n                      <div className=\"text-right\">\n                        <p className=\"text-2xl font-bold\">${quote.totalAmount.toLocaleString()}</p>\n                        <p className=\"text-sm text-muted-foreground\">Inc. Trade Discount</p>\n                      </div>\n                    </div>\n                    {quote.status === \"pending\" && (\n                      <div className=\"flex gap-2 mt-4 pt-4 border-t\">\n                        <Button variant=\"outline\" className=\"flex-1\">\n                          <Download className=\"h-4 w-4 mr-2\" />\n                          Download PDF\n                        </Button>\n                        <Button\n                          className=\"flex-1\"\n                          onClick={() => handleAcceptQuote(quote)}\n                          data-testid={`button-accept-quote-${quote.id}`}\n                        >\n                          <CheckCircle className=\"h-4 w-4 mr-2\" />\n                          Accept Quote\n                        </Button>\n                      </div>\n                    )}\n                    {quote.status === \"approved\" && (\n                      <div className=\"flex gap-2 mt-4 pt-4 border-t\">\n                        <Button\n                          className=\"flex-1\"\n                          onClick={() => handlePayDeposit(quote)}\n                          data-testid={`button-pay-deposit-${quote.id}`}\n                        >\n                          <CreditCard className=\"h-4 w-4 mr-2\" />\n                          Pay 50% Deposit\n                        </Button>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              ))\n            )}\n          </TabsContent>\n\n          <TabsContent value=\"orders\" className=\"mt-6 space-y-4\">\n            {displayOrders.length === 0 ? (\n              <div className=\"text-center py-12 text-muted-foreground\">\n                <Package className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n                <p>No orders yet</p>\n              </div>\n            ) : (\n              displayOrders.map((order) => (\n                <Card key={order.id} data-testid={`order-card-${order.id}`}>\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-start justify-between gap-4 flex-wrap\">\n                      <div>\n                        <div className=\"flex items-center gap-3 mb-2\">\n                          <span className=\"font-mono text-sm text-muted-foreground\">\n                            {order.orderNumber}\n                          </span>\n                          <StatusBadge status={order.status} />\n                        </div>\n                        <h3 className=\"font-semibold mb-1\">{order.description}</h3>\n                        <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                          <Clock className=\"h-4 w-4\" />\n                          <span>\n                            {order.status === \"complete\" ? \"Completed\" : `Est. Ready: ${order.estimatedReady}`}\n                          </span>\n                        </div>\n                      </div>\n                      <div className=\"text-right\">\n                        <p className=\"text-xl font-bold\">${order.totalAmount.toLocaleString()}</p>\n                      </div>\n                    </div>\n                    <div className=\"flex gap-2 mt-4 pt-4 border-t\">\n                      <Button\n                        variant=\"outline\"\n                        className=\"flex-1\"\n                        onClick={() => handleTrackOrder(order)}\n                        data-testid={`button-track-order-${order.id}`}\n                      >\n                        <Package className=\"h-4 w-4 mr-2\" />\n                        Track Order\n                      </Button>\n                      {order.status === \"ready\" && (\n                        <Button className=\"flex-1\" data-testid={`button-arrange-pickup-${order.id}`}>\n                          <Truck className=\"h-4 w-4 mr-2\" />\n                          Arrange Pickup\n                        </Button>\n                      )}\n                    </div>\n                  </CardContent>\n                </Card>\n              ))\n            )}\n          </TabsContent>\n\n          <TabsContent value=\"reorder\" className=\"mt-6\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-lg\">Quick Reorder</CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"relative\">\n                  <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n                  <Input\n                    placeholder=\"Search products...\"\n                    value={searchQuery}\n                    onChange={(e) => setSearchQuery(e.target.value)}\n                    className=\"pl-9\"\n                    data-testid=\"input-search-reorder\"\n                  />\n                </div>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  {filteredProducts.length === 0 ? (\n                    <div className=\"col-span-2 text-center py-8 text-muted-foreground\">\n                      <Package className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n                      <p>No products found</p>\n                    </div>\n                  ) : (\n                    filteredProducts.slice(0, 8).map((product) => (\n                      <div \n                        key={product.id}\n                        className=\"p-4 border rounded-md hover-elevate cursor-pointer\" \n                        data-testid={`product-${product.id}`}\n                      >\n                        <h4 className=\"font-semibold\">{product.name}</h4>\n                        <p className=\"text-sm text-muted-foreground\">{product.description}</p>\n                        <p className=\"text-lg font-bold mt-2\">\n                          ${product.tradePrice.toFixed(2)} \n                          <span className=\"text-sm font-normal text-muted-foreground\"> (Trade)</span>\n                        </p>\n                      </div>\n                    ))\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"guides\" className=\"mt-6\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-lg\">Installation Guides</CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-3\">\n                {[\"Hampton Style Installation Guide\", \"Colonial Style Installation Guide\", \"Picket Style Installation Guide\", \"Gate Installation Guide\", \"Post Setting Guide\"].map((guide, idx) => (\n                  <div\n                    key={idx}\n                    className=\"flex items-center justify-between gap-4 p-4 border rounded-md hover-elevate cursor-pointer\"\n                    data-testid={`guide-${idx}`}\n                  >\n                    <div className=\"flex items-center gap-3\">\n                      <FileText className=\"h-5 w-5 text-muted-foreground\" />\n                      <span className=\"font-medium\">{guide}</span>\n                    </div>\n                    <Button variant=\"ghost\" size=\"sm\">\n                      <Download className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                ))}\n              </CardContent>\n            </Card>\n          </TabsContent>\n        </Tabs>\n\n        <Card className=\"bg-muted/50\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-4 flex-wrap\">\n              <div className=\"flex h-12 w-12 items-center justify-center rounded-full bg-accent\">\n                <HelpCircle className=\"h-6 w-6 text-accent-foreground\" />\n              </div>\n              <div className=\"flex-1 min-w-48\">\n                <h3 className=\"font-semibold\">Need Help?</h3>\n                <p className=\"text-sm text-muted-foreground\">Contact your account manager or our support team</p>\n              </div>\n              <Button variant=\"outline\" data-testid=\"button-contact-support\">\n                Contact Support\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":18098,"size_tokens":null},"client/src/components/examples/StatCardExample.tsx":{"content":"import { StatCard } from \"@/components/shared/StatCard\";\nimport { Users, FileText, Briefcase, DollarSign } from \"lucide-react\";\n\nexport default function StatCardExample() {\n  return (\n    <div className=\"grid grid-cols-2 gap-4 p-4\">\n      <StatCard\n        title=\"New Leads\"\n        value={12}\n        description=\"Awaiting contact\"\n        icon={Users}\n        trend={{ value: 8, isPositive: true }}\n      />\n      <StatCard\n        title=\"Active Quotes\"\n        value={24}\n        description=\"Pending response\"\n        icon={FileText}\n        trend={{ value: 12, isPositive: true }}\n      />\n      <StatCard\n        title=\"Jobs in Progress\"\n        value={18}\n        description=\"In production or scheduled\"\n        icon={Briefcase}\n      />\n      <StatCard\n        title=\"Monthly Revenue\"\n        value=\"$127,500\"\n        description=\"This month\"\n        icon={DollarSign}\n        trend={{ value: 15, isPositive: true }}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":953,"size_tokens":null},"client/src/components/shared/EmptyState.tsx":{"content":"import { LucideIcon } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface EmptyStateProps {\n  icon: LucideIcon;\n  title: string;\n  description: string;\n  actionLabel?: string;\n  onAction?: () => void;\n}\n\nexport function EmptyState({\n  icon: Icon,\n  title,\n  description,\n  actionLabel,\n  onAction,\n}: EmptyStateProps) {\n  return (\n    <div className=\"flex flex-col items-center justify-center py-16 px-4 text-center\">\n      <div className=\"flex h-16 w-16 items-center justify-center rounded-full bg-muted mb-4\">\n        <Icon className=\"h-8 w-8 text-muted-foreground\" />\n      </div>\n      <h3 className=\"text-lg font-semibold mb-2\">{title}</h3>\n      <p className=\"text-sm text-muted-foreground max-w-sm mb-6\">{description}</p>\n      {actionLabel && onAction && (\n        <Button onClick={onAction} data-testid=\"button-empty-action\">\n          {actionLabel}\n        </Button>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":933,"size_tokens":null},"client/src/components/shared/StatusBadge.tsx":{"content":"import { Badge } from \"@/components/ui/badge\";\nimport { cn } from \"@/lib/utils\";\n\ntype StatusType = \n  | \"new\" \n  | \"contacted\" \n  | \"quoted\" \n  | \"approved\" \n  | \"declined\"\n  | \"in_progress\"\n  | \"production\"\n  | \"ready\"\n  | \"scheduled\"\n  | \"complete\"\n  | \"paid\"\n  | \"overdue\"\n  | \"pending\"\n  | \"low_stock\"\n  | \"public\"\n  | \"trade\"\n  | \"draft\"\n  | \"sent\"\n  | \"expired\"\n  | \"accepted\"\n  | \"awaiting_deposit\"\n  | \"deposit_paid\"\n  | \"ready_for_production\"\n  | \"manufacturing_posts\"\n  | \"manufacturing_panels\"\n  | \"manufacturing_gates\"\n  | \"qa_check\"\n  | \"ready_for_scheduling\"\n  | \"install_in_progress\"\n  | \"install_posts\"\n  | \"install_panels\"\n  | \"install_gates\"\n  | \"install_complete\"\n  | \"final_payment_pending\"\n  | \"awaiting_final_payment\"\n  | \"completed\"\n  | \"paid_in_full\"\n  | \"cancelled\"\n  | \"archived\";\n\ninterface StatusBadgeProps {\n  status: StatusType;\n  className?: string;\n}\n\nconst statusConfig: Record<StatusType, { label: string; className: string }> = {\n  new: {\n    label: \"NEW\",\n    className: \"bg-accent text-accent-foreground\",\n  },\n  contacted: {\n    label: \"CONTACTED\",\n    className: \"bg-primary/10 text-primary dark:bg-primary/20\",\n  },\n  quoted: {\n    label: \"QUOTED\",\n    className: \"bg-warning/10 text-warning dark:bg-warning/20\",\n  },\n  approved: {\n    label: \"APPROVED\",\n    className: \"bg-success/10 text-success dark:bg-success/20\",\n  },\n  declined: {\n    label: \"DECLINED\",\n    className: \"bg-destructive/10 text-destructive dark:bg-destructive/20\",\n  },\n  in_progress: {\n    label: \"IN PROGRESS\",\n    className: \"bg-primary/10 text-primary dark:bg-primary/20\",\n  },\n  production: {\n    label: \"PRODUCTION\",\n    className: \"bg-warning/10 text-warning dark:bg-warning/20\",\n  },\n  ready: {\n    label: \"READY\",\n    className: \"bg-success/10 text-success dark:bg-success/20\",\n  },\n  scheduled: {\n    label: \"SCHEDULED\",\n    className: \"bg-primary/10 text-primary dark:bg-primary/20\",\n  },\n  complete: {\n    label: \"COMPLETE\",\n    className: \"bg-success/10 text-success dark:bg-success/20\",\n  },\n  paid: {\n    label: \"PAID\",\n    className: \"bg-success/10 text-success dark:bg-success/20\",\n  },\n  overdue: {\n    label: \"OVERDUE\",\n    className: \"bg-destructive/10 text-destructive dark:bg-destructive/20\",\n  },\n  pending: {\n    label: \"PENDING\",\n    className: \"bg-muted text-muted-foreground\",\n  },\n  low_stock: {\n    label: \"LOW STOCK\",\n    className: \"bg-destructive/10 text-destructive dark:bg-destructive/20\",\n  },\n  public: {\n    label: \"PUBLIC\",\n    className: \"bg-primary/10 text-primary dark:bg-primary/20\",\n  },\n  trade: {\n    label: \"TRADE\",\n    className: \"bg-accent text-accent-foreground\",\n  },\n  draft: {\n    label: \"DRAFT\",\n    className: \"bg-muted text-muted-foreground\",\n  },\n  sent: {\n    label: \"SENT\",\n    className: \"bg-primary/10 text-primary dark:bg-primary/20\",\n  },\n  expired: {\n    label: \"EXPIRED\",\n    className: \"bg-destructive/10 text-destructive dark:bg-destructive/20\",\n  },\n  accepted: {\n    label: \"ACCEPTED\",\n    className: \"bg-success/10 text-success dark:bg-success/20\",\n  },\n  awaiting_deposit: {\n    label: \"AWAITING DEPOSIT\",\n    className: \"bg-warning/10 text-warning dark:bg-warning/20\",\n  },\n  deposit_paid: {\n    label: \"DEPOSIT PAID\",\n    className: \"bg-success/10 text-success dark:bg-success/20\",\n  },\n  ready_for_production: {\n    label: \"READY FOR PRODUCTION\",\n    className: \"bg-primary/10 text-primary dark:bg-primary/20\",\n  },\n  manufacturing_posts: {\n    label: \"MFG POSTS\",\n    className: \"bg-warning/10 text-warning dark:bg-warning/20\",\n  },\n  manufacturing_panels: {\n    label: \"MFG PANELS\",\n    className: \"bg-warning/10 text-warning dark:bg-warning/20\",\n  },\n  manufacturing_gates: {\n    label: \"MFG GATES\",\n    className: \"bg-warning/10 text-warning dark:bg-warning/20\",\n  },\n  qa_check: {\n    label: \"QA CHECK\",\n    className: \"bg-primary/10 text-primary dark:bg-primary/20\",\n  },\n  ready_for_scheduling: {\n    label: \"READY TO SCHEDULE\",\n    className: \"bg-success/10 text-success dark:bg-success/20\",\n  },\n  install_in_progress: {\n    label: \"INSTALLING\",\n    className: \"bg-warning/10 text-warning dark:bg-warning/20\",\n  },\n  install_posts: {\n    label: \"INSTALL POSTS\",\n    className: \"bg-warning/10 text-warning dark:bg-warning/20\",\n  },\n  install_panels: {\n    label: \"INSTALL PANELS\",\n    className: \"bg-warning/10 text-warning dark:bg-warning/20\",\n  },\n  install_gates: {\n    label: \"INSTALL GATES\",\n    className: \"bg-warning/10 text-warning dark:bg-warning/20\",\n  },\n  install_complete: {\n    label: \"INSTALL COMPLETE\",\n    className: \"bg-success/10 text-success dark:bg-success/20\",\n  },\n  final_payment_pending: {\n    label: \"FINAL PAYMENT\",\n    className: \"bg-warning/10 text-warning dark:bg-warning/20\",\n  },\n  awaiting_final_payment: {\n    label: \"AWAITING PAYMENT\",\n    className: \"bg-warning/10 text-warning dark:bg-warning/20\",\n  },\n  completed: {\n    label: \"COMPLETED\",\n    className: \"bg-success/10 text-success dark:bg-success/20\",\n  },\n  paid_in_full: {\n    label: \"PAID IN FULL\",\n    className: \"bg-success/10 text-success dark:bg-success/20\",\n  },\n  cancelled: {\n    label: \"CANCELLED\",\n    className: \"bg-destructive/10 text-destructive dark:bg-destructive/20\",\n  },\n  archived: {\n    label: \"ARCHIVED\",\n    className: \"bg-muted text-muted-foreground\",\n  },\n};\n\nexport function StatusBadge({ status, className }: StatusBadgeProps) {\n  const config = statusConfig[status];\n  \n  return (\n    <Badge\n      variant=\"secondary\"\n      className={cn(\n        \"text-[10px] font-semibold uppercase tracking-wide px-2 py-0.5\",\n        config.className,\n        className\n      )}\n      data-testid={`badge-status-${status}`}\n    >\n      {config.label}\n    </Badge>\n  );\n}\n","path":null,"size_bytes":5671,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5128,"size_tokens":null},"server/seed.ts":{"content":"import { db } from \"./db\";\nimport {\n  users, clients, leads, fenceStyles, products, quotes, jobs,\n  productionTasks, installTasks, scheduleEvents, payments, notifications\n} from \"@shared/schema\";\n\nasync function seed() {\n  console.log(\"Seeding database...\");\n\n  // Clear existing data (order matters due to foreign key constraints)\n  await db.delete(notifications);\n  await db.delete(payments);\n  await db.delete(scheduleEvents);\n  await db.delete(installTasks);\n  await db.delete(productionTasks);\n  await db.delete(jobs);\n  await db.delete(quotes);\n  await db.delete(leads);\n  await db.delete(clients);\n  await db.delete(products);\n  await db.delete(fenceStyles);\n  await db.delete(users);\n\n  // Create Users\n  const [adminUser] = await db.insert(users).values({\n    username: \"vonnie\",\n    password: \"password123\",\n    email: \"vonnie@probuildpvc.com.au\",\n    firstName: \"Vonnie\",\n    lastName: \"Bradley\",\n    phone: \"0412 345 678\",\n    role: \"admin\",\n  }).returning();\n\n  const [salesUser] = await db.insert(users).values({\n    username: \"dave\",\n    password: \"password123\",\n    email: \"dave@probuildpvc.com.au\",\n    firstName: \"Dave\",\n    lastName: \"Smith\",\n    phone: \"0423 456 789\",\n    role: \"sales\",\n  }).returning();\n\n  const [schedulerUser] = await db.insert(users).values({\n    username: \"craig\",\n    password: \"password123\",\n    email: \"craig@probuildpvc.com.au\",\n    firstName: \"Craig\",\n    lastName: \"Johnson\",\n    phone: \"0434 567 890\",\n    role: \"scheduler\",\n  }).returning();\n\n  const [productionUser] = await db.insert(users).values({\n    username: \"david.turner\",\n    password: \"password123\",\n    email: \"david.turner@probuildpvc.com.au\",\n    firstName: \"David\",\n    lastName: \"Turner\",\n    phone: \"0445 678 901\",\n    role: \"production_manager\",\n  }).returning();\n\n  const [warehouseUser] = await db.insert(users).values({\n    username: \"george\",\n    password: \"password123\",\n    email: \"george@probuildpvc.com.au\",\n    firstName: \"George\",\n    lastName: \"Williams\",\n    phone: \"0456 789 012\",\n    role: \"warehouse\",\n  }).returning();\n\n  const [installer1] = await db.insert(users).values({\n    username: \"jake\",\n    password: \"password123\",\n    email: \"jake@probuildpvc.com.au\",\n    firstName: \"Jake\",\n    lastName: \"Miller\",\n    phone: \"0467 890 123\",\n    role: \"installer\",\n  }).returning();\n\n  const [installer2] = await db.insert(users).values({\n    username: \"jarrad\",\n    password: \"password123\",\n    email: \"jarrad@probuildpvc.com.au\",\n    firstName: \"Jarrad\",\n    lastName: \"Brown\",\n    phone: \"0478 901 234\",\n    role: \"installer\",\n  }).returning();\n\n  console.log(\"Created users\");\n\n  // Create Fence Styles\n  const [hamptonStyle] = await db.insert(fenceStyles).values({\n    name: \"Hampton\",\n    description: \"Classic horizontal slat design with clean lines\",\n    standardHeights: [1200, 1500, 1800],\n    postTypes: [\"65x65\", \"90x90\"],\n    picketSpacingOptions: [10, 15, 20],\n    basePrice: \"185.00\",\n  }).returning();\n\n  const [picketStyle] = await db.insert(fenceStyles).values({\n    name: \"Picket\",\n    description: \"Traditional picket fence design\",\n    standardHeights: [900, 1200, 1500],\n    postTypes: [\"65x65\"],\n    picketSpacingOptions: [50, 75, 100],\n    basePrice: \"155.00\",\n  }).returning();\n\n  const [colonialStyle] = await db.insert(fenceStyles).values({\n    name: \"Colonial\",\n    description: \"Elegant colonial-style with decorative caps\",\n    standardHeights: [1500, 1800, 2100],\n    postTypes: [\"90x90\", \"127x127\"],\n    picketSpacingOptions: [0],\n    basePrice: \"220.00\",\n  }).returning();\n\n  const [nautilusStyle] = await db.insert(fenceStyles).values({\n    name: \"Nautilus\",\n    description: \"Modern horizontal slat design with wider gaps\",\n    standardHeights: [1200, 1500, 1800],\n    postTypes: [\"65x65\", \"90x90\"],\n    picketSpacingOptions: [25, 35, 50],\n    basePrice: \"195.00\",\n  }).returning();\n\n  console.log(\"Created fence styles\");\n\n  // Create Products\n  const productsData = [\n    { sku: \"POST-65-1800\", name: \"Post 65x65mm 1800mm\", category: \"posts\" as const, costPrice: \"45.00\", sellPrice: \"85.00\", stockOnHand: 150 },\n    { sku: \"POST-90-1800\", name: \"Post 90x90mm 1800mm\", category: \"posts\" as const, costPrice: \"65.00\", sellPrice: \"120.00\", stockOnHand: 80 },\n    { sku: \"POST-90-2400\", name: \"Post 90x90mm 2400mm\", category: \"posts\" as const, costPrice: \"85.00\", sellPrice: \"155.00\", stockOnHand: 45 },\n    { sku: \"RAIL-65-2400\", name: \"Rail 65x40mm 2400mm\", category: \"rails\" as const, costPrice: \"22.00\", sellPrice: \"42.00\", stockOnHand: 200 },\n    { sku: \"RAIL-65-3000\", name: \"Rail 65x40mm 3000mm\", category: \"rails\" as const, costPrice: \"28.00\", sellPrice: \"52.00\", stockOnHand: 180 },\n    { sku: \"PICKET-65-900\", name: \"Picket 65x16mm 900mm\", category: \"pickets\" as const, costPrice: \"8.00\", sellPrice: \"16.00\", stockOnHand: 500 },\n    { sku: \"PICKET-65-1200\", name: \"Picket 65x16mm 1200mm\", category: \"pickets\" as const, costPrice: \"10.00\", sellPrice: \"20.00\", stockOnHand: 450 },\n    { sku: \"PICKET-65-1500\", name: \"Picket 65x16mm 1500mm\", category: \"pickets\" as const, costPrice: \"12.00\", sellPrice: \"24.00\", stockOnHand: 320 },\n    { sku: \"CAP-65\", name: \"Post Cap 65mm\", category: \"caps\" as const, costPrice: \"4.00\", sellPrice: \"8.50\", stockOnHand: 300 },\n    { sku: \"CAP-90\", name: \"Post Cap 90mm\", category: \"caps\" as const, costPrice: \"6.00\", sellPrice: \"12.00\", stockOnHand: 200 },\n    { sku: \"GATE-S-900\", name: \"Single Gate 900mm\", category: \"gates\" as const, costPrice: \"180.00\", sellPrice: \"380.00\", stockOnHand: 12 },\n    { sku: \"GATE-S-1200\", name: \"Single Gate 1200mm\", category: \"gates\" as const, costPrice: \"220.00\", sellPrice: \"450.00\", stockOnHand: 8 },\n    { sku: \"GATE-D-2400\", name: \"Double Gate 2400mm\", category: \"gates\" as const, costPrice: \"450.00\", sellPrice: \"850.00\", stockOnHand: 6 },\n    { sku: \"BRACKET-RAIL\", name: \"Rail Bracket\", category: \"hardware\" as const, costPrice: \"2.50\", sellPrice: \"5.50\", stockOnHand: 1000 },\n    { sku: \"SCREW-SS-50\", name: \"SS Screws 50mm (100pk)\", category: \"hardware\" as const, costPrice: \"12.00\", sellPrice: \"25.00\", stockOnHand: 50 },\n  ];\n\n  await db.insert(products).values(productsData as any[]);\n  console.log(\"Created products\");\n\n  // Create Clients\n  const [client1] = await db.insert(clients).values({\n    name: \"John & Sarah Smith\",\n    phone: \"0412 111 222\",\n    email: \"smith.family@email.com\",\n    address: \"45 Coastal Drive, Scarborough WA 6019\",\n    clientType: \"public\",\n    notes: \"Referred by neighbour\",\n  }).returning();\n\n  const [client2] = await db.insert(clients).values({\n    name: \"Michael Johnson\",\n    phone: \"0423 222 333\",\n    email: \"m.johnson@email.com\",\n    address: \"128 Beach Road, Cottesloe WA 6011\",\n    clientType: \"public\",\n  }).returning();\n\n  const [client3] = await db.insert(clients).values({\n    name: \"Premium Fencing Solutions\",\n    phone: \"0434 333 444\",\n    email: \"orders@premiumfencing.com.au\",\n    address: \"Unit 5, 22 Industrial Way, Malaga WA 6090\",\n    clientType: \"trade\",\n    companyName: \"Premium Fencing Solutions Pty Ltd\",\n    abn: \"12 345 678 901\",\n    tradeDiscountLevel: \"gold\",\n  }).returning();\n\n  const [client4] = await db.insert(clients).values({\n    name: \"WA Landscape Co\",\n    phone: \"0445 444 555\",\n    email: \"info@walandscape.com.au\",\n    address: \"88 Garden Street, Subiaco WA 6008\",\n    clientType: \"trade\",\n    companyName: \"WA Landscape Co Pty Ltd\",\n    abn: \"23 456 789 012\",\n    tradeDiscountLevel: \"silver\",\n  }).returning();\n\n  const [client5] = await db.insert(clients).values({\n    name: \"Emma Thompson\",\n    phone: \"0456 555 666\",\n    email: \"emma.t@email.com\",\n    address: \"15 Ocean View Terrace, City Beach WA 6015\",\n    clientType: \"public\",\n  }).returning();\n\n  console.log(\"Created clients\");\n\n  // Create Leads\n  const [lead1] = await db.insert(leads).values({\n    clientId: client1.id,\n    source: \"website\",\n    leadType: \"public\",\n    description: \"Looking for Hampton style fence for backyard\",\n    siteAddress: \"45 Coastal Drive, Scarborough WA 6019\",\n    measurementsProvided: true,\n    fenceLength: \"35.5\",\n    fenceStyle: \"Hampton\",\n    stage: \"quote_sent\",\n    assignedTo: salesUser.id,\n    notes: \"Customer wants 1800mm height. Has existing colorbond to remove.\",\n  }).returning();\n\n  const [lead2] = await db.insert(leads).values({\n    clientId: client2.id,\n    source: \"phone\",\n    leadType: \"public\",\n    description: \"Pool fencing enquiry\",\n    siteAddress: \"128 Beach Road, Cottesloe WA 6011\",\n    measurementsProvided: false,\n    stage: \"contacted\",\n    assignedTo: salesUser.id,\n    notes: \"Needs site measure. Pool compliance required.\",\n  }).returning();\n\n  const [lead3] = await db.insert(leads).values({\n    clientId: client5.id,\n    source: \"referral\",\n    leadType: \"public\",\n    description: \"Front fence and side gates\",\n    siteAddress: \"15 Ocean View Terrace, City Beach WA 6015\",\n    measurementsProvided: true,\n    fenceLength: \"22.0\",\n    fenceStyle: \"Colonial\",\n    stage: \"new\",\n    assignedTo: salesUser.id,\n  }).returning();\n\n  const [lead4] = await db.insert(leads).values({\n    source: \"walk_in\",\n    leadType: \"public\",\n    description: \"Picket fence for heritage home\",\n    siteAddress: \"88 Heritage Lane, Claremont WA 6010\",\n    stage: \"new\",\n  }).returning();\n\n  console.log(\"Created leads\");\n\n  // Create Quotes\n  const [quote1] = await db.insert(quotes).values({\n    quoteNumber: \"Q-2024-0001\",\n    clientId: client1.id,\n    leadId: lead1.id,\n    fenceStyleId: hamptonStyle.id,\n    siteAddress: \"45 Coastal Drive, Scarborough WA 6019\",\n    totalLength: \"35.5\",\n    fenceHeight: \"1800\",\n    lineItems: [\n      { productId: \"POST-90-2400\", productName: \"Post 90x90mm 2400mm\", quantity: 15, unitPrice: 155, totalPrice: 2325 },\n      { productId: \"RAIL-65-3000\", productName: \"Rail 65x40mm 3000mm\", quantity: 48, unitPrice: 52, totalPrice: 2496 },\n      { productId: \"PICKET-65-1500\", productName: \"Picket 65x16mm 1500mm\", quantity: 180, unitPrice: 24, totalPrice: 4320 },\n      { productId: \"CAP-90\", productName: \"Post Cap 90mm\", quantity: 15, unitPrice: 12, totalPrice: 180 },\n    ],\n    materialsSubtotal: \"9321.00\",\n    labourEstimate: \"3200.00\",\n    totalAmount: \"12521.00\",\n    depositRequired: \"6260.50\",\n    depositPercent: 50,\n    status: \"sent\",\n    sentAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),\n    createdBy: salesUser.id,\n    notes: \"Includes removal of existing colorbond fence\",\n  } as any).returning();\n\n  const [quote2] = await db.insert(quotes).values({\n    quoteNumber: \"Q-2024-0002\",\n    clientId: client3.id,\n    fenceStyleId: hamptonStyle.id,\n    siteAddress: \"Various Trade Jobs\",\n    totalLength: \"100.0\",\n    fenceHeight: \"1800\",\n    materialsSubtotal: \"18500.00\",\n    labourEstimate: \"0\",\n    totalAmount: \"14800.00\",\n    depositRequired: \"7400.00\",\n    depositPercent: 50,\n    status: \"approved\",\n    isTradeQuote: true,\n    tradeDiscount: \"20.00\",\n    approvedAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000),\n    createdBy: salesUser.id,\n  } as any).returning();\n\n  console.log(\"Created quotes\");\n\n  // Create Jobs\n  const [job1] = await db.insert(jobs).values({\n    jobNumber: \"JOB-2024-0089\",\n    clientId: client3.id,\n    quoteId: quote2.id,\n    jobType: \"supply_only\",\n    siteAddress: \"Various Trade Jobs\",\n    status: \"manufacturing_panels\",\n    fenceStyle: \"Hampton\",\n    totalLength: \"100.0\",\n    fenceHeight: \"1800\",\n    totalAmount: \"14800.00\",\n    depositAmount: \"7400.00\",\n    depositPaid: true,\n    depositPaidAt: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000),\n    notes: \"Trade order - Hampton panels bulk\",\n  } as any).returning();\n\n  const [job2] = await db.insert(jobs).values({\n    jobNumber: \"JOB-2024-0088\",\n    clientId: client1.id,\n    quoteId: quote1.id,\n    jobType: \"supply_install\",\n    siteAddress: \"45 Coastal Drive, Scarborough WA 6019\",\n    status: \"scheduled\",\n    fenceStyle: \"Hampton\",\n    totalLength: \"35.5\",\n    fenceHeight: \"1800\",\n    totalAmount: \"12521.00\",\n    depositAmount: \"6260.50\",\n    depositPaid: true,\n    depositPaidAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000),\n    assignedInstaller: installer1.id,\n    scheduledStartDate: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000),\n    notes: \"Remove existing colorbond. Customer aware of timeline.\",\n  } as any).returning();\n\n  const [job3] = await db.insert(jobs).values({\n    jobNumber: \"JOB-2024-0087\",\n    clientId: client4.id,\n    quoteId: quote2.id,\n    jobType: \"supply_only\",\n    siteAddress: \"88 Garden Street, Subiaco WA 6008\",\n    status: \"ready_for_scheduling\",\n    fenceStyle: \"Colonial\",\n    totalLength: \"45.0\",\n    fenceHeight: \"1500\",\n    totalAmount: \"8950.00\",\n    depositAmount: \"4475.00\",\n    depositPaid: true,\n    depositPaidAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),\n  } as any).returning();\n\n  console.log(\"Created jobs\");\n\n  // Create Production Tasks\n  await db.insert(productionTasks).values([\n    {\n      jobId: job1.id,\n      taskType: \"cutting\",\n      status: \"completed\",\n      assignedTo: warehouseUser.id,\n      startTime: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),\n      endTime: new Date(Date.now() - 1.5 * 24 * 60 * 60 * 1000),\n      timeSpentMinutes: 180,\n    },\n    {\n      jobId: job1.id,\n      taskType: \"routing\",\n      status: \"completed\",\n      assignedTo: warehouseUser.id,\n      startTime: new Date(Date.now() - 1.5 * 24 * 60 * 60 * 1000),\n      endTime: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000),\n      timeSpentMinutes: 120,\n    },\n    {\n      jobId: job1.id,\n      taskType: \"assembly\",\n      status: \"in_progress\",\n      assignedTo: warehouseUser.id,\n      startTime: new Date(Date.now() - 4 * 60 * 60 * 1000),\n    },\n    {\n      jobId: job1.id,\n      taskType: \"qa\",\n      status: \"pending\",\n    },\n    {\n      jobId: job2.id,\n      taskType: \"cutting\",\n      status: \"completed\",\n      assignedTo: warehouseUser.id,\n      timeSpentMinutes: 90,\n    },\n    {\n      jobId: job2.id,\n      taskType: \"routing\",\n      status: \"completed\",\n      assignedTo: warehouseUser.id,\n      timeSpentMinutes: 60,\n    },\n    {\n      jobId: job2.id,\n      taskType: \"assembly\",\n      status: \"completed\",\n      assignedTo: warehouseUser.id,\n      timeSpentMinutes: 150,\n    },\n    {\n      jobId: job2.id,\n      taskType: \"qa\",\n      status: \"completed\",\n      assignedTo: productionUser.id,\n      qaResult: \"passed\",\n      qaPassedAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000),\n    },\n  ] as any[]);\n\n  console.log(\"Created production tasks\");\n\n  // Create Install Tasks\n  await db.insert(installTasks).values([\n    {\n      jobId: job2.id,\n      scheduledDate: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000),\n      installerId: installer1.id,\n      status: \"scheduled\",\n      notes: \"Day 1 - Posts and rails\",\n    },\n    {\n      jobId: job2.id,\n      scheduledDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000),\n      installerId: installer1.id,\n      status: \"scheduled\",\n      notes: \"Day 2 - Panels and finishing\",\n    },\n  ] as any[]);\n\n  console.log(\"Created install tasks\");\n\n  // Create Schedule Events\n  await db.insert(scheduleEvents).values([\n    {\n      jobId: job2.id,\n      eventType: \"install\",\n      title: \"Install - Smith Residence\",\n      description: \"Hampton fence installation Day 1\",\n      startDate: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000),\n      endDate: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000 + 8 * 60 * 60 * 1000),\n      assignedTo: installer1.id,\n      isConfirmed: true,\n      clientNotified: true,\n    },\n    {\n      jobId: job2.id,\n      eventType: \"install\",\n      title: \"Install - Smith Residence\",\n      description: \"Hampton fence installation Day 2\",\n      startDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000),\n      endDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000 + 6 * 60 * 60 * 1000),\n      assignedTo: installer1.id,\n      isConfirmed: true,\n    },\n    {\n      jobId: job3.id,\n      eventType: \"pickup\",\n      title: \"Pickup - WA Landscape Co\",\n      description: \"Colonial fence materials ready for pickup\",\n      startDate: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000),\n      endDate: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000 + 2 * 60 * 60 * 1000),\n      isConfirmed: false,\n    },\n    {\n      eventType: \"site_measure\",\n      title: \"Site Measure - Johnson Pool\",\n      description: \"Pool fencing site measure\",\n      startDate: new Date(Date.now() + 4 * 24 * 60 * 60 * 1000),\n      endDate: new Date(Date.now() + 4 * 24 * 60 * 60 * 1000 + 1 * 60 * 60 * 1000),\n      assignedTo: salesUser.id,\n    },\n  ] as any[]);\n\n  console.log(\"Created schedule events\");\n\n  // Create Payments\n  await db.insert(payments).values([\n    {\n      clientId: client1.id,\n      jobId: job2.id,\n      quoteId: quote1.id,\n      invoiceNumber: \"INV-2024-0156\",\n      amount: \"6260.50\",\n      paymentType: \"deposit\",\n      paymentMethod: \"stripe\",\n      status: \"completed\",\n      paidAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000),\n    },\n    {\n      clientId: client3.id,\n      jobId: job1.id,\n      quoteId: quote2.id,\n      invoiceNumber: \"INV-2024-0155\",\n      amount: \"7400.00\",\n      paymentType: \"deposit\",\n      paymentMethod: \"bank_transfer\",\n      status: \"completed\",\n      paidAt: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000),\n    },\n    {\n      clientId: client1.id,\n      jobId: job2.id,\n      invoiceNumber: \"INV-2024-0158\",\n      amount: \"6260.50\",\n      paymentType: \"final\",\n      status: \"pending\",\n    },\n    {\n      clientId: client3.id,\n      jobId: job1.id,\n      invoiceNumber: \"INV-2024-0157\",\n      amount: \"7400.00\",\n      paymentType: \"final\",\n      status: \"pending\",\n    },\n  ] as any[]);\n\n  console.log(\"Created payments\");\n\n  // Create Notifications\n  await db.insert(notifications).values([\n    {\n      userId: salesUser.id,\n      type: \"lead_new\",\n      title: \"New Lead Created\",\n      message: \"Looking for Hampton style fence for backyard - Sarah Smith\",\n      relatedEntityType: \"lead\",\n      relatedEntityId: lead1.id,\n      createdAt: new Date(Date.now() - 2 * 60 * 1000),\n    },\n    {\n      userId: salesUser.id,\n      type: \"quote_approved\",\n      title: \"Quote Approved\",\n      message: \"Quote Q-2024-0002 approved by WA Landscape Co - $14,800.00\",\n      relatedEntityType: \"quote\",\n      relatedEntityId: quote2.id,\n      createdAt: new Date(Date.now() - 2 * 60 * 60 * 1000),\n    },\n    {\n      userId: salesUser.id,\n      type: \"payment_received\",\n      title: \"Payment Received\",\n      message: \"$6,260.50 deposit payment from Sarah Smith\",\n      relatedEntityType: \"payment\",\n      createdAt: new Date(Date.now() - 4 * 60 * 60 * 1000),\n    },\n    {\n      userId: salesUser.id,\n      type: \"job_scheduled\",\n      title: \"Job Scheduled\",\n      message: \"JOB-2024-0088 - Sarah Smith - Hampton fence installation\",\n      relatedEntityType: \"job\",\n      relatedEntityId: job2.id,\n      createdAt: new Date(Date.now() - 6 * 60 * 60 * 1000),\n    },\n    {\n      userId: salesUser.id,\n      type: \"lead_assigned\",\n      title: \"Lead Assigned to You\",\n      message: \"Pool fencing enquiry from James Johnson assigned to you\",\n      relatedEntityType: \"lead\",\n      relatedEntityId: lead3.id,\n      createdAt: new Date(Date.now() - 24 * 60 * 60 * 1000),\n    },\n    {\n      userId: schedulerUser.id,\n      type: \"job_ready\",\n      title: \"Job ready for scheduling\",\n      message: \"JOB-2024-0087 is ready for scheduling\",\n      relatedEntityType: \"job\",\n      relatedEntityId: job3.id,\n    },\n    {\n      userId: productionUser.id,\n      type: \"production_complete\",\n      title: \"Production complete\",\n      message: \"JOB-2024-0088 production is complete and ready for install\",\n      relatedEntityType: \"job\",\n      relatedEntityId: job2.id,\n    },\n  ] as any[]);\n\n  console.log(\"Created notifications\");\n\n  console.log(\"Database seeded successfully!\");\n}\n\nseed()\n  .then(() => process.exit(0))\n  .catch((err) => {\n    console.error(\"Error seeding database:\", err);\n    process.exit(1);\n  });\n","path":null,"size_bytes":19854,"size_tokens":null},"server/storage.ts":{"content":"import { eq, desc, and, gte, lte, like, ilike, or, sql, isNull, isNotNull, ne, inArray } from \"drizzle-orm\";\nimport { db } from \"./db\";\nimport {\n  users, clients, leads, fenceStyles, products, quotes, jobs, bom,\n  productionTasks, installTasks, scheduleEvents, payments, notifications,\n  smsLogs, smsConversations, messageRanges, activityLogs, documents,\n  quoteFollowUps, automationCampaigns, campaignEnrollments,\n  staffRateCards, quoteCostComponents, quoteTrips, quoteAdminTime,\n  travelSessions, quoteGroundConditions, quotePLSummary,\n  departments, workflows, workflowVersions, policies, policyVersions,\n  policyAcknowledgements, resources, knowledgeArticles,\n  jobSetupDocuments, jobSetupProducts, liveDocumentTemplates,\n  leadActivities, leadTasks, staffLeaveBalances,\n  bankConnections, bankAccounts, bankTransactions,\n  jobPipelines, jobPipelineStages,\n  expenseCategories, receiptSubmissions,\n  type User, type InsertUser,\n  type StaffLeaveBalance, type InsertStaffLeaveBalance,\n  type Client, type InsertClient,\n  type Lead, type InsertLead,\n  type FenceStyle, type InsertFenceStyle,\n  type Product, type InsertProduct,\n  type Quote, type InsertQuote,\n  type Job, type InsertJob,\n  type BOM, type InsertBOM,\n  type ProductionTask, type InsertProductionTask,\n  type InstallTask, type InsertInstallTask,\n  type ScheduleEvent, type InsertScheduleEvent,\n  type Payment, type InsertPayment,\n  type Notification, type InsertNotification,\n  type SMSLog, type InsertSMSLog,\n  type SMSConversation, type InsertSMSConversation,\n  type MessageRange, type InsertMessageRange,\n  type ActivityLog, type InsertActivityLog,\n  type Document, type InsertDocument,\n  type QuoteFollowUp, type InsertQuoteFollowUp,\n  type AutomationCampaign, type InsertAutomationCampaign,\n  type CampaignEnrollment, type InsertCampaignEnrollment,\n  type StaffRateCard, type InsertStaffRateCard,\n  type QuoteCostComponent, type InsertQuoteCostComponent,\n  type QuoteTrip, type InsertQuoteTrip,\n  type QuoteAdminTime, type InsertQuoteAdminTime,\n  type TravelSession, type InsertTravelSession,\n  type QuoteGroundCondition, type InsertQuoteGroundCondition,\n  type QuotePLSummary, type InsertQuotePLSummary,\n  type Department, type InsertDepartment,\n  type Workflow, type InsertWorkflow,\n  type WorkflowVersion, type InsertWorkflowVersion,\n  type Policy, type InsertPolicy,\n  type PolicyVersion, type InsertPolicyVersion,\n  type PolicyAcknowledgement, type InsertPolicyAcknowledgement,\n  type Resource, type InsertResource,\n  type KnowledgeArticle, type InsertKnowledgeArticle,\n  type JobSetupDocument, type InsertJobSetupDocument,\n  type JobSetupProduct, type InsertJobSetupProduct,\n  type JobSetupSection1Sales,\n  type JobSetupSection2ProductsMeta,\n  type JobSetupSection3Production,\n  type JobSetupSection4Schedule,\n  type JobSetupSection5Install,\n  type LiveDocumentTemplate, type InsertLiveDocumentTemplate,\n  type LeadActivity, type InsertLeadActivity,\n  type LeadTask, type InsertLeadTask,\n  type DashboardWidget, type InsertDashboardWidget,\n  type RoleDashboardLayout, type InsertRoleDashboardLayout,\n  type DashboardWidgetInstance, type InsertDashboardWidgetInstance,\n  type BankConnection, type InsertBankConnection,\n  type BankAccount, type InsertBankAccount,\n  type BankTransaction, type InsertBankTransaction,\n  type JobPipeline, type InsertJobPipeline,\n  type JobPipelineStage, type InsertJobPipelineStage,\n  type JobStageCompletion, jobStageCompletions,\n  type KanbanColumn, type InsertKanbanColumn, kanbanColumns,\n  type JobStatus, type InsertJobStatus, jobStatuses,\n  type JobStatusDependency, jobStatusDependencies,\n  type ProductionStage, type InsertProductionStage, productionStages,\n  dashboardWidgets, roleDashboardLayouts, dashboardWidgetInstances,\n  // Voice Calls & AI Coaching\n  voiceCalls, callTranscripts, salesChecklistItems, callChecklistStatus, callCoachingPrompts,\n  type VoiceCall, type InsertVoiceCall,\n  type CallTranscript, type InsertCallTranscript,\n  type SalesChecklistItem, type InsertSalesChecklistItem,\n  type CallChecklistStatus, type InsertCallChecklistStatus,\n  type CallCoachingPrompt, type InsertCallCoachingPrompt,\n  type ExpenseCategory, type InsertExpenseCategory,\n  type ReceiptSubmission, type InsertReceiptSubmission,\n} from \"@shared/schema\";\n\nexport interface IStorage {\n  // Users\n  getUser(id: string): Promise<User | undefined>;\n  getUserByUsername(username: string): Promise<User | undefined>;\n  getUserByEmail(email: string): Promise<User | undefined>;\n  createUser(user: InsertUser): Promise<User>;\n  updateUser(id: string, user: Partial<InsertUser>): Promise<User | undefined>;\n  getUsers(): Promise<User[]>;\n  getUsersByRole(role: string): Promise<User[]>;\n\n  // Clients\n  getClient(id: string): Promise<Client | undefined>;\n  getClients(): Promise<Client[]>;\n  getClientsByType(clientType: string): Promise<Client[]>;\n  createClient(client: InsertClient): Promise<Client>;\n  updateClient(id: string, client: Partial<InsertClient>): Promise<Client | undefined>;\n  deleteClient(id: string): Promise<boolean>;\n  searchClients(query: string): Promise<Client[]>;\n\n  // Leads\n  getLead(id: string): Promise<Lead | undefined>;\n  getLeads(): Promise<Lead[]>;\n  getLeadsByStage(stage: string): Promise<Lead[]>;\n  getLeadsByAssignee(userId: string): Promise<Lead[]>;\n  createLead(lead: InsertLead): Promise<Lead>;\n  updateLead(id: string, lead: Partial<InsertLead>): Promise<Lead | undefined>;\n  deleteLead(id: string): Promise<boolean>;\n  searchLeads(query: string): Promise<Lead[]>;\n\n  // Lead Activities\n  getLeadActivities(leadId: string): Promise<LeadActivity[]>;\n  getLeadActivity(id: string): Promise<LeadActivity | undefined>;\n  createLeadActivity(activity: InsertLeadActivity): Promise<LeadActivity>;\n  updateLeadActivity(id: string, activity: Partial<InsertLeadActivity>): Promise<LeadActivity | undefined>;\n  deleteLeadActivity(id: string): Promise<boolean>;\n  getTasksByActivityId(activityId: string): Promise<LeadTask[]>;\n\n  // Lead Tasks\n  getLeadTasks(leadId: string): Promise<LeadTask[]>;\n  getAllLeadTasks(): Promise<LeadTask[]>;\n  getTasksAssignedToUser(userId: string): Promise<LeadTask[]>;\n  createLeadTask(task: InsertLeadTask): Promise<LeadTask>;\n  updateLeadTask(id: string, task: Partial<InsertLeadTask>): Promise<LeadTask | undefined>;\n  deleteLeadTask(id: string): Promise<boolean>;\n\n  // Staff Leave Balances\n  getStaffLeaveBalance(userId: string): Promise<StaffLeaveBalance | undefined>;\n  createStaffLeaveBalance(balance: InsertStaffLeaveBalance): Promise<StaffLeaveBalance>;\n  updateStaffLeaveBalance(userId: string, balance: Partial<InsertStaffLeaveBalance>): Promise<StaffLeaveBalance | undefined>;\n  \n  // Role-Based KPIs\n  getRoleBasedKpis(role: string, userId: string): Promise<{ label: string; value: string | number; trend?: string }[]>;\n\n  // Fence Styles\n  getFenceStyle(id: string): Promise<FenceStyle | undefined>;\n  getFenceStyles(): Promise<FenceStyle[]>;\n  createFenceStyle(style: InsertFenceStyle): Promise<FenceStyle>;\n  updateFenceStyle(id: string, style: Partial<InsertFenceStyle>): Promise<FenceStyle | undefined>;\n\n  // Products\n  getProduct(id: string): Promise<Product | undefined>;\n  getProductBySku(sku: string): Promise<Product | undefined>;\n  getProducts(): Promise<Product[]>;\n  getProductsByCategory(category: string): Promise<Product[]>;\n  getLowStockProducts(): Promise<Product[]>;\n  createProduct(product: InsertProduct): Promise<Product>;\n  updateProduct(id: string, product: Partial<InsertProduct>): Promise<Product | undefined>;\n  updateStock(id: string, quantity: number): Promise<Product | undefined>;\n  deleteProduct(id: string): Promise<boolean>;\n\n  // Quotes\n  getQuote(id: string): Promise<Quote | undefined>;\n  getQuoteByNumber(quoteNumber: string): Promise<Quote | undefined>;\n  getQuotes(): Promise<Quote[]>;\n  getQuotesByClient(clientId: string): Promise<Quote[]>;\n  getQuotesByStatus(status: string): Promise<Quote[]>;\n  createQuote(quote: InsertQuote): Promise<Quote>;\n  updateQuote(id: string, quote: Partial<InsertQuote>): Promise<Quote | undefined>;\n  deleteQuote(id: string): Promise<boolean>;\n  getNextQuoteNumber(): Promise<string>;\n  searchQuotes(query: string): Promise<Quote[]>;\n\n  // Jobs\n  getJob(id: string): Promise<Job | undefined>;\n  getJobByNumber(jobNumber: string): Promise<Job | undefined>;\n  getJobs(): Promise<Job[]>;\n  getJobsByClient(clientId: string): Promise<Job[]>;\n  getJobsByStatus(status: string): Promise<Job[]>;\n  getJobsByInstaller(installerId: string): Promise<Job[]>;\n  createJob(job: InsertJob): Promise<Job>;\n  createDirectJob(data: { clientId: string; jobType: \"supply_only\" | \"supply_install\"; siteAddress: string; notes?: string; totalAmount?: number }): Promise<{ lead: Lead; job: Job }>;\n  updateJob(id: string, job: Partial<InsertJob>): Promise<Job | undefined>;\n  getNextJobNumber(): Promise<string>;\n  searchJobs(query: string): Promise<Job[]>;\n  deleteJob(id: string): Promise<boolean>;\n\n  // BOM\n  getBOM(id: string): Promise<BOM | undefined>;\n  getBOMByJob(jobId: string): Promise<BOM | undefined>;\n  createBOM(bomData: InsertBOM): Promise<BOM>;\n  updateBOM(id: string, bomData: Partial<InsertBOM>): Promise<BOM | undefined>;\n\n  // Production Tasks\n  getProductionTask(id: string): Promise<ProductionTask | undefined>;\n  getProductionTasks(): Promise<ProductionTask[]>;\n  getProductionTasksByJob(jobId: string): Promise<ProductionTask[]>;\n  getProductionTasksByAssignee(userId: string): Promise<ProductionTask[]>;\n  getProductionTasksByStatus(status: string): Promise<ProductionTask[]>;\n  createProductionTask(task: InsertProductionTask): Promise<ProductionTask>;\n  updateProductionTask(id: string, task: Partial<InsertProductionTask>): Promise<ProductionTask | undefined>;\n\n  // Install Tasks\n  getInstallTask(id: string): Promise<InstallTask | undefined>;\n  getInstallTasks(): Promise<InstallTask[]>;\n  getInstallTasksByJob(jobId: string): Promise<InstallTask[]>;\n  getInstallTasksByInstaller(installerId: string): Promise<InstallTask[]>;\n  getInstallTasksByDate(date: Date): Promise<InstallTask[]>;\n  createInstallTask(task: InsertInstallTask): Promise<InstallTask>;\n  updateInstallTask(id: string, task: Partial<InsertInstallTask>): Promise<InstallTask | undefined>;\n\n  // Schedule Events\n  getScheduleEvent(id: string): Promise<ScheduleEvent | undefined>;\n  getScheduleEvents(): Promise<ScheduleEvent[]>;\n  getScheduleEventsByDateRange(start: Date, end: Date): Promise<ScheduleEvent[]>;\n  getScheduleEventsByAssignee(userId: string): Promise<ScheduleEvent[]>;\n  createScheduleEvent(event: InsertScheduleEvent): Promise<ScheduleEvent>;\n  updateScheduleEvent(id: string, event: Partial<InsertScheduleEvent>): Promise<ScheduleEvent | undefined>;\n  deleteScheduleEvent(id: string): Promise<boolean>;\n\n  // Payments\n  getPayment(id: string): Promise<Payment | undefined>;\n  getPayments(): Promise<Payment[]>;\n  getPaymentsByClient(clientId: string): Promise<Payment[]>;\n  getPaymentsByJob(jobId: string): Promise<Payment[]>;\n  getPendingPayments(): Promise<Payment[]>;\n  createPayment(payment: InsertPayment): Promise<Payment>;\n  updatePayment(id: string, payment: Partial<InsertPayment>): Promise<Payment | undefined>;\n\n  // Notifications\n  getNotification(id: string): Promise<Notification | undefined>;\n  getNotificationsByUser(userId: string): Promise<Notification[]>;\n  getUnreadNotifications(userId: string): Promise<Notification[]>;\n  createNotification(notification: InsertNotification): Promise<Notification>;\n  markNotificationRead(id: string): Promise<Notification | undefined>;\n  markAllNotificationsRead(userId: string): Promise<void>;\n\n  // SMS Logs\n  getSMSLog(id: string): Promise<SMSLog | undefined>;\n  getSMSLogs(): Promise<SMSLog[]>;\n  getSMSLogsByPhone(phone: string): Promise<SMSLog[]>;\n  getSMSLogsByEntity(entityType: string, entityId: string): Promise<SMSLog[]>;\n  createSMSLog(log: InsertSMSLog): Promise<SMSLog>;\n  updateSMSLog(id: string, log: Partial<InsertSMSLog>): Promise<SMSLog | undefined>;\n  markMessagesRead(messageIds: string[]): Promise<void>;\n  getUnreadMessageCount(): Promise<number>;\n  \n  // SMS Conversations\n  getSMSConversation(id: string): Promise<SMSConversation | undefined>;\n  getSMSConversationByPhone(phone: string): Promise<SMSConversation | undefined>;\n  getSMSConversations(): Promise<SMSConversation[]>;\n  getUnresolvedConversations(): Promise<SMSConversation[]>;\n  createSMSConversation(conversation: InsertSMSConversation): Promise<SMSConversation>;\n  updateSMSConversation(id: string, conversation: Partial<InsertSMSConversation>): Promise<SMSConversation | undefined>;\n  getOrCreateConversation(phone: string): Promise<SMSConversation>;\n  findClientByPhone(phone: string): Promise<Client | undefined>;\n  \n  // Message Ranges\n  getMessageRange(id: string): Promise<MessageRange | undefined>;\n  getMessageRangesByConversation(conversationId: string): Promise<MessageRange[]>;\n  getMessageRangesByLead(leadId: string): Promise<MessageRange[]>;\n  getMessageRangesByJob(jobId: string): Promise<MessageRange[]>;\n  createMessageRange(range: InsertMessageRange): Promise<MessageRange>;\n  deleteMessageRange(id: string): Promise<boolean>;\n\n  // Activity Logs\n  getActivityLogs(): Promise<ActivityLog[]>;\n  getActivityLogsByUser(userId: string): Promise<ActivityLog[]>;\n  getActivityLogsByEntity(entityType: string, entityId: string): Promise<ActivityLog[]>;\n  createActivityLog(log: InsertActivityLog): Promise<ActivityLog>;\n\n  // Documents\n  getDocument(id: string): Promise<Document | undefined>;\n  getDocumentsByClient(clientId: string): Promise<Document[]>;\n  getDocumentsByJob(jobId: string): Promise<Document[]>;\n  createDocument(doc: InsertDocument): Promise<Document>;\n  deleteDocument(id: string): Promise<boolean>;\n\n  // Quote Follow-ups\n  getQuoteFollowUp(id: string): Promise<QuoteFollowUp | undefined>;\n  getQuoteFollowUpsByQuote(quoteId: string): Promise<QuoteFollowUp[]>;\n  getPendingFollowUps(): Promise<QuoteFollowUp[]>;\n  getFollowUpsByAssignee(userId: string): Promise<QuoteFollowUp[]>;\n  createQuoteFollowUp(followUp: InsertQuoteFollowUp): Promise<QuoteFollowUp>;\n  updateQuoteFollowUp(id: string, followUp: Partial<InsertQuoteFollowUp>): Promise<QuoteFollowUp | undefined>;\n  deleteQuoteFollowUp(id: string): Promise<boolean>;\n\n  // Automation Campaigns\n  getAutomationCampaign(id: string): Promise<AutomationCampaign | undefined>;\n  getAutomationCampaigns(): Promise<AutomationCampaign[]>;\n  getActiveCampaigns(): Promise<AutomationCampaign[]>;\n  getCampaignsByTrigger(trigger: string): Promise<AutomationCampaign[]>;\n  createAutomationCampaign(campaign: InsertAutomationCampaign): Promise<AutomationCampaign>;\n  updateAutomationCampaign(id: string, campaign: Partial<InsertAutomationCampaign>): Promise<AutomationCampaign | undefined>;\n  deleteAutomationCampaign(id: string): Promise<boolean>;\n\n  // Campaign Enrollments\n  getCampaignEnrollment(id: string): Promise<CampaignEnrollment | undefined>;\n  getCampaignEnrollmentsByCampaign(campaignId: string): Promise<CampaignEnrollment[]>;\n  getCampaignEnrollmentsByClient(clientId: string): Promise<CampaignEnrollment[]>;\n  getPendingEnrollments(): Promise<CampaignEnrollment[]>;\n  createCampaignEnrollment(enrollment: InsertCampaignEnrollment): Promise<CampaignEnrollment>;\n  updateCampaignEnrollment(id: string, enrollment: Partial<InsertCampaignEnrollment>): Promise<CampaignEnrollment | undefined>;\n  cancelCampaignEnrollment(id: string, reason: string): Promise<CampaignEnrollment | undefined>;\n\n  // Dashboard Stats\n  getDashboardStats(): Promise<DashboardStats>;\n  \n  // Quote Analytics\n  getQuoteAnalytics(): Promise<QuoteAnalytics>;\n\n  // Core Analytics (standardized KPIs)\n  getCoreAnalytics(startDate?: Date, endDate?: Date): Promise<CoreAnalytics>;\n  getLeadAnalytics(startDate?: Date, endDate?: Date): Promise<LeadAnalytics>;\n  getSalesAnalytics(startDate?: Date, endDate?: Date): Promise<SalesAnalytics>;\n\n  // ============================================\n  // PROFIT & LOSS COST TRACKING\n  // ============================================\n  \n  // Staff Rate Cards\n  getStaffRateCard(id: string): Promise<StaffRateCard | undefined>;\n  getStaffRateCards(): Promise<StaffRateCard[]>;\n  getStaffRateCardsByUser(userId: string): Promise<StaffRateCard[]>;\n  getActiveRateByType(userId: string, rateType: string): Promise<StaffRateCard | undefined>;\n  createStaffRateCard(rateCard: InsertStaffRateCard): Promise<StaffRateCard>;\n  updateStaffRateCard(id: string, rateCard: Partial<InsertStaffRateCard>): Promise<StaffRateCard | undefined>;\n  deleteStaffRateCard(id: string): Promise<boolean>;\n\n  // Quote Cost Components\n  getQuoteCostComponent(id: string): Promise<QuoteCostComponent | undefined>;\n  getQuoteCostComponentsByQuote(quoteId: string): Promise<QuoteCostComponent[]>;\n  getQuoteCostComponentsByJob(jobId: string): Promise<QuoteCostComponent[]>;\n  createQuoteCostComponent(component: InsertQuoteCostComponent): Promise<QuoteCostComponent>;\n  updateQuoteCostComponent(id: string, component: Partial<InsertQuoteCostComponent>): Promise<QuoteCostComponent | undefined>;\n  deleteQuoteCostComponent(id: string): Promise<boolean>;\n\n  // Quote Trips\n  getQuoteTrip(id: string): Promise<QuoteTrip | undefined>;\n  getQuoteTripsByQuote(quoteId: string): Promise<QuoteTrip[]>;\n  getQuoteTripsByJob(jobId: string): Promise<QuoteTrip[]>;\n  getQuoteTripsByStaff(staffId: string): Promise<QuoteTrip[]>;\n  createQuoteTrip(trip: InsertQuoteTrip): Promise<QuoteTrip>;\n  updateQuoteTrip(id: string, trip: Partial<InsertQuoteTrip>): Promise<QuoteTrip | undefined>;\n  deleteQuoteTrip(id: string): Promise<boolean>;\n\n  // Quote Admin Time\n  getQuoteAdminTime(id: string): Promise<QuoteAdminTime | undefined>;\n  getQuoteAdminTimeByQuote(quoteId: string): Promise<QuoteAdminTime[]>;\n  getQuoteAdminTimeByJob(jobId: string): Promise<QuoteAdminTime[]>;\n  getQuoteAdminTimeByStaff(staffId: string): Promise<QuoteAdminTime[]>;\n  createQuoteAdminTime(adminTime: InsertQuoteAdminTime): Promise<QuoteAdminTime>;\n  updateQuoteAdminTime(id: string, adminTime: Partial<InsertQuoteAdminTime>): Promise<QuoteAdminTime | undefined>;\n  deleteQuoteAdminTime(id: string): Promise<boolean>;\n\n  // Travel Sessions\n  getTravelSession(id: string): Promise<TravelSession | undefined>;\n  getTravelSessionsByTrip(tripId: string): Promise<TravelSession[]>;\n  getActiveTravelSessions(): Promise<TravelSession[]>;\n  createTravelSession(session: InsertTravelSession): Promise<TravelSession>;\n  updateTravelSession(id: string, session: Partial<InsertTravelSession>): Promise<TravelSession | undefined>;\n\n  // Quote Ground Conditions\n  getQuoteGroundCondition(id: string): Promise<QuoteGroundCondition | undefined>;\n  getQuoteGroundConditionsByQuote(quoteId: string): Promise<QuoteGroundCondition[]>;\n  createQuoteGroundCondition(condition: InsertQuoteGroundCondition): Promise<QuoteGroundCondition>;\n  updateQuoteGroundCondition(id: string, condition: Partial<InsertQuoteGroundCondition>): Promise<QuoteGroundCondition | undefined>;\n  deleteQuoteGroundCondition(id: string): Promise<boolean>;\n\n  // Quote P&L Summary\n  getQuotePLSummary(id: string): Promise<QuotePLSummary | undefined>;\n  getQuotePLSummaryByQuote(quoteId: string): Promise<QuotePLSummary | undefined>;\n  getQuotePLSummaryByJob(jobId: string): Promise<QuotePLSummary | undefined>;\n  createQuotePLSummary(summary: InsertQuotePLSummary): Promise<QuotePLSummary>;\n  updateQuotePLSummary(id: string, summary: Partial<InsertQuotePLSummary>): Promise<QuotePLSummary | undefined>;\n  recalculateQuotePLSummary(quoteId: string): Promise<QuotePLSummary | undefined>;\n\n  // ============================================\n  // ORGANISATION HUB\n  // ============================================\n\n  // Departments\n  getDepartment(id: string): Promise<Department | undefined>;\n  getDepartments(): Promise<Department[]>;\n  createDepartment(department: InsertDepartment): Promise<Department>;\n  updateDepartment(id: string, department: Partial<InsertDepartment>): Promise<Department | undefined>;\n  deleteDepartment(id: string): Promise<boolean>;\n\n  // Workflows\n  getWorkflow(id: string): Promise<Workflow | undefined>;\n  getWorkflows(): Promise<Workflow[]>;\n  getWorkflowsByDepartment(departmentId: string): Promise<Workflow[]>;\n  getWorkflowsByCategory(category: string): Promise<Workflow[]>;\n  getActiveWorkflows(): Promise<Workflow[]>;\n  createWorkflow(workflow: InsertWorkflow): Promise<Workflow>;\n  updateWorkflow(id: string, workflow: Partial<InsertWorkflow>): Promise<Workflow | undefined>;\n  deleteWorkflow(id: string): Promise<boolean>;\n\n  // Workflow Versions\n  getWorkflowVersion(id: string): Promise<WorkflowVersion | undefined>;\n  getWorkflowVersionsByWorkflow(workflowId: string): Promise<WorkflowVersion[]>;\n  getLatestWorkflowVersion(workflowId: string): Promise<WorkflowVersion | undefined>;\n  createWorkflowVersion(version: InsertWorkflowVersion): Promise<WorkflowVersion>;\n  updateWorkflowVersion(id: string, version: Partial<InsertWorkflowVersion>): Promise<WorkflowVersion | undefined>;\n\n  // Policies\n  getPolicy(id: string): Promise<Policy | undefined>;\n  getPolicies(): Promise<Policy[]>;\n  getPoliciesByDepartment(departmentId: string): Promise<Policy[]>;\n  getPoliciesByCategory(category: string): Promise<Policy[]>;\n  getActivePolicies(): Promise<Policy[]>;\n  createPolicy(policy: InsertPolicy): Promise<Policy>;\n  updatePolicy(id: string, policy: Partial<InsertPolicy>): Promise<Policy | undefined>;\n  deletePolicy(id: string): Promise<boolean>;\n\n  // Policy Versions\n  getPolicyVersion(id: string): Promise<PolicyVersion | undefined>;\n  getPolicyVersionsByPolicy(policyId: string): Promise<PolicyVersion[]>;\n  getLatestPolicyVersion(policyId: string): Promise<PolicyVersion | undefined>;\n  createPolicyVersion(version: InsertPolicyVersion): Promise<PolicyVersion>;\n  updatePolicyVersion(id: string, version: Partial<InsertPolicyVersion>): Promise<PolicyVersion | undefined>;\n\n  // Policy Acknowledgements\n  getPolicyAcknowledgement(id: string): Promise<PolicyAcknowledgement | undefined>;\n  getPolicyAcknowledgementsByPolicy(policyId: string): Promise<PolicyAcknowledgement[]>;\n  getPolicyAcknowledgementsByUser(userId: string): Promise<PolicyAcknowledgement[]>;\n  hasUserAcknowledgedPolicy(userId: string, policyVersionId: string): Promise<boolean>;\n  createPolicyAcknowledgement(acknowledgement: InsertPolicyAcknowledgement): Promise<PolicyAcknowledgement>;\n\n  // Resources\n  getResource(id: string): Promise<Resource | undefined>;\n  getResources(): Promise<Resource[]>;\n  getResourcesByDepartment(departmentId: string): Promise<Resource[]>;\n  searchResources(query: string): Promise<Resource[]>;\n  createResource(resource: InsertResource): Promise<Resource>;\n  updateResource(id: string, resource: Partial<InsertResource>): Promise<Resource | undefined>;\n  deleteResource(id: string): Promise<boolean>;\n\n  // Knowledge Articles\n  getKnowledgeArticle(id: string): Promise<KnowledgeArticle | undefined>;\n  getKnowledgeArticleBySlug(slug: string): Promise<KnowledgeArticle | undefined>;\n  getKnowledgeArticles(): Promise<KnowledgeArticle[]>;\n  getPublishedKnowledgeArticles(): Promise<KnowledgeArticle[]>;\n  getKnowledgeArticlesByDepartment(departmentId: string): Promise<KnowledgeArticle[]>;\n  searchKnowledgeArticles(query: string): Promise<KnowledgeArticle[]>;\n  createKnowledgeArticle(article: InsertKnowledgeArticle): Promise<KnowledgeArticle>;\n  updateKnowledgeArticle(id: string, article: Partial<InsertKnowledgeArticle>): Promise<KnowledgeArticle | undefined>;\n  deleteKnowledgeArticle(id: string): Promise<boolean>;\n\n  // ============================================\n  // JOB SETUP DOCUMENTS\n  // ============================================\n\n  // Live Document Templates\n  getLiveDocumentTemplate(id: string): Promise<LiveDocumentTemplate | undefined>;\n  getLiveDocumentTemplates(): Promise<LiveDocumentTemplate[]>;\n  getActiveLiveDocumentTemplates(): Promise<LiveDocumentTemplate[]>;\n  getDefaultLiveDocumentTemplate(): Promise<LiveDocumentTemplate | undefined>;\n  createLiveDocumentTemplate(template: InsertLiveDocumentTemplate): Promise<LiveDocumentTemplate>;\n  updateLiveDocumentTemplate(id: string, template: Partial<InsertLiveDocumentTemplate>): Promise<LiveDocumentTemplate | undefined>;\n  deleteLiveDocumentTemplate(id: string): Promise<boolean>;\n\n  // Job Setup Documents\n  getJobSetupDocument(id: string): Promise<JobSetupDocument | undefined>;\n  getJobSetupDocumentByJob(jobId: string): Promise<JobSetupDocument | undefined>;\n  getJobSetupDocumentByLead(leadId: string): Promise<JobSetupDocument | undefined>;\n  getJobSetupDocuments(): Promise<JobSetupDocument[]>;\n  getJobSetupDocumentsByStatus(status: string): Promise<JobSetupDocument[]>;\n  createJobSetupDocument(document: InsertJobSetupDocument): Promise<JobSetupDocument>;\n  updateJobSetupDocument(id: string, document: Partial<InsertJobSetupDocument>): Promise<JobSetupDocument | undefined>;\n  deleteJobSetupDocument(id: string): Promise<boolean>;\n  \n  // Section-specific updates\n  updateJobSetupSection1(id: string, section: JobSetupSection1Sales): Promise<JobSetupDocument | undefined>;\n  updateJobSetupSection2Meta(id: string, section: JobSetupSection2ProductsMeta): Promise<JobSetupDocument | undefined>;\n  updateJobSetupSection3(id: string, section: JobSetupSection3Production): Promise<JobSetupDocument | undefined>;\n  updateJobSetupSection4(id: string, section: JobSetupSection4Schedule): Promise<JobSetupDocument | undefined>;\n  updateJobSetupSection5(id: string, section: JobSetupSection5Install): Promise<JobSetupDocument | undefined>;\n  \n  // Section completion\n  markSectionComplete(id: string, sectionNumber: 1 | 2 | 3 | 4 | 5, complete: boolean): Promise<JobSetupDocument | undefined>;\n  recalculateDocumentStatus(id: string): Promise<JobSetupDocument | undefined>;\n  \n  // Job Setup Products (BOM items)\n  getJobSetupProduct(id: string): Promise<JobSetupProduct | undefined>;\n  getJobSetupProductsByDocument(documentId: string): Promise<JobSetupProduct[]>;\n  createJobSetupProduct(product: InsertJobSetupProduct): Promise<JobSetupProduct>;\n  createJobSetupProducts(products: InsertJobSetupProduct[]): Promise<JobSetupProduct[]>;\n  updateJobSetupProduct(id: string, product: Partial<InsertJobSetupProduct>): Promise<JobSetupProduct | undefined>;\n  deleteJobSetupProduct(id: string): Promise<boolean>;\n  deleteJobSetupProductsByDocument(documentId: string): Promise<boolean>;\n  \n  // Seed products from quote\n  seedJobSetupProductsFromQuote(documentId: string, quoteId: string): Promise<JobSetupProduct[]>;\n\n  // ============================================\n  // DASHBOARD BUILDER\n  // ============================================\n\n  // Dashboard Widgets (library)\n  getDashboardWidget(id: string): Promise<DashboardWidget | undefined>;\n  getDashboardWidgets(): Promise<DashboardWidget[]>;\n  getDashboardWidgetsByCategory(category: string): Promise<DashboardWidget[]>;\n  getActiveWidgets(): Promise<DashboardWidget[]>;\n  createDashboardWidget(widget: InsertDashboardWidget): Promise<DashboardWidget>;\n  updateDashboardWidget(id: string, widget: Partial<InsertDashboardWidget>): Promise<DashboardWidget | undefined>;\n\n  // Role Dashboard Layouts\n  getRoleDashboardLayout(id: string): Promise<RoleDashboardLayout | undefined>;\n  getRoleDashboardLayouts(): Promise<RoleDashboardLayout[]>;\n  getRoleDashboardLayoutsByRole(role: string): Promise<RoleDashboardLayout[]>;\n  getPublishedLayoutForRole(role: string): Promise<RoleDashboardLayout | undefined>;\n  getDefaultLayoutForRole(role: string): Promise<RoleDashboardLayout | undefined>;\n  createRoleDashboardLayout(layout: InsertRoleDashboardLayout): Promise<RoleDashboardLayout>;\n  updateRoleDashboardLayout(id: string, layout: Partial<InsertRoleDashboardLayout>): Promise<RoleDashboardLayout | undefined>;\n  deleteRoleDashboardLayout(id: string): Promise<boolean>;\n  publishRoleDashboardLayout(id: string): Promise<RoleDashboardLayout | undefined>;\n\n  // Dashboard Widget Instances\n  getDashboardWidgetInstance(id: string): Promise<DashboardWidgetInstance | undefined>;\n  getDashboardWidgetInstancesByLayout(layoutId: string): Promise<DashboardWidgetInstance[]>;\n  createDashboardWidgetInstance(instance: InsertDashboardWidgetInstance): Promise<DashboardWidgetInstance>;\n  updateDashboardWidgetInstance(id: string, instance: Partial<InsertDashboardWidgetInstance>): Promise<DashboardWidgetInstance | undefined>;\n  deleteDashboardWidgetInstance(id: string): Promise<boolean>;\n  deleteDashboardWidgetInstancesByLayout(layoutId: string): Promise<boolean>;\n  saveDashboardLayout(layoutId: string, instances: InsertDashboardWidgetInstance[]): Promise<DashboardWidgetInstance[]>;\n\n  // ============================================\n  // BANKING / FINANCIAL\n  // ============================================\n\n  // Bank Connections\n  getBankConnections(): Promise<BankConnection[]>;\n  getBankConnectionById(id: string): Promise<BankConnection | undefined>;\n  getBankConnectionByInstitution(institutionId: string): Promise<BankConnection | undefined>;\n  createBankConnection(connection: InsertBankConnection): Promise<BankConnection>;\n  updateBankConnection(id: string, connection: Partial<InsertBankConnection>): Promise<BankConnection | undefined>;\n  deleteBankConnection(id: string): Promise<boolean>;\n\n  // Bank Accounts\n  getBankAccounts(): Promise<BankAccount[]>;\n  getBankAccountsByConnection(connectionId: string): Promise<BankAccount[]>;\n  getBankAccountById(id: string): Promise<BankAccount | undefined>;\n  getBankAccountByName(name: string): Promise<BankAccount | undefined>;\n  createBankAccount(account: InsertBankAccount): Promise<BankAccount>;\n  updateBankAccount(id: string, account: Partial<InsertBankAccount>): Promise<BankAccount | undefined>;\n  deleteBankAccount(id: string): Promise<boolean>;\n\n  // Bank Transactions\n  getBankTransactions(accountId: string, filters?: TransactionFilters): Promise<BankTransaction[]>;\n  getAllBankTransactions(filters?: TransactionFilters): Promise<BankTransaction[]>;\n  getBankTransactionById(id: string): Promise<BankTransaction | undefined>;\n  createBankTransaction(transaction: InsertBankTransaction): Promise<BankTransaction>;\n  createBankTransactions(transactions: InsertBankTransaction[]): Promise<BankTransaction[]>;\n  updateBankTransaction(id: string, transaction: Partial<InsertBankTransaction>): Promise<BankTransaction | undefined>;\n  getTransactionsByStaff(staffId: string, filters?: TransactionFilters): Promise<BankTransaction[]>;\n  getStaffTransactionSummary(): Promise<{ staffId: string; staffName: string; totalSpent: number; transactionCount: number }[]>;\n  autoAllocateTransactionsByCardNumber(): Promise<number>;\n  autoCategorizeTransactionsByKeywords(): Promise<number>;\n\n  // Expense Categories\n  getExpenseCategories(): Promise<ExpenseCategory[]>;\n  getActiveExpenseCategories(): Promise<ExpenseCategory[]>;\n  getExpenseCategory(id: string): Promise<ExpenseCategory | undefined>;\n  createExpenseCategory(category: InsertExpenseCategory): Promise<ExpenseCategory>;\n  updateExpenseCategory(id: string, category: Partial<InsertExpenseCategory>): Promise<ExpenseCategory | undefined>;\n  deleteExpenseCategory(id: string): Promise<boolean>;\n\n  // Receipt Submissions\n  getReceiptSubmissions(filters?: { status?: string }): Promise<ReceiptSubmission[]>;\n  getReceiptSubmission(id: string): Promise<ReceiptSubmission | undefined>;\n  getReceiptSubmissionByToken(token: string): Promise<ReceiptSubmission | undefined>;\n  createReceiptSubmission(submission: InsertReceiptSubmission): Promise<ReceiptSubmission>;\n  updateReceiptSubmission(id: string, submission: Partial<InsertReceiptSubmission>): Promise<ReceiptSubmission | undefined>;\n  deleteReceiptSubmission(id: string): Promise<boolean>;\n  getPendingReceipts(): Promise<ReceiptSubmission[]>;\n  matchReceiptToTransaction(receiptId: string, transactionId: string, reviewedBy: string): Promise<boolean>;\n\n  // ============================================\n  // JOB PIPELINE CONFIGURATION\n  // ============================================\n\n  // Job Pipelines\n  getJobPipeline(id: string): Promise<JobPipeline | undefined>;\n  getJobPipelines(): Promise<JobPipeline[]>;\n  getActiveJobPipelines(): Promise<JobPipeline[]>;\n  createJobPipeline(pipeline: InsertJobPipeline): Promise<JobPipeline>;\n  updateJobPipeline(id: string, pipeline: Partial<InsertJobPipeline>): Promise<JobPipeline | undefined>;\n  deleteJobPipeline(id: string): Promise<boolean>;\n\n  // Job Pipeline Stages\n  getJobPipelineStage(id: string): Promise<JobPipelineStage | undefined>;\n  getJobPipelineStages(pipelineId: string): Promise<JobPipelineStage[]>;\n  createJobPipelineStage(stage: InsertJobPipelineStage): Promise<JobPipelineStage>;\n  updateJobPipelineStage(id: string, stage: Partial<InsertJobPipelineStage>): Promise<JobPipelineStage | undefined>;\n  deleteJobPipelineStage(id: string): Promise<boolean>;\n  reorderJobPipelineStages(pipelineId: string, stageIds: string[]): Promise<boolean>;\n\n  // Job Stage Completions\n  getJobStageCompletions(jobId: string): Promise<JobStageCompletion[]>;\n  toggleJobStageCompletion(jobId: string, stageId: string, userId?: string): Promise<{ completed: boolean }>;\n\n  // Kanban Columns\n  getKanbanColumns(): Promise<KanbanColumn[]>;\n  getKanbanColumn(id: string): Promise<KanbanColumn | undefined>;\n  createKanbanColumn(column: InsertKanbanColumn): Promise<KanbanColumn>;\n  updateKanbanColumn(id: string, column: Partial<InsertKanbanColumn>): Promise<KanbanColumn | undefined>;\n  deleteKanbanColumn(id: string): Promise<boolean>;\n  reorderKanbanColumns(columnIds: string[]): Promise<boolean>;\n\n  // Job Statuses\n  getJobStatuses(): Promise<JobStatus[]>;\n  getJobStatus(id: string): Promise<JobStatus | undefined>;\n  createJobStatus(status: InsertJobStatus): Promise<JobStatus>;\n  updateJobStatus(id: string, status: Partial<InsertJobStatus>): Promise<JobStatus | undefined>;\n  deleteJobStatus(id: string): Promise<boolean>;\n  reorderJobStatuses(statusIds: string[]): Promise<boolean>;\n\n  // Job Status Dependencies\n  getStatusDependencies(statusKey: string): Promise<JobStatusDependency[]>;\n  getAllStatusDependencies(): Promise<JobStatusDependency[]>;\n  setStatusDependencies(statusKey: string, dependencies: { prerequisiteKey: string; dependencyType: string }[]): Promise<boolean>;\n\n  // Production Stages\n  getProductionStages(): Promise<ProductionStage[]>;\n  getProductionStage(id: string): Promise<ProductionStage | undefined>;\n  createProductionStage(stage: InsertProductionStage): Promise<ProductionStage>;\n  updateProductionStage(id: string, stage: Partial<InsertProductionStage>): Promise<ProductionStage | undefined>;\n  deleteProductionStage(id: string): Promise<boolean>;\n  reorderProductionStages(stageIds: string[]): Promise<boolean>;\n\n  // ============================================\n  // VOICE CALLS & AI COACHING\n  // ============================================\n\n  // Voice Calls\n  getVoiceCall(id: string): Promise<VoiceCall | undefined>;\n  getVoiceCallBySid(twilioCallSid: string): Promise<VoiceCall | undefined>;\n  getVoiceCalls(): Promise<VoiceCall[]>;\n  getActiveVoiceCalls(): Promise<VoiceCall[]>;\n  getVoiceCallsByStaff(userId: string): Promise<VoiceCall[]>;\n  getVoiceCallsByClient(clientId: string): Promise<VoiceCall[]>;\n  getVoiceCallsByLead(leadId: string): Promise<VoiceCall[]>;\n  createVoiceCall(call: InsertVoiceCall): Promise<VoiceCall>;\n  updateVoiceCall(id: string, call: Partial<InsertVoiceCall>): Promise<VoiceCall | undefined>;\n\n  // Call Transcripts\n  getCallTranscripts(callId: string): Promise<CallTranscript[]>;\n  createCallTranscript(transcript: InsertCallTranscript): Promise<CallTranscript>;\n  createCallTranscripts(transcripts: InsertCallTranscript[]): Promise<CallTranscript[]>;\n\n  // Sales Checklist Items\n  getSalesChecklistItem(id: string): Promise<SalesChecklistItem | undefined>;\n  getSalesChecklistItems(): Promise<SalesChecklistItem[]>;\n  getActiveSalesChecklistItems(): Promise<SalesChecklistItem[]>;\n  createSalesChecklistItem(item: InsertSalesChecklistItem): Promise<SalesChecklistItem>;\n  updateSalesChecklistItem(id: string, item: Partial<InsertSalesChecklistItem>): Promise<SalesChecklistItem | undefined>;\n  deleteSalesChecklistItem(id: string): Promise<boolean>;\n  reorderSalesChecklistItems(itemIds: string[]): Promise<boolean>;\n\n  // Call Checklist Status\n  getCallChecklistStatus(callId: string): Promise<CallChecklistStatus[]>;\n  initializeCallChecklistStatus(callId: string): Promise<CallChecklistStatus[]>;\n  updateCallChecklistItemStatus(callId: string, checklistItemId: string, isCovered: boolean, detectedText?: string): Promise<CallChecklistStatus | undefined>;\n\n  // Call Coaching Prompts\n  getCallCoachingPrompts(callId: string): Promise<CallCoachingPrompt[]>;\n  createCallCoachingPrompt(prompt: InsertCallCoachingPrompt): Promise<CallCoachingPrompt>;\n  acknowledgeCallCoachingPrompt(id: string): Promise<CallCoachingPrompt | undefined>;\n}\n\nexport interface TransactionFilters {\n  fromDate?: string;\n  toDate?: string;\n  category?: string;\n  direction?: \"credit\" | \"debit\";\n  limit?: number;\n  offset?: number;\n  search?: string;\n  minAmount?: number;\n  maxAmount?: number;\n}\n\nexport interface DashboardStats {\n  newLeadsCount: number;\n  quotesAwaitingFollowUp: number;\n  jobsInProduction: number;\n  jobsReadyForInstall: number;\n  todayInstalls: number;\n  pendingPaymentsTotal: number;\n}\n\nexport interface QuoteAnalytics {\n  totalQuotes: number;\n  sentQuotes: number;\n  approvedQuotes: number;\n  declinedQuotes: number;\n  pendingQuotes: number;\n  conversionRate: number;\n  totalValue: number;\n  averageQuoteValue: number;\n  quotesThisWeek: number;\n  quotesLastWeek: number;\n  quotesByStatus: { status: string; count: number }[];\n  quotesByCreator: { userId: string; userName: string; total: number; approved: number; declined: number }[];\n  recentQuotes: Quote[];\n  pipelineValue: number;\n  wonValue: number;\n}\n\n// ============================================\n// CORE ANALYTICS INTERFACES\n// ============================================\n\nexport interface DateRange {\n  startDate: Date;\n  endDate: Date;\n}\n\nexport interface LeadAnalytics {\n  newLeads: number;\n  totalActiveLeads: number;\n  leadsByStage: { stage: string; count: number }[];\n  leadsBySource: { source: string; count: number }[];\n  averageTimeToFirstResponse: number | null; // in hours\n  averageTimeToQuote: number | null; // in hours\n  averageTimeToClose: number | null; // in days\n  leadsByAssignee: { userId: string; userName: string; count: number }[];\n}\n\nexport interface SalesAnalytics {\n  pendingQuotes: number;\n  quoteConversionRate: number; // Won Leads  Leads that received quotes\n  averageDealSize: number; // Mean value of accepted quotes\n  quotePipelineValue: number; // Sum of sent quotes\n  monthlyRevenue: number; // Sum of paid invoices\n  yearToDateRevenue: number;\n  wonValue: number; // Value of won quotes in period\n  lostValue: number; // Value of lost quotes in period\n}\n\nexport interface CoreAnalytics {\n  leads: LeadAnalytics;\n  sales: SalesAnalytics;\n  dateRange: DateRange;\n}\n\nexport class DatabaseStorage implements IStorage {\n  // Users\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user;\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.username, username));\n    return user;\n  }\n\n  async getUserByEmail(email: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.email, email));\n    return user;\n  }\n\n  async createUser(user: InsertUser): Promise<User> {\n    const [created] = await db.insert(users).values(user).returning();\n    return created;\n  }\n\n  async updateUser(id: string, user: Partial<InsertUser>): Promise<User | undefined> {\n    const [updated] = await db.update(users).set(user).where(eq(users.id, id)).returning();\n    return updated;\n  }\n\n  async getUsers(): Promise<User[]> {\n    return db.select().from(users).where(eq(users.isActive, true)).orderBy(users.firstName);\n  }\n\n  async getUsersByRole(role: string): Promise<User[]> {\n    return db.select().from(users).where(and(eq(users.role, role as any), eq(users.isActive, true)));\n  }\n\n  // Clients\n  async getClient(id: string): Promise<Client | undefined> {\n    const [client] = await db.select().from(clients).where(eq(clients.id, id));\n    return client;\n  }\n\n  async getClients(): Promise<Client[]> {\n    return db.select().from(clients).orderBy(desc(clients.createdAt));\n  }\n\n  async getClientsByType(clientType: string): Promise<Client[]> {\n    return db.select().from(clients).where(eq(clients.clientType, clientType as any)).orderBy(clients.name);\n  }\n\n  async checkClientDuplicates(name?: string, email?: string, phone?: string): Promise<Client[]> {\n    const conditions = [];\n    \n    if (name && name.trim()) {\n      conditions.push(ilike(clients.name, `%${name.trim()}%`));\n    }\n    if (email && email.trim()) {\n      conditions.push(ilike(clients.email, `%${email.trim()}%`));\n    }\n    if (phone && phone.trim()) {\n      const normalizedPhone = phone.replace(/\\D/g, '');\n      if (normalizedPhone.length >= 6) {\n        conditions.push(sql`REPLACE(REPLACE(REPLACE(${clients.phone}, ' ', ''), '-', ''), '+', '') LIKE ${'%' + normalizedPhone + '%'}`);\n      }\n    }\n    \n    if (conditions.length === 0) {\n      return [];\n    }\n    \n    return db.select().from(clients).where(or(...conditions)).limit(5);\n  }\n\n  async createClient(client: InsertClient): Promise<Client> {\n    const [created] = await db.insert(clients).values(client).returning();\n    return created;\n  }\n\n  async updateClient(id: string, client: Partial<InsertClient>): Promise<Client | undefined> {\n    const [updated] = await db.update(clients).set(client).where(eq(clients.id, id)).returning();\n    return updated;\n  }\n\n  async deleteClient(id: string): Promise<boolean> {\n    const result = await db.delete(clients).where(eq(clients.id, id));\n    return true;\n  }\n\n  async searchClients(query: string): Promise<Client[]> {\n    return db.select().from(clients).where(\n      or(\n        ilike(clients.name, `%${query}%`),\n        ilike(clients.email, `%${query}%`),\n        ilike(clients.phone, `%${query}%`),\n        ilike(clients.address, `%${query}%`)\n      )\n    );\n  }\n\n  // Leads\n  async getLead(id: string): Promise<Lead | undefined> {\n    const [lead] = await db.select().from(leads).where(eq(leads.id, id));\n    return lead;\n  }\n\n  async getLeads(): Promise<Lead[]> {\n    return db.select().from(leads).orderBy(desc(leads.createdAt));\n  }\n\n  async getLeadsByStage(stage: string): Promise<Lead[]> {\n    return db.select().from(leads).where(eq(leads.stage, stage as any)).orderBy(desc(leads.createdAt));\n  }\n\n  async getLeadsByAssignee(userId: string): Promise<Lead[]> {\n    return db.select().from(leads).where(eq(leads.assignedTo, userId)).orderBy(desc(leads.createdAt));\n  }\n\n  async createLead(lead: InsertLead): Promise<Lead> {\n    const leadNumber = await this.generateLeadNumber();\n    const now = new Date();\n    \n    // Set analytics timestamps based on initial stage\n    const leadData: any = {\n      ...lead,\n      leadNumber,\n    };\n    \n    // If lead is created in a stage past 'new', set timestamps appropriately\n    if (lead.stage && lead.stage !== 'new') {\n      leadData.firstResponseAt = now;\n    }\n    if (lead.stage === 'quote_sent' || lead.stage === 'follow_up') {\n      leadData.quoteSentAt = now;\n    }\n    if (lead.stage === 'won') {\n      leadData.wonAt = now;\n    }\n    if (lead.stage === 'lost') {\n      leadData.lostAt = now;\n    }\n    \n    const [created] = await db.insert(leads).values(leadData).returning();\n    return created;\n  }\n\n  private async generateLeadNumber(): Promise<string> {\n    const [result] = await db.select({ \n      maxNumber: sql<number>`COALESCE(MAX(CAST(SUBSTRING(lead_number FROM 5) AS INTEGER)), 0)` \n    }).from(leads);\n    const nextNum = (result?.maxNumber || 0) + 1;\n    return `PVC-${nextNum.toString().padStart(3, '0')}`;\n  }\n\n  async updateLead(id: string, lead: Partial<InsertLead>): Promise<Lead | undefined> {\n    const now = new Date();\n    const updateData: Partial<InsertLead> & { updatedAt: Date } = {\n      ...lead,\n      updatedAt: now,\n    };\n\n    // Auto-populate analytics timestamps based on stage transitions\n    if (lead.stage) {\n      // Get current lead to check for stage changes\n      const currentLead = await this.getLead(id);\n      if (currentLead) {\n        const oldStage = currentLead.stage;\n        const newStage = lead.stage;\n\n        // First response: when lead moves from 'new' to any other stage\n        if (oldStage === 'new' && newStage !== 'new' && !currentLead.firstResponseAt) {\n          (updateData as any).firstResponseAt = now;\n        }\n\n        // Quote sent: when lead moves to 'quote_sent' stage\n        if (newStage === 'quote_sent' && !currentLead.quoteSentAt) {\n          (updateData as any).quoteSentAt = now;\n        }\n\n        // Won: when lead moves to 'won' stage\n        if (newStage === 'won' && !currentLead.wonAt) {\n          (updateData as any).wonAt = now;\n        }\n\n        // Lost: when lead moves to 'lost' stage\n        if (newStage === 'lost' && !currentLead.lostAt) {\n          (updateData as any).lostAt = now;\n        }\n      }\n    }\n\n    const [updated] = await db.update(leads).set(updateData).where(eq(leads.id, id)).returning();\n    return updated;\n  }\n\n  async deleteLead(id: string): Promise<boolean> {\n    await db.delete(leads).where(eq(leads.id, id));\n    return true;\n  }\n\n  async searchLeads(query: string): Promise<Lead[]> {\n    return db.select().from(leads).where(\n      or(\n        ilike(leads.leadNumber, `%${query}%`),\n        ilike(leads.description, `%${query}%`),\n        ilike(leads.siteAddress, `%${query}%`),\n        ilike(leads.fenceStyle, `%${query}%`)\n      )\n    );\n  }\n\n  // Lead Activities\n  async getLeadActivities(leadId: string): Promise<LeadActivity[]> {\n    return db.select().from(leadActivities)\n      .where(eq(leadActivities.leadId, leadId))\n      .orderBy(desc(leadActivities.createdAt));\n  }\n\n  async getLeadActivity(id: string): Promise<LeadActivity | undefined> {\n    const [activity] = await db.select().from(leadActivities).where(eq(leadActivities.id, id));\n    return activity;\n  }\n\n  async createLeadActivity(activity: InsertLeadActivity): Promise<LeadActivity> {\n    const [newActivity] = await db.insert(leadActivities).values(activity).returning();\n    return newActivity;\n  }\n\n  async updateLeadActivity(id: string, activity: Partial<InsertLeadActivity>): Promise<LeadActivity | undefined> {\n    const [updated] = await db.update(leadActivities)\n      .set(activity)\n      .where(eq(leadActivities.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteLeadActivity(id: string): Promise<boolean> {\n    await db.delete(leadActivities).where(eq(leadActivities.id, id));\n    return true;\n  }\n\n  async getTasksByActivityId(activityId: string): Promise<LeadTask[]> {\n    return db.select().from(leadTasks)\n      .where(eq(leadTasks.sourceActivityId, activityId))\n      .orderBy(desc(leadTasks.createdAt));\n  }\n\n  // Lead Tasks\n  async getLeadTasks(leadId: string): Promise<LeadTask[]> {\n    return db.select().from(leadTasks)\n      .where(eq(leadTasks.leadId, leadId))\n      .orderBy(desc(leadTasks.createdAt));\n  }\n\n  async getAllLeadTasks(): Promise<LeadTask[]> {\n    return db.select().from(leadTasks).orderBy(desc(leadTasks.createdAt));\n  }\n\n  async createLeadTask(task: InsertLeadTask): Promise<LeadTask> {\n    const [newTask] = await db.insert(leadTasks).values(task).returning();\n    return newTask;\n  }\n\n  async updateLeadTask(id: string, task: Partial<InsertLeadTask>): Promise<LeadTask | undefined> {\n    const [updatedTask] = await db.update(leadTasks)\n      .set({ ...task, updatedAt: new Date() })\n      .where(eq(leadTasks.id, id))\n      .returning();\n    return updatedTask;\n  }\n\n  async deleteLeadTask(id: string): Promise<boolean> {\n    const result = await db.delete(leadTasks).where(eq(leadTasks.id, id));\n    return true;\n  }\n\n  async getTasksAssignedToUser(userId: string): Promise<LeadTask[]> {\n    return db.select().from(leadTasks)\n      .where(eq(leadTasks.assignedTo, userId))\n      .orderBy(desc(leadTasks.dueDate));\n  }\n\n  // Staff Leave Balances\n  async getStaffLeaveBalance(userId: string): Promise<StaffLeaveBalance | undefined> {\n    const [balance] = await db.select().from(staffLeaveBalances)\n      .where(eq(staffLeaveBalances.userId, userId));\n    return balance;\n  }\n\n  async createStaffLeaveBalance(balance: InsertStaffLeaveBalance): Promise<StaffLeaveBalance> {\n    const [newBalance] = await db.insert(staffLeaveBalances).values(balance).returning();\n    return newBalance;\n  }\n\n  async updateStaffLeaveBalance(userId: string, balance: Partial<InsertStaffLeaveBalance>): Promise<StaffLeaveBalance | undefined> {\n    const [updated] = await db.update(staffLeaveBalances)\n      .set({ ...balance, updatedAt: new Date() })\n      .where(eq(staffLeaveBalances.userId, userId))\n      .returning();\n    return updated;\n  }\n  \n  // Role-Based KPIs\n  async getRoleBasedKpis(role: string, userId: string): Promise<{ label: string; value: string | number; trend?: string }[]> {\n    const today = new Date();\n    const thisMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);\n    const thisWeekStart = new Date(today);\n    thisWeekStart.setDate(today.getDate() - today.getDay());\n    \n    // Define active job statuses (in manufacturing or installation phases)\n    const activeJobStatuses = [\n      'ready_for_production', 'manufacturing_posts', 'manufacturing_panels', \n      'manufacturing_gates', 'qa_check', 'ready_for_scheduling', 'scheduled',\n      'install_posts', 'install_panels', 'install_gates'\n    ];\n    \n    // Jobs waiting for scheduling\n    const pendingSchedulingStatuses = ['ready_for_scheduling'];\n    \n    // Jobs in installation phase\n    const installPhaseStatuses = ['install_posts', 'install_panels', 'install_gates'];\n    \n    // Completed job statuses\n    const completedJobStatuses = ['install_complete', 'paid_in_full', 'archived'];\n    \n    switch (role) {\n      case 'admin': {\n        const [allLeads, allQuotes, allJobs, activeJobs] = await Promise.all([\n          db.select({ count: sql<number>`count(*)` }).from(leads).where(gte(leads.createdAt, thisMonthStart)),\n          db.select({ count: sql<number>`count(*)` }).from(quotes).where(gte(quotes.createdAt, thisMonthStart)),\n          db.select({ count: sql<number>`count(*)` }).from(jobs).where(gte(jobs.createdAt, thisMonthStart)),\n          db.select({ count: sql<number>`count(*)` }).from(jobs).where(\n            sql`${jobs.status} IN (${sql.join(activeJobStatuses.map(s => sql`${s}`), sql`, `)})`\n          ),\n        ]);\n        return [\n          { label: \"Leads This Month\", value: Number(allLeads[0]?.count || 0), trend: \"+12%\" },\n          { label: \"Quotes Created\", value: Number(allQuotes[0]?.count || 0), trend: \"+8%\" },\n          { label: \"Jobs Created\", value: Number(allJobs[0]?.count || 0), trend: \"+15%\" },\n          { label: \"Active Jobs\", value: Number(activeJobs[0]?.count || 0) },\n        ];\n      }\n      case 'sales': {\n        const [myLeads, myQuotes, convertedQuotes] = await Promise.all([\n          db.select({ count: sql<number>`count(*)` }).from(leads).where(\n            and(eq(leads.assignedTo, userId), gte(leads.createdAt, thisMonthStart))\n          ),\n          db.select({ count: sql<number>`count(*)` }).from(quotes).where(gte(quotes.createdAt, thisMonthStart)),\n          db.select({ count: sql<number>`count(*)` }).from(quotes).where(\n            and(eq(quotes.status, 'approved'), gte(quotes.createdAt, thisMonthStart))\n          ),\n        ]);\n        const conversionRate = Number(myQuotes[0]?.count || 0) > 0 \n          ? Math.round((Number(convertedQuotes[0]?.count || 0) / Number(myQuotes[0]?.count || 1)) * 100) \n          : 0;\n        return [\n          { label: \"My Active Leads\", value: Number(myLeads[0]?.count || 0), trend: \"+5%\" },\n          { label: \"Quotes This Month\", value: Number(myQuotes[0]?.count || 0), trend: \"+10%\" },\n          { label: \"Conversion Rate\", value: `${conversionRate}%` },\n        ];\n      }\n      case 'scheduler': {\n        const [scheduledThisWeek, unscheduledJobs] = await Promise.all([\n          db.select({ count: sql<number>`count(*)` }).from(scheduleEvents).where(\n            gte(scheduleEvents.startDate, thisWeekStart)\n          ),\n          db.select({ count: sql<number>`count(*)` }).from(jobs).where(\n            eq(jobs.status, 'ready_for_scheduling')\n          ),\n        ]);\n        return [\n          { label: \"Scheduled This Week\", value: Number(scheduledThisWeek[0]?.count || 0) },\n          { label: \"Pending Scheduling\", value: Number(unscheduledJobs[0]?.count || 0) },\n        ];\n      }\n      case 'production_manager': {\n        const [activeTasks, completedTasks] = await Promise.all([\n          db.select({ count: sql<number>`count(*)` }).from(productionTasks).where(\n            ne(productionTasks.status, 'completed')\n          ),\n          db.select({ count: sql<number>`count(*)` }).from(productionTasks).where(\n            and(eq(productionTasks.status, 'completed'), gte(productionTasks.endTime, thisWeekStart))\n          ),\n        ]);\n        return [\n          { label: \"Active Production Tasks\", value: Number(activeTasks[0]?.count || 0) },\n          { label: \"Completed This Week\", value: Number(completedTasks[0]?.count || 0), trend: \"+20%\" },\n        ];\n      }\n      case 'warehouse': {\n        const [lowStockItems] = await Promise.all([\n          db.select({ count: sql<number>`count(*)` }).from(products).where(\n            sql`${products.stockOnHand}::int <= ${products.reorderPoint}::int`\n          ),\n        ]);\n        return [\n          { label: \"Low Stock Items\", value: Number(lowStockItems[0]?.count || 0) },\n          { label: \"Pending Shipments\", value: 0 },\n        ];\n      }\n      case 'installer': {\n        const [myActiveJobs, completedJobs] = await Promise.all([\n          db.select({ count: sql<number>`count(*)` }).from(jobs).where(\n            and(\n              eq(jobs.assignedInstaller, userId),\n              sql`${jobs.status} IN (${sql.join(installPhaseStatuses.map(s => sql`${s}`), sql`, `)})`\n            )\n          ),\n          db.select({ count: sql<number>`count(*)` }).from(jobs).where(\n            and(\n              eq(jobs.assignedInstaller, userId),\n              eq(jobs.status, 'install_complete'),\n              gte(jobs.updatedAt, thisMonthStart)\n            )\n          ),\n        ]);\n        return [\n          { label: \"My Active Installs\", value: Number(myActiveJobs[0]?.count || 0) },\n          { label: \"Completed This Month\", value: Number(completedJobs[0]?.count || 0), trend: \"+3\" },\n        ];\n      }\n      case 'trade_client': {\n        const [myQuotes, myActiveJobs] = await Promise.all([\n          db.select({ count: sql<number>`count(*)` }).from(quotes).where(gte(quotes.createdAt, thisMonthStart)),\n          db.select({ count: sql<number>`count(*)` }).from(jobs).where(\n            sql`${jobs.status} IN (${sql.join(activeJobStatuses.map(s => sql`${s}`), sql`, `)})`\n          ),\n        ]);\n        return [\n          { label: \"My Quotes\", value: Number(myQuotes[0]?.count || 0) },\n          { label: \"Active Orders\", value: Number(myActiveJobs[0]?.count || 0) },\n        ];\n      }\n      default:\n        return [\n          { label: \"No KPIs available\", value: \"-\" },\n        ];\n    }\n  }\n\n  // Fence Styles\n  async getFenceStyle(id: string): Promise<FenceStyle | undefined> {\n    const [style] = await db.select().from(fenceStyles).where(eq(fenceStyles.id, id));\n    return style;\n  }\n\n  async getFenceStyles(): Promise<FenceStyle[]> {\n    return db.select().from(fenceStyles).where(eq(fenceStyles.isActive, true)).orderBy(fenceStyles.name);\n  }\n\n  async createFenceStyle(style: InsertFenceStyle): Promise<FenceStyle> {\n    const [created] = await db.insert(fenceStyles).values(style as any).returning();\n    return created;\n  }\n\n  async updateFenceStyle(id: string, style: Partial<InsertFenceStyle>): Promise<FenceStyle | undefined> {\n    const [updated] = await db.update(fenceStyles).set(style as any).where(eq(fenceStyles.id, id)).returning();\n    return updated;\n  }\n\n  // Products\n  async getProduct(id: string): Promise<Product | undefined> {\n    const [product] = await db.select().from(products).where(eq(products.id, id));\n    return product;\n  }\n\n  async getProductBySku(sku: string): Promise<Product | undefined> {\n    const [product] = await db.select().from(products).where(eq(products.sku, sku));\n    return product;\n  }\n\n  async getProducts(): Promise<Product[]> {\n    return db.select().from(products).where(eq(products.isActive, true)).orderBy(products.name);\n  }\n\n  async getProductsByCategory(category: string): Promise<Product[]> {\n    return db.select().from(products).where(\n      and(eq(products.category, category as any), eq(products.isActive, true))\n    ).orderBy(products.name);\n  }\n\n  async getLowStockProducts(): Promise<Product[]> {\n    return db.select().from(products).where(\n      and(\n        eq(products.isActive, true),\n        sql`${products.stockOnHand} <= ${products.reorderPoint}`\n      )\n    );\n  }\n\n  async createProduct(product: InsertProduct): Promise<Product> {\n    const [created] = await db.insert(products).values(product).returning();\n    return created;\n  }\n\n  async updateProduct(id: string, product: Partial<InsertProduct>): Promise<Product | undefined> {\n    const [updated] = await db.update(products).set(product).where(eq(products.id, id)).returning();\n    return updated;\n  }\n\n  async updateStock(id: string, quantity: number): Promise<Product | undefined> {\n    const [updated] = await db.update(products)\n      .set({ stockOnHand: quantity })\n      .where(eq(products.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteProduct(id: string): Promise<boolean> {\n    await db.update(products).set({ isActive: false }).where(eq(products.id, id));\n    return true;\n  }\n\n  // Quotes\n  async getQuote(id: string): Promise<Quote | undefined> {\n    const [quote] = await db.select().from(quotes).where(eq(quotes.id, id));\n    return quote;\n  }\n\n  async getQuoteByNumber(quoteNumber: string): Promise<Quote | undefined> {\n    const [quote] = await db.select().from(quotes).where(eq(quotes.quoteNumber, quoteNumber));\n    return quote;\n  }\n\n  async getQuotes(): Promise<Quote[]> {\n    return db.select().from(quotes).orderBy(desc(quotes.createdAt));\n  }\n\n  async getQuotesByClient(clientId: string): Promise<Quote[]> {\n    return db.select().from(quotes).where(eq(quotes.clientId, clientId)).orderBy(desc(quotes.createdAt));\n  }\n\n  async getQuotesByStatus(status: string): Promise<Quote[]> {\n    return db.select().from(quotes).where(eq(quotes.status, status as any)).orderBy(desc(quotes.createdAt));\n  }\n\n  async createQuote(quote: InsertQuote): Promise<Quote> {\n    let quoteNumber = quote.quoteNumber;\n    \n    if (quote.leadId) {\n      quoteNumber = await this.generateQuoteNumber(quote.leadId);\n    } else if (!quoteNumber) {\n      quoteNumber = await this.getNextQuoteNumber();\n    }\n    \n    const [created] = await db.insert(quotes).values({\n      ...quote,\n      quoteNumber,\n    } as any).returning();\n    return created;\n  }\n\n  private async generateQuoteNumber(leadId: string): Promise<string> {\n    const lead = await this.getLead(leadId);\n    if (!lead?.leadNumber) {\n      return this.getNextQuoteNumber();\n    }\n    \n    const prefix = `${lead.leadNumber}-Q`;\n    const existingQuotes = await db.select({ quoteNumber: quotes.quoteNumber })\n      .from(quotes)\n      .where(like(quotes.quoteNumber, `${prefix}%`));\n    \n    let maxSeq = 0;\n    for (const q of existingQuotes) {\n      const match = q.quoteNumber.match(/-Q(\\d+)$/);\n      if (match) {\n        const seq = parseInt(match[1], 10);\n        if (seq > maxSeq) maxSeq = seq;\n      }\n    }\n    \n    return `${prefix}${maxSeq + 1}`;\n  }\n\n  async updateQuote(id: string, quote: Partial<InsertQuote>): Promise<Quote | undefined> {\n    const [updated] = await db.update(quotes).set(quote as any).where(eq(quotes.id, id)).returning();\n    return updated;\n  }\n\n  async deleteQuote(id: string): Promise<boolean> {\n    await db.delete(quotes).where(eq(quotes.id, id));\n    return true;\n  }\n\n  async searchQuotes(query: string): Promise<Quote[]> {\n    return db.select().from(quotes).where(\n      or(\n        ilike(quotes.quoteNumber, `%${query}%`),\n        ilike(quotes.siteAddress, `%${query}%`)\n      )\n    );\n  }\n\n  async setPrimaryQuote(quoteId: string): Promise<{ quote: Quote; lead: Lead }> {\n    const quote = await this.getQuote(quoteId);\n    if (!quote) {\n      throw new Error(\"Quote not found\");\n    }\n    if (!quote.leadId) {\n      throw new Error(\"Quote must be associated with a lead to be set as primary\");\n    }\n\n    await db.update(quotes)\n      .set({ isPrimary: false } as any)\n      .where(eq(quotes.leadId, quote.leadId));\n\n    const [updatedQuote] = await db.update(quotes)\n      .set({ isPrimary: true } as any)\n      .where(eq(quotes.id, quoteId))\n      .returning();\n\n    // Safely parse opportunity value to ensure numeric consistency\n    const opportunityValue = quote.totalAmount ? String(parseFloat(quote.totalAmount) || 0) : \"0\";\n\n    const [updatedLead] = await db.update(leads)\n      .set({\n        primaryQuoteId: quoteId,\n        opportunityValue: opportunityValue,\n        updatedAt: new Date(),\n      } as any)\n      .where(eq(leads.id, quote.leadId))\n      .returning();\n\n    return { quote: updatedQuote, lead: updatedLead };\n  }\n\n  async acceptQuote(quoteId: string): Promise<{ quote: Quote; lead: Lead; job: Job }> {\n    const quote = await this.getQuote(quoteId);\n    if (!quote) {\n      throw new Error(\"Quote not found\");\n    }\n    if (!quote.leadId) {\n      throw new Error(\"Quote must be associated with a lead to be accepted\");\n    }\n\n    const lead = await this.getLead(quote.leadId);\n    if (!lead) {\n      throw new Error(\"Lead not found\");\n    }\n\n    await db.update(quotes)\n      .set({ isPrimary: false, status: \"rejected\" } as any)\n      .where(and(\n        eq(quotes.leadId, quote.leadId),\n        ne(quotes.id, quoteId)\n      ));\n\n    const [updatedQuote] = await db.update(quotes)\n      .set({ \n        isPrimary: true, \n        status: \"approved\",\n        approvedAt: new Date()\n      } as any)\n      .where(eq(quotes.id, quoteId))\n      .returning();\n\n    // Safely parse values to prevent NaN\n    const totalAmount = parseFloat(quote.totalAmount) || 0;\n    const depositRequired = parseFloat(quote.depositRequired || \"0\") || 0;\n    const opportunityValue = String(totalAmount);\n    const balanceDue = String(totalAmount - depositRequired);\n\n    const now = new Date();\n    const [updatedLead] = await db.update(leads)\n      .set({\n        primaryQuoteId: quoteId,\n        opportunityValue: opportunityValue,\n        stage: \"won\",\n        wonAt: now, // Set analytics timestamp when lead is won\n        updatedAt: now,\n      } as any)\n      .where(eq(leads.id, quote.leadId))\n      .returning();\n\n    // Create job with awaiting_deposit status to align with existing workflow\n    const job = await this.createJob({\n      clientId: quote.clientId,\n      quoteId: quoteId,\n      jobType: lead.jobFulfillmentType || \"supply_install\",\n      siteAddress: quote.siteAddress || lead.siteAddress || \"\",\n      fenceStyle: lead.fenceStyle || \"Standard\",\n      totalAmount: String(totalAmount),\n      depositAmount: String(depositRequired),\n      balanceDue: balanceDue,\n      status: \"awaiting_deposit\",\n    });\n\n    return { quote: updatedQuote, lead: updatedLead, job };\n  }\n\n  async getNextQuoteNumber(): Promise<string> {\n    const year = new Date().getFullYear();\n    const [result] = await db.select({ count: sql<number>`count(*)` })\n      .from(quotes)\n      .where(like(quotes.quoteNumber, `Q-${year}-%`));\n    const count = (result?.count || 0) + 1;\n    return `Q-${year}-${String(count).padStart(4, '0')}`;\n  }\n\n  // Jobs\n  async getJob(id: string): Promise<Job | undefined> {\n    const [job] = await db.select().from(jobs).where(eq(jobs.id, id));\n    return job;\n  }\n\n  async getJobByNumber(jobNumber: string): Promise<Job | undefined> {\n    const [job] = await db.select().from(jobs).where(eq(jobs.jobNumber, jobNumber));\n    return job;\n  }\n\n  async getJobs(): Promise<Job[]> {\n    return db.select().from(jobs).orderBy(desc(jobs.createdAt));\n  }\n\n  async getJobsByClient(clientId: string): Promise<Job[]> {\n    return db.select().from(jobs).where(eq(jobs.clientId, clientId)).orderBy(desc(jobs.createdAt));\n  }\n\n  async getJobsByStatus(status: string): Promise<Job[]> {\n    return db.select().from(jobs).where(eq(jobs.status, status as any)).orderBy(desc(jobs.createdAt));\n  }\n\n  async getJobsByInstaller(installerId: string): Promise<Job[]> {\n    return db.select().from(jobs).where(eq(jobs.assignedInstaller, installerId)).orderBy(desc(jobs.scheduledStartDate));\n  }\n\n  async createJob(job: InsertJob): Promise<Job> {\n    let jobNumber = job.jobNumber;\n    let invoiceNumber = (job as any).invoiceNumber;\n    let leadId = (job as any).leadId;\n    let jobType = job.jobType;\n    \n    if (job.quoteId && !leadId) {\n      const quote = await this.getQuote(job.quoteId);\n      if (quote?.leadId) {\n        leadId = quote.leadId;\n      }\n    }\n    \n    if (leadId) {\n      const lead = await this.getLead(leadId);\n      if (lead?.leadNumber) {\n        const baseJobNumber = `${lead.leadNumber}-JOB`;\n        const baseInvoiceNumber = `${lead.leadNumber}-INV`;\n        \n        const existingJob = await this.getJobByNumber(baseJobNumber);\n        if (existingJob) {\n          const existingJobs = await db.select({ jobNumber: jobs.jobNumber })\n            .from(jobs)\n            .where(like(jobs.jobNumber, `${lead.leadNumber}-JOB%`));\n          \n          let maxSuffix = 0;\n          for (const j of existingJobs) {\n            const match = j.jobNumber.match(/-JOB(\\d+)?$/);\n            if (match) {\n              const suffix = match[1] ? parseInt(match[1], 10) : 1;\n              if (suffix > maxSuffix) maxSuffix = suffix;\n            }\n          }\n          jobNumber = `${lead.leadNumber}-JOB${maxSuffix + 1}`;\n          invoiceNumber = `${lead.leadNumber}-INV${maxSuffix + 1}`;\n        } else {\n          jobNumber = baseJobNumber;\n          invoiceNumber = baseInvoiceNumber;\n        }\n      }\n      if (!jobType && lead?.jobFulfillmentType) {\n        jobType = lead.jobFulfillmentType as \"supply_only\" | \"supply_install\";\n      }\n    }\n    \n    if (!jobNumber) {\n      jobNumber = await this.getNextJobNumber();\n    }\n    \n    const [created] = await db.insert(jobs).values({\n      ...job,\n      jobNumber,\n      invoiceNumber,\n      leadId,\n      jobType: jobType || \"supply_install\",\n    } as any).returning();\n    return created;\n  }\n\n  async updateJob(id: string, job: Partial<InsertJob>): Promise<Job | undefined> {\n    const [updated] = await db.update(jobs).set({\n      ...job,\n      updatedAt: new Date(),\n    } as any).where(eq(jobs.id, id)).returning();\n    return updated;\n  }\n\n  async getNextJobNumber(): Promise<string> {\n    const year = new Date().getFullYear();\n    const [result] = await db.select({ count: sql<number>`count(*)` })\n      .from(jobs)\n      .where(like(jobs.jobNumber, `JOB-${year}-%`));\n    const count = (result?.count || 0) + 1;\n    return `JOB-${year}-${String(count).padStart(4, '0')}`;\n  }\n\n  async searchJobs(query: string): Promise<Job[]> {\n    return db.select().from(jobs).where(\n      or(\n        ilike(jobs.jobNumber, `%${query}%`),\n        ilike(jobs.siteAddress, `%${query}%`),\n        ilike(jobs.fenceStyle, `%${query}%`)\n      )\n    );\n  }\n\n  async deleteJob(id: string): Promise<boolean> {\n    await db.delete(jobs).where(eq(jobs.id, id));\n    return true;\n  }\n\n  async createDirectJob(data: { clientId: string; jobType: \"supply_only\" | \"supply_install\"; siteAddress: string; notes?: string; totalAmount?: number }): Promise<{ lead: Lead; job: Job }> {\n    const client = await this.getClient(data.clientId);\n    if (!client) {\n      throw new Error(\"Client not found\");\n    }\n\n    const lead = await this.createLead({\n      clientId: data.clientId,\n      source: \"direct_job\",\n      stage: \"won\",\n      jobFulfillmentType: data.jobType,\n      siteAddress: data.siteAddress,\n      notes: data.notes || \"Created via Direct Job\",\n      expectedValue: data.totalAmount ? String(data.totalAmount) : undefined,\n    });\n\n    const job = await this.createJob({\n      clientId: data.clientId,\n      jobType: data.jobType,\n      siteAddress: data.siteAddress,\n      fenceStyle: \"Standard\",\n      notes: data.notes,\n      totalAmount: data.totalAmount ? String(data.totalAmount) : \"0\",\n      depositAmount: \"0\",\n      balanceDue: data.totalAmount ? String(data.totalAmount) : \"0\",\n      status: \"accepted\",\n      leadId: lead.id,\n    } as any);\n\n    return { lead, job };\n  }\n\n  // BOM\n  async getBOM(id: string): Promise<BOM | undefined> {\n    const [bomResult] = await db.select().from(bom).where(eq(bom.id, id));\n    return bomResult;\n  }\n\n  async getBOMByJob(jobId: string): Promise<BOM | undefined> {\n    const [bomResult] = await db.select().from(bom).where(eq(bom.jobId, jobId));\n    return bomResult;\n  }\n\n  async createBOM(bomData: InsertBOM): Promise<BOM> {\n    const [created] = await db.insert(bom).values(bomData as any).returning();\n    return created;\n  }\n\n  async updateBOM(id: string, bomData: Partial<InsertBOM>): Promise<BOM | undefined> {\n    const [updated] = await db.update(bom).set(bomData as any).where(eq(bom.id, id)).returning();\n    return updated;\n  }\n\n  // Production Tasks\n  async getProductionTask(id: string): Promise<ProductionTask | undefined> {\n    const [task] = await db.select().from(productionTasks).where(eq(productionTasks.id, id));\n    return task;\n  }\n\n  async getProductionTasks(): Promise<ProductionTask[]> {\n    return db.select().from(productionTasks).orderBy(desc(productionTasks.createdAt));\n  }\n\n  async getProductionTasksByJob(jobId: string): Promise<ProductionTask[]> {\n    return db.select().from(productionTasks).where(eq(productionTasks.jobId, jobId)).orderBy(productionTasks.taskType);\n  }\n\n  async getProductionTasksByAssignee(userId: string): Promise<ProductionTask[]> {\n    return db.select().from(productionTasks).where(eq(productionTasks.assignedTo, userId)).orderBy(desc(productionTasks.createdAt));\n  }\n\n  async getProductionTasksByStatus(status: string): Promise<ProductionTask[]> {\n    return db.select().from(productionTasks).where(eq(productionTasks.status, status as any)).orderBy(desc(productionTasks.createdAt));\n  }\n\n  async createProductionTask(task: InsertProductionTask): Promise<ProductionTask> {\n    const [created] = await db.insert(productionTasks).values(task).returning();\n    return created;\n  }\n\n  async updateProductionTask(id: string, task: Partial<InsertProductionTask>): Promise<ProductionTask | undefined> {\n    const [updated] = await db.update(productionTasks).set(task).where(eq(productionTasks.id, id)).returning();\n    return updated;\n  }\n\n  // Install Tasks\n  async getInstallTask(id: string): Promise<InstallTask | undefined> {\n    const [task] = await db.select().from(installTasks).where(eq(installTasks.id, id));\n    return task;\n  }\n\n  async getInstallTasks(): Promise<InstallTask[]> {\n    return db.select().from(installTasks).orderBy(desc(installTasks.scheduledDate));\n  }\n\n  async getInstallTasksByJob(jobId: string): Promise<InstallTask[]> {\n    return db.select().from(installTasks).where(eq(installTasks.jobId, jobId)).orderBy(installTasks.scheduledDate);\n  }\n\n  async getInstallTasksByInstaller(installerId: string): Promise<InstallTask[]> {\n    return db.select().from(installTasks).where(eq(installTasks.installerId, installerId)).orderBy(desc(installTasks.scheduledDate));\n  }\n\n  async getInstallTasksByDate(date: Date): Promise<InstallTask[]> {\n    const startOfDay = new Date(date);\n    startOfDay.setHours(0, 0, 0, 0);\n    const endOfDay = new Date(date);\n    endOfDay.setHours(23, 59, 59, 999);\n    \n    return db.select().from(installTasks).where(\n      and(\n        gte(installTasks.scheduledDate, startOfDay),\n        lte(installTasks.scheduledDate, endOfDay)\n      )\n    );\n  }\n\n  async createInstallTask(task: InsertInstallTask): Promise<InstallTask> {\n    const [created] = await db.insert(installTasks).values(task as any).returning();\n    return created;\n  }\n\n  async updateInstallTask(id: string, task: Partial<InsertInstallTask>): Promise<InstallTask | undefined> {\n    const [updated] = await db.update(installTasks).set(task as any).where(eq(installTasks.id, id)).returning();\n    return updated;\n  }\n\n  // Schedule Events\n  async getScheduleEvent(id: string): Promise<ScheduleEvent | undefined> {\n    const [event] = await db.select().from(scheduleEvents).where(eq(scheduleEvents.id, id));\n    return event;\n  }\n\n  async getScheduleEvents(): Promise<ScheduleEvent[]> {\n    return db.select().from(scheduleEvents).orderBy(scheduleEvents.startDate);\n  }\n\n  async getScheduleEventsByDateRange(start: Date, end: Date): Promise<ScheduleEvent[]> {\n    return db.select().from(scheduleEvents).where(\n      and(\n        gte(scheduleEvents.startDate, start),\n        lte(scheduleEvents.endDate, end)\n      )\n    ).orderBy(scheduleEvents.startDate);\n  }\n\n  async getScheduleEventsByAssignee(userId: string): Promise<ScheduleEvent[]> {\n    return db.select().from(scheduleEvents).where(eq(scheduleEvents.assignedTo, userId)).orderBy(scheduleEvents.startDate);\n  }\n\n  async createScheduleEvent(event: InsertScheduleEvent): Promise<ScheduleEvent> {\n    const [created] = await db.insert(scheduleEvents).values(event).returning();\n    return created;\n  }\n\n  async updateScheduleEvent(id: string, event: Partial<InsertScheduleEvent>): Promise<ScheduleEvent | undefined> {\n    const [updated] = await db.update(scheduleEvents).set(event).where(eq(scheduleEvents.id, id)).returning();\n    return updated;\n  }\n\n  async deleteScheduleEvent(id: string): Promise<boolean> {\n    await db.delete(scheduleEvents).where(eq(scheduleEvents.id, id));\n    return true;\n  }\n\n  // Payments\n  async getPayment(id: string): Promise<Payment | undefined> {\n    const [payment] = await db.select().from(payments).where(eq(payments.id, id));\n    return payment;\n  }\n\n  async getPayments(): Promise<Payment[]> {\n    return db.select().from(payments).orderBy(desc(payments.createdAt));\n  }\n\n  async getPaymentsByClient(clientId: string): Promise<Payment[]> {\n    return db.select().from(payments).where(eq(payments.clientId, clientId)).orderBy(desc(payments.createdAt));\n  }\n\n  async getPaymentsByJob(jobId: string): Promise<Payment[]> {\n    return db.select().from(payments).where(eq(payments.jobId, jobId)).orderBy(desc(payments.createdAt));\n  }\n\n  async getPendingPayments(): Promise<Payment[]> {\n    return db.select().from(payments).where(eq(payments.status, 'pending')).orderBy(desc(payments.createdAt));\n  }\n\n  async createPayment(payment: InsertPayment): Promise<Payment> {\n    const [created] = await db.insert(payments).values(payment).returning();\n    return created;\n  }\n\n  async updatePayment(id: string, payment: Partial<InsertPayment>): Promise<Payment | undefined> {\n    const [updated] = await db.update(payments).set(payment).where(eq(payments.id, id)).returning();\n    return updated;\n  }\n\n  // Notifications\n  async getNotification(id: string): Promise<Notification | undefined> {\n    const [notification] = await db.select().from(notifications).where(eq(notifications.id, id));\n    return notification;\n  }\n\n  async getNotificationsByUser(userId: string): Promise<Notification[]> {\n    return db.select().from(notifications).where(eq(notifications.userId, userId)).orderBy(desc(notifications.createdAt));\n  }\n\n  async getUnreadNotifications(userId: string): Promise<Notification[]> {\n    return db.select().from(notifications).where(\n      and(\n        eq(notifications.userId, userId),\n        eq(notifications.isRead, false)\n      )\n    ).orderBy(desc(notifications.createdAt));\n  }\n\n  async createNotification(notification: InsertNotification): Promise<Notification> {\n    const [created] = await db.insert(notifications).values(notification).returning();\n    return created;\n  }\n\n  async markNotificationRead(id: string): Promise<Notification | undefined> {\n    const [updated] = await db.update(notifications)\n      .set({ isRead: true, readAt: new Date() })\n      .where(eq(notifications.id, id))\n      .returning();\n    return updated;\n  }\n\n  async markAllNotificationsRead(userId: string): Promise<void> {\n    await db.update(notifications)\n      .set({ isRead: true, readAt: new Date() })\n      .where(and(eq(notifications.userId, userId), eq(notifications.isRead, false)));\n  }\n\n  // SMS Logs\n  async getSMSLog(id: string): Promise<SMSLog | undefined> {\n    const [log] = await db.select().from(smsLogs).where(eq(smsLogs.id, id));\n    return log;\n  }\n\n  async getSMSLogs(): Promise<SMSLog[]> {\n    return db.select().from(smsLogs).orderBy(desc(smsLogs.createdAt));\n  }\n\n  async getSMSLogsByPhone(phone: string): Promise<SMSLog[]> {\n    // Get last 9 digits for matching (handles both 0xxx and +61xxx formats)\n    const normalizedPhone = phone.replace(/\\D/g, '').slice(-9);\n    const allLogs = await db.select().from(smsLogs).orderBy(smsLogs.createdAt);\n    // Filter in JS to handle phone number matching correctly\n    return allLogs.filter(log => {\n      const logPhone = log.recipientPhone.replace(/\\D/g, '').slice(-9);\n      return logPhone === normalizedPhone;\n    });\n  }\n\n  async getSMSLogsByEntity(entityType: string, entityId: string): Promise<SMSLog[]> {\n    return db.select().from(smsLogs)\n      .where(and(\n        eq(smsLogs.relatedEntityType, entityType),\n        eq(smsLogs.relatedEntityId, entityId)\n      ))\n      .orderBy(smsLogs.createdAt);\n  }\n\n  async createSMSLog(log: InsertSMSLog): Promise<SMSLog> {\n    const [created] = await db.insert(smsLogs).values(log).returning();\n    return created;\n  }\n\n  async updateSMSLog(id: string, log: Partial<InsertSMSLog>): Promise<SMSLog | undefined> {\n    const [updated] = await db.update(smsLogs).set(log).where(eq(smsLogs.id, id)).returning();\n    return updated;\n  }\n\n  async markMessagesRead(messageIds: string[]): Promise<void> {\n    if (messageIds.length === 0) return;\n    for (const id of messageIds) {\n      await db.update(smsLogs).set({ isRead: true }).where(eq(smsLogs.id, id));\n    }\n  }\n\n  async getUnreadMessageCount(): Promise<number> {\n    const [result] = await db.select({ count: sql<number>`count(*)` })\n      .from(smsLogs)\n      .where(and(eq(smsLogs.isRead, false), eq(smsLogs.isOutbound, false)));\n    return Number(result?.count || 0);\n  }\n\n  // SMS Conversations\n  async getSMSConversation(id: string): Promise<SMSConversation | undefined> {\n    const [conversation] = await db.select().from(smsConversations).where(eq(smsConversations.id, id));\n    return conversation;\n  }\n\n  async getSMSConversationByPhone(phone: string): Promise<SMSConversation | undefined> {\n    const normalizedPhone = phone.replace(/\\D/g, '').slice(-9);\n    const allConversations = await db.select().from(smsConversations);\n    return allConversations.find(conv => {\n      const convPhone = conv.phoneNumber.replace(/\\D/g, '').slice(-9);\n      return convPhone === normalizedPhone;\n    });\n  }\n\n  async getSMSConversations(): Promise<SMSConversation[]> {\n    return db.select().from(smsConversations).orderBy(desc(smsConversations.lastMessageAt));\n  }\n\n  async getUnresolvedConversations(): Promise<SMSConversation[]> {\n    return db.select().from(smsConversations)\n      .where(eq(smsConversations.isResolved, false))\n      .orderBy(desc(smsConversations.lastMessageAt));\n  }\n\n  async createSMSConversation(conversation: InsertSMSConversation): Promise<SMSConversation> {\n    const [created] = await db.insert(smsConversations).values(conversation).returning();\n    return created;\n  }\n\n  async updateSMSConversation(id: string, conversation: Partial<InsertSMSConversation>): Promise<SMSConversation | undefined> {\n    const [updated] = await db.update(smsConversations).set(conversation).where(eq(smsConversations.id, id)).returning();\n    return updated;\n  }\n\n  async findClientByPhone(phone: string): Promise<Client | undefined> {\n    const normalizedPhone = phone.replace(/\\D/g, '').slice(-9);\n    const allClients = await db.select().from(clients);\n    return allClients.find(client => {\n      if (!client.phone) return false;\n      const clientPhone = client.phone.replace(/\\D/g, '').slice(-9);\n      return clientPhone === normalizedPhone;\n    });\n  }\n\n  async getOrCreateConversation(phone: string): Promise<SMSConversation> {\n    let conversation = await this.getSMSConversationByPhone(phone);\n    if (conversation) return conversation;\n    \n    // Try to find matching client\n    const client = await this.findClientByPhone(phone);\n    \n    // Create new conversation\n    return this.createSMSConversation({\n      phoneNumber: phone,\n      clientId: client?.id || null,\n      lastMessageAt: new Date(),\n      unreadCount: 0,\n    });\n  }\n\n  // Message Ranges\n  async getMessageRange(id: string): Promise<MessageRange | undefined> {\n    const [range] = await db.select().from(messageRanges).where(eq(messageRanges.id, id));\n    return range;\n  }\n\n  async getMessageRangesByConversation(conversationId: string): Promise<MessageRange[]> {\n    return db.select().from(messageRanges)\n      .where(eq(messageRanges.conversationId, conversationId))\n      .orderBy(desc(messageRanges.createdAt));\n  }\n\n  async getMessageRangesByLead(leadId: string): Promise<MessageRange[]> {\n    return db.select().from(messageRanges)\n      .where(eq(messageRanges.leadId, leadId))\n      .orderBy(desc(messageRanges.createdAt));\n  }\n\n  async getMessageRangesByJob(jobId: string): Promise<MessageRange[]> {\n    return db.select().from(messageRanges)\n      .where(eq(messageRanges.jobId, jobId))\n      .orderBy(desc(messageRanges.createdAt));\n  }\n\n  async createMessageRange(range: InsertMessageRange): Promise<MessageRange> {\n    const [created] = await db.insert(messageRanges).values(range).returning();\n    return created;\n  }\n\n  async deleteMessageRange(id: string): Promise<boolean> {\n    await db.delete(messageRanges).where(eq(messageRanges.id, id));\n    return true;\n  }\n\n  // Activity Logs\n  async getActivityLogs(): Promise<ActivityLog[]> {\n    return db.select().from(activityLogs).orderBy(desc(activityLogs.createdAt)).limit(100);\n  }\n\n  async getActivityLogsByUser(userId: string): Promise<ActivityLog[]> {\n    return db.select().from(activityLogs).where(eq(activityLogs.userId, userId)).orderBy(desc(activityLogs.createdAt));\n  }\n\n  async getActivityLogsByEntity(entityType: string, entityId: string): Promise<ActivityLog[]> {\n    return db.select().from(activityLogs).where(\n      and(\n        eq(activityLogs.entityType, entityType),\n        eq(activityLogs.entityId, entityId)\n      )\n    ).orderBy(desc(activityLogs.createdAt));\n  }\n\n  async createActivityLog(log: InsertActivityLog): Promise<ActivityLog> {\n    const [created] = await db.insert(activityLogs).values(log).returning();\n    return created;\n  }\n\n  // Documents\n  async getDocument(id: string): Promise<Document | undefined> {\n    const [doc] = await db.select().from(documents).where(eq(documents.id, id));\n    return doc;\n  }\n\n  async getDocumentsByClient(clientId: string): Promise<Document[]> {\n    return db.select().from(documents).where(eq(documents.clientId, clientId)).orderBy(desc(documents.createdAt));\n  }\n\n  async getDocumentsByJob(jobId: string): Promise<Document[]> {\n    return db.select().from(documents).where(eq(documents.jobId, jobId)).orderBy(desc(documents.createdAt));\n  }\n\n  async createDocument(doc: InsertDocument): Promise<Document> {\n    const [created] = await db.insert(documents).values(doc).returning();\n    return created;\n  }\n\n  async deleteDocument(id: string): Promise<boolean> {\n    await db.delete(documents).where(eq(documents.id, id));\n    return true;\n  }\n\n  // Dashboard Stats\n  async getDashboardStats(): Promise<DashboardStats> {\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    const tomorrow = new Date(today);\n    tomorrow.setDate(tomorrow.getDate() + 1);\n\n    const [newLeadsResult] = await db.select({ count: sql<number>`count(*)` })\n      .from(leads)\n      .where(eq(leads.stage, 'new'));\n\n    const [quotesFollowUpResult] = await db.select({ count: sql<number>`count(*)` })\n      .from(quotes)\n      .where(eq(quotes.status, 'sent'));\n\n    const [jobsInProductionResult] = await db.select({ count: sql<number>`count(*)` })\n      .from(jobs)\n      .where(\n        or(\n          eq(jobs.status, 'manufacturing_posts'),\n          eq(jobs.status, 'manufacturing_panels'),\n          eq(jobs.status, 'manufacturing_gates'),\n          eq(jobs.status, 'qa_check')\n        )\n      );\n\n    const [jobsReadyInstallResult] = await db.select({ count: sql<number>`count(*)` })\n      .from(jobs)\n      .where(eq(jobs.status, 'scheduled'));\n\n    const [todayInstallsResult] = await db.select({ count: sql<number>`count(*)` })\n      .from(installTasks)\n      .where(\n        and(\n          gte(installTasks.scheduledDate, today),\n          lte(installTasks.scheduledDate, tomorrow)\n        )\n      );\n\n    const [pendingPaymentsResult] = await db.select({ total: sql<number>`COALESCE(SUM(amount), 0)` })\n      .from(payments)\n      .where(eq(payments.status, 'pending'));\n\n    return {\n      newLeadsCount: Number(newLeadsResult?.count || 0),\n      quotesAwaitingFollowUp: Number(quotesFollowUpResult?.count || 0),\n      jobsInProduction: Number(jobsInProductionResult?.count || 0),\n      jobsReadyForInstall: Number(jobsReadyInstallResult?.count || 0),\n      todayInstalls: Number(todayInstallsResult?.count || 0),\n      pendingPaymentsTotal: Number(pendingPaymentsResult?.total || 0),\n    };\n  }\n\n  // Quote Follow-ups\n  async getQuoteFollowUp(id: string): Promise<QuoteFollowUp | undefined> {\n    const [followUp] = await db.select().from(quoteFollowUps).where(eq(quoteFollowUps.id, id));\n    return followUp;\n  }\n\n  async getQuoteFollowUpsByQuote(quoteId: string): Promise<QuoteFollowUp[]> {\n    return db.select().from(quoteFollowUps)\n      .where(eq(quoteFollowUps.quoteId, quoteId))\n      .orderBy(desc(quoteFollowUps.scheduledDate));\n  }\n\n  async getPendingFollowUps(): Promise<QuoteFollowUp[]> {\n    return db.select().from(quoteFollowUps)\n      .where(isNull(quoteFollowUps.completedAt))\n      .orderBy(quoteFollowUps.scheduledDate);\n  }\n\n  async getFollowUpsByAssignee(userId: string): Promise<QuoteFollowUp[]> {\n    return db.select().from(quoteFollowUps)\n      .where(and(eq(quoteFollowUps.assignedTo, userId), isNull(quoteFollowUps.completedAt)))\n      .orderBy(quoteFollowUps.scheduledDate);\n  }\n\n  async createQuoteFollowUp(followUp: InsertQuoteFollowUp): Promise<QuoteFollowUp> {\n    const [created] = await db.insert(quoteFollowUps).values(followUp).returning();\n    return created;\n  }\n\n  async updateQuoteFollowUp(id: string, followUp: Partial<InsertQuoteFollowUp>): Promise<QuoteFollowUp | undefined> {\n    const [updated] = await db.update(quoteFollowUps).set(followUp).where(eq(quoteFollowUps.id, id)).returning();\n    return updated;\n  }\n\n  async deleteQuoteFollowUp(id: string): Promise<boolean> {\n    await db.delete(quoteFollowUps).where(eq(quoteFollowUps.id, id));\n    return true;\n  }\n\n  // Automation Campaigns\n  async getAutomationCampaign(id: string): Promise<AutomationCampaign | undefined> {\n    const [campaign] = await db.select().from(automationCampaigns).where(eq(automationCampaigns.id, id));\n    return campaign;\n  }\n\n  async getAutomationCampaigns(): Promise<AutomationCampaign[]> {\n    return db.select().from(automationCampaigns).orderBy(desc(automationCampaigns.createdAt));\n  }\n\n  async getActiveCampaigns(): Promise<AutomationCampaign[]> {\n    return db.select().from(automationCampaigns)\n      .where(eq(automationCampaigns.isActive, true))\n      .orderBy(automationCampaigns.name);\n  }\n\n  async getCampaignsByTrigger(trigger: string): Promise<AutomationCampaign[]> {\n    return db.select().from(automationCampaigns)\n      .where(and(eq(automationCampaigns.trigger, trigger as any), eq(automationCampaigns.isActive, true)));\n  }\n\n  async createAutomationCampaign(campaign: InsertAutomationCampaign): Promise<AutomationCampaign> {\n    const [created] = await db.insert(automationCampaigns).values(campaign).returning();\n    return created;\n  }\n\n  async updateAutomationCampaign(id: string, campaign: Partial<InsertAutomationCampaign>): Promise<AutomationCampaign | undefined> {\n    const [updated] = await db.update(automationCampaigns)\n      .set({ ...campaign, updatedAt: new Date() })\n      .where(eq(automationCampaigns.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteAutomationCampaign(id: string): Promise<boolean> {\n    await db.delete(automationCampaigns).where(eq(automationCampaigns.id, id));\n    return true;\n  }\n\n  // Campaign Enrollments\n  async getCampaignEnrollment(id: string): Promise<CampaignEnrollment | undefined> {\n    const [enrollment] = await db.select().from(campaignEnrollments).where(eq(campaignEnrollments.id, id));\n    return enrollment;\n  }\n\n  async getCampaignEnrollmentsByCampaign(campaignId: string): Promise<CampaignEnrollment[]> {\n    return db.select().from(campaignEnrollments)\n      .where(eq(campaignEnrollments.campaignId, campaignId))\n      .orderBy(desc(campaignEnrollments.enrolledAt));\n  }\n\n  async getCampaignEnrollmentsByClient(clientId: string): Promise<CampaignEnrollment[]> {\n    return db.select().from(campaignEnrollments)\n      .where(eq(campaignEnrollments.clientId, clientId))\n      .orderBy(desc(campaignEnrollments.enrolledAt));\n  }\n\n  async getPendingEnrollments(): Promise<CampaignEnrollment[]> {\n    return db.select().from(campaignEnrollments)\n      .where(and(eq(campaignEnrollments.status, 'active'), isNull(campaignEnrollments.sentAt)))\n      .orderBy(campaignEnrollments.scheduledSendAt);\n  }\n\n  async createCampaignEnrollment(enrollment: InsertCampaignEnrollment): Promise<CampaignEnrollment> {\n    const [created] = await db.insert(campaignEnrollments).values(enrollment).returning();\n    return created;\n  }\n\n  async updateCampaignEnrollment(id: string, enrollment: Partial<InsertCampaignEnrollment>): Promise<CampaignEnrollment | undefined> {\n    const [updated] = await db.update(campaignEnrollments).set(enrollment).where(eq(campaignEnrollments.id, id)).returning();\n    return updated;\n  }\n\n  async cancelCampaignEnrollment(id: string, reason: string): Promise<CampaignEnrollment | undefined> {\n    const [updated] = await db.update(campaignEnrollments)\n      .set({ status: 'cancelled', cancelledAt: new Date(), cancelReason: reason })\n      .where(eq(campaignEnrollments.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Quote Analytics\n  async getQuoteAnalytics(): Promise<QuoteAnalytics> {\n    const allQuotes = await db.select().from(quotes).orderBy(desc(quotes.createdAt));\n    \n    const now = new Date();\n    const startOfThisWeek = new Date(now);\n    startOfThisWeek.setDate(now.getDate() - now.getDay());\n    startOfThisWeek.setHours(0, 0, 0, 0);\n    \n    const startOfLastWeek = new Date(startOfThisWeek);\n    startOfLastWeek.setDate(startOfLastWeek.getDate() - 7);\n\n    const totalQuotes = allQuotes.length;\n    const sentQuotes = allQuotes.filter(q => q.status === 'sent').length;\n    const approvedQuotes = allQuotes.filter(q => q.status === 'approved').length;\n    const declinedQuotes = allQuotes.filter(q => q.status === 'declined').length;\n    const pendingQuotes = allQuotes.filter(q => q.status === 'sent' || q.status === 'draft').length;\n    \n    const quotesThisWeek = allQuotes.filter(q => new Date(q.createdAt) >= startOfThisWeek).length;\n    const quotesLastWeek = allQuotes.filter(q => {\n      const date = new Date(q.createdAt);\n      return date >= startOfLastWeek && date < startOfThisWeek;\n    }).length;\n\n    const totalValue = allQuotes.reduce((sum, q) => sum + Number(q.totalAmount || 0), 0);\n    const averageQuoteValue = totalQuotes > 0 ? totalValue / totalQuotes : 0;\n    \n    const decidedQuotes = approvedQuotes + declinedQuotes;\n    const conversionRate = decidedQuotes > 0 ? (approvedQuotes / decidedQuotes) * 100 : 0;\n\n    // Group by status\n    const statusCounts = ['draft', 'sent', 'approved', 'declined', 'expired'].map(status => ({\n      status,\n      count: allQuotes.filter(q => q.status === status).length,\n    }));\n\n    // Group by creator (get users data)\n    const allUsers = await db.select().from(users);\n    const creatorStats: { [key: string]: { total: number; approved: number; declined: number; userName: string } } = {};\n    \n    allQuotes.forEach(q => {\n      if (q.createdBy) {\n        if (!creatorStats[q.createdBy]) {\n          const user = allUsers.find(u => u.id === q.createdBy);\n          creatorStats[q.createdBy] = {\n            total: 0,\n            approved: 0,\n            declined: 0,\n            userName: user ? `${user.firstName} ${user.lastName}` : 'Unknown',\n          };\n        }\n        creatorStats[q.createdBy].total++;\n        if (q.status === 'approved') creatorStats[q.createdBy].approved++;\n        if (q.status === 'declined') creatorStats[q.createdBy].declined++;\n      }\n    });\n\n    const quotesByCreator = Object.entries(creatorStats).map(([userId, stats]) => ({\n      userId,\n      userName: stats.userName,\n      total: stats.total,\n      approved: stats.approved,\n      declined: stats.declined,\n    }));\n\n    // Calculate pipeline value from leads' opportunity_value (for forecasting)\n    // Pipeline = leads that are not won/lost (active opportunities only)\n    const allLeads = await db.select().from(leads);\n    const activeLeadStages = ['new', 'contacted', 'needs_quote', 'quote_sent', 'follow_up'];\n    // Exclude lost leads from pipeline - only active leads with opportunity value\n    const pipelineValue = allLeads\n      .filter(l => activeLeadStages.includes(l.stage))\n      .reduce((sum, l) => {\n        const value = parseFloat((l as any).opportunityValue) || 0;\n        return sum + value;\n      }, 0);\n    \n    // Won value = opportunity_value of leads that are won (for actual converted revenue)\n    const wonValue = allLeads\n      .filter(l => l.stage === 'won')\n      .reduce((sum, l) => {\n        const value = parseFloat((l as any).opportunityValue) || 0;\n        return sum + value;\n      }, 0);\n\n    return {\n      totalQuotes,\n      sentQuotes,\n      approvedQuotes,\n      declinedQuotes,\n      pendingQuotes,\n      conversionRate,\n      totalValue,\n      averageQuoteValue,\n      quotesThisWeek,\n      quotesLastWeek,\n      quotesByStatus: statusCounts,\n      quotesByCreator,\n      recentQuotes: allQuotes.slice(0, 10),\n      pipelineValue,\n      wonValue,\n    };\n  }\n\n  // ============================================\n  // PROFIT & LOSS COST TRACKING IMPLEMENTATION\n  // ============================================\n\n  // Staff Rate Cards\n  async getStaffRateCard(id: string): Promise<StaffRateCard | undefined> {\n    const [card] = await db.select().from(staffRateCards).where(eq(staffRateCards.id, id));\n    return card;\n  }\n\n  async getStaffRateCards(): Promise<StaffRateCard[]> {\n    return db.select().from(staffRateCards).orderBy(desc(staffRateCards.createdAt));\n  }\n\n  async getStaffRateCardsByUser(userId: string): Promise<StaffRateCard[]> {\n    return db.select().from(staffRateCards)\n      .where(eq(staffRateCards.userId, userId))\n      .orderBy(desc(staffRateCards.effectiveFrom));\n  }\n\n  async getActiveRateByType(userId: string, rateType: string): Promise<StaffRateCard | undefined> {\n    const now = new Date();\n    const [rate] = await db.select().from(staffRateCards)\n      .where(and(\n        eq(staffRateCards.userId, userId),\n        eq(staffRateCards.rateType, rateType),\n        eq(staffRateCards.isActive, true),\n        lte(staffRateCards.effectiveFrom, now),\n        or(isNull(staffRateCards.effectiveUntil), gte(staffRateCards.effectiveUntil, now))\n      ))\n      .orderBy(desc(staffRateCards.effectiveFrom))\n      .limit(1);\n    return rate;\n  }\n\n  async createStaffRateCard(rateCard: InsertStaffRateCard): Promise<StaffRateCard> {\n    const [created] = await db.insert(staffRateCards).values(rateCard).returning();\n    return created;\n  }\n\n  async updateStaffRateCard(id: string, rateCard: Partial<InsertStaffRateCard>): Promise<StaffRateCard | undefined> {\n    const [updated] = await db.update(staffRateCards).set(rateCard).where(eq(staffRateCards.id, id)).returning();\n    return updated;\n  }\n\n  async deleteStaffRateCard(id: string): Promise<boolean> {\n    await db.delete(staffRateCards).where(eq(staffRateCards.id, id));\n    return true;\n  }\n\n  // Quote Cost Components\n  async getQuoteCostComponent(id: string): Promise<QuoteCostComponent | undefined> {\n    const [component] = await db.select().from(quoteCostComponents).where(eq(quoteCostComponents.id, id));\n    return component;\n  }\n\n  async getQuoteCostComponentsByQuote(quoteId: string): Promise<QuoteCostComponent[]> {\n    return db.select().from(quoteCostComponents)\n      .where(eq(quoteCostComponents.quoteId, quoteId))\n      .orderBy(quoteCostComponents.category, quoteCostComponents.createdAt);\n  }\n\n  async getQuoteCostComponentsByJob(jobId: string): Promise<QuoteCostComponent[]> {\n    return db.select().from(quoteCostComponents)\n      .where(eq(quoteCostComponents.jobId, jobId))\n      .orderBy(quoteCostComponents.category, quoteCostComponents.createdAt);\n  }\n\n  async createQuoteCostComponent(component: InsertQuoteCostComponent): Promise<QuoteCostComponent> {\n    const [created] = await db.insert(quoteCostComponents).values(component).returning();\n    return created;\n  }\n\n  async updateQuoteCostComponent(id: string, component: Partial<InsertQuoteCostComponent>): Promise<QuoteCostComponent | undefined> {\n    const [updated] = await db.update(quoteCostComponents)\n      .set({ ...component, updatedAt: new Date() })\n      .where(eq(quoteCostComponents.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteQuoteCostComponent(id: string): Promise<boolean> {\n    await db.delete(quoteCostComponents).where(eq(quoteCostComponents.id, id));\n    return true;\n  }\n\n  // Quote Trips\n  async getQuoteTrip(id: string): Promise<QuoteTrip | undefined> {\n    const [trip] = await db.select().from(quoteTrips).where(eq(quoteTrips.id, id));\n    return trip;\n  }\n\n  async getQuoteTripsByQuote(quoteId: string): Promise<QuoteTrip[]> {\n    return db.select().from(quoteTrips)\n      .where(eq(quoteTrips.quoteId, quoteId))\n      .orderBy(quoteTrips.scheduledDate, quoteTrips.createdAt);\n  }\n\n  async getQuoteTripsByJob(jobId: string): Promise<QuoteTrip[]> {\n    return db.select().from(quoteTrips)\n      .where(eq(quoteTrips.jobId, jobId))\n      .orderBy(quoteTrips.scheduledDate, quoteTrips.createdAt);\n  }\n\n  async getQuoteTripsByStaff(staffId: string): Promise<QuoteTrip[]> {\n    return db.select().from(quoteTrips)\n      .where(eq(quoteTrips.staffId, staffId))\n      .orderBy(desc(quoteTrips.scheduledDate));\n  }\n\n  async createQuoteTrip(trip: InsertQuoteTrip): Promise<QuoteTrip> {\n    const [created] = await db.insert(quoteTrips).values(trip).returning();\n    return created;\n  }\n\n  async updateQuoteTrip(id: string, trip: Partial<InsertQuoteTrip>): Promise<QuoteTrip | undefined> {\n    const [updated] = await db.update(quoteTrips).set(trip).where(eq(quoteTrips.id, id)).returning();\n    return updated;\n  }\n\n  async deleteQuoteTrip(id: string): Promise<boolean> {\n    await db.delete(quoteTrips).where(eq(quoteTrips.id, id));\n    return true;\n  }\n\n  // Quote Admin Time\n  async getQuoteAdminTime(id: string): Promise<QuoteAdminTime | undefined> {\n    const [adminTime] = await db.select().from(quoteAdminTime).where(eq(quoteAdminTime.id, id));\n    return adminTime;\n  }\n\n  async getQuoteAdminTimeByQuote(quoteId: string): Promise<QuoteAdminTime[]> {\n    return db.select().from(quoteAdminTime)\n      .where(eq(quoteAdminTime.quoteId, quoteId))\n      .orderBy(desc(quoteAdminTime.createdAt));\n  }\n\n  async getQuoteAdminTimeByJob(jobId: string): Promise<QuoteAdminTime[]> {\n    return db.select().from(quoteAdminTime)\n      .where(eq(quoteAdminTime.jobId, jobId))\n      .orderBy(desc(quoteAdminTime.createdAt));\n  }\n\n  async getQuoteAdminTimeByStaff(staffId: string): Promise<QuoteAdminTime[]> {\n    return db.select().from(quoteAdminTime)\n      .where(eq(quoteAdminTime.staffId, staffId))\n      .orderBy(desc(quoteAdminTime.createdAt));\n  }\n\n  async createQuoteAdminTime(adminTime: InsertQuoteAdminTime): Promise<QuoteAdminTime> {\n    const [created] = await db.insert(quoteAdminTime).values(adminTime).returning();\n    return created;\n  }\n\n  async updateQuoteAdminTime(id: string, adminTime: Partial<InsertQuoteAdminTime>): Promise<QuoteAdminTime | undefined> {\n    const [updated] = await db.update(quoteAdminTime).set(adminTime).where(eq(quoteAdminTime.id, id)).returning();\n    return updated;\n  }\n\n  async deleteQuoteAdminTime(id: string): Promise<boolean> {\n    await db.delete(quoteAdminTime).where(eq(quoteAdminTime.id, id));\n    return true;\n  }\n\n  // Travel Sessions\n  async getTravelSession(id: string): Promise<TravelSession | undefined> {\n    const [session] = await db.select().from(travelSessions).where(eq(travelSessions.id, id));\n    return session;\n  }\n\n  async getTravelSessionsByTrip(tripId: string): Promise<TravelSession[]> {\n    return db.select().from(travelSessions)\n      .where(eq(travelSessions.tripId, tripId))\n      .orderBy(desc(travelSessions.createdAt));\n  }\n\n  async getActiveTravelSessions(): Promise<TravelSession[]> {\n    return db.select().from(travelSessions)\n      .where(eq(travelSessions.status, 'in_transit'))\n      .orderBy(travelSessions.startedAt);\n  }\n\n  async createTravelSession(session: InsertTravelSession): Promise<TravelSession> {\n    const [created] = await db.insert(travelSessions).values(session).returning();\n    return created;\n  }\n\n  async updateTravelSession(id: string, session: Partial<InsertTravelSession>): Promise<TravelSession | undefined> {\n    const [updated] = await db.update(travelSessions).set(session).where(eq(travelSessions.id, id)).returning();\n    return updated;\n  }\n\n  // Quote Ground Conditions\n  async getQuoteGroundCondition(id: string): Promise<QuoteGroundCondition | undefined> {\n    const [condition] = await db.select().from(quoteGroundConditions).where(eq(quoteGroundConditions.id, id));\n    return condition;\n  }\n\n  async getQuoteGroundConditionsByQuote(quoteId: string): Promise<QuoteGroundCondition[]> {\n    return db.select().from(quoteGroundConditions)\n      .where(eq(quoteGroundConditions.quoteId, quoteId))\n      .orderBy(quoteGroundConditions.createdAt);\n  }\n\n  async createQuoteGroundCondition(condition: InsertQuoteGroundCondition): Promise<QuoteGroundCondition> {\n    const [created] = await db.insert(quoteGroundConditions).values(condition).returning();\n    return created;\n  }\n\n  async updateQuoteGroundCondition(id: string, condition: Partial<InsertQuoteGroundCondition>): Promise<QuoteGroundCondition | undefined> {\n    const [updated] = await db.update(quoteGroundConditions).set(condition).where(eq(quoteGroundConditions.id, id)).returning();\n    return updated;\n  }\n\n  async deleteQuoteGroundCondition(id: string): Promise<boolean> {\n    await db.delete(quoteGroundConditions).where(eq(quoteGroundConditions.id, id));\n    return true;\n  }\n\n  // Quote P&L Summary\n  async getQuotePLSummary(id: string): Promise<QuotePLSummary | undefined> {\n    const [summary] = await db.select().from(quotePLSummary).where(eq(quotePLSummary.id, id));\n    return summary;\n  }\n\n  async getQuotePLSummaryByQuote(quoteId: string): Promise<QuotePLSummary | undefined> {\n    const [summary] = await db.select().from(quotePLSummary).where(eq(quotePLSummary.quoteId, quoteId));\n    return summary;\n  }\n\n  async getQuotePLSummaryByJob(jobId: string): Promise<QuotePLSummary | undefined> {\n    const [summary] = await db.select().from(quotePLSummary).where(eq(quotePLSummary.jobId, jobId));\n    return summary;\n  }\n\n  async createQuotePLSummary(summary: InsertQuotePLSummary): Promise<QuotePLSummary> {\n    const [created] = await db.insert(quotePLSummary).values(summary).returning();\n    return created;\n  }\n\n  async updateQuotePLSummary(id: string, summary: Partial<InsertQuotePLSummary>): Promise<QuotePLSummary | undefined> {\n    const [updated] = await db.update(quotePLSummary)\n      .set({ ...summary, updatedAt: new Date(), lastCalculatedAt: new Date() })\n      .where(eq(quotePLSummary.id, id))\n      .returning();\n    return updated;\n  }\n\n  async recalculateQuotePLSummary(quoteId: string): Promise<QuotePLSummary | undefined> {\n    // Get the quote\n    const quote = await this.getQuote(quoteId);\n    if (!quote) return undefined;\n\n    // Get all cost components\n    const costComponents = await this.getQuoteCostComponentsByQuote(quoteId);\n    \n    // Get all trips\n    const trips = await this.getQuoteTripsByQuote(quoteId);\n    \n    // Get all admin time\n    const adminTimes = await this.getQuoteAdminTimeByQuote(quoteId);\n    \n    // Get ground conditions\n    const groundConditions = await this.getQuoteGroundConditionsByQuote(quoteId);\n\n    // Calculate costs by category\n    const materialsCost = costComponents\n      .filter(c => c.category === 'materials')\n      .reduce((sum, c) => sum + Number(c.totalCost || 0), 0);\n\n    const manufacturingLabourCost = costComponents\n      .filter(c => c.category === 'manufacturing_labour')\n      .reduce((sum, c) => sum + Number(c.totalCost || 0), 0);\n\n    const installationLabourCost = costComponents\n      .filter(c => c.category === 'install_labour')\n      .reduce((sum, c) => sum + Number(c.totalCost || 0), 0);\n\n    const supplierDeliveryFees = costComponents\n      .filter(c => c.category === 'supplier_fees')\n      .reduce((sum, c) => sum + Number(c.totalCost || 0), 0);\n\n    const thirdPartyCost = costComponents\n      .filter(c => c.category === 'third_party')\n      .reduce((sum, c) => sum + Number(c.totalCost || 0), 0);\n\n    // Calculate travel costs from trips\n    const travelCost = trips.reduce((sum, t) => sum + Number(t.travelCostTotal || 0), 0);\n    const totalTravelMinutes = trips.reduce((sum, t) => sum + (t.durationMinutes || 0), 0);\n\n    // Calculate admin costs\n    const adminCost = adminTimes.reduce((sum, a) => sum + Number(a.totalCost || 0), 0);\n    const totalAdminMinutes = adminTimes.reduce((sum, a) => sum + (a.durationMinutes || 0), 0);\n\n    // Calculate ground conditions costs\n    const groundConditionsCost = groundConditions.reduce((sum, g) => sum + Number(g.additionalCost || 0), 0);\n\n    // Total revenue is from the quote\n    const totalRevenue = Number(quote.totalAmount || 0);\n\n    // Calculate totals\n    const totalCost = materialsCost + manufacturingLabourCost + installationLabourCost + \n                      travelCost + adminCost + supplierDeliveryFees + thirdPartyCost + groundConditionsCost;\n    \n    const profitAmount = totalRevenue - totalCost;\n    const profitMarginPercent = totalRevenue > 0 ? (profitAmount / totalRevenue) * 100 : 0;\n\n    // Manufacturing minutes from production cost components\n    const totalManufacturingMinutes = costComponents\n      .filter(c => c.category === 'manufacturing_labour')\n      .reduce((sum, c) => sum + Number(c.quantity || 0) * 60, 0); // Assuming quantity is hours\n\n    // Install minutes\n    const totalInstallMinutes = costComponents\n      .filter(c => c.category === 'install_labour')\n      .reduce((sum, c) => sum + Number(c.quantity || 0) * 60, 0);\n\n    const summaryData = {\n      quoteId,\n      totalRevenue: totalRevenue.toString(),\n      materialsCost: materialsCost.toString(),\n      manufacturingLabourCost: manufacturingLabourCost.toString(),\n      installationLabourCost: installationLabourCost.toString(),\n      travelCost: travelCost.toString(),\n      adminCost: adminCost.toString(),\n      supplierDeliveryFees: supplierDeliveryFees.toString(),\n      thirdPartyCost: thirdPartyCost.toString(),\n      groundConditionsCost: groundConditionsCost.toString(),\n      totalCost: totalCost.toString(),\n      profitAmount: profitAmount.toString(),\n      profitMarginPercent: profitMarginPercent.toFixed(2),\n      isSupplyOnly: !quote.labourEstimate || Number(quote.labourEstimate) === 0,\n      actualTripCount: trips.length,\n      totalManufacturingMinutes: Math.round(totalManufacturingMinutes),\n      totalInstallMinutes: Math.round(totalInstallMinutes),\n      totalAdminMinutes,\n      totalTravelMinutes,\n    };\n\n    // Check if summary exists, update or create\n    const existing = await this.getQuotePLSummaryByQuote(quoteId);\n    if (existing) {\n      return this.updateQuotePLSummary(existing.id, summaryData);\n    } else {\n      return this.createQuotePLSummary(summaryData);\n    }\n  }\n\n  // ============================================\n  // ORGANISATION HUB IMPLEMENTATIONS\n  // ============================================\n\n  // Departments\n  async getDepartment(id: string): Promise<Department | undefined> {\n    const [department] = await db.select().from(departments).where(eq(departments.id, id));\n    return department;\n  }\n\n  async getDepartments(): Promise<Department[]> {\n    return db.select().from(departments).orderBy(departments.name);\n  }\n\n  async createDepartment(department: InsertDepartment): Promise<Department> {\n    const [created] = await db.insert(departments).values(department).returning();\n    return created;\n  }\n\n  async updateDepartment(id: string, department: Partial<InsertDepartment>): Promise<Department | undefined> {\n    const [updated] = await db.update(departments)\n      .set({ ...department, updatedAt: new Date() })\n      .where(eq(departments.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteDepartment(id: string): Promise<boolean> {\n    const result = await db.delete(departments).where(eq(departments.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // Workflows\n  async getWorkflow(id: string): Promise<Workflow | undefined> {\n    const [workflow] = await db.select().from(workflows).where(eq(workflows.id, id));\n    return workflow;\n  }\n\n  async getWorkflows(): Promise<Workflow[]> {\n    return db.select().from(workflows).orderBy(desc(workflows.updatedAt));\n  }\n\n  async getWorkflowsByDepartment(departmentId: string): Promise<Workflow[]> {\n    return db.select().from(workflows).where(eq(workflows.departmentId, departmentId)).orderBy(workflows.title);\n  }\n\n  async getWorkflowsByCategory(category: string): Promise<Workflow[]> {\n    return db.select().from(workflows).where(eq(workflows.category, category as any)).orderBy(workflows.title);\n  }\n\n  async getActiveWorkflows(): Promise<Workflow[]> {\n    return db.select().from(workflows).where(eq(workflows.status, 'active')).orderBy(workflows.title);\n  }\n\n  async createWorkflow(workflow: InsertWorkflow): Promise<Workflow> {\n    const [created] = await db.insert(workflows).values(workflow).returning();\n    return created;\n  }\n\n  async updateWorkflow(id: string, workflow: Partial<InsertWorkflow>): Promise<Workflow | undefined> {\n    const [updated] = await db.update(workflows)\n      .set({ ...workflow, updatedAt: new Date() })\n      .where(eq(workflows.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteWorkflow(id: string): Promise<boolean> {\n    const result = await db.delete(workflows).where(eq(workflows.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // Workflow Versions\n  async getWorkflowVersion(id: string): Promise<WorkflowVersion | undefined> {\n    const [version] = await db.select().from(workflowVersions).where(eq(workflowVersions.id, id));\n    return version;\n  }\n\n  async getWorkflowVersionsByWorkflow(workflowId: string): Promise<WorkflowVersion[]> {\n    return db.select().from(workflowVersions)\n      .where(eq(workflowVersions.workflowId, workflowId))\n      .orderBy(desc(workflowVersions.versionNumber));\n  }\n\n  async getLatestWorkflowVersion(workflowId: string): Promise<WorkflowVersion | undefined> {\n    const [version] = await db.select().from(workflowVersions)\n      .where(eq(workflowVersions.workflowId, workflowId))\n      .orderBy(desc(workflowVersions.versionNumber))\n      .limit(1);\n    return version;\n  }\n\n  async createWorkflowVersion(version: InsertWorkflowVersion): Promise<WorkflowVersion> {\n    const [created] = await db.insert(workflowVersions).values(version).returning();\n    return created;\n  }\n\n  async updateWorkflowVersion(id: string, version: Partial<InsertWorkflowVersion>): Promise<WorkflowVersion | undefined> {\n    const [updated] = await db.update(workflowVersions)\n      .set(version)\n      .where(eq(workflowVersions.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Policies\n  async getPolicy(id: string): Promise<Policy | undefined> {\n    const [policy] = await db.select().from(policies).where(eq(policies.id, id));\n    return policy;\n  }\n\n  async getPolicies(): Promise<Policy[]> {\n    return db.select().from(policies).orderBy(desc(policies.updatedAt));\n  }\n\n  async getPoliciesByDepartment(departmentId: string): Promise<Policy[]> {\n    return db.select().from(policies).where(eq(policies.departmentId, departmentId)).orderBy(policies.title);\n  }\n\n  async getPoliciesByCategory(category: string): Promise<Policy[]> {\n    return db.select().from(policies).where(eq(policies.category, category as any)).orderBy(policies.title);\n  }\n\n  async getActivePolicies(): Promise<Policy[]> {\n    return db.select().from(policies).where(eq(policies.status, 'active')).orderBy(policies.title);\n  }\n\n  async createPolicy(policy: InsertPolicy): Promise<Policy> {\n    const [created] = await db.insert(policies).values(policy).returning();\n    return created;\n  }\n\n  async updatePolicy(id: string, policy: Partial<InsertPolicy>): Promise<Policy | undefined> {\n    const [updated] = await db.update(policies)\n      .set({ ...policy, updatedAt: new Date() })\n      .where(eq(policies.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deletePolicy(id: string): Promise<boolean> {\n    const result = await db.delete(policies).where(eq(policies.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // Policy Versions\n  async getPolicyVersion(id: string): Promise<PolicyVersion | undefined> {\n    const [version] = await db.select().from(policyVersions).where(eq(policyVersions.id, id));\n    return version;\n  }\n\n  async getPolicyVersionsByPolicy(policyId: string): Promise<PolicyVersion[]> {\n    return db.select().from(policyVersions)\n      .where(eq(policyVersions.policyId, policyId))\n      .orderBy(desc(policyVersions.versionNumber));\n  }\n\n  async getLatestPolicyVersion(policyId: string): Promise<PolicyVersion | undefined> {\n    const [version] = await db.select().from(policyVersions)\n      .where(eq(policyVersions.policyId, policyId))\n      .orderBy(desc(policyVersions.versionNumber))\n      .limit(1);\n    return version;\n  }\n\n  async createPolicyVersion(version: InsertPolicyVersion): Promise<PolicyVersion> {\n    const [created] = await db.insert(policyVersions).values(version).returning();\n    return created;\n  }\n\n  async updatePolicyVersion(id: string, version: Partial<InsertPolicyVersion>): Promise<PolicyVersion | undefined> {\n    const [updated] = await db.update(policyVersions)\n      .set(version)\n      .where(eq(policyVersions.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Policy Acknowledgements\n  async getPolicyAcknowledgement(id: string): Promise<PolicyAcknowledgement | undefined> {\n    const [ack] = await db.select().from(policyAcknowledgements).where(eq(policyAcknowledgements.id, id));\n    return ack;\n  }\n\n  async getPolicyAcknowledgementsByPolicy(policyId: string): Promise<PolicyAcknowledgement[]> {\n    return db.select().from(policyAcknowledgements)\n      .where(eq(policyAcknowledgements.policyId, policyId))\n      .orderBy(desc(policyAcknowledgements.acknowledgedAt));\n  }\n\n  async getPolicyAcknowledgementsByUser(userId: string): Promise<PolicyAcknowledgement[]> {\n    return db.select().from(policyAcknowledgements)\n      .where(eq(policyAcknowledgements.userId, userId))\n      .orderBy(desc(policyAcknowledgements.acknowledgedAt));\n  }\n\n  async hasUserAcknowledgedPolicy(userId: string, policyVersionId: string): Promise<boolean> {\n    const [ack] = await db.select().from(policyAcknowledgements)\n      .where(and(\n        eq(policyAcknowledgements.userId, userId),\n        eq(policyAcknowledgements.policyVersionId, policyVersionId)\n      ));\n    return !!ack;\n  }\n\n  async createPolicyAcknowledgement(acknowledgement: InsertPolicyAcknowledgement): Promise<PolicyAcknowledgement> {\n    const [created] = await db.insert(policyAcknowledgements).values(acknowledgement).returning();\n    return created;\n  }\n\n  // Resources\n  async getResource(id: string): Promise<Resource | undefined> {\n    const [resource] = await db.select().from(resources).where(eq(resources.id, id));\n    return resource;\n  }\n\n  async getResources(): Promise<Resource[]> {\n    return db.select().from(resources).orderBy(desc(resources.uploadedAt));\n  }\n\n  async getResourcesByDepartment(departmentId: string): Promise<Resource[]> {\n    return db.select().from(resources).where(eq(resources.departmentId, departmentId)).orderBy(resources.title);\n  }\n\n  async searchResources(query: string): Promise<Resource[]> {\n    return db.select().from(resources)\n      .where(or(\n        like(resources.title, `%${query}%`),\n        like(resources.description, `%${query}%`)\n      ))\n      .orderBy(desc(resources.uploadedAt));\n  }\n\n  async createResource(resource: InsertResource): Promise<Resource> {\n    const [created] = await db.insert(resources).values(resource).returning();\n    return created;\n  }\n\n  async updateResource(id: string, resource: Partial<InsertResource>): Promise<Resource | undefined> {\n    const [updated] = await db.update(resources)\n      .set(resource)\n      .where(eq(resources.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteResource(id: string): Promise<boolean> {\n    const result = await db.delete(resources).where(eq(resources.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // Knowledge Articles\n  async getKnowledgeArticle(id: string): Promise<KnowledgeArticle | undefined> {\n    const [article] = await db.select().from(knowledgeArticles).where(eq(knowledgeArticles.id, id));\n    return article;\n  }\n\n  async getKnowledgeArticleBySlug(slug: string): Promise<KnowledgeArticle | undefined> {\n    const [article] = await db.select().from(knowledgeArticles).where(eq(knowledgeArticles.slug, slug));\n    return article;\n  }\n\n  async getKnowledgeArticles(): Promise<KnowledgeArticle[]> {\n    return db.select().from(knowledgeArticles).orderBy(desc(knowledgeArticles.updatedAt));\n  }\n\n  async getPublishedKnowledgeArticles(): Promise<KnowledgeArticle[]> {\n    return db.select().from(knowledgeArticles)\n      .where(eq(knowledgeArticles.isPublished, true))\n      .orderBy(knowledgeArticles.title);\n  }\n\n  async getKnowledgeArticlesByDepartment(departmentId: string): Promise<KnowledgeArticle[]> {\n    return db.select().from(knowledgeArticles)\n      .where(eq(knowledgeArticles.departmentId, departmentId))\n      .orderBy(knowledgeArticles.title);\n  }\n\n  async searchKnowledgeArticles(query: string): Promise<KnowledgeArticle[]> {\n    return db.select().from(knowledgeArticles)\n      .where(or(\n        like(knowledgeArticles.title, `%${query}%`),\n        like(knowledgeArticles.contentMarkdown, `%${query}%`)\n      ))\n      .orderBy(desc(knowledgeArticles.updatedAt));\n  }\n\n  async createKnowledgeArticle(article: InsertKnowledgeArticle): Promise<KnowledgeArticle> {\n    const [created] = await db.insert(knowledgeArticles).values(article).returning();\n    return created;\n  }\n\n  async updateKnowledgeArticle(id: string, article: Partial<InsertKnowledgeArticle>): Promise<KnowledgeArticle | undefined> {\n    const [updated] = await db.update(knowledgeArticles)\n      .set({ ...article, updatedAt: new Date() })\n      .where(eq(knowledgeArticles.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteKnowledgeArticle(id: string): Promise<boolean> {\n    const result = await db.delete(knowledgeArticles).where(eq(knowledgeArticles.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // ============================================\n  // LIVE DOCUMENT TEMPLATES\n  // ============================================\n\n  async getLiveDocumentTemplate(id: string): Promise<LiveDocumentTemplate | undefined> {\n    const [template] = await db.select().from(liveDocumentTemplates).where(eq(liveDocumentTemplates.id, id));\n    return template;\n  }\n\n  async getLiveDocumentTemplates(): Promise<LiveDocumentTemplate[]> {\n    return db.select().from(liveDocumentTemplates).orderBy(desc(liveDocumentTemplates.createdAt));\n  }\n\n  async getActiveLiveDocumentTemplates(): Promise<LiveDocumentTemplate[]> {\n    return db.select().from(liveDocumentTemplates)\n      .where(eq(liveDocumentTemplates.isActive, true))\n      .orderBy(desc(liveDocumentTemplates.createdAt));\n  }\n\n  async getDefaultLiveDocumentTemplate(): Promise<LiveDocumentTemplate | undefined> {\n    const [template] = await db.select().from(liveDocumentTemplates)\n      .where(and(\n        eq(liveDocumentTemplates.isDefault, true),\n        eq(liveDocumentTemplates.isActive, true)\n      ));\n    return template;\n  }\n\n  async createLiveDocumentTemplate(template: InsertLiveDocumentTemplate): Promise<LiveDocumentTemplate> {\n    // If this template is being set as default, unset other defaults\n    if (template.isDefault) {\n      await db.update(liveDocumentTemplates).set({ isDefault: false });\n    }\n    const [created] = await db.insert(liveDocumentTemplates).values(template as any).returning();\n    return created;\n  }\n\n  async updateLiveDocumentTemplate(id: string, template: Partial<InsertLiveDocumentTemplate>): Promise<LiveDocumentTemplate | undefined> {\n    // If setting this as default, unset other defaults first\n    if (template.isDefault) {\n      await db.update(liveDocumentTemplates).set({ isDefault: false }).where(sql`id != ${id}`);\n    }\n    const [updated] = await db.update(liveDocumentTemplates)\n      .set({ ...template, updatedAt: new Date() } as any)\n      .where(eq(liveDocumentTemplates.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteLiveDocumentTemplate(id: string): Promise<boolean> {\n    const result = await db.delete(liveDocumentTemplates).where(eq(liveDocumentTemplates.id, id));\n    return true;\n  }\n\n  // ============================================\n  // JOB SETUP DOCUMENTS\n  // ============================================\n\n  async getJobSetupDocument(id: string): Promise<JobSetupDocument | undefined> {\n    const [document] = await db.select().from(jobSetupDocuments).where(eq(jobSetupDocuments.id, id));\n    return document;\n  }\n\n  async getJobSetupDocumentByJob(jobId: string): Promise<JobSetupDocument | undefined> {\n    const [document] = await db.select().from(jobSetupDocuments).where(eq(jobSetupDocuments.jobId, jobId));\n    return document;\n  }\n\n  async getJobSetupDocumentByLead(leadId: string): Promise<JobSetupDocument | undefined> {\n    const [document] = await db.select().from(jobSetupDocuments).where(eq(jobSetupDocuments.leadId, leadId));\n    return document;\n  }\n\n  async getJobSetupDocuments(): Promise<JobSetupDocument[]> {\n    return db.select().from(jobSetupDocuments).orderBy(desc(jobSetupDocuments.createdAt));\n  }\n\n  async getJobSetupDocumentsByStatus(status: string): Promise<JobSetupDocument[]> {\n    return db.select().from(jobSetupDocuments)\n      .where(eq(jobSetupDocuments.status, status as any))\n      .orderBy(desc(jobSetupDocuments.createdAt));\n  }\n\n  async createJobSetupDocument(document: InsertJobSetupDocument): Promise<JobSetupDocument> {\n    const [created] = await db.insert(jobSetupDocuments).values(document as any).returning();\n    return created;\n  }\n\n  async updateJobSetupDocument(id: string, document: Partial<InsertJobSetupDocument>): Promise<JobSetupDocument | undefined> {\n    const [updated] = await db.update(jobSetupDocuments)\n      .set({ ...document, updatedAt: new Date() } as any)\n      .where(eq(jobSetupDocuments.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteJobSetupDocument(id: string): Promise<boolean> {\n    // First delete associated products\n    await db.delete(jobSetupProducts).where(eq(jobSetupProducts.jobSetupDocumentId, id));\n    // Then delete the document\n    const result = await db.delete(jobSetupDocuments).where(eq(jobSetupDocuments.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // Section-specific updates\n  async updateJobSetupSection1(id: string, section: JobSetupSection1Sales): Promise<JobSetupDocument | undefined> {\n    const [updated] = await db.update(jobSetupDocuments)\n      .set({ section1Sales: section, updatedAt: new Date() })\n      .where(eq(jobSetupDocuments.id, id))\n      .returning();\n    return updated;\n  }\n\n  async updateJobSetupSection2Meta(id: string, section: JobSetupSection2ProductsMeta): Promise<JobSetupDocument | undefined> {\n    const [updated] = await db.update(jobSetupDocuments)\n      .set({ section2ProductsMeta: section, updatedAt: new Date() })\n      .where(eq(jobSetupDocuments.id, id))\n      .returning();\n    return updated;\n  }\n\n  async updateJobSetupSection3(id: string, section: JobSetupSection3Production): Promise<JobSetupDocument | undefined> {\n    const [updated] = await db.update(jobSetupDocuments)\n      .set({ section3Production: section, updatedAt: new Date() })\n      .where(eq(jobSetupDocuments.id, id))\n      .returning();\n    return updated;\n  }\n\n  async updateJobSetupSection4(id: string, section: JobSetupSection4Schedule): Promise<JobSetupDocument | undefined> {\n    const [updated] = await db.update(jobSetupDocuments)\n      .set({ section4Schedule: section, updatedAt: new Date() })\n      .where(eq(jobSetupDocuments.id, id))\n      .returning();\n    return updated;\n  }\n\n  async updateJobSetupSection5(id: string, section: JobSetupSection5Install): Promise<JobSetupDocument | undefined> {\n    const [updated] = await db.update(jobSetupDocuments)\n      .set({ section5Install: section, updatedAt: new Date() })\n      .where(eq(jobSetupDocuments.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Section completion\n  async markSectionComplete(id: string, sectionNumber: 1 | 2 | 3 | 4 | 5, complete: boolean): Promise<JobSetupDocument | undefined> {\n    const sectionField = `section${sectionNumber}Complete` as keyof typeof jobSetupDocuments.$inferInsert;\n    const [updated] = await db.update(jobSetupDocuments)\n      .set({ [sectionField]: complete, updatedAt: new Date() } as any)\n      .where(eq(jobSetupDocuments.id, id))\n      .returning();\n    \n    // Recalculate document status after marking section\n    if (updated) {\n      return this.recalculateDocumentStatus(id);\n    }\n    return updated;\n  }\n\n  async recalculateDocumentStatus(id: string): Promise<JobSetupDocument | undefined> {\n    const document = await this.getJobSetupDocument(id);\n    if (!document) return undefined;\n\n    let newStatus: string = document.status;\n\n    // Determine new status based on section completion\n    if (document.section5Complete) {\n      newStatus = \"completed\";\n    } else if (document.section4Complete) {\n      newStatus = \"ready_for_install\";\n    } else if (document.section3Complete) {\n      newStatus = \"ready_for_scheduling\";\n    } else if (document.section1Complete && document.section2Complete) {\n      newStatus = \"ready_for_production\";\n    } else if (document.section1Complete || document.section2Complete) {\n      newStatus = \"in_progress\";\n    } else {\n      newStatus = \"draft\";\n    }\n\n    if (newStatus !== document.status) {\n      const [updated] = await db.update(jobSetupDocuments)\n        .set({ status: newStatus as any, updatedAt: new Date() })\n        .where(eq(jobSetupDocuments.id, id))\n        .returning();\n      return updated;\n    }\n\n    return document;\n  }\n\n  // Job Setup Products\n  async getJobSetupProduct(id: string): Promise<JobSetupProduct | undefined> {\n    const [product] = await db.select().from(jobSetupProducts).where(eq(jobSetupProducts.id, id));\n    return product;\n  }\n\n  async getJobSetupProductsByDocument(documentId: string): Promise<JobSetupProduct[]> {\n    return db.select().from(jobSetupProducts)\n      .where(eq(jobSetupProducts.jobSetupDocumentId, documentId))\n      .orderBy(jobSetupProducts.category, jobSetupProducts.productName);\n  }\n\n  async createJobSetupProduct(product: InsertJobSetupProduct): Promise<JobSetupProduct> {\n    const [created] = await db.insert(jobSetupProducts).values(product).returning();\n    return created;\n  }\n\n  async createJobSetupProducts(productsToCreate: InsertJobSetupProduct[]): Promise<JobSetupProduct[]> {\n    if (productsToCreate.length === 0) return [];\n    return db.insert(jobSetupProducts).values(productsToCreate).returning();\n  }\n\n  async updateJobSetupProduct(id: string, product: Partial<InsertJobSetupProduct>): Promise<JobSetupProduct | undefined> {\n    const [updated] = await db.update(jobSetupProducts)\n      .set({ ...product, updatedAt: new Date() })\n      .where(eq(jobSetupProducts.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteJobSetupProduct(id: string): Promise<boolean> {\n    const result = await db.delete(jobSetupProducts).where(eq(jobSetupProducts.id, id)).returning();\n    return result.length > 0;\n  }\n\n  async deleteJobSetupProductsByDocument(documentId: string): Promise<boolean> {\n    const result = await db.delete(jobSetupProducts)\n      .where(eq(jobSetupProducts.jobSetupDocumentId, documentId))\n      .returning();\n    return result.length > 0;\n  }\n\n  // Seed products from quote\n  async seedJobSetupProductsFromQuote(documentId: string, quoteId: string): Promise<JobSetupProduct[]> {\n    const quote = await this.getQuote(quoteId);\n    if (!quote || !quote.lineItems) return [];\n\n    // Get all products to validate productId references\n    const allProducts = await this.getProducts();\n    const productIdSet = new Set(allProducts.map(p => p.id));\n\n    // Map quote line items to job setup products\n    const productsToCreate: InsertJobSetupProduct[] = quote.lineItems.map((item: any) => {\n      // Determine category based on product name or other indicators\n      let category: string = \"other\";\n      const nameLower = item.productName?.toLowerCase() || \"\";\n      if (nameLower.includes(\"post\")) category = \"post\";\n      else if (nameLower.includes(\"rail\")) category = \"rail\";\n      else if (nameLower.includes(\"panel\") || nameLower.includes(\"picket\")) category = \"panel\";\n      else if (nameLower.includes(\"cap\")) category = \"cap\";\n      else if (nameLower.includes(\"gate\")) category = \"gate\";\n      else if (nameLower.includes(\"hardware\") || nameLower.includes(\"screw\") || nameLower.includes(\"bracket\")) category = \"hardware\";\n      else if (nameLower.includes(\"cement\") || nameLower.includes(\"concrete\")) category = \"cement\";\n\n      // Only use productId if it's a valid UUID that exists in the products table\n      // Quote line items might have SKUs instead of UUIDs, so we need to validate\n      const validProductId = item.productId && productIdSet.has(item.productId) ? item.productId : null;\n\n      return {\n        jobSetupDocumentId: documentId,\n        productId: validProductId,\n        productName: item.productName || \"Unknown Product\",\n        sku: !validProductId && item.productId ? item.productId : null,\n        category: category as any,\n        quantity: item.quantity || 0,\n        unitInfo: null,\n        notes: item.notes || null,\n        sourceQuoteLineId: null,\n        addedBy: null,\n      };\n    });\n\n    // Update section 2 metadata\n    await this.updateJobSetupSection2Meta(documentId, {\n      autoPopulatedFromQuote: true,\n      quoteId: quoteId,\n      lastUpdatedAt: new Date().toISOString(),\n    });\n\n    return this.createJobSetupProducts(productsToCreate);\n  }\n\n  // ============================================\n  // DASHBOARD BUILDER IMPLEMENTATIONS\n  // ============================================\n\n  // Dashboard Widgets (library)\n  async getDashboardWidget(id: string): Promise<DashboardWidget | undefined> {\n    const [widget] = await db.select().from(dashboardWidgets).where(eq(dashboardWidgets.id, id));\n    return widget;\n  }\n\n  async getDashboardWidgets(): Promise<DashboardWidget[]> {\n    return db.select().from(dashboardWidgets).orderBy(dashboardWidgets.category, dashboardWidgets.name);\n  }\n\n  async getDashboardWidgetsByCategory(category: string): Promise<DashboardWidget[]> {\n    return db.select().from(dashboardWidgets).where(eq(dashboardWidgets.category, category as any));\n  }\n\n  async getActiveWidgets(): Promise<DashboardWidget[]> {\n    return db.select().from(dashboardWidgets).where(eq(dashboardWidgets.isActive, true)).orderBy(dashboardWidgets.category, dashboardWidgets.name);\n  }\n\n  async createDashboardWidget(widget: InsertDashboardWidget): Promise<DashboardWidget> {\n    const [created] = await db.insert(dashboardWidgets).values(widget).returning();\n    return created;\n  }\n\n  async updateDashboardWidget(id: string, widget: Partial<InsertDashboardWidget>): Promise<DashboardWidget | undefined> {\n    const [updated] = await db.update(dashboardWidgets)\n      .set(widget)\n      .where(eq(dashboardWidgets.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Role Dashboard Layouts\n  async getRoleDashboardLayout(id: string): Promise<RoleDashboardLayout | undefined> {\n    const [layout] = await db.select().from(roleDashboardLayouts).where(eq(roleDashboardLayouts.id, id));\n    return layout;\n  }\n\n  async getRoleDashboardLayouts(): Promise<RoleDashboardLayout[]> {\n    return db.select().from(roleDashboardLayouts).orderBy(roleDashboardLayouts.role, roleDashboardLayouts.name);\n  }\n\n  async getRoleDashboardLayoutsByRole(role: string): Promise<RoleDashboardLayout[]> {\n    return db.select().from(roleDashboardLayouts).where(eq(roleDashboardLayouts.role, role as any));\n  }\n\n  async getPublishedLayoutForRole(role: string): Promise<RoleDashboardLayout | undefined> {\n    const [layout] = await db.select().from(roleDashboardLayouts)\n      .where(and(\n        eq(roleDashboardLayouts.role, role as any),\n        eq(roleDashboardLayouts.isPublished, true),\n        eq(roleDashboardLayouts.isDefault, true)\n      ));\n    return layout;\n  }\n\n  async getDefaultLayoutForRole(role: string): Promise<RoleDashboardLayout | undefined> {\n    const [layout] = await db.select().from(roleDashboardLayouts)\n      .where(and(\n        eq(roleDashboardLayouts.role, role as any),\n        eq(roleDashboardLayouts.isDefault, true)\n      ));\n    return layout;\n  }\n\n  async createRoleDashboardLayout(layout: InsertRoleDashboardLayout): Promise<RoleDashboardLayout> {\n    const [created] = await db.insert(roleDashboardLayouts).values(layout).returning();\n    return created;\n  }\n\n  async updateRoleDashboardLayout(id: string, layout: Partial<InsertRoleDashboardLayout>): Promise<RoleDashboardLayout | undefined> {\n    const [updated] = await db.update(roleDashboardLayouts)\n      .set({ ...layout, updatedAt: new Date() })\n      .where(eq(roleDashboardLayouts.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteRoleDashboardLayout(id: string): Promise<boolean> {\n    const result = await db.delete(roleDashboardLayouts).where(eq(roleDashboardLayouts.id, id)).returning();\n    return result.length > 0;\n  }\n\n  async publishRoleDashboardLayout(id: string): Promise<RoleDashboardLayout | undefined> {\n    // First get the layout to find its role\n    const layout = await this.getRoleDashboardLayout(id);\n    if (!layout) return undefined;\n\n    // Unpublish any existing published layouts for this role\n    await db.update(roleDashboardLayouts)\n      .set({ isPublished: false, isDefault: false })\n      .where(and(\n        eq(roleDashboardLayouts.role, layout.role),\n        eq(roleDashboardLayouts.isPublished, true)\n      ));\n\n    // Publish this layout\n    const [updated] = await db.update(roleDashboardLayouts)\n      .set({ isPublished: true, isDefault: true, updatedAt: new Date() })\n      .where(eq(roleDashboardLayouts.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Dashboard Widget Instances\n  async getDashboardWidgetInstance(id: string): Promise<DashboardWidgetInstance | undefined> {\n    const [instance] = await db.select().from(dashboardWidgetInstances).where(eq(dashboardWidgetInstances.id, id));\n    return instance;\n  }\n\n  async getDashboardWidgetInstancesByLayout(layoutId: string): Promise<DashboardWidgetInstance[]> {\n    return db.select().from(dashboardWidgetInstances)\n      .where(eq(dashboardWidgetInstances.layoutId, layoutId))\n      .orderBy(dashboardWidgetInstances.positionY, dashboardWidgetInstances.positionX);\n  }\n\n  async createDashboardWidgetInstance(instance: InsertDashboardWidgetInstance): Promise<DashboardWidgetInstance> {\n    const [created] = await db.insert(dashboardWidgetInstances).values(instance).returning();\n    return created;\n  }\n\n  async updateDashboardWidgetInstance(id: string, instance: Partial<InsertDashboardWidgetInstance>): Promise<DashboardWidgetInstance | undefined> {\n    const [updated] = await db.update(dashboardWidgetInstances)\n      .set(instance)\n      .where(eq(dashboardWidgetInstances.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteDashboardWidgetInstance(id: string): Promise<boolean> {\n    const result = await db.delete(dashboardWidgetInstances).where(eq(dashboardWidgetInstances.id, id)).returning();\n    return result.length > 0;\n  }\n\n  async deleteDashboardWidgetInstancesByLayout(layoutId: string): Promise<boolean> {\n    await db.delete(dashboardWidgetInstances).where(eq(dashboardWidgetInstances.layoutId, layoutId));\n    return true;\n  }\n\n  async saveDashboardLayout(layoutId: string, instances: InsertDashboardWidgetInstance[]): Promise<DashboardWidgetInstance[]> {\n    // Delete existing instances for this layout\n    await this.deleteDashboardWidgetInstancesByLayout(layoutId);\n\n    // Insert new instances\n    if (instances.length === 0) return [];\n    \n    const result = await db.insert(dashboardWidgetInstances)\n      .values(instances.map(i => ({ ...i, layoutId })))\n      .returning();\n    return result;\n  }\n\n  // ============================================\n  // BANKING / FINANCIAL\n  // ============================================\n\n  // Bank Connections\n  async getBankConnections(): Promise<BankConnection[]> {\n    return db.select().from(bankConnections).orderBy(desc(bankConnections.createdAt));\n  }\n\n  async getBankConnectionById(id: string): Promise<BankConnection | undefined> {\n    const [connection] = await db.select().from(bankConnections).where(eq(bankConnections.id, id));\n    return connection;\n  }\n\n  async getBankConnectionByInstitution(institutionId: string): Promise<BankConnection | undefined> {\n    const [connection] = await db.select().from(bankConnections).where(eq(bankConnections.institutionId, institutionId));\n    return connection;\n  }\n\n  async createBankConnection(connection: InsertBankConnection): Promise<BankConnection> {\n    const [created] = await db.insert(bankConnections).values(connection).returning();\n    return created;\n  }\n\n  async updateBankConnection(id: string, connection: Partial<InsertBankConnection>): Promise<BankConnection | undefined> {\n    const [updated] = await db.update(bankConnections)\n      .set({ ...connection, updatedAt: new Date() })\n      .where(eq(bankConnections.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteBankConnection(id: string): Promise<boolean> {\n    const result = await db.delete(bankConnections).where(eq(bankConnections.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // Bank Accounts\n  async getBankAccounts(): Promise<BankAccount[]> {\n    return db.select().from(bankAccounts).where(eq(bankAccounts.isActive, true)).orderBy(bankAccounts.name);\n  }\n\n  async getBankAccountsByConnection(connectionId: string): Promise<BankAccount[]> {\n    return db.select().from(bankAccounts)\n      .where(and(eq(bankAccounts.connectionId, connectionId), eq(bankAccounts.isActive, true)))\n      .orderBy(bankAccounts.name);\n  }\n\n  async getBankAccountById(id: string): Promise<BankAccount | undefined> {\n    const [account] = await db.select().from(bankAccounts).where(eq(bankAccounts.id, id));\n    return account;\n  }\n\n  async getBankAccountByName(name: string): Promise<BankAccount | undefined> {\n    const [account] = await db.select().from(bankAccounts).where(eq(bankAccounts.name, name));\n    return account;\n  }\n\n  async createBankAccount(account: InsertBankAccount): Promise<BankAccount> {\n    const [created] = await db.insert(bankAccounts).values(account).returning();\n    return created;\n  }\n\n  async updateBankAccount(id: string, account: Partial<InsertBankAccount>): Promise<BankAccount | undefined> {\n    const [updated] = await db.update(bankAccounts)\n      .set(account)\n      .where(eq(bankAccounts.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteBankAccount(id: string): Promise<boolean> {\n    const result = await db.delete(bankAccounts).where(eq(bankAccounts.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // Bank Transactions\n  async getBankTransactions(accountId: string, filters?: TransactionFilters): Promise<BankTransaction[]> {\n    const conditions = [eq(bankTransactions.accountId, accountId)];\n    \n    if (filters?.fromDate) {\n      conditions.push(gte(bankTransactions.postDate, new Date(filters.fromDate)));\n    }\n    if (filters?.toDate) {\n      conditions.push(lte(bankTransactions.postDate, new Date(filters.toDate)));\n    }\n    if (filters?.category) {\n      conditions.push(eq(bankTransactions.category, filters.category));\n    }\n    if (filters?.direction) {\n      conditions.push(eq(bankTransactions.direction, filters.direction));\n    }\n    if (filters?.search) {\n      conditions.push(or(\n        ilike(bankTransactions.description, `%${filters.search}%`),\n        ilike(bankTransactions.merchantName, `%${filters.search}%`)\n      )!);\n    }\n\n    let query = db.select().from(bankTransactions)\n      .where(and(...conditions))\n      .orderBy(desc(bankTransactions.postDate));\n    \n    if (filters?.limit) {\n      query = query.limit(filters.limit) as typeof query;\n    }\n    if (filters?.offset) {\n      query = query.offset(filters.offset) as typeof query;\n    }\n\n    return query;\n  }\n\n  async getAllBankTransactions(filters?: TransactionFilters): Promise<BankTransaction[]> {\n    const conditions: any[] = [];\n    \n    if (filters?.fromDate) {\n      conditions.push(gte(bankTransactions.postDate, new Date(filters.fromDate)));\n    }\n    if (filters?.toDate) {\n      conditions.push(lte(bankTransactions.postDate, new Date(filters.toDate)));\n    }\n    if (filters?.category) {\n      conditions.push(eq(bankTransactions.category, filters.category));\n    }\n    if (filters?.direction) {\n      conditions.push(eq(bankTransactions.direction, filters.direction));\n    }\n    if (filters?.search) {\n      conditions.push(or(\n        ilike(bankTransactions.description, `%${filters.search}%`),\n        ilike(bankTransactions.merchantName, `%${filters.search}%`)\n      ));\n    }\n    if (filters?.minAmount !== undefined) {\n      conditions.push(gte(bankTransactions.amount, filters.minAmount.toString()));\n    }\n    if (filters?.maxAmount !== undefined) {\n      conditions.push(lte(bankTransactions.amount, filters.maxAmount.toString()));\n    }\n\n    let query = conditions.length > 0 \n      ? db.select().from(bankTransactions).where(and(...conditions)).orderBy(desc(bankTransactions.postDate))\n      : db.select().from(bankTransactions).orderBy(desc(bankTransactions.postDate));\n    \n    if (filters?.limit) {\n      query = query.limit(filters.limit) as typeof query;\n    }\n    if (filters?.offset) {\n      query = query.offset(filters.offset) as typeof query;\n    }\n\n    return query;\n  }\n\n  async getBankTransactionById(id: string): Promise<BankTransaction | undefined> {\n    const [transaction] = await db.select().from(bankTransactions).where(eq(bankTransactions.id, id));\n    return transaction;\n  }\n\n  async createBankTransaction(transaction: InsertBankTransaction): Promise<BankTransaction> {\n    const [created] = await db.insert(bankTransactions).values(transaction).returning();\n    return created;\n  }\n\n  async createBankTransactions(transactions: InsertBankTransaction[]): Promise<BankTransaction[]> {\n    if (transactions.length === 0) return [];\n    const result = await db.insert(bankTransactions).values(transactions).returning();\n    return result;\n  }\n\n  async updateBankTransaction(id: string, transaction: Partial<InsertBankTransaction>): Promise<BankTransaction | undefined> {\n    const [updated] = await db.update(bankTransactions)\n      .set(transaction)\n      .where(eq(bankTransactions.id, id))\n      .returning();\n    return updated;\n  }\n\n  async getTransactionsByStaff(staffId: string, filters?: TransactionFilters): Promise<BankTransaction[]> {\n    const conditions: any[] = [eq(bankTransactions.allocatedStaffId, staffId)];\n    \n    if (filters?.fromDate) {\n      conditions.push(gte(bankTransactions.postDate, new Date(filters.fromDate)));\n    }\n    if (filters?.toDate) {\n      conditions.push(lte(bankTransactions.postDate, new Date(filters.toDate)));\n    }\n    if (filters?.category) {\n      conditions.push(eq(bankTransactions.expenseCategoryId, filters.category));\n    }\n    if (filters?.direction) {\n      conditions.push(eq(bankTransactions.direction, filters.direction));\n    }\n\n    return db.select().from(bankTransactions)\n      .where(and(...conditions))\n      .orderBy(desc(bankTransactions.postDate))\n      .limit(filters?.limit || 100);\n  }\n\n  async getStaffTransactionSummary(): Promise<{ staffId: string; staffName: string; totalSpent: number; transactionCount: number }[]> {\n    const result = await db.select({\n      staffId: bankTransactions.allocatedStaffId,\n      totalSpent: sql<string>`COALESCE(SUM(CASE WHEN ${bankTransactions.direction} = 'debit' THEN ABS(${bankTransactions.amount}::numeric) ELSE 0 END), 0)`,\n      transactionCount: sql<string>`COUNT(*)`,\n    })\n    .from(bankTransactions)\n    .where(isNotNull(bankTransactions.allocatedStaffId))\n    .groupBy(bankTransactions.allocatedStaffId);\n\n    const staffIds = result.map(r => r.staffId).filter(Boolean) as string[];\n    if (staffIds.length === 0) return [];\n\n    const staffUsers = await db.select().from(users).where(inArray(users.id, staffIds));\n    const staffMap = new Map(staffUsers.map(u => [u.id, `${u.firstName} ${u.lastName}`]));\n\n    return result.map(r => ({\n      staffId: r.staffId!,\n      staffName: staffMap.get(r.staffId!) || 'Unknown',\n      totalSpent: parseFloat(r.totalSpent) || 0,\n      transactionCount: parseInt(r.transactionCount) || 0,\n    }));\n  }\n\n  async autoAllocateTransactionsByCardNumber(): Promise<number> {\n    const staffWithCards = await db.select().from(users).where(isNotNull(users.bankCardNumber));\n    if (staffWithCards.length === 0) return 0;\n\n    let allocated = 0;\n    for (const staff of staffWithCards) {\n      if (!staff.bankCardNumber) continue;\n      \n      const result = await db.update(bankTransactions)\n        .set({ \n          allocatedStaffId: staff.id,\n          cardNumberUsed: staff.bankCardNumber \n        })\n        .where(and(\n          isNull(bankTransactions.allocatedStaffId),\n          ilike(bankTransactions.description, `%${staff.bankCardNumber}%`)\n        ))\n        .returning();\n      \n      allocated += result.length;\n    }\n    return allocated;\n  }\n\n  async autoCategorizeTransactionsByKeywords(): Promise<number> {\n    // Get all active expense categories with keywords\n    const categoriesWithKeywords = await db.select()\n      .from(expenseCategories)\n      .where(and(\n        eq(expenseCategories.isActive, true),\n        isNotNull(expenseCategories.keywords)\n      ));\n    \n    if (categoriesWithKeywords.length === 0) return 0;\n\n    // Get uncategorized transactions\n    const uncategorizedTxs = await db.select()\n      .from(bankTransactions)\n      .where(isNull(bankTransactions.expenseCategoryId));\n    \n    let categorized = 0;\n    \n    for (const tx of uncategorizedTxs) {\n      const description = (tx.description || '').toLowerCase();\n      const merchantName = (tx.merchantName || '').toLowerCase();\n      const searchText = `${description} ${merchantName}`;\n      \n      // Find matching category by keywords\n      for (const category of categoriesWithKeywords) {\n        if (!category.keywords || category.keywords.length === 0) continue;\n        \n        const hasMatch = category.keywords.some((keyword: string) => \n          searchText.includes(keyword.toLowerCase())\n        );\n        \n        if (hasMatch) {\n          await db.update(bankTransactions)\n            .set({ expenseCategoryId: category.id })\n            .where(eq(bankTransactions.id, tx.id));\n          categorized++;\n          break; // Only assign first matching category\n        }\n      }\n    }\n    \n    return categorized;\n  }\n\n  // Expense Categories\n  async getExpenseCategories(): Promise<ExpenseCategory[]> {\n    return db.select().from(expenseCategories).orderBy(expenseCategories.sortOrder);\n  }\n\n  async getActiveExpenseCategories(): Promise<ExpenseCategory[]> {\n    return db.select().from(expenseCategories)\n      .where(eq(expenseCategories.isActive, true))\n      .orderBy(expenseCategories.sortOrder);\n  }\n\n  async getExpenseCategory(id: string): Promise<ExpenseCategory | undefined> {\n    const [category] = await db.select().from(expenseCategories).where(eq(expenseCategories.id, id));\n    return category;\n  }\n\n  async createExpenseCategory(category: InsertExpenseCategory): Promise<ExpenseCategory> {\n    const [created] = await db.insert(expenseCategories).values(category).returning();\n    return created;\n  }\n\n  async updateExpenseCategory(id: string, category: Partial<InsertExpenseCategory>): Promise<ExpenseCategory | undefined> {\n    const [updated] = await db.update(expenseCategories)\n      .set({ ...category, updatedAt: new Date() })\n      .where(eq(expenseCategories.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteExpenseCategory(id: string): Promise<boolean> {\n    const result = await db.delete(expenseCategories).where(eq(expenseCategories.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // Receipt Submissions\n  async getReceiptSubmissions(filters?: { status?: string }): Promise<ReceiptSubmission[]> {\n    if (filters?.status) {\n      return db.select().from(receiptSubmissions)\n        .where(eq(receiptSubmissions.status, filters.status as any))\n        .orderBy(desc(receiptSubmissions.createdAt));\n    }\n    return db.select().from(receiptSubmissions).orderBy(desc(receiptSubmissions.createdAt));\n  }\n\n  async getReceiptSubmission(id: string): Promise<ReceiptSubmission | undefined> {\n    const [receipt] = await db.select().from(receiptSubmissions).where(eq(receiptSubmissions.id, id));\n    return receipt;\n  }\n\n  async getReceiptSubmissionByToken(token: string): Promise<ReceiptSubmission | undefined> {\n    const [receipt] = await db.select().from(receiptSubmissions)\n      .where(eq(receiptSubmissions.submissionToken, token));\n    return receipt;\n  }\n\n  async createReceiptSubmission(submission: InsertReceiptSubmission): Promise<ReceiptSubmission> {\n    const [created] = await db.insert(receiptSubmissions).values(submission).returning();\n    return created;\n  }\n\n  async updateReceiptSubmission(id: string, submission: Partial<InsertReceiptSubmission>): Promise<ReceiptSubmission | undefined> {\n    const [updated] = await db.update(receiptSubmissions)\n      .set({ ...submission, updatedAt: new Date() })\n      .where(eq(receiptSubmissions.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteReceiptSubmission(id: string): Promise<boolean> {\n    const result = await db.delete(receiptSubmissions).where(eq(receiptSubmissions.id, id)).returning();\n    return result.length > 0;\n  }\n\n  async getPendingReceipts(): Promise<ReceiptSubmission[]> {\n    return db.select().from(receiptSubmissions)\n      .where(eq(receiptSubmissions.status, 'pending'))\n      .orderBy(desc(receiptSubmissions.createdAt));\n  }\n\n  async matchReceiptToTransaction(receiptId: string, transactionId: string, reviewedBy: string): Promise<boolean> {\n    await db.update(receiptSubmissions)\n      .set({ \n        matchedTransactionId: transactionId, \n        status: 'matched',\n        reviewedByUserId: reviewedBy,\n        reviewedAt: new Date(),\n        updatedAt: new Date()\n      })\n      .where(eq(receiptSubmissions.id, receiptId));\n    \n    await db.update(bankTransactions)\n      .set({ receiptId })\n      .where(eq(bankTransactions.id, transactionId));\n    \n    return true;\n  }\n\n  // ============================================\n  // JOB PIPELINE CONFIGURATION\n  // ============================================\n\n  // Job Pipelines\n  async getJobPipeline(id: string): Promise<JobPipeline | undefined> {\n    const [pipeline] = await db.select().from(jobPipelines).where(eq(jobPipelines.id, id));\n    return pipeline;\n  }\n\n  async getJobPipelines(): Promise<JobPipeline[]> {\n    return db.select().from(jobPipelines).orderBy(jobPipelines.name);\n  }\n\n  async getActiveJobPipelines(): Promise<JobPipeline[]> {\n    return db.select().from(jobPipelines)\n      .where(eq(jobPipelines.isActive, true))\n      .orderBy(jobPipelines.name);\n  }\n\n  async createJobPipeline(pipeline: InsertJobPipeline): Promise<JobPipeline> {\n    const [created] = await db.insert(jobPipelines).values(pipeline).returning();\n    return created;\n  }\n\n  async updateJobPipeline(id: string, pipeline: Partial<InsertJobPipeline>): Promise<JobPipeline | undefined> {\n    const [updated] = await db.update(jobPipelines)\n      .set({ ...pipeline, updatedAt: new Date() })\n      .where(eq(jobPipelines.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteJobPipeline(id: string): Promise<boolean> {\n    const result = await db.delete(jobPipelines).where(eq(jobPipelines.id, id));\n    return true;\n  }\n\n  // Job Pipeline Stages\n  async getJobPipelineStage(id: string): Promise<JobPipelineStage | undefined> {\n    const [stage] = await db.select().from(jobPipelineStages).where(eq(jobPipelineStages.id, id));\n    return stage;\n  }\n\n  async getJobPipelineStages(pipelineId: string): Promise<JobPipelineStage[]> {\n    return db.select().from(jobPipelineStages)\n      .where(eq(jobPipelineStages.pipelineId, pipelineId))\n      .orderBy(jobPipelineStages.sortOrder);\n  }\n\n  async createJobPipelineStage(stage: InsertJobPipelineStage): Promise<JobPipelineStage> {\n    const [created] = await db.insert(jobPipelineStages).values(stage).returning();\n    return created;\n  }\n\n  async updateJobPipelineStage(id: string, stage: Partial<InsertJobPipelineStage>): Promise<JobPipelineStage | undefined> {\n    const [updated] = await db.update(jobPipelineStages)\n      .set({ ...stage, updatedAt: new Date() })\n      .where(eq(jobPipelineStages.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteJobPipelineStage(id: string): Promise<boolean> {\n    await db.delete(jobPipelineStages).where(eq(jobPipelineStages.id, id));\n    return true;\n  }\n\n  async reorderJobPipelineStages(pipelineId: string, stageIds: string[]): Promise<boolean> {\n    for (let i = 0; i < stageIds.length; i++) {\n      await db.update(jobPipelineStages)\n        .set({ sortOrder: i, updatedAt: new Date() })\n        .where(and(\n          eq(jobPipelineStages.id, stageIds[i]),\n          eq(jobPipelineStages.pipelineId, pipelineId)\n        ));\n    }\n    return true;\n  }\n\n  // Job Stage Completions\n  async getJobStageCompletions(jobId: string): Promise<JobStageCompletion[]> {\n    return db.select().from(jobStageCompletions)\n      .where(eq(jobStageCompletions.jobId, jobId));\n  }\n\n  async toggleJobStageCompletion(jobId: string, stageId: string, userId?: string): Promise<{ completed: boolean }> {\n    // Check if this stage is already completed for this job\n    const [existing] = await db.select().from(jobStageCompletions)\n      .where(and(\n        eq(jobStageCompletions.jobId, jobId),\n        eq(jobStageCompletions.stageId, stageId)\n      ));\n\n    let completed: boolean;\n    \n    if (existing) {\n      // Remove the completion (toggle off)\n      await db.delete(jobStageCompletions)\n        .where(and(\n          eq(jobStageCompletions.jobId, jobId),\n          eq(jobStageCompletions.stageId, stageId)\n        ));\n      completed = false;\n    } else {\n      // Add the completion (toggle on)\n      await db.insert(jobStageCompletions).values({\n        jobId,\n        stageId,\n        completedBy: userId,\n      });\n      completed = true;\n    }\n\n    // Sync the legacy stagesCompleted array for kanban view\n    // Get all completions for this job\n    const allCompletions = await db.select().from(jobStageCompletions)\n      .where(eq(jobStageCompletions.jobId, jobId));\n    \n    // Get the stages with their sortOrder\n    const stageIds = allCompletions.map(c => c.stageId);\n    if (stageIds.length > 0) {\n      const stages = await db.select().from(jobPipelineStages)\n        .where(inArray(jobPipelineStages.id, stageIds));\n      \n      // Convert to legacy format: array of (sortOrder + 1) for each completed stage\n      const stagesCompletedArray = stages.map(s => s.sortOrder + 1);\n      \n      await db.update(jobs)\n        .set({ stagesCompleted: stagesCompletedArray, updatedAt: new Date() })\n        .where(eq(jobs.id, jobId));\n    } else {\n      await db.update(jobs)\n        .set({ stagesCompleted: [], updatedAt: new Date() })\n        .where(eq(jobs.id, jobId));\n    }\n    \n    return { completed };\n  }\n\n  // ============================================\n  // CORE ANALYTICS IMPLEMENTATION\n  // ============================================\n\n  async getLeadAnalytics(startDate?: Date, endDate?: Date): Promise<LeadAnalytics> {\n    const now = new Date();\n    const start = startDate || new Date(now.getFullYear(), now.getMonth(), 1); // Default to start of month\n    const end = endDate || now;\n\n    // Get all leads for analysis\n    const allLeads = await db.select().from(leads);\n    const allUsers = await db.select().from(users);\n    const userMap = new Map(allUsers.map(u => [u.id, `${u.firstName} ${u.lastName}`]));\n\n    // New leads in date range\n    const newLeads = allLeads.filter(l => {\n      const created = new Date(l.createdAt);\n      return created >= start && created <= end;\n    }).length;\n\n    // Total active leads (not won or lost)\n    const totalActiveLeads = allLeads.filter(l => \n      l.stage !== 'won' && l.stage !== 'lost'\n    ).length;\n\n    // Leads by stage (for pipeline chart)\n    const stageValues = ['new', 'contacted', 'needs_quote', 'quote_sent', 'follow_up', 'won', 'lost'];\n    const leadsByStage = stageValues.map(stage => ({\n      stage,\n      count: allLeads.filter(l => l.stage === stage).length\n    }));\n\n    // Leads by source\n    const sourceMap = new Map<string, number>();\n    allLeads.forEach(l => {\n      const source = l.source || 'unknown';\n      sourceMap.set(source, (sourceMap.get(source) || 0) + 1);\n    });\n    const leadsBySource = Array.from(sourceMap.entries()).map(([source, count]) => ({ source, count }));\n\n    // Calculate average time metrics\n    let totalFirstResponseTime = 0;\n    let firstResponseCount = 0;\n    let totalQuoteTime = 0;\n    let quoteTimeCount = 0;\n    let totalCloseTime = 0;\n    let closeTimeCount = 0;\n\n    allLeads.forEach(l => {\n      if (l.firstResponseAt) {\n        const responseTime = (new Date(l.firstResponseAt).getTime() - new Date(l.createdAt).getTime()) / (1000 * 60 * 60);\n        totalFirstResponseTime += responseTime;\n        firstResponseCount++;\n      }\n      if (l.quoteSentAt) {\n        const quoteTime = (new Date(l.quoteSentAt).getTime() - new Date(l.createdAt).getTime()) / (1000 * 60 * 60);\n        totalQuoteTime += quoteTime;\n        quoteTimeCount++;\n      }\n      if (l.wonAt && l.stage === 'won') {\n        const closeTime = (new Date(l.wonAt).getTime() - new Date(l.createdAt).getTime()) / (1000 * 60 * 60 * 24);\n        totalCloseTime += closeTime;\n        closeTimeCount++;\n      }\n    });\n\n    // Leads by assignee\n    const assigneeMap = new Map<string, number>();\n    allLeads.forEach(l => {\n      if (l.assignedTo) {\n        assigneeMap.set(l.assignedTo, (assigneeMap.get(l.assignedTo) || 0) + 1);\n      }\n    });\n    const leadsByAssignee = Array.from(assigneeMap.entries()).map(([userId, count]) => ({\n      userId,\n      userName: userMap.get(userId) || 'Unknown',\n      count\n    }));\n\n    return {\n      newLeads,\n      totalActiveLeads,\n      leadsByStage,\n      leadsBySource,\n      averageTimeToFirstResponse: firstResponseCount > 0 ? totalFirstResponseTime / firstResponseCount : null,\n      averageTimeToQuote: quoteTimeCount > 0 ? totalQuoteTime / quoteTimeCount : null,\n      averageTimeToClose: closeTimeCount > 0 ? totalCloseTime / closeTimeCount : null,\n      leadsByAssignee\n    };\n  }\n\n  async getSalesAnalytics(startDate?: Date, endDate?: Date): Promise<SalesAnalytics> {\n    const now = new Date();\n    const start = startDate || new Date(now.getFullYear(), now.getMonth(), 1);\n    const end = endDate || now;\n    const yearStart = new Date(now.getFullYear(), 0, 1);\n\n    // Get all leads and payments (using lead-centric approach per spec)\n    const allLeads = await db.select().from(leads);\n    const allPayments = await db.select().from(payments);\n\n    // Pending quotes: Count leads awaiting client decision\n    // Includes quote_sent, follow_up, or any lead with quoteSentAt that isn't won/lost\n    const pendingQuotes = allLeads.filter(l => \n      (l.stage === 'quote_sent' || l.stage === 'follow_up') ||\n      (l.quoteSentAt && l.stage !== 'won' && l.stage !== 'lost')\n    ).length;\n\n    // Quote Conversion Rate: Won Leads  Leads that ever received quotes\n    // A lead \"received a quote\" when: quoteSentAt is set OR stage indicates quote was sent\n    // This includes leads in any stage if quoteSentAt is populated\n    const leadsWithQuotesSent = allLeads.filter(l => \n      l.quoteSentAt !== null || \n      ['quote_sent', 'follow_up', 'won', 'lost'].includes(l.stage)\n    );\n    const wonLeadsWithQuotes = leadsWithQuotesSent.filter(l => l.stage === 'won').length;\n    const quoteConversionRate = leadsWithQuotesSent.length > 0 \n      ? (wonLeadsWithQuotes / leadsWithQuotesSent.length) * 100 \n      : 0;\n\n    // Average Deal Size: Mean value of opportunity_value from won leads\n    const wonLeads = allLeads.filter(l => l.stage === 'won' && l.opportunityValue);\n    const totalWonValue = wonLeads.reduce((sum, l) => sum + Number(l.opportunityValue || 0), 0);\n    const averageDealSize = wonLeads.length > 0 ? totalWonValue / wonLeads.length : 0;\n\n    // Quote Pipeline Value: Sum of opportunity_value from active leads (not won/lost)\n    // This uses the lead's opportunity_value which is set from the primary quote\n    const activeLeadsWithOpportunity = allLeads.filter(l => \n      l.stage !== 'won' && l.stage !== 'lost' && l.opportunityValue\n    );\n    const quotePipelineValue = activeLeadsWithOpportunity.reduce((sum, l) => \n      sum + Number(l.opportunityValue || 0), 0\n    );\n\n    // Monthly Revenue: Sum of paid payments (status='paid' with paidAt set)\n    const paidPaymentsInRange = allPayments.filter(p => {\n      if (p.status !== 'paid' || !p.paidAt) return false;\n      const paidDate = new Date(p.paidAt);\n      return paidDate >= start && paidDate <= end;\n    });\n    const monthlyRevenue = paidPaymentsInRange.reduce((sum, p) => sum + Number(p.amount), 0);\n\n    // Year-to-date Revenue\n    const ytdPayments = allPayments.filter(p => {\n      if (p.status !== 'paid' || !p.paidAt) return false;\n      const paidDate = new Date(p.paidAt);\n      return paidDate >= yearStart && paidDate <= end;\n    });\n    const yearToDateRevenue = ytdPayments.reduce((sum, p) => sum + Number(p.amount), 0);\n\n    // Won value in period (leads that became won in the date range)\n    // Uses wonAt timestamp when available, falls back to createdAt for legacy data\n    const wonInPeriod = allLeads.filter(l => {\n      if (l.stage !== 'won') return false;\n      const wonDate = l.wonAt ? new Date(l.wonAt) : null;\n      if (!wonDate) return false;\n      return wonDate >= start && wonDate <= end;\n    });\n    const wonValue = wonInPeriod.reduce((sum, l) => sum + Number(l.opportunityValue || 0), 0);\n\n    // Lost value in period\n    const lostInPeriod = allLeads.filter(l => {\n      if (l.stage !== 'lost') return false;\n      const lostDate = l.lostAt ? new Date(l.lostAt) : null;\n      if (!lostDate) return false;\n      return lostDate >= start && lostDate <= end;\n    });\n    const lostValue = lostInPeriod.reduce((sum, l) => sum + Number(l.opportunityValue || 0), 0);\n\n    return {\n      pendingQuotes,\n      quoteConversionRate,\n      averageDealSize,\n      quotePipelineValue,\n      monthlyRevenue,\n      yearToDateRevenue,\n      wonValue,\n      lostValue\n    };\n  }\n\n  async getCoreAnalytics(startDate?: Date, endDate?: Date): Promise<CoreAnalytics> {\n    const now = new Date();\n    const start = startDate || new Date(now.getFullYear(), now.getMonth(), 1);\n    const end = endDate || now;\n\n    const [leadsAnalytics, salesAnalytics] = await Promise.all([\n      this.getLeadAnalytics(start, end),\n      this.getSalesAnalytics(start, end)\n    ]);\n\n    return {\n      leads: leadsAnalytics,\n      sales: salesAnalytics,\n      dateRange: { startDate: start, endDate: end }\n    };\n  }\n\n  // Kanban Columns\n  async getKanbanColumns(): Promise<KanbanColumn[]> {\n    return db.select().from(kanbanColumns)\n      .where(eq(kanbanColumns.isActive, true))\n      .orderBy(kanbanColumns.sortOrder);\n  }\n\n  async getKanbanColumn(id: string): Promise<KanbanColumn | undefined> {\n    const [column] = await db.select().from(kanbanColumns).where(eq(kanbanColumns.id, id));\n    return column;\n  }\n\n  async createKanbanColumn(column: InsertKanbanColumn): Promise<KanbanColumn> {\n    const maxOrder = await db.select({ max: sql<number>`COALESCE(MAX(sort_order), -1)` })\n      .from(kanbanColumns);\n    const sortOrder = (maxOrder[0]?.max ?? -1) + 1;\n    \n    const [newColumn] = await db.insert(kanbanColumns)\n      .values({ ...column, sortOrder })\n      .returning();\n    return newColumn;\n  }\n\n  async updateKanbanColumn(id: string, column: Partial<InsertKanbanColumn>): Promise<KanbanColumn | undefined> {\n    const [updated] = await db.update(kanbanColumns)\n      .set({ ...column, updatedAt: new Date() })\n      .where(eq(kanbanColumns.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteKanbanColumn(id: string): Promise<boolean> {\n    const result = await db.delete(kanbanColumns).where(eq(kanbanColumns.id, id));\n    return (result.rowCount ?? 0) > 0;\n  }\n\n  async reorderKanbanColumns(columnIds: string[]): Promise<boolean> {\n    for (let i = 0; i < columnIds.length; i++) {\n      await db.update(kanbanColumns)\n        .set({ sortOrder: i, updatedAt: new Date() })\n        .where(eq(kanbanColumns.id, columnIds[i]));\n    }\n    return true;\n  }\n\n  // Job Statuses\n  async getJobStatuses(): Promise<JobStatus[]> {\n    return db.select().from(jobStatuses)\n      .where(eq(jobStatuses.isActive, true))\n      .orderBy(jobStatuses.sortOrder);\n  }\n\n  async getJobStatus(id: string): Promise<JobStatus | undefined> {\n    const [status] = await db.select().from(jobStatuses).where(eq(jobStatuses.id, id));\n    return status;\n  }\n\n  async createJobStatus(status: InsertJobStatus): Promise<JobStatus> {\n    const maxOrder = await db.select({ max: sql<number>`COALESCE(MAX(sort_order), -1)` })\n      .from(jobStatuses);\n    const sortOrder = (maxOrder[0]?.max ?? -1) + 1;\n    \n    const [newStatus] = await db.insert(jobStatuses)\n      .values({ ...status, sortOrder })\n      .returning();\n    return newStatus;\n  }\n\n  async updateJobStatus(id: string, status: Partial<InsertJobStatus>): Promise<JobStatus | undefined> {\n    const [updated] = await db.update(jobStatuses)\n      .set({ ...status, updatedAt: new Date() })\n      .where(eq(jobStatuses.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteJobStatus(id: string): Promise<boolean> {\n    const result = await db.delete(jobStatuses).where(eq(jobStatuses.id, id));\n    return (result.rowCount ?? 0) > 0;\n  }\n\n  async reorderJobStatuses(statusIds: string[]): Promise<boolean> {\n    for (let i = 0; i < statusIds.length; i++) {\n      await db.update(jobStatuses)\n        .set({ sortOrder: i, updatedAt: new Date() })\n        .where(eq(jobStatuses.id, statusIds[i]));\n    }\n    return true;\n  }\n\n  // Job Status Dependencies\n  async getStatusDependencies(statusKey: string): Promise<JobStatusDependency[]> {\n    return db.select().from(jobStatusDependencies)\n      .where(eq(jobStatusDependencies.statusKey, statusKey));\n  }\n\n  async getAllStatusDependencies(): Promise<JobStatusDependency[]> {\n    return db.select().from(jobStatusDependencies);\n  }\n\n  async setStatusDependencies(statusKey: string, dependencies: { prerequisiteKey: string; dependencyType: string }[]): Promise<boolean> {\n    await db.delete(jobStatusDependencies)\n      .where(eq(jobStatusDependencies.statusKey, statusKey));\n    \n    if (dependencies.length > 0) {\n      await db.insert(jobStatusDependencies)\n        .values(dependencies.map(dep => ({\n          statusKey,\n          prerequisiteKey: dep.prerequisiteKey,\n          dependencyType: dep.dependencyType\n        })));\n    }\n    return true;\n  }\n\n  // Production Stages\n  async getProductionStages(): Promise<ProductionStage[]> {\n    return db.select().from(productionStages)\n      .where(eq(productionStages.isActive, true))\n      .orderBy(productionStages.sortOrder);\n  }\n\n  async getProductionStage(id: string): Promise<ProductionStage | undefined> {\n    const [stage] = await db.select().from(productionStages).where(eq(productionStages.id, id));\n    return stage;\n  }\n\n  async createProductionStage(stage: InsertProductionStage): Promise<ProductionStage> {\n    const maxOrder = await db.select({ max: sql<number>`COALESCE(MAX(sort_order), -1)` }).from(productionStages);\n    const sortOrder = (maxOrder[0]?.max ?? -1) + 1;\n    \n    const [created] = await db.insert(productionStages)\n      .values({ ...stage, sortOrder })\n      .returning();\n    return created;\n  }\n\n  async updateProductionStage(id: string, stage: Partial<InsertProductionStage>): Promise<ProductionStage | undefined> {\n    const [updated] = await db.update(productionStages)\n      .set({ ...stage, updatedAt: new Date() })\n      .where(eq(productionStages.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteProductionStage(id: string): Promise<boolean> {\n    const result = await db.delete(productionStages).where(eq(productionStages.id, id));\n    return (result.rowCount ?? 0) > 0;\n  }\n\n  async reorderProductionStages(stageIds: string[]): Promise<boolean> {\n    for (let i = 0; i < stageIds.length; i++) {\n      await db.update(productionStages)\n        .set({ sortOrder: i, updatedAt: new Date() })\n        .where(eq(productionStages.id, stageIds[i]));\n    }\n    return true;\n  }\n\n  // ============================================\n  // VOICE CALLS & AI COACHING\n  // ============================================\n\n  // Voice Calls\n  async getVoiceCall(id: string): Promise<VoiceCall | undefined> {\n    const [call] = await db.select().from(voiceCalls).where(eq(voiceCalls.id, id));\n    return call;\n  }\n\n  async getVoiceCallBySid(twilioCallSid: string): Promise<VoiceCall | undefined> {\n    const [call] = await db.select().from(voiceCalls).where(eq(voiceCalls.twilioCallSid, twilioCallSid));\n    return call;\n  }\n\n  async getVoiceCalls(): Promise<VoiceCall[]> {\n    return db.select().from(voiceCalls).orderBy(desc(voiceCalls.createdAt));\n  }\n\n  async getActiveVoiceCalls(): Promise<VoiceCall[]> {\n    return db.select().from(voiceCalls)\n      .where(or(\n        eq(voiceCalls.status, \"ringing\"),\n        eq(voiceCalls.status, \"in_progress\")\n      ))\n      .orderBy(desc(voiceCalls.startedAt));\n  }\n\n  async getVoiceCallsByStaff(userId: string): Promise<VoiceCall[]> {\n    return db.select().from(voiceCalls)\n      .where(eq(voiceCalls.staffUserId, userId))\n      .orderBy(desc(voiceCalls.createdAt));\n  }\n\n  async getVoiceCallsByClient(clientId: string): Promise<VoiceCall[]> {\n    return db.select().from(voiceCalls)\n      .where(eq(voiceCalls.clientId, clientId))\n      .orderBy(desc(voiceCalls.createdAt));\n  }\n\n  async getVoiceCallsByLead(leadId: string): Promise<VoiceCall[]> {\n    return db.select().from(voiceCalls)\n      .where(eq(voiceCalls.leadId, leadId))\n      .orderBy(desc(voiceCalls.createdAt));\n  }\n\n  async createVoiceCall(call: InsertVoiceCall): Promise<VoiceCall> {\n    const [created] = await db.insert(voiceCalls).values(call).returning();\n    return created;\n  }\n\n  async updateVoiceCall(id: string, call: Partial<InsertVoiceCall>): Promise<VoiceCall | undefined> {\n    const [updated] = await db.update(voiceCalls)\n      .set(call)\n      .where(eq(voiceCalls.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Call Transcripts\n  async getCallTranscripts(callId: string): Promise<CallTranscript[]> {\n    return db.select().from(callTranscripts)\n      .where(eq(callTranscripts.callId, callId))\n      .orderBy(callTranscripts.startTime);\n  }\n\n  async createCallTranscript(transcript: InsertCallTranscript): Promise<CallTranscript> {\n    const [created] = await db.insert(callTranscripts).values(transcript).returning();\n    return created;\n  }\n\n  async createCallTranscripts(transcripts: InsertCallTranscript[]): Promise<CallTranscript[]> {\n    if (transcripts.length === 0) return [];\n    return db.insert(callTranscripts).values(transcripts).returning();\n  }\n\n  // Sales Checklist Items\n  async getSalesChecklistItem(id: string): Promise<SalesChecklistItem | undefined> {\n    const [item] = await db.select().from(salesChecklistItems).where(eq(salesChecklistItems.id, id));\n    return item;\n  }\n\n  async getSalesChecklistItems(): Promise<SalesChecklistItem[]> {\n    return db.select().from(salesChecklistItems).orderBy(salesChecklistItems.sortOrder);\n  }\n\n  async getActiveSalesChecklistItems(): Promise<SalesChecklistItem[]> {\n    return db.select().from(salesChecklistItems)\n      .where(eq(salesChecklistItems.isActive, true))\n      .orderBy(salesChecklistItems.sortOrder);\n  }\n\n  async createSalesChecklistItem(item: InsertSalesChecklistItem): Promise<SalesChecklistItem> {\n    const maxOrder = await db.select({ max: sql<number>`COALESCE(MAX(sort_order), -1)` })\n      .from(salesChecklistItems);\n    const sortOrder = (maxOrder[0]?.max ?? -1) + 1;\n    \n    const [created] = await db.insert(salesChecklistItems)\n      .values({ ...item, sortOrder })\n      .returning();\n    return created;\n  }\n\n  async updateSalesChecklistItem(id: string, item: Partial<InsertSalesChecklistItem>): Promise<SalesChecklistItem | undefined> {\n    const [updated] = await db.update(salesChecklistItems)\n      .set({ ...item, updatedAt: new Date() })\n      .where(eq(salesChecklistItems.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteSalesChecklistItem(id: string): Promise<boolean> {\n    const result = await db.delete(salesChecklistItems).where(eq(salesChecklistItems.id, id));\n    return (result.rowCount ?? 0) > 0;\n  }\n\n  async reorderSalesChecklistItems(itemIds: string[]): Promise<boolean> {\n    for (let i = 0; i < itemIds.length; i++) {\n      await db.update(salesChecklistItems)\n        .set({ sortOrder: i, updatedAt: new Date() })\n        .where(eq(salesChecklistItems.id, itemIds[i]));\n    }\n    return true;\n  }\n\n  // Call Checklist Status\n  async getCallChecklistStatus(callId: string): Promise<CallChecklistStatus[]> {\n    return db.select().from(callChecklistStatus)\n      .where(eq(callChecklistStatus.callId, callId));\n  }\n\n  async initializeCallChecklistStatus(callId: string): Promise<CallChecklistStatus[]> {\n    const activeItems = await this.getActiveSalesChecklistItems();\n    if (activeItems.length === 0) return [];\n    \n    const statuses = activeItems.map(item => ({\n      callId,\n      checklistItemId: item.id,\n      isCovered: false,\n    }));\n    \n    return db.insert(callChecklistStatus).values(statuses).returning();\n  }\n\n  async updateCallChecklistItemStatus(\n    callId: string, \n    checklistItemId: string, \n    isCovered: boolean, \n    detectedText?: string\n  ): Promise<CallChecklistStatus | undefined> {\n    const [updated] = await db.update(callChecklistStatus)\n      .set({ \n        isCovered, \n        coveredAt: isCovered ? new Date() : null,\n        detectedText \n      })\n      .where(and(\n        eq(callChecklistStatus.callId, callId),\n        eq(callChecklistStatus.checklistItemId, checklistItemId)\n      ))\n      .returning();\n    return updated;\n  }\n\n  // Call Coaching Prompts\n  async getCallCoachingPrompts(callId: string): Promise<CallCoachingPrompt[]> {\n    return db.select().from(callCoachingPrompts)\n      .where(eq(callCoachingPrompts.callId, callId))\n      .orderBy(desc(callCoachingPrompts.createdAt));\n  }\n\n  async createCallCoachingPrompt(prompt: InsertCallCoachingPrompt): Promise<CallCoachingPrompt> {\n    const [created] = await db.insert(callCoachingPrompts).values(prompt).returning();\n    return created;\n  }\n\n  async acknowledgeCallCoachingPrompt(id: string): Promise<CallCoachingPrompt | undefined> {\n    const [updated] = await db.update(callCoachingPrompts)\n      .set({ wasAcknowledged: true, acknowledgedAt: new Date() })\n      .where(eq(callCoachingPrompts.id, id))\n      .returning();\n    return updated;\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","path":null,"size_bytes":177461,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5741,"size_tokens":null},"client/src/components/examples/CalendarViewExample.tsx":{"content":"import { CalendarView } from \"@/components/schedule/CalendarView\";\n\nexport default function CalendarViewExample() {\n  const events = [\n    {\n      id: \"1\",\n      jobNumber: \"JOB-2024-089\",\n      clientName: \"Williams\",\n      time: \"8:00\",\n      type: \"install\" as const,\n      installer: \"Jake M\",\n    },\n    {\n      id: \"2\",\n      jobNumber: \"JOB-2024-091\",\n      clientName: \"Harbor Homes\",\n      time: \"10:30\",\n      type: \"delivery\" as const,\n    },\n    {\n      id: \"3\",\n      jobNumber: \"JOB-2024-093\",\n      clientName: \"Coastal Living\",\n      time: \"14:00\",\n      type: \"measure\" as const,\n    },\n    {\n      id: \"4\",\n      jobNumber: \"JOB-2024-094\",\n      clientName: \"Smith\",\n      time: \"9:00\",\n      type: \"pickup\" as const,\n    },\n  ];\n\n  return (\n    <div className=\"p-4\">\n      <CalendarView\n        events={events}\n        onEventClick={(event) => console.log(\"Event clicked:\", event)}\n        onAddEvent={(date) => console.log(\"Add event on:\", date)}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":994,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":21846,"size_tokens":null},"client/src/components/clients/ClientCard.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { StatusBadge } from \"@/components/shared/StatusBadge\";\nimport { Phone, Mail, MapPin, FileText, Briefcase, MoreHorizontal } from \"lucide-react\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\n\ninterface Client {\n  id: string;\n  name: string;\n  phone: string;\n  email: string;\n  address: string;\n  clientType: \"public\" | \"trade\";\n  tradeDiscountLevel?: number;\n  totalQuotes: number;\n  totalJobs: number;\n  totalSpent: number;\n}\n\ninterface ClientCardProps {\n  client: Client;\n  onClick?: () => void;\n  onCreateQuote?: () => void;\n  onAddNote?: () => void;\n  onViewHistory?: () => void;\n}\n\nexport function ClientCard({\n  client,\n  onClick,\n  onCreateQuote,\n  onAddNote,\n  onViewHistory,\n}: ClientCardProps) {\n  const getInitials = (name: string) => {\n    return name\n      .split(\" \")\n      .map((n) => n[0])\n      .join(\"\")\n      .toUpperCase()\n      .slice(0, 2);\n  };\n\n  return (\n    <Card\n      className=\"hover-elevate cursor-pointer\"\n      onClick={onClick}\n      data-testid={`client-card-${client.id}`}\n    >\n      <CardContent className=\"p-4\">\n        <div className=\"flex items-start justify-between mb-3\">\n          <div className=\"flex items-center gap-3\">\n            <Avatar className=\"h-10 w-10\">\n              <AvatarFallback className=\"bg-muted text-sm\">\n                {getInitials(client.name)}\n              </AvatarFallback>\n            </Avatar>\n            <div>\n              <div className=\"flex items-center gap-2\">\n                <h3 className=\"font-semibold\">{client.name}</h3>\n                <StatusBadge status={client.clientType} />\n              </div>\n              {client.clientType === \"trade\" && client.tradeDiscountLevel && (\n                <Badge variant=\"secondary\" className=\"text-[10px] mt-1\">\n                  {client.tradeDiscountLevel}% Trade Discount\n                </Badge>\n              )}\n            </div>\n          </div>\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>\n              <Button variant=\"ghost\" size=\"icon\" className=\"h-7 w-7\" data-testid={`button-client-actions-${client.id}`}>\n                <MoreHorizontal className=\"h-4 w-4\" />\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\">\n              <DropdownMenuItem onClick={(e) => { e.stopPropagation(); onCreateQuote?.(); }}>\n                Create Quote\n              </DropdownMenuItem>\n              <DropdownMenuItem onClick={(e) => { e.stopPropagation(); onAddNote?.(); }}>\n                Add Note\n              </DropdownMenuItem>\n              <DropdownMenuItem onClick={(e) => { e.stopPropagation(); onViewHistory?.(); }}>\n                View History\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n\n        <div className=\"space-y-1.5 text-xs text-muted-foreground mb-4\">\n          <div className=\"flex items-center gap-2\">\n            <Phone className=\"h-3 w-3\" />\n            <span>{client.phone}</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Mail className=\"h-3 w-3\" />\n            <span className=\"truncate\">{client.email}</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <MapPin className=\"h-3 w-3\" />\n            <span className=\"truncate\">{client.address}</span>\n          </div>\n        </div>\n\n        <div className=\"flex items-center justify-between pt-3 border-t\">\n          <div className=\"flex items-center gap-4 text-xs\">\n            <div className=\"flex items-center gap-1 text-muted-foreground\">\n              <FileText className=\"h-3 w-3\" />\n              <span>{client.totalQuotes} quotes</span>\n            </div>\n            <div className=\"flex items-center gap-1 text-muted-foreground\">\n              <Briefcase className=\"h-3 w-3\" />\n              <span>{client.totalJobs} jobs</span>\n            </div>\n          </div>\n          <span className=\"text-sm font-semibold\">\n            ${client.totalSpent.toLocaleString()}\n          </span>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":4416,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\", /* 9px */\n        md: \".375rem\", /* 6px */\n        sm: \".1875rem\", /* 3px */\n      },\n      colors: {\n        // Flat / base colors (regular buttons)\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        success: {\n          DEFAULT: \"hsl(var(--success) / <alpha-value>)\",\n          foreground: \"hsl(var(--success-foreground) / <alpha-value>)\",\n        },\n        warning: {\n          DEFAULT: \"hsl(var(--warning) / <alpha-value>)\",\n          foreground: \"hsl(var(--warning-foreground) / <alpha-value>)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":4370,"size_tokens":null},"server/routes.ts":{"content":"import type { Express, Request, Response, NextFunction } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport crypto from \"crypto\";\nimport { storage } from \"./storage\";\nimport { \n  insertClientSchema, insertLeadSchema, insertProductSchema, \n  insertQuoteSchema, insertJobSchema, insertBOMSchema,\n  insertProductionTaskSchema, insertInstallTaskSchema,\n  insertScheduleEventSchema, insertPaymentSchema,\n  insertFenceStyleSchema, insertNotificationSchema,\n  insertSMSConversationSchema, insertMessageRangeSchema,\n  insertDepartmentSchema, insertWorkflowSchema, insertWorkflowVersionSchema,\n  insertPolicySchema, insertPolicyVersionSchema, insertPolicyAcknowledgementSchema,\n  insertResourceSchema, insertKnowledgeArticleSchema,\n  insertJobSetupDocumentSchema, insertJobSetupProductSchema,\n  section1SalesSchema, section2ProductsMetaSchema, section3ProductionSchema,\n  section4ScheduleSchema, section5InstallSchema,\n  insertLiveDocumentTemplateSchema,\n  insertLeadActivitySchema, insertLeadTaskSchema,\n  type User\n} from \"@shared/schema\";\nimport { z } from \"zod\";\nimport Stripe from \"stripe\";\nimport { getTwilioClient, getTwilioFromPhoneNumber, makeOutboundCall, generateTwimlForInbound, generateTwimlForOutbound, getCallRecording, generateVoiceToken, isVoiceSdkConfigured } from \"./twilio\";\nimport { processTranscriptUpdate, generateSuggestedResponse } from \"./coaching\";\nimport { initializeMediaStreamServer } from \"./deepgram\";\n\ntype UserRole = \"admin\" | \"sales\" | \"scheduler\" | \"production_manager\" | \"warehouse\" | \"installer\" | \"trade_client\";\n\nfunction requireAuth(req: Request, res: Response, next: NextFunction) {\n  if (!req.session.userId || !req.session.user) {\n    return res.status(401).json({ error: \"Not authenticated\" });\n  }\n  next();\n}\n\nfunction requireRoles(...allowedRoles: UserRole[]) {\n  return (req: Request, res: Response, next: NextFunction) => {\n    if (!req.session.userId || !req.session.user) {\n      return res.status(401).json({ error: \"Not authenticated\" });\n    }\n    \n    const userRole = req.session.user.role as UserRole;\n    if (!allowedRoles.includes(userRole)) {\n      return res.status(403).json({ error: \"Access denied\" });\n    }\n    \n    next();\n  };\n}\n\nconst stripe = process.env.STRIPE_SECRET_KEY \n  ? new Stripe(process.env.STRIPE_SECRET_KEY, {\n      apiVersion: \"2025-04-30.basil\" as any,\n    })\n  : null;\n\nconst loginSchema = z.object({\n  email: z.string().email(),\n  password: z.string().min(1),\n});\n\nexport async function registerRoutes(\n  httpServer: Server,\n  app: Express\n): Promise<Server> {\n  \n  // ============ AUTHENTICATION ============\n  app.post(\"/api/auth/login\", async (req, res) => {\n    try {\n      const { email, password } = loginSchema.parse(req.body);\n      \n      const user = await storage.getUserByEmail(email);\n      if (!user) {\n        return res.status(401).json({ error: \"Invalid email or password\" });\n      }\n      \n      if (!user.isActive) {\n        return res.status(401).json({ error: \"Account is inactive\" });\n      }\n      \n      if (user.password !== password) {\n        return res.status(401).json({ error: \"Invalid email or password\" });\n      }\n      \n      const sessionUser = {\n        id: user.id,\n        username: user.username,\n        email: user.email,\n        firstName: user.firstName,\n        lastName: user.lastName,\n        role: user.role,\n        positionTitle: user.positionTitle,\n        profilePhotoUrl: user.profilePhotoUrl,\n      };\n      \n      req.session.userId = user.id;\n      req.session.user = sessionUser;\n      \n      res.json({ user: sessionUser });\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error during login:\", error);\n      res.status(500).json({ error: \"Failed to login\" });\n    }\n  });\n  \n  app.post(\"/api/auth/logout\", async (req, res) => {\n    req.session.destroy((err) => {\n      if (err) {\n        console.error(\"Error destroying session:\", err);\n        return res.status(500).json({ error: \"Failed to logout\" });\n      }\n      res.clearCookie(\"connect.sid\");\n      res.json({ success: true });\n    });\n  });\n  \n  app.get(\"/api/auth/me\", async (req, res) => {\n    if (!req.session.userId || !req.session.user) {\n      return res.status(401).json({ error: \"Not authenticated\" });\n    }\n    \n    const user = await storage.getUser(req.session.userId);\n    if (!user || !user.isActive) {\n      req.session.destroy(() => {});\n      return res.status(401).json({ error: \"Session invalid\" });\n    }\n    \n    res.json({\n      user: {\n        id: user.id,\n        username: user.username,\n        email: user.email,\n        firstName: user.firstName,\n        lastName: user.lastName,\n        role: user.role,\n        positionTitle: user.positionTitle,\n        profilePhotoUrl: user.profilePhotoUrl,\n      }\n    });\n  });\n\n  // ============ PERSONAL DASHBOARD ============\n  app.get(\"/api/my-dashboard\", async (req, res) => {\n    try {\n      if (!req.session.userId) {\n        return res.status(401).json({ error: \"Not authenticated\" });\n      }\n      \n      const userId = req.session.userId;\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(401).json({ error: \"User not found\" });\n      }\n      \n      const [myTasks, myNotifications, leaveBalance, roleKpis] = await Promise.all([\n        storage.getTasksAssignedToUser(userId),\n        storage.getNotificationsByUser(userId),\n        storage.getStaffLeaveBalance(userId),\n        storage.getRoleBasedKpis(user.role, userId),\n      ]);\n      \n      res.json({\n        user: {\n          id: user.id,\n          firstName: user.firstName,\n          lastName: user.lastName,\n          role: user.role,\n          positionTitle: user.positionTitle,\n          profilePhotoUrl: user.profilePhotoUrl,\n        },\n        tasks: myTasks,\n        notifications: myNotifications,\n        leaveBalance: leaveBalance || { \n          annualLeaveBalanceHours: \"0\", \n          sickLeaveBalanceHours: \"0\" \n        },\n        kpis: roleKpis,\n      });\n    } catch (error) {\n      console.error(\"Error fetching personal dashboard:\", error);\n      res.status(500).json({ error: \"Failed to fetch personal dashboard\" });\n    }\n  });\n\n  // ============ DASHBOARD ============\n  app.get(\"/api/dashboard/stats\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const stats = await storage.getDashboardStats();\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching dashboard stats:\", error);\n      res.status(500).json({ error: \"Failed to fetch dashboard stats\" });\n    }\n  });\n\n  // ============ WEATHER (WA LOCATIONS) ============\n  const waLocations: Record<string, { name: string; lat: number; lon: number }> = {\n    malaga: { name: \"Malaga\", lat: -31.8583, lon: 115.8978 },\n    perth: { name: \"Perth CBD\", lat: -31.9523, lon: 115.8613 },\n    rockingham: { name: \"Rockingham\", lat: -32.2769, lon: 115.7294 },\n    quinns: { name: \"Quinns Rock\", lat: -31.6722, lon: 115.7011 },\n  };\n\n  app.get(\"/api/weather/:location\", async (req, res) => {\n    try {\n      const locationKey = req.params.location.toLowerCase();\n      const location = waLocations[locationKey] || waLocations.malaga;\n      \n      const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${location.lat}&longitude=${location.lon}&current=temperature_2m,relative_humidity_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&timezone=Australia%2FPerth`;\n      \n      const response = await fetch(weatherUrl);\n      if (!response.ok) {\n        throw new Error(\"Failed to fetch weather data\");\n      }\n      \n      const data = await response.json();\n      \n      // Map weather codes to conditions\n      const weatherCodeMap: Record<number, string> = {\n        0: \"Clear\",\n        1: \"Mainly Clear\",\n        2: \"Partly Cloudy\",\n        3: \"Overcast\",\n        45: \"Foggy\",\n        48: \"Foggy\",\n        51: \"Light Drizzle\",\n        53: \"Drizzle\",\n        55: \"Heavy Drizzle\",\n        61: \"Light Rain\",\n        63: \"Rain\",\n        65: \"Heavy Rain\",\n        71: \"Light Snow\",\n        73: \"Snow\",\n        75: \"Heavy Snow\",\n        80: \"Light Showers\",\n        81: \"Showers\",\n        82: \"Heavy Showers\",\n        95: \"Thunderstorm\",\n        96: \"Thunderstorm\",\n        99: \"Thunderstorm\",\n      };\n      \n      const weatherCode = data.current?.weather_code || 0;\n      const condition = weatherCodeMap[weatherCode] || \"Clear\";\n      \n      const weatherData = {\n        location: location.name,\n        temperature: Math.round(data.current?.temperature_2m || 25),\n        condition,\n        minTemp: Math.round(data.daily?.temperature_2m_min?.[0] || 18),\n        maxTemp: Math.round(data.daily?.temperature_2m_max?.[0] || 30),\n        humidity: Math.round(data.current?.relative_humidity_2m || 50),\n      };\n      \n      res.json(weatherData);\n    } catch (error) {\n      console.error(\"Error fetching weather:\", error);\n      // Return fallback data if API fails\n      res.json({\n        location: \"Malaga\",\n        temperature: 25,\n        condition: \"Unable to fetch\",\n        minTemp: 18,\n        maxTemp: 30,\n        humidity: 50,\n      });\n    }\n  });\n\n  // Get available weather locations\n  app.get(\"/api/weather-locations\", (req, res) => {\n    res.json(Object.entries(waLocations).map(([key, val]) => ({\n      id: key,\n      name: val.name,\n    })));\n  });\n\n  // ============ SOIL DATA ============\n  // Perth Coastal Limestone Zone Detection (Tamala Limestone Formation)\n  // This limestone belt runs along Perth's coast from Yanchep to Mandurah\n  function isInPerthLimestoneZone(lat: number, lng: number): { inZone: boolean; zoneName: string | null } {\n    // Perth metro area bounds with limestone\n    const PERTH_LAT_MIN = -32.6;  // South of Mandurah\n    const PERTH_LAT_MAX = -31.4;  // North of Yanchep\n    const COAST_LNG = 115.75;     // Approximate coastline longitude\n    const LIMESTONE_INLAND_EXTENT = 0.12; // ~12km inland from coast\n    \n    // Check if within Perth metro latitude range\n    if (lat < PERTH_LAT_MIN || lat > PERTH_LAT_MAX) {\n      return { inZone: false, zoneName: null };\n    }\n    \n    // Check if within coastal limestone belt (within ~12km of coast)\n    // The coast curves, so we use a simplified check\n    const distanceFromCoast = Math.abs(lng - COAST_LNG);\n    \n    // Northern suburbs (Yanchep to Scarborough) - limestone extends further east\n    if (lat > -31.9 && lng >= 115.70 && lng <= 115.85) {\n      return { inZone: true, zoneName: \"Tamala Limestone (Northern Coastal)\" };\n    }\n    \n    // Central coastal suburbs (Cottesloe, Mosman Park, Fremantle)\n    if (lat >= -32.1 && lat <= -31.9 && lng >= 115.74 && lng <= 115.80) {\n      return { inZone: true, zoneName: \"Tamala Limestone (Central Coastal)\" };\n    }\n    \n    // Southern suburbs (Rockingham, Safety Bay)\n    if (lat >= -32.4 && lat < -32.1 && lng >= 115.72 && lng <= 115.80) {\n      return { inZone: true, zoneName: \"Tamala Limestone (Southern Coastal)\" };\n    }\n    \n    // General coastal check - within 12km of coast\n    if (distanceFromCoast <= LIMESTONE_INLAND_EXTENT) {\n      return { inZone: true, zoneName: \"Tamala Limestone (Coastal Belt)\" };\n    }\n    \n    return { inZone: false, zoneName: null };\n  }\n  \n  app.get(\"/api/soil-data\", async (req, res) => {\n    try {\n      const { lat, lng } = req.query;\n      \n      if (!lat || !lng || typeof lat !== \"string\" || typeof lng !== \"string\") {\n        return res.status(400).json({ error: \"Missing lat/lng parameters\" });\n      }\n      \n      const latitude = parseFloat(lat);\n      const longitude = parseFloat(lng);\n      \n      if (isNaN(latitude) || isNaN(longitude)) {\n        return res.status(400).json({ error: \"Invalid lat/lng values\" });\n      }\n      \n      // Check for Perth coastal limestone zone\n      const limestoneCheck = isInPerthLimestoneZone(latitude, longitude);\n      \n      // Call ASRIS (CSIRO) Soil API with retry\n      const asrisUrl = `https://asris.csiro.au/ASRISApi/api/APSIM/getApsoil?longitude=${longitude}&latitude=${latitude}`;\n      \n      let response: Response | null = null;\n      let lastError: Error | null = null;\n      \n      // Retry up to 3 times with backoff\n      for (let attempt = 0; attempt < 3; attempt++) {\n        try {\n          response = await fetch(asrisUrl, { \n            signal: AbortSignal.timeout(10000) // 10 second timeout\n          });\n          if (response.ok) break;\n          lastError = new Error(`ASRIS returned ${response.status}`);\n        } catch (err) {\n          lastError = err as Error;\n        }\n        // Wait before retry (100ms, 300ms)\n        if (attempt < 2) await new Promise(r => setTimeout(r, 100 * (attempt + 1)));\n      }\n      \n      // Return fallback if ASRIS unavailable\n      if (!response?.ok) {\n        console.warn(\"ASRIS API unavailable:\", lastError?.message);\n        return res.json({\n          soilType: null,\n          region: null,\n          nearestTown: null,\n          naturalVegetation: null,\n          state: null,\n          ascOrder: null,\n          comments: null,\n          installationNotes: null,\n          source: \"unavailable\",\n        });\n      }\n      \n      const xmlText = await response.text();\n      \n      // Parse key soil information from XML\n      const extractValue = (tag: string): string | null => {\n        const match = xmlText.match(new RegExp(`<${tag}>([^<]+)</${tag}>`));\n        return match ? match[1] : null;\n      };\n      \n      const soilType = extractValue(\"SoilType\");\n      const region = extractValue(\"Region\");\n      const nearestTown = extractValue(\"NearestTown\");\n      const naturalVegetation = extractValue(\"NaturalVegetation\");\n      const state = extractValue(\"State\");\n      const ascOrder = extractValue(\"ASCOrder\");\n      const comments = extractValue(\"Comments\");\n      \n      // If no soil type found in XML, return unavailable\n      if (!soilType) {\n        console.warn(\"ASRIS returned empty soil data for coordinates:\", latitude, longitude);\n        return res.json({\n          soilType: null,\n          region: null,\n          nearestTown: null,\n          naturalVegetation: null,\n          state: null,\n          ascOrder: null,\n          comments: null,\n          installationNotes: null,\n          source: \"unavailable\",\n        });\n      }\n      \n      // Determine installation difficulty based on soil type and limestone zone\n      let installationNotes = \"\";\n      let geologyWarning: string | null = null;\n      const soilLower = soilType.toLowerCase();\n      \n      // Check for limestone zone FIRST - this takes priority\n      if (limestoneCheck.inZone) {\n        installationNotes = \"LIMESTONE ZONE - Core drill likely required. Shallow rock expected within 300-500mm.\";\n        geologyWarning = limestoneCheck.zoneName;\n      } else if (soilLower.includes(\"rock\") || soilLower.includes(\"limestone\") || soilLower.includes(\"calcrete\")) {\n        installationNotes = \"Core drill likely required\";\n      } else if (soilLower.includes(\"clay\")) {\n        installationNotes = \"Harder digging - may require more time/effort\";\n      } else if (soilLower.includes(\"gravel\")) {\n        installationNotes = \"Mixed conditions - check site for rock presence\";\n      } else if (soilLower.includes(\"loam\") && !soilLower.includes(\"sand\")) {\n        installationNotes = \"Moderate digging - standard equipment suitable\";\n      } else if (soilLower.includes(\"sand\") || soilLower.includes(\"loamy sand\")) {\n        // Even in sandy areas, check if we're near limestone zone\n        if (limestoneCheck.inZone) {\n          installationNotes = \"LIMESTONE ZONE - Sandy topsoil but rock likely below. Core drill recommended.\";\n          geologyWarning = limestoneCheck.zoneName;\n        } else {\n          installationNotes = \"Easy digging - standard auger should work well\";\n        }\n      }\n      \n      res.json({\n        soilType,\n        region: region || null,\n        nearestTown: nearestTown || null,\n        naturalVegetation: naturalVegetation || null,\n        state: state || null,\n        ascOrder: ascOrder !== \"NA\" ? ascOrder : null,\n        comments: comments || null,\n        installationNotes: installationNotes || null,\n        geologyWarning: geologyWarning,\n        source: \"CSIRO ASRIS\",\n      });\n    } catch (error) {\n      console.error(\"Error fetching soil data:\", error);\n      // Return graceful fallback instead of 500\n      res.json({\n        soilType: null,\n        region: null,\n        nearestTown: null,\n        naturalVegetation: null,\n        state: null,\n        ascOrder: null,\n        comments: null,\n        installationNotes: null,\n        source: \"unavailable\",\n      });\n    }\n  });\n\n  // ============ GLOBAL SEARCH ============\n  // Only internal staff roles can search - excludes trade_client and installer\n  app.get(\"/api/search\", requireRoles(\"admin\", \"sales\", \"scheduler\", \"production_manager\", \"warehouse\"), async (req, res) => {\n    try {\n      const { q } = req.query;\n      if (!q || typeof q !== \"string\" || q.length < 2) {\n        return res.json({ clients: [], leads: [], jobs: [], quotes: [] });\n      }\n\n      const [clients, leads, jobs, quotes] = await Promise.all([\n        storage.searchClients(q),\n        storage.searchLeads(q),\n        storage.searchJobs(q),\n        storage.searchQuotes(q),\n      ]);\n\n      res.json({\n        clients: clients.slice(0, 5),\n        leads: leads.slice(0, 5),\n        jobs: jobs.slice(0, 5),\n        quotes: quotes.slice(0, 5),\n      });\n    } catch (error) {\n      console.error(\"Error performing global search:\", error);\n      res.status(500).json({ error: \"Failed to perform search\" });\n    }\n  });\n\n  // ============ CLIENTS ============\n  app.get(\"/api/clients\", requireRoles(\"admin\", \"sales\", \"scheduler\", \"production_manager\"), async (req, res) => {\n    try {\n      const { type, search } = req.query;\n      let clients;\n      if (search) {\n        clients = await storage.searchClients(search as string);\n      } else if (type) {\n        clients = await storage.getClientsByType(type as string);\n      } else {\n        clients = await storage.getClients();\n      }\n      res.json(clients);\n    } catch (error) {\n      console.error(\"Error fetching clients:\", error);\n      res.status(500).json({ error: \"Failed to fetch clients\" });\n    }\n  });\n\n  app.get(\"/api/clients/:id\", requireRoles(\"admin\", \"sales\", \"scheduler\", \"production_manager\"), async (req, res) => {\n    try {\n      const client = await storage.getClient(req.params.id);\n      if (!client) {\n        return res.status(404).json({ error: \"Client not found\" });\n      }\n      res.json(client);\n    } catch (error) {\n      console.error(\"Error fetching client:\", error);\n      res.status(500).json({ error: \"Failed to fetch client\" });\n    }\n  });\n\n  app.post(\"/api/clients/check-duplicate\", requireRoles(\"admin\", \"sales\", \"scheduler\", \"production_manager\"), async (req, res) => {\n    try {\n      const { name, email, phone } = req.body;\n      const duplicates = await storage.checkClientDuplicates(name, email, phone);\n      res.json({ duplicates });\n    } catch (error) {\n      console.error(\"Error checking client duplicates:\", error);\n      res.status(500).json({ error: \"Failed to check duplicates\" });\n    }\n  });\n\n  app.post(\"/api/clients\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const validatedData = insertClientSchema.parse(req.body);\n      const client = await storage.createClient(validatedData);\n      res.status(201).json(client);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating client:\", error);\n      res.status(500).json({ error: \"Failed to create client\" });\n    }\n  });\n\n  app.patch(\"/api/clients/:id\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const client = await storage.updateClient(req.params.id, req.body);\n      if (!client) {\n        return res.status(404).json({ error: \"Client not found\" });\n      }\n      res.json(client);\n    } catch (error) {\n      console.error(\"Error updating client:\", error);\n      res.status(500).json({ error: \"Failed to update client\" });\n    }\n  });\n\n  app.delete(\"/api/clients/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      await storage.deleteClient(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting client:\", error);\n      res.status(500).json({ error: \"Failed to delete client\" });\n    }\n  });\n\n  // Get client's quotes\n  app.get(\"/api/clients/:id/quotes\", requireRoles(\"admin\", \"sales\", \"scheduler\", \"production_manager\"), async (req, res) => {\n    try {\n      const quotes = await storage.getQuotesByClient(req.params.id);\n      res.json(quotes);\n    } catch (error) {\n      console.error(\"Error fetching client quotes:\", error);\n      res.status(500).json({ error: \"Failed to fetch client quotes\" });\n    }\n  });\n\n  // Get client's jobs\n  app.get(\"/api/clients/:id/jobs\", requireRoles(\"admin\", \"sales\", \"scheduler\", \"production_manager\"), async (req, res) => {\n    try {\n      const jobs = await storage.getJobsByClient(req.params.id);\n      res.json(jobs);\n    } catch (error) {\n      console.error(\"Error fetching client jobs:\", error);\n      res.status(500).json({ error: \"Failed to fetch client jobs\" });\n    }\n  });\n\n  // Get client's payments\n  app.get(\"/api/clients/:id/payments\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const payments = await storage.getPaymentsByClient(req.params.id);\n      res.json(payments);\n    } catch (error) {\n      console.error(\"Error fetching client payments:\", error);\n      res.status(500).json({ error: \"Failed to fetch client payments\" });\n    }\n  });\n\n  // ============ LEADS ============\n  app.get(\"/api/leads\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const { stage, assignee } = req.query;\n      let leads;\n      if (stage) {\n        leads = await storage.getLeadsByStage(stage as string);\n      } else if (assignee) {\n        leads = await storage.getLeadsByAssignee(assignee as string);\n      } else {\n        leads = await storage.getLeads();\n      }\n      res.json(leads);\n    } catch (error) {\n      console.error(\"Error fetching leads:\", error);\n      res.status(500).json({ error: \"Failed to fetch leads\" });\n    }\n  });\n\n  app.get(\"/api/leads/:id\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const lead = await storage.getLead(req.params.id);\n      if (!lead) {\n        return res.status(404).json({ error: \"Lead not found\" });\n      }\n      res.json(lead);\n    } catch (error) {\n      console.error(\"Error fetching lead:\", error);\n      res.status(500).json({ error: \"Failed to fetch lead\" });\n    }\n  });\n\n  app.post(\"/api/leads\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const { clientName, clientPhone, clientEmail, ...leadData } = req.body;\n      \n      // Validate clientName is required when no existing clientId\n      const trimmedName = (clientName || \"\").trim();\n      const trimmedPhone = (clientPhone || \"\").trim();\n      const trimmedEmail = (clientEmail || \"\").trim();\n      \n      let clientId = leadData.clientId;\n      \n      // Require clientName if no existing client linked\n      if (!clientId && !trimmedName) {\n        return res.status(400).json({ error: \"Client name is required\" });\n      }\n      \n      // If client info is provided, create or find client\n      if (trimmedName && !clientId) {\n        // Try to find existing client by phone or email\n        const allClients = await storage.getClients();\n        let existingClient = null;\n        \n        if (trimmedPhone) {\n          existingClient = allClients.find(c => c.phone === trimmedPhone);\n        }\n        if (!existingClient && trimmedEmail) {\n          existingClient = allClients.find(c => c.email === trimmedEmail);\n        }\n        \n        if (existingClient) {\n          clientId = existingClient.id;\n          // Only update if values actually changed\n          const needsUpdate = existingClient.name !== trimmedName || \n              existingClient.phone !== trimmedPhone || \n              existingClient.email !== trimmedEmail;\n          if (needsUpdate) {\n            await storage.updateClient(existingClient.id, {\n              name: trimmedName,\n              phone: trimmedPhone || existingClient.phone || \"\",\n              email: trimmedEmail || existingClient.email || \"\",\n              address: leadData.siteAddress || existingClient.address || \"\",\n            });\n          }\n        } else {\n          // Create new client\n          const newClient = await storage.createClient({\n            name: trimmedName,\n            phone: trimmedPhone,\n            email: trimmedEmail,\n            address: leadData.siteAddress || \"\",\n            clientType: leadData.leadType === \"trade\" ? \"trade\" : \"public\",\n          });\n          clientId = newClient.id;\n        }\n      }\n      \n      // Build clean lead payload - only include valid lead fields\n      const cleanLeadPayload = {\n        source: leadData.source,\n        leadType: leadData.leadType,\n        description: leadData.description,\n        siteAddress: leadData.siteAddress,\n        stage: leadData.stage || \"new\",\n        jobFulfillmentType: leadData.jobFulfillmentType,\n        clientId,\n        // Soil/site data from frontend\n        soilWarning: leadData.soilWarning || null,\n        soilInstallNotes: leadData.soilInstallNotes || null,\n        siteLatitude: leadData.siteLatitude || null,\n        siteLongitude: leadData.siteLongitude || null,\n      };\n      \n      const validatedData = insertLeadSchema.parse(cleanLeadPayload);\n      const lead = await storage.createLead(validatedData);\n\n      const admins = await storage.getUsersByRole(\"admin\");\n      const sales = await storage.getUsersByRole(\"sales\");\n      const notifyUsers = [...admins, ...sales];\n      \n      for (const user of notifyUsers) {\n        await storage.createNotification({\n          userId: user.id,\n          type: \"lead_new\",\n          title: \"New Lead Created\",\n          message: lead.description || `New ${lead.leadType} lead from ${lead.source}`,\n          relatedEntityType: \"lead\",\n          relatedEntityId: lead.id,\n        });\n      }\n\n      res.status(201).json(lead);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating lead:\", error);\n      res.status(500).json({ error: \"Failed to create lead\" });\n    }\n  });\n\n  app.patch(\"/api/leads/:id\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const { clientName, clientPhone, clientEmail, clientId: passedClientId, ...rawLeadData } = req.body;\n      \n      // Get existing lead to find clientId\n      const existingLead = await storage.getLead(req.params.id);\n      if (!existingLead) {\n        return res.status(404).json({ error: \"Lead not found\" });\n      }\n      \n      // Trim and validate client data\n      const trimmedName = (clientName || \"\").trim();\n      const trimmedPhone = (clientPhone || \"\").trim();\n      const trimmedEmail = (clientEmail || \"\").trim();\n      \n      let newClientId: string | null = null;\n      \n      // If a specific client ID is passed, use that (user selected existing client)\n      if (passedClientId && !existingLead.clientId) {\n        newClientId = passedClientId;\n        // Update the existing client's info if provided\n        if (trimmedName || trimmedPhone || trimmedEmail) {\n          const existingClient = await storage.getClient(passedClientId);\n          if (existingClient) {\n            const updates: Record<string, string> = {};\n            if (trimmedName && trimmedName !== existingClient.name) updates.name = trimmedName;\n            if (trimmedPhone && trimmedPhone !== (existingClient.phone || \"\")) updates.phone = trimmedPhone;\n            if (trimmedEmail && trimmedEmail !== (existingClient.email || \"\")) updates.email = trimmedEmail;\n            if (Object.keys(updates).length > 0) {\n              await storage.updateClient(passedClientId, updates);\n            }\n          }\n        }\n      }\n      // If lead has no client and client info is provided, create or find client\n      else if (!existingLead.clientId && trimmedName) {\n        // Try to find existing client by phone or email first\n        const allClients = await storage.getClients();\n        let matchingClient = null;\n        \n        if (trimmedPhone) {\n          matchingClient = allClients.find(c => c.phone === trimmedPhone);\n        }\n        if (!matchingClient && trimmedEmail) {\n          matchingClient = allClients.find(c => c.email === trimmedEmail);\n        }\n        \n        if (matchingClient) {\n          newClientId = matchingClient.id;\n          // Update client info if different\n          const needsUpdate = matchingClient.name !== trimmedName || \n              matchingClient.phone !== trimmedPhone || \n              matchingClient.email !== trimmedEmail;\n          if (needsUpdate) {\n            await storage.updateClient(matchingClient.id, {\n              name: trimmedName,\n              phone: trimmedPhone || matchingClient.phone || \"\",\n              email: trimmedEmail || matchingClient.email || \"\",\n              address: rawLeadData.siteAddress || matchingClient.address || \"\",\n            });\n          }\n        } else {\n          // Create new client\n          const newClient = await storage.createClient({\n            name: trimmedName,\n            phone: trimmedPhone,\n            email: trimmedEmail,\n            address: rawLeadData.siteAddress || existingLead.siteAddress || \"\",\n            clientType: existingLead.leadType === \"trade\" ? \"trade\" : \"public\",\n          });\n          newClientId = newClient.id;\n        }\n      }\n      // If passed a different client ID than existing, switch to that client\n      else if (passedClientId && existingLead.clientId && passedClientId !== existingLead.clientId) {\n        newClientId = passedClientId;\n        // Optionally update the new client's info\n        if (trimmedName || trimmedPhone || trimmedEmail) {\n          const existingClient = await storage.getClient(passedClientId);\n          if (existingClient) {\n            const updates: Record<string, string> = {};\n            if (trimmedName && trimmedName !== existingClient.name) updates.name = trimmedName;\n            if (trimmedPhone && trimmedPhone !== (existingClient.phone || \"\")) updates.phone = trimmedPhone;\n            if (trimmedEmail && trimmedEmail !== (existingClient.email || \"\")) updates.email = trimmedEmail;\n            if (Object.keys(updates).length > 0) {\n              await storage.updateClient(passedClientId, updates);\n            }\n          }\n        }\n      }\n      // Update client info if lead already has a client and no new clientId passed\n      else if (existingLead.clientId && (trimmedName || trimmedPhone || trimmedEmail)) {\n        // Fetch existing client to compare values\n        const existingClient = await storage.getClient(existingLead.clientId);\n        if (existingClient) {\n          const updates: Record<string, string> = {};\n          // Only include fields that actually changed\n          if (trimmedName && trimmedName !== existingClient.name) {\n            updates.name = trimmedName;\n          }\n          if (trimmedPhone !== undefined && trimmedPhone !== (existingClient.phone || \"\")) {\n            updates.phone = trimmedPhone;\n          }\n          if (trimmedEmail !== undefined && trimmedEmail !== (existingClient.email || \"\")) {\n            updates.email = trimmedEmail;\n          }\n          if (rawLeadData.siteAddress && rawLeadData.siteAddress !== (existingClient.address || \"\")) {\n            updates.address = rawLeadData.siteAddress;\n          }\n          \n          // Only call update if there are actual changes\n          if (Object.keys(updates).length > 0) {\n            await storage.updateClient(existingLead.clientId, updates);\n          }\n        }\n      }\n      \n      // Build clean lead update payload - only include valid lead fields\n      const cleanLeadPayload: Record<string, any> = {};\n      if (rawLeadData.source !== undefined) cleanLeadPayload.source = rawLeadData.source;\n      if (rawLeadData.leadType !== undefined) cleanLeadPayload.leadType = rawLeadData.leadType;\n      if (rawLeadData.description !== undefined) cleanLeadPayload.description = rawLeadData.description;\n      if (rawLeadData.siteAddress !== undefined) cleanLeadPayload.siteAddress = rawLeadData.siteAddress;\n      if (rawLeadData.stage !== undefined) cleanLeadPayload.stage = rawLeadData.stage;\n      if (rawLeadData.jobFulfillmentType !== undefined) cleanLeadPayload.jobFulfillmentType = rawLeadData.jobFulfillmentType;\n      if (rawLeadData.assignedTo !== undefined) cleanLeadPayload.assignedTo = rawLeadData.assignedTo;\n      if (rawLeadData.followUpDate !== undefined) cleanLeadPayload.followUpDate = rawLeadData.followUpDate;\n      if (rawLeadData.notes !== undefined) cleanLeadPayload.notes = rawLeadData.notes;\n      \n      // Link new client if one was created\n      if (newClientId) {\n        cleanLeadPayload.clientId = newClientId;\n      }\n      \n      const lead = await storage.updateLead(req.params.id, cleanLeadPayload);\n      if (!lead) {\n        return res.status(404).json({ error: \"Lead not found\" });\n      }\n      res.json(lead);\n    } catch (error) {\n      console.error(\"Error updating lead:\", error);\n      res.status(500).json({ error: \"Failed to update lead\" });\n    }\n  });\n\n  app.delete(\"/api/leads/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      await storage.deleteLead(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting lead:\", error);\n      res.status(500).json({ error: \"Failed to delete lead\" });\n    }\n  });\n\n  // Lead Activities\n  app.get(\"/api/leads/:leadId/activities\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const activities = await storage.getLeadActivities(req.params.leadId);\n      res.json(activities);\n    } catch (error) {\n      console.error(\"Error fetching lead activities:\", error);\n      res.status(500).json({ error: \"Failed to fetch lead activities\" });\n    }\n  });\n\n  app.post(\"/api/leads/:leadId/activities\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const { activityType, title, description, metadata,\n        callDirection, callTimestamp, callDurationSeconds, staffMemberId,\n        callNotes, audioRecordingUrl, aiSummaryText, callTranscriptionText, transcriptionStatus\n      } = req.body;\n      \n      if (!activityType || !title) {\n        return res.status(400).json({ error: \"Activity type and title are required\" });\n      }\n      \n      const activityData: Record<string, unknown> = {\n        leadId: req.params.leadId,\n        activityType,\n        title,\n      };\n      \n      if (description) activityData.description = description;\n      if (metadata) activityData.metadata = metadata;\n      \n      // Call-specific fields\n      if (callDirection) activityData.callDirection = callDirection;\n      if (callTimestamp) activityData.callTimestamp = new Date(callTimestamp);\n      if (callDurationSeconds !== undefined) activityData.callDurationSeconds = callDurationSeconds;\n      if (staffMemberId) activityData.staffMemberId = staffMemberId;\n      if (callNotes) activityData.callNotes = callNotes;\n      if (audioRecordingUrl) activityData.audioRecordingUrl = audioRecordingUrl;\n      if (aiSummaryText) activityData.aiSummaryText = aiSummaryText;\n      if (callTranscriptionText) activityData.callTranscriptionText = callTranscriptionText;\n      if (transcriptionStatus) activityData.transcriptionStatus = transcriptionStatus;\n      \n      const validatedData = insertLeadActivitySchema.parse(activityData);\n      \n      const activity = await storage.createLeadActivity(validatedData);\n      res.status(201).json(activity);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating lead activity:\", error);\n      res.status(500).json({ error: \"Failed to create lead activity\" });\n    }\n  });\n\n  // Get single activity with linked tasks\n  app.get(\"/api/lead-activities/:id\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const activity = await storage.getLeadActivity(req.params.id);\n      if (!activity) {\n        return res.status(404).json({ error: \"Activity not found\" });\n      }\n      \n      const linkedTasks = await storage.getTasksByActivityId(req.params.id);\n      res.json({ ...activity, linkedTasks });\n    } catch (error) {\n      console.error(\"Error fetching activity:\", error);\n      res.status(500).json({ error: \"Failed to fetch activity\" });\n    }\n  });\n\n  // Update lead activity (for call logs - edit notes, direction, staff member)\n  app.patch(\"/api/lead-activities/:id\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const { callNotes, callDirection, staffMemberId, aiSummaryText, \n              callTranscriptionText, transcriptionStatus } = req.body;\n      \n      const updateData: Record<string, unknown> = {};\n      \n      if (callNotes !== undefined) updateData.callNotes = callNotes;\n      if (callDirection !== undefined) updateData.callDirection = callDirection;\n      if (staffMemberId !== undefined) updateData.staffMemberId = staffMemberId;\n      if (aiSummaryText !== undefined) updateData.aiSummaryText = aiSummaryText;\n      if (callTranscriptionText !== undefined) updateData.callTranscriptionText = callTranscriptionText;\n      if (transcriptionStatus !== undefined) updateData.transcriptionStatus = transcriptionStatus;\n      \n      const activity = await storage.updateLeadActivity(req.params.id, updateData);\n      if (!activity) {\n        return res.status(404).json({ error: \"Activity not found\" });\n      }\n      res.json(activity);\n    } catch (error) {\n      console.error(\"Error updating activity:\", error);\n      res.status(500).json({ error: \"Failed to update activity\" });\n    }\n  });\n\n  // Delete lead activity (call log)\n  app.delete(\"/api/lead-activities/:id\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      // Clear the sourceActivityId from any linked tasks before deleting\n      const linkedTasks = await storage.getTasksByActivityId(req.params.id);\n      for (const task of linkedTasks) {\n        await storage.updateLeadTask(task.id, { sourceActivityId: null });\n      }\n      \n      await storage.deleteLeadActivity(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting activity:\", error);\n      res.status(500).json({ error: \"Failed to delete activity\" });\n    }\n  });\n\n  // Get tasks linked to a specific activity (call log)\n  app.get(\"/api/lead-activities/:id/tasks\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const tasks = await storage.getTasksByActivityId(req.params.id);\n      res.json(tasks);\n    } catch (error) {\n      console.error(\"Error fetching activity tasks:\", error);\n      res.status(500).json({ error: \"Failed to fetch activity tasks\" });\n    }\n  });\n\n  // Lead Tasks\n  app.get(\"/api/leads/:leadId/tasks\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const tasks = await storage.getLeadTasks(req.params.leadId);\n      res.json(tasks);\n    } catch (error) {\n      console.error(\"Error fetching lead tasks:\", error);\n      res.status(500).json({ error: \"Failed to fetch lead tasks\" });\n    }\n  });\n\n  app.post(\"/api/leads/:leadId/tasks\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const { title, description, dueDate, priority, assignedTo, sourceActivityId } = req.body;\n      \n      if (!title) {\n        return res.status(400).json({ error: \"Task title is required\" });\n      }\n      \n      const taskData: Record<string, unknown> = {\n        leadId: req.params.leadId,\n        title,\n        status: \"pending\",\n      };\n      \n      if (description) taskData.description = description;\n      if (dueDate) taskData.dueDate = new Date(dueDate);\n      if (priority) taskData.priority = priority;\n      if (assignedTo) taskData.assignedTo = assignedTo;\n      if (sourceActivityId) taskData.sourceActivityId = sourceActivityId;\n      \n      const validatedData = insertLeadTaskSchema.parse(taskData);\n      \n      const task = await storage.createLeadTask(validatedData);\n      res.status(201).json(task);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating lead task:\", error);\n      res.status(500).json({ error: \"Failed to create lead task\" });\n    }\n  });\n\n  app.get(\"/api/lead-tasks\", async (req, res) => {\n    try {\n      const tasks = await storage.getAllLeadTasks();\n      res.json(tasks);\n    } catch (error) {\n      console.error(\"Error fetching lead tasks:\", error);\n      res.status(500).json({ error: \"Failed to fetch lead tasks\" });\n    }\n  });\n\n  app.patch(\"/api/lead-tasks/:id\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const { status, title, description, priority, dueDate, assignedTo } = req.body;\n      \n      const updateData: Record<string, unknown> = {};\n      \n      const validStatuses = [\"pending\", \"in_progress\", \"completed\"];\n      if (status) {\n        if (!validStatuses.includes(status)) {\n          return res.status(400).json({ error: \"Invalid status value\" });\n        }\n        updateData.status = status;\n        if (status === \"completed\") {\n          updateData.completedAt = new Date();\n        }\n      }\n      \n      if (title !== undefined) updateData.title = title;\n      if (description !== undefined) updateData.description = description;\n      if (priority !== undefined) updateData.priority = priority;\n      if (dueDate !== undefined) updateData.dueDate = dueDate ? new Date(dueDate) : null;\n      if (assignedTo !== undefined) updateData.assignedTo = assignedTo;\n      \n      const task = await storage.updateLeadTask(req.params.id, updateData);\n      if (!task) {\n        return res.status(404).json({ error: \"Task not found\" });\n      }\n      res.json(task);\n    } catch (error) {\n      console.error(\"Error updating lead task:\", error);\n      res.status(500).json({ error: \"Failed to update lead task\" });\n    }\n  });\n\n  app.delete(\"/api/lead-tasks/:id\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      await storage.deleteLeadTask(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting lead task:\", error);\n      res.status(500).json({ error: \"Failed to delete lead task\" });\n    }\n  });\n\n  // Convert lead to quote\n  app.post(\"/api/leads/:id/convert-to-quote\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const lead = await storage.getLead(req.params.id);\n      if (!lead) {\n        return res.status(404).json({ error: \"Lead not found\" });\n      }\n\n      // Get next quote number\n      const quoteNumber = await storage.getNextQuoteNumber();\n\n      // Create quote from lead\n      const quoteData = {\n        quoteNumber,\n        clientId: lead.clientId!,\n        leadId: lead.id,\n        siteAddress: lead.siteAddress,\n        totalAmount: \"0\",\n        status: \"draft\" as const,\n        isTradeQuote: lead.leadType === \"trade\",\n        ...req.body,\n      };\n\n      const quote = await storage.createQuote(quoteData);\n\n      // Update lead stage\n      await storage.updateLead(lead.id, { stage: \"quote_sent\" });\n\n      res.status(201).json(quote);\n    } catch (error) {\n      console.error(\"Error converting lead to quote:\", error);\n      res.status(500).json({ error: \"Failed to convert lead to quote\" });\n    }\n  });\n\n  // ============ FENCE STYLES ============\n  app.get(\"/api/fence-styles\", async (req, res) => {\n    try {\n      const styles = await storage.getFenceStyles();\n      res.json(styles);\n    } catch (error) {\n      console.error(\"Error fetching fence styles:\", error);\n      res.status(500).json({ error: \"Failed to fetch fence styles\" });\n    }\n  });\n\n  app.post(\"/api/fence-styles\", async (req, res) => {\n    try {\n      const validatedData = insertFenceStyleSchema.parse(req.body);\n      const style = await storage.createFenceStyle(validatedData);\n      res.status(201).json(style);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating fence style:\", error);\n      res.status(500).json({ error: \"Failed to create fence style\" });\n    }\n  });\n\n  // ============ PRODUCTS / INVENTORY ============\n  app.get(\"/api/products\", requireRoles(\"admin\", \"sales\", \"production_manager\", \"warehouse\"), async (req, res) => {\n    try {\n      const { category, lowStock } = req.query;\n      let products;\n      if (lowStock === \"true\") {\n        products = await storage.getLowStockProducts();\n      } else if (category) {\n        products = await storage.getProductsByCategory(category as string);\n      } else {\n        products = await storage.getProducts();\n      }\n      res.json(products);\n    } catch (error) {\n      console.error(\"Error fetching products:\", error);\n      res.status(500).json({ error: \"Failed to fetch products\" });\n    }\n  });\n\n  app.get(\"/api/products/:id\", requireRoles(\"admin\", \"sales\", \"production_manager\", \"warehouse\"), async (req, res) => {\n    try {\n      const product = await storage.getProduct(req.params.id);\n      if (!product) {\n        return res.status(404).json({ error: \"Product not found\" });\n      }\n      res.json(product);\n    } catch (error) {\n      console.error(\"Error fetching product:\", error);\n      res.status(500).json({ error: \"Failed to fetch product\" });\n    }\n  });\n\n  app.post(\"/api/products\", requireRoles(\"admin\", \"production_manager\", \"warehouse\"), async (req, res) => {\n    try {\n      const validatedData = insertProductSchema.parse(req.body);\n      const product = await storage.createProduct(validatedData);\n      res.status(201).json(product);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating product:\", error);\n      res.status(500).json({ error: \"Failed to create product\" });\n    }\n  });\n\n  app.patch(\"/api/products/:id\", requireRoles(\"admin\", \"production_manager\", \"warehouse\"), async (req, res) => {\n    try {\n      const product = await storage.updateProduct(req.params.id, req.body);\n      if (!product) {\n        return res.status(404).json({ error: \"Product not found\" });\n      }\n      res.json(product);\n    } catch (error) {\n      console.error(\"Error updating product:\", error);\n      res.status(500).json({ error: \"Failed to update product\" });\n    }\n  });\n\n  app.patch(\"/api/products/:id/stock\", requireRoles(\"admin\", \"production_manager\", \"warehouse\"), async (req, res) => {\n    try {\n      const { quantity } = req.body;\n      const product = await storage.updateStock(req.params.id, quantity);\n      if (!product) {\n        return res.status(404).json({ error: \"Product not found\" });\n      }\n      res.json(product);\n    } catch (error) {\n      console.error(\"Error updating stock:\", error);\n      res.status(500).json({ error: \"Failed to update stock\" });\n    }\n  });\n\n  app.delete(\"/api/products/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      await storage.deleteProduct(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting product:\", error);\n      res.status(500).json({ error: \"Failed to delete product\" });\n    }\n  });\n\n  // ============ QUOTES ============\n  app.get(\"/api/quotes\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const { status, clientId } = req.query;\n      let quotes;\n      if (status) {\n        quotes = await storage.getQuotesByStatus(status as string);\n      } else if (clientId) {\n        quotes = await storage.getQuotesByClient(clientId as string);\n      } else {\n        quotes = await storage.getQuotes();\n      }\n      res.json(quotes);\n    } catch (error) {\n      console.error(\"Error fetching quotes:\", error);\n      res.status(500).json({ error: \"Failed to fetch quotes\" });\n    }\n  });\n\n  app.get(\"/api/quotes/next-number\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const number = await storage.getNextQuoteNumber();\n      res.json({ quoteNumber: number });\n    } catch (error) {\n      console.error(\"Error generating quote number:\", error);\n      res.status(500).json({ error: \"Failed to generate quote number\" });\n    }\n  });\n\n  app.get(\"/api/quotes/analytics\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const analytics = await storage.getQuoteAnalytics();\n      res.json(analytics);\n    } catch (error) {\n      console.error(\"Error fetching quote analytics:\", error);\n      res.status(500).json({ error: \"Failed to fetch quote analytics\" });\n    }\n  });\n\n  // ============ CORE ANALYTICS ============\n  // Standardized KPI endpoints for dashboards\n\n  app.get(\"/api/analytics/core\", requireRoles(\"admin\", \"sales\", \"scheduler\", \"production_manager\"), async (req, res) => {\n    try {\n      const { startDate, endDate } = req.query;\n      const start = startDate ? new Date(startDate as string) : undefined;\n      const end = endDate ? new Date(endDate as string) : undefined;\n      const analytics = await storage.getCoreAnalytics(start, end);\n      res.json(analytics);\n    } catch (error) {\n      console.error(\"Error fetching core analytics:\", error);\n      res.status(500).json({ error: \"Failed to fetch core analytics\" });\n    }\n  });\n\n  app.get(\"/api/analytics/leads\", requireRoles(\"admin\", \"sales\", \"scheduler\", \"production_manager\"), async (req, res) => {\n    try {\n      const { startDate, endDate } = req.query;\n      const start = startDate ? new Date(startDate as string) : undefined;\n      const end = endDate ? new Date(endDate as string) : undefined;\n      const analytics = await storage.getLeadAnalytics(start, end);\n      res.json(analytics);\n    } catch (error) {\n      console.error(\"Error fetching lead analytics:\", error);\n      res.status(500).json({ error: \"Failed to fetch lead analytics\" });\n    }\n  });\n\n  app.get(\"/api/analytics/sales\", requireRoles(\"admin\", \"sales\", \"scheduler\", \"production_manager\"), async (req, res) => {\n    try {\n      const { startDate, endDate } = req.query;\n      const start = startDate ? new Date(startDate as string) : undefined;\n      const end = endDate ? new Date(endDate as string) : undefined;\n      const analytics = await storage.getSalesAnalytics(start, end);\n      res.json(analytics);\n    } catch (error) {\n      console.error(\"Error fetching sales analytics:\", error);\n      res.status(500).json({ error: \"Failed to fetch sales analytics\" });\n    }\n  });\n\n  app.get(\"/api/quotes/:id\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const quote = await storage.getQuote(req.params.id);\n      if (!quote) {\n        return res.status(404).json({ error: \"Quote not found\" });\n      }\n      res.json(quote);\n    } catch (error) {\n      console.error(\"Error fetching quote:\", error);\n      res.status(500).json({ error: \"Failed to fetch quote\" });\n    }\n  });\n\n  app.post(\"/api/quotes\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const quoteNumber = await storage.getNextQuoteNumber();\n      const validatedData = insertQuoteSchema.parse({\n        ...req.body,\n        quoteNumber,\n      });\n      const quote = await storage.createQuote(validatedData);\n\n      const client = quote.clientId ? await storage.getClient(quote.clientId) : null;\n      const admins = await storage.getUsersByRole(\"admin\");\n      \n      for (const user of admins) {\n        await storage.createNotification({\n          userId: user.id,\n          type: \"quote_created\",\n          title: \"New Quote Created\",\n          message: `Quote ${quote.quoteNumber} for ${client?.name || \"Unknown client\"} - $${parseFloat(quote.totalAmount || \"0\").toLocaleString()}`,\n          relatedEntityType: \"quote\",\n          relatedEntityId: quote.id,\n        });\n      }\n\n      res.status(201).json(quote);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating quote:\", error);\n      res.status(500).json({ error: \"Failed to create quote\" });\n    }\n  });\n\n  app.patch(\"/api/quotes/:id\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const oldQuote = await storage.getQuote(req.params.id);\n      const quote = await storage.updateQuote(req.params.id, req.body);\n      if (!quote) {\n        return res.status(404).json({ error: \"Quote not found\" });\n      }\n\n      if (oldQuote && oldQuote.status !== quote.status) {\n        if (quote.status === \"approved\") {\n          const client = quote.clientId ? await storage.getClient(quote.clientId) : null;\n          const admins = await storage.getUsersByRole(\"admin\");\n          const sales = await storage.getUsersByRole(\"sales\");\n          const notifyUsers = [...admins, ...sales];\n          \n          for (const user of notifyUsers) {\n            await storage.createNotification({\n              userId: user.id,\n              type: \"quote_approved\",\n              title: \"Quote Approved\",\n              message: `Quote ${quote.quoteNumber} approved by ${client?.name || \"client\"} - $${parseFloat(quote.totalAmount || \"0\").toLocaleString()}`,\n              relatedEntityType: \"quote\",\n              relatedEntityId: quote.id,\n            });\n          }\n        }\n      }\n\n      res.json(quote);\n    } catch (error) {\n      console.error(\"Error updating quote:\", error);\n      res.status(500).json({ error: \"Failed to update quote\" });\n    }\n  });\n\n  // Send quote\n  app.post(\"/api/quotes/:id/send\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const quote = await storage.updateQuote(req.params.id, {\n        status: \"sent\",\n        sentAt: new Date(),\n      } as any);\n      if (!quote) {\n        return res.status(404).json({ error: \"Quote not found\" });\n      }\n      res.json(quote);\n    } catch (error) {\n      console.error(\"Error sending quote:\", error);\n      res.status(500).json({ error: \"Failed to send quote\" });\n    }\n  });\n\n  // Set quote as primary (updates lead opportunity_value)\n  app.post(\"/api/quotes/:id/set-primary\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const result = await storage.setPrimaryQuote(req.params.id);\n      res.json(result);\n    } catch (error: any) {\n      console.error(\"Error setting primary quote:\", error);\n      res.status(400).json({ error: error.message || \"Failed to set primary quote\" });\n    }\n  });\n\n  // Accept quote and create job (also sets as primary and rejects other quotes)\n  app.post(\"/api/quotes/:id/accept\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const quote = await storage.getQuote(req.params.id);\n      if (!quote) {\n        return res.status(404).json({ error: \"Quote not found\" });\n      }\n\n      // Use the new acceptQuote method which handles:\n      // - Setting this quote as primary\n      // - Updating lead stage to \"won\" and opportunity_value\n      // - Rejecting all other quotes on this lead\n      // - Creating the job\n      const { quote: updatedQuote, lead, job } = await storage.acceptQuote(req.params.id);\n\n      // Create deposit payment record\n      if (quote.depositRequired) {\n        await storage.createPayment({\n          clientId: quote.clientId,\n          jobId: job.id,\n          quoteId: quote.id,\n          amount: quote.depositRequired,\n          paymentType: \"deposit\",\n          status: \"pending\",\n        });\n      }\n\n      // Auto-create Job Setup Document for supply+install jobs\n      const jobType = job.jobType || \"supply_install\";\n      if (jobType === \"supply_install\") {\n        try {\n          const setupDocument = await storage.createJobSetupDocument({\n            jobId: job.id,\n            jobType: jobType,\n            status: \"draft\",\n            section1Sales: {},\n            section2ProductsMeta: {},\n            section3Production: {},\n            section4Schedule: {},\n            section5Install: {},\n          } as any);\n\n          // Seed BOM products from quote line items\n          if (quote.lineItems && Array.isArray(quote.lineItems) && quote.lineItems.length > 0) {\n            await storage.seedJobSetupProductsFromQuote(setupDocument.id, quote.id);\n          }\n        } catch (setupError) {\n          // Log but don't fail the job creation\n          console.error(\"Error creating job setup document:\", setupError);\n        }\n      }\n\n      res.status(201).json({ quote: updatedQuote, lead, job });\n    } catch (error: any) {\n      console.error(\"Error accepting quote:\", error);\n      res.status(500).json({ error: error.message || \"Failed to accept quote\" });\n    }\n  });\n\n  app.delete(\"/api/quotes/:id\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      await storage.deleteQuote(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting quote:\", error);\n      res.status(500).json({ error: \"Failed to delete quote\" });\n    }\n  });\n\n  // ============ JOBS ============\n  app.get(\"/api/jobs\", requireRoles(\"admin\", \"sales\", \"scheduler\", \"production_manager\", \"warehouse\", \"installer\"), async (req, res) => {\n    try {\n      const { status, clientId, installerId } = req.query;\n      let jobs;\n      if (status) {\n        jobs = await storage.getJobsByStatus(status as string);\n      } else if (clientId) {\n        jobs = await storage.getJobsByClient(clientId as string);\n      } else if (installerId) {\n        jobs = await storage.getJobsByInstaller(installerId as string);\n      } else {\n        jobs = await storage.getJobs();\n      }\n      res.json(jobs);\n    } catch (error) {\n      console.error(\"Error fetching jobs:\", error);\n      res.status(500).json({ error: \"Failed to fetch jobs\" });\n    }\n  });\n\n  app.get(\"/api/jobs/:id\", requireRoles(\"admin\", \"sales\", \"scheduler\", \"production_manager\", \"warehouse\", \"installer\"), async (req, res) => {\n    try {\n      const job = await storage.getJob(req.params.id);\n      if (!job) {\n        return res.status(404).json({ error: \"Job not found\" });\n      }\n      res.json(job);\n    } catch (error) {\n      console.error(\"Error fetching job:\", error);\n      res.status(500).json({ error: \"Failed to fetch job\" });\n    }\n  });\n\n  // Create a job directly (without going through leads/quotes flow)\n  app.post(\"/api/jobs/create-direct\", requireRoles(\"admin\", \"sales\", \"scheduler\", \"production_manager\"), async (req, res) => {\n    try {\n      const { clientId, jobType, siteAddress, notes, totalAmount } = req.body;\n      \n      if (!clientId || !jobType || !siteAddress) {\n        return res.status(400).json({ error: \"clientId, jobType, and siteAddress are required\" });\n      }\n\n      const result = await storage.createDirectJob({\n        clientId,\n        jobType,\n        siteAddress,\n        notes,\n        totalAmount: totalAmount ? parseFloat(totalAmount) : undefined,\n      });\n\n      res.status(201).json(result);\n    } catch (error) {\n      console.error(\"Error creating direct job:\", error);\n      res.status(500).json({ error: \"Failed to create job\" });\n    }\n  });\n\n  app.patch(\"/api/jobs/:id\", requireRoles(\"admin\", \"sales\", \"scheduler\", \"production_manager\"), async (req, res) => {\n    try {\n      const job = await storage.updateJob(req.params.id, req.body);\n      if (!job) {\n        return res.status(404).json({ error: \"Job not found\" });\n      }\n      res.json(job);\n    } catch (error) {\n      console.error(\"Error updating job:\", error);\n      res.status(500).json({ error: \"Failed to update job\" });\n    }\n  });\n\n  // Update job status\n  app.patch(\"/api/jobs/:id/status\", requireRoles(\"admin\", \"sales\", \"scheduler\", \"production_manager\"), async (req, res) => {\n    try {\n      const { status, bypassValidation } = req.body;\n      const oldJob = await storage.getJob(req.params.id);\n      if (!oldJob) {\n        return res.status(404).json({ error: \"Job not found\" });\n      }\n\n      // Validate setup document completion for supply+install jobs (unless bypassed)\n      if (oldJob.jobType === \"supply_install\" && !bypassValidation) {\n        const statusRequirements: Record<string, { sections: number[]; message: string }> = {\n          \"in_production\": { \n            sections: [1, 2], \n            message: \"Sections 1 (Sales Info) and 2 (Products) must be completed before production\" \n          },\n          \"manufacturing_panels\": { \n            sections: [1, 2], \n            message: \"Sections 1 (Sales Info) and 2 (Products) must be completed before production\" \n          },\n          \"ready_for_install\": { \n            sections: [1, 2, 3, 4], \n            message: \"Sections 1-4 must be completed before marking ready for install\" \n          },\n          \"scheduled\": { \n            sections: [1, 2, 3, 4], \n            message: \"Sections 1-4 must be completed before scheduling\" \n          },\n          \"installing\": { \n            sections: [1, 2, 3, 4], \n            message: \"Sections 1-4 must be completed before install can begin\" \n          },\n          \"completed\": { \n            sections: [1, 2, 3, 4, 5], \n            message: \"All sections must be completed before marking job complete\" \n          },\n        };\n\n        const requirements = statusRequirements[status];\n        if (requirements) {\n          const document = await storage.getJobSetupDocumentByJob(oldJob.id);\n          if (!document) {\n            return res.status(400).json({ \n              error: \"Job setup document must be created and completed before changing status\",\n              requiresSetupDocument: true\n            });\n          }\n\n          const incompleteSections: number[] = [];\n          if (requirements.sections.includes(1) && !document.section1Complete) incompleteSections.push(1);\n          if (requirements.sections.includes(2) && !document.section2Complete) incompleteSections.push(2);\n          if (requirements.sections.includes(3) && !document.section3Complete) incompleteSections.push(3);\n          if (requirements.sections.includes(4) && !document.section4Complete) incompleteSections.push(4);\n          if (requirements.sections.includes(5) && !document.section5Complete) incompleteSections.push(5);\n\n          if (incompleteSections.length > 0) {\n            return res.status(400).json({ \n              error: requirements.message,\n              incompleteSections,\n              requiredSections: requirements.sections\n            });\n          }\n        }\n      }\n\n      const job = await storage.updateJob(req.params.id, { status });\n      if (!job) {\n        return res.status(404).json({ error: \"Job not found\" });\n      }\n\n      if (oldJob && oldJob.status !== job.status) {\n        const client = await storage.getClient(job.clientId);\n        const admins = await storage.getUsersByRole(\"admin\");\n        \n        const statusMessages: Record<string, { title: string; type: string }> = {\n          \"scheduled\": { title: \"Job Scheduled\", type: \"job_scheduled\" },\n          \"ready_for_install\": { title: \"Job Ready for Installation\", type: \"job_ready\" },\n          \"in_progress\": { title: \"Job Installation Started\", type: \"job_started\" },\n          \"completed\": { title: \"Job Completed\", type: \"job_complete\" },\n          \"manufacturing_panels\": { title: \"Job in Production\", type: \"job_production\" },\n        };\n\n        const statusInfo = statusMessages[job.status];\n        if (statusInfo) {\n          for (const user of admins) {\n            await storage.createNotification({\n              userId: user.id,\n              type: statusInfo.type,\n              title: statusInfo.title,\n              message: `${job.jobNumber} - ${client?.name || \"Unknown client\"} - ${job.fenceStyle || \"Fence\"}`,\n              relatedEntityType: \"job\",\n              relatedEntityId: job.id,\n            });\n          }\n\n          if (job.assignedInstaller) {\n            await storage.createNotification({\n              userId: job.assignedInstaller,\n              type: statusInfo.type,\n              title: statusInfo.title,\n              message: `${job.jobNumber} - ${job.siteAddress}`,\n              relatedEntityType: \"job\",\n              relatedEntityId: job.id,\n            });\n          }\n        }\n      }\n\n      res.json(job);\n    } catch (error) {\n      console.error(\"Error updating job status:\", error);\n      res.status(500).json({ error: \"Failed to update job status\" });\n    }\n  });\n\n  // Get job BOM\n  app.get(\"/api/jobs/:id/bom\", requireRoles(\"admin\", \"sales\", \"scheduler\", \"production_manager\", \"warehouse\"), async (req, res) => {\n    try {\n      const bomData = await storage.getBOMByJob(req.params.id);\n      if (!bomData) {\n        return res.status(404).json({ error: \"BOM not found\" });\n      }\n      res.json(bomData);\n    } catch (error) {\n      console.error(\"Error fetching BOM:\", error);\n      res.status(500).json({ error: \"Failed to fetch BOM\" });\n    }\n  });\n\n  // Create/Update job BOM\n  app.post(\"/api/jobs/:id/bom\", requireRoles(\"admin\", \"production_manager\"), async (req, res) => {\n    try {\n      const existingBOM = await storage.getBOMByJob(req.params.id);\n      if (existingBOM) {\n        const updated = await storage.updateBOM(existingBOM.id, req.body);\n        return res.json(updated);\n      }\n      \n      const validatedData = insertBOMSchema.parse({\n        ...req.body,\n        jobId: req.params.id,\n      });\n      const bomData = await storage.createBOM(validatedData);\n      res.status(201).json(bomData);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating BOM:\", error);\n      res.status(500).json({ error: \"Failed to create BOM\" });\n    }\n  });\n\n  // Get job production tasks\n  app.get(\"/api/jobs/:id/production-tasks\", requireRoles(\"admin\", \"scheduler\", \"production_manager\", \"warehouse\"), async (req, res) => {\n    try {\n      const tasks = await storage.getProductionTasksByJob(req.params.id);\n      res.json(tasks);\n    } catch (error) {\n      console.error(\"Error fetching production tasks:\", error);\n      res.status(500).json({ error: \"Failed to fetch production tasks\" });\n    }\n  });\n\n  // Get job install tasks\n  app.get(\"/api/jobs/:id/install-tasks\", requireRoles(\"admin\", \"scheduler\", \"production_manager\", \"installer\"), async (req, res) => {\n    try {\n      const tasks = await storage.getInstallTasksByJob(req.params.id);\n      res.json(tasks);\n    } catch (error) {\n      console.error(\"Error fetching install tasks:\", error);\n      res.status(500).json({ error: \"Failed to fetch install tasks\" });\n    }\n  });\n\n  // Get job payments\n  app.get(\"/api/jobs/:id/payments\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const payments = await storage.getPaymentsByJob(req.params.id);\n      res.json(payments);\n    } catch (error) {\n      console.error(\"Error fetching job payments:\", error);\n      res.status(500).json({ error: \"Failed to fetch job payments\" });\n    }\n  });\n\n  // ============ PRODUCTION TASKS ============\n  app.get(\"/api/production-tasks\", requireRoles(\"admin\", \"production_manager\", \"warehouse\"), async (req, res) => {\n    try {\n      const { status, assignee, jobId } = req.query;\n      let tasks;\n      if (jobId) {\n        tasks = await storage.getProductionTasksByJob(jobId as string);\n      } else if (status) {\n        tasks = await storage.getProductionTasksByStatus(status as string);\n      } else if (assignee) {\n        tasks = await storage.getProductionTasksByAssignee(assignee as string);\n      } else {\n        tasks = await storage.getProductionTasks();\n      }\n      res.json(tasks);\n    } catch (error) {\n      console.error(\"Error fetching production tasks:\", error);\n      res.status(500).json({ error: \"Failed to fetch production tasks\" });\n    }\n  });\n\n  app.post(\"/api/production-tasks\", requireRoles(\"admin\", \"production_manager\"), async (req, res) => {\n    try {\n      const validatedData = insertProductionTaskSchema.parse(req.body);\n      const task = await storage.createProductionTask(validatedData);\n      res.status(201).json(task);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating production task:\", error);\n      res.status(500).json({ error: \"Failed to create production task\" });\n    }\n  });\n\n  app.patch(\"/api/production-tasks/:id\", async (req, res) => {\n    try {\n      const task = await storage.updateProductionTask(req.params.id, req.body);\n      if (!task) {\n        return res.status(404).json({ error: \"Production task not found\" });\n      }\n      res.json(task);\n    } catch (error) {\n      console.error(\"Error updating production task:\", error);\n      res.status(500).json({ error: \"Failed to update production task\" });\n    }\n  });\n\n  // Start production task\n  app.post(\"/api/production-tasks/:id/start\", async (req, res) => {\n    try {\n      const task = await storage.updateProductionTask(req.params.id, {\n        status: \"in_progress\",\n        startTime: new Date(),\n        assignedTo: req.body.assignedTo,\n      });\n      if (!task) {\n        return res.status(404).json({ error: \"Production task not found\" });\n      }\n      res.json(task);\n    } catch (error) {\n      console.error(\"Error starting production task:\", error);\n      res.status(500).json({ error: \"Failed to start production task\" });\n    }\n  });\n\n  // Complete production task\n  app.post(\"/api/production-tasks/:id/complete\", async (req, res) => {\n    try {\n      const existingTask = await storage.getProductionTask(req.params.id);\n      if (!existingTask) {\n        return res.status(404).json({ error: \"Production task not found\" });\n      }\n\n      const endTime = new Date();\n      const startTime = existingTask.startTime ? new Date(existingTask.startTime) : endTime;\n      const timeSpentMinutes = Math.round((endTime.getTime() - startTime.getTime()) / 60000);\n\n      const task = await storage.updateProductionTask(req.params.id, {\n        status: \"completed\",\n        endTime,\n        timeSpentMinutes,\n        qaResult: req.body.qaResult,\n        qaPassedAt: req.body.qaResult === \"passed\" ? new Date() : undefined,\n      });\n      res.json(task);\n    } catch (error) {\n      console.error(\"Error completing production task:\", error);\n      res.status(500).json({ error: \"Failed to complete production task\" });\n    }\n  });\n\n  // ============ INSTALL TASKS ============\n  app.get(\"/api/install-tasks\", async (req, res) => {\n    try {\n      const { installerId, date, jobId } = req.query;\n      let tasks;\n      if (jobId) {\n        tasks = await storage.getInstallTasksByJob(jobId as string);\n      } else if (installerId) {\n        tasks = await storage.getInstallTasksByInstaller(installerId as string);\n      } else if (date) {\n        tasks = await storage.getInstallTasksByDate(new Date(date as string));\n      } else {\n        tasks = await storage.getInstallTasks();\n      }\n      res.json(tasks);\n    } catch (error) {\n      console.error(\"Error fetching install tasks:\", error);\n      res.status(500).json({ error: \"Failed to fetch install tasks\" });\n    }\n  });\n\n  app.post(\"/api/install-tasks\", async (req, res) => {\n    try {\n      const validatedData = insertInstallTaskSchema.parse(req.body);\n      const task = await storage.createInstallTask(validatedData);\n      res.status(201).json(task);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating install task:\", error);\n      res.status(500).json({ error: \"Failed to create install task\" });\n    }\n  });\n\n  app.patch(\"/api/install-tasks/:id\", async (req, res) => {\n    try {\n      const task = await storage.updateInstallTask(req.params.id, req.body);\n      if (!task) {\n        return res.status(404).json({ error: \"Install task not found\" });\n      }\n      res.json(task);\n    } catch (error) {\n      console.error(\"Error updating install task:\", error);\n      res.status(500).json({ error: \"Failed to update install task\" });\n    }\n  });\n\n  // Installer check-in\n  app.post(\"/api/install-tasks/:id/check-in\", async (req, res) => {\n    try {\n      const task = await storage.updateInstallTask(req.params.id, {\n        status: \"on_site\",\n        checkInTime: new Date(),\n      });\n      if (!task) {\n        return res.status(404).json({ error: \"Install task not found\" });\n      }\n      res.json(task);\n    } catch (error) {\n      console.error(\"Error checking in:\", error);\n      res.status(500).json({ error: \"Failed to check in\" });\n    }\n  });\n\n  // Complete install task\n  app.post(\"/api/install-tasks/:id/complete\", async (req, res) => {\n    try {\n      const task = await storage.updateInstallTask(req.params.id, {\n        status: \"completed\",\n        checkOutTime: new Date(),\n        notes: req.body.notes,\n        variationsFound: req.body.variationsFound,\n        photos: req.body.photos,\n      });\n      if (!task) {\n        return res.status(404).json({ error: \"Install task not found\" });\n      }\n\n      // Update job status\n      if (task.jobId) {\n        await storage.updateJob(task.jobId, { status: \"install_complete\" });\n      }\n\n      res.json(task);\n    } catch (error) {\n      console.error(\"Error completing install task:\", error);\n      res.status(500).json({ error: \"Failed to complete install task\" });\n    }\n  });\n\n  // ============ SCHEDULE EVENTS ============\n  app.get(\"/api/schedule\", requireRoles(\"admin\", \"scheduler\", \"production_manager\", \"installer\"), async (req, res) => {\n    try {\n      const { start, end, assignee } = req.query;\n      let events;\n      if (start && end) {\n        events = await storage.getScheduleEventsByDateRange(\n          new Date(start as string),\n          new Date(end as string)\n        );\n      } else if (assignee) {\n        events = await storage.getScheduleEventsByAssignee(assignee as string);\n      } else {\n        events = await storage.getScheduleEvents();\n      }\n      res.json(events);\n    } catch (error) {\n      console.error(\"Error fetching schedule events:\", error);\n      res.status(500).json({ error: \"Failed to fetch schedule events\" });\n    }\n  });\n\n  app.post(\"/api/schedule\", requireRoles(\"admin\", \"scheduler\"), async (req, res) => {\n    try {\n      const body = {\n        ...req.body,\n        startDate: req.body.startDate ? new Date(req.body.startDate) : undefined,\n        endDate: req.body.endDate ? new Date(req.body.endDate) : undefined,\n      };\n      const validatedData = insertScheduleEventSchema.parse(body);\n      const event = await storage.createScheduleEvent(validatedData);\n      res.status(201).json(event);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating schedule event:\", error);\n      res.status(500).json({ error: \"Failed to create schedule event\" });\n    }\n  });\n\n  app.patch(\"/api/schedule/:id\", requireRoles(\"admin\", \"scheduler\"), async (req, res) => {\n    try {\n      const body = { ...req.body };\n      if (body.startDate) body.startDate = new Date(body.startDate);\n      if (body.endDate) body.endDate = new Date(body.endDate);\n      \n      const event = await storage.updateScheduleEvent(req.params.id, body);\n      if (!event) {\n        return res.status(404).json({ error: \"Schedule event not found\" });\n      }\n      res.json(event);\n    } catch (error) {\n      console.error(\"Error updating schedule event:\", error);\n      res.status(500).json({ error: \"Failed to update schedule event\" });\n    }\n  });\n\n  app.delete(\"/api/schedule/:id\", requireRoles(\"admin\", \"scheduler\"), async (req, res) => {\n    try {\n      await storage.deleteScheduleEvent(req.params.id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting schedule event:\", error);\n      res.status(500).json({ error: \"Failed to delete schedule event\" });\n    }\n  });\n\n  // ============ PAYMENTS ============\n  app.get(\"/api/payments\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { status, clientId, jobId } = req.query;\n      let payments;\n      if (status === \"pending\") {\n        payments = await storage.getPendingPayments();\n      } else if (clientId) {\n        payments = await storage.getPaymentsByClient(clientId as string);\n      } else if (jobId) {\n        payments = await storage.getPaymentsByJob(jobId as string);\n      } else {\n        payments = await storage.getPayments();\n      }\n      res.json(payments);\n    } catch (error) {\n      console.error(\"Error fetching payments:\", error);\n      res.status(500).json({ error: \"Failed to fetch payments\" });\n    }\n  });\n\n  app.post(\"/api/payments\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const validatedData = insertPaymentSchema.parse(req.body);\n      const payment = await storage.createPayment(validatedData);\n      res.status(201).json(payment);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating payment:\", error);\n      res.status(500).json({ error: \"Failed to create payment\" });\n    }\n  });\n\n  app.patch(\"/api/payments/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const oldPayment = await storage.getPayment(req.params.id);\n      const payment = await storage.updatePayment(req.params.id, req.body);\n      if (!payment) {\n        return res.status(404).json({ error: \"Payment not found\" });\n      }\n\n      if (oldPayment && oldPayment.status !== payment.status && payment.status === \"completed\") {\n        const client = await storage.getClient(payment.clientId);\n        const admins = await storage.getUsersByRole(\"admin\");\n        const sales = await storage.getUsersByRole(\"sales\");\n        const notifyUsers = [...admins, ...sales];\n        \n        const formattedAmount = parseFloat(payment.amount).toLocaleString(\"en-AU\", { \n          style: \"currency\", \n          currency: \"AUD\" \n        });\n\n        for (const user of notifyUsers) {\n          await storage.createNotification({\n            userId: user.id,\n            type: \"payment_received\",\n            title: \"Payment Received\",\n            message: `${formattedAmount} ${payment.paymentType} payment from ${client?.name || \"Unknown client\"}`,\n            relatedEntityType: \"payment\",\n            relatedEntityId: payment.id,\n          });\n        }\n      }\n\n      res.json(payment);\n    } catch (error) {\n      console.error(\"Error updating payment:\", error);\n      res.status(500).json({ error: \"Failed to update payment\" });\n    }\n  });\n\n  // ============ STRIPE PAYMENTS ============\n  app.post(\"/api/payments/:id/create-checkout\", async (req, res) => {\n    try {\n      if (!stripe) {\n        return res.status(503).json({ error: \"Payment service not configured\" });\n      }\n\n      const payment = await storage.getPayment(req.params.id);\n      if (!payment) {\n        return res.status(404).json({ error: \"Payment not found\" });\n      }\n\n      const client = await storage.getClient(payment.clientId);\n      if (!client) {\n        return res.status(404).json({ error: \"Client not found\" });\n      }\n\n      const session = await stripe.checkout.sessions.create({\n        payment_method_types: [\"card\"],\n        line_items: [\n          {\n            price_data: {\n              currency: \"aud\",\n              product_data: {\n                name: `${payment.paymentType === \"deposit\" ? \"Deposit\" : \"Final Payment\"} - ${payment.invoiceNumber || payment.id}`,\n              },\n              unit_amount: Math.round(parseFloat(payment.amount) * 100),\n            },\n            quantity: 1,\n          },\n        ],\n        mode: \"payment\",\n        success_url: `${req.headers.origin}/payments/success?session_id={CHECKOUT_SESSION_ID}`,\n        cancel_url: `${req.headers.origin}/payments/cancelled`,\n        customer_email: client.email || undefined,\n        metadata: {\n          paymentId: payment.id,\n          jobId: payment.jobId || \"\",\n          clientId: payment.clientId,\n        },\n      });\n\n      await storage.updatePayment(payment.id, {\n        stripeSessionId: session.id,\n      });\n\n      res.json({ url: session.url });\n    } catch (error) {\n      console.error(\"Error creating checkout session:\", error);\n      res.status(500).json({ error: \"Failed to create checkout session\" });\n    }\n  });\n\n  // Stripe webhook\n  app.post(\"/api/webhooks/stripe\", async (req, res) => {\n    const sig = req.headers[\"stripe-signature\"];\n    const webhookSecret = process.env.STRIPE_WEBHOOK_SECRET;\n\n    try {\n      let event;\n      if (webhookSecret && sig && stripe) {\n        event = stripe.webhooks.constructEvent(req.body, sig as string, webhookSecret);\n      } else {\n        event = req.body;\n      }\n\n      if (event.type === \"checkout.session.completed\") {\n        const session = event.data.object;\n        const paymentId = session.metadata?.paymentId;\n\n        if (paymentId) {\n          const payment = await storage.updatePayment(paymentId, {\n            status: \"completed\",\n            paidAt: new Date(),\n            stripePaymentIntentId: session.payment_intent,\n          });\n\n          // Update job if this was a deposit\n          if (payment?.jobId && payment.paymentType === \"deposit\") {\n            await storage.updateJob(payment.jobId, {\n              depositPaid: true,\n              depositPaidAt: new Date(),\n              status: \"ready_for_production\",\n            });\n          } else if (payment?.jobId && payment.paymentType === \"final\") {\n            await storage.updateJob(payment.jobId, {\n              finalPaid: true,\n              finalPaidAt: new Date(),\n              status: \"paid_in_full\",\n            });\n          }\n        }\n      }\n\n      res.json({ received: true });\n    } catch (error) {\n      console.error(\"Webhook error:\", error);\n      res.status(400).json({ error: \"Webhook error\" });\n    }\n  });\n\n  // ============ TWILIO SMS ============\n  const smsSendSchema = z.object({\n    to: z.string().min(1, \"Phone number is required\"),\n    message: z.string().min(1, \"Message is required\"),\n    recipientName: z.string().optional(),\n    relatedEntityType: z.string().optional(),\n    relatedEntityId: z.string().optional(),\n  });\n\n  const formatPhoneNumber = (phone: string): string => {\n    let cleaned = phone.replace(/[\\s\\-\\(\\)]/g, '');\n    if (cleaned.startsWith('0')) {\n      cleaned = '+61' + cleaned.substring(1);\n    }\n    if (!cleaned.startsWith('+')) {\n      cleaned = '+61' + cleaned;\n    }\n    return cleaned;\n  };\n\n  app.post(\"/api/sms/send\", async (req, res) => {\n    try {\n      const parseResult = smsSendSchema.safeParse(req.body);\n      if (!parseResult.success) {\n        return res.status(400).json({ error: parseResult.error.errors[0].message });\n      }\n      const { to, message, recipientName, relatedEntityType, relatedEntityId } = parseResult.data;\n      \n      const formattedTo = formatPhoneNumber(to);\n\n      const twilioClient = await getTwilioClient();\n      const fromNumber = await getTwilioFromPhoneNumber();\n\n      if (!twilioClient || !fromNumber) {\n        return res.status(503).json({ error: \"SMS service not configured\" });\n      }\n\n      const smsLog = await storage.createSMSLog({\n        recipientPhone: to,\n        recipientName,\n        message,\n        status: \"pending\",\n        isOutbound: true,\n        relatedEntityType,\n        relatedEntityId,\n      });\n\n      try {\n        console.log('Sending SMS to:', formattedTo, 'from:', fromNumber);\n        const twilioMessage = await twilioClient.messages.create({\n          body: message,\n          from: fromNumber,\n          to: formattedTo,\n        });\n\n        await storage.updateSMSLog(smsLog.id, {\n          twilioMessageSid: twilioMessage.sid,\n          status: \"sent\",\n          sentAt: new Date(),\n        });\n\n        res.json({ success: true, messageSid: twilioMessage.sid, smsLog: { ...smsLog, status: \"sent\", sentAt: new Date() } });\n      } catch (twilioError: any) {\n        await storage.updateSMSLog(smsLog.id, {\n          status: \"failed\",\n          errorMessage: twilioError.message,\n        });\n        throw twilioError;\n      }\n    } catch (error: any) {\n      console.error(\"Error sending SMS:\", error);\n      res.status(500).json({ error: error.message || \"Failed to send SMS\" });\n    }\n  });\n\n  // Send install reminder\n  app.post(\"/api/sms/install-reminder\", async (req, res) => {\n    try {\n      const { jobId } = req.body;\n      const job = await storage.getJob(jobId);\n      if (!job) {\n        return res.status(404).json({ error: \"Job not found\" });\n      }\n\n      const client = await storage.getClient(job.clientId);\n      if (!client || !client.phone) {\n        return res.status(400).json({ error: \"Client phone not found\" });\n      }\n\n      const scheduledDate = job.scheduledStartDate\n        ? new Date(job.scheduledStartDate).toLocaleDateString(\"en-AU\", {\n            weekday: \"long\",\n            year: \"numeric\",\n            month: \"long\",\n            day: \"numeric\",\n          })\n        : \"soon\";\n\n      const message = `Hi ${client.name}, this is a reminder that your PVC fence installation with Probuild PVC is scheduled for ${scheduledDate}. If you have any questions, please call us. Thank you!`;\n\n      // Use the SMS send endpoint\n      const response = await fetch(`http://localhost:5000/api/sms/send`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          to: client.phone,\n          message,\n          recipientName: client.name,\n          relatedEntityType: \"job\",\n          relatedEntityId: jobId,\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error(\"Failed to send SMS\");\n      }\n\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error sending install reminder:\", error);\n      res.status(500).json({ error: \"Failed to send install reminder\" });\n    }\n  });\n\n  // Get all SMS logs\n  app.get(\"/api/sms/logs\", async (req, res) => {\n    try {\n      const logs = await storage.getSMSLogs();\n      res.json(logs);\n    } catch (error) {\n      console.error(\"Error fetching SMS logs:\", error);\n      res.status(500).json({ error: \"Failed to fetch SMS logs\" });\n    }\n  });\n\n  // Get SMS conversation by phone\n  app.get(\"/api/sms/conversation/:phone\", async (req, res) => {\n    try {\n      const { phone } = req.params;\n      const messages = await storage.getSMSLogsByPhone(phone);\n      res.json(messages);\n    } catch (error) {\n      console.error(\"Error fetching SMS conversation:\", error);\n      res.status(500).json({ error: \"Failed to fetch conversation\" });\n    }\n  });\n\n  // Get SMS logs by related entity (client, job, quote)\n  app.get(\"/api/sms/entity/:entityType/:entityId\", async (req, res) => {\n    try {\n      const { entityType, entityId } = req.params;\n      const messages = await storage.getSMSLogsByEntity(entityType, entityId);\n      res.json(messages);\n    } catch (error) {\n      console.error(\"Error fetching SMS logs by entity:\", error);\n      res.status(500).json({ error: \"Failed to fetch messages\" });\n    }\n  });\n\n  // Webhook endpoint to receive incoming SMS from Twilio\n  app.post(\"/api/sms/incoming\", async (req, res) => {\n    try {\n      console.log(\"Incoming SMS webhook received:\", req.body);\n      \n      // Twilio sends these fields in the webhook\n      const { From, Body, MessageSid } = req.body;\n      \n      if (!From || !Body) {\n        console.log(\"Missing From or Body in incoming SMS\");\n        return res.status(400).send(\"Missing required fields\");\n      }\n\n      // Find client by phone number to get their name\n      let recipientName = \"Unknown\";\n      const matchingClient = await storage.findClientByPhone(From);\n\n      if (matchingClient) {\n        recipientName = matchingClient.name;\n      }\n\n      // Store the incoming message (unread by default)\n      const smsLog = await storage.createSMSLog({\n        recipientPhone: From,\n        recipientName,\n        message: Body,\n        twilioMessageSid: MessageSid || null,\n        status: \"received\",\n        isOutbound: false,\n        isRead: false,\n        sentAt: new Date(),\n        relatedEntityType: matchingClient ? \"client\" : null,\n        relatedEntityId: matchingClient?.id || null,\n      });\n\n      // Get or create conversation and update it\n      const conversation = await storage.getOrCreateConversation(From);\n      \n      // If conversation was resolved, unresolve it (customer replied = action required)\n      // Also increment unread count\n      await storage.updateSMSConversation(conversation.id, {\n        isResolved: false,\n        resolvedAt: null,\n        resolvedBy: null,\n        lastMessageAt: new Date(),\n        unreadCount: (conversation.unreadCount || 0) + 1,\n      });\n\n      // Create notification for new incoming message\n      await storage.createNotification({\n        type: \"new_message\",\n        title: \"New SMS Message\",\n        message: `${recipientName}: ${Body.substring(0, 100)}${Body.length > 100 ? '...' : ''}`,\n        relatedEntityType: \"sms_conversation\",\n        relatedEntityId: conversation.id,\n      });\n\n      console.log(\"Incoming SMS saved:\", smsLog.id, \"from:\", From);\n\n      // Return TwiML response (empty response, no auto-reply)\n      res.set(\"Content-Type\", \"text/xml\");\n      res.send(`<?xml version=\"1.0\" encoding=\"UTF-8\"?><Response></Response>`);\n    } catch (error) {\n      console.error(\"Error processing incoming SMS:\", error);\n      res.status(500).send(\"Error processing message\");\n    }\n  });\n\n  // ============ SMS CONVERSATIONS ============\n  \n  // Get all conversations\n  app.get(\"/api/sms/conversations\", async (req, res) => {\n    try {\n      const conversations = await storage.getSMSConversations();\n      res.json(conversations);\n    } catch (error) {\n      console.error(\"Error fetching conversations:\", error);\n      res.status(500).json({ error: \"Failed to fetch conversations\" });\n    }\n  });\n\n  // Get unread message count\n  app.get(\"/api/sms/unread-count\", async (req, res) => {\n    try {\n      const count = await storage.getUnreadMessageCount();\n      res.json({ count });\n    } catch (error) {\n      console.error(\"Error fetching unread count:\", error);\n      res.status(500).json({ error: \"Failed to fetch unread count\" });\n    }\n  });\n\n  // Get conversation by ID\n  app.get(\"/api/sms/conversations/:id\", async (req, res) => {\n    try {\n      const conversation = await storage.getSMSConversation(req.params.id);\n      if (!conversation) {\n        return res.status(404).json({ error: \"Conversation not found\" });\n      }\n      res.json(conversation);\n    } catch (error) {\n      console.error(\"Error fetching conversation:\", error);\n      res.status(500).json({ error: \"Failed to fetch conversation\" });\n    }\n  });\n\n  // Update conversation (assign, resolve, link to client)\n  app.patch(\"/api/sms/conversations/:id\", async (req, res) => {\n    try {\n      const updateSchema = z.object({\n        assignedTo: z.string().nullable().optional(),\n        isResolved: z.boolean().optional(),\n        resolvedBy: z.string().nullable().optional(),\n        clientId: z.string().nullable().optional(),\n        notes: z.string().nullable().optional(),\n      });\n      \n      const validatedData = updateSchema.parse(req.body);\n      const { assignedTo, isResolved, resolvedBy, clientId, notes } = validatedData;\n      const updates: any = {};\n      \n      if (assignedTo !== undefined) updates.assignedTo = assignedTo;\n      if (clientId !== undefined) updates.clientId = clientId;\n      if (notes !== undefined) updates.notes = notes;\n      \n      if (isResolved !== undefined) {\n        updates.isResolved = isResolved;\n        if (isResolved) {\n          updates.resolvedAt = new Date();\n          updates.resolvedBy = resolvedBy || null;\n        } else {\n          updates.resolvedAt = null;\n          updates.resolvedBy = null;\n        }\n      }\n      \n      const conversation = await storage.updateSMSConversation(req.params.id, updates);\n      if (!conversation) {\n        return res.status(404).json({ error: \"Conversation not found\" });\n      }\n      res.json(conversation);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error updating conversation:\", error);\n      res.status(500).json({ error: \"Failed to update conversation\" });\n    }\n  });\n\n  // Mark messages as read\n  app.post(\"/api/sms/mark-read\", async (req, res) => {\n    try {\n      const { messageIds, conversationId } = req.body;\n      \n      if (messageIds && messageIds.length > 0) {\n        await storage.markMessagesRead(messageIds);\n      }\n      \n      // Reset unread count on conversation\n      if (conversationId) {\n        await storage.updateSMSConversation(conversationId, { unreadCount: 0 });\n      }\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error marking messages as read:\", error);\n      res.status(500).json({ error: \"Failed to mark messages as read\" });\n    }\n  });\n\n  // ============ MESSAGE RANGES ============\n  \n  // Create a message range (bundle of messages attached to an opportunity)\n  app.post(\"/api/sms/message-ranges\", async (req, res) => {\n    try {\n      const messageRangeInputSchema = insertMessageRangeSchema\n        .omit({ messageCount: true })\n        .extend({\n          startDate: z.string(),\n          endDate: z.string(),\n        });\n      \n      const validatedData = messageRangeInputSchema.parse(req.body);\n      const { conversationId, leadId, jobId, quoteId, startMessageId, endMessageId, startDate, endDate, summary } = validatedData;\n      \n      // Count messages in range\n      const conversation = await storage.getSMSConversation(conversationId);\n      if (!conversation) {\n        return res.status(404).json({ error: \"Conversation not found\" });\n      }\n      \n      const messages = await storage.getSMSLogsByPhone(conversation.phoneNumber);\n      const startTime = new Date(startDate).getTime();\n      const endTime = new Date(endDate).getTime();\n      const messagesInRange = messages.filter(m => {\n        const msgTime = new Date(m.createdAt).getTime();\n        return msgTime >= startTime && msgTime <= endTime;\n      });\n      \n      const range = await storage.createMessageRange({\n        conversationId,\n        leadId: leadId || null,\n        jobId: jobId || null,\n        quoteId: quoteId || null,\n        startMessageId,\n        endMessageId,\n        startDate: new Date(startDate),\n        endDate: new Date(endDate),\n        messageCount: messagesInRange.length,\n        summary: summary || null,\n      });\n      \n      res.status(201).json(range);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating message range:\", error);\n      res.status(500).json({ error: \"Failed to create message range\" });\n    }\n  });\n\n  // Get message ranges by lead\n  app.get(\"/api/sms/message-ranges/lead/:leadId\", async (req, res) => {\n    try {\n      const ranges = await storage.getMessageRangesByLead(req.params.leadId);\n      res.json(ranges);\n    } catch (error) {\n      console.error(\"Error fetching message ranges:\", error);\n      res.status(500).json({ error: \"Failed to fetch message ranges\" });\n    }\n  });\n\n  // Get message ranges by job\n  app.get(\"/api/sms/message-ranges/job/:jobId\", async (req, res) => {\n    try {\n      const ranges = await storage.getMessageRangesByJob(req.params.jobId);\n      res.json(ranges);\n    } catch (error) {\n      console.error(\"Error fetching message ranges:\", error);\n      res.status(500).json({ error: \"Failed to fetch message ranges\" });\n    }\n  });\n\n  // Delete message range\n  app.delete(\"/api/sms/message-ranges/:id\", async (req, res) => {\n    try {\n      await storage.deleteMessageRange(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting message range:\", error);\n      res.status(500).json({ error: \"Failed to delete message range\" });\n    }\n  });\n\n  const smsQuoteReadySchema = z.object({\n    quoteId: z.string().min(1, \"Quote ID is required\"),\n  });\n\n  // Send quote notification\n  app.post(\"/api/sms/quote-ready\", async (req, res) => {\n    try {\n      const parseResult = smsQuoteReadySchema.safeParse(req.body);\n      if (!parseResult.success) {\n        return res.status(400).json({ error: parseResult.error.errors[0].message });\n      }\n      const { quoteId } = parseResult.data;\n\n      const quote = await storage.getQuote(quoteId);\n      if (!quote) {\n        return res.status(404).json({ error: \"Quote not found\" });\n      }\n\n      const client = await storage.getClient(quote.clientId);\n      if (!client || !client.phone) {\n        return res.status(400).json({ error: \"Client phone not found\" });\n      }\n\n      const twilioClient = await getTwilioClient();\n      const fromNumber = await getTwilioFromPhoneNumber();\n\n      if (!twilioClient || !fromNumber) {\n        return res.status(503).json({ error: \"SMS service not configured\" });\n      }\n\n      const formattedAmount = parseFloat(quote.totalAmount || \"0\").toLocaleString(\"en-AU\", { \n        style: \"currency\", \n        currency: \"AUD\" \n      });\n\n      const message = `Hi ${client.name}, your quote ${quote.quoteNumber} from Probuild PVC is ready for review. Total: ${formattedAmount}. Please contact us to discuss. Thank you!`;\n\n      const smsLog = await storage.createSMSLog({\n        recipientPhone: client.phone,\n        recipientName: client.name,\n        message,\n        status: \"pending\",\n        isOutbound: true,\n        relatedEntityType: \"quote\",\n        relatedEntityId: quoteId,\n      });\n\n      try {\n        const twilioMessage = await twilioClient.messages.create({\n          body: message,\n          from: fromNumber,\n          to: client.phone,\n        });\n\n        await storage.updateSMSLog(smsLog.id, {\n          twilioMessageSid: twilioMessage.sid,\n          status: \"sent\",\n          sentAt: new Date(),\n        });\n\n        res.json({ success: true, messageSid: twilioMessage.sid });\n      } catch (twilioError: any) {\n        await storage.updateSMSLog(smsLog.id, {\n          status: \"failed\",\n          errorMessage: twilioError.message,\n        });\n        throw twilioError;\n      }\n    } catch (error: any) {\n      console.error(\"Error sending quote notification:\", error);\n      res.status(500).json({ error: error.message || \"Failed to send notification\" });\n    }\n  });\n\n  const smsPaymentReceivedSchema = z.object({\n    paymentId: z.string().min(1, \"Payment ID is required\"),\n  });\n\n  // Send payment received confirmation\n  app.post(\"/api/sms/payment-received\", async (req, res) => {\n    try {\n      const parseResult = smsPaymentReceivedSchema.safeParse(req.body);\n      if (!parseResult.success) {\n        return res.status(400).json({ error: parseResult.error.errors[0].message });\n      }\n      const { paymentId } = parseResult.data;\n\n      const payment = await storage.getPayment(paymentId);\n      if (!payment) {\n        return res.status(404).json({ error: \"Payment not found\" });\n      }\n\n      const client = await storage.getClient(payment.clientId);\n      if (!client || !client.phone) {\n        return res.status(400).json({ error: \"Client phone not found\" });\n      }\n\n      const twilioClient = await getTwilioClient();\n      const fromNumber = await getTwilioFromPhoneNumber();\n\n      if (!twilioClient || !fromNumber) {\n        return res.status(503).json({ error: \"SMS service not configured\" });\n      }\n\n      const formattedAmount = parseFloat(payment.amount).toLocaleString(\"en-AU\", { \n        style: \"currency\", \n        currency: \"AUD\" \n      });\n\n      const message = `Hi ${client.name}, thank you for your payment of ${formattedAmount}. Invoice: ${payment.invoiceNumber || \"N/A\"}. Probuild PVC appreciates your business!`;\n\n      const smsLog = await storage.createSMSLog({\n        recipientPhone: client.phone,\n        recipientName: client.name,\n        message,\n        status: \"pending\",\n        isOutbound: true,\n        relatedEntityType: \"payment\",\n        relatedEntityId: paymentId,\n      });\n\n      try {\n        const twilioMessage = await twilioClient.messages.create({\n          body: message,\n          from: fromNumber,\n          to: client.phone,\n        });\n\n        await storage.updateSMSLog(smsLog.id, {\n          twilioMessageSid: twilioMessage.sid,\n          status: \"sent\",\n          sentAt: new Date(),\n        });\n\n        res.json({ success: true, messageSid: twilioMessage.sid });\n      } catch (twilioError: any) {\n        await storage.updateSMSLog(smsLog.id, {\n          status: \"failed\",\n          errorMessage: twilioError.message,\n        });\n        throw twilioError;\n      }\n    } catch (error: any) {\n      console.error(\"Error sending payment confirmation:\", error);\n      res.status(500).json({ error: error.message || \"Failed to send confirmation\" });\n    }\n  });\n\n  // ============ NOTIFICATIONS ============\n  app.get(\"/api/notifications\", async (req, res) => {\n    try {\n      const { userId, unread } = req.query;\n      if (!userId) {\n        return res.status(400).json({ error: \"userId is required\" });\n      }\n      let notifications;\n      if (unread === \"true\") {\n        notifications = await storage.getUnreadNotifications(userId as string);\n      } else {\n        notifications = await storage.getNotificationsByUser(userId as string);\n      }\n      res.json(notifications);\n    } catch (error) {\n      console.error(\"Error fetching notifications:\", error);\n      res.status(500).json({ error: \"Failed to fetch notifications\" });\n    }\n  });\n\n  app.post(\"/api/notifications/:id/read\", async (req, res) => {\n    try {\n      const notification = await storage.markNotificationRead(req.params.id);\n      if (!notification) {\n        return res.status(404).json({ error: \"Notification not found\" });\n      }\n      res.json(notification);\n    } catch (error) {\n      console.error(\"Error marking notification read:\", error);\n      res.status(500).json({ error: \"Failed to mark notification read\" });\n    }\n  });\n\n  app.post(\"/api/notifications/read-all\", async (req, res) => {\n    try {\n      const { userId } = req.body;\n      if (!userId) {\n        return res.status(400).json({ error: \"userId is required\" });\n      }\n      await storage.markAllNotificationsRead(userId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error marking all notifications read:\", error);\n      res.status(500).json({ error: \"Failed to mark all notifications read\" });\n    }\n  });\n\n  // ============ USERS ============\n  app.get(\"/api/users\", async (req, res) => {\n    try {\n      const { role } = req.query;\n      let userList;\n      if (role) {\n        userList = await storage.getUsersByRole(role as string);\n      } else {\n        userList = await storage.getUsers();\n      }\n      res.json(userList);\n    } catch (error) {\n      console.error(\"Error fetching users:\", error);\n      res.status(500).json({ error: \"Failed to fetch users\" });\n    }\n  });\n\n  app.get(\"/api/users/:id\", async (req, res) => {\n    try {\n      const user = await storage.getUser(req.params.id);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      res.json(user);\n    } catch (error) {\n      console.error(\"Error fetching user:\", error);\n      res.status(500).json({ error: \"Failed to fetch user\" });\n    }\n  });\n\n  // Update user (admin only) - for staff management\n  app.patch(\"/api/users/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const updateSchema = z.object({\n        bankCardNumber: z.string().max(6).nullable().optional(),\n        phone: z.string().nullable().optional(),\n        positionTitle: z.string().nullable().optional(),\n        isActive: z.union([z.boolean(), z.string()]).transform(val => {\n          if (typeof val === 'boolean') return val;\n          return val === 'true';\n        }).optional(),\n      });\n      \n      const validatedData = updateSchema.parse(req.body);\n      const { bankCardNumber, phone, positionTitle, isActive } = validatedData;\n      \n      const updateData: Record<string, unknown> = {};\n      if (bankCardNumber !== undefined) updateData.bankCardNumber = bankCardNumber;\n      if (phone !== undefined) updateData.phone = phone;\n      if (positionTitle !== undefined) updateData.positionTitle = positionTitle;\n      if (isActive !== undefined) updateData.isActive = isActive;\n      \n      const user = await storage.updateUser(req.params.id, updateData);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      res.json(user);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error updating user:\", error);\n      res.status(500).json({ error: \"Failed to update user\" });\n    }\n  });\n\n  // ============ ACTIVITY LOGS ============\n  app.get(\"/api/activity-logs\", async (req, res) => {\n    try {\n      const { userId, entityType, entityId } = req.query;\n      let logs;\n      if (entityType && entityId) {\n        logs = await storage.getActivityLogsByEntity(entityType as string, entityId as string);\n      } else if (userId) {\n        logs = await storage.getActivityLogsByUser(userId as string);\n      } else {\n        logs = await storage.getActivityLogs();\n      }\n      res.json(logs);\n    } catch (error) {\n      console.error(\"Error fetching activity logs:\", error);\n      res.status(500).json({ error: \"Failed to fetch activity logs\" });\n    }\n  });\n\n  // ============ CSV EXPORTS ============\n  const escapeCSVField = (field: any): string => {\n    if (field === null || field === undefined) return \"\";\n    const str = String(field);\n    if (str.includes(\",\") || str.includes('\"') || str.includes(\"\\n\")) {\n      return `\"${str.replace(/\"/g, '\"\"')}\"`;\n    }\n    return str;\n  };\n\n  const formatDate = (date: Date | string | null): string => {\n    if (!date) return \"\";\n    const d = new Date(date);\n    return d.toLocaleDateString(\"en-AU\", { day: \"2-digit\", month: \"2-digit\", year: \"numeric\" });\n  };\n\n  const formatCurrency = (amount: string | number | null): string => {\n    if (amount === null || amount === undefined) return \"$0.00\";\n    return `$${Number(amount).toFixed(2)}`;\n  };\n\n  app.get(\"/api/export/payments\", async (req, res) => {\n    try {\n      const payments = await storage.getPayments();\n      const clients = await storage.getClients();\n      const jobs = await storage.getJobs();\n      \n      const clientMap = new Map(clients.map(c => [c.id, c]));\n      const jobMap = new Map(jobs.map(j => [j.id, j]));\n      \n      const headers = [\"Invoice Number\", \"Client Name\", \"Job Number\", \"Amount\", \"Payment Type\", \"Payment Method\", \"Status\", \"Paid Date\", \"Created Date\"];\n      const rows = payments.map(p => {\n        const client = clientMap.get(p.clientId);\n        const job = p.jobId ? jobMap.get(p.jobId) : null;\n        return [\n          escapeCSVField(p.invoiceNumber),\n          escapeCSVField(client?.name || \"Unknown\"),\n          escapeCSVField(job?.jobNumber || \"\"),\n          escapeCSVField(formatCurrency(p.amount)),\n          escapeCSVField(p.paymentType),\n          escapeCSVField(p.paymentMethod || \"\"),\n          escapeCSVField(p.status),\n          escapeCSVField(formatDate(p.paidAt)),\n          escapeCSVField(formatDate(p.createdAt)),\n        ].join(\",\");\n      });\n      \n      const csv = [headers.join(\",\"), ...rows].join(\"\\n\");\n      const filename = `payments-export-${new Date().toISOString().split(\"T\")[0]}.csv`;\n      \n      res.setHeader(\"Content-Type\", \"text/csv\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"${filename}\"`);\n      res.send(csv);\n    } catch (error) {\n      console.error(\"Error exporting payments:\", error);\n      res.status(500).json({ error: \"Failed to export payments\" });\n    }\n  });\n\n  app.get(\"/api/export/products\", async (req, res) => {\n    try {\n      const products = await storage.getProducts();\n      \n      const headers = [\"SKU\", \"Name\", \"Category\", \"Cost Price\", \"Sell Price\", \"Stock on Hand\", \"Reorder Point\", \"Is Active\"];\n      const rows = products.map(p => [\n        escapeCSVField(p.sku),\n        escapeCSVField(p.name),\n        escapeCSVField(p.category),\n        escapeCSVField(formatCurrency(p.costPrice)),\n        escapeCSVField(formatCurrency(p.sellPrice)),\n        escapeCSVField(p.stockOnHand),\n        escapeCSVField(p.reorderPoint),\n        escapeCSVField(p.isActive ? \"Yes\" : \"No\"),\n      ].join(\",\"));\n      \n      const csv = [headers.join(\",\"), ...rows].join(\"\\n\");\n      const filename = `inventory-export-${new Date().toISOString().split(\"T\")[0]}.csv`;\n      \n      res.setHeader(\"Content-Type\", \"text/csv\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"${filename}\"`);\n      res.send(csv);\n    } catch (error) {\n      console.error(\"Error exporting products:\", error);\n      res.status(500).json({ error: \"Failed to export products\" });\n    }\n  });\n\n  app.get(\"/api/export/jobs\", async (req, res) => {\n    try {\n      const jobs = await storage.getJobs();\n      const clients = await storage.getClients();\n      const users = await storage.getUsers();\n      \n      const clientMap = new Map(clients.map(c => [c.id, c]));\n      const userMap = new Map(users.map(u => [u.id, u]));\n      \n      const headers = [\"Job Number\", \"Client Name\", \"Job Type\", \"Site Address\", \"Fence Style\", \"Total Length (m)\", \"Fence Height (mm)\", \"Total Amount\", \"Deposit Paid\", \"Status\", \"Assigned Installer\", \"Scheduled Start\", \"Created Date\"];\n      const rows = jobs.map(j => {\n        const client = clientMap.get(j.clientId);\n        const installer = j.assignedInstaller ? userMap.get(j.assignedInstaller) : null;\n        return [\n          escapeCSVField(j.jobNumber),\n          escapeCSVField(client?.name || \"Unknown\"),\n          escapeCSVField(j.jobType),\n          escapeCSVField(j.siteAddress),\n          escapeCSVField(j.fenceStyle),\n          escapeCSVField(j.totalLength),\n          escapeCSVField(j.fenceHeight),\n          escapeCSVField(formatCurrency(j.totalAmount)),\n          escapeCSVField(j.depositPaid ? \"Yes\" : \"No\"),\n          escapeCSVField(j.status),\n          escapeCSVField(installer ? `${installer.firstName} ${installer.lastName}` : \"\"),\n          escapeCSVField(formatDate(j.scheduledStartDate)),\n          escapeCSVField(formatDate(j.createdAt)),\n        ].join(\",\");\n      });\n      \n      const csv = [headers.join(\",\"), ...rows].join(\"\\n\");\n      const filename = `jobs-export-${new Date().toISOString().split(\"T\")[0]}.csv`;\n      \n      res.setHeader(\"Content-Type\", \"text/csv\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"${filename}\"`);\n      res.send(csv);\n    } catch (error) {\n      console.error(\"Error exporting jobs:\", error);\n      res.status(500).json({ error: \"Failed to export jobs\" });\n    }\n  });\n\n  app.get(\"/api/export/clients\", async (req, res) => {\n    try {\n      const clients = await storage.getClients();\n      \n      const headers = [\"Name\", \"Company\", \"Client Type\", \"Phone\", \"Email\", \"Address\", \"ABN\", \"Trade Discount Level\", \"Created Date\"];\n      const rows = clients.map(c => [\n        escapeCSVField(c.name),\n        escapeCSVField(c.companyName),\n        escapeCSVField(c.clientType),\n        escapeCSVField(c.phone),\n        escapeCSVField(c.email),\n        escapeCSVField(c.address),\n        escapeCSVField(c.abn),\n        escapeCSVField(c.tradeDiscountLevel),\n        escapeCSVField(formatDate(c.createdAt)),\n      ].join(\",\"));\n      \n      const csv = [headers.join(\",\"), ...rows].join(\"\\n\");\n      const filename = `clients-export-${new Date().toISOString().split(\"T\")[0]}.csv`;\n      \n      res.setHeader(\"Content-Type\", \"text/csv\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"${filename}\"`);\n      res.send(csv);\n    } catch (error) {\n      console.error(\"Error exporting clients:\", error);\n      res.status(500).json({ error: \"Failed to export clients\" });\n    }\n  });\n\n  app.get(\"/api/export/leads\", async (req, res) => {\n    try {\n      const leads = await storage.getLeads();\n      const clients = await storage.getClients();\n      const users = await storage.getUsers();\n      \n      const clientMap = new Map(clients.map(c => [c.id, c]));\n      const userMap = new Map(users.map(u => [u.id, u]));\n      \n      const headers = [\"Lead Type\", \"Source\", \"Stage\", \"Client Name\", \"Site Address\", \"Description\", \"Fence Style\", \"Fence Length (m)\", \"Assigned To\", \"Created Date\"];\n      const rows = leads.map(l => {\n        const client = l.clientId ? clientMap.get(l.clientId) : null;\n        const assignee = l.assignedTo ? userMap.get(l.assignedTo) : null;\n        return [\n          escapeCSVField(l.leadType),\n          escapeCSVField(l.source),\n          escapeCSVField(l.stage),\n          escapeCSVField(client?.name || \"\"),\n          escapeCSVField(l.siteAddress),\n          escapeCSVField(l.description),\n          escapeCSVField(l.fenceStyle),\n          escapeCSVField(l.fenceLength),\n          escapeCSVField(assignee ? `${assignee.firstName} ${assignee.lastName}` : \"\"),\n          escapeCSVField(formatDate(l.createdAt)),\n        ].join(\",\");\n      });\n      \n      const csv = [headers.join(\",\"), ...rows].join(\"\\n\");\n      const filename = `leads-export-${new Date().toISOString().split(\"T\")[0]}.csv`;\n      \n      res.setHeader(\"Content-Type\", \"text/csv\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"${filename}\"`);\n      res.send(csv);\n    } catch (error) {\n      console.error(\"Error exporting leads:\", error);\n      res.status(500).json({ error: \"Failed to export leads\" });\n    }\n  });\n\n  // ============ QUOTE FOLLOW-UPS ============\n\n  app.get(\"/api/quote-follow-ups\", async (req, res) => {\n    try {\n      const followUps = await storage.getPendingFollowUps();\n      res.json(followUps);\n    } catch (error) {\n      console.error(\"Error fetching follow-ups:\", error);\n      res.status(500).json({ error: \"Failed to fetch follow-ups\" });\n    }\n  });\n\n  app.get(\"/api/quote-follow-ups/quote/:quoteId\", async (req, res) => {\n    try {\n      const followUps = await storage.getQuoteFollowUpsByQuote(req.params.quoteId);\n      res.json(followUps);\n    } catch (error) {\n      console.error(\"Error fetching follow-ups:\", error);\n      res.status(500).json({ error: \"Failed to fetch follow-ups\" });\n    }\n  });\n\n  app.post(\"/api/quote-follow-ups\", async (req, res) => {\n    try {\n      const followUp = await storage.createQuoteFollowUp({\n        ...req.body,\n        scheduledDate: new Date(req.body.scheduledDate),\n      });\n      res.status(201).json(followUp);\n    } catch (error) {\n      console.error(\"Error creating follow-up:\", error);\n      res.status(500).json({ error: \"Failed to create follow-up\" });\n    }\n  });\n\n  app.patch(\"/api/quote-follow-ups/:id\", async (req, res) => {\n    try {\n      const updates = { ...req.body };\n      if (updates.scheduledDate) {\n        updates.scheduledDate = new Date(updates.scheduledDate);\n      }\n      if (updates.completedAt) {\n        updates.completedAt = new Date(updates.completedAt);\n      }\n      const followUp = await storage.updateQuoteFollowUp(req.params.id, updates);\n      if (!followUp) {\n        return res.status(404).json({ error: \"Follow-up not found\" });\n      }\n      res.json(followUp);\n    } catch (error) {\n      console.error(\"Error updating follow-up:\", error);\n      res.status(500).json({ error: \"Failed to update follow-up\" });\n    }\n  });\n\n  app.delete(\"/api/quote-follow-ups/:id\", async (req, res) => {\n    try {\n      await storage.deleteQuoteFollowUp(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting follow-up:\", error);\n      res.status(500).json({ error: \"Failed to delete follow-up\" });\n    }\n  });\n\n  // ============ AUTOMATION CAMPAIGNS ============\n\n  app.get(\"/api/automation-campaigns\", async (req, res) => {\n    try {\n      const campaigns = await storage.getAutomationCampaigns();\n      res.json(campaigns);\n    } catch (error) {\n      console.error(\"Error fetching campaigns:\", error);\n      res.status(500).json({ error: \"Failed to fetch campaigns\" });\n    }\n  });\n\n  app.get(\"/api/automation-campaigns/:id\", async (req, res) => {\n    try {\n      const campaign = await storage.getAutomationCampaign(req.params.id);\n      if (!campaign) {\n        return res.status(404).json({ error: \"Campaign not found\" });\n      }\n      res.json(campaign);\n    } catch (error) {\n      console.error(\"Error fetching campaign:\", error);\n      res.status(500).json({ error: \"Failed to fetch campaign\" });\n    }\n  });\n\n  app.post(\"/api/automation-campaigns\", async (req, res) => {\n    try {\n      const campaign = await storage.createAutomationCampaign(req.body);\n      res.status(201).json(campaign);\n    } catch (error) {\n      console.error(\"Error creating campaign:\", error);\n      res.status(500).json({ error: \"Failed to create campaign\" });\n    }\n  });\n\n  app.patch(\"/api/automation-campaigns/:id\", async (req, res) => {\n    try {\n      const campaign = await storage.updateAutomationCampaign(req.params.id, req.body);\n      if (!campaign) {\n        return res.status(404).json({ error: \"Campaign not found\" });\n      }\n      res.json(campaign);\n    } catch (error) {\n      console.error(\"Error updating campaign:\", error);\n      res.status(500).json({ error: \"Failed to update campaign\" });\n    }\n  });\n\n  app.delete(\"/api/automation-campaigns/:id\", async (req, res) => {\n    try {\n      await storage.deleteAutomationCampaign(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting campaign:\", error);\n      res.status(500).json({ error: \"Failed to delete campaign\" });\n    }\n  });\n\n  // ============ CAMPAIGN ENROLLMENTS ============\n\n  app.get(\"/api/campaign-enrollments\", async (req, res) => {\n    try {\n      const enrollments = await storage.getPendingEnrollments();\n      res.json(enrollments);\n    } catch (error) {\n      console.error(\"Error fetching enrollments:\", error);\n      res.status(500).json({ error: \"Failed to fetch enrollments\" });\n    }\n  });\n\n  app.get(\"/api/campaign-enrollments/campaign/:campaignId\", async (req, res) => {\n    try {\n      const enrollments = await storage.getCampaignEnrollmentsByCampaign(req.params.campaignId);\n      res.json(enrollments);\n    } catch (error) {\n      console.error(\"Error fetching enrollments:\", error);\n      res.status(500).json({ error: \"Failed to fetch enrollments\" });\n    }\n  });\n\n  app.post(\"/api/campaign-enrollments\", async (req, res) => {\n    try {\n      const enrollment = await storage.createCampaignEnrollment({\n        ...req.body,\n        scheduledSendAt: req.body.scheduledSendAt ? new Date(req.body.scheduledSendAt) : null,\n      });\n      res.status(201).json(enrollment);\n    } catch (error) {\n      console.error(\"Error creating enrollment:\", error);\n      res.status(500).json({ error: \"Failed to create enrollment\" });\n    }\n  });\n\n  app.patch(\"/api/campaign-enrollments/:id/cancel\", async (req, res) => {\n    try {\n      const enrollment = await storage.cancelCampaignEnrollment(req.params.id, req.body.reason || \"Cancelled by user\");\n      if (!enrollment) {\n        return res.status(404).json({ error: \"Enrollment not found\" });\n      }\n      res.json(enrollment);\n    } catch (error) {\n      console.error(\"Error cancelling enrollment:\", error);\n      res.status(500).json({ error: \"Failed to cancel enrollment\" });\n    }\n  });\n\n  // ============ PROFIT & LOSS COST TRACKING ============\n  // Staff-only endpoints for job costing analysis\n\n  // Staff Rate Cards\n  app.get(\"/api/staff-rate-cards\", async (req, res) => {\n    try {\n      const rateCards = await storage.getStaffRateCards();\n      res.json(rateCards);\n    } catch (error) {\n      console.error(\"Error fetching rate cards:\", error);\n      res.status(500).json({ error: \"Failed to fetch rate cards\" });\n    }\n  });\n\n  app.get(\"/api/staff-rate-cards/user/:userId\", async (req, res) => {\n    try {\n      const rateCards = await storage.getStaffRateCardsByUser(req.params.userId);\n      res.json(rateCards);\n    } catch (error) {\n      console.error(\"Error fetching rate cards:\", error);\n      res.status(500).json({ error: \"Failed to fetch rate cards\" });\n    }\n  });\n\n  app.get(\"/api/staff-rate-cards/:id\", async (req, res) => {\n    try {\n      const rateCard = await storage.getStaffRateCard(req.params.id);\n      if (!rateCard) {\n        return res.status(404).json({ error: \"Rate card not found\" });\n      }\n      res.json(rateCard);\n    } catch (error) {\n      console.error(\"Error fetching rate card:\", error);\n      res.status(500).json({ error: \"Failed to fetch rate card\" });\n    }\n  });\n\n  app.post(\"/api/staff-rate-cards\", async (req, res) => {\n    try {\n      const data = {\n        ...req.body,\n        effectiveFrom: req.body.effectiveFrom ? new Date(req.body.effectiveFrom) : new Date(),\n        effectiveUntil: req.body.effectiveUntil ? new Date(req.body.effectiveUntil) : null,\n      };\n      const rateCard = await storage.createStaffRateCard(data);\n      res.status(201).json(rateCard);\n    } catch (error) {\n      console.error(\"Error creating rate card:\", error);\n      res.status(500).json({ error: \"Failed to create rate card\" });\n    }\n  });\n\n  app.patch(\"/api/staff-rate-cards/:id\", async (req, res) => {\n    try {\n      const data = { ...req.body };\n      if (data.effectiveFrom) data.effectiveFrom = new Date(data.effectiveFrom);\n      if (data.effectiveUntil) data.effectiveUntil = new Date(data.effectiveUntil);\n      const rateCard = await storage.updateStaffRateCard(req.params.id, data);\n      if (!rateCard) {\n        return res.status(404).json({ error: \"Rate card not found\" });\n      }\n      res.json(rateCard);\n    } catch (error) {\n      console.error(\"Error updating rate card:\", error);\n      res.status(500).json({ error: \"Failed to update rate card\" });\n    }\n  });\n\n  app.delete(\"/api/staff-rate-cards/:id\", async (req, res) => {\n    try {\n      await storage.deleteStaffRateCard(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting rate card:\", error);\n      res.status(500).json({ error: \"Failed to delete rate card\" });\n    }\n  });\n\n  // Quote Cost Components\n  app.get(\"/api/quotes/:quoteId/costs\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const components = await storage.getQuoteCostComponentsByQuote(req.params.quoteId);\n      res.json(components);\n    } catch (error) {\n      console.error(\"Error fetching cost components:\", error);\n      res.status(500).json({ error: \"Failed to fetch cost components\" });\n    }\n  });\n\n  app.post(\"/api/quotes/:quoteId/costs\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const component = await storage.createQuoteCostComponent({\n        ...req.body,\n        quoteId: req.params.quoteId,\n      });\n      // Recalculate summary\n      await storage.recalculateQuotePLSummary(req.params.quoteId);\n      res.status(201).json(component);\n    } catch (error) {\n      console.error(\"Error creating cost component:\", error);\n      res.status(500).json({ error: \"Failed to create cost component\" });\n    }\n  });\n\n  app.patch(\"/api/quotes/:quoteId/costs/:id\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const component = await storage.updateQuoteCostComponent(req.params.id, req.body);\n      if (!component) {\n        return res.status(404).json({ error: \"Cost component not found\" });\n      }\n      // Recalculate summary\n      await storage.recalculateQuotePLSummary(req.params.quoteId);\n      res.json(component);\n    } catch (error) {\n      console.error(\"Error updating cost component:\", error);\n      res.status(500).json({ error: \"Failed to update cost component\" });\n    }\n  });\n\n  app.delete(\"/api/quotes/:quoteId/costs/:id\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      await storage.deleteQuoteCostComponent(req.params.id);\n      // Recalculate summary\n      await storage.recalculateQuotePLSummary(req.params.quoteId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting cost component:\", error);\n      res.status(500).json({ error: \"Failed to delete cost component\" });\n    }\n  });\n\n  // Quote Trips\n  app.get(\"/api/quotes/:quoteId/trips\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const trips = await storage.getQuoteTripsByQuote(req.params.quoteId);\n      res.json(trips);\n    } catch (error) {\n      console.error(\"Error fetching trips:\", error);\n      res.status(500).json({ error: \"Failed to fetch trips\" });\n    }\n  });\n\n  app.post(\"/api/quotes/:quoteId/trips\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const trip = await storage.createQuoteTrip({\n        ...req.body,\n        quoteId: req.params.quoteId,\n        scheduledDate: req.body.scheduledDate ? new Date(req.body.scheduledDate) : null,\n      });\n      // Recalculate summary\n      await storage.recalculateQuotePLSummary(req.params.quoteId);\n      res.status(201).json(trip);\n    } catch (error) {\n      console.error(\"Error creating trip:\", error);\n      res.status(500).json({ error: \"Failed to create trip\" });\n    }\n  });\n\n  app.patch(\"/api/quotes/:quoteId/trips/:id\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const data = { ...req.body };\n      if (data.scheduledDate) data.scheduledDate = new Date(data.scheduledDate);\n      const trip = await storage.updateQuoteTrip(req.params.id, data);\n      if (!trip) {\n        return res.status(404).json({ error: \"Trip not found\" });\n      }\n      // Recalculate summary\n      await storage.recalculateQuotePLSummary(req.params.quoteId);\n      res.json(trip);\n    } catch (error) {\n      console.error(\"Error updating trip:\", error);\n      res.status(500).json({ error: \"Failed to update trip\" });\n    }\n  });\n\n  app.delete(\"/api/quotes/:quoteId/trips/:id\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      await storage.deleteQuoteTrip(req.params.id);\n      // Recalculate summary\n      await storage.recalculateQuotePLSummary(req.params.quoteId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting trip:\", error);\n      res.status(500).json({ error: \"Failed to delete trip\" });\n    }\n  });\n\n  // Quote Admin Time\n  app.get(\"/api/quotes/:quoteId/admin-time\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const adminTime = await storage.getQuoteAdminTimeByQuote(req.params.quoteId);\n      res.json(adminTime);\n    } catch (error) {\n      console.error(\"Error fetching admin time:\", error);\n      res.status(500).json({ error: \"Failed to fetch admin time\" });\n    }\n  });\n\n  app.post(\"/api/quotes/:quoteId/admin-time\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const adminTime = await storage.createQuoteAdminTime({\n        ...req.body,\n        quoteId: req.params.quoteId,\n      });\n      // Recalculate summary\n      await storage.recalculateQuotePLSummary(req.params.quoteId);\n      res.status(201).json(adminTime);\n    } catch (error) {\n      console.error(\"Error creating admin time:\", error);\n      res.status(500).json({ error: \"Failed to create admin time\" });\n    }\n  });\n\n  app.patch(\"/api/quotes/:quoteId/admin-time/:id\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const adminTime = await storage.updateQuoteAdminTime(req.params.id, req.body);\n      if (!adminTime) {\n        return res.status(404).json({ error: \"Admin time not found\" });\n      }\n      // Recalculate summary\n      await storage.recalculateQuotePLSummary(req.params.quoteId);\n      res.json(adminTime);\n    } catch (error) {\n      console.error(\"Error updating admin time:\", error);\n      res.status(500).json({ error: \"Failed to update admin time\" });\n    }\n  });\n\n  app.delete(\"/api/quotes/:quoteId/admin-time/:id\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      await storage.deleteQuoteAdminTime(req.params.id);\n      // Recalculate summary\n      await storage.recalculateQuotePLSummary(req.params.quoteId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting admin time:\", error);\n      res.status(500).json({ error: \"Failed to delete admin time\" });\n    }\n  });\n\n  // Travel Sessions (for real-time tracking)\n  app.get(\"/api/trips/:tripId/travel-sessions\", async (req, res) => {\n    try {\n      const sessions = await storage.getTravelSessionsByTrip(req.params.tripId);\n      res.json(sessions);\n    } catch (error) {\n      console.error(\"Error fetching travel sessions:\", error);\n      res.status(500).json({ error: \"Failed to fetch travel sessions\" });\n    }\n  });\n\n  app.get(\"/api/travel-sessions/active\", async (req, res) => {\n    try {\n      const sessions = await storage.getActiveTravelSessions();\n      res.json(sessions);\n    } catch (error) {\n      console.error(\"Error fetching active sessions:\", error);\n      res.status(500).json({ error: \"Failed to fetch active sessions\" });\n    }\n  });\n\n  app.post(\"/api/trips/:tripId/travel-sessions/start\", async (req, res) => {\n    try {\n      const session = await storage.createTravelSession({\n        tripId: req.params.tripId,\n        staffId: req.body.staffId,\n        clientId: req.body.clientId,\n        startLatitude: req.body.startLatitude,\n        startLongitude: req.body.startLongitude,\n        startedAt: new Date(),\n        status: 'in_transit',\n        estimatedArrivalTime: req.body.estimatedArrivalTime ? new Date(req.body.estimatedArrivalTime) : null,\n      });\n      \n      // Optional: Send SMS notification to client\n      if (req.body.notifyClient && req.body.clientPhone) {\n        const twilio = await getTwilioClient();\n        if (twilio) {\n          try {\n            const fromPhone = await getTwilioFromPhoneNumber();\n            await twilio.messages.create({\n              body: `Probuild PVC: Our team is now on their way to your site. Estimated arrival time: ${req.body.etaMinutes || 30} minutes.`,\n              from: fromPhone || '',\n              to: req.body.clientPhone,\n            });\n            // Update session with notification info\n            await storage.updateTravelSession(session.id, {\n              clientNotificationSent: true,\n              clientNotificationSentAt: new Date(),\n            });\n          } catch (smsError) {\n            console.error(\"Failed to send travel notification SMS:\", smsError);\n          }\n        }\n      }\n      \n      res.status(201).json(session);\n    } catch (error) {\n      console.error(\"Error starting travel session:\", error);\n      res.status(500).json({ error: \"Failed to start travel session\" });\n    }\n  });\n\n  app.patch(\"/api/travel-sessions/:id/arrive\", async (req, res) => {\n    try {\n      const session = await storage.updateTravelSession(req.params.id, {\n        endLatitude: req.body.endLatitude,\n        endLongitude: req.body.endLongitude,\n        actualArrivalTime: new Date(),\n        status: 'arrived',\n        completedAt: new Date(),\n      });\n      \n      if (!session) {\n        return res.status(404).json({ error: \"Travel session not found\" });\n      }\n      \n      // Update trip totals if duration/distance provided\n      if (session.tripId && (req.body.durationMinutes || req.body.distanceKm)) {\n        const trip = await storage.getQuoteTrip(session.tripId);\n        if (trip) {\n          await storage.updateQuoteTrip(session.tripId, {\n            durationMinutes: req.body.durationMinutes || trip.durationMinutes,\n            distanceKm: req.body.distanceKm?.toString() || trip.distanceKm,\n          });\n          \n          // Recalculate P&L if we have a quoteId\n          if (trip.quoteId) {\n            await storage.recalculateQuotePLSummary(trip.quoteId);\n          }\n        }\n      }\n      \n      res.json(session);\n    } catch (error) {\n      console.error(\"Error completing travel session:\", error);\n      res.status(500).json({ error: \"Failed to complete travel session\" });\n    }\n  });\n\n  // Quote Ground Conditions\n  app.get(\"/api/quotes/:quoteId/ground-conditions\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const conditions = await storage.getQuoteGroundConditionsByQuote(req.params.quoteId);\n      res.json(conditions);\n    } catch (error) {\n      console.error(\"Error fetching ground conditions:\", error);\n      res.status(500).json({ error: \"Failed to fetch ground conditions\" });\n    }\n  });\n\n  app.post(\"/api/quotes/:quoteId/ground-conditions\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const condition = await storage.createQuoteGroundCondition({\n        ...req.body,\n        quoteId: req.params.quoteId,\n      });\n      // Recalculate summary\n      await storage.recalculateQuotePLSummary(req.params.quoteId);\n      res.status(201).json(condition);\n    } catch (error) {\n      console.error(\"Error creating ground condition:\", error);\n      res.status(500).json({ error: \"Failed to create ground condition\" });\n    }\n  });\n\n  app.patch(\"/api/quotes/:quoteId/ground-conditions/:id\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const condition = await storage.updateQuoteGroundCondition(req.params.id, req.body);\n      if (!condition) {\n        return res.status(404).json({ error: \"Ground condition not found\" });\n      }\n      // Recalculate summary\n      await storage.recalculateQuotePLSummary(req.params.quoteId);\n      res.json(condition);\n    } catch (error) {\n      console.error(\"Error updating ground condition:\", error);\n      res.status(500).json({ error: \"Failed to update ground condition\" });\n    }\n  });\n\n  app.delete(\"/api/quotes/:quoteId/ground-conditions/:id\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      await storage.deleteQuoteGroundCondition(req.params.id);\n      // Recalculate summary\n      await storage.recalculateQuotePLSummary(req.params.quoteId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting ground condition:\", error);\n      res.status(500).json({ error: \"Failed to delete ground condition\" });\n    }\n  });\n\n  // Quote P&L Summary\n  app.get(\"/api/quotes/:quoteId/pl-summary\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      let summary = await storage.getQuotePLSummaryByQuote(req.params.quoteId);\n      \n      // If no summary exists, calculate it\n      if (!summary) {\n        summary = await storage.recalculateQuotePLSummary(req.params.quoteId);\n      }\n      \n      if (!summary) {\n        return res.status(404).json({ error: \"Quote not found\" });\n      }\n      \n      res.json(summary);\n    } catch (error) {\n      console.error(\"Error fetching P&L summary:\", error);\n      res.status(500).json({ error: \"Failed to fetch P&L summary\" });\n    }\n  });\n\n  app.post(\"/api/quotes/:quoteId/pl-summary/recalculate\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const summary = await storage.recalculateQuotePLSummary(req.params.quoteId);\n      if (!summary) {\n        return res.status(404).json({ error: \"Quote not found\" });\n      }\n      res.json(summary);\n    } catch (error) {\n      console.error(\"Error recalculating P&L:\", error);\n      res.status(500).json({ error: \"Failed to recalculate P&L\" });\n    }\n  });\n\n  // Job-based P&L (for completed jobs)\n  app.get(\"/api/jobs/:jobId/costs\", requireRoles(\"admin\", \"sales\", \"production_manager\"), async (req, res) => {\n    try {\n      const components = await storage.getQuoteCostComponentsByJob(req.params.jobId);\n      res.json(components);\n    } catch (error) {\n      console.error(\"Error fetching job costs:\", error);\n      res.status(500).json({ error: \"Failed to fetch job costs\" });\n    }\n  });\n\n  app.get(\"/api/jobs/:jobId/trips\", requireRoles(\"admin\", \"sales\", \"scheduler\", \"production_manager\"), async (req, res) => {\n    try {\n      const trips = await storage.getQuoteTripsByJob(req.params.jobId);\n      res.json(trips);\n    } catch (error) {\n      console.error(\"Error fetching job trips:\", error);\n      res.status(500).json({ error: \"Failed to fetch job trips\" });\n    }\n  });\n\n  app.get(\"/api/jobs/:jobId/admin-time\", requireRoles(\"admin\", \"sales\", \"production_manager\"), async (req, res) => {\n    try {\n      const adminTime = await storage.getQuoteAdminTimeByJob(req.params.jobId);\n      res.json(adminTime);\n    } catch (error) {\n      console.error(\"Error fetching job admin time:\", error);\n      res.status(500).json({ error: \"Failed to fetch job admin time\" });\n    }\n  });\n\n  app.get(\"/api/jobs/:jobId/pl-summary\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const summary = await storage.getQuotePLSummaryByJob(req.params.jobId);\n      if (!summary) {\n        return res.status(404).json({ error: \"P&L summary not found for this job\" });\n      }\n      res.json(summary);\n    } catch (error) {\n      console.error(\"Error fetching job P&L summary:\", error);\n      res.status(500).json({ error: \"Failed to fetch job P&L summary\" });\n    }\n  });\n\n  // ============================================\n  // ORGANISATION HUB\n  // ============================================\n\n  // ============ DEPARTMENTS ============\n  app.get(\"/api/organisation/departments\", async (req, res) => {\n    try {\n      const departments = await storage.getDepartments();\n      res.json(departments);\n    } catch (error) {\n      console.error(\"Error fetching departments:\", error);\n      res.status(500).json({ error: \"Failed to fetch departments\" });\n    }\n  });\n\n  app.get(\"/api/organisation/departments/:id\", async (req, res) => {\n    try {\n      const department = await storage.getDepartment(req.params.id);\n      if (!department) {\n        return res.status(404).json({ error: \"Department not found\" });\n      }\n      res.json(department);\n    } catch (error) {\n      console.error(\"Error fetching department:\", error);\n      res.status(500).json({ error: \"Failed to fetch department\" });\n    }\n  });\n\n  app.post(\"/api/organisation/departments\", async (req, res) => {\n    try {\n      const data = { ...req.body };\n      if (data.managerUserId === \"\") data.managerUserId = null;\n      const validatedData = insertDepartmentSchema.parse(data);\n      const department = await storage.createDepartment(validatedData);\n      res.status(201).json(department);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating department:\", error);\n      res.status(500).json({ error: \"Failed to create department\" });\n    }\n  });\n\n  app.patch(\"/api/organisation/departments/:id\", async (req, res) => {\n    try {\n      const data = { ...req.body };\n      if (data.managerUserId === \"\") data.managerUserId = null;\n      const validatedData = insertDepartmentSchema.partial().parse(data);\n      const department = await storage.updateDepartment(req.params.id, validatedData);\n      if (!department) {\n        return res.status(404).json({ error: \"Department not found\" });\n      }\n      res.json(department);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error updating department:\", error);\n      res.status(500).json({ error: \"Failed to update department\" });\n    }\n  });\n\n  app.delete(\"/api/organisation/departments/:id\", async (req, res) => {\n    try {\n      const deleted = await storage.deleteDepartment(req.params.id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"Department not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting department:\", error);\n      res.status(500).json({ error: \"Failed to delete department\" });\n    }\n  });\n\n  // ============ WORKFLOWS ============\n  app.get(\"/api/organisation/workflows\", async (req, res) => {\n    try {\n      const { department, category, status } = req.query;\n      let workflowList;\n      if (department) {\n        workflowList = await storage.getWorkflowsByDepartment(department as string);\n      } else if (category) {\n        workflowList = await storage.getWorkflowsByCategory(category as string);\n      } else if (status === 'active') {\n        workflowList = await storage.getActiveWorkflows();\n      } else {\n        workflowList = await storage.getWorkflows();\n      }\n      res.json(workflowList);\n    } catch (error) {\n      console.error(\"Error fetching workflows:\", error);\n      res.status(500).json({ error: \"Failed to fetch workflows\" });\n    }\n  });\n\n  app.get(\"/api/organisation/workflows/:id\", async (req, res) => {\n    try {\n      const workflow = await storage.getWorkflow(req.params.id);\n      if (!workflow) {\n        return res.status(404).json({ error: \"Workflow not found\" });\n      }\n      res.json(workflow);\n    } catch (error) {\n      console.error(\"Error fetching workflow:\", error);\n      res.status(500).json({ error: \"Failed to fetch workflow\" });\n    }\n  });\n\n  app.post(\"/api/organisation/workflows\", async (req, res) => {\n    try {\n      const data = { ...req.body };\n      if (data.departmentId === \"\") data.departmentId = null;\n      const validatedData = insertWorkflowSchema.parse(data);\n      const workflow = await storage.createWorkflow(validatedData);\n      res.status(201).json(workflow);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating workflow:\", error);\n      res.status(500).json({ error: \"Failed to create workflow\" });\n    }\n  });\n\n  app.patch(\"/api/organisation/workflows/:id\", async (req, res) => {\n    try {\n      const data = { ...req.body };\n      if (data.departmentId === \"\") data.departmentId = null;\n      const validatedData = insertWorkflowSchema.partial().parse(data);\n      const workflow = await storage.updateWorkflow(req.params.id, validatedData);\n      if (!workflow) {\n        return res.status(404).json({ error: \"Workflow not found\" });\n      }\n      res.json(workflow);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error updating workflow:\", error);\n      res.status(500).json({ error: \"Failed to update workflow\" });\n    }\n  });\n\n  app.delete(\"/api/organisation/workflows/:id\", async (req, res) => {\n    try {\n      const deleted = await storage.deleteWorkflow(req.params.id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"Workflow not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting workflow:\", error);\n      res.status(500).json({ error: \"Failed to delete workflow\" });\n    }\n  });\n\n  // Workflow Versions\n  app.get(\"/api/organisation/workflows/:workflowId/versions\", async (req, res) => {\n    try {\n      const versions = await storage.getWorkflowVersionsByWorkflow(req.params.workflowId);\n      res.json(versions);\n    } catch (error) {\n      console.error(\"Error fetching workflow versions:\", error);\n      res.status(500).json({ error: \"Failed to fetch workflow versions\" });\n    }\n  });\n\n  app.get(\"/api/organisation/workflows/:workflowId/versions/latest\", async (req, res) => {\n    try {\n      const version = await storage.getLatestWorkflowVersion(req.params.workflowId);\n      if (!version) {\n        return res.status(404).json({ error: \"No versions found\" });\n      }\n      res.json(version);\n    } catch (error) {\n      console.error(\"Error fetching latest workflow version:\", error);\n      res.status(500).json({ error: \"Failed to fetch latest version\" });\n    }\n  });\n\n  app.post(\"/api/organisation/workflows/:workflowId/versions\", async (req, res) => {\n    try {\n      const validatedData = insertWorkflowVersionSchema.parse({\n        ...req.body,\n        workflowId: req.params.workflowId\n      });\n      const version = await storage.createWorkflowVersion(validatedData);\n      res.status(201).json(version);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating workflow version:\", error);\n      res.status(500).json({ error: \"Failed to create workflow version\" });\n    }\n  });\n\n  // ============ POLICIES ============\n  app.get(\"/api/organisation/policies\", async (req, res) => {\n    try {\n      const { department, category, status } = req.query;\n      let policyList;\n      if (department) {\n        policyList = await storage.getPoliciesByDepartment(department as string);\n      } else if (category) {\n        policyList = await storage.getPoliciesByCategory(category as string);\n      } else if (status === 'active') {\n        policyList = await storage.getActivePolicies();\n      } else {\n        policyList = await storage.getPolicies();\n      }\n      res.json(policyList);\n    } catch (error) {\n      console.error(\"Error fetching policies:\", error);\n      res.status(500).json({ error: \"Failed to fetch policies\" });\n    }\n  });\n\n  app.get(\"/api/organisation/policies/:id\", async (req, res) => {\n    try {\n      const policy = await storage.getPolicy(req.params.id);\n      if (!policy) {\n        return res.status(404).json({ error: \"Policy not found\" });\n      }\n      res.json(policy);\n    } catch (error) {\n      console.error(\"Error fetching policy:\", error);\n      res.status(500).json({ error: \"Failed to fetch policy\" });\n    }\n  });\n\n  app.post(\"/api/organisation/policies\", async (req, res) => {\n    try {\n      const data = { ...req.body };\n      if (data.departmentId === \"\") data.departmentId = null;\n      const validatedData = insertPolicySchema.parse(data);\n      const policy = await storage.createPolicy(validatedData);\n      res.status(201).json(policy);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating policy:\", error);\n      res.status(500).json({ error: \"Failed to create policy\" });\n    }\n  });\n\n  app.patch(\"/api/organisation/policies/:id\", async (req, res) => {\n    try {\n      const data = { ...req.body };\n      if (data.departmentId === \"\") data.departmentId = null;\n      const validatedData = insertPolicySchema.partial().parse(data);\n      const policy = await storage.updatePolicy(req.params.id, validatedData);\n      if (!policy) {\n        return res.status(404).json({ error: \"Policy not found\" });\n      }\n      res.json(policy);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error updating policy:\", error);\n      res.status(500).json({ error: \"Failed to update policy\" });\n    }\n  });\n\n  app.delete(\"/api/organisation/policies/:id\", async (req, res) => {\n    try {\n      const deleted = await storage.deletePolicy(req.params.id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"Policy not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting policy:\", error);\n      res.status(500).json({ error: \"Failed to delete policy\" });\n    }\n  });\n\n  // Policy Versions\n  app.get(\"/api/organisation/policies/:policyId/versions\", async (req, res) => {\n    try {\n      const versions = await storage.getPolicyVersionsByPolicy(req.params.policyId);\n      res.json(versions);\n    } catch (error) {\n      console.error(\"Error fetching policy versions:\", error);\n      res.status(500).json({ error: \"Failed to fetch policy versions\" });\n    }\n  });\n\n  app.get(\"/api/organisation/policies/:policyId/versions/latest\", async (req, res) => {\n    try {\n      const version = await storage.getLatestPolicyVersion(req.params.policyId);\n      if (!version) {\n        return res.status(404).json({ error: \"No versions found\" });\n      }\n      res.json(version);\n    } catch (error) {\n      console.error(\"Error fetching latest policy version:\", error);\n      res.status(500).json({ error: \"Failed to fetch latest version\" });\n    }\n  });\n\n  app.post(\"/api/organisation/policies/:policyId/versions\", async (req, res) => {\n    try {\n      const validatedData = insertPolicyVersionSchema.parse({\n        ...req.body,\n        policyId: req.params.policyId\n      });\n      const version = await storage.createPolicyVersion(validatedData);\n      res.status(201).json(version);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating policy version:\", error);\n      res.status(500).json({ error: \"Failed to create policy version\" });\n    }\n  });\n\n  // Policy Acknowledgements\n  app.get(\"/api/organisation/policies/:policyId/acknowledgements\", async (req, res) => {\n    try {\n      const acknowledgements = await storage.getPolicyAcknowledgementsByPolicy(req.params.policyId);\n      res.json(acknowledgements);\n    } catch (error) {\n      console.error(\"Error fetching acknowledgements:\", error);\n      res.status(500).json({ error: \"Failed to fetch acknowledgements\" });\n    }\n  });\n\n  app.post(\"/api/organisation/policies/:policyId/acknowledge\", async (req, res) => {\n    try {\n      const { userId, policyVersionId } = req.body;\n      if (!userId || !policyVersionId) {\n        return res.status(400).json({ error: \"userId and policyVersionId are required\" });\n      }\n      \n      const alreadyAcknowledged = await storage.hasUserAcknowledgedPolicy(userId, policyVersionId);\n      if (alreadyAcknowledged) {\n        return res.status(400).json({ error: \"Policy already acknowledged\" });\n      }\n      \n      const acknowledgement = await storage.createPolicyAcknowledgement({\n        policyId: req.params.policyId,\n        policyVersionId,\n        userId\n      });\n      res.status(201).json(acknowledgement);\n    } catch (error) {\n      console.error(\"Error creating acknowledgement:\", error);\n      res.status(500).json({ error: \"Failed to create acknowledgement\" });\n    }\n  });\n\n  app.get(\"/api/organisation/users/:userId/acknowledgements\", async (req, res) => {\n    try {\n      const acknowledgements = await storage.getPolicyAcknowledgementsByUser(req.params.userId);\n      res.json(acknowledgements);\n    } catch (error) {\n      console.error(\"Error fetching user acknowledgements:\", error);\n      res.status(500).json({ error: \"Failed to fetch user acknowledgements\" });\n    }\n  });\n\n  // ============ RESOURCES ============\n  app.get(\"/api/organisation/resources\", async (req, res) => {\n    try {\n      const { department, search } = req.query;\n      let resourceList;\n      if (search) {\n        resourceList = await storage.searchResources(search as string);\n      } else if (department) {\n        resourceList = await storage.getResourcesByDepartment(department as string);\n      } else {\n        resourceList = await storage.getResources();\n      }\n      res.json(resourceList);\n    } catch (error) {\n      console.error(\"Error fetching resources:\", error);\n      res.status(500).json({ error: \"Failed to fetch resources\" });\n    }\n  });\n\n  app.get(\"/api/organisation/resources/:id\", async (req, res) => {\n    try {\n      const resource = await storage.getResource(req.params.id);\n      if (!resource) {\n        return res.status(404).json({ error: \"Resource not found\" });\n      }\n      res.json(resource);\n    } catch (error) {\n      console.error(\"Error fetching resource:\", error);\n      res.status(500).json({ error: \"Failed to fetch resource\" });\n    }\n  });\n\n  app.post(\"/api/organisation/resources\", async (req, res) => {\n    try {\n      const data = { ...req.body };\n      if (data.departmentId === \"\") data.departmentId = null;\n      const validatedData = insertResourceSchema.parse(data);\n      const resource = await storage.createResource(validatedData);\n      res.status(201).json(resource);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating resource:\", error);\n      res.status(500).json({ error: \"Failed to create resource\" });\n    }\n  });\n\n  app.patch(\"/api/organisation/resources/:id\", async (req, res) => {\n    try {\n      const data = { ...req.body };\n      if (data.departmentId === \"\") data.departmentId = null;\n      const validatedData = insertResourceSchema.partial().parse(data);\n      const resource = await storage.updateResource(req.params.id, validatedData);\n      if (!resource) {\n        return res.status(404).json({ error: \"Resource not found\" });\n      }\n      res.json(resource);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error updating resource:\", error);\n      res.status(500).json({ error: \"Failed to update resource\" });\n    }\n  });\n\n  app.delete(\"/api/organisation/resources/:id\", async (req, res) => {\n    try {\n      const deleted = await storage.deleteResource(req.params.id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"Resource not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting resource:\", error);\n      res.status(500).json({ error: \"Failed to delete resource\" });\n    }\n  });\n\n  // ============ KNOWLEDGE ARTICLES ============\n  app.get(\"/api/organisation/knowledge\", async (req, res) => {\n    try {\n      const { department, search, published } = req.query;\n      let articleList;\n      if (search) {\n        articleList = await storage.searchKnowledgeArticles(search as string);\n      } else if (department) {\n        articleList = await storage.getKnowledgeArticlesByDepartment(department as string);\n      } else if (published === 'true') {\n        articleList = await storage.getPublishedKnowledgeArticles();\n      } else {\n        articleList = await storage.getKnowledgeArticles();\n      }\n      res.json(articleList);\n    } catch (error) {\n      console.error(\"Error fetching knowledge articles:\", error);\n      res.status(500).json({ error: \"Failed to fetch knowledge articles\" });\n    }\n  });\n\n  app.get(\"/api/organisation/knowledge/:id\", async (req, res) => {\n    try {\n      const article = await storage.getKnowledgeArticle(req.params.id);\n      if (!article) {\n        return res.status(404).json({ error: \"Article not found\" });\n      }\n      res.json(article);\n    } catch (error) {\n      console.error(\"Error fetching article:\", error);\n      res.status(500).json({ error: \"Failed to fetch article\" });\n    }\n  });\n\n  app.get(\"/api/organisation/knowledge/slug/:slug\", async (req, res) => {\n    try {\n      const article = await storage.getKnowledgeArticleBySlug(req.params.slug);\n      if (!article) {\n        return res.status(404).json({ error: \"Article not found\" });\n      }\n      res.json(article);\n    } catch (error) {\n      console.error(\"Error fetching article by slug:\", error);\n      res.status(500).json({ error: \"Failed to fetch article\" });\n    }\n  });\n\n  app.post(\"/api/organisation/knowledge\", async (req, res) => {\n    try {\n      const data = { ...req.body };\n      if (data.departmentId === \"\") data.departmentId = null;\n      const validatedData = insertKnowledgeArticleSchema.parse(data);\n      const article = await storage.createKnowledgeArticle(validatedData);\n      res.status(201).json(article);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating article:\", error);\n      res.status(500).json({ error: \"Failed to create article\" });\n    }\n  });\n\n  app.patch(\"/api/organisation/knowledge/:id\", async (req, res) => {\n    try {\n      const data = { ...req.body };\n      if (data.departmentId === \"\") data.departmentId = null;\n      const validatedData = insertKnowledgeArticleSchema.partial().parse(data);\n      const article = await storage.updateKnowledgeArticle(req.params.id, validatedData);\n      if (!article) {\n        return res.status(404).json({ error: \"Article not found\" });\n      }\n      res.json(article);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error updating article:\", error);\n      res.status(500).json({ error: \"Failed to update article\" });\n    }\n  });\n\n  app.delete(\"/api/organisation/knowledge/:id\", async (req, res) => {\n    try {\n      const deleted = await storage.deleteKnowledgeArticle(req.params.id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"Article not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting article:\", error);\n      res.status(500).json({ error: \"Failed to delete article\" });\n    }\n  });\n\n  // ============ LIVE DOCUMENT TEMPLATES ============\n\n  // Get all templates\n  app.get(\"/api/live-doc-templates\", async (req, res) => {\n    try {\n      const { active } = req.query;\n      let templates;\n      if (active === \"true\") {\n        templates = await storage.getActiveLiveDocumentTemplates();\n      } else {\n        templates = await storage.getLiveDocumentTemplates();\n      }\n      res.json(templates);\n    } catch (error) {\n      console.error(\"Error fetching live document templates:\", error);\n      res.status(500).json({ error: \"Failed to fetch templates\" });\n    }\n  });\n\n  // Get default template\n  app.get(\"/api/live-doc-templates/default\", async (req, res) => {\n    try {\n      const template = await storage.getDefaultLiveDocumentTemplate();\n      if (!template) {\n        return res.status(404).json({ error: \"No default template found\" });\n      }\n      res.json(template);\n    } catch (error) {\n      console.error(\"Error fetching default template:\", error);\n      res.status(500).json({ error: \"Failed to fetch default template\" });\n    }\n  });\n\n  // Get a specific template by ID\n  app.get(\"/api/live-doc-templates/:id\", async (req, res) => {\n    try {\n      const template = await storage.getLiveDocumentTemplate(req.params.id);\n      if (!template) {\n        return res.status(404).json({ error: \"Template not found\" });\n      }\n      res.json(template);\n    } catch (error) {\n      console.error(\"Error fetching template:\", error);\n      res.status(500).json({ error: \"Failed to fetch template\" });\n    }\n  });\n\n  // Create a new template\n  app.post(\"/api/live-doc-templates\", async (req, res) => {\n    try {\n      const validatedData = insertLiveDocumentTemplateSchema.parse(req.body);\n      const template = await storage.createLiveDocumentTemplate(validatedData);\n      res.status(201).json(template);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating template:\", error);\n      res.status(500).json({ error: \"Failed to create template\" });\n    }\n  });\n\n  // Update a template\n  app.patch(\"/api/live-doc-templates/:id\", async (req, res) => {\n    try {\n      const validatedData = insertLiveDocumentTemplateSchema.partial().parse(req.body);\n      const template = await storage.updateLiveDocumentTemplate(req.params.id, validatedData);\n      if (!template) {\n        return res.status(404).json({ error: \"Template not found\" });\n      }\n      res.json(template);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error updating template:\", error);\n      res.status(500).json({ error: \"Failed to update template\" });\n    }\n  });\n\n  // Delete a template\n  app.delete(\"/api/live-doc-templates/:id\", async (req, res) => {\n    try {\n      const deleted = await storage.deleteLiveDocumentTemplate(req.params.id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"Template not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting template:\", error);\n      res.status(500).json({ error: \"Failed to delete template\" });\n    }\n  });\n\n  // ============ JOB SETUP DOCUMENTS ============\n\n  // Get all job setup documents\n  app.get(\"/api/job-setup-documents\", async (req, res) => {\n    try {\n      const { status } = req.query;\n      let documents;\n      if (status && typeof status === \"string\") {\n        documents = await storage.getJobSetupDocumentsByStatus(status);\n      } else {\n        documents = await storage.getJobSetupDocuments();\n      }\n      res.json(documents);\n    } catch (error) {\n      console.error(\"Error fetching job setup documents:\", error);\n      res.status(500).json({ error: \"Failed to fetch job setup documents\" });\n    }\n  });\n\n  // Get a specific job setup document by ID\n  app.get(\"/api/job-setup-documents/:id\", async (req, res) => {\n    try {\n      const document = await storage.getJobSetupDocument(req.params.id);\n      if (!document) {\n        return res.status(404).json({ error: \"Job setup document not found\" });\n      }\n      res.json(document);\n    } catch (error) {\n      console.error(\"Error fetching job setup document:\", error);\n      res.status(500).json({ error: \"Failed to fetch job setup document\" });\n    }\n  });\n\n  // Get job setup document by job ID (auto-creates for supply_install jobs if not exists)\n  app.get(\"/api/jobs/:jobId/setup-document\", requireRoles(\"admin\", \"sales\", \"scheduler\", \"production_manager\"), async (req, res) => {\n    try {\n      let document = await storage.getJobSetupDocumentByJob(req.params.jobId);\n      \n      // If no document exists, auto-create one for supply_install jobs\n      if (!document) {\n        const job = await storage.getJob(req.params.jobId);\n        if (!job) {\n          return res.status(404).json({ error: \"Job not found\" });\n        }\n        \n        if (job.jobType === \"supply_install\") {\n          // Auto-create the setup document\n          document = await storage.createJobSetupDocument({\n            jobId: job.id,\n            quoteId: job.quoteId,\n            jobType: job.jobType,\n            status: \"in_progress\",\n            section1Sales: {},\n            section2ProductsMeta: { autoPopulatedFromQuote: false },\n            section3Production: {},\n            section4Schedule: {},\n            section5Install: {},\n            section1Complete: false,\n            section2Complete: false,\n            section3Complete: false,\n            section4Complete: false,\n            section5Complete: false,\n          } as any);\n          \n          // If there's a quote, seed products from it\n          if (job.quoteId) {\n            await storage.seedJobSetupProductsFromQuote(document.id, job.quoteId);\n            // Update meta to indicate auto-population\n            document = await storage.updateJobSetupDocument(document.id, {\n              section2ProductsMeta: { autoPopulatedFromQuote: true }\n            });\n          }\n        } else {\n          return res.status(404).json({ error: \"Job setup document not found\" });\n        }\n      }\n      \n      // Also fetch the products for this document\n      const products = await storage.getJobSetupProductsByDocument(document!.id);\n      res.json({ ...document, products });\n    } catch (error) {\n      console.error(\"Error fetching job setup document:\", error);\n      res.status(500).json({ error: \"Failed to fetch job setup document\" });\n    }\n  });\n\n  // Get live document by lead ID (auto-creates for supply_install leads if not exists)\n  app.get(\"/api/leads/:leadId/live-document\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      let document = await storage.getJobSetupDocumentByLead(req.params.leadId);\n      \n      // If no document exists, auto-create one for supply_install leads\n      if (!document) {\n        const lead = await storage.getLead(req.params.leadId);\n        if (!lead) {\n          return res.status(404).json({ error: \"Lead not found\" });\n        }\n        \n        if (lead.jobFulfillmentType === \"supply_install\") {\n          // Get the default template to use for section configurations\n          const defaultTemplate = await storage.getDefaultLiveDocumentTemplate();\n          \n          // Auto-create the live document linked to the lead\n          document = await storage.createJobSetupDocument({\n            leadId: lead.id,\n            templateId: defaultTemplate?.id,\n            jobType: lead.jobFulfillmentType,\n            status: \"in_progress\",\n            section1Sales: {},\n            section2ProductsMeta: { autoPopulatedFromQuote: false },\n            section3Production: {},\n            section4Schedule: {},\n            section5Install: {},\n            section1Complete: false,\n            section2Complete: false,\n            section3Complete: false,\n            section4Complete: false,\n            section5Complete: false,\n          } as any);\n        } else {\n          return res.status(400).json({ error: \"Live documents are only available for supply+install leads\" });\n        }\n      }\n      \n      // Also fetch the products for this document\n      const products = await storage.getJobSetupProductsByDocument(document!.id);\n      res.json({ ...document, products });\n    } catch (error) {\n      console.error(\"Error fetching lead live document:\", error);\n      res.status(500).json({ error: \"Failed to fetch lead live document\" });\n    }\n  });\n\n  // Create a new job setup document\n  app.post(\"/api/job-setup-documents\", async (req, res) => {\n    try {\n      const validatedData = insertJobSetupDocumentSchema.parse(req.body);\n      const document = await storage.createJobSetupDocument(validatedData);\n      res.status(201).json(document);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating job setup document:\", error);\n      res.status(500).json({ error: \"Failed to create job setup document\" });\n    }\n  });\n\n  // Update a job setup document\n  app.patch(\"/api/job-setup-documents/:id\", async (req, res) => {\n    try {\n      const validatedData = insertJobSetupDocumentSchema.partial().parse(req.body);\n      const document = await storage.updateJobSetupDocument(req.params.id, validatedData);\n      if (!document) {\n        return res.status(404).json({ error: \"Job setup document not found\" });\n      }\n      res.json(document);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error updating job setup document:\", error);\n      res.status(500).json({ error: \"Failed to update job setup document\" });\n    }\n  });\n\n  // Delete a job setup document\n  app.delete(\"/api/job-setup-documents/:id\", async (req, res) => {\n    try {\n      const deleted = await storage.deleteJobSetupDocument(req.params.id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"Job setup document not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting job setup document:\", error);\n      res.status(500).json({ error: \"Failed to delete job setup document\" });\n    }\n  });\n\n  // ============ JOB SETUP SECTIONS ============\n\n  // Update Section 1 (Sales Info)\n  app.patch(\"/api/job-setup-documents/:id/section1\", async (req, res) => {\n    try {\n      const validatedData = section1SalesSchema.parse(req.body);\n      const document = await storage.updateJobSetupSection1(req.params.id, validatedData);\n      if (!document) {\n        return res.status(404).json({ error: \"Job setup document not found\" });\n      }\n      res.json(document);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error updating section 1:\", error);\n      res.status(500).json({ error: \"Failed to update section 1\" });\n    }\n  });\n\n  // Update Section 2 Meta (Products metadata)\n  app.patch(\"/api/job-setup-documents/:id/section2-meta\", async (req, res) => {\n    try {\n      const validatedData = section2ProductsMetaSchema.parse(req.body);\n      const document = await storage.updateJobSetupSection2Meta(req.params.id, validatedData);\n      if (!document) {\n        return res.status(404).json({ error: \"Job setup document not found\" });\n      }\n      res.json(document);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error updating section 2 meta:\", error);\n      res.status(500).json({ error: \"Failed to update section 2 meta\" });\n    }\n  });\n\n  // Update Section 3 (Production)\n  app.patch(\"/api/job-setup-documents/:id/section3\", async (req, res) => {\n    try {\n      const validatedData = section3ProductionSchema.parse(req.body);\n      const document = await storage.updateJobSetupSection3(req.params.id, validatedData);\n      if (!document) {\n        return res.status(404).json({ error: \"Job setup document not found\" });\n      }\n      res.json(document);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error updating section 3:\", error);\n      res.status(500).json({ error: \"Failed to update section 3\" });\n    }\n  });\n\n  // Update Section 4 (Schedule)\n  app.patch(\"/api/job-setup-documents/:id/section4\", async (req, res) => {\n    try {\n      const validatedData = section4ScheduleSchema.parse(req.body);\n      const document = await storage.updateJobSetupSection4(req.params.id, validatedData);\n      if (!document) {\n        return res.status(404).json({ error: \"Job setup document not found\" });\n      }\n      res.json(document);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error updating section 4:\", error);\n      res.status(500).json({ error: \"Failed to update section 4\" });\n    }\n  });\n\n  // Update Section 5 (Install Notes)\n  app.patch(\"/api/job-setup-documents/:id/section5\", async (req, res) => {\n    try {\n      const validatedData = section5InstallSchema.parse(req.body);\n      const document = await storage.updateJobSetupSection5(req.params.id, validatedData);\n      if (!document) {\n        return res.status(404).json({ error: \"Job setup document not found\" });\n      }\n      res.json(document);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error updating section 5:\", error);\n      res.status(500).json({ error: \"Failed to update section 5\" });\n    }\n  });\n\n  // Mark section as complete/incomplete\n  app.post(\"/api/job-setup-documents/:id/section/:sectionNumber/complete\", async (req, res) => {\n    try {\n      const sectionNumber = parseInt(req.params.sectionNumber);\n      if (sectionNumber < 1 || sectionNumber > 5) {\n        return res.status(400).json({ error: \"Invalid section number. Must be 1-5\" });\n      }\n      const { complete } = req.body;\n      if (typeof complete !== \"boolean\") {\n        return res.status(400).json({ error: \"complete field must be a boolean\" });\n      }\n      const document = await storage.markSectionComplete(req.params.id, sectionNumber as 1 | 2 | 3 | 4 | 5, complete);\n      if (!document) {\n        return res.status(404).json({ error: \"Job setup document not found\" });\n      }\n      res.json(document);\n    } catch (error) {\n      console.error(\"Error marking section complete:\", error);\n      res.status(500).json({ error: \"Failed to mark section complete\" });\n    }\n  });\n\n  // Recalculate document status\n  app.post(\"/api/job-setup-documents/:id/recalculate-status\", async (req, res) => {\n    try {\n      const document = await storage.recalculateDocumentStatus(req.params.id);\n      if (!document) {\n        return res.status(404).json({ error: \"Job setup document not found\" });\n      }\n      res.json(document);\n    } catch (error) {\n      console.error(\"Error recalculating status:\", error);\n      res.status(500).json({ error: \"Failed to recalculate status\" });\n    }\n  });\n\n  // ============ JOB SETUP PRODUCTS ============\n\n  // Get products for a document\n  app.get(\"/api/job-setup-documents/:id/products\", async (req, res) => {\n    try {\n      const products = await storage.getJobSetupProductsByDocument(req.params.id);\n      res.json(products);\n    } catch (error) {\n      console.error(\"Error fetching job setup products:\", error);\n      res.status(500).json({ error: \"Failed to fetch job setup products\" });\n    }\n  });\n\n  // Add a product to a document\n  app.post(\"/api/job-setup-documents/:documentId/products\", async (req, res) => {\n    try {\n      const data = { ...req.body, jobSetupDocumentId: req.params.documentId };\n      // Convert empty strings to null for optional FK fields\n      if (data.productId === \"\") data.productId = null;\n      if (data.addedBy === \"\") data.addedBy = null;\n      if (data.sourceQuoteLineId === \"\") data.sourceQuoteLineId = null;\n      const validatedData = insertJobSetupProductSchema.parse(data);\n      const product = await storage.createJobSetupProduct(validatedData);\n      res.status(201).json(product);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error creating job setup product:\", error);\n      res.status(500).json({ error: \"Failed to create job setup product\" });\n    }\n  });\n\n  // Update a product\n  app.patch(\"/api/job-setup-products/:id\", async (req, res) => {\n    try {\n      const data = { ...req.body };\n      // Convert empty strings to null for optional FK fields\n      if (data.productId === \"\") data.productId = null;\n      if (data.addedBy === \"\") data.addedBy = null;\n      if (data.sourceQuoteLineId === \"\") data.sourceQuoteLineId = null;\n      const validatedData = insertJobSetupProductSchema.partial().parse(data);\n      const product = await storage.updateJobSetupProduct(req.params.id, validatedData);\n      if (!product) {\n        return res.status(404).json({ error: \"Job setup product not found\" });\n      }\n      res.json(product);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: error.errors });\n      }\n      console.error(\"Error updating job setup product:\", error);\n      res.status(500).json({ error: \"Failed to update job setup product\" });\n    }\n  });\n\n  // Delete a product\n  app.delete(\"/api/job-setup-products/:id\", async (req, res) => {\n    try {\n      const deleted = await storage.deleteJobSetupProduct(req.params.id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"Job setup product not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting job setup product:\", error);\n      res.status(500).json({ error: \"Failed to delete job setup product\" });\n    }\n  });\n\n  // Seed products from quote\n  app.post(\"/api/job-setup-documents/:id/seed-from-quote\", async (req, res) => {\n    try {\n      const { quoteId } = req.body;\n      if (!quoteId) {\n        return res.status(400).json({ error: \"quoteId is required\" });\n      }\n      const products = await storage.seedJobSetupProductsFromQuote(req.params.id, quoteId);\n      res.json({ products, count: products.length });\n    } catch (error) {\n      console.error(\"Error seeding products from quote:\", error);\n      res.status(500).json({ error: \"Failed to seed products from quote\" });\n    }\n  });\n\n  // Validate if job can transition to a new status (based on setup document completion)\n  app.get(\"/api/jobs/:jobId/validate-status-change\", requireRoles(\"admin\", \"sales\", \"scheduler\", \"production_manager\"), async (req, res) => {\n    try {\n      const { newStatus } = req.query;\n      if (!newStatus || typeof newStatus !== \"string\") {\n        return res.status(400).json({ error: \"newStatus query parameter is required\" });\n      }\n\n      const job = await storage.getJob(req.params.jobId);\n      if (!job) {\n        return res.status(404).json({ error: \"Job not found\" });\n      }\n\n      // Only supply+install jobs require setup document validation\n      if (job.jobType === \"supply_only\") {\n        return res.json({ valid: true, message: \"Supply only job - no validation required\" });\n      }\n\n      const document = await storage.getJobSetupDocumentByJob(req.params.jobId);\n      if (!document) {\n        // If transitioning to any status beyond 'pending', need document\n        const blockedStatuses = [\"awaiting_deposit\", \"in_production\", \"ready_for_install\", \"scheduled\", \"installing\", \"completed\"];\n        if (blockedStatuses.includes(newStatus)) {\n          return res.json({ \n            valid: false, \n            message: \"Job setup document must be created before changing status\",\n            requiredSections: []\n          });\n        }\n        return res.json({ valid: true, message: \"Status change allowed\" });\n      }\n\n      // Define required sections for each status transition\n      const statusRequirements: Record<string, { sections: number[]; message: string }> = {\n        \"in_production\": { \n          sections: [1, 2], \n          message: \"Section 1 (Sales Info) and Section 2 (Products) must be completed before production\" \n        },\n        \"ready_for_install\": { \n          sections: [1, 2, 3, 4], \n          message: \"Sections 1-4 must be completed before marking ready for install\" \n        },\n        \"scheduled\": { \n          sections: [1, 2, 3, 4], \n          message: \"Sections 1-4 must be completed before scheduling\" \n        },\n        \"installing\": { \n          sections: [1, 2, 3, 4], \n          message: \"Sections 1-4 must be completed before install can begin\" \n        },\n        \"completed\": { \n          sections: [1, 2, 3, 4, 5], \n          message: \"All sections must be completed before marking job complete\" \n        },\n      };\n\n      const requirements = statusRequirements[newStatus];\n      if (!requirements) {\n        return res.json({ valid: true, message: \"Status change allowed\" });\n      }\n\n      // Check which sections are not complete\n      const incompleteSections: number[] = [];\n      if (requirements.sections.includes(1) && !document.section1Complete) incompleteSections.push(1);\n      if (requirements.sections.includes(2) && !document.section2Complete) incompleteSections.push(2);\n      if (requirements.sections.includes(3) && !document.section3Complete) incompleteSections.push(3);\n      if (requirements.sections.includes(4) && !document.section4Complete) incompleteSections.push(4);\n      if (requirements.sections.includes(5) && !document.section5Complete) incompleteSections.push(5);\n\n      if (incompleteSections.length > 0) {\n        return res.json({ \n          valid: false, \n          message: requirements.message,\n          requiredSections: requirements.sections,\n          incompleteSections\n        });\n      }\n\n      return res.json({ valid: true, message: \"Status change allowed\" });\n    } catch (error) {\n      console.error(\"Error validating status change:\", error);\n      res.status(500).json({ error: \"Failed to validate status change\" });\n    }\n  });\n\n  // ============ IMPORT DATA ============\n  \n  // Import clients\n  app.post(\"/api/import/clients\", async (req, res) => {\n    try {\n      const { data } = req.body;\n      if (!Array.isArray(data)) {\n        return res.status(400).json({ error: \"Data must be an array\" });\n      }\n\n      let success = 0;\n      let failed = 0;\n      const errors: string[] = [];\n\n      for (const row of data) {\n        try {\n          const clientData = {\n            name: row.name?.trim() || \"\",\n            email: row.email?.trim() || null,\n            phone: row.phone?.trim() || null,\n            address: row.address?.trim() || null,\n            clientType: (row.clientType === \"trade\" ? \"trade\" : \"public\") as \"public\" | \"trade\",\n            companyName: row.companyName?.trim() || null,\n            abn: row.abn?.trim() || null,\n          };\n\n          if (!clientData.name) {\n            errors.push(`Row missing name`);\n            failed++;\n            continue;\n          }\n\n          await storage.createClient(clientData);\n          success++;\n        } catch (err) {\n          failed++;\n          errors.push(`Failed to import client: ${row.name || 'unknown'}`);\n        }\n      }\n\n      res.json({ success, failed, errors });\n    } catch (error) {\n      console.error(\"Error importing clients:\", error);\n      res.status(500).json({ error: \"Failed to import clients\" });\n    }\n  });\n\n  // Import leads (creates client if doesn't exist)\n  app.post(\"/api/import/leads\", async (req, res) => {\n    try {\n      const { data } = req.body;\n      if (!Array.isArray(data)) {\n        return res.status(400).json({ error: \"Data must be an array\" });\n      }\n\n      let success = 0;\n      let failed = 0;\n      const errors: string[] = [];\n\n      for (const row of data) {\n        try {\n          const clientName = row.clientName?.trim();\n          const siteAddress = row.siteAddress?.trim();\n\n          if (!clientName || !siteAddress) {\n            errors.push(`Row missing clientName or siteAddress`);\n            failed++;\n            continue;\n          }\n\n          // Find or create client\n          let client = await storage.getClientByEmail(row.clientEmail?.trim());\n          if (!client && row.clientPhone?.trim()) {\n            const clients = await storage.getClients();\n            client = clients.find(c => c.phone === row.clientPhone?.trim()) || null;\n          }\n\n          if (!client) {\n            const clientData = {\n              name: clientName,\n              email: row.clientEmail?.trim() || null,\n              phone: row.clientPhone?.trim() || null,\n              address: null,\n              clientType: (row.leadType === \"trade\" ? \"trade\" : \"public\") as \"public\" | \"trade\",\n              companyName: null,\n              abn: null,\n            };\n            client = await storage.createClient(clientData);\n          }\n\n          // Parse source value\n          const validSources = [\"website\", \"phone\", \"referral\", \"trade_account\", \"walk_in\", \"other\"];\n          const source = validSources.includes(row.source?.toLowerCase()) \n            ? row.source.toLowerCase() \n            : \"other\";\n\n          // Parse leadType\n          const leadType = row.leadType === \"trade\" ? \"trade\" : \"public\";\n\n          // Parse jobFulfillmentType\n          const validFulfillment = [\"supply_install\", \"supply_only\"];\n          const jobFulfillmentType = validFulfillment.includes(row.jobFulfillmentType?.toLowerCase())\n            ? row.jobFulfillmentType.toLowerCase()\n            : \"supply_install\";\n\n          const leadData = {\n            clientId: client.id,\n            source: source as any,\n            leadType: leadType as any,\n            jobFulfillmentType: jobFulfillmentType as any,\n            description: row.description?.trim() || null,\n            siteAddress,\n            measurementsProvided: false,\n            fenceLength: row.fenceLength?.trim() || null,\n            fenceStyle: row.fenceStyle?.trim() || null,\n            stage: \"new\" as const,\n            assignedTo: null,\n            followUpDate: null,\n            notes: null,\n          };\n\n          await storage.createLead(leadData);\n          success++;\n        } catch (err) {\n          failed++;\n          errors.push(`Failed to import lead for: ${row.clientName || 'unknown'}`);\n        }\n      }\n\n      res.json({ success, failed, errors });\n    } catch (error) {\n      console.error(\"Error importing leads:\", error);\n      res.status(500).json({ error: \"Failed to import leads\" });\n    }\n  });\n\n  // Import jobs (creates client and lead if doesn't exist)\n  app.post(\"/api/import/jobs\", async (req, res) => {\n    try {\n      const { data } = req.body;\n      if (!Array.isArray(data)) {\n        return res.status(400).json({ error: \"Data must be an array\" });\n      }\n\n      let success = 0;\n      let failed = 0;\n      const errors: string[] = [];\n\n      for (const row of data) {\n        try {\n          const clientName = row.clientName?.trim();\n          const siteAddress = row.siteAddress?.trim();\n\n          if (!clientName || !siteAddress) {\n            errors.push(`Row missing clientName or siteAddress`);\n            failed++;\n            continue;\n          }\n\n          // Find or create client\n          let client = await storage.getClientByEmail(row.clientEmail?.trim());\n          if (!client && row.clientPhone?.trim()) {\n            const clients = await storage.getClients();\n            client = clients.find(c => c.phone === row.clientPhone?.trim()) || null;\n          }\n\n          if (!client) {\n            const clientData = {\n              name: clientName,\n              email: row.clientEmail?.trim() || null,\n              phone: row.clientPhone?.trim() || null,\n              address: siteAddress,\n              clientType: \"public\" as const,\n              companyName: null,\n              abn: null,\n            };\n            client = await storage.createClient(clientData);\n          }\n\n          // Parse job type\n          const validJobTypes = [\"supply_install\", \"supply_only\"];\n          const jobType = validJobTypes.includes(row.jobType?.toLowerCase())\n            ? row.jobType.toLowerCase()\n            : \"supply_install\";\n\n          // Parse job status  \n          const validStatuses = [\"pending\", \"awaiting_deposit\", \"in_production\", \"ready_for_install\", \"scheduled\", \"installing\", \"completed\", \"on_hold\", \"cancelled\"];\n          const status = validStatuses.includes(row.status?.toLowerCase())\n            ? row.status.toLowerCase()\n            : \"pending\";\n\n          // Create a lead for the job\n          const leadData = {\n            clientId: client.id,\n            source: \"other\" as const,\n            leadType: \"public\" as const,\n            jobFulfillmentType: jobType as any,\n            description: row.notes?.trim() || \"Imported job\",\n            siteAddress,\n            measurementsProvided: !!row.fenceLength,\n            fenceLength: row.fenceLength?.trim() || null,\n            fenceStyle: row.fenceStyle?.trim() || null,\n            stage: \"won\" as const,\n            assignedTo: null,\n            followUpDate: null,\n            notes: null,\n          };\n\n          const lead = await storage.createLead(leadData);\n\n          // Create the job\n          const jobData = {\n            leadId: lead.id,\n            clientId: client.id,\n            jobType: jobType as any,\n            siteAddress,\n            fenceLength: row.fenceLength?.trim() || null,\n            fenceStyle: row.fenceStyle?.trim() || null,\n            status: status as any,\n            assignedTeam: null,\n            scheduledDate: null,\n            notes: row.notes?.trim() || null,\n            depositPaid: false,\n            depositAmount: null,\n            totalAmount: null,\n          };\n\n          await storage.createJob(jobData);\n          success++;\n        } catch (err) {\n          failed++;\n          errors.push(`Failed to import job for: ${row.clientName || 'unknown'}`);\n        }\n      }\n\n      res.json({ success, failed, errors });\n    } catch (error) {\n      console.error(\"Error importing jobs:\", error);\n      res.status(500).json({ error: \"Failed to import jobs\" });\n    }\n  });\n\n  // ============================================\n  // DASHBOARD BUILDER ROUTES\n  // ============================================\n\n  // Get all available widgets\n  app.get(\"/api/dashboard-builder/widgets\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const widgets = await storage.getActiveWidgets();\n      res.json(widgets);\n    } catch (error) {\n      console.error(\"Error fetching widgets:\", error);\n      res.status(500).json({ error: \"Failed to fetch widgets\" });\n    }\n  });\n\n  // Get widgets by category\n  app.get(\"/api/dashboard-builder/widgets/category/:category\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const widgets = await storage.getDashboardWidgetsByCategory(req.params.category);\n      res.json(widgets);\n    } catch (error) {\n      console.error(\"Error fetching widgets by category:\", error);\n      res.status(500).json({ error: \"Failed to fetch widgets\" });\n    }\n  });\n\n  // Get all dashboard layouts\n  app.get(\"/api/dashboard-builder/layouts\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const layouts = await storage.getRoleDashboardLayouts();\n      res.json(layouts);\n    } catch (error) {\n      console.error(\"Error fetching layouts:\", error);\n      res.status(500).json({ error: \"Failed to fetch layouts\" });\n    }\n  });\n\n  // Get layouts for a specific role\n  app.get(\"/api/dashboard-builder/layouts/role/:role\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const layouts = await storage.getRoleDashboardLayoutsByRole(req.params.role);\n      res.json(layouts);\n    } catch (error) {\n      console.error(\"Error fetching layouts by role:\", error);\n      res.status(500).json({ error: \"Failed to fetch layouts\" });\n    }\n  });\n\n  // Get a specific layout with its widget instances\n  app.get(\"/api/dashboard-builder/layouts/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const layout = await storage.getRoleDashboardLayout(req.params.id);\n      if (!layout) {\n        return res.status(404).json({ error: \"Layout not found\" });\n      }\n      const instances = await storage.getDashboardWidgetInstancesByLayout(req.params.id);\n      const widgets = await storage.getDashboardWidgets();\n      \n      // Enrich instances with widget details\n      const enrichedInstances = instances.map(instance => {\n        const widget = widgets.find(w => w.id === instance.widgetId);\n        return { ...instance, widget };\n      });\n      \n      res.json({ ...layout, instances: enrichedInstances });\n    } catch (error) {\n      console.error(\"Error fetching layout:\", error);\n      res.status(500).json({ error: \"Failed to fetch layout\" });\n    }\n  });\n\n  // Create a new layout\n  app.post(\"/api/dashboard-builder/layouts\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const layout = await storage.createRoleDashboardLayout({\n        ...req.body,\n        createdBy: req.user?.id,\n        updatedBy: req.user?.id,\n      });\n      res.status(201).json(layout);\n    } catch (error) {\n      console.error(\"Error creating layout:\", error);\n      res.status(500).json({ error: \"Failed to create layout\" });\n    }\n  });\n\n  // Update a layout\n  app.patch(\"/api/dashboard-builder/layouts/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const layout = await storage.updateRoleDashboardLayout(req.params.id, {\n        ...req.body,\n        updatedBy: req.user?.id,\n      });\n      if (!layout) {\n        return res.status(404).json({ error: \"Layout not found\" });\n      }\n      res.json(layout);\n    } catch (error) {\n      console.error(\"Error updating layout:\", error);\n      res.status(500).json({ error: \"Failed to update layout\" });\n    }\n  });\n\n  // Delete a layout\n  app.delete(\"/api/dashboard-builder/layouts/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const deleted = await storage.deleteRoleDashboardLayout(req.params.id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"Layout not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting layout:\", error);\n      res.status(500).json({ error: \"Failed to delete layout\" });\n    }\n  });\n\n  // Publish a layout (make it the active default for the role)\n  app.post(\"/api/dashboard-builder/layouts/:id/publish\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const layout = await storage.publishRoleDashboardLayout(req.params.id);\n      if (!layout) {\n        return res.status(404).json({ error: \"Layout not found\" });\n      }\n      res.json(layout);\n    } catch (error) {\n      console.error(\"Error publishing layout:\", error);\n      res.status(500).json({ error: \"Failed to publish layout\" });\n    }\n  });\n\n  // Save all widget instances for a layout (bulk update)\n  app.put(\"/api/dashboard-builder/layouts/:id/instances\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { instances } = req.body;\n      if (!Array.isArray(instances)) {\n        return res.status(400).json({ error: \"instances must be an array\" });\n      }\n      const savedInstances = await storage.saveDashboardLayout(req.params.id, instances);\n      res.json(savedInstances);\n    } catch (error) {\n      console.error(\"Error saving layout instances:\", error);\n      res.status(500).json({ error: \"Failed to save layout\" });\n    }\n  });\n\n  // Add a widget instance to a layout\n  app.post(\"/api/dashboard-builder/layouts/:id/instances\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const instance = await storage.createDashboardWidgetInstance({\n        ...req.body,\n        layoutId: req.params.id,\n      });\n      res.status(201).json(instance);\n    } catch (error) {\n      console.error(\"Error adding widget instance:\", error);\n      res.status(500).json({ error: \"Failed to add widget\" });\n    }\n  });\n\n  // Update a widget instance\n  app.patch(\"/api/dashboard-builder/instances/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const instance = await storage.updateDashboardWidgetInstance(req.params.id, req.body);\n      if (!instance) {\n        return res.status(404).json({ error: \"Widget instance not found\" });\n      }\n      res.json(instance);\n    } catch (error) {\n      console.error(\"Error updating widget instance:\", error);\n      res.status(500).json({ error: \"Failed to update widget\" });\n    }\n  });\n\n  // Delete a widget instance\n  app.delete(\"/api/dashboard-builder/instances/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const deleted = await storage.deleteDashboardWidgetInstance(req.params.id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"Widget instance not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting widget instance:\", error);\n      res.status(500).json({ error: \"Failed to delete widget\" });\n    }\n  });\n\n  // Get the published dashboard for a user's role (used by MyDashboard)\n  app.get(\"/api/dashboard/my-layout\", async (req, res) => {\n    try {\n      if (!req.session?.user) {\n        return res.status(401).json({ error: \"Not authenticated\" });\n      }\n      \n      const role = req.session.user.role;\n      const layout = await storage.getPublishedLayoutForRole(role);\n      \n      if (!layout) {\n        // Return null to indicate no custom layout - use default dashboard\n        return res.json(null);\n      }\n      \n      const instances = await storage.getDashboardWidgetInstancesByLayout(layout.id);\n      const widgets = await storage.getDashboardWidgets();\n      \n      // Enrich instances with widget details\n      const enrichedInstances = instances.map(instance => {\n        const widget = widgets.find(w => w.id === instance.widgetId);\n        return { ...instance, widget };\n      });\n      \n      res.json({ ...layout, instances: enrichedInstances });\n    } catch (error) {\n      console.error(\"Error fetching user dashboard:\", error);\n      res.status(500).json({ error: \"Failed to fetch dashboard\" });\n    }\n  });\n\n  // ============ FINANCIAL / BANKING (Basiq CDR Open Banking Integration) ============\n  // IMPORTANT: This uses ONLY the CDR consent flow - NO login credentials are ever collected\n  \n  // Create CDR consent and get Connect URL - initiates the Open Banking flow\n  app.post(\"/api/financial/connect-bank\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { businessName, businessIdNo, businessIdNoType, businessAddress, organisationType, sharingDuration, email } = req.body;\n      \n      if (!businessName || !businessIdNo || !businessIdNoType || !businessAddress || !organisationType || !sharingDuration || !email) {\n        return res.status(400).json({ error: \"businessName, businessIdNo, businessIdNoType, businessAddress, organisationType, sharingDuration, and email are all required\" });\n      }\n      \n      const { BasiqService } = await import(\"./services/basiq\");\n      const basiq = new BasiqService();\n      \n      // Create Basiq user and get Consent UI URL\n      const { userId, connectUrl } = await basiq.createCDRConsent(businessName, businessIdNo, businessIdNoType, businessAddress, organisationType, sharingDuration, email);\n      \n      // Store the pending connection with Basiq user ID\n      const connection = await storage.createBankConnection({\n        ownerUserId: req.session?.user?.id || null,\n        basiqConsentId: null, // Will be set after consent is completed\n        basiqUserId: userId,\n        basiqConnectionId: null,\n        institutionId: null,\n        institutionName: null,\n        status: \"pending_consent\",\n        refreshJobId: null,\n        metadata: { \n          createdAt: new Date().toISOString(),\n          businessName,\n          businessIdNo\n        }\n      });\n\n      res.status(201).json({ \n        connectionId: connection.id,\n        basiqUserId: userId,\n        connectUrl,\n        message: \"Redirect user to connectUrl to complete bank authorization in Basiq Consent UI\" \n      });\n    } catch (error: any) {\n      console.error(\"Error creating CDR consent:\", error);\n      res.status(500).json({ error: error.message || \"Failed to create consent\" });\n    }\n  });\n\n  // Basiq callback endpoint - handles redirect after user completes consent on Westpac\n  app.get(\"/api/financial/callback\", async (req, res) => {\n    try {\n      const { consentId, error, connectionId } = req.query;\n      \n      if (error) {\n        console.error(\"Basiq callback error:\", error);\n        return res.redirect(`/financial?error=${encodeURIComponent(error as string)}`);\n      }\n\n      if (consentId) {\n        console.log(\"Consent callback received, consentId:\", consentId);\n        \n        // Find the connection with this consent ID and activate it\n        const { BasiqService } = await import(\"./services/basiq\");\n        const basiq = new BasiqService();\n        \n        // Verify consent is active\n        const consent = await basiq.getConsent(consentId as string);\n        console.log(\"Consent status:\", consent);\n        \n        if (consent.status === \"active\") {\n          // Find connection by consent ID and update it\n          const connections = await storage.getBankConnections();\n          const connection = connections.find(c => c.basiqConsentId === consentId);\n          \n          if (connection) {\n            // Fetch accounts from the consent\n            const accounts = await basiq.getAccountsByConsent(consentId as string);\n            console.log(\"Fetched accounts:\", accounts.length);\n            \n            // Get institution info from first account\n            const firstAccount = accounts[0];\n            const institutionName = firstAccount?.institution?.shortName || firstAccount?.institution?.name || \"Unknown Bank\";\n            const institutionId = firstAccount?.institution?.id;\n            \n            // Update connection to active\n            await storage.updateBankConnection(connection.id, {\n              status: \"active\",\n              institutionId,\n              institutionName,\n              lastSyncedAt: new Date(),\n              consentExpiresAt: consent.expiresAt ? new Date(consent.expiresAt) : null\n            });\n            \n            // Sync accounts to database\n            await basiq.syncAccountsToDatabase(connection.id);\n          }\n        }\n        \n        return res.redirect(`/financial?success=true&consentId=${consentId}`);\n      }\n      \n      // Fallback redirect\n      res.redirect(\"/financial?success=true\");\n    } catch (error) {\n      console.error(\"Error handling Basiq callback:\", error);\n      res.redirect(\"/financial?error=callback_failed\");\n    }\n  });\n\n  // Basiq webhook endpoint - receives notifications about data updates\n  app.post(\"/api/basiq/webhook\", async (req, res) => {\n    try {\n      console.log(\"Basiq webhook received:\", JSON.stringify(req.body, null, 2));\n      \n      const { type, consentId, data } = req.body;\n      \n      // Log the webhook event for future processing\n      console.log(`Webhook event: ${type} for consent: ${consentId}`);\n      \n      // Handle different webhook events\n      if (type === \"transactions.available\") {\n        // New transactions are available - trigger sync\n        console.log(\"New transactions available for sync\");\n        // TODO: Implement automatic transaction sync\n      } else if (type === \"consent.revoked\") {\n        // User revoked consent - update connection status\n        console.log(\"Consent revoked for:\", consentId);\n        const connections = await storage.getBankConnections();\n        const connection = connections.find(c => c.basiqConsentId === consentId);\n        if (connection) {\n          await storage.updateBankConnection(connection.id, {\n            status: \"inactive\"\n          });\n        }\n      }\n      \n      // Always respond 200 to acknowledge receipt\n      res.status(200).json({ received: true });\n    } catch (error) {\n      console.error(\"Error handling Basiq webhook:\", error);\n      res.status(200).json({ received: true, error: \"Processing error\" });\n    }\n  });\n\n  // Get all bank connections\n  app.get(\"/api/financial/connections\", requireRoles(\"admin\", \"scheduler\", \"production_manager\"), async (req, res) => {\n    try {\n      const connections = await storage.getBankConnections();\n      res.json(connections);\n    } catch (error) {\n      console.error(\"Error fetching bank connections:\", error);\n      res.status(500).json({ error: \"Failed to fetch connections\" });\n    }\n  });\n\n  // Refresh accounts for a connection\n  app.post(\"/api/financial/connections/:id/refresh\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const connection = await storage.getBankConnectionById(req.params.id);\n      if (!connection) {\n        return res.status(404).json({ error: \"Connection not found\" });\n      }\n\n      if (!connection.basiqConsentId) {\n        return res.status(400).json({ error: \"Connection has no consent ID\" });\n      }\n\n      const { BasiqService } = await import(\"./services/basiq\");\n      const basiq = new BasiqService();\n      \n      // Verify consent is still active\n      const consent = await basiq.getConsent(connection.basiqConsentId);\n      if (consent.status !== \"active\") {\n        await storage.updateBankConnection(connection.id, { status: \"inactive\" });\n        return res.status(400).json({ error: \"Consent is no longer active. Please reconnect.\" });\n      }\n      \n      // Sync accounts\n      await basiq.syncAccountsToDatabase(connection.id);\n      \n      // Update last synced time\n      await storage.updateBankConnection(connection.id, {\n        lastSyncedAt: new Date()\n      });\n\n      const updated = await storage.getBankConnectionById(connection.id);\n      res.json(updated);\n    } catch (error: any) {\n      console.error(\"Error refreshing connection:\", error);\n      res.status(500).json({ error: error.message || \"Failed to refresh connection\" });\n    }\n  });\n\n  // Get all bank accounts\n  app.get(\"/api/financial/accounts\", requireRoles(\"admin\", \"scheduler\", \"production_manager\"), async (req, res) => {\n    try {\n      const accounts = await storage.getBankAccounts();\n      res.json(accounts);\n    } catch (error) {\n      console.error(\"Error fetching bank accounts:\", error);\n      res.status(500).json({ error: \"Failed to fetch accounts\" });\n    }\n  });\n\n  // Get account by ID with connection info\n  app.get(\"/api/financial/accounts/:id\", requireRoles(\"admin\", \"scheduler\", \"production_manager\"), async (req, res) => {\n    try {\n      const account = await storage.getBankAccountById(req.params.id);\n      if (!account) {\n        return res.status(404).json({ error: \"Account not found\" });\n      }\n      res.json(account);\n    } catch (error) {\n      console.error(\"Error fetching bank account:\", error);\n      res.status(500).json({ error: \"Failed to fetch account\" });\n    }\n  });\n\n  // Get transactions for an account\n  app.get(\"/api/financial/accounts/:id/transactions\", requireRoles(\"admin\", \"scheduler\", \"production_manager\"), async (req, res) => {\n    try {\n      const { fromDate, toDate, category, direction, limit = \"100\", offset = \"0\" } = req.query;\n      \n      const transactions = await storage.getBankTransactions(req.params.id, {\n        fromDate: fromDate as string,\n        toDate: toDate as string,\n        category: category as string,\n        direction: direction as \"credit\" | \"debit\",\n        limit: parseInt(limit as string),\n        offset: parseInt(offset as string)\n      });\n      \n      res.json(transactions);\n    } catch (error) {\n      console.error(\"Error fetching transactions:\", error);\n      res.status(500).json({ error: \"Failed to fetch transactions\" });\n    }\n  });\n\n  // Get all transactions across all accounts\n  app.get(\"/api/financial/transactions\", requireRoles(\"admin\", \"scheduler\", \"production_manager\"), async (req, res) => {\n    try {\n      const { fromDate, toDate, category, direction, limit = \"500\", offset = \"0\", search, minAmount, maxAmount } = req.query;\n      \n      const transactions = await storage.getAllBankTransactions({\n        fromDate: fromDate as string,\n        toDate: toDate as string,\n        category: category as string,\n        direction: direction as \"credit\" | \"debit\",\n        limit: parseInt(limit as string),\n        offset: parseInt(offset as string),\n        search: search as string,\n        minAmount: minAmount ? parseFloat(minAmount as string) : undefined,\n        maxAmount: maxAmount ? parseFloat(maxAmount as string) : undefined,\n      });\n      \n      res.json(transactions);\n    } catch (error) {\n      console.error(\"Error fetching all transactions:\", error);\n      res.status(500).json({ error: \"Failed to fetch transactions\" });\n    }\n  });\n\n  // Sync transactions for an account\n  app.post(\"/api/financial/accounts/:id/sync\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { fromDate } = req.body;\n      \n      const { BasiqService } = await import(\"./services/basiq\");\n      const basiq = new BasiqService();\n      \n      const importedCount = await basiq.syncTransactionsToDatabase(req.params.id, fromDate);\n      \n      // Update account balance using consent-based account fetch\n      const account = await storage.getBankAccountById(req.params.id);\n      if (account) {\n        const connection = await storage.getBankConnectionById(account.connectionId);\n        if (connection?.basiqConsentId) {\n          // Use consent-based account fetch\n          const accounts = await basiq.getAccountsByConsent(connection.basiqConsentId);\n          const basiqAccount = accounts.find((a: any) => a.id === account.basiqAccountId);\n          if (basiqAccount) {\n            await storage.updateBankAccount(account.id, {\n              balance: basiqAccount.balance,\n              availableFunds: basiqAccount.availableFunds,\n              lastUpdatedAt: new Date()\n            });\n          }\n        }\n      }\n      \n      res.json({ \n        success: true, \n        importedCount,\n        message: `Imported ${importedCount} new transactions` \n      });\n    } catch (error: any) {\n      console.error(\"Error syncing transactions:\", error);\n      res.status(500).json({ error: error.message || \"Failed to sync transactions\" });\n    }\n  });\n\n  // Get financial overview/summary\n  app.get(\"/api/financial/overview\", requireRoles(\"admin\", \"scheduler\", \"production_manager\"), async (req, res) => {\n    try {\n      const accounts = await storage.getBankAccounts();\n      const connections = await storage.getBankConnections();\n      \n      // Calculate totals\n      let totalBalance = 0;\n      let totalAvailable = 0;\n      \n      for (const account of accounts) {\n        if (account.isActive) {\n          totalBalance += parseFloat(account.balance || \"0\");\n          totalAvailable += parseFloat(account.availableFunds || \"0\");\n        }\n      }\n\n      // Get recent transactions (last 30 days)\n      const thirtyDaysAgo = new Date();\n      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\n      \n      const recentTransactions = await storage.getAllBankTransactions({\n        fromDate: thirtyDaysAgo.toISOString().split(\"T\")[0],\n        limit: 10\n      });\n\n      // Calculate income/expenses for the month\n      let monthlyIncome = 0;\n      let monthlyExpenses = 0;\n\n      const allRecentTx = await storage.getAllBankTransactions({\n        fromDate: thirtyDaysAgo.toISOString().split(\"T\")[0],\n        limit: 1000\n      });\n\n      for (const tx of allRecentTx) {\n        const amount = parseFloat(tx.amount || \"0\");\n        if (tx.direction === \"credit\") {\n          monthlyIncome += amount;\n        } else {\n          monthlyExpenses += amount;\n        }\n      }\n\n      res.json({\n        totalBalance,\n        totalAvailable,\n        monthlyIncome,\n        monthlyExpenses,\n        accountCount: accounts.filter(a => a.isActive).length,\n        connectionCount: connections.filter(c => c.status === \"active\").length,\n        recentTransactions,\n        lastSyncedAt: connections.length > 0 ? connections[0].lastSyncedAt : null\n      });\n    } catch (error) {\n      console.error(\"Error fetching financial overview:\", error);\n      res.status(500).json({ error: \"Failed to fetch overview\" });\n    }\n  });\n\n  // ============================================\n  // STAFF TRANSACTIONS / EXPENSE MANAGEMENT\n  // ============================================\n\n  // Get staff transaction summary\n  app.get(\"/api/financial/staff-summary\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const summary = await storage.getStaffTransactionSummary();\n      res.json(summary);\n    } catch (error) {\n      console.error(\"Error fetching staff summary:\", error);\n      res.status(500).json({ error: \"Failed to fetch staff summary\" });\n    }\n  });\n\n  // Get transactions for specific staff member\n  app.get(\"/api/financial/staff/:staffId/transactions\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { staffId } = req.params;\n      const { fromDate, toDate, category, limit } = req.query;\n      \n      const transactions = await storage.getTransactionsByStaff(staffId, {\n        fromDate: fromDate as string,\n        toDate: toDate as string,\n        category: category as string,\n        limit: limit ? parseInt(limit as string) : undefined\n      });\n      \n      res.json(transactions);\n    } catch (error) {\n      console.error(\"Error fetching staff transactions:\", error);\n      res.status(500).json({ error: \"Failed to fetch staff transactions\" });\n    }\n  });\n\n  // Update transaction (allocate to staff/job, set category)\n  app.patch(\"/api/financial/transactions/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { id } = req.params;\n      const { allocatedStaffId, allocatedJobId, expenseCategoryId, allocationNotes } = req.body;\n      \n      const updated = await storage.updateBankTransaction(id, {\n        allocatedStaffId,\n        allocatedJobId,\n        expenseCategoryId,\n        allocationNotes\n      });\n      \n      if (!updated) {\n        return res.status(404).json({ error: \"Transaction not found\" });\n      }\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating transaction:\", error);\n      res.status(500).json({ error: \"Failed to update transaction\" });\n    }\n  });\n\n  // Auto-allocate transactions by card number\n  app.post(\"/api/financial/auto-allocate\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const count = await storage.autoAllocateTransactionsByCardNumber();\n      res.json({ \n        success: true, \n        allocatedCount: count,\n        message: `Auto-allocated ${count} transactions` \n      });\n    } catch (error) {\n      console.error(\"Error auto-allocating transactions:\", error);\n      res.status(500).json({ error: \"Failed to auto-allocate transactions\" });\n    }\n  });\n\n  // Auto-categorize transactions by keyword matching\n  app.post(\"/api/financial/auto-categorize\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const count = await storage.autoCategorizeTransactionsByKeywords();\n      res.json({ \n        success: true, \n        categorizedCount: count,\n        message: `Auto-categorized ${count} transactions` \n      });\n    } catch (error) {\n      console.error(\"Error auto-categorizing transactions:\", error);\n      res.status(500).json({ error: \"Failed to auto-categorize transactions\" });\n    }\n  });\n\n  // Import transactions from CSV\n  app.post(\"/api/financial/transactions/import\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { rows } = req.body;\n      \n      if (!rows || !Array.isArray(rows)) {\n        return res.status(400).json({ error: \"Invalid CSV data. Expected rows array.\" });\n      }\n      \n      // Get or create a default \"Manual Import\" account for CSV imports\n      let importAccount = await storage.getBankAccountByName(\"Manual Import\");\n      if (!importAccount) {\n        // First, create a placeholder connection for manual imports\n        let importConnection = await storage.getBankConnectionByInstitution(\"MANUAL\");\n        if (!importConnection) {\n          const newConnection = await storage.createBankConnection({\n            institutionId: \"MANUAL\",\n            institutionName: \"Manual Import\",\n            status: \"active\",\n          });\n          if (!newConnection) {\n            return res.status(500).json({ error: \"Failed to create import connection\" });\n          }\n          importConnection = newConnection;\n        }\n        \n        // Create the import account\n        const newAccount = await storage.createBankAccount({\n          connectionId: importConnection.id,\n          basiqAccountId: \"manual-import\",\n          name: \"Manual Import\",\n          accountType: \"other\",\n          currency: \"AUD\",\n        });\n        if (!newAccount) {\n          return res.status(500).json({ error: \"Failed to create import account\" });\n        }\n        importAccount = newAccount;\n      }\n      \n      let importedCount = 0;\n      const errors: string[] = [];\n      \n      for (let i = 0; i < rows.length; i++) {\n        const row = rows[i];\n        \n        try {\n          // Parse date - try multiple formats\n          let transactionDate: Date | null = null;\n          if (row.transactionDate) {\n            const dateStr = row.transactionDate.trim();\n            // Try various date formats\n            const formats = [\n              /^(\\d{1,2})\\/(\\d{1,2})\\/(\\d{4})$/, // DD/MM/YYYY or D/M/YYYY\n              /^(\\d{1,2})\\/(\\d{1,2})\\/(\\d{2})$/, // DD/MM/YY\n              /^(\\d{4})-(\\d{2})-(\\d{2})$/, // YYYY-MM-DD\n            ];\n            \n            for (const format of formats) {\n              const match = dateStr.match(format);\n              if (match) {\n                if (format === formats[2]) {\n                  // YYYY-MM-DD\n                  transactionDate = new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));\n                } else if (format === formats[1]) {\n                  // DD/MM/YY\n                  const year = parseInt(match[3]) + 2000;\n                  transactionDate = new Date(year, parseInt(match[2]) - 1, parseInt(match[1]));\n                } else {\n                  // DD/MM/YYYY\n                  transactionDate = new Date(parseInt(match[3]), parseInt(match[2]) - 1, parseInt(match[1]));\n                }\n                break;\n              }\n            }\n            \n            // Fallback: try Date.parse\n            if (!transactionDate) {\n              const parsed = Date.parse(dateStr);\n              if (!isNaN(parsed)) {\n                transactionDate = new Date(parsed);\n              }\n            }\n          }\n          \n          if (!transactionDate || isNaN(transactionDate.getTime())) {\n            errors.push(`Row ${i + 1}: Invalid date \"${row.transactionDate}\"`);\n            continue;\n          }\n          \n          // Parse amount - remove currency symbols, handle negatives\n          let amount = row.amount?.toString().replace(/[^0-9.\\-]/g, '') || \"0\";\n          const numAmount = parseFloat(amount);\n          \n          if (isNaN(numAmount)) {\n            errors.push(`Row ${i + 1}: Invalid amount \"${row.amount}\"`);\n            continue;\n          }\n          \n          // Determine direction from amount or explicit direction field\n          let direction: \"credit\" | \"debit\" = numAmount >= 0 ? \"credit\" : \"debit\";\n          if (row.direction) {\n            const dirLower = row.direction.toLowerCase().trim();\n            if (dirLower.includes(\"debit\") || dirLower === \"dr\" || dirLower === \"d\") {\n              direction = \"debit\";\n            } else if (dirLower.includes(\"credit\") || dirLower === \"cr\" || dirLower === \"c\") {\n              direction = \"credit\";\n            }\n          }\n          \n          // Create unique transaction ID based on date, amount, description\n          const description = row.description?.trim() || \"Imported transaction\";\n          const uniqueId = `csv-${transactionDate.toISOString().split('T')[0]}-${Math.abs(numAmount).toFixed(2)}-${description.slice(0, 20).replace(/\\s+/g, '-')}`;\n          \n          await storage.createBankTransaction({\n            accountId: importAccount.id,\n            basiqTransactionId: `import-${Date.now()}-${i}`,\n            description,\n            amount: Math.abs(numAmount).toFixed(2),\n            direction,\n            status: \"posted\",\n            transactionDate,\n            postDate: transactionDate,\n            category: null,\n            subCategory: null,\n            merchantName: null,\n            merchantLocation: null,\n            runningBalance: null,\n            rawData: { source: \"csv_import\", originalRow: row },\n          });\n          \n          importedCount++;\n        } catch (rowError: any) {\n          errors.push(`Row ${i + 1}: ${rowError.message}`);\n        }\n      }\n      \n      res.json({\n        success: true,\n        count: importedCount,\n        errors: errors.length > 0 ? errors.slice(0, 10) : undefined,\n        message: errors.length > 0 \n          ? `Imported ${importedCount} transactions with ${errors.length} errors`\n          : `Successfully imported ${importedCount} transactions`\n      });\n    } catch (error) {\n      console.error(\"Error importing CSV transactions:\", error);\n      res.status(500).json({ error: \"Failed to import transactions\" });\n    }\n  });\n\n  // ============================================\n  // EXPENSE CATEGORIES\n  // ============================================\n\n  // Get all expense categories\n  app.get(\"/api/expense-categories\", requireRoles(\"admin\", \"scheduler\", \"production_manager\"), async (req, res) => {\n    try {\n      const categories = await storage.getExpenseCategories();\n      res.json(categories);\n    } catch (error) {\n      console.error(\"Error fetching expense categories:\", error);\n      res.status(500).json({ error: \"Failed to fetch expense categories\" });\n    }\n  });\n\n  // Get active expense categories only\n  app.get(\"/api/expense-categories/active\", async (req, res) => {\n    try {\n      const categories = await storage.getActiveExpenseCategories();\n      res.json(categories);\n    } catch (error) {\n      console.error(\"Error fetching active expense categories:\", error);\n      res.status(500).json({ error: \"Failed to fetch expense categories\" });\n    }\n  });\n\n  // Create expense category\n  app.post(\"/api/expense-categories\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const category = await storage.createExpenseCategory(req.body);\n      res.status(201).json(category);\n    } catch (error) {\n      console.error(\"Error creating expense category:\", error);\n      res.status(500).json({ error: \"Failed to create expense category\" });\n    }\n  });\n\n  // Update expense category\n  app.patch(\"/api/expense-categories/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { id } = req.params;\n      const updated = await storage.updateExpenseCategory(id, req.body);\n      \n      if (!updated) {\n        return res.status(404).json({ error: \"Category not found\" });\n      }\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating expense category:\", error);\n      res.status(500).json({ error: \"Failed to update expense category\" });\n    }\n  });\n\n  // Delete expense category\n  app.delete(\"/api/expense-categories/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { id } = req.params;\n      const deleted = await storage.deleteExpenseCategory(id);\n      \n      if (!deleted) {\n        return res.status(404).json({ error: \"Category not found\" });\n      }\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting expense category:\", error);\n      res.status(500).json({ error: \"Failed to delete expense category\" });\n    }\n  });\n\n  // ============================================\n  // RECEIPT SUBMISSIONS\n  // ============================================\n\n  // Get all receipt submissions (admin)\n  app.get(\"/api/receipts\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { status } = req.query;\n      const receipts = await storage.getReceiptSubmissions(\n        status ? { status: status as string } : undefined\n      );\n      res.json(receipts);\n    } catch (error) {\n      console.error(\"Error fetching receipts:\", error);\n      res.status(500).json({ error: \"Failed to fetch receipts\" });\n    }\n  });\n\n  // Get pending receipts (admin)\n  app.get(\"/api/receipts/pending\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const receipts = await storage.getPendingReceipts();\n      res.json(receipts);\n    } catch (error) {\n      console.error(\"Error fetching pending receipts:\", error);\n      res.status(500).json({ error: \"Failed to fetch pending receipts\" });\n    }\n  });\n\n  // Create receipt submission link (admin generates link for staff)\n  app.post(\"/api/receipts/create-link\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { staffId, description, amount, expenseCategoryId } = req.body;\n      \n      const token = crypto.randomBytes(32).toString(\"hex\");\n      const expiresAt = new Date();\n      expiresAt.setDate(expiresAt.getDate() + 7); // 7-day expiry\n      \n      const receipt = await storage.createReceiptSubmission({\n        submissionToken: token,\n        staffId,\n        description,\n        expectedAmount: amount,\n        expenseCategoryId,\n        status: \"pending\",\n        expiresAt\n      });\n      \n      const submissionUrl = `${req.protocol}://${req.get(\"host\")}/submit-receipt/${token}`;\n      \n      res.status(201).json({\n        receipt,\n        submissionUrl,\n        expiresAt\n      });\n    } catch (error) {\n      console.error(\"Error creating receipt link:\", error);\n      res.status(500).json({ error: \"Failed to create receipt link\" });\n    }\n  });\n\n  // Validate receipt submission link (public - for checking link validity)\n  app.get(\"/api/receipts/validate/:token\", async (req, res) => {\n    try {\n      const { token } = req.params;\n      const receipt = await storage.getReceiptSubmissionByToken(token);\n      \n      if (!receipt) {\n        return res.status(404).json({ error: \"Receipt link not found or expired\" });\n      }\n      \n      if (receipt.expiresAt && new Date(receipt.expiresAt) < new Date()) {\n        return res.status(410).json({ error: \"Receipt link has expired\" });\n      }\n      \n      // Return minimal info for validation\n      res.json({\n        id: receipt.id,\n        status: receipt.status,\n        expectedAmount: receipt.expectedAmount,\n        notes: receipt.notes,\n        expiresAt: receipt.expiresAt,\n        createdAt: receipt.createdAt\n      });\n    } catch (error) {\n      console.error(\"Error validating receipt token:\", error);\n      res.status(500).json({ error: \"Failed to validate receipt link\" });\n    }\n  });\n\n  // Get receipt submission by token (public - for staff to upload)\n  app.get(\"/api/receipts/submit/:token\", async (req, res) => {\n    try {\n      const { token } = req.params;\n      const receipt = await storage.getReceiptSubmissionByToken(token);\n      \n      if (!receipt) {\n        return res.status(404).json({ error: \"Receipt link not found or expired\" });\n      }\n      \n      if (receipt.expiresAt && new Date(receipt.expiresAt) < new Date()) {\n        return res.status(410).json({ error: \"Receipt link has expired\" });\n      }\n      \n      if (receipt.status !== \"pending\") {\n        return res.status(400).json({ error: \"Receipt has already been submitted\" });\n      }\n      \n      // Get active categories for the form\n      const categories = await storage.getActiveExpenseCategories();\n      \n      res.json({ receipt, categories });\n    } catch (error) {\n      console.error(\"Error fetching receipt by token:\", error);\n      res.status(500).json({ error: \"Failed to fetch receipt\" });\n    }\n  });\n\n  // Submit receipt (public - staff uploads via link)\n  app.post(\"/api/receipts/submit/:token\", async (req, res) => {\n    try {\n      const { token } = req.params;\n      const { imageUrl, actualAmount, expenseCategoryId, notes, merchantName, purchaseDate } = req.body;\n      \n      const receipt = await storage.getReceiptSubmissionByToken(token);\n      \n      if (!receipt) {\n        return res.status(404).json({ error: \"Receipt link not found\" });\n      }\n      \n      if (receipt.expiresAt && new Date(receipt.expiresAt) < new Date()) {\n        return res.status(410).json({ error: \"Receipt link has expired\" });\n      }\n      \n      if (receipt.status !== \"pending\") {\n        return res.status(400).json({ error: \"Receipt has already been submitted\" });\n      }\n      \n      const updated = await storage.updateReceiptSubmission(receipt.id, {\n        imageUrl,\n        actualAmount,\n        expenseCategoryId: expenseCategoryId || receipt.expenseCategoryId,\n        notes,\n        merchantName,\n        purchaseDate: purchaseDate ? new Date(purchaseDate) : undefined,\n        status: \"submitted\",\n        submittedAt: new Date()\n      });\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error submitting receipt:\", error);\n      res.status(500).json({ error: \"Failed to submit receipt\" });\n    }\n  });\n\n  // Match receipt to transaction (admin)\n  app.post(\"/api/receipts/:id/match\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { id } = req.params;\n      const { transactionId } = req.body;\n      const user = req.user as User;\n      \n      if (!transactionId) {\n        return res.status(400).json({ error: \"Transaction ID required\" });\n      }\n      \n      await storage.matchReceiptToTransaction(id, transactionId, user.id);\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error matching receipt:\", error);\n      res.status(500).json({ error: \"Failed to match receipt\" });\n    }\n  });\n\n  // Update receipt (admin)\n  app.patch(\"/api/receipts/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { id } = req.params;\n      const updated = await storage.updateReceiptSubmission(id, req.body);\n      \n      if (!updated) {\n        return res.status(404).json({ error: \"Receipt not found\" });\n      }\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating receipt:\", error);\n      res.status(500).json({ error: \"Failed to update receipt\" });\n    }\n  });\n\n  // Delete receipt (admin)\n  app.delete(\"/api/receipts/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { id } = req.params;\n      const deleted = await storage.deleteReceiptSubmission(id);\n      \n      if (!deleted) {\n        return res.status(404).json({ error: \"Receipt not found\" });\n      }\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting receipt:\", error);\n      res.status(500).json({ error: \"Failed to delete receipt\" });\n    }\n  });\n\n  // Import Products/Inventory\n  app.post(\"/api/import/products\", async (req, res) => {\n    try {\n      const { data } = req.body;\n      if (!Array.isArray(data)) {\n        return res.status(400).json({ error: \"Data must be an array\" });\n      }\n\n      let success = 0;\n      let failed = 0;\n      const errors: string[] = [];\n\n      for (const row of data) {\n        try {\n          const sku = row.sku?.trim();\n          const name = row.name?.trim();\n          const category = row.category?.trim();\n          const costPrice = row.costPrice;\n          const sellPrice = row.sellPrice;\n\n          if (!sku || !name || !category || costPrice === undefined || sellPrice === undefined) {\n            errors.push(`Row missing required fields: sku=${sku || 'missing'}`);\n            failed++;\n            continue;\n          }\n\n          const validCategories = [\"fencing\", \"gates\", \"hardware\", \"accessories\", \"other\"];\n          if (!validCategories.includes(category)) {\n            errors.push(`Invalid category for ${sku}: ${category}`);\n            failed++;\n            continue;\n          }\n\n          await storage.createProduct({\n            sku,\n            name,\n            description: row.description?.trim() || null,\n            category: category as any,\n            dimensions: row.dimensions?.trim() || null,\n            color: row.color?.trim() || null,\n            costPrice: String(costPrice),\n            sellPrice: String(sellPrice),\n            tradePrice: row.tradePrice ? String(row.tradePrice) : null,\n            stockOnHand: parseInt(row.stockOnHand) || 0,\n            reorderPoint: parseInt(row.reorderPoint) || 10,\n            isActive: row.isActive !== \"false\" && row.isActive !== false\n          });\n          success++;\n        } catch (err: any) {\n          failed++;\n          errors.push(`Failed to import product: ${row.sku || 'unknown'} - ${err.message || ''}`);\n        }\n      }\n\n      res.json({ success, failed, errors });\n    } catch (error) {\n      console.error(\"Error importing products:\", error);\n      res.status(500).json({ error: \"Failed to import products\" });\n    }\n  });\n\n  // ==========================================\n  // JOB PIPELINE CONFIGURATION\n  // ==========================================\n\n  // Get all job pipelines\n  app.get(\"/api/job-pipelines\", async (req, res) => {\n    try {\n      const pipelines = await storage.getJobPipelines();\n      res.json(pipelines);\n    } catch (error) {\n      console.error(\"Error fetching job pipelines:\", error);\n      res.status(500).json({ error: \"Failed to fetch job pipelines\" });\n    }\n  });\n\n  // Get a single job pipeline with stages\n  app.get(\"/api/job-pipelines/:id\", async (req, res) => {\n    try {\n      const pipeline = await storage.getJobPipeline(req.params.id);\n      if (!pipeline) {\n        return res.status(404).json({ error: \"Pipeline not found\" });\n      }\n      const stages = await storage.getJobPipelineStages(req.params.id);\n      res.json({ ...pipeline, stages });\n    } catch (error) {\n      console.error(\"Error fetching job pipeline:\", error);\n      res.status(500).json({ error: \"Failed to fetch job pipeline\" });\n    }\n  });\n\n  // Create a new job pipeline\n  app.post(\"/api/job-pipelines\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { name, description, isActive } = req.body;\n      if (!name) {\n        return res.status(400).json({ error: \"Name is required\" });\n      }\n      const pipeline = await storage.createJobPipeline({\n        name,\n        description: description || null,\n        isActive: isActive !== false\n      });\n      res.status(201).json(pipeline);\n    } catch (error) {\n      console.error(\"Error creating job pipeline:\", error);\n      res.status(500).json({ error: \"Failed to create job pipeline\" });\n    }\n  });\n\n  // Update a job pipeline\n  app.patch(\"/api/job-pipelines/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { name, description, isActive } = req.body;\n      const pipeline = await storage.updateJobPipeline(req.params.id, {\n        name,\n        description,\n        isActive\n      });\n      if (!pipeline) {\n        return res.status(404).json({ error: \"Pipeline not found\" });\n      }\n      res.json(pipeline);\n    } catch (error) {\n      console.error(\"Error updating job pipeline:\", error);\n      res.status(500).json({ error: \"Failed to update job pipeline\" });\n    }\n  });\n\n  // Delete a job pipeline\n  app.delete(\"/api/job-pipelines/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      await storage.deleteJobPipeline(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting job pipeline:\", error);\n      res.status(500).json({ error: \"Failed to delete job pipeline\" });\n    }\n  });\n\n  // Get stages for a pipeline\n  app.get(\"/api/job-pipelines/:pipelineId/stages\", async (req, res) => {\n    try {\n      const stages = await storage.getJobPipelineStages(req.params.pipelineId);\n      res.json(stages);\n    } catch (error) {\n      console.error(\"Error fetching pipeline stages:\", error);\n      res.status(500).json({ error: \"Failed to fetch pipeline stages\" });\n    }\n  });\n\n  // Create a new stage\n  app.post(\"/api/job-pipelines/:pipelineId/stages\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { name, icon, completionType, isActive, sortOrder } = req.body;\n      if (!name) {\n        return res.status(400).json({ error: \"Name is required\" });\n      }\n      \n      // Get current max sort order if not provided\n      let order = sortOrder;\n      if (order === undefined) {\n        const existingStages = await storage.getJobPipelineStages(req.params.pipelineId);\n        order = existingStages.length > 0 \n          ? Math.max(...existingStages.map(s => s.sortOrder)) + 1 \n          : 0;\n      }\n      \n      const stage = await storage.createJobPipelineStage({\n        pipelineId: req.params.pipelineId,\n        name,\n        icon: icon || null,\n        completionType: completionType || \"manual\",\n        isActive: isActive !== false,\n        sortOrder: order\n      });\n      res.status(201).json(stage);\n    } catch (error) {\n      console.error(\"Error creating pipeline stage:\", error);\n      res.status(500).json({ error: \"Failed to create pipeline stage\" });\n    }\n  });\n\n  // Update a stage\n  app.patch(\"/api/job-pipeline-stages/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { name, icon, completionType, isActive, sortOrder } = req.body;\n      const stage = await storage.updateJobPipelineStage(req.params.id, {\n        name,\n        icon,\n        completionType,\n        isActive,\n        sortOrder\n      });\n      if (!stage) {\n        return res.status(404).json({ error: \"Stage not found\" });\n      }\n      res.json(stage);\n    } catch (error) {\n      console.error(\"Error updating pipeline stage:\", error);\n      res.status(500).json({ error: \"Failed to update pipeline stage\" });\n    }\n  });\n\n  // Delete a stage\n  app.delete(\"/api/job-pipeline-stages/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      await storage.deleteJobPipelineStage(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting pipeline stage:\", error);\n      res.status(500).json({ error: \"Failed to delete pipeline stage\" });\n    }\n  });\n\n  // Reorder stages\n  app.post(\"/api/job-pipelines/:pipelineId/stages/reorder\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { stageIds } = req.body;\n      if (!Array.isArray(stageIds)) {\n        return res.status(400).json({ error: \"stageIds must be an array\" });\n      }\n      await storage.reorderJobPipelineStages(req.params.pipelineId, stageIds);\n      const stages = await storage.getJobPipelineStages(req.params.pipelineId);\n      res.json(stages);\n    } catch (error) {\n      console.error(\"Error reordering stages:\", error);\n      res.status(500).json({ error: \"Failed to reorder stages\" });\n    }\n  });\n\n  // ============================================\n  // JOB STAGE COMPLETIONS\n  // ============================================\n\n  // Get stage completions for a job\n  app.get(\"/api/jobs/:jobId/stage-completions\", async (req, res) => {\n    try {\n      const completions = await storage.getJobStageCompletions(req.params.jobId);\n      res.json(completions);\n    } catch (error) {\n      console.error(\"Error fetching job stage completions:\", error);\n      res.status(500).json({ error: \"Failed to fetch stage completions\" });\n    }\n  });\n\n  // Toggle stage completion for a job\n  app.post(\"/api/jobs/:jobId/stage-completions/:stageId/toggle\", async (req, res) => {\n    try {\n      const userId = req.user?.id;\n      const result = await storage.toggleJobStageCompletion(\n        req.params.jobId, \n        req.params.stageId, \n        userId\n      );\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error toggling stage completion:\", error);\n      res.status(500).json({ error: \"Failed to toggle stage completion\" });\n    }\n  });\n\n  // ============================================\n  // KANBAN COLUMNS CONFIGURATION\n  // ============================================\n\n  // Get all kanban columns\n  app.get(\"/api/kanban-columns\", async (req, res) => {\n    try {\n      const columns = await storage.getKanbanColumns();\n      res.json(columns);\n    } catch (error) {\n      console.error(\"Error fetching kanban columns:\", error);\n      res.status(500).json({ error: \"Failed to fetch kanban columns\" });\n    }\n  });\n\n  // Get single kanban column\n  app.get(\"/api/kanban-columns/:id\", async (req, res) => {\n    try {\n      const column = await storage.getKanbanColumn(req.params.id);\n      if (!column) {\n        return res.status(404).json({ error: \"Kanban column not found\" });\n      }\n      res.json(column);\n    } catch (error) {\n      console.error(\"Error fetching kanban column:\", error);\n      res.status(500).json({ error: \"Failed to fetch kanban column\" });\n    }\n  });\n\n  // Create kanban column\n  app.post(\"/api/kanban-columns\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { title, statuses, defaultStatus, color, isActive } = req.body;\n      if (!title || !statuses || !defaultStatus || !color) {\n        return res.status(400).json({ error: \"Missing required fields\" });\n      }\n      const column = await storage.createKanbanColumn({\n        title,\n        statuses,\n        defaultStatus,\n        color,\n        isActive: isActive ?? true\n      });\n      res.status(201).json(column);\n    } catch (error) {\n      console.error(\"Error creating kanban column:\", error);\n      res.status(500).json({ error: \"Failed to create kanban column\" });\n    }\n  });\n\n  // Update kanban column\n  app.patch(\"/api/kanban-columns/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { title, statuses, defaultStatus, color, isActive, sortOrder } = req.body;\n      const column = await storage.updateKanbanColumn(req.params.id, {\n        title,\n        statuses,\n        defaultStatus,\n        color,\n        isActive,\n        sortOrder\n      });\n      if (!column) {\n        return res.status(404).json({ error: \"Kanban column not found\" });\n      }\n      res.json(column);\n    } catch (error) {\n      console.error(\"Error updating kanban column:\", error);\n      res.status(500).json({ error: \"Failed to update kanban column\" });\n    }\n  });\n\n  // Delete kanban column\n  app.delete(\"/api/kanban-columns/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      await storage.deleteKanbanColumn(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting kanban column:\", error);\n      res.status(500).json({ error: \"Failed to delete kanban column\" });\n    }\n  });\n\n  // Reorder kanban columns\n  app.post(\"/api/kanban-columns/reorder\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { columnIds } = req.body;\n      if (!Array.isArray(columnIds)) {\n        return res.status(400).json({ error: \"columnIds must be an array\" });\n      }\n      await storage.reorderKanbanColumns(columnIds);\n      const columns = await storage.getKanbanColumns();\n      res.json(columns);\n    } catch (error) {\n      console.error(\"Error reordering kanban columns:\", error);\n      res.status(500).json({ error: \"Failed to reorder kanban columns\" });\n    }\n  });\n\n  // ============================================\n  // JOB STATUSES\n  // ============================================\n\n  // Get all job statuses\n  app.get(\"/api/job-statuses\", async (req, res) => {\n    try {\n      const statuses = await storage.getJobStatuses();\n      res.json(statuses);\n    } catch (error) {\n      console.error(\"Error fetching job statuses:\", error);\n      res.status(500).json({ error: \"Failed to fetch job statuses\" });\n    }\n  });\n\n  // Get single job status\n  app.get(\"/api/job-statuses/:id\", async (req, res) => {\n    try {\n      const status = await storage.getJobStatus(req.params.id);\n      if (!status) {\n        return res.status(404).json({ error: \"Job status not found\" });\n      }\n      res.json(status);\n    } catch (error) {\n      console.error(\"Error fetching job status:\", error);\n      res.status(500).json({ error: \"Failed to fetch job status\" });\n    }\n  });\n\n  // Create job status\n  app.post(\"/api/job-statuses\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { key, label, description, isActive } = req.body;\n      if (!key || !label) {\n        return res.status(400).json({ error: \"Missing required fields: key and label\" });\n      }\n      const status = await storage.createJobStatus({\n        key,\n        label,\n        description,\n        isActive: isActive ?? true\n      });\n      res.json(status);\n    } catch (error) {\n      console.error(\"Error creating job status:\", error);\n      res.status(500).json({ error: \"Failed to create job status\" });\n    }\n  });\n\n  // Update job status\n  app.patch(\"/api/job-statuses/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { key, label, description, isActive, sortOrder } = req.body;\n      const status = await storage.updateJobStatus(req.params.id, {\n        key,\n        label,\n        description,\n        isActive,\n        sortOrder\n      });\n      if (!status) {\n        return res.status(404).json({ error: \"Job status not found\" });\n      }\n      res.json(status);\n    } catch (error) {\n      console.error(\"Error updating job status:\", error);\n      res.status(500).json({ error: \"Failed to update job status\" });\n    }\n  });\n\n  // Delete job status\n  app.delete(\"/api/job-statuses/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      await storage.deleteJobStatus(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting job status:\", error);\n      res.status(500).json({ error: \"Failed to delete job status\" });\n    }\n  });\n\n  // Reorder job statuses\n  app.post(\"/api/job-statuses/reorder\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { statusIds } = req.body;\n      if (!Array.isArray(statusIds)) {\n        return res.status(400).json({ error: \"statusIds must be an array\" });\n      }\n      await storage.reorderJobStatuses(statusIds);\n      const statuses = await storage.getJobStatuses();\n      res.json(statuses);\n    } catch (error) {\n      console.error(\"Error reordering job statuses:\", error);\n      res.status(500).json({ error: \"Failed to reorder job statuses\" });\n    }\n  });\n\n  // ============================================\n  // JOB STATUS DEPENDENCIES\n  // ============================================\n\n  // Get all status dependencies\n  app.get(\"/api/job-status-dependencies\", async (req, res) => {\n    try {\n      const dependencies = await storage.getAllStatusDependencies();\n      res.json(dependencies);\n    } catch (error) {\n      console.error(\"Error fetching status dependencies:\", error);\n      res.status(500).json({ error: \"Failed to fetch status dependencies\" });\n    }\n  });\n\n  // Get dependencies for a specific status\n  app.get(\"/api/job-status-dependencies/:statusKey\", async (req, res) => {\n    try {\n      const dependencies = await storage.getStatusDependencies(req.params.statusKey);\n      res.json(dependencies);\n    } catch (error) {\n      console.error(\"Error fetching status dependencies:\", error);\n      res.status(500).json({ error: \"Failed to fetch status dependencies\" });\n    }\n  });\n\n  // Set dependencies for a status (replaces all existing)\n  app.put(\"/api/job-status-dependencies/:statusKey\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { dependencies } = req.body;\n      if (!Array.isArray(dependencies)) {\n        return res.status(400).json({ error: \"dependencies must be an array\" });\n      }\n      await storage.setStatusDependencies(req.params.statusKey, dependencies);\n      const updated = await storage.getStatusDependencies(req.params.statusKey);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error setting status dependencies:\", error);\n      res.status(500).json({ error: \"Failed to set status dependencies\" });\n    }\n  });\n\n  // ============================================\n  // PRODUCTION STAGES\n  // ============================================\n\n  // Get all production stages\n  app.get(\"/api/production-stages\", async (req, res) => {\n    try {\n      const stages = await storage.getProductionStages();\n      res.json(stages);\n    } catch (error) {\n      console.error(\"Error fetching production stages:\", error);\n      res.status(500).json({ error: \"Failed to fetch production stages\" });\n    }\n  });\n\n  // Get single production stage\n  app.get(\"/api/production-stages/:id\", async (req, res) => {\n    try {\n      const stage = await storage.getProductionStage(req.params.id);\n      if (!stage) {\n        return res.status(404).json({ error: \"Production stage not found\" });\n      }\n      res.json(stage);\n    } catch (error) {\n      console.error(\"Error fetching production stage:\", error);\n      res.status(500).json({ error: \"Failed to fetch production stage\" });\n    }\n  });\n\n  // Create production stage\n  app.post(\"/api/production-stages\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const stage = await storage.createProductionStage(req.body);\n      res.status(201).json(stage);\n    } catch (error) {\n      console.error(\"Error creating production stage:\", error);\n      res.status(500).json({ error: \"Failed to create production stage\" });\n    }\n  });\n\n  // Update production stage\n  app.patch(\"/api/production-stages/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const stage = await storage.updateProductionStage(req.params.id, req.body);\n      if (!stage) {\n        return res.status(404).json({ error: \"Production stage not found\" });\n      }\n      res.json(stage);\n    } catch (error) {\n      console.error(\"Error updating production stage:\", error);\n      res.status(500).json({ error: \"Failed to update production stage\" });\n    }\n  });\n\n  // Delete production stage\n  app.delete(\"/api/production-stages/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const success = await storage.deleteProductionStage(req.params.id);\n      if (!success) {\n        return res.status(404).json({ error: \"Production stage not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting production stage:\", error);\n      res.status(500).json({ error: \"Failed to delete production stage\" });\n    }\n  });\n\n  // Reorder production stages\n  app.post(\"/api/production-stages/reorder\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { stageIds } = req.body;\n      if (!Array.isArray(stageIds)) {\n        return res.status(400).json({ error: \"stageIds must be an array\" });\n      }\n      await storage.reorderProductionStages(stageIds);\n      const stages = await storage.getProductionStages();\n      res.json(stages);\n    } catch (error) {\n      console.error(\"Error reordering production stages:\", error);\n      res.status(500).json({ error: \"Failed to reorder production stages\" });\n    }\n  });\n\n  // ============================================\n  // SALES CHECKLIST ITEMS\n  // ============================================\n\n  // Get all sales checklist items (admin only - for configuration page)\n  app.get(\"/api/sales-checklist-items\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const items = await storage.getSalesChecklistItems();\n      res.json(items);\n    } catch (error) {\n      console.error(\"Error fetching sales checklist items:\", error);\n      res.status(500).json({ error: \"Failed to fetch sales checklist items\" });\n    }\n  });\n\n  // Get active sales checklist items (sales/admin can access - needed during calls)\n  app.get(\"/api/sales-checklist-items/active\", requireRoles(\"admin\", \"sales\"), async (req, res) => {\n    try {\n      const items = await storage.getActiveSalesChecklistItems();\n      res.json(items);\n    } catch (error) {\n      console.error(\"Error fetching active sales checklist items:\", error);\n      res.status(500).json({ error: \"Failed to fetch active sales checklist items\" });\n    }\n  });\n\n  // Get single sales checklist item (admin only - for configuration)\n  app.get(\"/api/sales-checklist-items/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const item = await storage.getSalesChecklistItem(req.params.id);\n      if (!item) {\n        return res.status(404).json({ error: \"Sales checklist item not found\" });\n      }\n      res.json(item);\n    } catch (error) {\n      console.error(\"Error fetching sales checklist item:\", error);\n      res.status(500).json({ error: \"Failed to fetch sales checklist item\" });\n    }\n  });\n\n  // Create sales checklist item\n  app.post(\"/api/sales-checklist-items\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const item = await storage.createSalesChecklistItem(req.body);\n      res.status(201).json(item);\n    } catch (error) {\n      console.error(\"Error creating sales checklist item:\", error);\n      res.status(500).json({ error: \"Failed to create sales checklist item\" });\n    }\n  });\n\n  // Update sales checklist item\n  app.patch(\"/api/sales-checklist-items/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const item = await storage.updateSalesChecklistItem(req.params.id, req.body);\n      if (!item) {\n        return res.status(404).json({ error: \"Sales checklist item not found\" });\n      }\n      res.json(item);\n    } catch (error) {\n      console.error(\"Error updating sales checklist item:\", error);\n      res.status(500).json({ error: \"Failed to update sales checklist item\" });\n    }\n  });\n\n  // Delete sales checklist item\n  app.delete(\"/api/sales-checklist-items/:id\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const success = await storage.deleteSalesChecklistItem(req.params.id);\n      if (!success) {\n        return res.status(404).json({ error: \"Sales checklist item not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting sales checklist item:\", error);\n      res.status(500).json({ error: \"Failed to delete sales checklist item\" });\n    }\n  });\n\n  // Reorder sales checklist items\n  app.post(\"/api/sales-checklist-items/reorder\", requireRoles(\"admin\"), async (req, res) => {\n    try {\n      const { itemIds } = req.body;\n      if (!Array.isArray(itemIds)) {\n        return res.status(400).json({ error: \"itemIds must be an array\" });\n      }\n      await storage.reorderSalesChecklistItems(itemIds);\n      const items = await storage.getSalesChecklistItems();\n      res.json(items);\n    } catch (error) {\n      console.error(\"Error reordering sales checklist items:\", error);\n      res.status(500).json({ error: \"Failed to reorder sales checklist items\" });\n    }\n  });\n\n  // ============================================\n  // VOICE CALLS & AI COACHING\n  // ============================================\n\n  // Get all voice calls\n  app.get(\"/api/voice-calls\", requireAuth, async (req, res) => {\n    try {\n      const calls = await storage.getVoiceCalls();\n      res.json(calls);\n    } catch (error) {\n      console.error(\"Error fetching voice calls:\", error);\n      res.status(500).json({ error: \"Failed to fetch voice calls\" });\n    }\n  });\n\n  // Get active voice calls (for live coach panel)\n  app.get(\"/api/voice-calls/active\", requireAuth, async (req, res) => {\n    try {\n      const calls = await storage.getActiveVoiceCalls();\n      res.json(calls);\n    } catch (error) {\n      console.error(\"Error fetching active voice calls:\", error);\n      res.status(500).json({ error: \"Failed to fetch active voice calls\" });\n    }\n  });\n\n  // Get single voice call with full details\n  app.get(\"/api/voice-calls/:id\", requireAuth, async (req, res) => {\n    try {\n      const call = await storage.getVoiceCall(req.params.id);\n      if (!call) {\n        return res.status(404).json({ error: \"Voice call not found\" });\n      }\n      const [transcripts, checklistStatus, coachingPrompts] = await Promise.all([\n        storage.getCallTranscripts(req.params.id),\n        storage.getCallChecklistStatus(req.params.id),\n        storage.getCallCoachingPrompts(req.params.id),\n      ]);\n      res.json({ call, transcripts, checklistStatus, coachingPrompts });\n    } catch (error) {\n      console.error(\"Error fetching voice call:\", error);\n      res.status(500).json({ error: \"Failed to fetch voice call\" });\n    }\n  });\n\n  // Get voice calls by lead\n  app.get(\"/api/leads/:leadId/voice-calls\", requireAuth, async (req, res) => {\n    try {\n      const calls = await storage.getVoiceCallsByLead(req.params.leadId);\n      res.json(calls);\n    } catch (error) {\n      console.error(\"Error fetching voice calls for lead:\", error);\n      res.status(500).json({ error: \"Failed to fetch voice calls for lead\" });\n    }\n  });\n\n  // Create voice call (manual or via Twilio webhook)\n  app.post(\"/api/voice-calls\", requireAuth, async (req, res) => {\n    try {\n      const call = await storage.createVoiceCall(req.body);\n      // Initialize checklist status for the call\n      await storage.initializeCallChecklistStatus(call.id);\n      res.status(201).json(call);\n    } catch (error) {\n      console.error(\"Error creating voice call:\", error);\n      res.status(500).json({ error: \"Failed to create voice call\" });\n    }\n  });\n\n  // Update voice call status\n  app.patch(\"/api/voice-calls/:id\", requireAuth, async (req, res) => {\n    try {\n      const call = await storage.updateVoiceCall(req.params.id, req.body);\n      if (!call) {\n        return res.status(404).json({ error: \"Voice call not found\" });\n      }\n      res.json(call);\n    } catch (error) {\n      console.error(\"Error updating voice call:\", error);\n      res.status(500).json({ error: \"Failed to update voice call\" });\n    }\n  });\n\n  // Add transcript entry (from real-time transcription service)\n  app.post(\"/api/voice-calls/:callId/transcripts\", requireAuth, async (req, res) => {\n    try {\n      const transcript = await storage.createCallTranscript({\n        callId: req.params.callId,\n        ...req.body,\n      });\n      res.status(201).json(transcript);\n    } catch (error) {\n      console.error(\"Error creating transcript:\", error);\n      res.status(500).json({ error: \"Failed to create transcript\" });\n    }\n  });\n\n  // Update checklist item status during call\n  app.patch(\"/api/voice-calls/:callId/checklist/:checklistItemId\", requireAuth, async (req, res) => {\n    try {\n      const { isCovered, detectedText } = req.body;\n      const status = await storage.updateCallChecklistItemStatus(\n        req.params.callId,\n        req.params.checklistItemId,\n        isCovered,\n        detectedText\n      );\n      if (!status) {\n        return res.status(404).json({ error: \"Checklist status not found\" });\n      }\n      res.json(status);\n    } catch (error) {\n      console.error(\"Error updating checklist status:\", error);\n      res.status(500).json({ error: \"Failed to update checklist status\" });\n    }\n  });\n\n  // Create coaching prompt (from AI coaching service)\n  app.post(\"/api/voice-calls/:callId/coaching-prompts\", requireAuth, async (req, res) => {\n    try {\n      const prompt = await storage.createCallCoachingPrompt({\n        callId: req.params.callId,\n        ...req.body,\n      });\n      res.status(201).json(prompt);\n    } catch (error) {\n      console.error(\"Error creating coaching prompt:\", error);\n      res.status(500).json({ error: \"Failed to create coaching prompt\" });\n    }\n  });\n\n  // Acknowledge coaching prompt\n  app.post(\"/api/coaching-prompts/:id/acknowledge\", requireAuth, async (req, res) => {\n    try {\n      const prompt = await storage.acknowledgeCallCoachingPrompt(req.params.id);\n      if (!prompt) {\n        return res.status(404).json({ error: \"Coaching prompt not found\" });\n      }\n      res.json(prompt);\n    } catch (error) {\n      console.error(\"Error acknowledging coaching prompt:\", error);\n      res.status(500).json({ error: \"Failed to acknowledge coaching prompt\" });\n    }\n  });\n\n  // ============================================\n  // TWILIO VOICE WEBHOOKS\n  // ============================================\n\n  // Get Voice SDK token for browser-based calling\n  app.get(\"/api/voice/token\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session?.userId;\n      if (!userId) {\n        return res.status(401).json({ error: \"Not authenticated\" });\n      }\n\n      const isConfigured = await isVoiceSdkConfigured();\n      if (!isConfigured) {\n        return res.json({ \n          configured: false,\n          message: \"Voice SDK not configured. Set TWILIO_API_KEY, TWILIO_API_SECRET, and TWILIO_TWIML_APP_SID\"\n        });\n      }\n\n      const token = await generateVoiceToken(userId);\n      if (!token) {\n        return res.status(500).json({ error: \"Failed to generate voice token\" });\n      }\n\n      res.json({ \n        configured: true,\n        token,\n        identity: userId\n      });\n    } catch (error) {\n      console.error(\"Error generating voice token:\", error);\n      res.status(500).json({ error: \"Failed to generate voice token\" });\n    }\n  });\n\n  // Initiate outbound call\n  app.post(\"/api/voice/call\", requireAuth, async (req, res) => {\n    try {\n      const { phoneNumber, leadId, clientId } = req.body;\n      \n      if (!phoneNumber) {\n        return res.status(400).json({ error: \"Phone number required\" });\n      }\n\n      const webhookBaseUrl = `${req.protocol}://${req.get('host')}`;\n      \n      const result = await makeOutboundCall({\n        to: phoneNumber,\n        webhookBaseUrl,\n        staffUserId: req.session?.userId,\n        leadId,\n        clientId,\n      });\n\n      if (!result) {\n        return res.status(500).json({ error: \"Failed to initiate call\" });\n      }\n\n      const call = await storage.createVoiceCall({\n        twilioCallSid: result.sid,\n        direction: \"outbound\",\n        status: \"ringing\",\n        fromNumber: await getTwilioFromPhoneNumber() || \"\",\n        toNumber: phoneNumber,\n        staffUserId: req.session?.userId,\n        leadId,\n        clientId,\n      });\n\n      await storage.initializeCallChecklistStatus(call.id);\n\n      res.json({ callId: call.id, callSid: result.sid });\n    } catch (error) {\n      console.error(\"Error initiating call:\", error);\n      res.status(500).json({ error: \"Failed to initiate call\" });\n    }\n  });\n\n  // End/hangup a call\n  app.post(\"/api/voice-calls/:id/hangup\", requireAuth, async (req, res) => {\n    try {\n      const call = await storage.getVoiceCall(req.params.id);\n      if (!call) {\n        return res.status(404).json({ error: \"Call not found\" });\n      }\n\n      if (call.twilioCallSid) {\n        try {\n          const twilioClient = await getTwilioClient();\n          if (twilioClient) {\n            await twilioClient.calls(call.twilioCallSid).update({ status: 'completed' });\n          }\n        } catch (twilioError: any) {\n          console.log(\"Twilio hangup error (may already be ended):\", twilioError.message);\n        }\n      }\n\n      await storage.updateVoiceCall(call.id, { \n        status: \"completed\",\n        endedAt: new Date(),\n      });\n\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error hanging up call:\", error);\n      res.status(500).json({ error: \"Failed to hang up call\" });\n    }\n  });\n\n  // Twilio inbound call webhook\n  app.post(\"/api/twilio/voice/inbound\", async (req, res) => {\n    try {\n      const { CallSid, From, To, CallStatus } = req.body;\n      console.log(\"Inbound call webhook:\", { CallSid, From, To, CallStatus });\n\n      const webhookBaseUrl = `${req.protocol}://${req.get('host')}`;\n      \n      const call = await storage.createVoiceCall({\n        twilioCallSid: CallSid,\n        direction: \"inbound\",\n        status: \"ringing\",\n        fromNumber: From,\n        toNumber: To,\n      });\n\n      await storage.initializeCallChecklistStatus(call.id);\n\n      const twiml = generateTwimlForInbound({\n        greeting: \"Thank you for calling Probuild PVC. Connecting you now.\",\n        webhookBaseUrl,\n        callId: call.id,\n        callSid: CallSid,\n      });\n\n      res.type('text/xml');\n      res.send(twiml);\n    } catch (error) {\n      console.error(\"Error handling inbound call:\", error);\n      res.status(500).send(\"Error\");\n    }\n  });\n\n  // Twilio outbound call answer webhook (also handles TwiML App for Voice SDK)\n  app.post(\"/api/twilio/voice/outbound\", async (req, res) => {\n    try {\n      const { CallSid, To, From, Caller } = req.body;\n      console.log(\"Outbound/TwiML App webhook:\", req.body);\n\n      const webhookBaseUrl = `${req.protocol}://${req.get('host')}`;\n      const VoiceResponse = require('twilio').twiml.VoiceResponse;\n      const response = new VoiceResponse();\n      \n      // If To parameter exists, this is from the Voice SDK making an outbound call\n      if (To && To.startsWith('+')) {\n        // Voice SDK call - dial the actual phone number\n        console.log(`Voice SDK dialing: ${To}`);\n        \n        // Create call record in database\n        const call = await storage.createVoiceCall({\n          twilioCallSid: CallSid,\n          direction: \"outbound\",\n          status: \"ringing\",\n          fromNumber: From || Caller || \"\",\n          toNumber: To,\n        });\n        \n        await storage.initializeCallChecklistStatus(call.id);\n        \n        // Set up media stream for transcription\n        const wsUrl = webhookBaseUrl.replace('https://', 'wss://').replace('http://', 'ws://');\n        const start = response.start() as any;\n        start.stream({\n          url: `${wsUrl}/api/twilio/media-stream?callSid=${CallSid}&callId=${call.id}`,\n          track: 'both_tracks'\n        });\n        \n        // Dial the destination number\n        const dial = response.dial({\n          callerId: From || await getTwilioFromPhoneNumber(),\n          record: 'record-from-answer-dual',\n          recordingStatusCallback: `${webhookBaseUrl}/api/twilio/voice/recording`,\n          recordingStatusCallbackMethod: 'POST',\n        });\n        dial.number(To);\n      } else {\n        // Legacy API-initiated call - just set up media stream\n        const call = await storage.getVoiceCallBySid(CallSid);\n        \n        if (call) {\n          const wsUrl = webhookBaseUrl.replace('https://', 'wss://').replace('http://', 'ws://');\n          const start = response.start() as any;\n          start.stream({\n            url: `${wsUrl}/api/twilio/media-stream?callSid=${CallSid}&callId=${call.id}`,\n            track: 'both_tracks'\n          });\n        }\n        \n        // Say a greeting since this is an answered API-initiated call\n        response.say({ voice: 'Polly.Matthew' }, 'Connected.');\n      }\n\n      res.type('text/xml');\n      res.send(response.toString());\n    } catch (error) {\n      console.error(\"Error handling outbound call:\", error);\n      const VoiceResponse = require('twilio').twiml.VoiceResponse;\n      const response = new VoiceResponse();\n      response.say({ voice: 'Polly.Matthew' }, 'Sorry, there was an error connecting your call.');\n      res.type('text/xml');\n      res.send(response.toString());\n    }\n  });\n  \n  // Also handle GET requests for TwiML app\n  app.get(\"/api/twilio/voice/outbound\", async (req, res) => {\n    res.status(200).send(\"TwiML App endpoint - use POST\");\n  });\n\n  // Twilio call status webhook\n  app.post(\"/api/twilio/voice/status\", async (req, res) => {\n    try {\n      const { CallSid, CallStatus, CallDuration, Timestamp } = req.body;\n      console.log(\"Call status webhook:\", { CallSid, CallStatus, CallDuration });\n\n      const call = await storage.getVoiceCallBySid(CallSid);\n      if (!call) {\n        console.log(\"Call not found for SID:\", CallSid);\n        return res.status(200).send(\"OK\");\n      }\n\n      const statusMap: Record<string, any> = {\n        'initiated': 'ringing',\n        'ringing': 'ringing',\n        'in-progress': 'in_progress',\n        'completed': 'completed',\n        'busy': 'busy',\n        'failed': 'failed',\n        'no-answer': 'no_answer',\n        'canceled': 'canceled',\n      };\n\n      const updates: any = {\n        status: statusMap[CallStatus] || call.status,\n      };\n\n      if (CallStatus === 'in-progress' && !call.answeredAt) {\n        updates.answeredAt = new Date();\n      }\n\n      if (['completed', 'busy', 'failed', 'no-answer', 'canceled'].includes(CallStatus)) {\n        updates.endedAt = new Date();\n        if (CallDuration) {\n          updates.duration = parseInt(CallDuration);\n        }\n      }\n\n      await storage.updateVoiceCall(call.id, updates);\n\n      res.status(200).send(\"OK\");\n    } catch (error) {\n      console.error(\"Error handling call status:\", error);\n      res.status(200).send(\"OK\");\n    }\n  });\n\n  // Twilio recording status webhook\n  app.post(\"/api/twilio/voice/recording\", async (req, res) => {\n    try {\n      const { CallSid, RecordingSid, RecordingUrl, RecordingStatus, RecordingDuration } = req.body;\n      console.log(\"Recording webhook:\", { CallSid, RecordingSid, RecordingStatus });\n\n      if (RecordingStatus !== 'completed') {\n        return res.status(200).send(\"OK\");\n      }\n\n      const call = await storage.getVoiceCallBySid(CallSid);\n      if (!call) {\n        console.log(\"Call not found for recording SID:\", CallSid);\n        return res.status(200).send(\"OK\");\n      }\n\n      await storage.updateVoiceCall(call.id, {\n        recordingUrl: RecordingUrl,\n        recordingSid: RecordingSid,\n        duration: RecordingDuration ? parseInt(RecordingDuration) : call.duration,\n      });\n\n      res.status(200).send(\"OK\");\n    } catch (error) {\n      console.error(\"Error handling recording:\", error);\n      res.status(200).send(\"OK\");\n    }\n  });\n\n  // ============================================\n  // AI COACHING ENDPOINTS\n  // ============================================\n\n  // Trigger AI analysis of call transcript\n  app.post(\"/api/voice-calls/:callId/analyze\", requireAuth, async (req, res) => {\n    try {\n      await processTranscriptUpdate(req.params.callId);\n      \n      const [checklistStatus, coachingPrompts] = await Promise.all([\n        storage.getCallChecklistStatus(req.params.callId),\n        storage.getCallCoachingPrompts(req.params.callId),\n      ]);\n\n      res.json({ checklistStatus, coachingPrompts });\n    } catch (error) {\n      console.error(\"Error analyzing transcript:\", error);\n      res.status(500).json({ error: \"Failed to analyze transcript\" });\n    }\n  });\n\n  // Get AI-suggested response for customer question\n  app.post(\"/api/voice-calls/:callId/suggest-response\", requireAuth, async (req, res) => {\n    try {\n      const { question } = req.body;\n      if (!question) {\n        return res.status(400).json({ error: \"Question required\" });\n      }\n\n      const response = await generateSuggestedResponse(req.params.callId, question);\n      res.json({ suggestedResponse: response });\n    } catch (error) {\n      console.error(\"Error generating suggested response:\", error);\n      res.status(500).json({ error: \"Failed to generate response\" });\n    }\n  });\n\n  // ============================================\n  // TWILIO MEDIA STREAM WEBSOCKET\n  // ============================================\n\n  // Initialize singleton WebSocket server for Twilio Media Streams\n  initializeMediaStreamServer(httpServer);\n\n  return httpServer;\n}\n","path":null,"size_bytes":268888,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"client/src/components/dashboard/ProductionOverview.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Button } from \"@/components/ui/button\";\nimport { ChevronRight, Factory, Columns, DoorOpen, CheckCircle, Cog } from \"lucide-react\";\n\ninterface ProductionStage {\n  statusKey: string;\n  label: string;\n  jobCount: number;\n  progress: number;\n}\n\ninterface ProductionOverviewProps {\n  stages: ProductionStage[];\n  totalActiveJobs: number;\n  onViewProduction?: () => void;\n}\n\nconst iconMap: Record<string, typeof Factory> = {\n  manufacturing_posts: Columns,\n  manufacturing_panels: Factory,\n  manufacturing_gates: DoorOpen,\n  qa_check: CheckCircle,\n  cutting: Factory,\n  routing: Cog,\n  assembly: Factory,\n  qa: CheckCircle,\n};\n\nconst colorMap: Record<string, string> = {\n  manufacturing_posts: \"bg-chart-1\",\n  manufacturing_panels: \"bg-chart-2\",\n  manufacturing_gates: \"bg-chart-3\",\n  qa_check: \"bg-chart-4\",\n  cutting: \"bg-chart-1\",\n  routing: \"bg-chart-2\",\n  assembly: \"bg-chart-3\",\n  qa: \"bg-chart-4\",\n};\n\nexport function ProductionOverview({\n  stages,\n  totalActiveJobs,\n  onViewProduction,\n}: ProductionOverviewProps) {\n  return (\n    <Card>\n      <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-4\">\n        <div>\n          <CardTitle className=\"text-base font-semibold\">Production Overview</CardTitle>\n          <p className=\"text-xs text-muted-foreground mt-1\">{totalActiveJobs} jobs in production</p>\n        </div>\n        {onViewProduction && (\n          <Button variant=\"ghost\" size=\"sm\" onClick={onViewProduction} data-testid=\"button-view-production\">\n            Manage\n            <ChevronRight className=\"ml-1 h-4 w-4\" />\n          </Button>\n        )}\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        {stages.map((stage, index) => {\n          const Icon = iconMap[stage.statusKey] || Factory;\n          const colorClass = colorMap[stage.statusKey] || `bg-chart-${(index % 4) + 1}`;\n          return (\n            <div key={stage.statusKey} className=\"space-y-2\" data-testid={`production-stage-${stage.statusKey}`}>\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                  <div className={`flex h-6 w-6 items-center justify-center rounded ${colorClass}/10`}>\n                    <Icon className={`h-3.5 w-3.5 ${colorClass.replace('bg-', 'text-')}`} />\n                  </div>\n                  <span className=\"text-sm font-medium\">{stage.label}</span>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <span className=\"text-sm text-muted-foreground\">{stage.jobCount} jobs</span>\n                  <span className=\"text-xs font-medium\">{stage.progress}%</span>\n                </div>\n              </div>\n              <Progress value={stage.progress} className=\"h-2\" />\n            </div>\n          );\n        })}\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":3000,"size_tokens":null},"client/src/components/layout/Header.tsx":{"content":"import { Bell, Check, CheckCheck, Loader2 } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { SidebarTrigger } from \"@/components/ui/sidebar\";\nimport { ThemeToggle } from \"./ThemeToggle\";\nimport { GlobalSearch } from \"./GlobalSearch\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Notification } from \"@shared/schema\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport { useLocation } from \"wouter\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\n\nconst CURRENT_USER_ID = \"16721d3b-b980-4991-a279-767ce2777b9e\";\n\ninterface HeaderProps {\n  title?: string;\n}\n\nexport function Header({ title }: HeaderProps) {\n  const [, navigate] = useLocation();\n\n  const { data: notifications = [], isLoading } = useQuery<Notification[]>({\n    queryKey: [`/api/notifications?userId=${CURRENT_USER_ID}`],\n    refetchInterval: 30000,\n  });\n\n  const unreadCount = notifications.filter(n => !n.isRead).length;\n\n  const markReadMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"POST\", `/api/notifications/${id}/read`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/notifications?userId=${CURRENT_USER_ID}`] });\n    },\n  });\n\n  const markAllReadMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"POST\", \"/api/notifications/read-all\", { userId: CURRENT_USER_ID });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/notifications?userId=${CURRENT_USER_ID}`] });\n    },\n  });\n\n  const handleNotificationClick = (notification: Notification) => {\n    if (!notification.isRead) {\n      markReadMutation.mutate(notification.id);\n    }\n    \n    if (notification.relatedEntityType && notification.relatedEntityId) {\n      const path = getEntityPath(notification.relatedEntityType, notification.relatedEntityId);\n      if (path) {\n        navigate(path);\n      }\n    }\n  };\n\n  const getEntityPath = (entityType: string, entityId: string): string | null => {\n    switch (entityType) {\n      case \"lead\":\n        return \"/leads\";\n      case \"quote\":\n        return \"/quotes\";\n      case \"job\":\n        return \"/jobs\";\n      case \"payment\":\n        return \"/payments\";\n      case \"client\":\n        return \"/clients\";\n      case \"schedule\":\n        return \"/schedule\";\n      case \"sms_conversation\":\n      case \"new_message\":\n        return \"/messages\";\n      default:\n        return null;\n    }\n  };\n\n  const getNotificationIcon = (type: string) => {\n    switch (type) {\n      case \"lead_new\":\n      case \"lead_assigned\":\n        return \"user-plus\";\n      case \"quote_approved\":\n      case \"quote_sent\":\n        return \"file-text\";\n      case \"payment_received\":\n        return \"credit-card\";\n      case \"job_complete\":\n      case \"job_scheduled\":\n        return \"check-circle\";\n      default:\n        return \"bell\";\n    }\n  };\n\n  return (\n    <header className=\"flex h-14 items-center justify-between gap-4 border-b px-4 bg-background\">\n      <div className=\"flex items-center gap-4\">\n        <SidebarTrigger data-testid=\"button-sidebar-toggle\" />\n        {title && (\n          <h1 className=\"text-lg font-semibold\" data-testid=\"text-page-title\">{title}</h1>\n        )}\n      </div>\n\n      <div className=\"flex flex-1 items-center justify-center max-w-md\">\n        <GlobalSearch />\n      </div>\n\n      <div className=\"flex items-center gap-2\">\n        <DropdownMenu>\n          <DropdownMenuTrigger asChild>\n            <Button variant=\"ghost\" size=\"icon\" className=\"relative\" data-testid=\"button-notifications\">\n              <Bell className=\"h-4 w-4\" />\n              {unreadCount > 0 && (\n                <Badge \n                  variant=\"destructive\" \n                  className=\"absolute -right-1 -top-1 h-5 w-5 rounded-full p-0 flex items-center justify-center text-[10px]\"\n                >\n                  {unreadCount > 9 ? \"9+\" : unreadCount}\n                </Badge>\n              )}\n            </Button>\n          </DropdownMenuTrigger>\n          <DropdownMenuContent align=\"end\" className=\"w-80\">\n            <div className=\"flex items-center justify-between px-2 py-1.5\">\n              <DropdownMenuLabel className=\"p-0\">Notifications</DropdownMenuLabel>\n              {unreadCount > 0 && (\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className=\"h-auto py-1 px-2 text-xs\"\n                  onClick={(e) => {\n                    e.preventDefault();\n                    markAllReadMutation.mutate();\n                  }}\n                  disabled={markAllReadMutation.isPending}\n                  data-testid=\"button-mark-all-read\"\n                >\n                  {markAllReadMutation.isPending ? (\n                    <Loader2 className=\"h-3 w-3 animate-spin mr-1\" />\n                  ) : (\n                    <CheckCheck className=\"h-3 w-3 mr-1\" />\n                  )}\n                  Mark all read\n                </Button>\n              )}\n            </div>\n            <DropdownMenuSeparator />\n            <ScrollArea className=\"max-h-80\">\n              {isLoading ? (\n                <div className=\"flex items-center justify-center py-6\">\n                  <Loader2 className=\"h-5 w-5 animate-spin text-muted-foreground\" />\n                </div>\n              ) : notifications.length === 0 ? (\n                <div className=\"py-6 text-center text-sm text-muted-foreground\">\n                  No notifications\n                </div>\n              ) : (\n                notifications.slice(0, 10).map((notification) => (\n                  <DropdownMenuItem \n                    key={notification.id}\n                    className={`flex flex-col items-start gap-1 py-3 cursor-pointer ${\n                      !notification.isRead ? \"bg-muted/50\" : \"\"\n                    }`}\n                    onClick={() => handleNotificationClick(notification)}\n                    data-testid={`notification-item-${notification.id}`}\n                  >\n                    <div className=\"flex items-center justify-between w-full gap-2\">\n                      <span className=\"font-medium text-sm\">{notification.title}</span>\n                      {!notification.isRead && (\n                        <span className=\"h-2 w-2 rounded-full bg-primary shrink-0\" />\n                      )}\n                    </div>\n                    <span className=\"text-xs text-muted-foreground line-clamp-2\">\n                      {notification.message}\n                    </span>\n                    <span className=\"text-xs text-muted-foreground\">\n                      {formatDistanceToNow(new Date(notification.createdAt), { addSuffix: true })}\n                    </span>\n                  </DropdownMenuItem>\n                ))\n              )}\n            </ScrollArea>\n          </DropdownMenuContent>\n        </DropdownMenu>\n        <ThemeToggle />\n      </div>\n    </header>\n  );\n}\n","path":null,"size_bytes":7237,"size_tokens":null},"client/src/components/examples/LeadCardExample.tsx":{"content":"import { LeadCard } from \"@/components/leads/LeadCard\";\n\nexport default function LeadCardExample() {\n  const lead = {\n    id: \"lead-001\",\n    leadNumber: \"PVC-001\",\n    clientName: \"Sarah Mitchell\",\n    phone: \"0412 345 678\",\n    email: \"sarah.mitchell@email.com\",\n    address: \"42 Ocean Drive, Scarborough WA 6019\",\n    source: \"Website\",\n    fenceStyle: \"Hampton Style - 1.8m height\",\n    leadType: \"public\" as const,\n    status: \"new\" as const,\n    assignedTo: {\n      name: \"Dave\",\n      initials: \"DV\",\n    },\n    createdAt: \"2h ago\",\n  };\n\n  return (\n    <div className=\"p-4 max-w-sm\">\n      <LeadCard\n        lead={lead}\n        onClick={() => console.log(\"Lead clicked\")}\n        onCreateQuote={() => console.log(\"Create quote\")}\n        onAddNote={() => console.log(\"Add note\")}\n        onFollowUp={() => console.log(\"Follow up\")}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":867,"size_tokens":null},"server/db.ts":{"content":"import { Pool, neonConfig } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-serverless';\nimport ws from \"ws\";\nimport * as schema from \"@shared/schema\";\n\nneonConfig.webSocketConstructor = ws;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle({ client: pool, schema });\n","path":null,"size_bytes":483,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/components/layout/GlobalSearch.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { Search, User, FileText, Briefcase, ClipboardList, X, Loader2 } from \"lucide-react\";\nimport { Input } from \"@/components/ui/input\";\nimport { useLocation } from \"wouter\";\nimport { cn } from \"@/lib/utils\";\nimport type { Client, Lead, Job, Quote } from \"@shared/schema\";\n\ninterface SearchResults {\n  clients: Client[];\n  leads: Lead[];\n  jobs: Job[];\n  quotes: Quote[];\n}\n\nexport function GlobalSearch() {\n  const [query, setQuery] = useState(\"\");\n  const [results, setResults] = useState<SearchResults | null>(null);\n  const [isOpen, setIsOpen] = useState(false);\n  const [isLoading, setIsLoading] = useState(false);\n  const [, setLocation] = useLocation();\n  const containerRef = useRef<HTMLDivElement>(null);\n  const inputRef = useRef<HTMLInputElement>(null);\n\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (containerRef.current && !containerRef.current.contains(event.target as Node)) {\n        setIsOpen(false);\n      }\n    };\n\n    document.addEventListener(\"mousedown\", handleClickOutside);\n    return () => document.removeEventListener(\"mousedown\", handleClickOutside);\n  }, []);\n\n  useEffect(() => {\n    const searchDebounce = setTimeout(async () => {\n      if (query.length >= 2) {\n        setIsLoading(true);\n        try {\n          const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);\n          if (response.ok) {\n            const data = await response.json();\n            setResults(data);\n            setIsOpen(true);\n          }\n        } catch (error) {\n          console.error(\"Search error:\", error);\n        } finally {\n          setIsLoading(false);\n        }\n      } else {\n        setResults(null);\n        setIsOpen(false);\n      }\n    }, 300);\n\n    return () => clearTimeout(searchDebounce);\n  }, [query]);\n\n  const handleResultClick = (type: string, id: string) => {\n    setIsOpen(false);\n    setQuery(\"\");\n    switch (type) {\n      case \"client\":\n        setLocation(`/clients?id=${id}`);\n        break;\n      case \"lead\":\n        setLocation(`/leads?id=${id}`);\n        break;\n      case \"job\":\n        setLocation(`/jobs?id=${id}`);\n        break;\n      case \"quote\":\n        setLocation(`/leads?quote=${id}`);\n        break;\n    }\n  };\n\n  const hasResults = results && (\n    results.clients.length > 0 ||\n    results.leads.length > 0 ||\n    results.jobs.length > 0 ||\n    results.quotes.length > 0\n  );\n\n  const noResults = results && !hasResults;\n\n  return (\n    <div className=\"relative w-full\" ref={containerRef}>\n      <div className=\"relative\">\n        <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n        <Input\n          ref={inputRef}\n          type=\"search\"\n          placeholder=\"Search jobs, clients, quotes...\"\n          className=\"pl-9 pr-9 w-full\"\n          data-testid=\"input-global-search\"\n          value={query}\n          onChange={(e) => setQuery(e.target.value)}\n          onFocus={() => results && setIsOpen(true)}\n        />\n        {isLoading && (\n          <Loader2 className=\"absolute right-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground animate-spin\" />\n        )}\n        {query && !isLoading && (\n          <button\n            onClick={() => {\n              setQuery(\"\");\n              setResults(null);\n              setIsOpen(false);\n            }}\n            className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\n          >\n            <X className=\"h-4 w-4\" />\n          </button>\n        )}\n      </div>\n\n      {isOpen && (\n        <div className=\"absolute top-full left-0 right-0 mt-1 bg-popover border rounded-md shadow-lg z-50 max-h-[400px] overflow-auto\">\n          {noResults && (\n            <div className=\"p-4 text-center text-muted-foreground text-sm\">\n              No results found for \"{query}\"\n            </div>\n          )}\n\n          {hasResults && (\n            <div className=\"py-2\">\n              {results.clients.length > 0 && (\n                <div>\n                  <div className=\"px-3 py-1.5 text-xs font-semibold text-muted-foreground uppercase tracking-wide\">\n                    Clients\n                  </div>\n                  {results.clients.map((client) => (\n                    <button\n                      key={client.id}\n                      onClick={() => handleResultClick(\"client\", client.id)}\n                      className={cn(\n                        \"w-full flex items-center gap-3 px-3 py-2 text-left hover-elevate\",\n                        \"focus:outline-none focus:bg-accent\"\n                      )}\n                      data-testid={`search-result-client-${client.id}`}\n                    >\n                      <User className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\n                      <div className=\"min-w-0 flex-1\">\n                        <p className=\"font-medium text-sm truncate\">{client.name}</p>\n                        <p className=\"text-xs text-muted-foreground truncate\">\n                          {client.email || client.phone}\n                        </p>\n                      </div>\n                      <span className=\"text-xs text-muted-foreground capitalize\">\n                        {client.clientType}\n                      </span>\n                    </button>\n                  ))}\n                </div>\n              )}\n\n              {results.leads.length > 0 && (\n                <div>\n                  <div className=\"px-3 py-1.5 text-xs font-semibold text-muted-foreground uppercase tracking-wide\">\n                    Leads\n                  </div>\n                  {results.leads.map((lead) => (\n                    <button\n                      key={lead.id}\n                      onClick={() => handleResultClick(\"lead\", lead.id)}\n                      className={cn(\n                        \"w-full flex items-center gap-3 px-3 py-2 text-left hover-elevate\",\n                        \"focus:outline-none focus:bg-accent\"\n                      )}\n                      data-testid={`search-result-lead-${lead.id}`}\n                    >\n                      <ClipboardList className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\n                      <div className=\"min-w-0 flex-1\">\n                        <p className=\"font-medium text-sm truncate\">{lead.description || lead.siteAddress}</p>\n                        <p className=\"text-xs text-muted-foreground truncate\">\n                          {lead.siteAddress}\n                        </p>\n                      </div>\n                      <span className=\"text-xs text-muted-foreground capitalize\">\n                        {lead.stage?.replace(\"_\", \" \")}\n                      </span>\n                    </button>\n                  ))}\n                </div>\n              )}\n\n              {results.jobs.length > 0 && (\n                <div>\n                  <div className=\"px-3 py-1.5 text-xs font-semibold text-muted-foreground uppercase tracking-wide\">\n                    Jobs\n                  </div>\n                  {results.jobs.map((job) => (\n                    <button\n                      key={job.id}\n                      onClick={() => handleResultClick(\"job\", job.id)}\n                      className={cn(\n                        \"w-full flex items-center gap-3 px-3 py-2 text-left hover-elevate\",\n                        \"focus:outline-none focus:bg-accent\"\n                      )}\n                      data-testid={`search-result-job-${job.id}`}\n                    >\n                      <Briefcase className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\n                      <div className=\"min-w-0 flex-1\">\n                        <p className=\"font-medium text-sm truncate font-mono\">{job.jobNumber}</p>\n                        <p className=\"text-xs text-muted-foreground truncate\">\n                          {job.siteAddress}\n                        </p>\n                      </div>\n                      <span className=\"text-xs text-muted-foreground capitalize\">\n                        {job.status?.replace(/_/g, \" \")}\n                      </span>\n                    </button>\n                  ))}\n                </div>\n              )}\n\n              {results.quotes.length > 0 && (\n                <div>\n                  <div className=\"px-3 py-1.5 text-xs font-semibold text-muted-foreground uppercase tracking-wide\">\n                    Quotes\n                  </div>\n                  {results.quotes.map((quote) => (\n                    <button\n                      key={quote.id}\n                      onClick={() => handleResultClick(\"quote\", quote.id)}\n                      className={cn(\n                        \"w-full flex items-center gap-3 px-3 py-2 text-left hover-elevate\",\n                        \"focus:outline-none focus:bg-accent\"\n                      )}\n                      data-testid={`search-result-quote-${quote.id}`}\n                    >\n                      <FileText className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\n                      <div className=\"min-w-0 flex-1\">\n                        <p className=\"font-medium text-sm truncate font-mono\">{quote.quoteNumber}</p>\n                        <p className=\"text-xs text-muted-foreground truncate\">\n                          {quote.siteAddress}\n                        </p>\n                      </div>\n                      <span className=\"text-xs text-muted-foreground\">\n                        ${parseFloat(quote.totalAmount).toLocaleString()}\n                      </span>\n                    </button>\n                  ))}\n                </div>\n              )}\n            </div>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":9743,"size_tokens":null},"client/src/components/pl/QuotePLPanel.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { format } from \"date-fns\";\nimport {\n  Calculator,\n  DollarSign,\n  TrendingUp,\n  TrendingDown,\n  Truck,\n  Clock,\n  Wrench,\n  Package,\n  Users,\n  MapPin,\n  Plus,\n  Trash2,\n  Edit2,\n  RefreshCw,\n  ChevronDown,\n  ChevronUp,\n  AlertTriangle,\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/components/ui/collapsible\";\nimport { Label } from \"@/components/ui/label\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport type { \n  QuoteCostComponent, \n  QuoteTrip, \n  QuoteAdminTime, \n  QuotePLSummary,\n  User \n} from \"@shared/schema\";\n\ninterface QuotePLPanelProps {\n  quoteId: string;\n  quoteTotalAmount: string;\n}\n\ntype CostCategory = \"materials\" | \"manufacturing_labour\" | \"install_labour\" | \"travel\" | \"admin\" | \"supplier_fees\" | \"third_party\" | \"ground_conditions\";\ntype TripType = \"site_quote\" | \"post_install\" | \"panel_install\" | \"gate_install\" | \"welder_dropoff\" | \"welder_pickup\" | \"powder_coat_dropoff\" | \"powder_coat_pickup\" | \"supplier_delivery\" | \"warranty\" | \"follow_up\";\ntype AdminActivityType = \"quote_creation\" | \"client_messaging\" | \"client_call\" | \"spec_gathering\" | \"scheduling\" | \"invoicing\" | \"follow_up\" | \"general_admin\";\n\nconst categoryLabels: Record<CostCategory, string> = {\n  materials: \"Materials\",\n  manufacturing_labour: \"Manufacturing Labour\",\n  install_labour: \"Installation Labour\",\n  travel: \"Travel\",\n  admin: \"Admin Time\",\n  supplier_fees: \"Supplier Delivery Fees\",\n  third_party: \"Third Party\",\n  ground_conditions: \"Ground Conditions\",\n};\n\nconst categoryIcons: Record<CostCategory, any> = {\n  materials: Package,\n  manufacturing_labour: Wrench,\n  install_labour: Users,\n  travel: Truck,\n  admin: Clock,\n  supplier_fees: Truck,\n  third_party: DollarSign,\n  ground_conditions: MapPin,\n};\n\nconst tripTypeLabels: Record<TripType, string> = {\n  site_quote: \"Site Quote\",\n  post_install: \"Post Installation\",\n  panel_install: \"Panel Installation\",\n  gate_install: \"Gate Installation\",\n  welder_dropoff: \"Welder Drop-off\",\n  welder_pickup: \"Welder Pick-up\",\n  powder_coat_dropoff: \"Powder Coat Drop-off\",\n  powder_coat_pickup: \"Powder Coat Pick-up\",\n  supplier_delivery: \"Supplier Delivery\",\n  warranty: \"Warranty\",\n  follow_up: \"Follow Up\",\n};\n\nconst adminActivityLabels: Record<AdminActivityType, string> = {\n  quote_creation: \"Quote Creation\",\n  client_messaging: \"Client Messaging\",\n  client_call: \"Client Call\",\n  spec_gathering: \"Spec Gathering\",\n  scheduling: \"Scheduling\",\n  invoicing: \"Invoicing\",\n  follow_up: \"Follow Up\",\n  general_admin: \"General Admin\",\n};\n\nexport function QuotePLPanel({ quoteId, quoteTotalAmount }: QuotePLPanelProps) {\n  const { toast } = useToast();\n  const [expandedSections, setExpandedSections] = useState<Set<string>>(new Set([\"summary\"]));\n  const [showAddCostDialog, setShowAddCostDialog] = useState(false);\n  const [showAddTripDialog, setShowAddTripDialog] = useState(false);\n  const [showAddAdminDialog, setShowAddAdminDialog] = useState(false);\n\n  const { data: plSummary, isLoading: summaryLoading, error: summaryError } = useQuery<QuotePLSummary>({\n    queryKey: [\"/api/quotes\", quoteId, \"pl-summary\"],\n    queryFn: async () => {\n      const res = await apiRequest(\"GET\", `/api/quotes/${quoteId}/pl-summary`);\n      return res.json();\n    },\n  });\n\n  const { data: costComponents = [], isLoading: costsLoading, error: costsError } = useQuery<QuoteCostComponent[]>({\n    queryKey: [\"/api/quotes\", quoteId, \"costs\"],\n    queryFn: async () => {\n      const res = await apiRequest(\"GET\", `/api/quotes/${quoteId}/costs`);\n      return res.json();\n    },\n  });\n\n  const { data: trips = [], isLoading: tripsLoading, error: tripsError } = useQuery<QuoteTrip[]>({\n    queryKey: [\"/api/quotes\", quoteId, \"trips\"],\n    queryFn: async () => {\n      const res = await apiRequest(\"GET\", `/api/quotes/${quoteId}/trips`);\n      return res.json();\n    },\n  });\n\n  const { data: adminTime = [], isLoading: adminLoading, error: adminError } = useQuery<QuoteAdminTime[]>({\n    queryKey: [\"/api/quotes\", quoteId, \"admin-time\"],\n    queryFn: async () => {\n      const res = await apiRequest(\"GET\", `/api/quotes/${quoteId}/admin-time`);\n      return res.json();\n    },\n  });\n\n  const { data: users = [] } = useQuery<User[]>({\n    queryKey: [\"/api/users\"],\n  });\n\n  const recalculateMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", `/api/quotes/${quoteId}/pl-summary/recalculate`);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/quotes\", quoteId, \"pl-summary\"] });\n      toast({ title: \"P&L summary recalculated\" });\n    },\n    onError: (error) => {\n      toast({ title: \"Failed to recalculate\", variant: \"destructive\" });\n    },\n  });\n\n  const addCostMutation = useMutation({\n    mutationFn: async (data: Partial<QuoteCostComponent>) => {\n      const res = await apiRequest(\"POST\", `/api/quotes/${quoteId}/costs`, data);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/quotes\", quoteId, \"costs\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/quotes\", quoteId, \"pl-summary\"] });\n      setShowAddCostDialog(false);\n      toast({ title: \"Cost added\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to add cost\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteCostMutation = useMutation({\n    mutationFn: async (costId: string) => {\n      await apiRequest(\"DELETE\", `/api/quotes/${quoteId}/costs/${costId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/quotes\", quoteId, \"costs\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/quotes\", quoteId, \"pl-summary\"] });\n      toast({ title: \"Cost removed\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to remove cost\", variant: \"destructive\" });\n    },\n  });\n\n  const addTripMutation = useMutation({\n    mutationFn: async (data: Partial<QuoteTrip>) => {\n      const res = await apiRequest(\"POST\", `/api/quotes/${quoteId}/trips`, data);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/quotes\", quoteId, \"trips\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/quotes\", quoteId, \"pl-summary\"] });\n      setShowAddTripDialog(false);\n      toast({ title: \"Trip added\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to add trip\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteTripMutation = useMutation({\n    mutationFn: async (tripId: string) => {\n      await apiRequest(\"DELETE\", `/api/quotes/${quoteId}/trips/${tripId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/quotes\", quoteId, \"trips\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/quotes\", quoteId, \"pl-summary\"] });\n      toast({ title: \"Trip removed\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to remove trip\", variant: \"destructive\" });\n    },\n  });\n\n  const addAdminMutation = useMutation({\n    mutationFn: async (data: Partial<QuoteAdminTime>) => {\n      const res = await apiRequest(\"POST\", `/api/quotes/${quoteId}/admin-time`, data);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/quotes\", quoteId, \"admin-time\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/quotes\", quoteId, \"pl-summary\"] });\n      setShowAddAdminDialog(false);\n      toast({ title: \"Admin time added\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to add admin time\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteAdminMutation = useMutation({\n    mutationFn: async (adminId: string) => {\n      await apiRequest(\"DELETE\", `/api/quotes/${quoteId}/admin-time/${adminId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/quotes\", quoteId, \"admin-time\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/quotes\", quoteId, \"pl-summary\"] });\n      toast({ title: \"Admin time removed\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to remove admin time\", variant: \"destructive\" });\n    },\n  });\n\n  const toggleSection = (section: string) => {\n    setExpandedSections((prev) => {\n      const next = new Set(prev);\n      if (next.has(section)) {\n        next.delete(section);\n      } else {\n        next.add(section);\n      }\n      return next;\n    });\n  };\n\n  const getUserName = (userId: string) => {\n    const user = users.find((u) => u.id === userId);\n    return user ? `${user.firstName} ${user.lastName}` : \"Unknown\";\n  };\n\n  const profitMargin = plSummary?.profitMarginPercent \n    ? parseFloat(plSummary.profitMarginPercent) \n    : 0;\n  const isHealthyMargin = profitMargin >= 20;\n\n  const isLoading = summaryLoading || costsLoading || tripsLoading || adminLoading;\n  const hasError = summaryError || costsError || tripsError || adminError;\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center p-8\">\n        <RefreshCw className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n        <span className=\"ml-2 text-muted-foreground\">Loading P&L data...</span>\n      </div>\n    );\n  }\n\n  if (hasError) {\n    return (\n      <div className=\"flex flex-col items-center justify-center p-8 text-center\">\n        <AlertTriangle className=\"h-8 w-8 text-destructive mb-2\" />\n        <p className=\"text-sm text-muted-foreground\">Failed to load P&L data</p>\n        <Button \n          variant=\"outline\" \n          size=\"sm\" \n          className=\"mt-3\"\n          onClick={() => {\n            queryClient.invalidateQueries({ queryKey: [\"/api/quotes\", quoteId] });\n          }}\n        >\n          <RefreshCw className=\"h-4 w-4 mr-2\" />\n          Retry\n        </Button>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-2\">\n          <Calculator className=\"h-5 w-5 text-primary\" />\n          <h3 className=\"font-semibold\">Profit & Loss Analysis</h3>\n          <Badge variant=\"outline\" className=\"text-xs\">Staff Only</Badge>\n        </div>\n        <Button\n          variant=\"outline\"\n          size=\"sm\"\n          onClick={() => recalculateMutation.mutate()}\n          disabled={recalculateMutation.isPending}\n          data-testid=\"button-recalculate-pl\"\n        >\n          <RefreshCw className={`h-4 w-4 mr-2 ${recalculateMutation.isPending ? \"animate-spin\" : \"\"}`} />\n          Recalculate\n        </Button>\n      </div>\n\n      <Card className={isHealthyMargin ? \"border-green-200 dark:border-green-900\" : \"border-orange-200 dark:border-orange-900\"}>\n        <CardContent className=\"pt-4\">\n          <div className=\"grid grid-cols-3 gap-4 text-center\">\n            <div>\n              <div className=\"text-sm text-muted-foreground\">Revenue</div>\n              <div className=\"text-xl font-bold text-green-600\" data-testid=\"text-pl-revenue\">\n                ${parseFloat(plSummary?.totalRevenue || quoteTotalAmount || \"0\").toLocaleString()}\n              </div>\n            </div>\n            <div>\n              <div className=\"text-sm text-muted-foreground\">Total Cost</div>\n              <div className=\"text-xl font-bold text-red-600\" data-testid=\"text-pl-cost\">\n                ${parseFloat(plSummary?.totalCost || \"0\").toLocaleString()}\n              </div>\n            </div>\n            <div>\n              <div className=\"text-sm text-muted-foreground\">Profit</div>\n              <div className={`text-xl font-bold flex items-center justify-center gap-1 ${profitMargin >= 0 ? \"text-green-600\" : \"text-red-600\"}`} data-testid=\"text-pl-profit\">\n                {profitMargin >= 0 ? <TrendingUp className=\"h-5 w-5\" /> : <TrendingDown className=\"h-5 w-5\" />}\n                ${parseFloat(plSummary?.profitAmount || \"0\").toLocaleString()}\n                <span className=\"text-sm\">({profitMargin.toFixed(1)}%)</span>\n              </div>\n            </div>\n          </div>\n          {!isHealthyMargin && profitMargin > 0 && (\n            <div className=\"mt-3 flex items-center gap-2 text-orange-600 text-sm\">\n              <AlertTriangle className=\"h-4 w-4\" />\n              <span>Margin below 20% target</span>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      <Collapsible open={expandedSections.has(\"costs\")} onOpenChange={() => toggleSection(\"costs\")}>\n        <CollapsibleTrigger asChild>\n          <Button variant=\"ghost\" className=\"w-full justify-between p-2\" data-testid=\"button-toggle-costs\">\n            <div className=\"flex items-center gap-2\">\n              <Package className=\"h-4 w-4\" />\n              <span>Cost Components ({costComponents.length})</span>\n            </div>\n            {expandedSections.has(\"costs\") ? <ChevronUp className=\"h-4 w-4\" /> : <ChevronDown className=\"h-4 w-4\" />}\n          </Button>\n        </CollapsibleTrigger>\n        <CollapsibleContent>\n          <Card>\n            <CardContent className=\"p-3 space-y-2\">\n              {costComponents.length === 0 ? (\n                <div className=\"text-center py-4 text-muted-foreground text-sm\">\n                  No cost components added yet\n                </div>\n              ) : (\n                <div className=\"space-y-2\">\n                  {costComponents.map((cost) => {\n                    const Icon = categoryIcons[cost.category as CostCategory] || DollarSign;\n                    return (\n                      <div key={cost.id} className=\"flex items-center justify-between p-2 rounded-md bg-muted/50\">\n                        <div className=\"flex items-center gap-2\">\n                          <Icon className=\"h-4 w-4 text-muted-foreground\" />\n                          <div>\n                            <div className=\"text-sm font-medium\">{cost.description || categoryLabels[cost.category as CostCategory]}</div>\n                            <div className=\"text-xs text-muted-foreground\">\n                              {cost.quantity}  ${parseFloat(cost.unitCost || \"0\").toFixed(2)}\n                            </div>\n                          </div>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <span className=\"font-medium\">${parseFloat(cost.totalCost || \"0\").toLocaleString()}</span>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            className=\"h-6 w-6 text-destructive\"\n                            onClick={() => deleteCostMutation.mutate(cost.id)}\n                            data-testid={`button-delete-cost-${cost.id}`}\n                          >\n                            <Trash2 className=\"h-3 w-3\" />\n                          </Button>\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              )}\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                className=\"w-full\"\n                onClick={() => setShowAddCostDialog(true)}\n                data-testid=\"button-add-cost\"\n              >\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Add Cost\n              </Button>\n            </CardContent>\n          </Card>\n        </CollapsibleContent>\n      </Collapsible>\n\n      <Collapsible open={expandedSections.has(\"trips\")} onOpenChange={() => toggleSection(\"trips\")}>\n        <CollapsibleTrigger asChild>\n          <Button variant=\"ghost\" className=\"w-full justify-between p-2\" data-testid=\"button-toggle-trips\">\n            <div className=\"flex items-center gap-2\">\n              <Truck className=\"h-4 w-4\" />\n              <span>Trips ({trips.length})</span>\n            </div>\n            {expandedSections.has(\"trips\") ? <ChevronUp className=\"h-4 w-4\" /> : <ChevronDown className=\"h-4 w-4\" />}\n          </Button>\n        </CollapsibleTrigger>\n        <CollapsibleContent>\n          <Card>\n            <CardContent className=\"p-3 space-y-2\">\n              {trips.length === 0 ? (\n                <div className=\"text-center py-4 text-muted-foreground text-sm\">\n                  No trips scheduled yet\n                </div>\n              ) : (\n                <div className=\"space-y-2\">\n                  {trips.map((trip) => (\n                    <div key={trip.id} className=\"flex items-center justify-between p-2 rounded-md bg-muted/50\">\n                      <div className=\"flex items-center gap-2\">\n                        <Truck className=\"h-4 w-4 text-muted-foreground\" />\n                        <div>\n                          <div className=\"text-sm font-medium\">{tripTypeLabels[trip.tripType as TripType]}</div>\n                          <div className=\"text-xs text-muted-foreground\">\n                            {trip.staffId ? getUserName(trip.staffId) : \"Unassigned\"}\n                            {trip.distanceKm && `  ${trip.distanceKm}km`}\n                            {trip.durationMinutes && `  ${trip.durationMinutes}min`}\n                          </div>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        {trip.travelCostTotal && (\n                          <span className=\"font-medium\">${parseFloat(trip.travelCostTotal).toLocaleString()}</span>\n                        )}\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          {trip.status}\n                        </Badge>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          className=\"h-6 w-6 text-destructive\"\n                          onClick={() => deleteTripMutation.mutate(trip.id)}\n                          data-testid={`button-delete-trip-${trip.id}`}\n                        >\n                          <Trash2 className=\"h-3 w-3\" />\n                        </Button>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                className=\"w-full\"\n                onClick={() => setShowAddTripDialog(true)}\n                data-testid=\"button-add-trip\"\n              >\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Add Trip\n              </Button>\n            </CardContent>\n          </Card>\n        </CollapsibleContent>\n      </Collapsible>\n\n      <Collapsible open={expandedSections.has(\"admin\")} onOpenChange={() => toggleSection(\"admin\")}>\n        <CollapsibleTrigger asChild>\n          <Button variant=\"ghost\" className=\"w-full justify-between p-2\" data-testid=\"button-toggle-admin\">\n            <div className=\"flex items-center gap-2\">\n              <Clock className=\"h-4 w-4\" />\n              <span>Admin Time ({adminTime.length})</span>\n            </div>\n            {expandedSections.has(\"admin\") ? <ChevronUp className=\"h-4 w-4\" /> : <ChevronDown className=\"h-4 w-4\" />}\n          </Button>\n        </CollapsibleTrigger>\n        <CollapsibleContent>\n          <Card>\n            <CardContent className=\"p-3 space-y-2\">\n              {adminTime.length === 0 ? (\n                <div className=\"text-center py-4 text-muted-foreground text-sm\">\n                  No admin time logged yet\n                </div>\n              ) : (\n                <div className=\"space-y-2\">\n                  {adminTime.map((admin) => (\n                    <div key={admin.id} className=\"flex items-center justify-between p-2 rounded-md bg-muted/50\">\n                      <div className=\"flex items-center gap-2\">\n                        <Clock className=\"h-4 w-4 text-muted-foreground\" />\n                        <div>\n                          <div className=\"text-sm font-medium\">{admin.activityType}</div>\n                          <div className=\"text-xs text-muted-foreground\">\n                            {admin.staffId ? getUserName(admin.staffId) : \"Unknown\"}\n                            {admin.durationMinutes && `  ${admin.durationMinutes}min`}\n                          </div>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        {admin.totalCost && (\n                          <span className=\"font-medium\">${parseFloat(admin.totalCost).toLocaleString()}</span>\n                        )}\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          className=\"h-6 w-6 text-destructive\"\n                          onClick={() => deleteAdminMutation.mutate(admin.id)}\n                          data-testid={`button-delete-admin-${admin.id}`}\n                        >\n                          <Trash2 className=\"h-3 w-3\" />\n                        </Button>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                className=\"w-full\"\n                onClick={() => setShowAddAdminDialog(true)}\n                data-testid=\"button-add-admin\"\n              >\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Add Admin Time\n              </Button>\n            </CardContent>\n          </Card>\n        </CollapsibleContent>\n      </Collapsible>\n\n      <Collapsible open={expandedSections.has(\"breakdown\")} onOpenChange={() => toggleSection(\"breakdown\")}>\n        <CollapsibleTrigger asChild>\n          <Button variant=\"ghost\" className=\"w-full justify-between p-2\" data-testid=\"button-toggle-breakdown\">\n            <div className=\"flex items-center gap-2\">\n              <DollarSign className=\"h-4 w-4\" />\n              <span>Cost Breakdown</span>\n            </div>\n            {expandedSections.has(\"breakdown\") ? <ChevronUp className=\"h-4 w-4\" /> : <ChevronDown className=\"h-4 w-4\" />}\n          </Button>\n        </CollapsibleTrigger>\n        <CollapsibleContent>\n          <Card>\n            <CardContent className=\"p-3 space-y-2\">\n              <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Materials</span>\n                  <span>${parseFloat(plSummary?.materialsCost || \"0\").toLocaleString()}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Manufacturing</span>\n                  <span>${parseFloat(plSummary?.manufacturingLabourCost || \"0\").toLocaleString()}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Installation</span>\n                  <span>${parseFloat(plSummary?.installationLabourCost || \"0\").toLocaleString()}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Travel</span>\n                  <span>${parseFloat(plSummary?.travelCost || \"0\").toLocaleString()}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Admin</span>\n                  <span>${parseFloat(plSummary?.adminCost || \"0\").toLocaleString()}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Supplier Fees</span>\n                  <span>${parseFloat(plSummary?.supplierDeliveryFees || \"0\").toLocaleString()}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Third Party</span>\n                  <span>${parseFloat(plSummary?.thirdPartyCost || \"0\").toLocaleString()}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Ground Conditions</span>\n                  <span>${parseFloat(plSummary?.groundConditionsCost || \"0\").toLocaleString()}</span>\n                </div>\n              </div>\n              <Separator />\n              <div className=\"flex justify-between font-medium\">\n                <span>Total Cost</span>\n                <span>${parseFloat(plSummary?.totalCost || \"0\").toLocaleString()}</span>\n              </div>\n            </CardContent>\n          </Card>\n        </CollapsibleContent>\n      </Collapsible>\n\n      <AddCostDialog\n        open={showAddCostDialog}\n        onClose={() => setShowAddCostDialog(false)}\n        onSubmit={(data) => addCostMutation.mutate(data)}\n        isPending={addCostMutation.isPending}\n      />\n\n      <AddTripDialog\n        open={showAddTripDialog}\n        onClose={() => setShowAddTripDialog(false)}\n        onSubmit={(data) => addTripMutation.mutate(data)}\n        isPending={addTripMutation.isPending}\n        users={users}\n      />\n\n      <AddAdminTimeDialog\n        open={showAddAdminDialog}\n        onClose={() => setShowAddAdminDialog(false)}\n        onSubmit={(data) => addAdminMutation.mutate(data)}\n        isPending={addAdminMutation.isPending}\n        users={users}\n      />\n    </div>\n  );\n}\n\nfunction AddCostDialog({\n  open,\n  onClose,\n  onSubmit,\n  isPending,\n}: {\n  open: boolean;\n  onClose: () => void;\n  onSubmit: (data: Partial<QuoteCostComponent>) => void;\n  isPending: boolean;\n}) {\n  const [category, setCategory] = useState<CostCategory>(\"materials\");\n  const [description, setDescription] = useState(\"\");\n  const [quantity, setQuantity] = useState(\"1\");\n  const [unitCost, setUnitCost] = useState(\"\");\n\n  const handleSubmit = () => {\n    const qty = parseFloat(quantity) || 1;\n    const cost = parseFloat(unitCost) || 0;\n    onSubmit({\n      category,\n      description,\n      quantity: qty.toString(),\n      unitCost: cost.toString(),\n      totalCost: (qty * cost).toString(),\n    });\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent>\n        <DialogHeader>\n          <DialogTitle>Add Cost Component</DialogTitle>\n        </DialogHeader>\n        <div className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <Label>Category</Label>\n            <Select value={category} onValueChange={(v) => setCategory(v as CostCategory)}>\n              <SelectTrigger data-testid=\"select-cost-category\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                {Object.entries(categoryLabels).map(([key, label]) => (\n                  <SelectItem key={key} value={key}>{label}</SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n          <div className=\"space-y-2\">\n            <Label>Description</Label>\n            <Input\n              value={description}\n              onChange={(e) => setDescription(e.target.value)}\n              placeholder=\"e.g., Post material costs\"\n              data-testid=\"input-cost-description\"\n            />\n          </div>\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label>Quantity</Label>\n              <Input\n                type=\"number\"\n                value={quantity}\n                onChange={(e) => setQuantity(e.target.value)}\n                data-testid=\"input-cost-quantity\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Unit Cost ($)</Label>\n              <Input\n                type=\"number\"\n                step=\"0.01\"\n                value={unitCost}\n                onChange={(e) => setUnitCost(e.target.value)}\n                placeholder=\"0.00\"\n                data-testid=\"input-cost-unit-price\"\n              />\n            </div>\n          </div>\n          <div className=\"text-right text-muted-foreground\">\n            Total: ${((parseFloat(quantity) || 0) * (parseFloat(unitCost) || 0)).toFixed(2)}\n          </div>\n        </div>\n        <DialogFooter>\n          <Button variant=\"outline\" onClick={onClose}>Cancel</Button>\n          <Button onClick={handleSubmit} disabled={isPending} data-testid=\"button-submit-cost\">\n            {isPending ? \"Adding...\" : \"Add Cost\"}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction AddTripDialog({\n  open,\n  onClose,\n  onSubmit,\n  isPending,\n  users,\n}: {\n  open: boolean;\n  onClose: () => void;\n  onSubmit: (data: Partial<QuoteTrip>) => void;\n  isPending: boolean;\n  users: User[];\n}) {\n  const [tripType, setTripType] = useState<TripType>(\"panel_install\");\n  const [staffId, setStaffId] = useState(\"\");\n  const [distanceKm, setDistanceKm] = useState(\"\");\n  const [durationMinutes, setDurationMinutes] = useState(\"\");\n  const [travelCost, setTravelCost] = useState(\"\");\n\n  const handleSubmit = () => {\n    onSubmit({\n      tripType,\n      staffId,\n      distanceKm: distanceKm || undefined,\n      durationMinutes: durationMinutes ? parseInt(durationMinutes) : undefined,\n      travelCostTotal: travelCost || undefined,\n    });\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent>\n        <DialogHeader>\n          <DialogTitle>Add Trip</DialogTitle>\n        </DialogHeader>\n        <div className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <Label>Trip Type</Label>\n            <Select value={tripType} onValueChange={(v) => setTripType(v as TripType)}>\n              <SelectTrigger data-testid=\"select-trip-type\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                {Object.entries(tripTypeLabels).map(([key, label]) => (\n                  <SelectItem key={key} value={key}>{label}</SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n          <div className=\"space-y-2\">\n            <Label>Assigned Staff</Label>\n            <Select value={staffId} onValueChange={setStaffId}>\n              <SelectTrigger data-testid=\"select-trip-staff\">\n                <SelectValue placeholder=\"Select staff member\" />\n              </SelectTrigger>\n              <SelectContent>\n                {users.filter(u => u.role === 'installer' || u.role === 'sales' || u.role === 'admin').map((user) => (\n                  <SelectItem key={user.id} value={user.id}>\n                    {user.firstName} {user.lastName}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n          <div className=\"grid grid-cols-3 gap-4\">\n            <div className=\"space-y-2\">\n              <Label>Distance (km)</Label>\n              <Input\n                type=\"number\"\n                value={distanceKm}\n                onChange={(e) => setDistanceKm(e.target.value)}\n                placeholder=\"0\"\n                data-testid=\"input-trip-distance\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Duration (min)</Label>\n              <Input\n                type=\"number\"\n                value={durationMinutes}\n                onChange={(e) => setDurationMinutes(e.target.value)}\n                placeholder=\"0\"\n                data-testid=\"input-trip-duration\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Travel Cost ($)</Label>\n              <Input\n                type=\"number\"\n                step=\"0.01\"\n                value={travelCost}\n                onChange={(e) => setTravelCost(e.target.value)}\n                placeholder=\"0.00\"\n                data-testid=\"input-trip-cost\"\n              />\n            </div>\n          </div>\n        </div>\n        <DialogFooter>\n          <Button variant=\"outline\" onClick={onClose}>Cancel</Button>\n          <Button onClick={handleSubmit} disabled={isPending || !staffId} data-testid=\"button-submit-trip\">\n            {isPending ? \"Adding...\" : \"Add Trip\"}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction AddAdminTimeDialog({\n  open,\n  onClose,\n  onSubmit,\n  isPending,\n  users,\n}: {\n  open: boolean;\n  onClose: () => void;\n  onSubmit: (data: Partial<QuoteAdminTime>) => void;\n  isPending: boolean;\n  users: User[];\n}) {\n  const [activityType, setActivityType] = useState<AdminActivityType>(\"quote_creation\");\n  const [staffId, setStaffId] = useState(\"\");\n  const [durationMinutes, setDurationMinutes] = useState(\"\");\n  const [hourlyRate, setHourlyRate] = useState(\"50\");\n\n  const handleSubmit = () => {\n    const minutes = parseInt(durationMinutes) || 0;\n    const rate = parseFloat(hourlyRate) || 0;\n    const totalCost = (minutes / 60) * rate;\n    onSubmit({\n      activityType,\n      staffId,\n      durationMinutes: minutes,\n      hourlyRate: rate.toString(),\n      totalCost: totalCost.toString(),\n    });\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent>\n        <DialogHeader>\n          <DialogTitle>Add Admin Time</DialogTitle>\n        </DialogHeader>\n        <div className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <Label>Activity Type</Label>\n            <Select value={activityType} onValueChange={(v) => setActivityType(v as AdminActivityType)}>\n              <SelectTrigger data-testid=\"select-admin-type\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                {Object.entries(adminActivityLabels).map(([key, label]) => (\n                  <SelectItem key={key} value={key}>{label}</SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n          <div className=\"space-y-2\">\n            <Label>Staff Member</Label>\n            <Select value={staffId} onValueChange={setStaffId}>\n              <SelectTrigger data-testid=\"select-admin-staff\">\n                <SelectValue placeholder=\"Select staff member\" />\n              </SelectTrigger>\n              <SelectContent>\n                {users.map((user) => (\n                  <SelectItem key={user.id} value={user.id}>\n                    {user.firstName} {user.lastName}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label>Duration (minutes)</Label>\n              <Input\n                type=\"number\"\n                value={durationMinutes}\n                onChange={(e) => setDurationMinutes(e.target.value)}\n                placeholder=\"0\"\n                data-testid=\"input-admin-duration\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Hourly Rate ($)</Label>\n              <Input\n                type=\"number\"\n                step=\"0.01\"\n                value={hourlyRate}\n                onChange={(e) => setHourlyRate(e.target.value)}\n                data-testid=\"input-admin-rate\"\n              />\n            </div>\n          </div>\n          <div className=\"text-right text-muted-foreground\">\n            Total: ${(((parseInt(durationMinutes) || 0) / 60) * (parseFloat(hourlyRate) || 0)).toFixed(2)}\n          </div>\n        </div>\n        <DialogFooter>\n          <Button variant=\"outline\" onClick={onClose}>Cancel</Button>\n          <Button onClick={handleSubmit} disabled={isPending || !staffId} data-testid=\"button-submit-admin\">\n            {isPending ? \"Adding...\" : \"Add Time\"}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":36461,"size_tokens":null},"client/src/pages/organisation/Workflows.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { GitBranch, Plus, Pencil, Trash2, Search, Filter, Eye, Clock } from \"lucide-react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { Workflow, Department, WorkflowVersion } from \"@shared/schema\";\nimport { format } from \"date-fns\";\n\nconst workflowFormSchema = z.object({\n  title: z.string().min(1, \"Title is required\"),\n  description: z.string().optional(),\n  category: z.enum([\"sales\", \"production\", \"install\", \"warehouse\", \"admin\", \"hr\", \"safety\", \"other\"]),\n  status: z.enum([\"active\", \"draft\", \"archived\"]).default(\"draft\"),\n  departmentId: z.string().optional(),\n});\n\ntype WorkflowFormValues = z.infer<typeof workflowFormSchema>;\n\nconst categoryLabels: Record<string, string> = {\n  sales: \"Sales\",\n  production: \"Production\",\n  install: \"Installation\",\n  warehouse: \"Warehouse\",\n  admin: \"Admin\",\n  hr: \"HR\",\n  safety: \"Safety\",\n  other: \"Other\",\n};\n\nconst statusColors: Record<string, string> = {\n  active: \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\",\n  draft: \"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200\",\n  archived: \"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300\",\n};\n\nexport default function Workflows() {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [categoryFilter, setCategoryFilter] = useState<string>(\"\");\n  const [statusFilter, setStatusFilter] = useState<string>(\"\");\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [editingWorkflow, setEditingWorkflow] = useState<Workflow | null>(null);\n  const [viewingWorkflow, setViewingWorkflow] = useState<Workflow | null>(null);\n  const [deletingWorkflow, setDeletingWorkflow] = useState<Workflow | null>(null);\n\n  const { data: workflows = [], isLoading } = useQuery<Workflow[]>({\n    queryKey: ['/api/organisation/workflows'],\n  });\n\n  const { data: departments = [] } = useQuery<Department[]>({\n    queryKey: ['/api/organisation/departments'],\n  });\n\n  const { data: workflowVersions = [] } = useQuery<WorkflowVersion[]>({\n    queryKey: ['/api/organisation/workflows', viewingWorkflow?.id, 'versions'],\n    enabled: !!viewingWorkflow,\n  });\n\n  const form = useForm<WorkflowFormValues>({\n    resolver: zodResolver(workflowFormSchema),\n    defaultValues: {\n      title: \"\",\n      description: \"\",\n      category: \"other\",\n      status: \"draft\",\n      departmentId: \"\",\n    },\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: WorkflowFormValues) => {\n      return apiRequest('POST', '/api/organisation/workflows', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/organisation/workflows'] });\n      setIsCreateDialogOpen(false);\n      form.reset();\n      toast({ title: \"Workflow created successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to create workflow\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: WorkflowFormValues }) => {\n      return apiRequest('PATCH', `/api/organisation/workflows/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/organisation/workflows'] });\n      setEditingWorkflow(null);\n      form.reset();\n      toast({ title: \"Workflow updated successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to update workflow\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest('DELETE', `/api/organisation/workflows/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/organisation/workflows'] });\n      setDeletingWorkflow(null);\n      toast({ title: \"Workflow deleted successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to delete workflow\", variant: \"destructive\" });\n    },\n  });\n\n  const handleCreateSubmit = (data: WorkflowFormValues) => {\n    createMutation.mutate(data);\n  };\n\n  const handleEditSubmit = (data: WorkflowFormValues) => {\n    if (editingWorkflow) {\n      updateMutation.mutate({ id: editingWorkflow.id, data });\n    }\n  };\n\n  const openEditDialog = (workflow: Workflow) => {\n    setEditingWorkflow(workflow);\n    form.reset({\n      title: workflow.title,\n      description: workflow.description || \"\",\n      category: workflow.category as any,\n      status: workflow.status as any,\n      departmentId: workflow.departmentId || \"\",\n    });\n  };\n\n  const filteredWorkflows = workflows.filter(workflow => {\n    const matchesSearch = \n      workflow.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      workflow.description?.toLowerCase().includes(searchQuery.toLowerCase());\n    const matchesCategory = !categoryFilter || workflow.category === categoryFilter;\n    const matchesStatus = !statusFilter || workflow.status === statusFilter;\n    return matchesSearch && matchesCategory && matchesStatus;\n  });\n\n  const getDepartmentName = (departmentId: string | null) => {\n    if (!departmentId) return null;\n    const department = departments.find(d => d.id === departmentId);\n    return department?.name;\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-semibold text-foreground\" data-testid=\"text-page-title\">Workflows & SOPs</h1>\n          <p className=\"text-muted-foreground\">Standard operating procedures and workflows</p>\n        </div>\n        <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-workflow\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              New Workflow\n            </Button>\n          </DialogTrigger>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Create Workflow</DialogTitle>\n              <DialogDescription>Add a new workflow or SOP to your organisation.</DialogDescription>\n            </DialogHeader>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(handleCreateSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"title\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Title</FormLabel>\n                      <FormControl>\n                        <Input {...field} placeholder=\"e.g. New Lead Processing\" data-testid=\"input-workflow-title\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"description\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Description</FormLabel>\n                      <FormControl>\n                        <Textarea {...field} placeholder=\"Workflow description...\" data-testid=\"input-workflow-description\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"category\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Category</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-workflow-category\">\n                              <SelectValue placeholder=\"Select category\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            {Object.entries(categoryLabels).map(([value, label]) => (\n                              <SelectItem key={value} value={value}>{label}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"status\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Status</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-workflow-status\">\n                              <SelectValue placeholder=\"Select status\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            <SelectItem value=\"draft\">Draft</SelectItem>\n                            <SelectItem value=\"active\">Active</SelectItem>\n                            <SelectItem value=\"archived\">Archived</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n                <FormField\n                  control={form.control}\n                  name=\"departmentId\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Department</FormLabel>\n                      <Select onValueChange={field.onChange} defaultValue={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-workflow-department\">\n                            <SelectValue placeholder=\"Select department\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {departments.map((dept) => (\n                            <SelectItem key={dept.id} value={dept.id}>{dept.name}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <DialogFooter>\n                  <Button type=\"submit\" disabled={createMutation.isPending} data-testid=\"button-submit-workflow\">\n                    {createMutation.isPending ? \"Creating...\" : \"Create Workflow\"}\n                  </Button>\n                </DialogFooter>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <div className=\"flex flex-wrap gap-4\">\n        <div className=\"relative flex-1 min-w-[200px] max-w-md\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search workflows...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-9\"\n            data-testid=\"input-search-workflows\"\n          />\n        </div>\n        <Select value={categoryFilter || \"all\"} onValueChange={(val) => setCategoryFilter(val === \"all\" ? \"\" : val)}>\n          <SelectTrigger className=\"w-40\" data-testid=\"filter-category\">\n            <Filter className=\"h-4 w-4 mr-2\" />\n            <SelectValue placeholder=\"Category\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Categories</SelectItem>\n            {Object.entries(categoryLabels).map(([value, label]) => (\n              <SelectItem key={value} value={value}>{label}</SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n        <Select value={statusFilter || \"all\"} onValueChange={(val) => setStatusFilter(val === \"all\" ? \"\" : val)}>\n          <SelectTrigger className=\"w-32\" data-testid=\"filter-status\">\n            <SelectValue placeholder=\"Status\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Status</SelectItem>\n            <SelectItem value=\"active\">Active</SelectItem>\n            <SelectItem value=\"draft\">Draft</SelectItem>\n            <SelectItem value=\"archived\">Archived</SelectItem>\n          </SelectContent>\n        </Select>\n      </div>\n\n      {isLoading ? (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {[1, 2, 3].map((i) => (\n            <Card key={i} className=\"animate-pulse\">\n              <CardHeader className=\"space-y-2\">\n                <div className=\"h-5 w-32 bg-muted rounded\"></div>\n                <div className=\"h-4 w-48 bg-muted rounded\"></div>\n              </CardHeader>\n            </Card>\n          ))}\n        </div>\n      ) : filteredWorkflows.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-12\">\n            <GitBranch className=\"h-12 w-12 text-muted-foreground mb-4\" />\n            <h3 className=\"text-lg font-medium\">No workflows found</h3>\n            <p className=\"text-muted-foreground text-sm\">\n              {searchQuery || categoryFilter || statusFilter ? \"Try adjusting your filters\" : \"Create your first workflow to get started\"}\n            </p>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {filteredWorkflows.map((workflow) => (\n            <Card key={workflow.id} data-testid={`card-workflow-${workflow.id}`}>\n              <CardHeader>\n                <div className=\"flex items-start justify-between gap-2\">\n                  <div className=\"flex items-start gap-3 min-w-0\">\n                    <div className=\"flex h-10 w-10 shrink-0 items-center justify-center rounded-md bg-primary/10 text-primary\">\n                      <GitBranch className=\"h-5 w-5\" />\n                    </div>\n                    <div className=\"min-w-0\">\n                      <CardTitle className=\"text-base truncate\">{workflow.title}</CardTitle>\n                      {workflow.description && (\n                        <CardDescription className=\"line-clamp-2\">{workflow.description}</CardDescription>\n                      )}\n                    </div>\n                  </div>\n                  <div className=\"flex gap-1 shrink-0\">\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\" \n                      className=\"h-8 w-8\"\n                      onClick={() => setViewingWorkflow(workflow)}\n                      data-testid={`button-view-workflow-${workflow.id}`}\n                    >\n                      <Eye className=\"h-4 w-4\" />\n                    </Button>\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\" \n                      className=\"h-8 w-8\"\n                      onClick={() => openEditDialog(workflow)}\n                      data-testid={`button-edit-workflow-${workflow.id}`}\n                    >\n                      <Pencil className=\"h-4 w-4\" />\n                    </Button>\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\" \n                      className=\"h-8 w-8 text-destructive\"\n                      onClick={() => setDeletingWorkflow(workflow)}\n                      data-testid={`button-delete-workflow-${workflow.id}`}\n                    >\n                      <Trash2 className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"flex flex-wrap items-center gap-2\">\n                  <Badge variant=\"outline\">{categoryLabels[workflow.category] || workflow.category}</Badge>\n                  <Badge className={statusColors[workflow.status]}>\n                    {workflow.status.charAt(0).toUpperCase() + workflow.status.slice(1)}\n                  </Badge>\n                  {workflow.departmentId && (\n                    <Badge variant=\"secondary\">{getDepartmentName(workflow.departmentId)}</Badge>\n                  )}\n                </div>\n                <div className=\"mt-3 flex items-center gap-2 text-xs text-muted-foreground\">\n                  <Clock className=\"h-3 w-3\" />\n                  <span>Updated {format(new Date(workflow.updatedAt), 'dd MMM yyyy')}</span>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n\n      <Dialog open={!!editingWorkflow} onOpenChange={(open) => !open && setEditingWorkflow(null)}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Edit Workflow</DialogTitle>\n            <DialogDescription>Update workflow details.</DialogDescription>\n          </DialogHeader>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(handleEditSubmit)} className=\"space-y-4\">\n              <FormField\n                control={form.control}\n                name=\"title\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Title</FormLabel>\n                    <FormControl>\n                      <Input {...field} data-testid=\"input-edit-workflow-title\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={form.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Description</FormLabel>\n                    <FormControl>\n                      <Textarea {...field} data-testid=\"input-edit-workflow-description\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"category\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Category</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-edit-workflow-category\">\n                            <SelectValue />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {Object.entries(categoryLabels).map(([value, label]) => (\n                            <SelectItem key={value} value={value}>{label}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"status\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Status</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-edit-workflow-status\">\n                            <SelectValue />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"draft\">Draft</SelectItem>\n                          <SelectItem value=\"active\">Active</SelectItem>\n                          <SelectItem value=\"archived\">Archived</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n              <FormField\n                control={form.control}\n                name=\"departmentId\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Department</FormLabel>\n                    <Select onValueChange={field.onChange} value={field.value}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-edit-workflow-department\">\n                          <SelectValue placeholder=\"Select department\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        {departments.map((dept) => (\n                          <SelectItem key={dept.id} value={dept.id}>{dept.name}</SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <DialogFooter>\n                <Button type=\"submit\" disabled={updateMutation.isPending} data-testid=\"button-update-workflow\">\n                  {updateMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={!!viewingWorkflow} onOpenChange={(open) => !open && setViewingWorkflow(null)}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle>{viewingWorkflow?.title}</DialogTitle>\n            <DialogDescription>{viewingWorkflow?.description}</DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"flex flex-wrap gap-2\">\n              {viewingWorkflow && (\n                <>\n                  <Badge variant=\"outline\">{categoryLabels[viewingWorkflow.category]}</Badge>\n                  <Badge className={statusColors[viewingWorkflow.status]}>\n                    {viewingWorkflow.status.charAt(0).toUpperCase() + viewingWorkflow.status.slice(1)}\n                  </Badge>\n                </>\n              )}\n            </div>\n            <div className=\"border-t pt-4\">\n              <h4 className=\"font-medium mb-2\">Version History</h4>\n              {workflowVersions.length === 0 ? (\n                <p className=\"text-sm text-muted-foreground\">No versions created yet.</p>\n              ) : (\n                <div className=\"space-y-2\">\n                  {workflowVersions.map((version) => (\n                    <div key={version.id} className=\"flex items-center justify-between p-2 rounded bg-muted/50\">\n                      <div>\n                        <span className=\"font-medium\">v{version.versionNumber}</span>\n                        {version.changeSummary && (\n                          <span className=\"ml-2 text-sm text-muted-foreground\">{version.changeSummary}</span>\n                        )}\n                      </div>\n                      <span className=\"text-xs text-muted-foreground\">\n                        {format(new Date(version.createdAt), 'dd MMM yyyy')}\n                      </span>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={!!deletingWorkflow} onOpenChange={(open) => !open && setDeletingWorkflow(null)}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Delete Workflow</DialogTitle>\n            <DialogDescription>\n              Are you sure you want to delete \"{deletingWorkflow?.title}\"? This action cannot be undone.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setDeletingWorkflow(null)} data-testid=\"button-cancel-delete\">\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={() => deletingWorkflow && deleteMutation.mutate(deletingWorkflow.id)}\n              disabled={deleteMutation.isPending}\n              data-testid=\"button-confirm-delete\"\n            >\n              {deleteMutation.isPending ? \"Deleting...\" : \"Delete\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":25478,"size_tokens":null},"client/src/components/quotes/QuoteBuilder.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Plus, Trash2, Calculator, Save, Send, FileText } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Client, Lead, Product, FenceStyle, QuoteLineItem } from \"@shared/schema\";\n\ninterface QuoteBuilderProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  lead?: Lead;\n  client?: Client;\n  onQuoteCreated?: (quoteId: string) => void;\n}\n\ninterface LineItemRow {\n  id: string;\n  productId: string;\n  productName: string;\n  quantity: number;\n  unitPrice: number;\n  totalPrice: number;\n  notes?: string;\n}\n\nfunction generateId(): string {\n  if (typeof crypto !== 'undefined' && crypto.randomUUID) {\n    return crypto.randomUUID();\n  }\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {\n    const r = Math.random() * 16 | 0;\n    const v = c === 'x' ? r : (r & 0x3 | 0x8);\n    return v.toString(16);\n  });\n}\n\nexport function QuoteBuilder({\n  open,\n  onOpenChange,\n  lead,\n  client,\n  onQuoteCreated,\n}: QuoteBuilderProps) {\n  const { toast } = useToast();\n  \n  const [lineItems, setLineItems] = useState<LineItemRow[]>([]);\n  const [fenceStyleId, setFenceStyleId] = useState<string>(\"\");\n  const [fenceLength, setFenceLength] = useState<string>(lead?.fenceLength || \"\");\n  const [fenceHeight, setFenceHeight] = useState<string>(\"1800\");\n  const [siteAddress, setSiteAddress] = useState<string>(lead?.siteAddress || \"\");\n  const [selectedClientId, setSelectedClientId] = useState<string>(\"\");\n  const [isTradeQuote, setIsTradeQuote] = useState<boolean>(client?.clientType === \"trade\");\n  const [tradeDiscount, setTradeDiscount] = useState<string>(\"0\");\n  const [labourEstimate, setLabourEstimate] = useState<string>(\"0\");\n  const [depositPercent, setDepositPercent] = useState<number>(50);\n  const [notes, setNotes] = useState<string>(\"\");\n  const [internalNotes, setInternalNotes] = useState<string>(\"\");\n\n  const { data: products = [] } = useQuery<Product[]>({\n    queryKey: [\"/api/products\"],\n  });\n\n  const { data: fenceStyles = [] } = useQuery<FenceStyle[]>({\n    queryKey: [\"/api/fence-styles\"],\n  });\n\n  const { data: clients = [] } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  useEffect(() => {\n    if (lead) {\n      setSiteAddress(lead.siteAddress || \"\");\n      setFenceLength(lead.fenceLength || \"\");\n      if (lead.clientId) {\n        setSelectedClientId(lead.clientId);\n      }\n      if (lead.fenceStyle) {\n        const style = fenceStyles.find(s => s.name === lead.fenceStyle);\n        if (style) setFenceStyleId(style.id);\n      }\n    }\n    if (client) {\n      setSelectedClientId(client.id);\n      setIsTradeQuote(client.clientType === \"trade\");\n      if (client.tradeDiscountLevel) {\n        const discountMap: Record<string, string> = {\n          standard: \"10\",\n          silver: \"15\",\n          gold: \"20\",\n          platinum: \"25\",\n        };\n        setTradeDiscount(discountMap[client.tradeDiscountLevel] || \"0\");\n      }\n    }\n  }, [lead, client, fenceStyles]);\n\n  useEffect(() => {\n    if (lineItems.length > 0 && products.length > 0) {\n      setLineItems(prevItems => prevItems.map(item => {\n        if (!item.productId) return item;\n        const product = products.find(p => p.id === item.productId);\n        if (!product) return item;\n        const price = isTradeQuote && product.tradePrice \n          ? parseFloat(product.tradePrice) \n          : parseFloat(product.sellPrice);\n        return {\n          ...item,\n          unitPrice: price,\n          totalPrice: price * item.quantity,\n        };\n      }));\n    }\n  }, [isTradeQuote, products]);\n\n  const createQuoteMutation = useMutation({\n    mutationFn: async (data: any) => {\n      const response = await apiRequest(\"POST\", \"/api/quotes\", data);\n      return response as unknown as { id: string };\n    },\n    onSuccess: async (response) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/quotes\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/leads\"] });\n      toast({\n        title: \"Quote Created\",\n        description: \"The quote has been successfully created.\",\n      });\n      onOpenChange(false);\n      resetForm();\n      if (onQuoteCreated && response?.id) {\n        onQuoteCreated(response.id);\n      }\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to create quote. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setLineItems([]);\n    setFenceStyleId(\"\");\n    setFenceLength(\"\");\n    setFenceHeight(\"1800\");\n    setSiteAddress(\"\");\n    setSelectedClientId(\"\");\n    setIsTradeQuote(false);\n    setTradeDiscount(\"0\");\n    setLabourEstimate(\"0\");\n    setNotes(\"\");\n    setInternalNotes(\"\");\n  };\n\n  const addLineItem = () => {\n    const newItem: LineItemRow = {\n      id: generateId(),\n      productId: \"\",\n      productName: \"\",\n      quantity: 1,\n      unitPrice: 0,\n      totalPrice: 0,\n    };\n    setLineItems([...lineItems, newItem]);\n  };\n\n  const removeLineItem = (id: string) => {\n    setLineItems(lineItems.filter(item => item.id !== id));\n  };\n\n  const updateLineItem = (id: string, field: keyof LineItemRow, value: any) => {\n    setLineItems(lineItems.map(item => {\n      if (item.id !== id) return item;\n      \n      const updatedItem = { ...item, [field]: value };\n      \n      if (field === \"productId\") {\n        const product = products.find(p => p.id === value);\n        if (product) {\n          const price = isTradeQuote && product.tradePrice \n            ? parseFloat(product.tradePrice) \n            : parseFloat(product.sellPrice);\n          updatedItem.productName = product.name;\n          updatedItem.unitPrice = price;\n          updatedItem.totalPrice = price * updatedItem.quantity;\n        }\n      }\n      \n      if (field === \"quantity\" || field === \"unitPrice\") {\n        const qty = field === \"quantity\" ? value : item.quantity;\n        const price = field === \"unitPrice\" ? value : item.unitPrice;\n        updatedItem.totalPrice = qty * price;\n      }\n      \n      return updatedItem;\n    }));\n  };\n\n  const materialsSubtotal = lineItems.reduce((sum, item) => sum + item.totalPrice, 0);\n  const labour = parseFloat(labourEstimate) || 0;\n  const discountRate = parseFloat(tradeDiscount) || 0;\n  const discountAmount = isTradeQuote ? (materialsSubtotal * discountRate / 100) : 0;\n  const totalBeforeDiscount = materialsSubtotal + labour;\n  const totalAmount = totalBeforeDiscount - discountAmount;\n  const depositRequired = totalAmount * (depositPercent / 100);\n\n  const getProductsByCategory = (category: string) => {\n    return products.filter(p => p.category === category && p.isActive);\n  };\n\n  const effectiveClientId = client?.id || selectedClientId || lead?.clientId;\n\n  const handleSubmit = (sendNow: boolean = false) => {\n    if (!effectiveClientId) {\n      toast({\n        title: \"Error\",\n        description: \"Please select a client for this quote.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (lineItems.length === 0) {\n      toast({\n        title: \"Error\",\n        description: \"Please add at least one line item.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const invalidItems = lineItems.filter(item => !item.productId || item.quantity < 1);\n    if (invalidItems.length > 0) {\n      toast({\n        title: \"Error\",\n        description: \"Please ensure all line items have a product selected and quantity greater than 0.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const quoteData = {\n      clientId: effectiveClientId,\n      leadId: lead?.id,\n      fenceStyleId: fenceStyleId || null,\n      siteAddress,\n      totalLength: fenceLength || null,\n      fenceHeight: fenceHeight || null,\n      lineItems: lineItems.map(item => ({\n        productId: item.productId,\n        productName: item.productName,\n        quantity: item.quantity,\n        unitPrice: item.unitPrice,\n        totalPrice: item.totalPrice,\n        notes: item.notes,\n      })) as QuoteLineItem[],\n      materialsSubtotal: materialsSubtotal.toFixed(2),\n      labourEstimate: labour.toFixed(2),\n      totalAmount: totalAmount.toFixed(2),\n      depositRequired: depositRequired.toFixed(2),\n      depositPercent,\n      status: sendNow ? \"sent\" : \"draft\",\n      isTradeQuote,\n      tradeDiscount: isTradeQuote ? tradeDiscount : null,\n      notes,\n      internalNotes,\n    };\n\n    createQuoteMutation.mutate(quoteData);\n  };\n\n  const quickAddProducts = (category: string) => {\n    const categoryProducts = getProductsByCategory(category);\n    if (categoryProducts.length > 0) {\n      const newItems = categoryProducts.slice(0, 3).map(product => ({\n        id: generateId(),\n        productId: product.id,\n        productName: product.name,\n        quantity: 1,\n        unitPrice: isTradeQuote && product.tradePrice \n          ? parseFloat(product.tradePrice) \n          : parseFloat(product.sellPrice),\n        totalPrice: isTradeQuote && product.tradePrice \n          ? parseFloat(product.tradePrice) \n          : parseFloat(product.sellPrice),\n      }));\n      setLineItems([...lineItems, ...newItems]);\n    }\n  };\n\n  const selectedClient = client || (selectedClientId ? clients.find(c => c.id === selectedClientId) : null) || (lead?.clientId ? clients.find(c => c.id === lead.clientId) : null);\n  const needsClientSelection = !client && !lead?.clientId;\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <FileText className=\"h-5 w-5\" />\n            Create Quote\n          </DialogTitle>\n          <DialogDescription>\n            Build a quote for {selectedClient?.name || \"a customer\"}\n            {lead?.siteAddress && ` at ${lead.siteAddress}`}\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-6\">\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-base\">Quote Details</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label>Client {needsClientSelection && <span className=\"text-destructive\">*</span>}</Label>\n                  {needsClientSelection ? (\n                    <Select value={selectedClientId} onValueChange={setSelectedClientId}>\n                      <SelectTrigger data-testid=\"select-quote-client\">\n                        <SelectValue placeholder=\"Select client\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {clients.map(c => (\n                          <SelectItem key={c.id} value={c.id}>\n                            {c.name} {c.clientType === \"trade\" && \"(Trade)\"}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  ) : (\n                    <Input \n                      value={selectedClient?.name || \"\"} \n                      disabled \n                      className=\"bg-muted\"\n                      data-testid=\"input-quote-client\"\n                    />\n                  )}\n                </div>\n                <div className=\"space-y-2\">\n                  <Label>Site Address</Label>\n                  <Input \n                    value={siteAddress}\n                    onChange={(e) => setSiteAddress(e.target.value)}\n                    placeholder=\"Installation address\"\n                    data-testid=\"input-quote-address\"\n                  />\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-3 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label>Fence Style</Label>\n                  <Select value={fenceStyleId} onValueChange={setFenceStyleId}>\n                    <SelectTrigger data-testid=\"select-fence-style\">\n                      <SelectValue placeholder=\"Select style\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {fenceStyles.map(style => (\n                        <SelectItem key={style.id} value={style.id}>\n                          {style.name}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label>Total Length (m)</Label>\n                  <Input \n                    type=\"number\"\n                    value={fenceLength}\n                    onChange={(e) => setFenceLength(e.target.value)}\n                    placeholder=\"e.g. 25.5\"\n                    data-testid=\"input-fence-length\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label>Height (mm)</Label>\n                  <Select value={fenceHeight} onValueChange={setFenceHeight}>\n                    <SelectTrigger data-testid=\"select-fence-height\">\n                      <SelectValue placeholder=\"Select height\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"1200\">1200mm</SelectItem>\n                      <SelectItem value=\"1500\">1500mm</SelectItem>\n                      <SelectItem value=\"1800\">1800mm</SelectItem>\n                      <SelectItem value=\"2100\">2100mm</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex items-center justify-between\">\n                <CardTitle className=\"text-base\">Line Items</CardTitle>\n                <div className=\"flex gap-2\">\n                  <Button \n                    size=\"sm\" \n                    variant=\"outline\" \n                    onClick={() => quickAddProducts(\"posts\")}\n                    data-testid=\"button-quick-add-posts\"\n                  >\n                    + Posts\n                  </Button>\n                  <Button \n                    size=\"sm\" \n                    variant=\"outline\" \n                    onClick={() => quickAddProducts(\"rails\")}\n                    data-testid=\"button-quick-add-rails\"\n                  >\n                    + Rails\n                  </Button>\n                  <Button \n                    size=\"sm\" \n                    variant=\"outline\" \n                    onClick={() => quickAddProducts(\"pickets\")}\n                    data-testid=\"button-quick-add-pickets\"\n                  >\n                    + Pickets\n                  </Button>\n                  <Button size=\"sm\" onClick={addLineItem} data-testid=\"button-add-line-item\">\n                    <Plus className=\"h-4 w-4 mr-1\" />\n                    Add Item\n                  </Button>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {lineItems.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <Calculator className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\n                  <p className=\"text-sm\">No items added yet. Click \"Add Item\" or use quick add buttons.</p>\n                </div>\n              ) : (\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead className=\"w-[300px]\">Product</TableHead>\n                      <TableHead className=\"w-[100px]\">Qty</TableHead>\n                      <TableHead className=\"w-[120px]\">Unit Price</TableHead>\n                      <TableHead className=\"w-[120px]\">Total</TableHead>\n                      <TableHead className=\"w-[50px]\"></TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {lineItems.map((item) => (\n                      <TableRow key={item.id}>\n                        <TableCell>\n                          <Select \n                            value={item.productId} \n                            onValueChange={(value) => updateLineItem(item.id, \"productId\", value)}\n                          >\n                            <SelectTrigger data-testid={`select-product-${item.id}`}>\n                              <SelectValue placeholder=\"Select product\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {[\"posts\", \"rails\", \"pickets\", \"caps\", \"gates\", \"hardware\", \"accessories\"].map(category => (\n                                <div key={category}>\n                                  {getProductsByCategory(category).length > 0 && (\n                                    <>\n                                      <div className=\"px-2 py-1.5 text-xs font-semibold text-muted-foreground capitalize\">\n                                        {category}\n                                      </div>\n                                      {getProductsByCategory(category).map(product => (\n                                        <SelectItem key={product.id} value={product.id}>\n                                          {product.name} - ${parseFloat(product.sellPrice).toFixed(2)}\n                                        </SelectItem>\n                                      ))}\n                                    </>\n                                  )}\n                                </div>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                        </TableCell>\n                        <TableCell>\n                          <Input \n                            type=\"number\"\n                            min=\"1\"\n                            value={item.quantity}\n                            onChange={(e) => updateLineItem(item.id, \"quantity\", parseInt(e.target.value) || 1)}\n                            className=\"w-20\"\n                            data-testid={`input-qty-${item.id}`}\n                          />\n                        </TableCell>\n                        <TableCell>\n                          <div className=\"flex items-center\">\n                            <span className=\"text-muted-foreground mr-1\">$</span>\n                            <Input \n                              type=\"number\"\n                              step=\"0.01\"\n                              value={item.unitPrice}\n                              onChange={(e) => updateLineItem(item.id, \"unitPrice\", parseFloat(e.target.value) || 0)}\n                              className=\"w-24\"\n                              data-testid={`input-price-${item.id}`}\n                            />\n                          </div>\n                        </TableCell>\n                        <TableCell className=\"font-medium\">\n                          ${item.totalPrice.toFixed(2)}\n                        </TableCell>\n                        <TableCell>\n                          <Button \n                            size=\"icon\" \n                            variant=\"ghost\"\n                            onClick={() => removeLineItem(item.id)}\n                            data-testid={`button-remove-${item.id}`}\n                          >\n                            <Trash2 className=\"h-4 w-4 text-destructive\" />\n                          </Button>\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              )}\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-base\">Pricing & Trade</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                  <Switch \n                    checked={isTradeQuote}\n                    onCheckedChange={setIsTradeQuote}\n                    data-testid=\"switch-trade-quote\"\n                  />\n                  <Label>Trade Quote</Label>\n                </div>\n                {isTradeQuote && (\n                  <div className=\"flex items-center gap-2\">\n                    <Label>Discount %</Label>\n                    <Input \n                      type=\"number\"\n                      value={tradeDiscount}\n                      onChange={(e) => setTradeDiscount(e.target.value)}\n                      className=\"w-20\"\n                      data-testid=\"input-trade-discount\"\n                    />\n                  </div>\n                )}\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label>Labour Estimate</Label>\n                  <div className=\"flex items-center\">\n                    <span className=\"text-muted-foreground mr-1\">$</span>\n                    <Input \n                      type=\"number\"\n                      value={labourEstimate}\n                      onChange={(e) => setLabourEstimate(e.target.value)}\n                      placeholder=\"0.00\"\n                      data-testid=\"input-labour\"\n                    />\n                  </div>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label>Deposit %</Label>\n                  <Select \n                    value={depositPercent.toString()} \n                    onValueChange={(v) => setDepositPercent(parseInt(v))}\n                  >\n                    <SelectTrigger data-testid=\"select-deposit-percent\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"30\">30%</SelectItem>\n                      <SelectItem value=\"50\">50%</SelectItem>\n                      <SelectItem value=\"100\">100% (Full)</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n\n              <Separator />\n\n              <div className=\"space-y-2 text-sm\">\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Materials Subtotal</span>\n                  <span>${materialsSubtotal.toFixed(2)}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Labour</span>\n                  <span>${labour.toFixed(2)}</span>\n                </div>\n                {isTradeQuote && discountAmount > 0 && (\n                  <div className=\"flex justify-between text-green-600\">\n                    <span>Trade Discount ({tradeDiscount}%)</span>\n                    <span>-${discountAmount.toFixed(2)}</span>\n                  </div>\n                )}\n                <Separator />\n                <div className=\"flex justify-between font-semibold text-base\">\n                  <span>Total</span>\n                  <span>${totalAmount.toFixed(2)}</span>\n                </div>\n                <div className=\"flex justify-between text-muted-foreground\">\n                  <span>Deposit Required ({depositPercent}%)</span>\n                  <span>${depositRequired.toFixed(2)}</span>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-base\">Notes</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label>Customer Notes (Visible on quote)</Label>\n                <Textarea \n                  value={notes}\n                  onChange={(e) => setNotes(e.target.value)}\n                  placeholder=\"Add any notes for the customer...\"\n                  data-testid=\"textarea-customer-notes\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Internal Notes (Staff only)</Label>\n                <Textarea \n                  value={internalNotes}\n                  onChange={(e) => setInternalNotes(e.target.value)}\n                  placeholder=\"Add internal notes...\"\n                  data-testid=\"textarea-internal-notes\"\n                />\n              </div>\n            </CardContent>\n          </Card>\n\n          <div className=\"flex justify-end gap-3\">\n            <Button \n              variant=\"outline\" \n              onClick={() => onOpenChange(false)}\n              data-testid=\"button-cancel-quote\"\n            >\n              Cancel\n            </Button>\n            <Button \n              variant=\"outline\"\n              onClick={() => handleSubmit(false)}\n              disabled={createQuoteMutation.isPending}\n              data-testid=\"button-save-draft\"\n            >\n              <Save className=\"h-4 w-4 mr-2\" />\n              Save Draft\n            </Button>\n            <Button \n              onClick={() => handleSubmit(true)}\n              disabled={createQuoteMutation.isPending}\n              data-testid=\"button-send-quote\"\n            >\n              <Send className=\"h-4 w-4 mr-2\" />\n              {createQuoteMutation.isPending ? \"Creating...\" : \"Create & Send\"}\n            </Button>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":26408,"size_tokens":null},"client/src/components/layout/NewMessageBanner.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { MessageSquare, X } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useState, useEffect } from \"react\";\n\nexport function NewMessageBanner() {\n  const [location, navigate] = useLocation();\n  const [dismissed, setDismissed] = useState(false);\n  const [lastCount, setLastCount] = useState(0);\n\n  const { data: unreadData } = useQuery<{ count: number }>({\n    queryKey: ['/api/sms/unread-count'],\n    refetchInterval: 15000,\n  });\n\n  const unreadCount = unreadData?.count || 0;\n\n  useEffect(() => {\n    if (unreadCount > lastCount && lastCount > 0) {\n      setDismissed(false);\n    }\n    setLastCount(unreadCount);\n  }, [unreadCount, lastCount]);\n\n  if (location === '/messages' || dismissed || unreadCount === 0) {\n    return null;\n  }\n\n  return (\n    <div \n      className=\"bg-destructive text-destructive-foreground px-4 py-2 flex items-center justify-between gap-4 animate-in slide-in-from-top-2\"\n      data-testid=\"banner-new-messages\"\n    >\n      <div className=\"flex items-center gap-3\">\n        <MessageSquare className=\"h-4 w-4\" />\n        <span className=\"text-sm font-medium\">\n          You have {unreadCount} unread message{unreadCount !== 1 ? 's' : ''} requiring attention\n        </span>\n      </div>\n      <div className=\"flex items-center gap-2\">\n        <Button \n          variant=\"outline\" \n          size=\"sm\"\n          className=\"bg-transparent border-destructive-foreground/30 text-destructive-foreground hover:bg-destructive-foreground/10\"\n          onClick={() => navigate('/messages')}\n          data-testid=\"button-view-messages\"\n        >\n          View Messages\n        </Button>\n        <Button \n          variant=\"ghost\" \n          size=\"icon\"\n          className=\"h-6 w-6 text-destructive-foreground hover:bg-destructive-foreground/10\"\n          onClick={() => setDismissed(true)}\n          data-testid=\"button-dismiss-banner\"\n        >\n          <X className=\"h-4 w-4\" />\n        </Button>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":2075,"size_tokens":null},"client/src/pages/organisation/Knowledge.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { BookOpen, Plus, Pencil, Trash2, Search, Eye, Clock } from \"lucide-react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Switch } from \"@/components/ui/switch\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { KnowledgeArticle, Department } from \"@shared/schema\";\nimport { format } from \"date-fns\";\n\nconst articleFormSchema = z.object({\n  title: z.string().min(1, \"Title is required\"),\n  slug: z.string().min(1, \"Slug is required\").regex(/^[a-z0-9-]+$/, \"Slug must be lowercase with hyphens only\"),\n  contentMarkdown: z.string().optional(),\n  departmentId: z.string().optional(),\n  isPublished: z.boolean().default(false),\n});\n\ntype ArticleFormValues = z.infer<typeof articleFormSchema>;\n\nexport default function Knowledge() {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [departmentFilter, setDepartmentFilter] = useState<string>(\"\");\n  const [publishedFilter, setPublishedFilter] = useState<string>(\"\");\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [editingArticle, setEditingArticle] = useState<KnowledgeArticle | null>(null);\n  const [viewingArticle, setViewingArticle] = useState<KnowledgeArticle | null>(null);\n  const [deletingArticle, setDeletingArticle] = useState<KnowledgeArticle | null>(null);\n\n  const { data: articles = [], isLoading } = useQuery<KnowledgeArticle[]>({\n    queryKey: ['/api/organisation/knowledge'],\n  });\n\n  const { data: departments = [] } = useQuery<Department[]>({\n    queryKey: ['/api/organisation/departments'],\n  });\n\n  const form = useForm<ArticleFormValues>({\n    resolver: zodResolver(articleFormSchema),\n    defaultValues: {\n      title: \"\",\n      slug: \"\",\n      contentMarkdown: \"\",\n      departmentId: \"\",\n      isPublished: false,\n    },\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: ArticleFormValues) => {\n      return apiRequest('POST', '/api/organisation/knowledge', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/organisation/knowledge'] });\n      setIsCreateDialogOpen(false);\n      form.reset();\n      toast({ title: \"Article created successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to create article\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: ArticleFormValues }) => {\n      return apiRequest('PATCH', `/api/organisation/knowledge/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/organisation/knowledge'] });\n      setEditingArticle(null);\n      form.reset();\n      toast({ title: \"Article updated successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to update article\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest('DELETE', `/api/organisation/knowledge/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/organisation/knowledge'] });\n      setDeletingArticle(null);\n      toast({ title: \"Article deleted successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to delete article\", variant: \"destructive\" });\n    },\n  });\n\n  const handleCreateSubmit = (data: ArticleFormValues) => {\n    createMutation.mutate(data);\n  };\n\n  const handleEditSubmit = (data: ArticleFormValues) => {\n    if (editingArticle) {\n      updateMutation.mutate({ id: editingArticle.id, data });\n    }\n  };\n\n  const openEditDialog = (article: KnowledgeArticle) => {\n    setEditingArticle(article);\n    form.reset({\n      title: article.title,\n      slug: article.slug,\n      contentMarkdown: article.contentMarkdown || \"\",\n      departmentId: article.departmentId || \"\",\n      isPublished: article.isPublished,\n    });\n  };\n\n  const generateSlug = (title: string) => {\n    return title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');\n  };\n\n  const filteredArticles = articles.filter(article => {\n    const matchesSearch = \n      article.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      article.contentMarkdown?.toLowerCase().includes(searchQuery.toLowerCase());\n    const matchesDepartment = !departmentFilter || article.departmentId === departmentFilter;\n    const matchesPublished = !publishedFilter || \n      (publishedFilter === \"published\" ? article.isPublished : !article.isPublished);\n    return matchesSearch && matchesDepartment && matchesPublished;\n  });\n\n  const getDepartmentName = (departmentId: string | null) => {\n    if (!departmentId) return null;\n    const department = departments.find(d => d.id === departmentId);\n    return department?.name;\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-semibold text-foreground\" data-testid=\"text-page-title\">Knowledge Base</h1>\n          <p className=\"text-muted-foreground\">Company knowledge and documentation</p>\n        </div>\n        <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-article\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              New Article\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl\">\n            <DialogHeader>\n              <DialogTitle>Create Article</DialogTitle>\n              <DialogDescription>Add a new knowledge base article.</DialogDescription>\n            </DialogHeader>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(handleCreateSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"title\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Title</FormLabel>\n                      <FormControl>\n                        <Input \n                          {...field} \n                          placeholder=\"e.g. How to Process a New Lead\" \n                          data-testid=\"input-article-title\"\n                          onChange={(e) => {\n                            field.onChange(e);\n                            const currentSlug = form.getValues(\"slug\");\n                            if (!currentSlug || currentSlug === generateSlug(form.getValues(\"title\"))) {\n                              form.setValue(\"slug\", generateSlug(e.target.value));\n                            }\n                          }}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"slug\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Slug</FormLabel>\n                      <FormControl>\n                        <Input {...field} placeholder=\"how-to-process-a-new-lead\" data-testid=\"input-article-slug\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"contentMarkdown\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Content (Markdown)</FormLabel>\n                      <FormControl>\n                        <Textarea \n                          {...field} \n                          placeholder=\"Write your article content here using Markdown...\" \n                          className=\"min-h-[200px] font-mono text-sm\"\n                          data-testid=\"input-article-content\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"departmentId\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Department (optional)</FormLabel>\n                        <Select onValueChange={(val) => field.onChange(val === \"_none\" ? \"\" : val)} defaultValue={field.value || \"_none\"}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-article-department\">\n                              <SelectValue placeholder=\"All departments\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            <SelectItem value=\"_none\">All departments</SelectItem>\n                            {departments.map((dept) => (\n                              <SelectItem key={dept.id} value={dept.id}>{dept.name}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"isPublished\"\n                    render={({ field }) => (\n                      <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-3\">\n                        <div className=\"space-y-0.5\">\n                          <FormLabel>Published</FormLabel>\n                        </div>\n                        <FormControl>\n                          <Switch\n                            checked={field.value}\n                            onCheckedChange={field.onChange}\n                            data-testid=\"switch-article-published\"\n                          />\n                        </FormControl>\n                      </FormItem>\n                    )}\n                  />\n                </div>\n                <DialogFooter>\n                  <Button type=\"submit\" disabled={createMutation.isPending} data-testid=\"button-submit-article\">\n                    {createMutation.isPending ? \"Creating...\" : \"Create Article\"}\n                  </Button>\n                </DialogFooter>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <div className=\"flex flex-wrap gap-4\">\n        <div className=\"relative flex-1 min-w-[200px] max-w-md\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search articles...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-9\"\n            data-testid=\"input-search-articles\"\n          />\n        </div>\n        <Select value={departmentFilter || \"all\"} onValueChange={(val) => setDepartmentFilter(val === \"all\" ? \"\" : val)}>\n          <SelectTrigger className=\"w-40\" data-testid=\"filter-department\">\n            <SelectValue placeholder=\"Department\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Departments</SelectItem>\n            {departments.map((dept) => (\n              <SelectItem key={dept.id} value={dept.id}>{dept.name}</SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n        <Select value={publishedFilter || \"all\"} onValueChange={(val) => setPublishedFilter(val === \"all\" ? \"\" : val)}>\n          <SelectTrigger className=\"w-32\" data-testid=\"filter-published\">\n            <SelectValue placeholder=\"Status\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Status</SelectItem>\n            <SelectItem value=\"published\">Published</SelectItem>\n            <SelectItem value=\"draft\">Draft</SelectItem>\n          </SelectContent>\n        </Select>\n      </div>\n\n      {isLoading ? (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {[1, 2, 3].map((i) => (\n            <Card key={i} className=\"animate-pulse\">\n              <CardHeader className=\"space-y-2\">\n                <div className=\"h-5 w-32 bg-muted rounded\"></div>\n                <div className=\"h-4 w-48 bg-muted rounded\"></div>\n              </CardHeader>\n            </Card>\n          ))}\n        </div>\n      ) : filteredArticles.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-12\">\n            <BookOpen className=\"h-12 w-12 text-muted-foreground mb-4\" />\n            <h3 className=\"text-lg font-medium\">No articles found</h3>\n            <p className=\"text-muted-foreground text-sm\">\n              {searchQuery || departmentFilter || publishedFilter ? \"Try adjusting your filters\" : \"Create your first article to get started\"}\n            </p>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {filteredArticles.map((article) => (\n            <Card key={article.id} data-testid={`card-article-${article.id}`}>\n              <CardHeader>\n                <div className=\"flex items-start justify-between gap-2\">\n                  <div className=\"flex items-start gap-3 min-w-0\">\n                    <div className=\"flex h-10 w-10 shrink-0 items-center justify-center rounded-md bg-primary/10 text-primary\">\n                      <BookOpen className=\"h-5 w-5\" />\n                    </div>\n                    <div className=\"min-w-0\">\n                      <CardTitle className=\"text-base truncate\">{article.title}</CardTitle>\n                      <CardDescription className=\"text-xs font-mono\">/{article.slug}</CardDescription>\n                    </div>\n                  </div>\n                  <div className=\"flex gap-1 shrink-0\">\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\" \n                      className=\"h-8 w-8\"\n                      onClick={() => setViewingArticle(article)}\n                      data-testid={`button-view-article-${article.id}`}\n                    >\n                      <Eye className=\"h-4 w-4\" />\n                    </Button>\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\" \n                      className=\"h-8 w-8\"\n                      onClick={() => openEditDialog(article)}\n                      data-testid={`button-edit-article-${article.id}`}\n                    >\n                      <Pencil className=\"h-4 w-4\" />\n                    </Button>\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\" \n                      className=\"h-8 w-8 text-destructive\"\n                      onClick={() => setDeletingArticle(article)}\n                      data-testid={`button-delete-article-${article.id}`}\n                    >\n                      <Trash2 className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"flex flex-wrap items-center gap-2\">\n                  <Badge className={article.isPublished \n                    ? \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\" \n                    : \"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200\"\n                  }>\n                    {article.isPublished ? \"Published\" : \"Draft\"}\n                  </Badge>\n                  {article.departmentId && (\n                    <Badge variant=\"secondary\">{getDepartmentName(article.departmentId)}</Badge>\n                  )}\n                </div>\n                <div className=\"mt-3 flex items-center gap-2 text-xs text-muted-foreground\">\n                  <Clock className=\"h-3 w-3\" />\n                  <span>Updated {format(new Date(article.updatedAt), 'dd MMM yyyy')}</span>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n\n      <Dialog open={!!editingArticle} onOpenChange={(open) => !open && setEditingArticle(null)}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle>Edit Article</DialogTitle>\n            <DialogDescription>Update article content.</DialogDescription>\n          </DialogHeader>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(handleEditSubmit)} className=\"space-y-4\">\n              <FormField\n                control={form.control}\n                name=\"title\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Title</FormLabel>\n                    <FormControl>\n                      <Input {...field} data-testid=\"input-edit-article-title\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={form.control}\n                name=\"slug\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Slug</FormLabel>\n                    <FormControl>\n                      <Input {...field} data-testid=\"input-edit-article-slug\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={form.control}\n                name=\"contentMarkdown\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Content (Markdown)</FormLabel>\n                    <FormControl>\n                      <Textarea \n                        {...field} \n                        className=\"min-h-[200px] font-mono text-sm\"\n                        data-testid=\"input-edit-article-content\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"departmentId\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Department (optional)</FormLabel>\n                      <Select onValueChange={(val) => field.onChange(val === \"_none\" ? \"\" : val)} value={field.value || \"_none\"}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-edit-article-department\">\n                            <SelectValue placeholder=\"All departments\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"_none\">All departments</SelectItem>\n                          {departments.map((dept) => (\n                            <SelectItem key={dept.id} value={dept.id}>{dept.name}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"isPublished\"\n                  render={({ field }) => (\n                    <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-3\">\n                      <div className=\"space-y-0.5\">\n                        <FormLabel>Published</FormLabel>\n                      </div>\n                      <FormControl>\n                        <Switch\n                          checked={field.value}\n                          onCheckedChange={field.onChange}\n                          data-testid=\"switch-edit-article-published\"\n                        />\n                      </FormControl>\n                    </FormItem>\n                  )}\n                />\n              </div>\n              <DialogFooter>\n                <Button type=\"submit\" disabled={updateMutation.isPending} data-testid=\"button-update-article\">\n                  {updateMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={!!viewingArticle} onOpenChange={(open) => !open && setViewingArticle(null)}>\n        <DialogContent className=\"max-w-3xl max-h-[80vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>{viewingArticle?.title}</DialogTitle>\n            <DialogDescription className=\"font-mono\">/{viewingArticle?.slug}</DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"flex flex-wrap gap-2\">\n              {viewingArticle && (\n                <>\n                  <Badge className={viewingArticle.isPublished \n                    ? \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\" \n                    : \"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200\"\n                  }>\n                    {viewingArticle.isPublished ? \"Published\" : \"Draft\"}\n                  </Badge>\n                  {viewingArticle.departmentId && (\n                    <Badge variant=\"secondary\">{getDepartmentName(viewingArticle.departmentId)}</Badge>\n                  )}\n                </>\n              )}\n            </div>\n            <div className=\"border-t pt-4\">\n              <div className=\"prose prose-sm dark:prose-invert max-w-none\">\n                {viewingArticle?.contentMarkdown ? (\n                  <pre className=\"whitespace-pre-wrap font-sans\">{viewingArticle.contentMarkdown}</pre>\n                ) : (\n                  <p className=\"text-muted-foreground\">No content yet.</p>\n                )}\n              </div>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={!!deletingArticle} onOpenChange={(open) => !open && setDeletingArticle(null)}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Delete Article</DialogTitle>\n            <DialogDescription>\n              Are you sure you want to delete \"{deletingArticle?.title}\"? This action cannot be undone.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setDeletingArticle(null)} data-testid=\"button-cancel-delete\">\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={() => deletingArticle && deleteMutation.mutate(deletingArticle.id)}\n              disabled={deleteMutation.isPending}\n              data-testid=\"button-confirm-delete\"\n            >\n              {deleteMutation.isPending ? \"Deleting...\" : \"Delete\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":24174,"size_tokens":null},"client/src/pages/QuoteAnalytics.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { \n  FileText, \n  TrendingUp, \n  TrendingDown, \n  DollarSign, \n  CheckCircle2, \n  XCircle, \n  Clock, \n  Send \n} from \"lucide-react\";\nimport { \n  BarChart, \n  Bar, \n  XAxis, \n  YAxis, \n  CartesianGrid, \n  Tooltip, \n  ResponsiveContainer,\n  PieChart,\n  Pie,\n  Cell,\n  Legend\n} from \"recharts\";\n\ninterface QuoteAnalytics {\n  totalQuotes: number;\n  sentQuotes: number;\n  approvedQuotes: number;\n  declinedQuotes: number;\n  pendingQuotes: number;\n  conversionRate: number;\n  totalValue: number;\n  averageQuoteValue: number;\n  quotesThisWeek: number;\n  quotesLastWeek: number;\n  quotesByStatus: { status: string; count: number }[];\n  quotesByCreator: { userId: string; userName: string; total: number; approved: number; declined: number }[];\n  recentQuotes: any[];\n  pipelineValue: number;\n  wonValue: number;\n}\n\ninterface SalesAnalytics {\n  pendingQuotes: number;\n  quoteConversionRate: number;\n  averageDealSize: number;\n  quotePipelineValue: number;\n  monthlyRevenue: number;\n  yearToDateRevenue: number;\n  wonValue: number;\n  lostValue: number;\n}\n\nconst COLORS = ['#213d42', '#db5c26', '#f5e5d6', '#6b7280', '#10b981'];\n\nconst statusColors: Record<string, string> = {\n  draft: 'secondary',\n  sent: 'default',\n  approved: 'default',\n  declined: 'destructive',\n  expired: 'secondary',\n};\n\nconst statusIcons: Record<string, typeof FileText> = {\n  draft: FileText,\n  sent: Send,\n  approved: CheckCircle2,\n  declined: XCircle,\n  expired: Clock,\n};\n\nfunction formatCurrency(amount: number | string | null): string {\n  const num = typeof amount === 'string' ? parseFloat(amount) : (amount || 0);\n  return new Intl.NumberFormat('en-AU', {\n    style: 'currency',\n    currency: 'AUD',\n    minimumFractionDigits: 0,\n    maximumFractionDigits: 0,\n  }).format(num);\n}\n\nfunction StatCard({ \n  title, \n  value, \n  subValue, \n  icon: Icon, \n  trend \n}: { \n  title: string; \n  value: string | number; \n  subValue?: string; \n  icon: typeof FileText; \n  trend?: 'up' | 'down' | null;\n}) {\n  return (\n    <Card>\n      <CardHeader className=\"flex flex-row items-center justify-between gap-2 pb-2\">\n        <CardTitle className=\"text-sm font-medium text-muted-foreground\">{title}</CardTitle>\n        <Icon className=\"h-4 w-4 text-muted-foreground\" />\n      </CardHeader>\n      <CardContent>\n        <div className=\"flex items-end gap-2\">\n          <span className=\"text-2xl font-bold\">{value}</span>\n          {trend && (\n            trend === 'up' ? (\n              <TrendingUp className=\"h-4 w-4 text-green-600\" />\n            ) : (\n              <TrendingDown className=\"h-4 w-4 text-red-600\" />\n            )\n          )}\n        </div>\n        {subValue && (\n          <p className=\"text-xs text-muted-foreground mt-1\">{subValue}</p>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction LoadingSkeleton() {\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        {[...Array(4)].map((_, i) => (\n          <Card key={i}>\n            <CardHeader className=\"pb-2\">\n              <Skeleton className=\"h-4 w-24\" />\n            </CardHeader>\n            <CardContent>\n              <Skeleton className=\"h-8 w-20\" />\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <Card>\n          <CardHeader>\n            <Skeleton className=\"h-6 w-40\" />\n          </CardHeader>\n          <CardContent>\n            <Skeleton className=\"h-64 w-full\" />\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader>\n            <Skeleton className=\"h-6 w-40\" />\n          </CardHeader>\n          <CardContent>\n            <Skeleton className=\"h-64 w-full\" />\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n\nexport default function QuoteAnalytics() {\n  const { data: analytics, isLoading } = useQuery<QuoteAnalytics>({\n    queryKey: ['/api/quotes/analytics'],\n  });\n\n  const { data: salesAnalytics, isLoading: salesLoading } = useQuery<SalesAnalytics>({\n    queryKey: ['/api/analytics/sales'],\n  });\n\n  if (isLoading || salesLoading) {\n    return <LoadingSkeleton />;\n  }\n\n  if (!analytics) {\n    return (\n      <div className=\"p-6 flex items-center justify-center\">\n        <p className=\"text-muted-foreground\">Unable to load analytics data</p>\n      </div>\n    );\n  }\n\n  const weekTrend = analytics.quotesThisWeek >= analytics.quotesLastWeek ? 'up' : 'down';\n  const weekChange = analytics.quotesLastWeek > 0 \n    ? Math.round(((analytics.quotesThisWeek - analytics.quotesLastWeek) / analytics.quotesLastWeek) * 100)\n    : 0;\n\n  const pieData = analytics.quotesByStatus.filter(s => s.count > 0).map(s => ({\n    name: s.status.charAt(0).toUpperCase() + s.status.slice(1),\n    value: s.count,\n  }));\n\n  const creatorData = analytics.quotesByCreator.map(c => ({\n    name: c.userName.split(' ')[0],\n    total: c.total,\n    approved: c.approved,\n    declined: c.declined,\n    winRate: c.total > 0 ? Math.round((c.approved / (c.approved + c.declined || 1)) * 100) : 0,\n  }));\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-2xl font-bold\" data-testid=\"text-page-title\">Quote Analytics</h1>\n        <p className=\"text-muted-foreground\">Track quote performance and conversion rates</p>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-4 gap-4\">\n        <StatCard\n          title=\"Total Quotes\"\n          value={analytics.totalQuotes}\n          subValue={`${analytics.quotesThisWeek} this week (${weekChange >= 0 ? '+' : ''}${weekChange}%)`}\n          icon={FileText}\n          trend={weekTrend}\n        />\n        <StatCard\n          title=\"Lead Conversion Rate\"\n          value={`${(salesAnalytics?.quoteConversionRate || 0).toFixed(1)}%`}\n          subValue=\"Won leads with quotes sent\"\n          icon={TrendingUp}\n        />\n        <StatCard\n          title=\"Average Deal Size\"\n          value={formatCurrency(salesAnalytics?.averageDealSize || 0)}\n          subValue=\"Mean value of won opportunities\"\n          icon={DollarSign}\n        />\n        <StatCard\n          title=\"Pending Quotes\"\n          value={salesAnalytics?.pendingQuotes || analytics.sentQuotes}\n          subValue=\"Awaiting client response\"\n          icon={Send}\n        />\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-4 gap-4\">\n        <StatCard\n          title=\"Pipeline Forecast\"\n          value={formatCurrency(salesAnalytics?.quotePipelineValue || analytics.pipelineValue)}\n          subValue=\"Active leads (opportunity value)\"\n          icon={TrendingUp}\n        />\n        <StatCard\n          title=\"Won This Period\"\n          value={formatCurrency(salesAnalytics?.wonValue || analytics.wonValue)}\n          subValue=\"Converted opportunities\"\n          icon={CheckCircle2}\n        />\n        <StatCard\n          title=\"Monthly Revenue\"\n          value={formatCurrency(salesAnalytics?.monthlyRevenue || 0)}\n          subValue=\"Paid invoices this month\"\n          icon={DollarSign}\n        />\n        <StatCard\n          title=\"YTD Revenue\"\n          value={formatCurrency(salesAnalytics?.yearToDateRevenue || 0)}\n          subValue=\"Total paid this year\"\n          icon={DollarSign}\n        />\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Quote Status Breakdown</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {pieData.length > 0 ? (\n              <ResponsiveContainer width=\"100%\" height={300}>\n                <PieChart>\n                  <Pie\n                    data={pieData}\n                    cx=\"50%\"\n                    cy=\"50%\"\n                    labelLine={false}\n                    label={({ name, percent }) => `${name} (${(percent * 100).toFixed(0)}%)`}\n                    outerRadius={100}\n                    fill=\"#8884d8\"\n                    dataKey=\"value\"\n                  >\n                    {pieData.map((_, index) => (\n                      <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />\n                    ))}\n                  </Pie>\n                  <Tooltip />\n                  <Legend />\n                </PieChart>\n              </ResponsiveContainer>\n            ) : (\n              <div className=\"h-[300px] flex items-center justify-center text-muted-foreground\">\n                No quote data available\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Performance by Team Member</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {creatorData.length > 0 ? (\n              <ResponsiveContainer width=\"100%\" height={300}>\n                <BarChart data={creatorData} layout=\"vertical\">\n                  <CartesianGrid strokeDasharray=\"3 3\" />\n                  <XAxis type=\"number\" />\n                  <YAxis type=\"category\" dataKey=\"name\" width={80} />\n                  <Tooltip />\n                  <Legend />\n                  <Bar dataKey=\"approved\" name=\"Approved\" fill=\"#10b981\" stackId=\"a\" />\n                  <Bar dataKey=\"declined\" name=\"Declined\" fill=\"#ef4444\" stackId=\"a\" />\n                </BarChart>\n              </ResponsiveContainer>\n            ) : (\n              <div className=\"h-[300px] flex items-center justify-center text-muted-foreground\">\n                No team data available\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Quote Pipeline</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {analytics.quotesByStatus.map(({ status, count }) => {\n              const StatusIcon = statusIcons[status] || FileText;\n              const percentage = analytics.totalQuotes > 0 \n                ? Math.round((count / analytics.totalQuotes) * 100) \n                : 0;\n              return (\n                <div key={status} className=\"space-y-2\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-2\">\n                      <StatusIcon className=\"h-4 w-4 text-muted-foreground\" />\n                      <span className=\"capitalize\">{status}</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <span className=\"text-sm text-muted-foreground\">{count}</span>\n                      <Badge variant={statusColors[status] as any || 'secondary'}>\n                        {percentage}%\n                      </Badge>\n                    </div>\n                  </div>\n                  <Progress value={percentage} className=\"h-2\" />\n                </div>\n              );\n            })}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Team Win Rates</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {creatorData.length > 0 ? (\n              creatorData.map((creator, index) => (\n                <div key={index} className=\"space-y-2\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"font-medium\">{creator.name}</span>\n                    <div className=\"flex items-center gap-2\">\n                      <span className=\"text-sm text-muted-foreground\">\n                        {creator.total} quotes\n                      </span>\n                      <Badge variant={creator.winRate >= 50 ? 'default' : 'secondary'}>\n                        {creator.winRate}% win rate\n                      </Badge>\n                    </div>\n                  </div>\n                  <Progress \n                    value={creator.winRate} \n                    className=\"h-2\"\n                  />\n                </div>\n              ))\n            ) : (\n              <div className=\"text-muted-foreground text-center py-8\">\n                No team data available\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Recent Quotes</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-3\">\n            {analytics.recentQuotes.length > 0 ? (\n              analytics.recentQuotes.map((quote) => {\n                const StatusIcon = statusIcons[quote.status] || FileText;\n                return (\n                  <div \n                    key={quote.id} \n                    className=\"flex items-center justify-between p-3 rounded-lg border\"\n                    data-testid={`quote-row-${quote.id}`}\n                  >\n                    <div className=\"flex items-center gap-3\">\n                      <StatusIcon className=\"h-4 w-4 text-muted-foreground\" />\n                      <div>\n                        <p className=\"font-medium\">{quote.quoteNumber}</p>\n                        <p className=\"text-sm text-muted-foreground\">{quote.siteAddress}</p>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-3\">\n                      <span className=\"font-medium\">{formatCurrency(quote.totalAmount)}</span>\n                      <Badge variant={statusColors[quote.status] as any || 'secondary'}>\n                        {quote.status}\n                      </Badge>\n                    </div>\n                  </div>\n                );\n              })\n            ) : (\n              <div className=\"text-muted-foreground text-center py-8\">\n                No quotes yet\n              </div>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":14157,"size_tokens":null},"client/src/pages/Quotes.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { format } from \"date-fns\";\nimport { Link } from \"wouter\";\nimport {\n  Search,\n  Filter,\n  Download,\n  Eye,\n  Send,\n  CheckCircle,\n  XCircle,\n  Clock,\n  FileText,\n  DollarSign,\n  Calendar,\n  User,\n  MapPin,\n  MoreHorizontal,\n  Plus,\n  ArrowUpDown,\n  ChevronDown,\n  Calculator,\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n  DropdownMenuSeparator,\n} from \"@/components/ui/dropdown-menu\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { QuotePLPanel } from \"@/components/pl/QuotePLPanel\";\nimport type { Quote, Client, Lead } from \"@shared/schema\";\n\ntype QuoteStatus = \"draft\" | \"sent\" | \"approved\" | \"rejected\" | \"expired\";\n\ninterface QuoteWithDetails extends Quote {\n  client?: Client;\n  lead?: Lead;\n}\n\nfunction getStatusColor(status: QuoteStatus): string {\n  switch (status) {\n    case \"draft\":\n      return \"bg-muted text-muted-foreground\";\n    case \"sent\":\n      return \"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300\";\n    case \"approved\":\n      return \"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300\";\n    case \"rejected\":\n      return \"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300\";\n    case \"expired\":\n      return \"bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300\";\n    default:\n      return \"bg-muted text-muted-foreground\";\n  }\n}\n\nfunction getStatusIcon(status: QuoteStatus) {\n  switch (status) {\n    case \"draft\":\n      return <FileText className=\"h-3.5 w-3.5\" />;\n    case \"sent\":\n      return <Send className=\"h-3.5 w-3.5\" />;\n    case \"approved\":\n      return <CheckCircle className=\"h-3.5 w-3.5\" />;\n    case \"rejected\":\n      return <XCircle className=\"h-3.5 w-3.5\" />;\n    case \"expired\":\n      return <Clock className=\"h-3.5 w-3.5\" />;\n    default:\n      return <FileText className=\"h-3.5 w-3.5\" />;\n  }\n}\n\nexport default function Quotes() {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState<string>(\"all\");\n  const [typeFilter, setTypeFilter] = useState<string>(\"all\");\n  const [selectedQuote, setSelectedQuote] = useState<QuoteWithDetails | null>(null);\n  const [sortField, setSortField] = useState<string>(\"createdAt\");\n  const [sortDirection, setSortDirection] = useState<\"asc\" | \"desc\">(\"desc\");\n\n  const { data: quotes = [], isLoading: quotesLoading } = useQuery<Quote[]>({\n    queryKey: [\"/api/quotes\"],\n  });\n\n  const { data: clients = [] } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const { data: leads = [] } = useQuery<Lead[]>({\n    queryKey: [\"/api/leads\"],\n  });\n\n  const sendQuoteMutation = useMutation({\n    mutationFn: async (quoteId: string) => {\n      return apiRequest(\"PATCH\", `/api/quotes/${quoteId}`, { status: \"sent\", sentAt: new Date().toISOString() });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/quotes\"] });\n      toast({\n        title: \"Quote sent\",\n        description: \"The quote has been marked as sent.\",\n      });\n    },\n  });\n\n  const approveQuoteMutation = useMutation({\n    mutationFn: async (quoteId: string) => {\n      return apiRequest(\"PATCH\", `/api/quotes/${quoteId}`, { status: \"approved\", approvedAt: new Date().toISOString() });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/quotes\"] });\n      toast({\n        title: \"Quote approved\",\n        description: \"The quote has been approved.\",\n      });\n    },\n  });\n\n  const getClientName = (clientId: string | null) => {\n    if (!clientId) return \"Unknown Client\";\n    const client = clients.find((c) => c.id === clientId);\n    return client?.name || client?.companyName || \"Unknown Client\";\n  };\n\n  const getLeadNumber = (leadId: string | null) => {\n    if (!leadId) return null;\n    const lead = leads.find((l) => l.id === leadId);\n    return lead?.leadNumber || null;\n  };\n\n  const quotesWithDetails: QuoteWithDetails[] = quotes.map((quote) => ({\n    ...quote,\n    client: clients.find((c) => c.id === quote.clientId),\n    lead: leads.find((l) => l.id === quote.leadId),\n  }));\n\n  const filteredQuotes = quotesWithDetails.filter((quote) => {\n    const matchesSearch =\n      searchQuery === \"\" ||\n      quote.quoteNumber.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      getClientName(quote.clientId).toLowerCase().includes(searchQuery.toLowerCase()) ||\n      (quote.siteAddress || \"\").toLowerCase().includes(searchQuery.toLowerCase());\n\n    const matchesStatus = statusFilter === \"all\" || quote.status === statusFilter;\n    const matchesType =\n      typeFilter === \"all\" ||\n      (typeFilter === \"trade\" && quote.isTradeQuote) ||\n      (typeFilter === \"public\" && !quote.isTradeQuote);\n\n    return matchesSearch && matchesStatus && matchesType;\n  });\n\n  const sortedQuotes = [...filteredQuotes].sort((a, b) => {\n    let aValue: any;\n    let bValue: any;\n\n    switch (sortField) {\n      case \"quoteNumber\":\n        aValue = a.quoteNumber;\n        bValue = b.quoteNumber;\n        break;\n      case \"totalAmount\":\n        aValue = parseFloat(a.totalAmount);\n        bValue = parseFloat(b.totalAmount);\n        break;\n      case \"status\":\n        aValue = a.status;\n        bValue = b.status;\n        break;\n      case \"createdAt\":\n      default:\n        aValue = new Date(a.createdAt).getTime();\n        bValue = new Date(b.createdAt).getTime();\n        break;\n    }\n\n    if (sortDirection === \"asc\") {\n      return aValue > bValue ? 1 : -1;\n    }\n    return aValue < bValue ? 1 : -1;\n  });\n\n  const stats = {\n    total: quotes.length,\n    draft: quotes.filter((q) => q.status === \"draft\").length,\n    sent: quotes.filter((q) => q.status === \"sent\").length,\n    approved: quotes.filter((q) => q.status === \"approved\").length,\n    // Pipeline Forecast uses opportunity_value from active leads (not sum of all quotes)\n    // This prevents inflation from multiple quotes per lead\n    pipelineForecast: leads\n      .filter((l) => ![\"won\", \"lost\", \"converted_to_job\"].includes(l.stage) && l.opportunityValue)\n      .reduce((sum, l) => sum + parseFloat(l.opportunityValue || \"0\"), 0),\n    pendingValue: quotes\n      .filter((q) => q.status === \"sent\")\n      .reduce((sum, q) => sum + parseFloat(q.totalAmount), 0),\n  };\n\n  const handleExportCSV = () => {\n    const headers = [\"Quote Number\", \"Client\", \"Address\", \"Amount\", \"Status\", \"Type\", \"Created\"];\n    const rows = sortedQuotes.map((quote) => [\n      quote.quoteNumber,\n      getClientName(quote.clientId),\n      quote.siteAddress,\n      `$${parseFloat(quote.totalAmount).toLocaleString()}`,\n      quote.status,\n      quote.isTradeQuote ? \"Trade\" : \"Public\",\n      format(new Date(quote.createdAt), \"dd/MM/yyyy\"),\n    ]);\n\n    const csvContent = [headers.join(\",\"), ...rows.map((row) => row.map((cell) => `\"${cell}\"`).join(\",\"))].join(\"\\n\");\n\n    const blob = new Blob([csvContent], { type: \"text/csv\" });\n    const url = window.URL.createObjectURL(blob);\n    const a = document.createElement(\"a\");\n    a.href = url;\n    a.download = `quotes-${format(new Date(), \"yyyy-MM-dd\")}.csv`;\n    a.click();\n    window.URL.revokeObjectURL(url);\n\n    toast({\n      title: \"Export complete\",\n      description: `${sortedQuotes.length} quotes exported to CSV.`,\n    });\n  };\n\n  const toggleSort = (field: string) => {\n    if (sortField === field) {\n      setSortDirection(sortDirection === \"asc\" ? \"desc\" : \"asc\");\n    } else {\n      setSortField(field);\n      setSortDirection(\"desc\");\n    }\n  };\n\n  if (quotesLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold\" data-testid=\"text-page-title\">Quotes</h1>\n          <p className=\"text-muted-foreground\">\n            Manage all quotes across your leads\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Button variant=\"outline\" size=\"sm\" onClick={handleExportCSV} data-testid=\"button-export-csv\">\n            <Download className=\"h-4 w-4 mr-2\" />\n            Export CSV\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-4\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2 gap-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Quotes</CardTitle>\n            <FileText className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"stat-total-quotes\">{stats.total}</div>\n            <p className=\"text-xs text-muted-foreground\">\n              {stats.draft} drafts, {stats.sent} pending\n            </p>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2 gap-2\">\n            <CardTitle className=\"text-sm font-medium\">Approved</CardTitle>\n            <CheckCircle className=\"h-4 w-4 text-green-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-green-600\" data-testid=\"stat-approved-quotes\">{stats.approved}</div>\n            <p className=\"text-xs text-muted-foreground\">\n              {stats.total > 0 ? ((stats.approved / stats.total) * 100).toFixed(0) : 0}% approval rate\n            </p>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2 gap-2\">\n            <CardTitle className=\"text-sm font-medium\">Pipeline Forecast</CardTitle>\n            <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"stat-pipeline-forecast\">\n              ${stats.pipelineForecast.toLocaleString()}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              Based on primary quotes\n            </p>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2 gap-2\">\n            <CardTitle className=\"text-sm font-medium\">Pending Value</CardTitle>\n            <Clock className=\"h-4 w-4 text-blue-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-blue-600\" data-testid=\"stat-pending-value\">\n              ${stats.pendingValue.toLocaleString()}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              Awaiting client response\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\n            <CardTitle>All Quotes</CardTitle>\n            <div className=\"flex flex-wrap items-center gap-2\">\n              <div className=\"relative\">\n                <Search className=\"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Search quotes...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-8 w-[200px]\"\n                  data-testid=\"input-search-quotes\"\n                />\n              </div>\n              <Select value={statusFilter} onValueChange={setStatusFilter}>\n                <SelectTrigger className=\"w-[130px]\" data-testid=\"select-status-filter\">\n                  <SelectValue placeholder=\"Status\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Status</SelectItem>\n                  <SelectItem value=\"draft\">Draft</SelectItem>\n                  <SelectItem value=\"sent\">Sent</SelectItem>\n                  <SelectItem value=\"approved\">Approved</SelectItem>\n                  <SelectItem value=\"rejected\">Rejected</SelectItem>\n                  <SelectItem value=\"expired\">Expired</SelectItem>\n                </SelectContent>\n              </Select>\n              <Select value={typeFilter} onValueChange={setTypeFilter}>\n                <SelectTrigger className=\"w-[130px]\" data-testid=\"select-type-filter\">\n                  <SelectValue placeholder=\"Type\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Types</SelectItem>\n                  <SelectItem value=\"public\">Public</SelectItem>\n                  <SelectItem value=\"trade\">Trade</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"rounded-md border\">\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      className=\"-ml-3 h-8\"\n                      onClick={() => toggleSort(\"quoteNumber\")}\n                      data-testid=\"button-sort-quote-number\"\n                    >\n                      Quote #\n                      <ArrowUpDown className=\"ml-2 h-4 w-4\" />\n                    </Button>\n                  </TableHead>\n                  <TableHead>Client</TableHead>\n                  <TableHead>Lead</TableHead>\n                  <TableHead>Address</TableHead>\n                  <TableHead>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      className=\"-ml-3 h-8\"\n                      onClick={() => toggleSort(\"totalAmount\")}\n                      data-testid=\"button-sort-amount\"\n                    >\n                      Amount\n                      <ArrowUpDown className=\"ml-2 h-4 w-4\" />\n                    </Button>\n                  </TableHead>\n                  <TableHead>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      className=\"-ml-3 h-8\"\n                      onClick={() => toggleSort(\"status\")}\n                      data-testid=\"button-sort-status\"\n                    >\n                      Status\n                      <ArrowUpDown className=\"ml-2 h-4 w-4\" />\n                    </Button>\n                  </TableHead>\n                  <TableHead>Type</TableHead>\n                  <TableHead>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      className=\"-ml-3 h-8\"\n                      onClick={() => toggleSort(\"createdAt\")}\n                      data-testid=\"button-sort-date\"\n                    >\n                      Created\n                      <ArrowUpDown className=\"ml-2 h-4 w-4\" />\n                    </Button>\n                  </TableHead>\n                  <TableHead className=\"w-[50px]\"></TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {sortedQuotes.length === 0 ? (\n                  <TableRow>\n                    <TableCell colSpan={9} className=\"text-center py-8 text-muted-foreground\">\n                      {searchQuery || statusFilter !== \"all\" || typeFilter !== \"all\"\n                        ? \"No quotes match your filters\"\n                        : \"No quotes yet\"}\n                    </TableCell>\n                  </TableRow>\n                ) : (\n                  sortedQuotes.map((quote) => (\n                    <TableRow\n                      key={quote.id}\n                      className=\"cursor-pointer hover-elevate\"\n                      onClick={() => setSelectedQuote(quote)}\n                      data-testid={`row-quote-${quote.id}`}\n                    >\n                      <TableCell className=\"font-mono font-medium\" data-testid={`text-quote-number-${quote.id}`}>\n                        {quote.quoteNumber}\n                      </TableCell>\n                      <TableCell data-testid={`text-client-name-${quote.id}`}>\n                        {getClientName(quote.clientId)}\n                      </TableCell>\n                      <TableCell>\n                        {quote.leadId ? (\n                          <span className=\"font-mono text-xs text-muted-foreground\" data-testid={`text-lead-number-${quote.id}`}>\n                            {getLeadNumber(quote.leadId)}\n                          </span>\n                        ) : (\n                          <span className=\"text-xs text-muted-foreground\">-</span>\n                        )}\n                      </TableCell>\n                      <TableCell className=\"max-w-[200px] truncate\" title={quote.siteAddress || undefined}>\n                        {quote.siteAddress || \"-\"}\n                      </TableCell>\n                      <TableCell className=\"font-semibold\" data-testid={`text-amount-${quote.id}`}>\n                        ${parseFloat(quote.totalAmount).toLocaleString()}\n                      </TableCell>\n                      <TableCell>\n                        <Badge className={`gap-1 ${getStatusColor(quote.status as QuoteStatus)}`} data-testid={`badge-status-${quote.id}`}>\n                          {getStatusIcon(quote.status as QuoteStatus)}\n                          {quote.status}\n                        </Badge>\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant={quote.isTradeQuote ? \"secondary\" : \"outline\"} data-testid={`badge-type-${quote.id}`}>\n                          {quote.isTradeQuote ? \"Trade\" : \"Public\"}\n                        </Badge>\n                      </TableCell>\n                      <TableCell className=\"text-muted-foreground\">\n                        {format(new Date(quote.createdAt), \"dd MMM yyyy\")}\n                      </TableCell>\n                      <TableCell>\n                        <DropdownMenu>\n                          <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>\n                            <Button variant=\"ghost\" size=\"icon\" data-testid={`button-actions-${quote.id}`}>\n                              <MoreHorizontal className=\"h-4 w-4\" />\n                            </Button>\n                          </DropdownMenuTrigger>\n                          <DropdownMenuContent align=\"end\">\n                            <DropdownMenuItem onClick={(e) => { e.stopPropagation(); setSelectedQuote(quote); }}>\n                              <Eye className=\"h-4 w-4 mr-2\" />\n                              View Details\n                            </DropdownMenuItem>\n                            {quote.status === \"draft\" && (\n                              <DropdownMenuItem onClick={(e) => { e.stopPropagation(); sendQuoteMutation.mutate(quote.id); }}>\n                                <Send className=\"h-4 w-4 mr-2\" />\n                                Send Quote\n                              </DropdownMenuItem>\n                            )}\n                            {quote.status === \"sent\" && (\n                              <DropdownMenuItem onClick={(e) => { e.stopPropagation(); approveQuoteMutation.mutate(quote.id); }}>\n                                <CheckCircle className=\"h-4 w-4 mr-2\" />\n                                Mark Approved\n                              </DropdownMenuItem>\n                            )}\n                          </DropdownMenuContent>\n                        </DropdownMenu>\n                      </TableCell>\n                    </TableRow>\n                  ))\n                )}\n              </TableBody>\n            </Table>\n          </div>\n          <div className=\"mt-4 text-sm text-muted-foreground\">\n            Showing {sortedQuotes.length} of {quotes.length} quotes\n          </div>\n        </CardContent>\n      </Card>\n\n      <Dialog open={!!selectedQuote} onOpenChange={() => setSelectedQuote(null)}>\n        <DialogContent className=\"max-w-3xl\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-3\">\n              <span className=\"font-mono\">{selectedQuote?.quoteNumber}</span>\n              {selectedQuote && (\n                <Badge className={getStatusColor(selectedQuote.status as QuoteStatus)}>\n                  {selectedQuote.status}\n                </Badge>\n              )}\n            </DialogTitle>\n          </DialogHeader>\n          {selectedQuote && (\n            <Tabs defaultValue=\"details\" className=\"w-full\">\n              <TabsList className=\"grid w-full grid-cols-2\">\n                <TabsTrigger value=\"details\" data-testid=\"tab-quote-details\">\n                  <FileText className=\"h-4 w-4 mr-2\" />\n                  Quote Details\n                </TabsTrigger>\n                <TabsTrigger value=\"pl\" data-testid=\"tab-quote-pl\">\n                  <Calculator className=\"h-4 w-4 mr-2\" />\n                  P&L Analysis\n                </TabsTrigger>\n              </TabsList>\n              <TabsContent value=\"details\">\n                <ScrollArea className=\"max-h-[55vh]\">\n                  <div className=\"space-y-6 pr-4 pt-4\">\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"space-y-1\">\n                        <div className=\"text-sm text-muted-foreground flex items-center gap-2\">\n                          <User className=\"h-4 w-4\" />\n                          Client\n                        </div>\n                        <div className=\"font-medium\" data-testid=\"dialog-client-name\">{getClientName(selectedQuote.clientId)}</div>\n                      </div>\n                      {selectedQuote.leadId && (\n                        <div className=\"space-y-1\">\n                          <div className=\"text-sm text-muted-foreground flex items-center gap-2\">\n                            <FileText className=\"h-4 w-4\" />\n                            Lead\n                          </div>\n                          <div className=\"font-mono\" data-testid=\"dialog-lead-number\">\n                            {getLeadNumber(selectedQuote.leadId)}\n                          </div>\n                        </div>\n                      )}\n                    </div>\n\n                    <div className=\"space-y-1\">\n                      <div className=\"text-sm text-muted-foreground flex items-center gap-2\">\n                        <MapPin className=\"h-4 w-4\" />\n                        Site Address\n                      </div>\n                      <div data-testid=\"dialog-address\">{selectedQuote.siteAddress}</div>\n                    </div>\n\n                    <Separator />\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"space-y-1\">\n                        <div className=\"text-sm text-muted-foreground\">Fence Details</div>\n                        <div>\n                          {selectedQuote.totalLength}m  {selectedQuote.fenceHeight}mm\n                        </div>\n                      </div>\n                      <div className=\"space-y-1\">\n                        <div className=\"text-sm text-muted-foreground\">Quote Type</div>\n                        <Badge variant={selectedQuote.isTradeQuote ? \"secondary\" : \"outline\"}>\n                          {selectedQuote.isTradeQuote ? \"Trade Quote\" : \"Public Quote\"}\n                        </Badge>\n                        {selectedQuote.isTradeQuote && selectedQuote.tradeDiscount && (\n                          <span className=\"ml-2 text-sm text-green-600\">\n                            ({selectedQuote.tradeDiscount}% discount)\n                          </span>\n                        )}\n                      </div>\n                    </div>\n\n                {selectedQuote.lineItems && Array.isArray(selectedQuote.lineItems) && (\n                  <>\n                    <Separator />\n                    <div className=\"space-y-3\">\n                      <div className=\"text-sm font-medium\">Line Items</div>\n                      <div className=\"rounded-md border\">\n                        <Table>\n                          <TableHeader>\n                            <TableRow>\n                              <TableHead>Product</TableHead>\n                              <TableHead className=\"text-right\">Qty</TableHead>\n                              <TableHead className=\"text-right\">Unit Price</TableHead>\n                              <TableHead className=\"text-right\">Total</TableHead>\n                            </TableRow>\n                          </TableHeader>\n                          <TableBody>\n                            {(selectedQuote.lineItems as any[]).map((item, idx) => (\n                              <TableRow key={idx}>\n                                <TableCell>{item.productName || item.productId}</TableCell>\n                                <TableCell className=\"text-right\">{item.quantity}</TableCell>\n                                <TableCell className=\"text-right\">${item.unitPrice}</TableCell>\n                                <TableCell className=\"text-right\">${item.totalPrice}</TableCell>\n                              </TableRow>\n                            ))}\n                          </TableBody>\n                        </Table>\n                      </div>\n                    </div>\n                  </>\n                )}\n\n                <Separator />\n\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">Materials Subtotal</span>\n                    <span>${parseFloat(selectedQuote.materialsSubtotal || \"0\").toLocaleString()}</span>\n                  </div>\n                  {parseFloat(selectedQuote.labourEstimate || \"0\") > 0 && (\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-muted-foreground\">Labour</span>\n                      <span>${parseFloat(selectedQuote.labourEstimate || \"0\").toLocaleString()}</span>\n                    </div>\n                  )}\n                  {selectedQuote.isTradeQuote && selectedQuote.tradeDiscount && (\n                    <div className=\"flex justify-between text-green-600\">\n                      <span>Trade Discount ({selectedQuote.tradeDiscount}%)</span>\n                      <span>\n                        -${((parseFloat(selectedQuote.materialsSubtotal || \"0\") * parseFloat(selectedQuote.tradeDiscount)) / 100).toLocaleString()}\n                      </span>\n                    </div>\n                  )}\n                  <Separator />\n                  <div className=\"flex justify-between text-lg font-bold\">\n                    <span>Total</span>\n                    <span data-testid=\"dialog-total-amount\">${parseFloat(selectedQuote.totalAmount).toLocaleString()}</span>\n                  </div>\n                  <div className=\"flex justify-between text-sm text-muted-foreground\">\n                    <span>Deposit Required ({selectedQuote.depositPercent}%)</span>\n                    <span>${parseFloat(selectedQuote.depositRequired || \"0\").toLocaleString()}</span>\n                  </div>\n                </div>\n\n                {selectedQuote.notes && (\n                  <>\n                    <Separator />\n                    <div className=\"space-y-1\">\n                      <div className=\"text-sm font-medium\">Notes</div>\n                      <div className=\"text-sm text-muted-foreground\">{selectedQuote.notes}</div>\n                    </div>\n                  </>\n                )}\n\n                <Separator />\n\n                <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                  <div>\n                    <span className=\"text-muted-foreground\">Created: </span>\n                    {format(new Date(selectedQuote.createdAt), \"dd MMM yyyy HH:mm\")}\n                  </div>\n                  {selectedQuote.sentAt && (\n                    <div>\n                      <span className=\"text-muted-foreground\">Sent: </span>\n                      {format(new Date(selectedQuote.sentAt), \"dd MMM yyyy HH:mm\")}\n                    </div>\n                  )}\n                  {selectedQuote.approvedAt && (\n                    <div>\n                      <span className=\"text-muted-foreground\">Approved: </span>\n                      {format(new Date(selectedQuote.approvedAt), \"dd MMM yyyy HH:mm\")}\n                    </div>\n                  )}\n                </div>\n\n                    <div className=\"flex gap-2 pt-4\">\n                      {selectedQuote.status === \"draft\" && (\n                        <Button\n                          onClick={() => {\n                            sendQuoteMutation.mutate(selectedQuote.id);\n                            setSelectedQuote(null);\n                          }}\n                          data-testid=\"button-send-quote\"\n                        >\n                          <Send className=\"h-4 w-4 mr-2\" />\n                          Send Quote\n                        </Button>\n                      )}\n                      {selectedQuote.status === \"sent\" && (\n                        <Button\n                          onClick={() => {\n                            approveQuoteMutation.mutate(selectedQuote.id);\n                            setSelectedQuote(null);\n                          }}\n                          data-testid=\"button-approve-quote\"\n                        >\n                          <CheckCircle className=\"h-4 w-4 mr-2\" />\n                          Mark Approved\n                        </Button>\n                      )}\n                      <Button variant=\"outline\" onClick={() => setSelectedQuote(null)}>\n                        Close\n                      </Button>\n                    </div>\n                  </div>\n                </ScrollArea>\n              </TabsContent>\n              <TabsContent value=\"pl\">\n                <ScrollArea className=\"max-h-[55vh]\">\n                  <div className=\"pt-4 pr-4\">\n                    <QuotePLPanel \n                      quoteId={selectedQuote.id} \n                      quoteTotalAmount={selectedQuote.totalAmount} \n                    />\n                  </div>\n                </ScrollArea>\n              </TabsContent>\n            </Tabs>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":31380,"size_tokens":null},"client/src/pages/Messages.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Label } from \"@/components/ui/label\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  MessageSquare,\n  Send,\n  Phone,\n  Clock,\n  CheckCircle,\n  XCircle,\n  AlertCircle,\n  Search,\n  User,\n  Loader2,\n  UserCheck,\n  Link2,\n  Building2,\n  FileText,\n  Briefcase,\n  CalendarRange,\n  AlertTriangle,\n} from \"lucide-react\";\nimport type { Client, SMSLog, User as UserType, Lead, Job, SMSConversation } from \"@shared/schema\";\nimport { format, formatDistanceToNow } from \"date-fns\";\n\nexport default function Messages() {\n  const { toast } = useToast();\n  const [selectedPhone, setSelectedPhone] = useState<string | null>(null);\n  const [newMessage, setNewMessage] = useState(\"\");\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [showResolved, setShowResolved] = useState(false);\n  const [selectionMode, setSelectionMode] = useState(false);\n  const [selectedMessages, setSelectedMessages] = useState<Set<string>>(new Set());\n  const [attachDialogOpen, setAttachDialogOpen] = useState(false);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n\n  const { data: clients = [], isLoading: clientsLoading } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const { data: users = [], isLoading: usersLoading } = useQuery<UserType[]>({\n    queryKey: [\"/api/users\"],\n  });\n\n  const { data: leads = [], isLoading: leadsLoading } = useQuery<Lead[]>({\n    queryKey: [\"/api/leads\"],\n  });\n\n  const { data: jobs = [], isLoading: jobsLoading } = useQuery<Job[]>({\n    queryKey: [\"/api/jobs\"],\n  });\n\n  const { data: allMessages = [], isLoading: messagesLoading } = useQuery<SMSLog[]>({\n    queryKey: [\"/api/sms/logs\"],\n  });\n\n  const { data: conversations = [] } = useQuery<SMSConversation[]>({\n    queryKey: [\"/api/sms/conversations\"],\n  });\n\n  const { data: clientMessages = [], refetch: refetchClientMessages } = useQuery<SMSLog[]>({\n    queryKey: [\"/api/sms/conversation\", selectedPhone],\n    enabled: !!selectedPhone,\n  });\n\n  const [optimisticMessages, setOptimisticMessages] = useState<SMSLog[]>([]);\n\n  const updateConversationMutation = useMutation({\n    mutationFn: async ({ id, ...data }: { id: string; assignedTo?: string | null; isResolved?: boolean; clientId?: string | null }) => {\n      return apiRequest(\"PATCH\", `/api/sms/conversations/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/sms/conversations\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/sms/unread-count\"] });\n      toast({\n        title: \"Updated\",\n        description: \"Conversation updated successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update conversation.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const markReadMutation = useMutation({\n    mutationFn: async (data: { messageIds: string[]; conversationId?: string }) => {\n      return apiRequest(\"POST\", \"/api/sms/mark-read\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/sms/logs\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/sms/unread-count\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/sms/conversations\"] });\n    },\n  });\n\n  const createMessageRangeMutation = useMutation({\n    mutationFn: async (data: { conversationId: string; leadId?: string; jobId?: string; startMessageId: string; endMessageId: string; startDate: string; endDate: string; summary?: string }) => {\n      return apiRequest(\"POST\", \"/api/sms/message-ranges\", data);\n    },\n    onSuccess: () => {\n      setSelectionMode(false);\n      setSelectedMessages(new Set());\n      setAttachDialogOpen(false);\n      toast({\n        title: \"Attached\",\n        description: \"Messages attached to opportunity successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to attach messages.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const sendMessageMutation = useMutation({\n    mutationFn: async (data: { to: string; message: string; recipientName?: string; relatedEntityType?: string; relatedEntityId?: string }) => {\n      return apiRequest(\"POST\", \"/api/sms/send\", data);\n    },\n    onMutate: async (data) => {\n      const tempId = `temp-${Date.now()}`;\n      const optimisticMsg: SMSLog = {\n        id: tempId,\n        recipientPhone: data.to,\n        recipientName: data.recipientName || null,\n        message: data.message,\n        twilioMessageSid: null,\n        status: \"pending\",\n        isOutbound: true,\n        isRead: true,\n        relatedEntityType: data.relatedEntityType || null,\n        relatedEntityId: data.relatedEntityId || null,\n        sentAt: null,\n        deliveredAt: null,\n        errorMessage: null,\n        createdAt: new Date(),\n      };\n      setOptimisticMessages(prev => [...prev, optimisticMsg]);\n      setNewMessage(\"\");\n    },\n    onSuccess: async (_, variables) => {\n      toast({\n        title: \"Message Sent\",\n        description: \"Your SMS has been sent successfully.\",\n      });\n      const recipientPhone = variables.to;\n      \n      if (recipientPhone && !selectedPhone) {\n        setSelectedPhone(recipientPhone);\n      }\n      \n      try {\n        await Promise.all([\n          queryClient.invalidateQueries({ queryKey: [\"/api/sms/logs\"] }),\n          queryClient.invalidateQueries({ queryKey: [\"/api/sms/unread-count\"] }),\n          queryClient.invalidateQueries({ queryKey: [\"/api/sms/conversations\"] }),\n          selectedPhone ? queryClient.invalidateQueries({ queryKey: [\"/api/sms/conversation\", selectedPhone] }) : Promise.resolve(),\n          (recipientPhone && recipientPhone !== selectedPhone) \n            ? queryClient.invalidateQueries({ queryKey: [\"/api/sms/conversation\", recipientPhone] }) \n            : Promise.resolve(),\n        ]);\n      } finally {\n        setOptimisticMessages([]);\n      }\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to send message. SMS service may not be configured.\",\n        variant: \"destructive\",\n      });\n      setOptimisticMessages([]);\n    },\n  });\n\n  const getPhoneMessages = (phone: string): SMSLog[] => {\n    const normalizedPhone = phone.replace(/\\D/g, '').slice(-9);\n    return allMessages.filter(msg => \n      msg.recipientPhone.replace(/\\D/g, '').slice(-9) === normalizedPhone\n    );\n  };\n\n  const getLastMessageTime = (phone: string): Date | null => {\n    const messages = getPhoneMessages(phone);\n    if (messages.length === 0) return null;\n    return messages.reduce((latest, msg) => {\n      const msgDate = new Date(msg.createdAt);\n      return msgDate > latest ? msgDate : latest;\n    }, new Date(messages[0].createdAt));\n  };\n\n  const getUnreadCount = (phone: string): number => {\n    const messages = getPhoneMessages(phone);\n    return messages.filter(m => !m.isOutbound && !m.isRead).length;\n  };\n\n  const getConversationForPhone = (phone: string): SMSConversation | undefined => {\n    const normalizedPhone = phone.replace(/\\D/g, '').slice(-9);\n    return conversations.find(conv => \n      conv.phoneNumber.replace(/\\D/g, '').slice(-9) === normalizedPhone\n    );\n  };\n\n  const getClientByPhone = (phone: string): Client | undefined => {\n    const normalizedPhone = phone.replace(/\\D/g, '').slice(-9);\n    return clients.find(client => \n      client.phone?.replace(/\\D/g, '').slice(-9) === normalizedPhone\n    );\n  };\n\n  const uniquePhones = Array.from(new Set(allMessages.map(m => m.recipientPhone.replace(/\\D/g, '').slice(-9))))\n    .map(normalized => {\n      const msg = allMessages.find(m => m.recipientPhone.replace(/\\D/g, '').slice(-9) === normalized);\n      return msg?.recipientPhone || '';\n    })\n    .filter(Boolean);\n\n  const filteredPhones = uniquePhones.filter(phone => {\n    const client = getClientByPhone(phone);\n    const conv = getConversationForPhone(phone);\n    const messages = getPhoneMessages(phone);\n    const lastMsg = messages[messages.length - 1];\n\n    if (!showResolved && conv?.isResolved) return false;\n\n    const matchesSearch = searchQuery === \"\" || \n      phone.includes(searchQuery) ||\n      (client?.name?.toLowerCase().includes(searchQuery.toLowerCase()) ?? false) ||\n      (lastMsg?.recipientName?.toLowerCase().includes(searchQuery.toLowerCase()) ?? false);\n\n    return matchesSearch;\n  });\n\n  const sortedPhones = [...filteredPhones].sort((a, b) => {\n    const aTime = getLastMessageTime(a);\n    const bTime = getLastMessageTime(b);\n    if (!aTime && !bTime) return 0;\n    if (!aTime) return 1;\n    if (!bTime) return -1;\n    return bTime.getTime() - aTime.getTime();\n  });\n\n  const selectedClient = selectedPhone ? getClientByPhone(selectedPhone) : null;\n  const selectedConversation = selectedPhone ? getConversationForPhone(selectedPhone) : null;\n  const selectedMessages_ = selectedPhone ? getPhoneMessages(selectedPhone) : [];\n  const lastMsgName = selectedMessages_.length > 0 ? selectedMessages_[selectedMessages_.length - 1].recipientName : null;\n\n  const handleSendMessage = () => {\n    if (!selectedPhone || !newMessage.trim()) return;\n    \n    sendMessageMutation.mutate({\n      to: selectedPhone,\n      message: newMessage.trim(),\n      recipientName: selectedClient?.name || lastMsgName || undefined,\n      relatedEntityType: selectedClient ? \"client\" : undefined,\n      relatedEntityId: selectedClient?.id,\n    });\n  };\n\n  const handleSelectConversation = (phone: string) => {\n    setSelectedPhone(phone);\n    setSelectionMode(false);\n    setSelectedMessages(new Set());\n    \n    const messages = getPhoneMessages(phone);\n    const unreadMsgIds = messages.filter(m => !m.isOutbound && !m.isRead).map(m => m.id);\n    const conv = getConversationForPhone(phone);\n    \n    if (unreadMsgIds.length > 0) {\n      markReadMutation.mutate({\n        messageIds: unreadMsgIds,\n        conversationId: conv?.id,\n      });\n    }\n  };\n\n  const handleMessageSelect = (msgId: string) => {\n    setSelectedMessages(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(msgId)) {\n        newSet.delete(msgId);\n      } else {\n        newSet.add(msgId);\n      }\n      return newSet;\n    });\n  };\n\n  const handleAttachMessages = (opportunityType: 'lead' | 'job', opportunityId: string) => {\n    if (!selectedConversation || selectedMessages.size === 0) return;\n\n    const selectedMsgs = clientMessages.filter(m => selectedMessages.has(m.id));\n    const sortedMsgs = [...selectedMsgs].sort((a, b) => \n      new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime()\n    );\n\n    const startMsg = sortedMsgs[0];\n    const endMsg = sortedMsgs[sortedMsgs.length - 1];\n\n    createMessageRangeMutation.mutate({\n      conversationId: selectedConversation.id,\n      leadId: opportunityType === 'lead' ? opportunityId : undefined,\n      jobId: opportunityType === 'job' ? opportunityId : undefined,\n      startMessageId: startMsg.id,\n      endMessageId: endMsg.id,\n      startDate: new Date(startMsg.createdAt).toISOString(),\n      endDate: new Date(endMsg.createdAt).toISOString(),\n    });\n  };\n\n  const getStatusIcon = (status: string) => {\n    switch (status) {\n      case \"sent\":\n      case \"delivered\":\n        return <CheckCircle className=\"h-3 w-3 text-green-500\" />;\n      case \"failed\":\n        return <XCircle className=\"h-3 w-3 text-red-500\" />;\n      case \"pending\":\n        return <Clock className=\"h-3 w-3 text-yellow-500\" />;\n      case \"received\":\n        return <CheckCircle className=\"h-3 w-3 text-blue-500\" />;\n      default:\n        return <AlertCircle className=\"h-3 w-3 text-muted-foreground\" />;\n    }\n  };\n\n  const getAssignedUser = (userId: string | null): UserType | undefined => {\n    if (!userId) return undefined;\n    return users.find(u => u.id === userId);\n  };\n\n  const clientLeads = selectedClient \n    ? leads.filter(l => l.clientId === selectedClient.id)\n    : [];\n\n  const clientJobs = selectedClient\n    ? jobs.filter(j => j.clientId === selectedClient.id)\n    : [];\n\n  useEffect(() => {\n    if (messagesEndRef.current) {\n      messagesEndRef.current.scrollIntoView({ behavior: \"smooth\" });\n    }\n  }, [clientMessages]);\n\n  return (\n    <div className=\"flex h-[calc(100vh-4rem)] gap-4 p-4\">\n      <Card className=\"w-80 flex-shrink-0 flex flex-col\">\n        <CardHeader className=\"pb-3\">\n          <CardTitle className=\"flex items-center gap-2 text-lg\">\n            <MessageSquare className=\"h-5 w-5\" />\n            Conversations\n          </CardTitle>\n          <div className=\"relative mt-2\">\n            <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n            <Input\n              placeholder=\"Search...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"pl-9\"\n              data-testid=\"input-search-conversations\"\n            />\n          </div>\n          <div className=\"flex items-center gap-2 mt-2\">\n            <Switch\n              id=\"show-resolved\"\n              checked={showResolved}\n              onCheckedChange={setShowResolved}\n            />\n            <Label htmlFor=\"show-resolved\" className=\"text-sm\">Show resolved</Label>\n          </div>\n        </CardHeader>\n        <CardContent className=\"flex-1 overflow-hidden p-0\">\n          <ScrollArea className=\"h-full\">\n            {messagesLoading ? (\n              <div className=\"flex items-center justify-center py-8\">\n                <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n              </div>\n            ) : sortedPhones.length === 0 ? (\n              <div className=\"px-4 py-8 text-center text-sm text-muted-foreground\">\n                No conversations found\n              </div>\n            ) : (\n              <div className=\"space-y-1 p-2\">\n                {sortedPhones.map(phone => {\n                  const messages = getPhoneMessages(phone);\n                  const lastMessage = messages[messages.length - 1];\n                  const isSelected = selectedPhone === phone;\n                  const client = getClientByPhone(phone);\n                  const conv = getConversationForPhone(phone);\n                  const unreadCount = getUnreadCount(phone);\n                  const assignedUser = getAssignedUser(conv?.assignedTo || null);\n                  const displayName = client?.name || lastMessage?.recipientName || \"Unknown\";\n                  \n                  return (\n                    <button\n                      key={phone}\n                      onClick={() => handleSelectConversation(phone)}\n                      className={`w-full rounded-lg p-3 text-left transition-colors hover-elevate ${\n                        isSelected ? \"bg-accent\" : \"\"\n                      }`}\n                      data-testid={`button-conversation-${phone}`}\n                    >\n                      <div className=\"flex items-start gap-3\">\n                        <div className=\"relative\">\n                          <Avatar className=\"h-10 w-10\">\n                            <AvatarFallback className=\"bg-primary/10 text-primary\">\n                              {displayName.split(\" \").map(n => n[0]).join(\"\").slice(0, 2)}\n                            </AvatarFallback>\n                          </Avatar>\n                          {!conv?.isResolved && (\n                            <div className=\"absolute -top-1 -right-1 h-3 w-3 rounded-full bg-destructive border-2 border-background\" title=\"Action required\" />\n                          )}\n                        </div>\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"flex items-center justify-between gap-2\">\n                            <p className=\"font-medium truncate\">{displayName}</p>\n                            {unreadCount > 0 && (\n                              <Badge variant=\"destructive\" className=\"text-xs h-5 min-w-5 px-1.5\">\n                                {unreadCount}\n                              </Badge>\n                            )}\n                          </div>\n                          <p className=\"text-xs text-muted-foreground truncate mt-0.5\">\n                            {phone}\n                          </p>\n                          {lastMessage && (\n                            <p className=\"text-xs text-muted-foreground truncate mt-1\">\n                              {lastMessage.isOutbound ? \"You: \" : \"\"}{lastMessage.message.slice(0, 35)}...\n                            </p>\n                          )}\n                          <div className=\"flex items-center gap-2 mt-1\">\n                            {client && (\n                              <Badge variant=\"outline\" className=\"text-xs py-0 px-1\">\n                                <Building2 className=\"h-3 w-3 mr-0.5\" />\n                                Client\n                              </Badge>\n                            )}\n                            {assignedUser && (\n                              <Badge variant=\"secondary\" className=\"text-xs py-0 px-1\">\n                                <UserCheck className=\"h-3 w-3 mr-0.5\" />\n                                {assignedUser.firstName}\n                              </Badge>\n                            )}\n                            {conv?.isResolved && (\n                              <Badge variant=\"outline\" className=\"text-xs py-0 px-1 text-green-600 border-green-300\">\n                                <CheckCircle className=\"h-3 w-3 mr-0.5\" />\n                                Resolved\n                              </Badge>\n                            )}\n                          </div>\n                        </div>\n                        {lastMessage && (\n                          <span className=\"text-xs text-muted-foreground shrink-0\">\n                            {formatDistanceToNow(new Date(lastMessage.createdAt), { addSuffix: false })}\n                          </span>\n                        )}\n                      </div>\n                    </button>\n                  );\n                })}\n              </div>\n            )}\n          </ScrollArea>\n        </CardContent>\n      </Card>\n\n      <Card className=\"flex-1 flex flex-col\">\n        {selectedPhone ? (\n          <>\n            <CardHeader className=\"border-b pb-4\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-3\">\n                  <Avatar className=\"h-12 w-12\">\n                    <AvatarFallback className=\"bg-primary/10 text-primary text-lg\">\n                      {(selectedClient?.name || lastMsgName || \"?\").split(\" \").map(n => n[0]).join(\"\").slice(0, 2)}\n                    </AvatarFallback>\n                  </Avatar>\n                  <div>\n                    <CardTitle className=\"text-lg flex items-center gap-2\">\n                      {selectedClient?.name || lastMsgName || \"Unknown\"}\n                      {!selectedConversation?.isResolved && (\n                        <Badge variant=\"destructive\" className=\"text-xs\">\n                          <AlertTriangle className=\"h-3 w-3 mr-1\" />\n                          Action Required\n                        </Badge>\n                      )}\n                    </CardTitle>\n                    <div className=\"flex items-center gap-2 text-sm text-muted-foreground mt-0.5\">\n                      <Phone className=\"h-3 w-3\" />\n                      {selectedPhone}\n                      {selectedClient && (\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          <Building2 className=\"h-3 w-3 mr-1\" />\n                          Linked to Client\n                        </Badge>\n                      )}\n                    </div>\n                  </div>\n                </div>\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"flex flex-col gap-1\">\n                    <Label className=\"text-xs text-muted-foreground\">Assigned To</Label>\n                    <Select\n                      value={selectedConversation?.assignedTo || \"unassigned\"}\n                      onValueChange={(value) => {\n                        if (selectedConversation) {\n                          updateConversationMutation.mutate({\n                            id: selectedConversation.id,\n                            assignedTo: value === \"unassigned\" ? null : value,\n                          });\n                        }\n                      }}\n                      disabled={usersLoading || updateConversationMutation.isPending}\n                    >\n                      <SelectTrigger className=\"w-36\" data-testid=\"select-assigned-to\">\n                        {usersLoading ? (\n                          <div className=\"flex items-center gap-2\">\n                            <Loader2 className=\"h-3 w-3 animate-spin\" />\n                            <span>Loading...</span>\n                          </div>\n                        ) : updateConversationMutation.isPending ? (\n                          <div className=\"flex items-center gap-2\">\n                            <Loader2 className=\"h-3 w-3 animate-spin\" />\n                            <span>Saving...</span>\n                          </div>\n                        ) : (\n                          <SelectValue placeholder=\"Assign to...\" />\n                        )}\n                      </SelectTrigger>\n                      <SelectContent>\n                        {!usersLoading && (\n                          <>\n                            <SelectItem value=\"unassigned\">Unassigned</SelectItem>\n                            {users.filter(u => u.role !== \"installer\" && u.role !== \"trade_client\").map(user => (\n                              <SelectItem key={user.id} value={user.id}>\n                                {user.firstName} {user.lastName}\n                              </SelectItem>\n                            ))}\n                          </>\n                        )}\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  <div className=\"flex flex-col gap-1 items-center\">\n                    <Label className=\"text-xs text-muted-foreground\">Resolved</Label>\n                    <Switch\n                      checked={selectedConversation?.isResolved || false}\n                      onCheckedChange={(checked) => {\n                        if (selectedConversation) {\n                          updateConversationMutation.mutate({\n                            id: selectedConversation.id,\n                            isResolved: checked,\n                          });\n                        }\n                      }}\n                      disabled={updateConversationMutation.isPending}\n                      data-testid=\"switch-resolved\"\n                    />\n                  </div>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2 mt-3\">\n                <Button \n                  variant={selectionMode ? \"secondary\" : \"outline\"} \n                  size=\"sm\"\n                  onClick={() => {\n                    setSelectionMode(!selectionMode);\n                    setSelectedMessages(new Set());\n                  }}\n                  data-testid=\"button-select-messages\"\n                >\n                  <CalendarRange className=\"h-4 w-4 mr-1\" />\n                  {selectionMode ? \"Cancel Selection\" : \"Select Messages\"}\n                </Button>\n                {selectionMode && selectedMessages.size > 0 && (\n                  <Button \n                    size=\"sm\" \n                    onClick={() => setAttachDialogOpen(true)}\n                    data-testid=\"button-attach-to-opportunity\"\n                  >\n                    <Link2 className=\"h-4 w-4 mr-1\" />\n                    Attach to Opportunity ({selectedMessages.size})\n                  </Button>\n                )}\n              </div>\n            </CardHeader>\n            <CardContent className=\"flex-1 overflow-hidden p-0\">\n              <ScrollArea className=\"h-full p-4\">\n                {messagesLoading ? (\n                  <div className=\"flex items-center justify-center py-8\">\n                    <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n                  </div>\n                ) : clientMessages.length === 0 && optimisticMessages.length === 0 ? (\n                  <div className=\"flex flex-col items-center justify-center py-16 text-center\">\n                    <MessageSquare className=\"h-12 w-12 text-muted-foreground/50 mb-4\" />\n                    <p className=\"text-lg font-medium text-muted-foreground\">No messages yet</p>\n                    <p className=\"text-sm text-muted-foreground mt-1\">\n                      Start the conversation by sending an SMS\n                    </p>\n                  </div>\n                ) : (\n                  <div className=\"space-y-4\">\n                    {[...clientMessages, ...optimisticMessages].map((msg) => {\n                      const isOutbound = msg.isOutbound !== false;\n                      const isSelected = selectedMessages.has(msg.id);\n                      return (\n                        <div\n                          key={msg.id}\n                          className={`flex ${isOutbound ? \"justify-end\" : \"justify-start\"}`}\n                        >\n                          {selectionMode && (\n                            <div className=\"flex items-center mr-2\">\n                              <Checkbox\n                                checked={isSelected}\n                                onCheckedChange={() => handleMessageSelect(msg.id)}\n                                data-testid={`checkbox-message-${msg.id}`}\n                              />\n                            </div>\n                          )}\n                          <div className={`max-w-[70%] space-y-1 ${selectionMode && isSelected ? \"ring-2 ring-primary rounded-lg\" : \"\"}`}>\n                            <div className={`rounded-lg px-4 py-2 ${\n                              isOutbound \n                                ? \"bg-primary text-primary-foreground\" \n                                : \"bg-muted text-foreground\"\n                            }`}>\n                              <p className=\"text-sm whitespace-pre-wrap\">{msg.message}</p>\n                            </div>\n                            <div className={`flex items-center gap-2 px-1 ${isOutbound ? \"justify-end\" : \"justify-start\"}`}>\n                              <span className=\"text-xs text-muted-foreground\">\n                                {format(new Date(msg.createdAt), \"MMM d, h:mm a\")}\n                              </span>\n                              {isOutbound && getStatusIcon(msg.status)}\n                              {!msg.isRead && !isOutbound && (\n                                <Badge variant=\"secondary\" className=\"text-xs py-0 px-1\">New</Badge>\n                              )}\n                            </div>\n                          </div>\n                        </div>\n                      );\n                    })}\n                    <div ref={messagesEndRef} />\n                  </div>\n                )}\n              </ScrollArea>\n            </CardContent>\n            <div className=\"border-t p-4\">\n              <div className=\"flex gap-2\">\n                <Textarea\n                  placeholder=\"Type a message...\"\n                  value={newMessage}\n                  onChange={(e) => setNewMessage(e.target.value)}\n                  className=\"resize-none\"\n                  rows={2}\n                  onKeyDown={(e) => {\n                    if (e.key === \"Enter\" && !e.shiftKey) {\n                      e.preventDefault();\n                      handleSendMessage();\n                    }\n                  }}\n                  data-testid=\"input-message\"\n                />\n                <Button\n                  onClick={handleSendMessage}\n                  disabled={!newMessage.trim() || sendMessageMutation.isPending}\n                  className=\"self-end\"\n                  data-testid=\"button-send-message\"\n                >\n                  {sendMessageMutation.isPending ? (\n                    <Loader2 className=\"h-4 w-4 animate-spin\" />\n                  ) : (\n                    <Send className=\"h-4 w-4\" />\n                  )}\n                </Button>\n              </div>\n              <p className=\"text-xs text-muted-foreground mt-2\">\n                Press Enter to send, Shift+Enter for new line\n              </p>\n            </div>\n          </>\n        ) : (\n          <div className=\"flex flex-1 flex-col items-center justify-center text-center p-8\">\n            <User className=\"h-16 w-16 text-muted-foreground/30 mb-4\" />\n            <h3 className=\"text-lg font-medium text-muted-foreground\">Select a conversation</h3>\n            <p className=\"text-sm text-muted-foreground mt-1\">\n              Choose a conversation from the list to view message history\n            </p>\n          </div>\n        )}\n      </Card>\n\n      <Dialog open={attachDialogOpen} onOpenChange={setAttachDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Attach Messages to Opportunity</DialogTitle>\n            <DialogDescription>\n              Select a lead or job to attach the selected {selectedMessages.size} message(s) to.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            {(leadsLoading || jobsLoading || createMessageRangeMutation.isPending) ? (\n              <div className=\"flex flex-col items-center justify-center py-8 gap-2\">\n                <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n                <p className=\"text-sm text-muted-foreground\">\n                  {createMessageRangeMutation.isPending ? \"Attaching messages...\" : \"Loading opportunities...\"}\n                </p>\n              </div>\n            ) : (\n              <>\n                {clientLeads.length > 0 && (\n                  <div>\n                    <h4 className=\"text-sm font-medium mb-2 flex items-center gap-2\">\n                      <FileText className=\"h-4 w-4\" />\n                      Leads\n                    </h4>\n                    <div className=\"space-y-2\">\n                      {clientLeads.map(lead => (\n                        <Button\n                          key={lead.id}\n                          variant=\"outline\"\n                          className=\"w-full justify-start\"\n                          onClick={() => handleAttachMessages('lead', lead.id)}\n                          disabled={createMessageRangeMutation.isPending}\n                          data-testid={`button-attach-lead-${lead.id}`}\n                        >\n                          <Badge variant=\"secondary\" className=\"mr-2\">{lead.stage}</Badge>\n                          {lead.description?.slice(0, 40) || \"Lead\"} - {lead.siteAddress?.slice(0, 30) || \"No address\"}\n                        </Button>\n                      ))}\n                    </div>\n                  </div>\n                )}\n                {clientJobs.length > 0 && (\n                  <div>\n                    <h4 className=\"text-sm font-medium mb-2 flex items-center gap-2\">\n                      <Briefcase className=\"h-4 w-4\" />\n                      Jobs\n                    </h4>\n                    <div className=\"space-y-2\">\n                      {clientJobs.map(job => (\n                        <Button\n                          key={job.id}\n                          variant=\"outline\"\n                          className=\"w-full justify-start\"\n                          onClick={() => handleAttachMessages('job', job.id)}\n                          disabled={createMessageRangeMutation.isPending}\n                          data-testid={`button-attach-job-${job.id}`}\n                        >\n                          <Badge variant=\"secondary\" className=\"mr-2\">{job.jobNumber}</Badge>\n                          {job.siteAddress?.slice(0, 40) || \"No address\"}\n                        </Button>\n                      ))}\n                    </div>\n                  </div>\n                )}\n                {clientLeads.length === 0 && clientJobs.length === 0 && (\n                  <div className=\"text-center text-muted-foreground py-4\">\n                    <p>No leads or jobs found for this client.</p>\n                    <p className=\"text-sm mt-1\">Link this conversation to a client first to see their opportunities.</p>\n                  </div>\n                )}\n              </>\n            )}\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setAttachDialogOpen(false)}>\n              Cancel\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":33822,"size_tokens":null},"server/twilio.ts":{"content":"import twilio from 'twilio';\nimport type { Twilio } from 'twilio';\n\nlet connectionSettings: any;\nlet twilioClientInstance: Twilio | null = null;\nlet twilioPhoneNumber: string | null = null;\n\n// Clear cached client to force re-initialization with new credentials\nexport function clearTwilioCache() {\n  twilioClientInstance = null;\n  twilioPhoneNumber = null;\n  connectionSettings = null;\n  console.log('Twilio cache cleared');\n}\n\nasync function getCredentials() {\n  // PRIORITY 1: Check for Auth Token in environment variables (works with global US1 endpoint for SMS)\n  // This is needed because AU regional API Keys don't support SMS\n  if (process.env.TWILIO_ACCOUNT_SID && process.env.TWILIO_AUTH_TOKEN) {\n    console.log('Twilio using env var Auth Token credentials (global endpoint for SMS)');\n    return {\n      accountSid: process.env.TWILIO_ACCOUNT_SID,\n      authToken: process.env.TWILIO_AUTH_TOKEN,\n      phoneNumber: process.env.TWILIO_PHONE_NUMBER || null,\n      useAuthToken: true\n    };\n  }\n\n  // PRIORITY 2: Try the Replit connector (may not work for SMS if regional)\n  const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME;\n  const xReplitToken = process.env.REPL_IDENTITY \n    ? 'repl ' + process.env.REPL_IDENTITY \n    : process.env.WEB_REPL_RENEWAL \n    ? 'depl ' + process.env.WEB_REPL_RENEWAL \n    : null;\n\n  console.log('Twilio getCredentials - hostname:', hostname ? 'present' : 'missing');\n  console.log('Twilio getCredentials - token type:', xReplitToken ? (process.env.REPL_IDENTITY ? 'repl' : 'depl') : 'none');\n\n  if (xReplitToken && hostname) {\n    try {\n      const response = await fetch(\n        'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=twilio',\n        {\n          headers: {\n            'Accept': 'application/json',\n            'X_REPLIT_TOKEN': xReplitToken\n          }\n        }\n      );\n      \n      const data = await response.json();\n      console.log('Twilio connector response status:', response.status);\n      console.log('Twilio connector data items:', data.items?.length || 0);\n      \n      connectionSettings = data.items?.[0];\n\n      const settings = connectionSettings?.settings;\n      console.log('Twilio connector all settings keys:', Object.keys(settings || {}));\n      \n      const accountSid = settings?.account_sid;\n      const authToken = settings?.auth_token;\n      const apiKey = settings?.api_key;\n      const apiKeySecret = settings?.api_key_secret;\n      const phoneNumber = settings?.phone_number || null;\n      \n      console.log('Twilio connector settings available:');\n      console.log('  - account_sid:', !!accountSid);\n      console.log('  - auth_token:', !!authToken);\n      console.log('  - api_key:', !!apiKey);\n      console.log('  - api_key_secret:', !!apiKeySecret);\n      console.log('  - phone_number:', phoneNumber);\n      \n      // Prefer Auth Token if available\n      if (accountSid && authToken) {\n        console.log('Using Auth Token authentication');\n        return {\n          accountSid,\n          authToken,\n          phoneNumber,\n          useAuthToken: true\n        };\n      }\n      \n      // Fall back to API Key authentication\n      if (accountSid && apiKey && apiKeySecret) {\n        console.log('Using API Key authentication');\n        return {\n          accountSid,\n          apiKey,\n          apiKeySecret,\n          phoneNumber,\n          useApiKey: true\n        };\n      }\n      \n      console.log('Twilio connector settings incomplete - for SMS, add TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN, and TWILIO_PHONE_NUMBER as secrets');\n    } catch (error) {\n      console.log('Twilio connector error:', error);\n    }\n  }\n\n  console.log('No Twilio credentials found - add TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN, and TWILIO_PHONE_NUMBER as secrets');\n  return null;\n}\n\nexport async function getTwilioClient(): Promise<Twilio | null> {\n  if (twilioClientInstance) {\n    return twilioClientInstance;\n  }\n\n  const credentials = await getCredentials();\n  if (!credentials) {\n    console.log('No Twilio credentials available');\n    return null;\n  }\n\n  if ('useAuthToken' in credentials && credentials.useAuthToken) {\n    // Use global endpoint (US1) for Auth Token - SMS only works on global endpoint\n    twilioClientInstance = twilio(credentials.accountSid, credentials.authToken);\n    console.log('Twilio client initialized with Auth Token (global endpoint for SMS)');\n  } else if ('useApiKey' in credentials && credentials.useApiKey) {\n    // Use API Key authentication - use global endpoint (AU region doesn't support SMS)\n    twilioClientInstance = twilio(credentials.apiKey, credentials.apiKeySecret, {\n      accountSid: credentials.accountSid\n    });\n    console.log('Twilio client initialized with API Key (global endpoint)');\n  }\n\n  twilioPhoneNumber = credentials.phoneNumber;\n  return twilioClientInstance;\n}\n\nexport async function getTwilioFromPhoneNumber(): Promise<string | null> {\n  if (twilioPhoneNumber) {\n    return twilioPhoneNumber;\n  }\n\n  const credentials = await getCredentials();\n  if (!credentials) {\n    return null;\n  }\n\n  twilioPhoneNumber = credentials.phoneNumber;\n  return twilioPhoneNumber;\n}\n\nexport async function sendSMS(\n  to: string, \n  message: string\n): Promise<{ sid: string } | null> {\n  const client = await getTwilioClient();\n  const fromNumber = await getTwilioFromPhoneNumber();\n\n  if (!client || !fromNumber) {\n    throw new Error('Twilio not configured');\n  }\n\n  const result = await client.messages.create({\n    body: message,\n    from: fromNumber,\n    to\n  });\n\n  return { sid: result.sid };\n}\n\n// ============================================\n// VOICE CALL FUNCTIONS\n// ============================================\n\n// Format phone number to E.164 format for Twilio\nfunction formatPhoneNumberE164(phoneNumber: string): string {\n  // Remove all non-digit characters except leading +\n  let cleaned = phoneNumber.replace(/[^\\d+]/g, '');\n  \n  // If it starts with +, assume it's already in E.164\n  if (cleaned.startsWith('+')) {\n    return cleaned;\n  }\n  \n  // Australian number handling (default)\n  if (cleaned.startsWith('0')) {\n    // Remove leading 0 and add +61 for Australia\n    cleaned = '+61' + cleaned.substring(1);\n  } else if (cleaned.startsWith('61')) {\n    // Already has country code, just add +\n    cleaned = '+' + cleaned;\n  } else if (cleaned.length === 9) {\n    // 9 digits - likely Australian mobile without leading 0\n    cleaned = '+61' + cleaned;\n  } else {\n    // Default to adding + if it looks international\n    cleaned = '+' + cleaned;\n  }\n  \n  return cleaned;\n}\n\nexport interface MakeCallOptions {\n  to: string;\n  webhookBaseUrl: string;\n  staffUserId?: string;\n  leadId?: string;\n  clientId?: string;\n}\n\nexport async function makeOutboundCall(options: MakeCallOptions): Promise<{ sid: string } | null> {\n  const client = await getTwilioClient();\n  const fromNumber = await getTwilioFromPhoneNumber();\n\n  if (!client || !fromNumber) {\n    throw new Error('Twilio not configured');\n  }\n\n  const formattedNumber = formatPhoneNumberE164(options.to);\n  console.log(`Making outbound call to ${options.to} -> formatted: ${formattedNumber}`);\n\n  const statusCallbackUrl = `${options.webhookBaseUrl}/api/twilio/voice/status`;\n  const voiceUrl = `${options.webhookBaseUrl}/api/twilio/voice/outbound`;\n\n  const callParams: any = {\n    to: formattedNumber,\n    from: fromNumber,\n    url: voiceUrl,\n    statusCallback: statusCallbackUrl,\n    statusCallbackEvent: ['initiated', 'ringing', 'answered', 'completed'],\n    statusCallbackMethod: 'POST',\n    record: true,\n    recordingStatusCallback: `${options.webhookBaseUrl}/api/twilio/voice/recording`,\n    recordingStatusCallbackMethod: 'POST',\n  };\n\n  const call = await client.calls.create(callParams);\n\n  return { sid: call.sid };\n}\n\nexport function generateTwimlForInbound(options: {\n  greeting?: string;\n  webhookBaseUrl: string;\n  callId?: string;\n  callSid?: string;\n}): string {\n  const { VoiceResponse } = twilio.twiml;\n  const response = new VoiceResponse();\n  \n  if (options.greeting) {\n    response.say({ voice: 'Polly.Matthew' }, options.greeting);\n  }\n\n  // Add Media Stream for real-time transcription if we have call info\n  if (options.callId && options.callSid) {\n    const wsUrl = options.webhookBaseUrl.replace('https://', 'wss://').replace('http://', 'ws://');\n    const start = response.start() as any;\n    start.stream({\n      url: `${wsUrl}/api/twilio/media-stream?callSid=${options.callSid}&callId=${options.callId}`,\n      track: 'both_tracks'\n    });\n  }\n  \n  response.dial({\n    record: 'record-from-answer-dual',\n    recordingStatusCallback: `${options.webhookBaseUrl}/api/twilio/voice/recording`,\n    recordingStatusCallbackMethod: 'POST'\n  });\n\n  return response.toString();\n}\n\nexport function generateTwimlForOutbound(options: {\n  greeting?: string;\n  webhookBaseUrl?: string;\n  callId?: string;\n  callSid?: string;\n}): string {\n  const { VoiceResponse } = twilio.twiml;\n  const response = new VoiceResponse();\n  \n  if (options.greeting) {\n    response.say({ voice: 'Polly.Matthew' }, options.greeting);\n  }\n\n  // Add Media Stream for real-time transcription if we have call info\n  if (options.callId && options.callSid && options.webhookBaseUrl) {\n    const wsUrl = options.webhookBaseUrl.replace('https://', 'wss://').replace('http://', 'ws://');\n    const start = response.start() as any;\n    start.stream({\n      url: `${wsUrl}/api/twilio/media-stream?callSid=${options.callSid}&callId=${options.callId}`,\n      track: 'both_tracks'\n    });\n  }\n\n  return response.toString();\n}\n\nexport async function getCallRecording(callSid: string): Promise<{\n  recordingUrl: string;\n  recordingSid: string;\n  duration: number;\n} | null> {\n  const client = await getTwilioClient();\n  if (!client) {\n    return null;\n  }\n\n  try {\n    const recordings = await client.recordings.list({ callSid, limit: 1 });\n    if (recordings.length === 0) {\n      return null;\n    }\n\n    const recording = recordings[0];\n    return {\n      recordingUrl: `https://api.twilio.com${recording.uri.replace('.json', '.mp3')}`,\n      recordingSid: recording.sid,\n      duration: recording.duration ? parseInt(recording.duration) : 0,\n    };\n  } catch (error) {\n    console.error('Failed to get call recording:', error);\n    return null;\n  }\n}\n\n// ============================================\n// VOICE SDK TOKEN GENERATION\n// ============================================\n\nexport async function generateVoiceToken(identity: string): Promise<string | null> {\n  const credentials = await getCredentials();\n  \n  if (!credentials) {\n    console.error('No Twilio credentials available for token generation');\n    return null;\n  }\n  \n  const { accountSid } = credentials;\n  \n  // For Voice SDK, we need API Key credentials\n  // Check environment variables for API Key and TwiML App SID\n  const apiKey = process.env.TWILIO_API_KEY;\n  const apiSecret = process.env.TWILIO_API_SECRET;\n  const twimlAppSid = process.env.TWILIO_TWIML_APP_SID;\n  \n  if (!apiKey || !apiSecret) {\n    console.error('TWILIO_API_KEY and TWILIO_API_SECRET required for Voice SDK');\n    return null;\n  }\n  \n  if (!twimlAppSid) {\n    console.error('TWILIO_TWIML_APP_SID required for Voice SDK');\n    return null;\n  }\n  \n  try {\n    const AccessToken = twilio.jwt.AccessToken;\n    const VoiceGrant = AccessToken.VoiceGrant;\n    \n    const voiceGrant = new VoiceGrant({\n      outgoingApplicationSid: twimlAppSid,\n      incomingAllow: true,\n    });\n    \n    const token = new AccessToken(\n      accountSid,\n      apiKey,\n      apiSecret,\n      { identity }\n    );\n    \n    token.addGrant(voiceGrant);\n    \n    return token.toJwt();\n  } catch (error) {\n    console.error('Failed to generate voice token:', error);\n    return null;\n  }\n}\n\n// Check if Voice SDK is configured\nexport async function isVoiceSdkConfigured(): Promise<boolean> {\n  const apiKey = process.env.TWILIO_API_KEY;\n  const apiSecret = process.env.TWILIO_API_SECRET;\n  const twimlAppSid = process.env.TWILIO_TWIML_APP_SID;\n  \n  return !!(apiKey && apiSecret && twimlAppSid);\n}\n","path":null,"size_bytes":12027,"size_tokens":null},"client/src/pages/organisation/Policies.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Shield, Plus, Pencil, Trash2, Search, Filter, Eye, Clock, CheckCircle2, AlertCircle } from \"lucide-react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { Policy, Department, PolicyVersion, PolicyAcknowledgement } from \"@shared/schema\";\nimport { format } from \"date-fns\";\n\nconst policyFormSchema = z.object({\n  title: z.string().min(1, \"Title is required\"),\n  category: z.enum([\"safety\", \"hr\", \"warehouse\", \"vehicles\", \"equipment\", \"operations\", \"other\"]),\n  status: z.enum([\"active\", \"draft\", \"archived\"]).default(\"draft\"),\n  departmentId: z.string().optional(),\n});\n\ntype PolicyFormValues = z.infer<typeof policyFormSchema>;\n\nconst categoryLabels: Record<string, string> = {\n  safety: \"Safety\",\n  hr: \"HR\",\n  warehouse: \"Warehouse\",\n  vehicles: \"Vehicles\",\n  equipment: \"Equipment\",\n  operations: \"Operations\",\n  other: \"Other\",\n};\n\nconst statusColors: Record<string, string> = {\n  active: \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\",\n  draft: \"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200\",\n  archived: \"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300\",\n};\n\nexport default function Policies() {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [categoryFilter, setCategoryFilter] = useState<string>(\"\");\n  const [statusFilter, setStatusFilter] = useState<string>(\"\");\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [editingPolicy, setEditingPolicy] = useState<Policy | null>(null);\n  const [viewingPolicy, setViewingPolicy] = useState<Policy | null>(null);\n  const [deletingPolicy, setDeletingPolicy] = useState<Policy | null>(null);\n\n  const { data: policies = [], isLoading } = useQuery<Policy[]>({\n    queryKey: ['/api/organisation/policies'],\n  });\n\n  const { data: departments = [] } = useQuery<Department[]>({\n    queryKey: ['/api/organisation/departments'],\n  });\n\n  const { data: policyVersions = [] } = useQuery<PolicyVersion[]>({\n    queryKey: ['/api/organisation/policies', viewingPolicy?.id, 'versions'],\n    enabled: !!viewingPolicy,\n  });\n\n  const { data: acknowledgements = [] } = useQuery<PolicyAcknowledgement[]>({\n    queryKey: ['/api/organisation/policies', viewingPolicy?.id, 'acknowledgements'],\n    enabled: !!viewingPolicy,\n  });\n\n  const form = useForm<PolicyFormValues>({\n    resolver: zodResolver(policyFormSchema),\n    defaultValues: {\n      title: \"\",\n      category: \"other\",\n      status: \"draft\",\n      departmentId: \"\",\n    },\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: PolicyFormValues) => {\n      return apiRequest('POST', '/api/organisation/policies', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/organisation/policies'] });\n      setIsCreateDialogOpen(false);\n      form.reset();\n      toast({ title: \"Policy created successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to create policy\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: PolicyFormValues }) => {\n      return apiRequest('PATCH', `/api/organisation/policies/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/organisation/policies'] });\n      setEditingPolicy(null);\n      form.reset();\n      toast({ title: \"Policy updated successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to update policy\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest('DELETE', `/api/organisation/policies/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/organisation/policies'] });\n      setDeletingPolicy(null);\n      toast({ title: \"Policy deleted successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to delete policy\", variant: \"destructive\" });\n    },\n  });\n\n  const handleCreateSubmit = (data: PolicyFormValues) => {\n    createMutation.mutate(data);\n  };\n\n  const handleEditSubmit = (data: PolicyFormValues) => {\n    if (editingPolicy) {\n      updateMutation.mutate({ id: editingPolicy.id, data });\n    }\n  };\n\n  const openEditDialog = (policy: Policy) => {\n    setEditingPolicy(policy);\n    form.reset({\n      title: policy.title,\n      category: policy.category as any,\n      status: policy.status as any,\n      departmentId: policy.departmentId || \"\",\n    });\n  };\n\n  const filteredPolicies = policies.filter(policy => {\n    const matchesSearch = policy.title.toLowerCase().includes(searchQuery.toLowerCase());\n    const matchesCategory = !categoryFilter || policy.category === categoryFilter;\n    const matchesStatus = !statusFilter || policy.status === statusFilter;\n    return matchesSearch && matchesCategory && matchesStatus;\n  });\n\n  const getDepartmentName = (departmentId: string | null) => {\n    if (!departmentId) return null;\n    const department = departments.find(d => d.id === departmentId);\n    return department?.name;\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-semibold text-foreground\" data-testid=\"text-page-title\">Policies & Procedures</h1>\n          <p className=\"text-muted-foreground\">Company policies with acknowledgement tracking</p>\n        </div>\n        <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-policy\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              New Policy\n            </Button>\n          </DialogTrigger>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Create Policy</DialogTitle>\n              <DialogDescription>Add a new policy to your organisation.</DialogDescription>\n            </DialogHeader>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(handleCreateSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"title\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Title</FormLabel>\n                      <FormControl>\n                        <Input {...field} placeholder=\"e.g. Safety Guidelines\" data-testid=\"input-policy-title\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"category\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Category</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-policy-category\">\n                              <SelectValue placeholder=\"Select category\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            {Object.entries(categoryLabels).map(([value, label]) => (\n                              <SelectItem key={value} value={value}>{label}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"status\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Status</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-policy-status\">\n                              <SelectValue placeholder=\"Select status\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            <SelectItem value=\"draft\">Draft</SelectItem>\n                            <SelectItem value=\"active\">Active</SelectItem>\n                            <SelectItem value=\"archived\">Archived</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n                <FormField\n                  control={form.control}\n                  name=\"departmentId\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Department (optional)</FormLabel>\n                      <Select onValueChange={(val) => field.onChange(val === \"_none\" ? \"\" : val)} defaultValue={field.value || \"_none\"}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-policy-department\">\n                            <SelectValue placeholder=\"All departments\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"_none\">All departments</SelectItem>\n                          {departments.map((dept) => (\n                            <SelectItem key={dept.id} value={dept.id}>{dept.name}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <DialogFooter>\n                  <Button type=\"submit\" disabled={createMutation.isPending} data-testid=\"button-submit-policy\">\n                    {createMutation.isPending ? \"Creating...\" : \"Create Policy\"}\n                  </Button>\n                </DialogFooter>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <div className=\"flex flex-wrap gap-4\">\n        <div className=\"relative flex-1 min-w-[200px] max-w-md\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search policies...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-9\"\n            data-testid=\"input-search-policies\"\n          />\n        </div>\n        <Select value={categoryFilter || \"all\"} onValueChange={(val) => setCategoryFilter(val === \"all\" ? \"\" : val)}>\n          <SelectTrigger className=\"w-40\" data-testid=\"filter-category\">\n            <Filter className=\"h-4 w-4 mr-2\" />\n            <SelectValue placeholder=\"Category\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Categories</SelectItem>\n            {Object.entries(categoryLabels).map(([value, label]) => (\n              <SelectItem key={value} value={value}>{label}</SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n        <Select value={statusFilter || \"all\"} onValueChange={(val) => setStatusFilter(val === \"all\" ? \"\" : val)}>\n          <SelectTrigger className=\"w-32\" data-testid=\"filter-status\">\n            <SelectValue placeholder=\"Status\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Status</SelectItem>\n            <SelectItem value=\"active\">Active</SelectItem>\n            <SelectItem value=\"draft\">Draft</SelectItem>\n            <SelectItem value=\"archived\">Archived</SelectItem>\n          </SelectContent>\n        </Select>\n      </div>\n\n      {isLoading ? (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {[1, 2, 3].map((i) => (\n            <Card key={i} className=\"animate-pulse\">\n              <CardHeader className=\"space-y-2\">\n                <div className=\"h-5 w-32 bg-muted rounded\"></div>\n                <div className=\"h-4 w-48 bg-muted rounded\"></div>\n              </CardHeader>\n            </Card>\n          ))}\n        </div>\n      ) : filteredPolicies.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-12\">\n            <Shield className=\"h-12 w-12 text-muted-foreground mb-4\" />\n            <h3 className=\"text-lg font-medium\">No policies found</h3>\n            <p className=\"text-muted-foreground text-sm\">\n              {searchQuery || categoryFilter || statusFilter ? \"Try adjusting your filters\" : \"Create your first policy to get started\"}\n            </p>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {filteredPolicies.map((policy) => (\n            <Card key={policy.id} data-testid={`card-policy-${policy.id}`}>\n              <CardHeader>\n                <div className=\"flex items-start justify-between gap-2\">\n                  <div className=\"flex items-start gap-3 min-w-0\">\n                    <div className=\"flex h-10 w-10 shrink-0 items-center justify-center rounded-md bg-primary/10 text-primary\">\n                      <Shield className=\"h-5 w-5\" />\n                    </div>\n                    <div className=\"min-w-0\">\n                      <CardTitle className=\"text-base truncate\">{policy.title}</CardTitle>\n                      <CardDescription className=\"text-sm\">\n                        {categoryLabels[policy.category] || policy.category}\n                      </CardDescription>\n                    </div>\n                  </div>\n                  <div className=\"flex gap-1 shrink-0\">\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\" \n                      className=\"h-8 w-8\"\n                      onClick={() => setViewingPolicy(policy)}\n                      data-testid={`button-view-policy-${policy.id}`}\n                    >\n                      <Eye className=\"h-4 w-4\" />\n                    </Button>\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\" \n                      className=\"h-8 w-8\"\n                      onClick={() => openEditDialog(policy)}\n                      data-testid={`button-edit-policy-${policy.id}`}\n                    >\n                      <Pencil className=\"h-4 w-4\" />\n                    </Button>\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\" \n                      className=\"h-8 w-8 text-destructive\"\n                      onClick={() => setDeletingPolicy(policy)}\n                      data-testid={`button-delete-policy-${policy.id}`}\n                    >\n                      <Trash2 className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"flex flex-wrap items-center gap-2\">\n                  <Badge className={statusColors[policy.status]}>\n                    {policy.status.charAt(0).toUpperCase() + policy.status.slice(1)}\n                  </Badge>\n                  {policy.departmentId ? (\n                    <Badge variant=\"secondary\">{getDepartmentName(policy.departmentId)}</Badge>\n                  ) : (\n                    <Badge variant=\"outline\">All Departments</Badge>\n                  )}\n                </div>\n                <div className=\"mt-3 flex items-center gap-2 text-xs text-muted-foreground\">\n                  <Clock className=\"h-3 w-3\" />\n                  <span>Updated {format(new Date(policy.updatedAt), 'dd MMM yyyy')}</span>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n\n      <Dialog open={!!editingPolicy} onOpenChange={(open) => !open && setEditingPolicy(null)}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Edit Policy</DialogTitle>\n            <DialogDescription>Update policy details.</DialogDescription>\n          </DialogHeader>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(handleEditSubmit)} className=\"space-y-4\">\n              <FormField\n                control={form.control}\n                name=\"title\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Title</FormLabel>\n                    <FormControl>\n                      <Input {...field} data-testid=\"input-edit-policy-title\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"category\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Category</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-edit-policy-category\">\n                            <SelectValue />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {Object.entries(categoryLabels).map(([value, label]) => (\n                            <SelectItem key={value} value={value}>{label}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"status\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Status</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-edit-policy-status\">\n                            <SelectValue />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"draft\">Draft</SelectItem>\n                          <SelectItem value=\"active\">Active</SelectItem>\n                          <SelectItem value=\"archived\">Archived</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n              <FormField\n                control={form.control}\n                name=\"departmentId\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Department (optional)</FormLabel>\n                    <Select onValueChange={(val) => field.onChange(val === \"_none\" ? \"\" : val)} value={field.value || \"_none\"}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-edit-policy-department\">\n                          <SelectValue placeholder=\"All departments\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"_none\">All departments</SelectItem>\n                        {departments.map((dept) => (\n                          <SelectItem key={dept.id} value={dept.id}>{dept.name}</SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <DialogFooter>\n                <Button type=\"submit\" disabled={updateMutation.isPending} data-testid=\"button-update-policy\">\n                  {updateMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={!!viewingPolicy} onOpenChange={(open) => !open && setViewingPolicy(null)}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle>{viewingPolicy?.title}</DialogTitle>\n            <DialogDescription>\n              {categoryLabels[viewingPolicy?.category || '']} policy\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"flex flex-wrap gap-2\">\n              {viewingPolicy && (\n                <>\n                  <Badge className={statusColors[viewingPolicy.status]}>\n                    {viewingPolicy.status.charAt(0).toUpperCase() + viewingPolicy.status.slice(1)}\n                  </Badge>\n                  {viewingPolicy.departmentId ? (\n                    <Badge variant=\"secondary\">{getDepartmentName(viewingPolicy.departmentId)}</Badge>\n                  ) : (\n                    <Badge variant=\"outline\">All Departments</Badge>\n                  )}\n                </>\n              )}\n            </div>\n\n            <div className=\"border-t pt-4\">\n              <h4 className=\"font-medium mb-2\">Version History</h4>\n              {policyVersions.length === 0 ? (\n                <p className=\"text-sm text-muted-foreground\">No versions created yet.</p>\n              ) : (\n                <div className=\"space-y-2\">\n                  {policyVersions.map((version) => (\n                    <div key={version.id} className=\"flex items-center justify-between p-2 rounded bg-muted/50\">\n                      <div>\n                        <span className=\"font-medium\">v{version.versionNumber}</span>\n                        {version.changeSummary && (\n                          <span className=\"ml-2 text-sm text-muted-foreground\">{version.changeSummary}</span>\n                        )}\n                      </div>\n                      <span className=\"text-xs text-muted-foreground\">\n                        {format(new Date(version.createdAt), 'dd MMM yyyy')}\n                      </span>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n\n            <div className=\"border-t pt-4\">\n              <h4 className=\"font-medium mb-2 flex items-center gap-2\">\n                <CheckCircle2 className=\"h-4 w-4 text-green-600\" />\n                Acknowledgements ({acknowledgements.length})\n              </h4>\n              {acknowledgements.length === 0 ? (\n                <p className=\"text-sm text-muted-foreground\">No acknowledgements yet.</p>\n              ) : (\n                <div className=\"space-y-2 max-h-40 overflow-y-auto\">\n                  {acknowledgements.map((ack) => (\n                    <div key={ack.id} className=\"flex items-center justify-between p-2 rounded bg-green-50 dark:bg-green-900/20\">\n                      <span className=\"text-sm\">{ack.userId}</span>\n                      <span className=\"text-xs text-muted-foreground\">\n                        {format(new Date(ack.acknowledgedAt), 'dd MMM yyyy HH:mm')}\n                      </span>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={!!deletingPolicy} onOpenChange={(open) => !open && setDeletingPolicy(null)}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Delete Policy</DialogTitle>\n            <DialogDescription>\n              Are you sure you want to delete \"{deletingPolicy?.title}\"? This action cannot be undone.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setDeletingPolicy(null)} data-testid=\"button-cancel-delete\">\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={() => deletingPolicy && deleteMutation.mutate(deletingPolicy.id)}\n              disabled={deleteMutation.isPending}\n              data-testid=\"button-confirm-delete\"\n            >\n              {deleteMutation.isPending ? \"Deleting...\" : \"Delete\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":25762,"size_tokens":null},"client/src/pages/organisation/Resources.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { FolderOpen, Plus, Pencil, Trash2, Search, ExternalLink, FileText, Link2 } from \"lucide-react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { Resource, Department } from \"@shared/schema\";\nimport { format } from \"date-fns\";\n\nconst resourceFormSchema = z.object({\n  title: z.string().min(1, \"Title is required\"),\n  description: z.string().optional(),\n  resourceType: z.enum([\"file\", \"link\"]),\n  fileUrl: z.string().optional(),\n  externalUrl: z.string().url().optional().or(z.literal(\"\")),\n  departmentId: z.string().optional(),\n});\n\ntype ResourceFormValues = z.infer<typeof resourceFormSchema>;\n\nexport default function Resources() {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [typeFilter, setTypeFilter] = useState<string>(\"\");\n  const [departmentFilter, setDepartmentFilter] = useState<string>(\"\");\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [editingResource, setEditingResource] = useState<Resource | null>(null);\n  const [deletingResource, setDeletingResource] = useState<Resource | null>(null);\n\n  const { data: resources = [], isLoading } = useQuery<Resource[]>({\n    queryKey: ['/api/organisation/resources'],\n  });\n\n  const { data: departments = [] } = useQuery<Department[]>({\n    queryKey: ['/api/organisation/departments'],\n  });\n\n  const form = useForm<ResourceFormValues>({\n    resolver: zodResolver(resourceFormSchema),\n    defaultValues: {\n      title: \"\",\n      description: \"\",\n      resourceType: \"link\",\n      fileUrl: \"\",\n      externalUrl: \"\",\n      departmentId: \"\",\n    },\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: ResourceFormValues) => {\n      return apiRequest('POST', '/api/organisation/resources', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/organisation/resources'] });\n      setIsCreateDialogOpen(false);\n      form.reset();\n      toast({ title: \"Resource created successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to create resource\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: ResourceFormValues }) => {\n      return apiRequest('PATCH', `/api/organisation/resources/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/organisation/resources'] });\n      setEditingResource(null);\n      form.reset();\n      toast({ title: \"Resource updated successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to update resource\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest('DELETE', `/api/organisation/resources/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/organisation/resources'] });\n      setDeletingResource(null);\n      toast({ title: \"Resource deleted successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to delete resource\", variant: \"destructive\" });\n    },\n  });\n\n  const handleCreateSubmit = (data: ResourceFormValues) => {\n    createMutation.mutate(data);\n  };\n\n  const handleEditSubmit = (data: ResourceFormValues) => {\n    if (editingResource) {\n      updateMutation.mutate({ id: editingResource.id, data });\n    }\n  };\n\n  const openEditDialog = (resource: Resource) => {\n    setEditingResource(resource);\n    form.reset({\n      title: resource.title,\n      description: resource.description || \"\",\n      resourceType: resource.resourceType as any,\n      fileUrl: resource.fileUrl || \"\",\n      externalUrl: resource.externalUrl || \"\",\n      departmentId: resource.departmentId || \"\",\n    });\n  };\n\n  const filteredResources = resources.filter(resource => {\n    const matchesSearch = \n      resource.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      resource.description?.toLowerCase().includes(searchQuery.toLowerCase());\n    const matchesType = !typeFilter || resource.resourceType === typeFilter;\n    const matchesDepartment = !departmentFilter || resource.departmentId === departmentFilter;\n    return matchesSearch && matchesType && matchesDepartment;\n  });\n\n  const getDepartmentName = (departmentId: string | null) => {\n    if (!departmentId) return null;\n    const department = departments.find(d => d.id === departmentId);\n    return department?.name;\n  };\n\n  const resourceType = form.watch(\"resourceType\");\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-semibold text-foreground\" data-testid=\"text-page-title\">Resource Library</h1>\n          <p className=\"text-muted-foreground\">Centralised files and links for the team</p>\n        </div>\n        <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-resource\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Add Resource\n            </Button>\n          </DialogTrigger>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Add Resource</DialogTitle>\n              <DialogDescription>Add a new file or link to the resource library.</DialogDescription>\n            </DialogHeader>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(handleCreateSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"title\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Title</FormLabel>\n                      <FormControl>\n                        <Input {...field} placeholder=\"e.g. Installation Guide\" data-testid=\"input-resource-title\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"description\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Description</FormLabel>\n                      <FormControl>\n                        <Textarea {...field} placeholder=\"Brief description...\" data-testid=\"input-resource-description\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"resourceType\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Type</FormLabel>\n                      <Select onValueChange={field.onChange} defaultValue={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-resource-type\">\n                            <SelectValue placeholder=\"Select type\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"link\">External Link</SelectItem>\n                          <SelectItem value=\"file\">File</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                {resourceType === \"link\" && (\n                  <FormField\n                    control={form.control}\n                    name=\"externalUrl\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>URL</FormLabel>\n                        <FormControl>\n                          <Input {...field} type=\"url\" placeholder=\"https://...\" data-testid=\"input-resource-url\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                )}\n                {resourceType === \"file\" && (\n                  <FormField\n                    control={form.control}\n                    name=\"fileUrl\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>File URL</FormLabel>\n                        <FormControl>\n                          <Input {...field} placeholder=\"File path or URL\" data-testid=\"input-resource-file\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                )}\n                <FormField\n                  control={form.control}\n                  name=\"departmentId\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Department (optional)</FormLabel>\n                      <Select onValueChange={(val) => field.onChange(val === \"_none\" ? \"\" : val)} defaultValue={field.value || \"_none\"}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-resource-department\">\n                            <SelectValue placeholder=\"All departments\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"_none\">All departments</SelectItem>\n                          {departments.map((dept) => (\n                            <SelectItem key={dept.id} value={dept.id}>{dept.name}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <DialogFooter>\n                  <Button type=\"submit\" disabled={createMutation.isPending} data-testid=\"button-submit-resource\">\n                    {createMutation.isPending ? \"Adding...\" : \"Add Resource\"}\n                  </Button>\n                </DialogFooter>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <div className=\"flex flex-wrap gap-4\">\n        <div className=\"relative flex-1 min-w-[200px] max-w-md\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search resources...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-9\"\n            data-testid=\"input-search-resources\"\n          />\n        </div>\n        <Select value={typeFilter || \"all\"} onValueChange={(val) => setTypeFilter(val === \"all\" ? \"\" : val)}>\n          <SelectTrigger className=\"w-32\" data-testid=\"filter-type\">\n            <SelectValue placeholder=\"Type\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Types</SelectItem>\n            <SelectItem value=\"file\">Files</SelectItem>\n            <SelectItem value=\"link\">Links</SelectItem>\n          </SelectContent>\n        </Select>\n        <Select value={departmentFilter || \"all\"} onValueChange={(val) => setDepartmentFilter(val === \"all\" ? \"\" : val)}>\n          <SelectTrigger className=\"w-40\" data-testid=\"filter-department\">\n            <SelectValue placeholder=\"Department\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Departments</SelectItem>\n            {departments.map((dept) => (\n              <SelectItem key={dept.id} value={dept.id}>{dept.name}</SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      {isLoading ? (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {[1, 2, 3].map((i) => (\n            <Card key={i} className=\"animate-pulse\">\n              <CardHeader className=\"space-y-2\">\n                <div className=\"h-5 w-32 bg-muted rounded\"></div>\n                <div className=\"h-4 w-48 bg-muted rounded\"></div>\n              </CardHeader>\n            </Card>\n          ))}\n        </div>\n      ) : filteredResources.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-12\">\n            <FolderOpen className=\"h-12 w-12 text-muted-foreground mb-4\" />\n            <h3 className=\"text-lg font-medium\">No resources found</h3>\n            <p className=\"text-muted-foreground text-sm\">\n              {searchQuery || typeFilter || departmentFilter ? \"Try adjusting your filters\" : \"Add your first resource to get started\"}\n            </p>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {filteredResources.map((resource) => (\n            <Card key={resource.id} data-testid={`card-resource-${resource.id}`}>\n              <CardHeader>\n                <div className=\"flex items-start justify-between gap-2\">\n                  <div className=\"flex items-start gap-3 min-w-0\">\n                    <div className=\"flex h-10 w-10 shrink-0 items-center justify-center rounded-md bg-primary/10 text-primary\">\n                      {resource.resourceType === \"link\" ? (\n                        <Link2 className=\"h-5 w-5\" />\n                      ) : (\n                        <FileText className=\"h-5 w-5\" />\n                      )}\n                    </div>\n                    <div className=\"min-w-0\">\n                      <CardTitle className=\"text-base truncate\">{resource.title}</CardTitle>\n                      {resource.description && (\n                        <CardDescription className=\"line-clamp-2\">{resource.description}</CardDescription>\n                      )}\n                    </div>\n                  </div>\n                  <div className=\"flex gap-1 shrink-0\">\n                    {resource.externalUrl && (\n                      <Button \n                        variant=\"ghost\" \n                        size=\"icon\" \n                        className=\"h-8 w-8\"\n                        asChild\n                      >\n                        <a href={resource.externalUrl} target=\"_blank\" rel=\"noopener noreferrer\" data-testid={`link-resource-${resource.id}`}>\n                          <ExternalLink className=\"h-4 w-4\" />\n                        </a>\n                      </Button>\n                    )}\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\" \n                      className=\"h-8 w-8\"\n                      onClick={() => openEditDialog(resource)}\n                      data-testid={`button-edit-resource-${resource.id}`}\n                    >\n                      <Pencil className=\"h-4 w-4\" />\n                    </Button>\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\" \n                      className=\"h-8 w-8 text-destructive\"\n                      onClick={() => setDeletingResource(resource)}\n                      data-testid={`button-delete-resource-${resource.id}`}\n                    >\n                      <Trash2 className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"flex flex-wrap items-center gap-2\">\n                  <Badge variant=\"outline\">\n                    {resource.resourceType === \"link\" ? \"Link\" : \"File\"}\n                  </Badge>\n                  {resource.departmentId && (\n                    <Badge variant=\"secondary\">{getDepartmentName(resource.departmentId)}</Badge>\n                  )}\n                </div>\n                <div className=\"mt-3 text-xs text-muted-foreground\">\n                  Added {format(new Date(resource.uploadedAt), 'dd MMM yyyy')}\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n\n      <Dialog open={!!editingResource} onOpenChange={(open) => !open && setEditingResource(null)}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Edit Resource</DialogTitle>\n            <DialogDescription>Update resource details.</DialogDescription>\n          </DialogHeader>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(handleEditSubmit)} className=\"space-y-4\">\n              <FormField\n                control={form.control}\n                name=\"title\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Title</FormLabel>\n                    <FormControl>\n                      <Input {...field} data-testid=\"input-edit-resource-title\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={form.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Description</FormLabel>\n                    <FormControl>\n                      <Textarea {...field} data-testid=\"input-edit-resource-description\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={form.control}\n                name=\"resourceType\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Type</FormLabel>\n                    <Select onValueChange={field.onChange} value={field.value}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-edit-resource-type\">\n                          <SelectValue />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"link\">External Link</SelectItem>\n                        <SelectItem value=\"file\">File</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              {resourceType === \"link\" && (\n                <FormField\n                  control={form.control}\n                  name=\"externalUrl\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>URL</FormLabel>\n                      <FormControl>\n                        <Input {...field} type=\"url\" data-testid=\"input-edit-resource-url\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              )}\n              {resourceType === \"file\" && (\n                <FormField\n                  control={form.control}\n                  name=\"fileUrl\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>File URL</FormLabel>\n                      <FormControl>\n                        <Input {...field} data-testid=\"input-edit-resource-file\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              )}\n              <FormField\n                control={form.control}\n                name=\"departmentId\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Department (optional)</FormLabel>\n                    <Select onValueChange={(val) => field.onChange(val === \"_none\" ? \"\" : val)} value={field.value || \"_none\"}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-edit-resource-department\">\n                          <SelectValue placeholder=\"All departments\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"_none\">All departments</SelectItem>\n                        {departments.map((dept) => (\n                          <SelectItem key={dept.id} value={dept.id}>{dept.name}</SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <DialogFooter>\n                <Button type=\"submit\" disabled={updateMutation.isPending} data-testid=\"button-update-resource\">\n                  {updateMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={!!deletingResource} onOpenChange={(open) => !open && setDeletingResource(null)}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Delete Resource</DialogTitle>\n            <DialogDescription>\n              Are you sure you want to delete \"{deletingResource?.title}\"? This action cannot be undone.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setDeletingResource(null)} data-testid=\"button-cancel-delete\">\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={() => deletingResource && deleteMutation.mutate(deletingResource.id)}\n              disabled={deleteMutation.isPending}\n              data-testid=\"button-confirm-delete\"\n            >\n              {deleteMutation.isPending ? \"Deleting...\" : \"Delete\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":22928,"size_tokens":null},"client/src/pages/organisation/Departments.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Building, Plus, Pencil, Trash2, Users, Search } from \"lucide-react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { Department, User } from \"@shared/schema\";\n\nconst departmentFormSchema = z.object({\n  name: z.string().min(1, \"Department name is required\"),\n  description: z.string().optional(),\n  managerUserId: z.string().optional(),\n});\n\ntype DepartmentFormValues = z.infer<typeof departmentFormSchema>;\n\nexport default function Departments() {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [editingDepartment, setEditingDepartment] = useState<Department | null>(null);\n  const [deletingDepartment, setDeletingDepartment] = useState<Department | null>(null);\n\n  const { data: departments = [], isLoading } = useQuery<Department[]>({\n    queryKey: ['/api/organisation/departments'],\n  });\n\n  const { data: users = [] } = useQuery<User[]>({\n    queryKey: ['/api/users'],\n  });\n\n  const form = useForm<DepartmentFormValues>({\n    resolver: zodResolver(departmentFormSchema),\n    defaultValues: {\n      name: \"\",\n      description: \"\",\n      managerUserId: \"\",\n    },\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: DepartmentFormValues) => {\n      return apiRequest('POST', '/api/organisation/departments', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/organisation/departments'] });\n      setIsCreateDialogOpen(false);\n      form.reset();\n      toast({ title: \"Department created successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to create department\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: DepartmentFormValues }) => {\n      return apiRequest('PATCH', `/api/organisation/departments/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/organisation/departments'] });\n      setEditingDepartment(null);\n      form.reset();\n      toast({ title: \"Department updated successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to update department\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest('DELETE', `/api/organisation/departments/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/organisation/departments'] });\n      setDeletingDepartment(null);\n      toast({ title: \"Department deleted successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to delete department\", variant: \"destructive\" });\n    },\n  });\n\n  const handleCreateSubmit = (data: DepartmentFormValues) => {\n    createMutation.mutate(data);\n  };\n\n  const handleEditSubmit = (data: DepartmentFormValues) => {\n    if (editingDepartment) {\n      updateMutation.mutate({ id: editingDepartment.id, data });\n    }\n  };\n\n  const openEditDialog = (department: Department) => {\n    setEditingDepartment(department);\n    form.reset({\n      name: department.name,\n      description: department.description || \"\",\n      managerUserId: department.managerUserId || \"\",\n    });\n  };\n\n  const filteredDepartments = departments.filter(dept =>\n    dept.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    dept.description?.toLowerCase().includes(searchQuery.toLowerCase())\n  );\n\n  const getManagerName = (userId: string | null) => {\n    if (!userId) return null;\n    const user = users.find(u => u.id === userId);\n    return user ? `${user.firstName} ${user.lastName}` : null;\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-semibold text-foreground\" data-testid=\"text-page-title\">Departments</h1>\n          <p className=\"text-muted-foreground\">Manage your organisation's department structure</p>\n        </div>\n        <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-department\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              New Department\n            </Button>\n          </DialogTrigger>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Create Department</DialogTitle>\n              <DialogDescription>Add a new department to your organisation.</DialogDescription>\n            </DialogHeader>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(handleCreateSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"name\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Name</FormLabel>\n                      <FormControl>\n                        <Input {...field} placeholder=\"e.g. Production\" data-testid=\"input-department-name\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"description\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Description</FormLabel>\n                      <FormControl>\n                        <Textarea {...field} placeholder=\"Department description...\" data-testid=\"input-department-description\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"managerUserId\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Manager</FormLabel>\n                      <Select onValueChange={field.onChange} defaultValue={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-department-manager\">\n                            <SelectValue placeholder=\"Select manager\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {users.map((user) => (\n                            <SelectItem key={user.id} value={user.id}>\n                              {user.firstName} {user.lastName}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <DialogFooter>\n                  <Button type=\"submit\" disabled={createMutation.isPending} data-testid=\"button-submit-department\">\n                    {createMutation.isPending ? \"Creating...\" : \"Create Department\"}\n                  </Button>\n                </DialogFooter>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <div className=\"relative max-w-md\">\n        <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n        <Input\n          placeholder=\"Search departments...\"\n          value={searchQuery}\n          onChange={(e) => setSearchQuery(e.target.value)}\n          className=\"pl-9\"\n          data-testid=\"input-search-departments\"\n        />\n      </div>\n\n      {isLoading ? (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {[1, 2, 3].map((i) => (\n            <Card key={i} className=\"animate-pulse\">\n              <CardHeader className=\"space-y-2\">\n                <div className=\"h-5 w-32 bg-muted rounded\"></div>\n                <div className=\"h-4 w-48 bg-muted rounded\"></div>\n              </CardHeader>\n            </Card>\n          ))}\n        </div>\n      ) : filteredDepartments.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-12\">\n            <Building className=\"h-12 w-12 text-muted-foreground mb-4\" />\n            <h3 className=\"text-lg font-medium\">No departments found</h3>\n            <p className=\"text-muted-foreground text-sm\">\n              {searchQuery ? \"Try a different search term\" : \"Create your first department to get started\"}\n            </p>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {filteredDepartments.map((department) => (\n            <Card key={department.id} data-testid={`card-department-${department.id}`}>\n              <CardHeader>\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-primary/10 text-primary\">\n                      <Building className=\"h-5 w-5\" />\n                    </div>\n                    <div>\n                      <CardTitle className=\"text-base\">{department.name}</CardTitle>\n                      {department.description && (\n                        <CardDescription className=\"line-clamp-2\">{department.description}</CardDescription>\n                      )}\n                    </div>\n                  </div>\n                  <div className=\"flex gap-1\">\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\" \n                      className=\"h-8 w-8\"\n                      onClick={() => openEditDialog(department)}\n                      data-testid={`button-edit-department-${department.id}`}\n                    >\n                      <Pencil className=\"h-4 w-4\" />\n                    </Button>\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\" \n                      className=\"h-8 w-8 text-destructive\"\n                      onClick={() => setDeletingDepartment(department)}\n                      data-testid={`button-delete-department-${department.id}`}\n                    >\n                      <Trash2 className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                  <Users className=\"h-4 w-4\" />\n                  <span>\n                    {department.managerUserId \n                      ? `Manager: ${getManagerName(department.managerUserId) || 'Unknown'}`\n                      : 'No manager assigned'}\n                  </span>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n\n      <Dialog open={!!editingDepartment} onOpenChange={(open) => !open && setEditingDepartment(null)}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Edit Department</DialogTitle>\n            <DialogDescription>Update department details.</DialogDescription>\n          </DialogHeader>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(handleEditSubmit)} className=\"space-y-4\">\n              <FormField\n                control={form.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Name</FormLabel>\n                    <FormControl>\n                      <Input {...field} placeholder=\"e.g. Production\" data-testid=\"input-edit-department-name\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={form.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Description</FormLabel>\n                    <FormControl>\n                      <Textarea {...field} placeholder=\"Department description...\" data-testid=\"input-edit-department-description\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={form.control}\n                name=\"managerUserId\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Manager</FormLabel>\n                    <Select onValueChange={field.onChange} value={field.value}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-edit-department-manager\">\n                          <SelectValue placeholder=\"Select manager\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        {users.map((user) => (\n                          <SelectItem key={user.id} value={user.id}>\n                            {user.firstName} {user.lastName}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <DialogFooter>\n                <Button type=\"submit\" disabled={updateMutation.isPending} data-testid=\"button-update-department\">\n                  {updateMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={!!deletingDepartment} onOpenChange={(open) => !open && setDeletingDepartment(null)}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Delete Department</DialogTitle>\n            <DialogDescription>\n              Are you sure you want to delete \"{deletingDepartment?.name}\"? This action cannot be undone.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setDeletingDepartment(null)} data-testid=\"button-cancel-delete\">\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={() => deletingDepartment && deleteMutation.mutate(deletingDepartment.id)}\n              disabled={deleteMutation.isPending}\n              data-testid=\"button-confirm-delete\"\n            >\n              {deleteMutation.isPending ? \"Deleting...\" : \"Delete\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":15805,"size_tokens":null},"client/src/pages/AutomationCampaigns.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription, CardFooter } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n  FormDescription,\n} from \"@/components/ui/form\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  Plus,\n  Zap,\n  MessageSquare,\n  Trash2,\n  Edit,\n  Users,\n  Clock,\n  FileText,\n} from \"lucide-react\";\nimport type { AutomationCampaign } from \"@shared/schema\";\n\nconst campaignSchema = z.object({\n  name: z.string().min(1, \"Campaign name is required\"),\n  description: z.string().optional(),\n  trigger: z.enum([\n    \"quote_sent\",\n    \"quote_no_response_3_days\",\n    \"quote_no_response_7_days\",\n    \"quote_expiring_soon\",\n    \"quote_expired\",\n    \"lead_new\",\n    \"lead_no_contact_24h\",\n    \"job_completed\",\n    \"payment_due\"\n  ]),\n  clientType: z.enum([\"public\", \"trade\"]).nullable(),\n  delayDays: z.coerce.number().min(0).max(365),\n  delayHours: z.coerce.number().min(0).max(23),\n  sendWindow: z.string().optional(),\n  messageTemplate: z.string().min(1, \"Message template is required\"),\n  isActive: z.boolean().default(true),\n});\n\ntype CampaignFormData = z.infer<typeof campaignSchema>;\n\nconst triggerLabels: Record<string, string> = {\n  quote_sent: \"Quote Sent\",\n  quote_no_response_3_days: \"No Response (3 Days)\",\n  quote_no_response_7_days: \"No Response (7 Days)\",\n  quote_expiring_soon: \"Quote Expiring Soon\",\n  quote_expired: \"Quote Expired\",\n  lead_new: \"New Lead\",\n  lead_no_contact_24h: \"Lead No Contact (24h)\",\n  job_completed: \"Job Completed\",\n  payment_due: \"Payment Due\",\n};\n\nfunction CampaignCard({ \n  campaign, \n  onEdit, \n  onDelete, \n  onToggle \n}: { \n  campaign: AutomationCampaign;\n  onEdit: () => void;\n  onDelete: () => void;\n  onToggle: () => void;\n}) {\n  return (\n    <Card className={!campaign.isActive ? 'opacity-60' : ''}>\n      <CardHeader className=\"flex flex-row items-start justify-between gap-2 pb-2\">\n        <div className=\"space-y-1\">\n          <div className=\"flex items-center gap-2\">\n            <CardTitle className=\"text-lg\">{campaign.name}</CardTitle>\n            <Badge variant={campaign.isActive ? 'default' : 'secondary'}>\n              {campaign.isActive ? 'Active' : 'Paused'}\n            </Badge>\n          </div>\n          {campaign.description && (\n            <CardDescription>{campaign.description}</CardDescription>\n          )}\n        </div>\n        <Switch \n          checked={campaign.isActive} \n          onCheckedChange={onToggle}\n          data-testid={`switch-campaign-toggle-${campaign.id}`}\n        />\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        <div className=\"grid grid-cols-2 gap-4 text-sm\">\n          <div className=\"flex items-center gap-2\">\n            <FileText className=\"h-4 w-4 text-muted-foreground\" />\n            <div>\n              <p className=\"text-muted-foreground\">Trigger</p>\n              <p className=\"font-medium\">{triggerLabels[campaign.trigger] || campaign.trigger}</p>\n            </div>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Clock className=\"h-4 w-4 text-muted-foreground\" />\n            <div>\n              <p className=\"text-muted-foreground\">Delay</p>\n              <p className=\"font-medium\">\n                {campaign.delayDays > 0 ? `${campaign.delayDays}d ` : ''}\n                {campaign.delayHours > 0 ? `${campaign.delayHours}h` : ''}\n                {campaign.delayDays === 0 && campaign.delayHours === 0 ? 'Immediate' : ''}\n              </p>\n            </div>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <MessageSquare className=\"h-4 w-4 text-muted-foreground\" />\n            <div>\n              <p className=\"text-muted-foreground\">Action</p>\n              <p className=\"font-medium\">Send SMS</p>\n            </div>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n            <div>\n              <p className=\"text-muted-foreground\">Client Type</p>\n              <p className=\"font-medium capitalize\">{campaign.clientType || 'All'}</p>\n            </div>\n          </div>\n        </div>\n        {campaign.messageTemplate && (\n          <div className=\"p-3 bg-muted rounded-md text-sm\">\n            <p className=\"text-muted-foreground mb-1\">Message Template:</p>\n            <p className=\"italic\">\"{campaign.messageTemplate}\"</p>\n          </div>\n        )}\n      </CardContent>\n      <CardFooter className=\"flex justify-end gap-2\">\n        <Button \n          variant=\"ghost\" \n          size=\"sm\" \n          onClick={onEdit}\n          data-testid={`button-edit-campaign-${campaign.id}`}\n        >\n          <Edit className=\"h-4 w-4 mr-1\" />\n          Edit\n        </Button>\n        <Button \n          variant=\"ghost\" \n          size=\"sm\" \n          onClick={onDelete}\n          className=\"text-destructive hover:text-destructive\"\n          data-testid={`button-delete-campaign-${campaign.id}`}\n        >\n          <Trash2 className=\"h-4 w-4 mr-1\" />\n          Delete\n        </Button>\n      </CardFooter>\n    </Card>\n  );\n}\n\nfunction CreateCampaignDialog({ \n  open, \n  onOpenChange,\n  editCampaign,\n}: { \n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  editCampaign: AutomationCampaign | null;\n}) {\n  const { toast } = useToast();\n  const isEditing = !!editCampaign;\n\n  const form = useForm<CampaignFormData>({\n    resolver: zodResolver(campaignSchema),\n    defaultValues: editCampaign ? {\n      name: editCampaign.name,\n      description: editCampaign.description || \"\",\n      trigger: editCampaign.trigger,\n      clientType: editCampaign.clientType,\n      delayDays: editCampaign.delayDays,\n      delayHours: editCampaign.delayHours,\n      sendWindow: editCampaign.sendWindow || \"\",\n      messageTemplate: editCampaign.messageTemplate,\n      isActive: editCampaign.isActive,\n    } : {\n      name: \"\",\n      description: \"\",\n      trigger: \"quote_sent\",\n      clientType: null,\n      delayDays: 3,\n      delayHours: 0,\n      sendWindow: \"09:00-17:00\",\n      messageTemplate: \"Hi {client_name}, just following up on your quote {quote_number}. Let us know if you have any questions!\",\n      isActive: true,\n    },\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: CampaignFormData) => {\n      if (isEditing) {\n        return apiRequest('PATCH', `/api/automation-campaigns/${editCampaign.id}`, data);\n      }\n      return apiRequest('POST', '/api/automation-campaigns', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/automation-campaigns'] });\n      toast({\n        title: isEditing ? \"Campaign Updated\" : \"Campaign Created\",\n        description: isEditing \n          ? \"The automation campaign has been updated.\" \n          : \"The automation campaign has been created.\",\n      });\n      onOpenChange(false);\n      form.reset();\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: `Failed to ${isEditing ? 'update' : 'create'} campaign`,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSubmit = (data: CampaignFormData) => {\n    createMutation.mutate(data);\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-lg max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle>\n            {isEditing ? 'Edit Automation Campaign' : 'Create Automation Campaign'}\n          </DialogTitle>\n        </DialogHeader>\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(handleSubmit)} className=\"space-y-4\">\n            <FormField\n              control={form.control}\n              name=\"name\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Campaign Name</FormLabel>\n                  <FormControl>\n                    <Input \n                      placeholder=\"e.g., Quote Follow-up (3 days)\" \n                      {...field} \n                      data-testid=\"input-campaign-name\"\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"description\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Description (Optional)</FormLabel>\n                  <FormControl>\n                    <Textarea \n                      placeholder=\"Describe what this campaign does...\"\n                      className=\"resize-none\"\n                      {...field} \n                      data-testid=\"input-campaign-description\"\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"trigger\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Trigger Event</FormLabel>\n                  <Select onValueChange={field.onChange} defaultValue={field.value}>\n                    <FormControl>\n                      <SelectTrigger data-testid=\"select-trigger\">\n                        <SelectValue placeholder=\"Select trigger\" />\n                      </SelectTrigger>\n                    </FormControl>\n                    <SelectContent>\n                      <SelectItem value=\"quote_sent\">Quote Sent</SelectItem>\n                      <SelectItem value=\"quote_no_response_3_days\">No Response (3 Days)</SelectItem>\n                      <SelectItem value=\"quote_no_response_7_days\">No Response (7 Days)</SelectItem>\n                      <SelectItem value=\"quote_expiring_soon\">Quote Expiring Soon</SelectItem>\n                      <SelectItem value=\"quote_expired\">Quote Expired</SelectItem>\n                      <SelectItem value=\"lead_new\">New Lead</SelectItem>\n                      <SelectItem value=\"lead_no_contact_24h\">Lead No Contact (24h)</SelectItem>\n                      <SelectItem value=\"job_completed\">Job Completed</SelectItem>\n                      <SelectItem value=\"payment_due\">Payment Due</SelectItem>\n                    </SelectContent>\n                  </Select>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <FormField\n                control={form.control}\n                name=\"delayDays\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Delay (Days)</FormLabel>\n                    <FormControl>\n                      <Input \n                        type=\"number\" \n                        min={0} \n                        max={365} \n                        {...field} \n                        data-testid=\"input-delay-days\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"delayHours\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Delay (Hours)</FormLabel>\n                    <FormControl>\n                      <Input \n                        type=\"number\" \n                        min={0} \n                        max={23} \n                        {...field} \n                        data-testid=\"input-delay-hours\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </div>\n\n            <FormField\n              control={form.control}\n              name=\"clientType\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Client Type</FormLabel>\n                  <Select \n                    onValueChange={(val) => field.onChange(val === \"all\" ? null : val)} \n                    defaultValue={field.value || \"all\"}\n                  >\n                    <FormControl>\n                      <SelectTrigger data-testid=\"select-client-type\">\n                        <SelectValue placeholder=\"Select client type\" />\n                      </SelectTrigger>\n                    </FormControl>\n                    <SelectContent>\n                      <SelectItem value=\"all\">All Clients</SelectItem>\n                      <SelectItem value=\"public\">Public Only</SelectItem>\n                      <SelectItem value=\"trade\">Trade Only</SelectItem>\n                    </SelectContent>\n                  </Select>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"sendWindow\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Send Window (Optional)</FormLabel>\n                  <FormControl>\n                    <Input \n                      placeholder=\"e.g., 09:00-17:00\"\n                      {...field} \n                      data-testid=\"input-send-window\"\n                    />\n                  </FormControl>\n                  <FormDescription className=\"text-xs\">\n                    Only send messages during these hours\n                  </FormDescription>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"messageTemplate\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Message Template</FormLabel>\n                  <FormControl>\n                    <Textarea \n                      placeholder=\"Hi {client_name}, just following up on your quote {quote_number}...\"\n                      className=\"resize-none min-h-[100px]\"\n                      {...field} \n                      data-testid=\"input-message-template\"\n                    />\n                  </FormControl>\n                  <FormDescription className=\"text-xs\">\n                    Use {'{client_name}'}, {'{quote_number}'}, {'{quote_amount}'} as placeholders\n                  </FormDescription>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"isActive\"\n              render={({ field }) => (\n                <FormItem className=\"flex items-center justify-between rounded-lg border p-3\">\n                  <div className=\"space-y-0.5\">\n                    <FormLabel>Active</FormLabel>\n                    <FormDescription className=\"text-xs\">\n                      Enable this campaign to start processing\n                    </FormDescription>\n                  </div>\n                  <FormControl>\n                    <Switch\n                      checked={field.value}\n                      onCheckedChange={field.onChange}\n                      data-testid=\"switch-is-active\"\n                    />\n                  </FormControl>\n                </FormItem>\n              )}\n            />\n\n            <DialogFooter>\n              <Button \n                type=\"button\" \n                variant=\"outline\" \n                onClick={() => onOpenChange(false)}\n                data-testid=\"button-cancel\"\n              >\n                Cancel\n              </Button>\n              <Button \n                type=\"submit\" \n                disabled={createMutation.isPending}\n                data-testid=\"button-save-campaign\"\n              >\n                {createMutation.isPending ? \"Saving...\" : (isEditing ? \"Save Changes\" : \"Create Campaign\")}\n              </Button>\n            </DialogFooter>\n          </form>\n        </Form>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction LoadingSkeleton() {\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <Skeleton className=\"h-8 w-48 mb-2\" />\n          <Skeleton className=\"h-4 w-64\" />\n        </div>\n        <Skeleton className=\"h-10 w-32\" />\n      </div>\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n        {[...Array(4)].map((_, i) => (\n          <Card key={i}>\n            <CardHeader>\n              <Skeleton className=\"h-6 w-40\" />\n              <Skeleton className=\"h-4 w-60\" />\n            </CardHeader>\n            <CardContent>\n              <Skeleton className=\"h-24 w-full\" />\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nexport default function AutomationCampaigns() {\n  const { toast } = useToast();\n  const [createOpen, setCreateOpen] = useState(false);\n  const [editCampaign, setEditCampaign] = useState<AutomationCampaign | null>(null);\n  const [deleteId, setDeleteId] = useState<string | null>(null);\n\n  const { data: campaigns, isLoading } = useQuery<AutomationCampaign[]>({\n    queryKey: ['/api/automation-campaigns'],\n  });\n\n  const toggleMutation = useMutation({\n    mutationFn: async ({ id, isActive }: { id: string; isActive: boolean }) => {\n      return apiRequest('PATCH', `/api/automation-campaigns/${id}`, { isActive });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/automation-campaigns'] });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest('DELETE', `/api/automation-campaigns/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/automation-campaigns'] });\n      toast({\n        title: \"Campaign Deleted\",\n        description: \"The automation campaign has been deleted.\",\n      });\n      setDeleteId(null);\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to delete campaign\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleEdit = (campaign: AutomationCampaign) => {\n    setEditCampaign(campaign);\n    setCreateOpen(true);\n  };\n\n  const handleCloseDialog = (open: boolean) => {\n    setCreateOpen(open);\n    if (!open) {\n      setEditCampaign(null);\n    }\n  };\n\n  if (isLoading) {\n    return <LoadingSkeleton />;\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold\" data-testid=\"text-page-title\">\n            Automation Campaigns\n          </h1>\n          <p className=\"text-muted-foreground\">\n            Set up automated SMS follow-ups for quotes based on client type and timing\n          </p>\n        </div>\n        <Button onClick={() => setCreateOpen(true)} data-testid=\"button-create-campaign\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Create Campaign\n        </Button>\n      </div>\n\n      {campaigns && campaigns.length > 0 ? (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n          {campaigns.map((campaign) => (\n            <CampaignCard\n              key={campaign.id}\n              campaign={campaign}\n              onEdit={() => handleEdit(campaign)}\n              onDelete={() => setDeleteId(campaign.id)}\n              onToggle={() => toggleMutation.mutate({ \n                id: campaign.id, \n                isActive: !campaign.isActive \n              })}\n            />\n          ))}\n        </div>\n      ) : (\n        <Card className=\"p-12\">\n          <div className=\"text-center\">\n            <Zap className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n            <h3 className=\"text-lg font-medium mb-2\">No Automation Campaigns</h3>\n            <p className=\"text-muted-foreground mb-4\">\n              Create your first automation campaign to start following up on quotes automatically.\n            </p>\n            <Button onClick={() => setCreateOpen(true)} data-testid=\"button-create-first-campaign\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Create Your First Campaign\n            </Button>\n          </div>\n        </Card>\n      )}\n\n      <CreateCampaignDialog\n        open={createOpen}\n        onOpenChange={handleCloseDialog}\n        editCampaign={editCampaign}\n      />\n\n      <Dialog open={!!deleteId} onOpenChange={() => setDeleteId(null)}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Delete Campaign</DialogTitle>\n          </DialogHeader>\n          <p>Are you sure you want to delete this automation campaign? This action cannot be undone.</p>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setDeleteId(null)}>\n              Cancel\n            </Button>\n            <Button \n              variant=\"destructive\" \n              onClick={() => deleteId && deleteMutation.mutate(deleteId)}\n              disabled={deleteMutation.isPending}\n              data-testid=\"button-confirm-delete\"\n            >\n              {deleteMutation.isPending ? \"Deleting...\" : \"Delete\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":21953,"size_tokens":null},"client/src/components/jobs/JobSetupDocument.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  Accordion,\n  AccordionContent,\n  AccordionItem,\n  AccordionTrigger,\n} from \"@/components/ui/accordion\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  AlertCircle,\n  Check,\n  CheckCircle,\n  ClipboardList,\n  FileText,\n  Loader2,\n  Package,\n  Calendar,\n  Wrench,\n  Save,\n  Plus,\n  AlertTriangle,\n} from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type {\n  JobSetupDocument as JobSetupDocumentType,\n  JobSetupProduct,\n  JobSetupSection1Sales,\n  JobSetupSection3Production,\n  JobSetupSection4Schedule,\n  JobSetupSection5Install,\n} from \"@shared/schema\";\n\ninterface JobSetupDocumentProps {\n  jobId?: string;\n  leadId?: string;\n  jobType: \"supply_only\" | \"supply_install\";\n}\n\ninterface DocumentWithProducts extends JobSetupDocumentType {\n  products?: JobSetupProduct[];\n}\n\nconst SECTION_TITLES = {\n  1: \"Sales & Site Info\",\n  2: \"Products / BOM\",\n  3: \"Production Notes\",\n  4: \"Scheduling\",\n  5: \"Install Notes & Sign-off\",\n};\n\nconst SECTION_ICONS = {\n  1: FileText,\n  2: Package,\n  3: Wrench,\n  4: Calendar,\n  5: ClipboardList,\n};\n\nexport function JobSetupDocument({ jobId, leadId, jobType }: JobSetupDocumentProps) {\n  const { toast } = useToast();\n  const [expandedSections, setExpandedSections] = useState<string[]>([\"section-1\"]);\n  \n  const isLeadMode = !!leadId && !jobId;\n  const resourceId = jobId || leadId;\n  const apiPath = isLeadMode \n    ? `/api/leads/${leadId}/live-document`\n    : `/api/jobs/${jobId}/setup-document`;\n  const queryKey = isLeadMode \n    ? [\"/api/leads\", leadId, \"live-document\"]\n    : [\"/api/jobs\", jobId, \"setup-document\"];\n\n  const { data: document, isLoading } = useQuery<DocumentWithProducts>({\n    queryKey,\n    enabled: jobType === \"supply_install\" && !!resourceId,\n  });\n\n  const updateSectionMutation = useMutation({\n    mutationFn: async ({\n      sectionNumber,\n      data,\n    }: {\n      sectionNumber: number;\n      data: unknown;\n    }) => {\n      return apiRequest(\n        \"PATCH\",\n        `/api/job-setup-documents/${document?.id}/section${sectionNumber}`,\n        data\n      );\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey });\n      toast({\n        title: \"Section Updated\",\n        description: \"Changes have been saved\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to save changes\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const markCompleteMutation = useMutation({\n    mutationFn: async ({\n      sectionNumber,\n      complete,\n    }: {\n      sectionNumber: number;\n      complete: boolean;\n    }) => {\n      return apiRequest(\n        \"POST\",\n        `/api/job-setup-documents/${document?.id}/section/${sectionNumber}/complete`,\n        { complete }\n      );\n    },\n    onSuccess: (_, { sectionNumber, complete }) => {\n      queryClient.invalidateQueries({ queryKey });\n      toast({\n        title: complete ? \"Section Completed\" : \"Section Reopened\",\n        description: `Section ${sectionNumber} has been ${complete ? \"marked complete\" : \"reopened for editing\"}`,\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to update section status\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  if (jobType !== \"supply_install\") {\n    return (\n      <Card>\n        <CardContent className=\"py-8 text-center text-muted-foreground\">\n          <AlertCircle className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n          <p className=\"text-sm\">\n            Job Setup Documents are only available for Supply + Install jobs\n          </p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"space-y-4\">\n        <Skeleton className=\"h-12\" />\n        <Skeleton className=\"h-32\" />\n        <Skeleton className=\"h-32\" />\n      </div>\n    );\n  }\n\n  if (!document) {\n    return (\n      <Card>\n        <CardContent className=\"py-8 text-center text-muted-foreground\">\n          <AlertTriangle className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n          <p className=\"text-sm\">No setup document found for this job</p>\n          <p className=\"text-xs mt-2\">\n            Setup documents are auto-created when a quote is accepted\n          </p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const completedSections = [\n    document.section1Complete,\n    document.section2Complete,\n    document.section3Complete,\n    document.section4Complete,\n    document.section5Complete,\n  ].filter(Boolean).length;\n\n  const progressPercent = (completedSections / 5) * 100;\n\n  return (\n    <div className=\"space-y-4\">\n      <Card>\n        <CardHeader className=\"pb-3\">\n          <div className=\"flex items-center justify-between\">\n            <CardTitle className=\"text-sm font-medium\">\n              Job Setup & Handover Progress\n            </CardTitle>\n            <Badge\n              variant={\n                document.status === \"completed\" ? \"default\" : \"secondary\"\n              }\n            >\n              {document.status.replace(/_/g, \" \")}\n            </Badge>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center justify-between text-sm\">\n              <span className=\"text-muted-foreground\">\n                {completedSections} of 5 sections complete\n              </span>\n              <span className=\"font-semibold\">{Math.round(progressPercent)}%</span>\n            </div>\n            <Progress value={progressPercent} className=\"h-2\" />\n          </div>\n        </CardContent>\n      </Card>\n\n      <Accordion\n        type=\"multiple\"\n        value={expandedSections}\n        onValueChange={setExpandedSections}\n        className=\"space-y-2\"\n      >\n        <Section1SalesInfo\n          document={document}\n          isComplete={document.section1Complete}\n          onMarkComplete={(complete) =>\n            markCompleteMutation.mutate({ sectionNumber: 1, complete })\n          }\n          onSave={(data) =>\n            updateSectionMutation.mutate({ sectionNumber: 1, data })\n          }\n          isSaving={updateSectionMutation.isPending}\n        />\n\n        <Section2Products\n          document={document}\n          products={document.products || []}\n          isComplete={document.section2Complete}\n          onMarkComplete={(complete) =>\n            markCompleteMutation.mutate({ sectionNumber: 2, complete })\n          }\n        />\n\n        <Section3Production\n          document={document}\n          isComplete={document.section3Complete}\n          onMarkComplete={(complete) =>\n            markCompleteMutation.mutate({ sectionNumber: 3, complete })\n          }\n          onSave={(data) =>\n            updateSectionMutation.mutate({ sectionNumber: 3, data })\n          }\n          isSaving={updateSectionMutation.isPending}\n        />\n\n        <Section4Schedule\n          document={document}\n          isComplete={document.section4Complete}\n          onMarkComplete={(complete) =>\n            markCompleteMutation.mutate({ sectionNumber: 4, complete })\n          }\n          onSave={(data) =>\n            updateSectionMutation.mutate({ sectionNumber: 4, data })\n          }\n          isSaving={updateSectionMutation.isPending}\n        />\n\n        <Section5Install\n          document={document}\n          isComplete={document.section5Complete}\n          onMarkComplete={(complete) =>\n            markCompleteMutation.mutate({ sectionNumber: 5, complete })\n          }\n          onSave={(data) =>\n            updateSectionMutation.mutate({ sectionNumber: 5, data })\n          }\n          isSaving={updateSectionMutation.isPending}\n        />\n      </Accordion>\n    </div>\n  );\n}\n\ninterface SectionProps {\n  document: DocumentWithProducts;\n  isComplete: boolean | null;\n  onMarkComplete: (complete: boolean) => void;\n  onSave?: (data: unknown) => void;\n  isSaving?: boolean;\n}\n\nfunction SectionHeader({\n  sectionNumber,\n  title,\n  isComplete,\n  onMarkComplete,\n}: {\n  sectionNumber: number;\n  title: string;\n  isComplete: boolean | null;\n  onMarkComplete: (complete: boolean) => void;\n}) {\n  const Icon = SECTION_ICONS[sectionNumber as keyof typeof SECTION_ICONS];\n\n  return (\n    <div className=\"flex items-center justify-between w-full pr-2\">\n      <div className=\"flex items-center gap-3\">\n        <div\n          className={`p-2 rounded-full ${isComplete ? \"bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400\" : \"bg-muted text-muted-foreground\"}`}\n        >\n          {isComplete ? (\n            <CheckCircle className=\"h-4 w-4\" />\n          ) : (\n            <Icon className=\"h-4 w-4\" />\n          )}\n        </div>\n        <div>\n          <span className=\"font-medium\">\n            Section {sectionNumber}: {title}\n          </span>\n        </div>\n      </div>\n      <div className=\"flex items-center gap-2\" onClick={(e) => e.stopPropagation()}>\n        <span className=\"text-xs text-muted-foreground\">\n          {isComplete ? \"Complete\" : \"Pending\"}\n        </span>\n        <Switch\n          checked={isComplete ?? false}\n          onCheckedChange={onMarkComplete}\n          data-testid={`switch-section-${sectionNumber}-complete`}\n        />\n      </div>\n    </div>\n  );\n}\n\nfunction Section1SalesInfo({\n  document,\n  isComplete,\n  onMarkComplete,\n  onSave,\n  isSaving,\n}: SectionProps) {\n  const section = (document.section1Sales as JobSetupSection1Sales) || {};\n  const [formData, setFormData] = useState({\n    oldFenceBeingRemoved: section.oldFenceBeingRemoved ?? false,\n    oldFenceMaterial: section.oldFenceMaterial ?? \"\",\n    oldFenceAgeYears: section.oldFenceAgeYears ?? \"\",\n    allFootingsRemoved: section.allFootingsRemoved ?? false,\n    reticInGround: section.reticInGround ?? false,\n    reticNotes: section.reticNotes ?? \"\",\n    undergroundServicesKnown: section.undergroundServicesKnown ?? false,\n    undergroundServicesNotes: section.undergroundServicesNotes ?? \"\",\n    poolArea: section.poolArea ?? false,\n    dogsOnSite: section.dogsOnSite ?? false,\n    lockedGatesOrRestrictedAccess: section.lockedGatesOrRestrictedAccess ?? false,\n    someoneHomeOnInstallDay: section.someoneHomeOnInstallDay ?? false,\n    drivewayAccessDescription: section.drivewayAccessDescription ?? \"\",\n    steepOrSlopingSite: section.steepOrSlopingSite ?? false,\n    siteHazardsNotes: section.siteHazardsNotes ?? \"\",\n    needsCoreDrill: section.needsCoreDrill ?? false,\n    needsChainsaw: section.needsChainsaw ?? false,\n    needsAuger: section.needsAuger ?? false,\n    needsSkipBin: section.needsSkipBin ?? false,\n    needsExtraLabor: section.needsExtraLabor ?? false,\n    equipmentOtherNotes: section.equipmentOtherNotes ?? \"\",\n    fenceTotalMetres: section.fenceTotalMetres ?? 0,\n    fenceHeightMm: section.fenceHeightMm ?? 0,\n    numGates: section.numGates ?? 0,\n    gateOpeningsDescription: section.gateOpeningsDescription ?? \"\",\n    rakedOrStepped: section.rakedOrStepped ?? \"\",\n    panelsLayoutNotes: section.panelsLayoutNotes ?? \"\",\n    clientConfirmationText: section.clientConfirmationText ?? \"\",\n    clientSignedAt: section.clientSignedAt ?? \"\",\n  });\n\n  const handleSave = () => {\n    onSave?.(formData);\n  };\n\n  return (\n    <AccordionItem value=\"section-1\" className=\"border rounded-lg\">\n      <AccordionTrigger className=\"px-4 hover:no-underline\">\n        <SectionHeader\n          sectionNumber={1}\n          title={SECTION_TITLES[1]}\n          isComplete={isComplete}\n          onMarkComplete={onMarkComplete}\n        />\n      </AccordionTrigger>\n      <AccordionContent className=\"px-4 pb-4\">\n        <div className=\"space-y-4\">\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Old fence being removed?</Label>\n              <Switch\n                checked={formData.oldFenceBeingRemoved}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, oldFenceBeingRemoved: v })\n                }\n                data-testid=\"switch-old-fence-removed\"\n              />\n            </div>\n            {formData.oldFenceBeingRemoved && (\n              <div className=\"space-y-2\">\n                <Label className=\"text-sm\">Old fence material</Label>\n                <Input\n                  value={formData.oldFenceMaterial}\n                  onChange={(e) =>\n                    setFormData({ ...formData, oldFenceMaterial: e.target.value })\n                  }\n                  placeholder=\"e.g., Timber, Colorbond\"\n                  data-testid=\"input-old-fence-material\"\n                />\n              </div>\n            )}\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">All footings removed?</Label>\n              <Switch\n                checked={formData.allFootingsRemoved}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, allFootingsRemoved: v })\n                }\n                data-testid=\"switch-footings-removed\"\n              />\n            </div>\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Retic in ground?</Label>\n              <Switch\n                checked={formData.reticInGround}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, reticInGround: v })\n                }\n                data-testid=\"switch-retic-ground\"\n              />\n            </div>\n          </div>\n\n          {formData.reticInGround && (\n            <div className=\"space-y-2\">\n              <Label className=\"text-sm\">Retic notes</Label>\n              <Textarea\n                value={formData.reticNotes}\n                onChange={(e) =>\n                  setFormData({ ...formData, reticNotes: e.target.value })\n                }\n                placeholder=\"Notes about reticulation...\"\n                data-testid=\"textarea-retic-notes\"\n              />\n            </div>\n          )}\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Underground services known?</Label>\n              <Switch\n                checked={formData.undergroundServicesKnown}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, undergroundServicesKnown: v })\n                }\n                data-testid=\"switch-underground-services\"\n              />\n            </div>\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Pool area?</Label>\n              <Switch\n                checked={formData.poolArea}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, poolArea: v })\n                }\n                data-testid=\"switch-pool-area\"\n              />\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Dogs on site?</Label>\n              <Switch\n                checked={formData.dogsOnSite}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, dogsOnSite: v })\n                }\n                data-testid=\"switch-dogs-on-site\"\n              />\n            </div>\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Someone home on install day?</Label>\n              <Switch\n                checked={formData.someoneHomeOnInstallDay}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, someoneHomeOnInstallDay: v })\n                }\n                data-testid=\"switch-someone-home\"\n              />\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Locked gates/restricted access?</Label>\n              <Switch\n                checked={formData.lockedGatesOrRestrictedAccess}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, lockedGatesOrRestrictedAccess: v })\n                }\n                data-testid=\"switch-locked-gates\"\n              />\n            </div>\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Steep or sloping site?</Label>\n              <Switch\n                checked={formData.steepOrSlopingSite}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, steepOrSlopingSite: v })\n                }\n                data-testid=\"switch-steep-site\"\n              />\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label className=\"text-sm\">Driveway access description</Label>\n            <Textarea\n              value={formData.drivewayAccessDescription}\n              onChange={(e) =>\n                setFormData({ ...formData, drivewayAccessDescription: e.target.value })\n              }\n              placeholder=\"Describe driveway/site access...\"\n              data-testid=\"textarea-driveway-access\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label className=\"text-sm\">Site hazards notes</Label>\n            <Textarea\n              value={formData.siteHazardsNotes}\n              onChange={(e) =>\n                setFormData({ ...formData, siteHazardsNotes: e.target.value })\n              }\n              placeholder=\"Any site hazards to be aware of...\"\n              data-testid=\"textarea-site-hazards\"\n            />\n          </div>\n\n          <h4 className=\"font-medium text-sm pt-2\">Equipment Required</h4>\n          <div className=\"grid grid-cols-3 gap-4\">\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Core drill</Label>\n              <Switch\n                checked={formData.needsCoreDrill}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, needsCoreDrill: v })\n                }\n                data-testid=\"switch-core-drill\"\n              />\n            </div>\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Chainsaw</Label>\n              <Switch\n                checked={formData.needsChainsaw}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, needsChainsaw: v })\n                }\n                data-testid=\"switch-chainsaw\"\n              />\n            </div>\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Auger</Label>\n              <Switch\n                checked={formData.needsAuger}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, needsAuger: v })\n                }\n                data-testid=\"switch-auger\"\n              />\n            </div>\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Skip bin</Label>\n              <Switch\n                checked={formData.needsSkipBin}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, needsSkipBin: v })\n                }\n                data-testid=\"switch-skip-bin\"\n              />\n            </div>\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Extra labor</Label>\n              <Switch\n                checked={formData.needsExtraLabor}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, needsExtraLabor: v })\n                }\n                data-testid=\"switch-extra-labor\"\n              />\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label className=\"text-sm\">Other equipment notes</Label>\n            <Textarea\n              value={formData.equipmentOtherNotes}\n              onChange={(e) =>\n                setFormData({ ...formData, equipmentOtherNotes: e.target.value })\n              }\n              placeholder=\"Any other equipment required...\"\n              data-testid=\"textarea-equipment-notes\"\n            />\n          </div>\n\n          <div className=\"flex justify-end\">\n            <Button onClick={handleSave} disabled={isSaving} data-testid=\"button-save-section1\">\n              {isSaving ? (\n                <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n              ) : (\n                <Save className=\"h-4 w-4 mr-2\" />\n              )}\n              Save Changes\n            </Button>\n          </div>\n        </div>\n      </AccordionContent>\n    </AccordionItem>\n  );\n}\n\nfunction Section2Products({\n  document,\n  products,\n  isComplete,\n  onMarkComplete,\n}: SectionProps & { products: JobSetupProduct[] }) {\n  return (\n    <AccordionItem value=\"section-2\" className=\"border rounded-lg\">\n      <AccordionTrigger className=\"px-4 hover:no-underline\">\n        <SectionHeader\n          sectionNumber={2}\n          title={SECTION_TITLES[2]}\n          isComplete={isComplete}\n          onMarkComplete={onMarkComplete}\n        />\n      </AccordionTrigger>\n      <AccordionContent className=\"px-4 pb-4\">\n        <div className=\"space-y-4\">\n          {Boolean((document.section2ProductsMeta as Record<string, boolean> | null)?.autoPopulatedFromQuote) && (\n            <div className=\"flex items-center gap-2 text-sm text-muted-foreground bg-muted/50 p-2 rounded\">\n              <Check className=\"h-4 w-4 text-green-500\" />\n              <span>Products auto-populated from quote</span>\n            </div>\n          )}\n\n          {products.length > 0 ? (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Product</TableHead>\n                  <TableHead>Category</TableHead>\n                  <TableHead className=\"text-right\">Qty</TableHead>\n                  <TableHead>Notes</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {products.map((product) => (\n                  <TableRow key={product.id} data-testid={`row-product-${product.id}`}>\n                    <TableCell className=\"font-medium\">\n                      {product.productName}\n                    </TableCell>\n                    <TableCell>\n                      <Badge variant=\"outline\">{product.category}</Badge>\n                    </TableCell>\n                    <TableCell className=\"text-right font-mono\">\n                      {product.quantity}\n                    </TableCell>\n                    <TableCell className=\"text-muted-foreground text-sm\">\n                      {product.notes || \"-\"}\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          ) : (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <Package className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n              <p className=\"text-sm\">No products in BOM</p>\n            </div>\n          )}\n\n          <Button variant=\"outline\" size=\"sm\" className=\"w-full\" data-testid=\"button-add-product\">\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Add Product\n          </Button>\n        </div>\n      </AccordionContent>\n    </AccordionItem>\n  );\n}\n\nfunction Section3Production({\n  document,\n  isComplete,\n  onMarkComplete,\n  onSave,\n  isSaving,\n}: SectionProps) {\n  const section = (document.section3Production as JobSetupSection3Production) || {};\n  const [formData, setFormData] = useState({\n    postsManufactured: section.postsManufactured ?? false,\n    panelsManufactured: section.panelsManufactured ?? false,\n    gatesFabricated: section.gatesFabricated ?? false,\n    hardwarePacked: section.hardwarePacked ?? false,\n    accessoriesPacked: section.accessoriesPacked ?? false,\n    cementAndMaterialsPrepared: section.cementAndMaterialsPrepared ?? false,\n    productionSpecialNotes: section.productionSpecialNotes ?? \"\",\n    productionCompletedBy: section.productionCompletedBy ?? \"\",\n    productionCompletedAt: section.productionCompletedAt ?? \"\",\n  });\n\n  const handleSave = () => {\n    onSave?.(formData);\n  };\n\n  return (\n    <AccordionItem value=\"section-3\" className=\"border rounded-lg\">\n      <AccordionTrigger className=\"px-4 hover:no-underline\">\n        <SectionHeader\n          sectionNumber={3}\n          title={SECTION_TITLES[3]}\n          isComplete={isComplete}\n          onMarkComplete={onMarkComplete}\n        />\n      </AccordionTrigger>\n      <AccordionContent className=\"px-4 pb-4\">\n        <div className=\"space-y-4\">\n          <h4 className=\"font-medium text-sm\">Production Checklist</h4>\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Posts manufactured</Label>\n              <Switch\n                checked={formData.postsManufactured}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, postsManufactured: v })\n                }\n                data-testid=\"switch-posts-manufactured\"\n              />\n            </div>\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Panels manufactured</Label>\n              <Switch\n                checked={formData.panelsManufactured}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, panelsManufactured: v })\n                }\n                data-testid=\"switch-panels-manufactured\"\n              />\n            </div>\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Gates fabricated</Label>\n              <Switch\n                checked={formData.gatesFabricated}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, gatesFabricated: v })\n                }\n                data-testid=\"switch-gates-fabricated\"\n              />\n            </div>\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Hardware packed</Label>\n              <Switch\n                checked={formData.hardwarePacked}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, hardwarePacked: v })\n                }\n                data-testid=\"switch-hardware-packed\"\n              />\n            </div>\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Accessories packed</Label>\n              <Switch\n                checked={formData.accessoriesPacked}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, accessoriesPacked: v })\n                }\n                data-testid=\"switch-accessories-packed\"\n              />\n            </div>\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Cement & materials prepared</Label>\n              <Switch\n                checked={formData.cementAndMaterialsPrepared}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, cementAndMaterialsPrepared: v })\n                }\n                data-testid=\"switch-cement-prepared\"\n              />\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label className=\"text-sm\">Production special notes</Label>\n            <Textarea\n              value={formData.productionSpecialNotes}\n              onChange={(e) =>\n                setFormData({ ...formData, productionSpecialNotes: e.target.value })\n              }\n              placeholder=\"Notes for the production team...\"\n              data-testid=\"textarea-production-notes\"\n            />\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label className=\"text-sm\">Completed by</Label>\n              <Input\n                value={formData.productionCompletedBy}\n                onChange={(e) =>\n                  setFormData({ ...formData, productionCompletedBy: e.target.value })\n                }\n                placeholder=\"Staff member name\"\n                data-testid=\"input-production-completed-by\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label className=\"text-sm\">Completed at</Label>\n              <Input\n                type=\"datetime-local\"\n                value={formData.productionCompletedAt}\n                onChange={(e) =>\n                  setFormData({ ...formData, productionCompletedAt: e.target.value })\n                }\n                data-testid=\"input-production-completed-at\"\n              />\n            </div>\n          </div>\n\n          <div className=\"flex justify-end\">\n            <Button onClick={handleSave} disabled={isSaving} data-testid=\"button-save-section3\">\n              {isSaving ? (\n                <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n              ) : (\n                <Save className=\"h-4 w-4 mr-2\" />\n              )}\n              Save Changes\n            </Button>\n          </div>\n        </div>\n      </AccordionContent>\n    </AccordionItem>\n  );\n}\n\nfunction Section4Schedule({\n  document,\n  isComplete,\n  onMarkComplete,\n  onSave,\n  isSaving,\n}: SectionProps) {\n  const section = (document.section4Schedule as JobSetupSection4Schedule) || {};\n  const [formData, setFormData] = useState({\n    schedulingReadyForInstall: section.schedulingReadyForInstall ?? false,\n    proposedInstallDate: section.proposedInstallDate ?? \"\",\n    confirmInstallDateWithClient: section.confirmInstallDateWithClient ?? false,\n    installTimeWindow: section.installTimeWindow ?? \"\",\n    installerTeamAssigned: section.installerTeamAssigned ?? \"\",\n    isSupplyOnlyPickup: section.isSupplyOnlyPickup ?? false,\n    pickupOrDeliveryNotes: section.pickupOrDeliveryNotes ?? \"\",\n    schedulerNotes: section.schedulerNotes ?? \"\",\n    scheduledBy: section.scheduledBy ?? \"\",\n    scheduledAt: section.scheduledAt ?? \"\",\n    requiresCoreDrill: section.requiresCoreDrill ?? false,\n    requiresChainsaw: section.requiresChainsaw ?? false,\n    requiresAuger: section.requiresAuger ?? false,\n    requiresSkipBin: section.requiresSkipBin ?? false,\n  });\n\n  const handleSave = () => {\n    onSave?.(formData);\n  };\n\n  return (\n    <AccordionItem value=\"section-4\" className=\"border rounded-lg\">\n      <AccordionTrigger className=\"px-4 hover:no-underline\">\n        <SectionHeader\n          sectionNumber={4}\n          title={SECTION_TITLES[4]}\n          isComplete={isComplete}\n          onMarkComplete={onMarkComplete}\n        />\n      </AccordionTrigger>\n      <AccordionContent className=\"px-4 pb-4\">\n        <div className=\"space-y-4\">\n          <div className=\"flex items-center justify-between p-3 border rounded\">\n            <Label className=\"text-sm\">Ready for install scheduling?</Label>\n            <Switch\n              checked={formData.schedulingReadyForInstall}\n              onCheckedChange={(v) =>\n                setFormData({ ...formData, schedulingReadyForInstall: v })\n              }\n              data-testid=\"switch-ready-install\"\n            />\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label className=\"text-sm\">Proposed install date</Label>\n              <Input\n                type=\"date\"\n                value={formData.proposedInstallDate}\n                onChange={(e) =>\n                  setFormData({ ...formData, proposedInstallDate: e.target.value })\n                }\n                data-testid=\"input-proposed-date\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label className=\"text-sm\">Install time window</Label>\n              <Input\n                value={formData.installTimeWindow}\n                onChange={(e) =>\n                  setFormData({ ...formData, installTimeWindow: e.target.value })\n                }\n                placeholder=\"e.g., Morning, Afternoon, All day\"\n                data-testid=\"input-install-window\"\n              />\n            </div>\n          </div>\n\n          <div className=\"flex items-center justify-between p-3 border rounded\">\n            <Label className=\"text-sm\">Date confirmed with client?</Label>\n            <Switch\n              checked={formData.confirmInstallDateWithClient}\n              onCheckedChange={(v) =>\n                setFormData({ ...formData, confirmInstallDateWithClient: v })\n              }\n              data-testid=\"switch-date-confirmed\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label className=\"text-sm\">Installer team assigned</Label>\n            <Input\n              value={formData.installerTeamAssigned}\n              onChange={(e) =>\n                setFormData({ ...formData, installerTeamAssigned: e.target.value })\n              }\n              placeholder=\"e.g., Team A, John & Mike\"\n              data-testid=\"input-installer-team\"\n            />\n          </div>\n\n          <div className=\"flex items-center justify-between p-3 border rounded\">\n            <Label className=\"text-sm\">Supply only (customer pickup)?</Label>\n            <Switch\n              checked={formData.isSupplyOnlyPickup}\n              onCheckedChange={(v) =>\n                setFormData({ ...formData, isSupplyOnlyPickup: v })\n              }\n              data-testid=\"switch-supply-only\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label className=\"text-sm\">Pickup/delivery notes</Label>\n            <Textarea\n              value={formData.pickupOrDeliveryNotes}\n              onChange={(e) =>\n                setFormData({ ...formData, pickupOrDeliveryNotes: e.target.value })\n              }\n              placeholder=\"Details about pickup or delivery...\"\n              data-testid=\"textarea-pickup-notes\"\n            />\n          </div>\n\n          <h4 className=\"font-medium text-sm pt-2\">Equipment Required</h4>\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Core drill</Label>\n              <Switch\n                checked={formData.requiresCoreDrill}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, requiresCoreDrill: v })\n                }\n                data-testid=\"switch-req-core-drill\"\n              />\n            </div>\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Chainsaw</Label>\n              <Switch\n                checked={formData.requiresChainsaw}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, requiresChainsaw: v })\n                }\n                data-testid=\"switch-req-chainsaw\"\n              />\n            </div>\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Auger</Label>\n              <Switch\n                checked={formData.requiresAuger}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, requiresAuger: v })\n                }\n                data-testid=\"switch-req-auger\"\n              />\n            </div>\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Skip bin</Label>\n              <Switch\n                checked={formData.requiresSkipBin}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, requiresSkipBin: v })\n                }\n                data-testid=\"switch-req-skip-bin\"\n              />\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label className=\"text-sm\">Scheduler notes</Label>\n            <Textarea\n              value={formData.schedulerNotes}\n              onChange={(e) =>\n                setFormData({ ...formData, schedulerNotes: e.target.value })\n              }\n              placeholder=\"Additional scheduling notes...\"\n              data-testid=\"textarea-scheduler-notes\"\n            />\n          </div>\n\n          <div className=\"flex justify-end\">\n            <Button onClick={handleSave} disabled={isSaving} data-testid=\"button-save-section4\">\n              {isSaving ? (\n                <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n              ) : (\n                <Save className=\"h-4 w-4 mr-2\" />\n              )}\n              Save Changes\n            </Button>\n          </div>\n        </div>\n      </AccordionContent>\n    </AccordionItem>\n  );\n}\n\nfunction Section5Install({\n  document,\n  isComplete,\n  onMarkComplete,\n  onSave,\n  isSaving,\n}: SectionProps) {\n  const section = (document.section5Install as JobSetupSection5Install) || {};\n  const [formData, setFormData] = useState({\n    installerCheckedMaterialsComplete: section.installerCheckedMaterialsComplete ?? false,\n    installerCheckedToolsLoaded: section.installerCheckedToolsLoaded ?? false,\n    installerConfirmedSiteAccessOk: section.installerConfirmedSiteAccessOk ?? false,\n    installerReadSiteNotes: section.installerReadSiteNotes ?? false,\n    installerPrestartNotes: section.installerPrestartNotes ?? \"\",\n    installerPrestartCompletedBy: section.installerPrestartCompletedBy ?? \"\",\n    installerPrestartCompletedAt: section.installerPrestartCompletedAt ?? \"\",\n    installCompleted: section.installCompleted ?? false,\n    completionNotes: section.completionNotes ?? \"\",\n    clientSignedCompletion: section.clientSignedCompletion ?? false,\n    clientSignedCompletionAt: section.clientSignedCompletionAt ?? \"\",\n    installerCompletionBy: section.installerCompletionBy ?? \"\",\n    installerCompletionAt: section.installerCompletionAt ?? \"\",\n  });\n\n  const handleSave = () => {\n    onSave?.(formData);\n  };\n\n  return (\n    <AccordionItem value=\"section-5\" className=\"border rounded-lg\">\n      <AccordionTrigger className=\"px-4 hover:no-underline\">\n        <SectionHeader\n          sectionNumber={5}\n          title={SECTION_TITLES[5]}\n          isComplete={isComplete}\n          onMarkComplete={onMarkComplete}\n        />\n      </AccordionTrigger>\n      <AccordionContent className=\"px-4 pb-4\">\n        <div className=\"space-y-4\">\n          <h4 className=\"font-medium text-sm\">Pre-Start Checklist</h4>\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Materials complete?</Label>\n              <Switch\n                checked={formData.installerCheckedMaterialsComplete}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, installerCheckedMaterialsComplete: v })\n                }\n                data-testid=\"switch-materials-complete\"\n              />\n            </div>\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Tools loaded?</Label>\n              <Switch\n                checked={formData.installerCheckedToolsLoaded}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, installerCheckedToolsLoaded: v })\n                }\n                data-testid=\"switch-tools-loaded\"\n              />\n            </div>\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Site access OK?</Label>\n              <Switch\n                checked={formData.installerConfirmedSiteAccessOk}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, installerConfirmedSiteAccessOk: v })\n                }\n                data-testid=\"switch-site-access-ok\"\n              />\n            </div>\n            <div className=\"flex items-center justify-between p-3 border rounded\">\n              <Label className=\"text-sm\">Read site notes?</Label>\n              <Switch\n                checked={formData.installerReadSiteNotes}\n                onCheckedChange={(v) =>\n                  setFormData({ ...formData, installerReadSiteNotes: v })\n                }\n                data-testid=\"switch-read-site-notes\"\n              />\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label className=\"text-sm\">Pre-start notes</Label>\n            <Textarea\n              value={formData.installerPrestartNotes}\n              onChange={(e) =>\n                setFormData({ ...formData, installerPrestartNotes: e.target.value })\n              }\n              placeholder=\"Any notes before starting install...\"\n              data-testid=\"textarea-prestart-notes\"\n            />\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label className=\"text-sm\">Pre-start completed by</Label>\n              <Input\n                value={formData.installerPrestartCompletedBy}\n                onChange={(e) =>\n                  setFormData({ ...formData, installerPrestartCompletedBy: e.target.value })\n                }\n                placeholder=\"Installer name\"\n                data-testid=\"input-prestart-by\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label className=\"text-sm\">Pre-start completed at</Label>\n              <Input\n                type=\"datetime-local\"\n                value={formData.installerPrestartCompletedAt}\n                onChange={(e) =>\n                  setFormData({ ...formData, installerPrestartCompletedAt: e.target.value })\n                }\n                data-testid=\"input-prestart-at\"\n              />\n            </div>\n          </div>\n\n          <h4 className=\"font-medium text-sm pt-2\">Completion Sign-off</h4>\n\n          <div className=\"flex items-center justify-between p-3 border rounded\">\n            <Label className=\"text-sm\">Install completed?</Label>\n            <Switch\n              checked={formData.installCompleted}\n              onCheckedChange={(v) =>\n                setFormData({ ...formData, installCompleted: v })\n              }\n              data-testid=\"switch-install-completed\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label className=\"text-sm\">Completion notes</Label>\n            <Textarea\n              value={formData.completionNotes}\n              onChange={(e) =>\n                setFormData({ ...formData, completionNotes: e.target.value })\n              }\n              placeholder=\"Notes from installation...\"\n              data-testid=\"textarea-completion-notes\"\n            />\n          </div>\n\n          <div className=\"flex items-center justify-between p-3 border rounded\">\n            <Label className=\"text-sm\">Client signed off?</Label>\n            <Switch\n              checked={formData.clientSignedCompletion}\n              onCheckedChange={(v) =>\n                setFormData({ ...formData, clientSignedCompletion: v })\n              }\n              data-testid=\"switch-client-signed\"\n            />\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label className=\"text-sm\">Completed by</Label>\n              <Input\n                value={formData.installerCompletionBy}\n                onChange={(e) =>\n                  setFormData({ ...formData, installerCompletionBy: e.target.value })\n                }\n                placeholder=\"Installer name\"\n                data-testid=\"input-completion-by\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label className=\"text-sm\">Completed at</Label>\n              <Input\n                type=\"datetime-local\"\n                value={formData.installerCompletionAt}\n                onChange={(e) =>\n                  setFormData({ ...formData, installerCompletionAt: e.target.value })\n                }\n                data-testid=\"input-completion-at\"\n              />\n            </div>\n          </div>\n\n          <div className=\"flex justify-end\">\n            <Button onClick={handleSave} disabled={isSaving} data-testid=\"button-save-section5\">\n              {isSaving ? (\n                <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n              ) : (\n                <Save className=\"h-4 w-4 mr-2\" />\n              )}\n              Save Changes\n            </Button>\n          </div>\n        </div>\n      </AccordionContent>\n    </AccordionItem>\n  );\n}\n","path":null,"size_bytes":45753,"size_tokens":null},"client/src/components/leads/CallLogEntry.tsx":{"content":"import { useState } from \"react\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { format, formatDistanceToNow } from \"date-fns\";\nimport { \n  Phone, PhoneIncoming, PhoneOutgoing, PhoneMissed, \n  Clock, User, ChevronDown, ChevronUp, FileText,\n  Edit2, Trash2, Plus, Link, MessageSquare\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Input } from \"@/components/ui/input\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/components/ui/collapsible\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from \"@/components/ui/alert-dialog\";\nimport type { LeadActivity, LeadTask, User as UserType } from \"@shared/schema\";\n\ninterface CallLogEntryProps {\n  activity: LeadActivity;\n  users: UserType[];\n  leadId: string;\n  onCreateTask?: (activityId: string) => void;\n}\n\nconst callDirectionConfig = {\n  inbound: {\n    icon: PhoneIncoming,\n    label: \"Inbound Call\",\n    badgeClass: \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\",\n  },\n  outbound: {\n    icon: PhoneOutgoing,\n    label: \"Outbound Call\",\n    badgeClass: \"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200\",\n  },\n  missed: {\n    icon: PhoneMissed,\n    label: \"Missed Call\",\n    badgeClass: \"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200\",\n  },\n};\n\nconst transcriptionStatusConfig: Record<string, { label: string; className: string }> = {\n  not_applicable: { label: \"No Recording\", className: \"text-muted-foreground\" },\n  pending: { label: \"Processing...\", className: \"text-yellow-600\" },\n  in_progress: { label: \"Transcribing...\", className: \"text-blue-600\" },\n  completed: { label: \"Transcribed\", className: \"text-green-600\" },\n  failed: { label: \"Failed\", className: \"text-red-600\" },\n};\n\nfunction formatDuration(seconds: number | null | undefined): string {\n  if (!seconds) return \"N/A\";\n  const mins = Math.floor(seconds / 60);\n  const secs = seconds % 60;\n  if (mins === 0) return `${secs}s`;\n  return `${mins}m ${secs}s`;\n}\n\nexport function CallLogEntry({ activity, users, leadId, onCreateTask }: CallLogEntryProps) {\n  const { toast } = useToast();\n  const [isExpanded, setIsExpanded] = useState(false);\n  const [isEditing, setIsEditing] = useState(false);\n  const [editedNotes, setEditedNotes] = useState(activity.callNotes || \"\");\n  const [showTaskForm, setShowTaskForm] = useState(false);\n  const [taskTitle, setTaskTitle] = useState(\"\");\n  const [taskPriority, setTaskPriority] = useState(\"medium\");\n  const [taskAssignee, setTaskAssignee] = useState(\"\");\n\n  const direction = (activity.callDirection || \"outbound\") as keyof typeof callDirectionConfig;\n  const config = callDirectionConfig[direction];\n  const DirectionIcon = config.icon;\n\n  const staffMember = users.find(u => u.id === activity.staffMemberId);\n  const transcriptionStatus = activity.transcriptionStatus || \"not_applicable\";\n  const transcriptionConfig = transcriptionStatusConfig[transcriptionStatus];\n\n  const { data: linkedTasks = [] } = useQuery<LeadTask[]>({\n    queryKey: [\"/api/lead-activities\", activity.id, \"tasks\"],\n    enabled: isExpanded,\n  });\n\n  const updateActivityMutation = useMutation({\n    mutationFn: async (data: Partial<LeadActivity>) => {\n      return apiRequest(\"PATCH\", `/api/lead-activities/${activity.id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leads\", leadId, \"activities\"] });\n      setIsEditing(false);\n      toast({ title: \"Call notes updated\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to update notes\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteActivityMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"DELETE\", `/api/lead-activities/${activity.id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leads\", leadId, \"activities\"] });\n      toast({ title: \"Call log deleted\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to delete call log\", variant: \"destructive\" });\n    },\n  });\n\n  const createTaskMutation = useMutation({\n    mutationFn: async (data: { title: string; priority: string; assignedTo?: string; sourceActivityId: string }) => {\n      return apiRequest(\"POST\", `/api/leads/${leadId}/tasks`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leads\", leadId, \"tasks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/lead-activities\", activity.id, \"tasks\"] });\n      toast({ title: \"Task created and linked to call\" });\n      setShowTaskForm(false);\n      setTaskTitle(\"\");\n      setTaskPriority(\"medium\");\n      setTaskAssignee(\"\");\n    },\n    onError: () => {\n      toast({ title: \"Failed to create task\", variant: \"destructive\" });\n    },\n  });\n\n  const handleSaveNotes = () => {\n    updateActivityMutation.mutate({ callNotes: editedNotes });\n  };\n\n  const handleCreateTask = () => {\n    if (!taskTitle.trim()) return;\n    createTaskMutation.mutate({\n      title: taskTitle.trim(),\n      priority: taskPriority,\n      sourceActivityId: activity.id,\n      assignedTo: taskAssignee && taskAssignee !== \"unassigned\" ? taskAssignee : undefined,\n    });\n  };\n\n  const hasDetails = activity.callNotes || activity.callTranscriptionText || activity.aiSummaryText || activity.audioRecordingUrl;\n\n  return (\n    <Card \n      className=\"overflow-hidden\"\n      data-testid={`call-log-entry-${activity.id}`}\n    >\n      <Collapsible open={isExpanded} onOpenChange={setIsExpanded}>\n        <div className=\"p-3\">\n          <div className=\"flex items-start gap-3\">\n            <div className={`p-2 rounded-full ${config.badgeClass}`}>\n              <DirectionIcon className=\"h-4 w-4\" />\n            </div>\n            \n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex items-center gap-2 flex-wrap\">\n                <span className=\"font-medium\">{config.label}</span>\n                <Badge variant=\"outline\" className=\"text-xs\">\n                  <Clock className=\"h-3 w-3 mr-1\" />\n                  {formatDuration(activity.callDurationSeconds)}\n                </Badge>\n                {linkedTasks.length > 0 && (\n                  <Badge variant=\"secondary\" className=\"text-xs\">\n                    <Link className=\"h-3 w-3 mr-1\" />\n                    {linkedTasks.length} task{linkedTasks.length > 1 ? \"s\" : \"\"}\n                  </Badge>\n                )}\n              </div>\n              \n              <div className=\"flex items-center gap-2 mt-1 text-sm text-muted-foreground flex-wrap\">\n                {staffMember && (\n                  <span className=\"flex items-center gap-1\">\n                    <User className=\"h-3 w-3\" />\n                    {staffMember.firstName} {staffMember.lastName}\n                  </span>\n                )}\n                {activity.callTimestamp && (\n                  <span>\n                    {format(new Date(activity.callTimestamp), \"dd/MM/yyyy HH:mm\")}\n                  </span>\n                )}\n                <span className=\"text-xs\">\n                  ({formatDistanceToNow(new Date(activity.callTimestamp || activity.createdAt!), { addSuffix: true })})\n                </span>\n              </div>\n\n              {activity.title && activity.title !== config.label && (\n                <p className=\"text-sm mt-1\">{activity.title}</p>\n              )}\n            </div>\n\n            <div className=\"flex items-center gap-1\">\n              <CollapsibleTrigger asChild>\n                <Button \n                  variant=\"ghost\" \n                  size=\"icon\"\n                  data-testid={`button-expand-call-${activity.id}`}\n                >\n                  {isExpanded ? (\n                    <ChevronUp className=\"h-4 w-4\" />\n                  ) : (\n                    <ChevronDown className=\"h-4 w-4\" />\n                  )}\n                </Button>\n              </CollapsibleTrigger>\n              \n              <AlertDialog>\n                <AlertDialogTrigger asChild>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    className=\"text-destructive\"\n                    data-testid={`button-delete-call-${activity.id}`}\n                  >\n                    <Trash2 className=\"h-4 w-4\" />\n                  </Button>\n                </AlertDialogTrigger>\n                <AlertDialogContent>\n                  <AlertDialogHeader>\n                    <AlertDialogTitle>Delete Call Log</AlertDialogTitle>\n                    <AlertDialogDescription>\n                      Are you sure you want to delete this call log? This action cannot be undone.\n                      {linkedTasks.length > 0 && (\n                        <span className=\"block mt-2 text-amber-600\">\n                          Note: {linkedTasks.length} linked task(s) will be unlinked from this call.\n                        </span>\n                      )}\n                    </AlertDialogDescription>\n                  </AlertDialogHeader>\n                  <AlertDialogFooter>\n                    <AlertDialogCancel>Cancel</AlertDialogCancel>\n                    <AlertDialogAction\n                      onClick={() => deleteActivityMutation.mutate()}\n                      className=\"bg-destructive text-destructive-foreground\"\n                    >\n                      Delete\n                    </AlertDialogAction>\n                  </AlertDialogFooter>\n                </AlertDialogContent>\n              </AlertDialog>\n            </div>\n          </div>\n        </div>\n\n        <CollapsibleContent>\n          <Separator />\n          <div className=\"p-3 space-y-3 bg-muted/30\">\n            {activity.callNotes && !isEditing && (\n              <div>\n                <div className=\"flex items-center justify-between mb-1\">\n                  <span className=\"text-xs font-medium text-muted-foreground uppercase\">Call Notes</span>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => {\n                      setEditedNotes(activity.callNotes || \"\");\n                      setIsEditing(true);\n                    }}\n                    data-testid={`button-edit-notes-${activity.id}`}\n                  >\n                    <Edit2 className=\"h-3 w-3 mr-1\" />\n                    Edit\n                  </Button>\n                </div>\n                <p className=\"text-sm whitespace-pre-wrap\">{activity.callNotes}</p>\n              </div>\n            )}\n\n            {isEditing && (\n              <div>\n                <span className=\"text-xs font-medium text-muted-foreground uppercase block mb-1\">Edit Call Notes</span>\n                <Textarea\n                  value={editedNotes}\n                  onChange={(e) => setEditedNotes(e.target.value)}\n                  className=\"min-h-[80px] mb-2\"\n                  data-testid={`input-edit-notes-${activity.id}`}\n                />\n                <div className=\"flex gap-2\">\n                  <Button\n                    size=\"sm\"\n                    onClick={handleSaveNotes}\n                    disabled={updateActivityMutation.isPending}\n                    data-testid={`button-save-notes-${activity.id}`}\n                  >\n                    Save\n                  </Button>\n                  <Button\n                    size=\"sm\"\n                    variant=\"outline\"\n                    onClick={() => setIsEditing(false)}\n                  >\n                    Cancel\n                  </Button>\n                </div>\n              </div>\n            )}\n\n            {!activity.callNotes && !isEditing && (\n              <div>\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setIsEditing(true)}\n                  data-testid={`button-add-notes-${activity.id}`}\n                >\n                  <MessageSquare className=\"h-3 w-3 mr-1\" />\n                  Add Notes\n                </Button>\n              </div>\n            )}\n\n            {activity.aiSummaryText && (\n              <div>\n                <span className=\"text-xs font-medium text-muted-foreground uppercase block mb-1\">AI Summary</span>\n                <div className=\"p-2 bg-blue-50 dark:bg-blue-950 rounded text-sm\">\n                  {activity.aiSummaryText}\n                </div>\n              </div>\n            )}\n\n            {activity.callTranscriptionText && (\n              <div>\n                <div className=\"flex items-center justify-between mb-1\">\n                  <span className=\"text-xs font-medium text-muted-foreground uppercase\">Transcription</span>\n                  <span className={`text-xs ${transcriptionConfig.className}`}>\n                    {transcriptionConfig.label}\n                  </span>\n                </div>\n                <div className=\"p-2 bg-background rounded border text-sm max-h-[200px] overflow-y-auto\">\n                  <pre className=\"whitespace-pre-wrap font-sans\">{activity.callTranscriptionText}</pre>\n                </div>\n              </div>\n            )}\n\n            {activity.audioRecordingUrl && (\n              <div>\n                <span className=\"text-xs font-medium text-muted-foreground uppercase block mb-1\">Recording</span>\n                <audio controls className=\"w-full h-8\">\n                  <source src={activity.audioRecordingUrl} type=\"audio/mpeg\" />\n                  Your browser does not support audio playback.\n                </audio>\n              </div>\n            )}\n\n            {linkedTasks.length > 0 && (\n              <div>\n                <span className=\"text-xs font-medium text-muted-foreground uppercase block mb-1\">Linked Tasks</span>\n                <div className=\"space-y-1\">\n                  {linkedTasks.map((task) => (\n                    <div\n                      key={task.id}\n                      className=\"flex items-center gap-2 p-2 bg-background rounded border text-sm\"\n                    >\n                      <Link className=\"h-3 w-3 text-muted-foreground\" />\n                      <span className={task.status === \"completed\" ? \"line-through text-muted-foreground\" : \"\"}>\n                        {task.title}\n                      </span>\n                      <Badge variant={task.status === \"completed\" ? \"secondary\" : \"outline\"} className=\"text-xs ml-auto\">\n                        {task.status}\n                      </Badge>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n\n            {showTaskForm ? (\n              <div className=\"space-y-2 p-3 bg-muted/50 rounded-lg border\">\n                <span className=\"text-xs font-medium text-muted-foreground uppercase block\">Create Task from Call</span>\n                <Input\n                  placeholder=\"Task title...\"\n                  value={taskTitle}\n                  onChange={(e) => setTaskTitle(e.target.value)}\n                  data-testid={`input-task-title-${activity.id}`}\n                  autoFocus\n                />\n                <div className=\"flex gap-2 flex-wrap\">\n                  <Select value={taskPriority} onValueChange={setTaskPriority}>\n                    <SelectTrigger className=\"w-[120px]\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"low\">Low</SelectItem>\n                      <SelectItem value=\"medium\">Medium</SelectItem>\n                      <SelectItem value=\"high\">High</SelectItem>\n                      <SelectItem value=\"urgent\">Urgent</SelectItem>\n                    </SelectContent>\n                  </Select>\n                  <Select value={taskAssignee} onValueChange={setTaskAssignee}>\n                    <SelectTrigger className=\"w-[160px]\" data-testid={`select-task-assignee-${activity.id}`}>\n                      <SelectValue placeholder=\"Assign to...\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"unassigned\">Unassigned</SelectItem>\n                      {users.map((user) => (\n                        <SelectItem key={user.id} value={user.id}>\n                          {user.firstName} {user.lastName}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div className=\"flex gap-2\">\n                  <Button\n                    size=\"sm\"\n                    onClick={handleCreateTask}\n                    disabled={!taskTitle.trim() || createTaskMutation.isPending}\n                    data-testid={`button-submit-task-${activity.id}`}\n                  >\n                    {createTaskMutation.isPending ? \"Creating...\" : \"Create Task\"}\n                  </Button>\n                  <Button\n                    size=\"sm\"\n                    variant=\"outline\"\n                    onClick={() => {\n                      setShowTaskForm(false);\n                      setTaskTitle(\"\");\n                      setTaskAssignee(\"\");\n                    }}\n                  >\n                    Cancel\n                  </Button>\n                </div>\n              </div>\n            ) : (\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => setShowTaskForm(true)}\n                data-testid={`button-create-task-from-call-${activity.id}`}\n              >\n                <Plus className=\"h-3 w-3 mr-1\" />\n                Create Task from Call\n              </Button>\n            )}\n          </div>\n        </CollapsibleContent>\n      </Collapsible>\n    </Card>\n  );\n}\n","path":null,"size_bytes":18253,"size_tokens":null},"client/src/pages/LiveDocTemplates.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { FileText, Plus, Pencil, Trash2, Star, Check, Search, Eye, MapPin, Package, Wrench, Calendar, ClipboardCheck, ChevronRight } from \"lucide-react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n  FormDescription,\n} from \"@/components/ui/form\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  Accordion,\n  AccordionContent,\n  AccordionItem,\n  AccordionTrigger,\n} from \"@/components/ui/accordion\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { LiveDocumentTemplate, TemplateSectionConfig, JobSetupSection1Sales, JobSetupSection3Production, JobSetupSection4Schedule, JobSetupSection5Install } from \"@shared/schema\";\n\nconst templateFormSchema = z.object({\n  name: z.string().min(1, \"Template name is required\"),\n  description: z.string().optional(),\n  isActive: z.boolean().default(true),\n  isDefault: z.boolean().default(false),\n});\n\ntype TemplateFormValues = z.infer<typeof templateFormSchema>;\n\nconst sectionIcons = {\n  1: MapPin,\n  2: Package,\n  3: Wrench,\n  4: Calendar,\n  5: ClipboardCheck,\n};\n\nconst sectionTitles = {\n  1: \"Sales & Site Info\",\n  2: \"Products / BOM\",\n  3: \"Production Notes\",\n  4: \"Scheduling\",\n  5: \"Install Notes & Sign-off\",\n};\n\nfunction SectionConfigDisplay({ \n  sectionNumber, \n  config, \n  defaults \n}: { \n  sectionNumber: number; \n  config?: TemplateSectionConfig | null;\n  defaults?: JobSetupSection1Sales | JobSetupSection3Production | JobSetupSection4Schedule | JobSetupSection5Install | Record<string, unknown> | null;\n}) {\n  const Icon = sectionIcons[sectionNumber as keyof typeof sectionIcons];\n  const defaultTitle = sectionTitles[sectionNumber as keyof typeof sectionTitles];\n  \n  const title = config?.title || defaultTitle;\n  const description = config?.description;\n  const requiredFields = config?.requiredBeforeComplete || [];\n\n  const renderDefaults = () => {\n    if (!defaults || Object.keys(defaults).length === 0) {\n      return <p className=\"text-sm text-muted-foreground italic\">No default values configured</p>;\n    }\n\n    const entries = Object.entries(defaults);\n    \n    return (\n      <div className=\"grid grid-cols-2 gap-2\">\n        {entries.map(([key, value]) => {\n          const displayKey = key\n            .replace(/([A-Z])/g, ' $1')\n            .replace(/^./, str => str.toUpperCase())\n            .trim();\n          \n          let displayValue: string;\n          if (typeof value === 'boolean') {\n            displayValue = value ? 'Yes' : 'No';\n          } else if (value === null || value === undefined) {\n            displayValue = '-';\n          } else {\n            displayValue = String(value);\n          }\n          \n          return (\n            <div key={key} className=\"flex items-center justify-between text-sm p-2 bg-muted/50 rounded\">\n              <span className=\"text-muted-foreground truncate flex-1\">{displayKey}</span>\n              <Badge variant={typeof value === 'boolean' ? (value ? 'default' : 'secondary') : 'outline'} className=\"ml-2 shrink-0\">\n                {displayValue}\n              </Badge>\n            </div>\n          );\n        })}\n      </div>\n    );\n  };\n\n  return (\n    <AccordionItem value={`section-${sectionNumber}`} className=\"border rounded-lg px-4 mb-2\">\n      <AccordionTrigger className=\"hover:no-underline py-3\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"p-2 rounded-full bg-primary/10\">\n            <Icon className=\"h-4 w-4 text-primary\" />\n          </div>\n          <div className=\"text-left\">\n            <p className=\"font-medium\">Section {sectionNumber}: {title}</p>\n            {description && (\n              <p className=\"text-xs text-muted-foreground font-normal\">{description}</p>\n            )}\n          </div>\n        </div>\n      </AccordionTrigger>\n      <AccordionContent className=\"pb-4\">\n        <div className=\"space-y-4 pt-2\">\n          {requiredFields.length > 0 && (\n            <div>\n              <p className=\"text-sm font-medium mb-2\">Required fields before completion:</p>\n              <div className=\"flex flex-wrap gap-1\">\n                {requiredFields.map((field) => (\n                  <Badge key={field} variant=\"outline\" className=\"text-xs\">\n                    {field.replace(/([A-Z])/g, ' $1').trim()}\n                  </Badge>\n                ))}\n              </div>\n            </div>\n          )}\n          \n          <div>\n            <p className=\"text-sm font-medium mb-2\">Default Values:</p>\n            {renderDefaults()}\n          </div>\n        </div>\n      </AccordionContent>\n    </AccordionItem>\n  );\n}\n\nfunction TemplateDetailDialog({ template, open, onOpenChange }: { \n  template: LiveDocumentTemplate; \n  open: boolean; \n  onOpenChange: (open: boolean) => void;\n}) {\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-3xl max-h-[90vh]\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <FileText className=\"h-5 w-5 text-primary\" />\n            {template.name}\n            {template.isDefault && (\n              <Star className=\"h-4 w-4 fill-yellow-400 text-yellow-400\" />\n            )}\n          </DialogTitle>\n          <DialogDescription>\n            {template.description || \"Template configuration and default values for each section\"}\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"flex items-center gap-2 mb-4\">\n          <Badge variant=\"outline\">Job Setup & Handover</Badge>\n          {template.isActive ? (\n            <Badge variant=\"default\" className=\"bg-green-600\">\n              <Check className=\"h-3 w-3 mr-1\" />\n              Active\n            </Badge>\n          ) : (\n            <Badge variant=\"secondary\">Inactive</Badge>\n          )}\n          {template.isDefault && (\n            <Badge variant=\"secondary\" className=\"bg-yellow-100 text-yellow-800 border-yellow-300\">\n              Default\n            </Badge>\n          )}\n        </div>\n\n        <ScrollArea className=\"h-[60vh] pr-4\">\n          <Accordion type=\"multiple\" defaultValue={[\"section-1\"]} className=\"w-full\">\n            <SectionConfigDisplay \n              sectionNumber={1} \n              config={template.section1Config} \n              defaults={template.section1Defaults}\n            />\n            <SectionConfigDisplay \n              sectionNumber={2} \n              config={template.section2Config} \n              defaults={template.section2Defaults}\n            />\n            <SectionConfigDisplay \n              sectionNumber={3} \n              config={template.section3Config} \n              defaults={template.section3Defaults}\n            />\n            <SectionConfigDisplay \n              sectionNumber={4} \n              config={template.section4Config} \n              defaults={template.section4Defaults}\n            />\n            <SectionConfigDisplay \n              sectionNumber={5} \n              config={template.section5Config} \n              defaults={template.section5Defaults}\n            />\n          </Accordion>\n        </ScrollArea>\n\n        <DialogFooter>\n          <Button variant=\"outline\" onClick={() => onOpenChange(false)}>\n            Close\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nexport default function LiveDocTemplates() {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [editingTemplate, setEditingTemplate] = useState<LiveDocumentTemplate | null>(null);\n  const [deletingTemplate, setDeletingTemplate] = useState<LiveDocumentTemplate | null>(null);\n  const [viewingTemplate, setViewingTemplate] = useState<LiveDocumentTemplate | null>(null);\n\n  const { data: templates = [], isLoading } = useQuery<LiveDocumentTemplate[]>({\n    queryKey: ['/api/live-doc-templates'],\n  });\n\n  const form = useForm<TemplateFormValues>({\n    resolver: zodResolver(templateFormSchema),\n    defaultValues: {\n      name: \"\",\n      description: \"\",\n      isActive: true,\n      isDefault: false,\n    },\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: TemplateFormValues) => {\n      return apiRequest('POST', '/api/live-doc-templates', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/live-doc-templates'] });\n      setIsCreateDialogOpen(false);\n      form.reset();\n      toast({ title: \"Template created successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to create template\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: TemplateFormValues }) => {\n      return apiRequest('PATCH', `/api/live-doc-templates/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/live-doc-templates'] });\n      setEditingTemplate(null);\n      form.reset();\n      toast({ title: \"Template updated successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to update template\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest('DELETE', `/api/live-doc-templates/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/live-doc-templates'] });\n      setDeletingTemplate(null);\n      toast({ title: \"Template deleted successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to delete template\", variant: \"destructive\" });\n    },\n  });\n\n  const handleCreateSubmit = (data: TemplateFormValues) => {\n    createMutation.mutate(data);\n  };\n\n  const handleEditSubmit = (data: TemplateFormValues) => {\n    if (editingTemplate) {\n      updateMutation.mutate({ id: editingTemplate.id, data });\n    }\n  };\n\n  const openEditDialog = (template: LiveDocumentTemplate) => {\n    setEditingTemplate(template);\n    form.reset({\n      name: template.name,\n      description: template.description || \"\",\n      isActive: template.isActive ?? true,\n      isDefault: template.isDefault ?? false,\n    });\n  };\n\n  const filteredTemplates = templates.filter(template =>\n    template.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    template.description?.toLowerCase().includes(searchQuery.toLowerCase())\n  );\n\n  const TemplateFormContent = ({ onSubmit, isPending }: { onSubmit: (data: TemplateFormValues) => void; isPending: boolean }) => (\n    <Form {...form}>\n      <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n        <FormField\n          control={form.control}\n          name=\"name\"\n          render={({ field }) => (\n            <FormItem>\n              <FormLabel>Template Name</FormLabel>\n              <FormControl>\n                <Input {...field} placeholder=\"e.g. Standard Job Setup\" data-testid=\"input-template-name\" />\n              </FormControl>\n              <FormMessage />\n            </FormItem>\n          )}\n        />\n        <FormField\n          control={form.control}\n          name=\"description\"\n          render={({ field }) => (\n            <FormItem>\n              <FormLabel>Description</FormLabel>\n              <FormControl>\n                <Textarea {...field} placeholder=\"Describe what this template is used for...\" data-testid=\"input-template-description\" />\n              </FormControl>\n              <FormMessage />\n            </FormItem>\n          )}\n        />\n        <FormField\n          control={form.control}\n          name=\"isActive\"\n          render={({ field }) => (\n            <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-3\">\n              <div className=\"space-y-0.5\">\n                <FormLabel>Active</FormLabel>\n                <FormDescription className=\"text-xs\">\n                  Active templates can be used for new documents\n                </FormDescription>\n              </div>\n              <FormControl>\n                <Switch\n                  checked={field.value}\n                  onCheckedChange={field.onChange}\n                  data-testid=\"switch-template-active\"\n                />\n              </FormControl>\n            </FormItem>\n          )}\n        />\n        <FormField\n          control={form.control}\n          name=\"isDefault\"\n          render={({ field }) => (\n            <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-3\">\n              <div className=\"space-y-0.5\">\n                <FormLabel>Default Template</FormLabel>\n                <FormDescription className=\"text-xs\">\n                  Set as the default template for new documents\n                </FormDescription>\n              </div>\n              <FormControl>\n                <Switch\n                  checked={field.value}\n                  onCheckedChange={field.onChange}\n                  data-testid=\"switch-template-default\"\n                />\n              </FormControl>\n            </FormItem>\n          )}\n        />\n        <DialogFooter>\n          <Button type=\"submit\" disabled={isPending} data-testid=\"button-submit-template\">\n            {isPending ? \"Saving...\" : editingTemplate ? \"Update Template\" : \"Create Template\"}\n          </Button>\n        </DialogFooter>\n      </form>\n    </Form>\n  );\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-semibold text-foreground\" data-testid=\"text-page-title\">Live Document Templates</h1>\n          <p className=\"text-muted-foreground\">Manage reusable templates for job setup and handover documents</p>\n        </div>\n        <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-template\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              New Template\n            </Button>\n          </DialogTrigger>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Create Template</DialogTitle>\n              <DialogDescription>Create a new template for live documents.</DialogDescription>\n            </DialogHeader>\n            <TemplateFormContent onSubmit={handleCreateSubmit} isPending={createMutation.isPending} />\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <div className=\"flex items-center gap-4\">\n        <div className=\"relative flex-1 max-w-sm\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search templates...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-10\"\n            data-testid=\"input-search-templates\"\n          />\n        </div>\n      </div>\n\n      {isLoading ? (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {[...Array(3)].map((_, i) => (\n            <Card key={i} className=\"animate-pulse\">\n              <CardHeader>\n                <div className=\"h-5 bg-muted rounded w-3/4\" />\n                <div className=\"h-4 bg-muted rounded w-1/2 mt-2\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"h-4 bg-muted rounded w-full\" />\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      ) : filteredTemplates.length === 0 ? (\n        <Card>\n          <CardContent className=\"flex flex-col items-center justify-center py-12\">\n            <FileText className=\"h-12 w-12 text-muted-foreground mb-4\" />\n            <h3 className=\"text-lg font-medium text-foreground mb-2\">No templates found</h3>\n            <p className=\"text-muted-foreground text-sm mb-4\">\n              {searchQuery ? \"Try a different search term\" : \"Create your first template to get started\"}\n            </p>\n            {!searchQuery && (\n              <Button onClick={() => setIsCreateDialogOpen(true)} data-testid=\"button-create-first-template\">\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Create Template\n              </Button>\n            )}\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {filteredTemplates.map((template) => (\n            <Card \n              key={template.id} \n              className=\"hover-elevate cursor-pointer\" \n              data-testid={`card-template-${template.id}`}\n              onClick={() => setViewingTemplate(template)}\n            >\n              <CardHeader className=\"pb-2\">\n                <div className=\"flex items-start justify-between gap-2\">\n                  <div className=\"flex-1\">\n                    <CardTitle className=\"text-base flex items-center gap-2\">\n                      <FileText className=\"h-4 w-4 text-primary\" />\n                      {template.name}\n                      {template.isDefault && (\n                        <Star className=\"h-4 w-4 fill-yellow-400 text-yellow-400\" />\n                      )}\n                    </CardTitle>\n                    {template.description && (\n                      <CardDescription className=\"mt-1 line-clamp-2\">{template.description}</CardDescription>\n                    )}\n                  </div>\n                  <div className=\"flex items-center gap-1\" onClick={(e) => e.stopPropagation()}>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      onClick={() => setViewingTemplate(template)}\n                      data-testid={`button-view-template-${template.id}`}\n                    >\n                      <Eye className=\"h-4 w-4\" />\n                    </Button>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      onClick={() => openEditDialog(template)}\n                      data-testid={`button-edit-template-${template.id}`}\n                    >\n                      <Pencil className=\"h-4 w-4\" />\n                    </Button>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      onClick={() => setDeletingTemplate(template)}\n                      data-testid={`button-delete-template-${template.id}`}\n                    >\n                      <Trash2 className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"flex items-center gap-2 flex-wrap mb-3\">\n                  <Badge variant=\"outline\">\n                    Job Setup & Handover\n                  </Badge>\n                  {template.isActive ? (\n                    <Badge variant=\"default\" className=\"bg-green-600\">\n                      <Check className=\"h-3 w-3 mr-1\" />\n                      Active\n                    </Badge>\n                  ) : (\n                    <Badge variant=\"secondary\">Inactive</Badge>\n                  )}\n                  {template.isDefault && (\n                    <Badge variant=\"secondary\" className=\"bg-yellow-100 text-yellow-800 border-yellow-300\">\n                      Default\n                    </Badge>\n                  )}\n                </div>\n                \n                <Separator className=\"my-3\" />\n                \n                <div className=\"space-y-1\">\n                  <p className=\"text-xs text-muted-foreground font-medium mb-2\">5 Sections:</p>\n                  <div className=\"grid grid-cols-1 gap-1\">\n                    {[1, 2, 3, 4, 5].map((num) => {\n                      const Icon = sectionIcons[num as keyof typeof sectionIcons];\n                      const title = sectionTitles[num as keyof typeof sectionTitles];\n                      return (\n                        <div key={num} className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                          <Icon className=\"h-3 w-3\" />\n                          <span>{title}</span>\n                        </div>\n                      );\n                    })}\n                  </div>\n                </div>\n                \n                <div className=\"flex items-center justify-end mt-3 text-xs text-primary\">\n                  <span>Click to view details</span>\n                  <ChevronRight className=\"h-3 w-3 ml-1\" />\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n\n      {viewingTemplate && (\n        <TemplateDetailDialog \n          template={viewingTemplate} \n          open={!!viewingTemplate} \n          onOpenChange={(open) => !open && setViewingTemplate(null)}\n        />\n      )}\n\n      <Dialog open={!!editingTemplate} onOpenChange={(open) => !open && setEditingTemplate(null)}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Edit Template</DialogTitle>\n            <DialogDescription>Update the template details.</DialogDescription>\n          </DialogHeader>\n          <TemplateFormContent onSubmit={handleEditSubmit} isPending={updateMutation.isPending} />\n        </DialogContent>\n      </Dialog>\n\n      <AlertDialog open={!!deletingTemplate} onOpenChange={(open) => !open && setDeletingTemplate(null)}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Delete Template</AlertDialogTitle>\n            <AlertDialogDescription>\n              Are you sure you want to delete \"{deletingTemplate?.name}\"? This action cannot be undone.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-delete\">Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => deletingTemplate && deleteMutation.mutate(deletingTemplate.id)}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              data-testid=\"button-confirm-delete\"\n            >\n              Delete\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":23265,"size_tokens":null},"client/src/components/leads/LeadDetailDialog.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { format } from \"date-fns\";\nimport { \n  Phone, Mail, MapPin, FileText, Edit, Plus, Clock, Calendar, \n  CheckCircle2, CircleDashed, MessageSquare, PhoneCall, Send,\n  ChevronRight, ClipboardList, AlertCircle, User, PhoneIncoming, PhoneOutgoing, PhoneMissed, Star\n} from \"lucide-react\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n} from \"@/components/ui/dialog\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { JobSetupDocument } from \"@/components/jobs/JobSetupDocument\";\nimport { CallLogEntry } from \"./CallLogEntry\";\nimport { SitePreview } from \"@/components/ui/address-autocomplete\";\nimport type { Lead, Client, Quote, LeadActivity, LeadTask, User as UserType, LiveDocumentTemplate, JobSetupDocument as JobSetupDocumentType } from \"@shared/schema\";\n\ninterface LeadDetailDialogProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  lead: Lead | null;\n  client: Client | null;\n  quotes: Quote[];\n  users: UserType[];\n  onEditLead: () => void;\n  onCreateQuote: () => void;\n  onViewQuote: (quote: Quote) => void;\n  initialTab?: string;\n  highlightedTaskId?: string;\n}\n\nconst activityTypeLabels: Record<string, { label: string; icon: typeof MessageSquare }> = {\n  call_logged: { label: \"Call Logged\", icon: PhoneCall },\n  call_missed: { label: \"Missed Call\", icon: PhoneCall },\n  note_added: { label: \"Note Added\", icon: MessageSquare },\n  email_sent: { label: \"Email Sent\", icon: Send },\n  sms_sent: { label: \"SMS Sent\", icon: MessageSquare },\n  quote_created: { label: \"Quote Created\", icon: FileText },\n  quote_sent: { label: \"Quote Sent\", icon: Send },\n  quote_approved: { label: \"Quote Approved\", icon: CheckCircle2 },\n  lead_created: { label: \"Lead Created\", icon: Plus },\n  stage_changed: { label: \"Stage Changed\", icon: ChevronRight },\n};\n\nconst priorityColors: Record<string, string> = {\n  low: \"bg-slate-100 text-slate-700\",\n  medium: \"bg-blue-100 text-blue-700\",\n  high: \"bg-orange-100 text-orange-700\",\n  urgent: \"bg-red-100 text-red-700\",\n};\n\nfunction formatCurrency(amount: string | number | null | undefined): string {\n  if (!amount) return \"$0.00\";\n  const num = typeof amount === \"string\" ? parseFloat(amount) : amount;\n  return new Intl.NumberFormat(\"en-AU\", {\n    style: \"currency\",\n    currency: \"AUD\",\n  }).format(num);\n}\n\nexport function LeadDetailDialog({\n  open,\n  onOpenChange,\n  lead,\n  client,\n  quotes,\n  users,\n  onEditLead,\n  onCreateQuote,\n  onViewQuote,\n  initialTab,\n  highlightedTaskId,\n}: LeadDetailDialogProps) {\n  const { toast } = useToast();\n  const [activeTab, setActiveTab] = useState(initialTab || \"details\");\n  const [focusedTaskId, setFocusedTaskId] = useState<string | undefined>(highlightedTaskId);\n  \n  // Reset to initialTab when dialog opens with a specific tab\n  useEffect(() => {\n    if (open && initialTab) {\n      setActiveTab(initialTab);\n    }\n    if (open && highlightedTaskId) {\n      setFocusedTaskId(highlightedTaskId);\n      // Scroll to the task after a short delay to allow rendering\n      setTimeout(() => {\n        const taskElement = document.querySelector(`[data-task-id=\"${highlightedTaskId}\"]`);\n        if (taskElement) {\n          taskElement.scrollIntoView({ behavior: \"smooth\", block: \"center\" });\n        }\n      }, 100);\n    }\n  }, [open, initialTab, highlightedTaskId]);\n  \n  // Clear the focused task after a few seconds\n  useEffect(() => {\n    if (focusedTaskId) {\n      const timer = setTimeout(() => setFocusedTaskId(undefined), 5000);\n      return () => clearTimeout(timer);\n    }\n  }, [focusedTaskId]);\n  const [newNote, setNewNote] = useState(\"\");\n  const [newTaskTitle, setNewTaskTitle] = useState(\"\");\n  const [newTaskPriority, setNewTaskPriority] = useState<string>(\"medium\");\n  const [selectedTemplateId, setSelectedTemplateId] = useState<string>(\"\");\n  \n  const [showLogCallForm, setShowLogCallForm] = useState(false);\n  const [callDirection, setCallDirection] = useState<string>(\"outbound\");\n  const [callDuration, setCallDuration] = useState<string>(\"\");\n  const [callNotes, setCallNotes] = useState(\"\");\n  const [linkingTaskToCallId, setLinkingTaskToCallId] = useState<string | null>(null);\n  const [newTaskAssignee, setNewTaskAssignee] = useState<string>(\"\");\n\n  const { data: activities = [] } = useQuery<LeadActivity[]>({\n    queryKey: [\"/api/leads\", lead?.id, \"activities\"],\n    enabled: !!lead?.id && open,\n  });\n\n  const { data: tasks = [] } = useQuery<LeadTask[]>({\n    queryKey: [\"/api/leads\", lead?.id, \"tasks\"],\n    enabled: !!lead?.id && open,\n  });\n\n  const { data: templates = [] } = useQuery<LiveDocumentTemplate[]>({\n    queryKey: [\"/api/live-doc-templates\"],\n    enabled: open,\n  });\n\n  const { data: existingDocument } = useQuery<JobSetupDocumentType>({\n    queryKey: [\"/api/leads\", lead?.id, \"live-document\"],\n    enabled: !!lead?.id && open && lead?.jobFulfillmentType === \"supply_install\",\n  });\n\n  const updateLeadMutation = useMutation({\n    mutationFn: async (data: Partial<Lead>) => {\n      return apiRequest(\"PATCH\", `/api/leads/${lead?.id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leads\"] });\n      toast({ title: \"Lead updated successfully\" });\n    },\n    onError: (error) => {\n      console.error(\"Error updating lead:\", error);\n      toast({ title: \"Failed to update lead\", variant: \"destructive\" });\n    },\n  });\n\n  const updateQuoteMutation = useMutation({\n    mutationFn: async ({ quoteId, data }: { quoteId: string; data: { status: string } }) => {\n      return apiRequest(\"PATCH\", `/api/quotes/${quoteId}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/quotes\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/leads\"] });\n      toast({ title: \"Quote updated successfully\" });\n    },\n    onError: (error) => {\n      console.error(\"Error updating quote:\", error);\n      toast({ title: \"Failed to update quote\", variant: \"destructive\" });\n    },\n  });\n\n  const convertToJobMutation = useMutation({\n    mutationFn: async ({ quoteId, jobType }: { quoteId: string; jobType: string }) => {\n      return apiRequest(\"POST\", `/api/quotes/${quoteId}/accept`, { jobType });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/quotes\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/leads\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/jobs\"] });\n      toast({ title: \"Quote accepted and job created!\" });\n      onOpenChange(false);\n    },\n    onError: (error) => {\n      console.error(\"Error converting to job:\", error);\n      toast({ title: \"Failed to create job\", variant: \"destructive\" });\n    },\n  });\n\n  const setPrimaryQuoteMutation = useMutation({\n    mutationFn: async (quoteId: string) => {\n      return apiRequest(\"POST\", `/api/quotes/${quoteId}/set-primary`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/quotes\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/leads\"] });\n      toast({ title: \"Quote set as primary. Opportunity value updated.\" });\n    },\n    onError: (error) => {\n      console.error(\"Error setting primary quote:\", error);\n      toast({ title: \"Failed to set primary quote\", variant: \"destructive\" });\n    },\n  });\n\n  const addActivityMutation = useMutation({\n    mutationFn: async (data: { activityType: string; title: string; description?: string }) => {\n      return apiRequest(\"POST\", `/api/leads/${lead?.id}/activities`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leads\", lead?.id, \"activities\"] });\n      setNewNote(\"\");\n      toast({ title: \"Note added successfully\" });\n    },\n    onError: (error) => {\n      console.error(\"Error adding activity:\", error);\n      toast({ title: \"Failed to add note\", variant: \"destructive\" });\n    },\n  });\n\n  const addTaskMutation = useMutation({\n    mutationFn: async (data: { title: string; priority: string; assignedTo?: string }) => {\n      return apiRequest(\"POST\", `/api/leads/${lead?.id}/tasks`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leads\", lead?.id, \"tasks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/lead-tasks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/my-dashboard\"] });\n      setNewTaskTitle(\"\");\n      setNewTaskPriority(\"medium\");\n      setNewTaskAssignee(\"\");\n      toast({ title: \"Task added successfully\" });\n    },\n    onError: (error) => {\n      console.error(\"Error adding task:\", error);\n      toast({ title: \"Failed to add task\", variant: \"destructive\" });\n    },\n  });\n\n  const updateTaskMutation = useMutation({\n    mutationFn: async ({ id, status }: { id: string; status: string }) => {\n      return apiRequest(\"PATCH\", `/api/lead-tasks/${id}`, { status });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leads\", lead?.id, \"tasks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/lead-tasks\"] });\n    },\n    onError: (error) => {\n      console.error(\"Error updating task:\", error);\n      toast({ title: \"Failed to update task\", variant: \"destructive\" });\n    },\n  });\n\n  const logCallMutation = useMutation({\n    mutationFn: async (data: {\n      activityType: string;\n      title: string;\n      callDirection: string;\n      callTimestamp: string;\n      callDurationSeconds?: number;\n      callNotes?: string;\n    }) => {\n      return apiRequest(\"POST\", `/api/leads/${lead?.id}/activities`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leads\", lead?.id, \"activities\"] });\n      setShowLogCallForm(false);\n      setCallDirection(\"outbound\");\n      setCallDuration(\"\");\n      setCallNotes(\"\");\n      toast({ title: \"Call logged successfully\" });\n    },\n    onError: (error) => {\n      console.error(\"Error logging call:\", error);\n      toast({ title: \"Failed to log call\", variant: \"destructive\" });\n    },\n  });\n\n  const addTaskWithCallLinkMutation = useMutation({\n    mutationFn: async (data: { title: string; priority: string; sourceActivityId?: string; assignedTo?: string }) => {\n      return apiRequest(\"POST\", `/api/leads/${lead?.id}/tasks`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leads\", lead?.id, \"tasks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/lead-tasks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/my-dashboard\"] });\n      if (linkingTaskToCallId) {\n        queryClient.invalidateQueries({ queryKey: [\"/api/lead-activities\", linkingTaskToCallId, \"tasks\"] });\n      }\n      setNewTaskTitle(\"\");\n      setNewTaskPriority(\"medium\");\n      setNewTaskAssignee(\"\");\n      setLinkingTaskToCallId(null);\n      toast({ title: \"Task created from call\" });\n    },\n    onError: (error) => {\n      console.error(\"Error adding task:\", error);\n      toast({ title: \"Failed to add task\", variant: \"destructive\" });\n    },\n  });\n\n  const handleAddNote = () => {\n    if (!newNote.trim()) return;\n    addActivityMutation.mutate({\n      activityType: \"note_added\",\n      title: \"Note Added\",\n      description: newNote.trim(),\n    });\n  };\n\n  const handleAddTask = () => {\n    if (!newTaskTitle.trim()) return;\n    addTaskMutation.mutate({\n      title: newTaskTitle.trim(),\n      priority: newTaskPriority,\n      assignedTo: newTaskAssignee && newTaskAssignee !== \"unassigned\" ? newTaskAssignee : undefined,\n    });\n  };\n\n  const handleLogCall = () => {\n    const parsedDuration = callDuration ? parseInt(callDuration) * 60 : undefined;\n    const directionLabel = callDirection === \"inbound\" ? \"Inbound Call\" : \n                          callDirection === \"outbound\" ? \"Outbound Call\" : \"Missed Call\";\n    \n    logCallMutation.mutate({\n      activityType: callDirection === \"missed\" ? \"call_missed\" : \"call_logged\",\n      title: directionLabel,\n      callDirection,\n      callTimestamp: new Date().toISOString(),\n      callDurationSeconds: parsedDuration,\n      callNotes: callNotes.trim() || undefined,\n    });\n  };\n\n  const handleCreateTaskFromCall = (activityId: string) => {\n    setLinkingTaskToCallId(activityId);\n  };\n\n  const handleSubmitTaskFromCall = () => {\n    if (!newTaskTitle.trim()) return;\n    addTaskWithCallLinkMutation.mutate({\n      title: newTaskTitle.trim(),\n      priority: newTaskPriority,\n      sourceActivityId: linkingTaskToCallId || undefined,\n      assignedTo: newTaskAssignee && newTaskAssignee !== \"unassigned\" ? newTaskAssignee : undefined,\n    });\n  };\n\n  const isCallActivity = (activity: LeadActivity) => {\n    return activity.activityType === \"call_logged\" || activity.activityType === \"call_missed\";\n  };\n\n  if (!lead) return null;\n\n  const activeTemplates = templates.filter(t => t.isActive);\n  const defaultTemplate = activeTemplates.find(t => t.isDefault);\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-4xl max-h-[90vh]\">\n        <DialogHeader>\n          <div className=\"flex items-center justify-between\">\n            <DialogTitle className=\"text-xl flex items-center gap-2\">\n              Lead Details\n              <span className=\"text-base font-mono text-muted-foreground\">\n                {lead.leadNumber}\n              </span>\n            </DialogTitle>\n            <div className=\"flex items-center gap-2\">\n              <Badge variant={lead.leadType === \"trade\" ? \"default\" : \"secondary\"}>\n                {lead.leadType}\n              </Badge>\n              <Badge variant=\"outline\">{lead.stage}</Badge>\n              {lead.jobFulfillmentType === \"supply_install\" && (\n                <Badge className=\"bg-primary\">S+I</Badge>\n              )}\n            </div>\n          </div>\n          <DialogDescription>\n            {client?.name || \"No client linked\"} - {lead.siteAddress || \"No site address\"}\n          </DialogDescription>\n        </DialogHeader>\n\n        <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n          <TabsList className=\"grid w-full grid-cols-4\">\n            <TabsTrigger value=\"details\" data-testid=\"tab-lead-details\">Details</TabsTrigger>\n            <TabsTrigger value=\"quotes\" data-testid=\"tab-lead-quotes\">\n              Quotes ({quotes.length})\n            </TabsTrigger>\n            <TabsTrigger value=\"activity\" data-testid=\"tab-lead-activity\">Activity</TabsTrigger>\n            <TabsTrigger value=\"document\" data-testid=\"tab-lead-document\">Live Document</TabsTrigger>\n          </TabsList>\n\n          <ScrollArea className=\"h-[60vh] mt-4\">\n            <TabsContent value=\"details\" className=\"mt-0 space-y-4\">\n              <div className=\"flex gap-2\">\n                <Button size=\"sm\" variant=\"outline\" onClick={onEditLead} data-testid=\"button-edit-lead-detail\">\n                  <Edit className=\"h-4 w-4 mr-1\" />\n                  Edit Lead\n                </Button>\n                <Button size=\"sm\" variant=\"outline\" onClick={onCreateQuote} data-testid=\"button-create-quote-detail\">\n                  <FileText className=\"h-4 w-4 mr-1\" />\n                  Create Quote\n                </Button>\n                <Button size=\"sm\" variant=\"outline\" onClick={handleLogCall} data-testid=\"button-log-call\">\n                  <PhoneCall className=\"h-4 w-4 mr-1\" />\n                  Log Call\n                </Button>\n              </div>\n\n              <Card>\n                <CardHeader className=\"pb-3\">\n                  <CardTitle className=\"text-base\">Contact Information</CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div className=\"font-medium text-lg\">\n                    {client?.name || \"No client linked\"}\n                  </div>\n                  {client?.phone && (\n                    <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                      <Phone className=\"h-4 w-4\" />\n                      <a href={`tel:${client.phone}`} className=\"hover:underline\">{client.phone}</a>\n                    </div>\n                  )}\n                  {client?.email && (\n                    <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                      <Mail className=\"h-4 w-4\" />\n                      <a href={`mailto:${client.email}`} className=\"hover:underline\">{client.email}</a>\n                    </div>\n                  )}\n                  {lead.siteAddress && (\n                    <>\n                      <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                        <MapPin className=\"h-4 w-4\" />\n                        {lead.siteAddress}\n                      </div>\n                      <SitePreview address={lead.siteAddress} />\n                    </>\n                  )}\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader className=\"pb-3\">\n                  <CardTitle className=\"text-base\">Assignment</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"flex items-center gap-3\">\n                    <User className=\"h-4 w-4 text-muted-foreground\" />\n                    <Select\n                      value={lead.assignedTo || \"unassigned\"}\n                      onValueChange={(value) => {\n                        updateLeadMutation.mutate({\n                          assignedTo: value === \"unassigned\" ? null : value,\n                        } as any);\n                      }}\n                    >\n                      <SelectTrigger className=\"w-[200px]\" data-testid=\"select-lead-assigned-to\">\n                        <SelectValue placeholder=\"Assign to...\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"unassigned\">Unassigned</SelectItem>\n                        {users.map((user) => (\n                          <SelectItem key={user.id} value={user.id}>\n                            {user.firstName} {user.lastName}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    {updateLeadMutation.isPending && (\n                      <span className=\"text-xs text-muted-foreground\">Saving...</span>\n                    )}\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader className=\"pb-3\">\n                  <CardTitle className=\"text-base\">Project Details</CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                    <div>\n                      <span className=\"text-muted-foreground\">Fence Style:</span>\n                      <div className=\"font-medium\">{lead.fenceStyle || \"Not specified\"}</div>\n                    </div>\n                    <div>\n                      <span className=\"text-muted-foreground\">Length:</span>\n                      <div className=\"font-medium\">{lead.fenceLength ? `${lead.fenceLength}m` : \"Not specified\"}</div>\n                    </div>\n                    <div>\n                      <span className=\"text-muted-foreground\">Source:</span>\n                      <div className=\"font-medium capitalize\">{lead.source?.replace(\"_\", \" \") || \"Unknown\"}</div>\n                    </div>\n                    <div>\n                      <span className=\"text-muted-foreground\">Job Type:</span>\n                      <div className=\"font-medium\">\n                        <Badge variant={lead.jobFulfillmentType === \"supply_install\" ? \"default\" : \"secondary\"}>\n                          {lead.jobFulfillmentType === \"supply_install\" ? \"Supply & Install\" : \"Supply Only\"}\n                        </Badge>\n                      </div>\n                    </div>\n                  </div>\n                  {lead.description && (\n                    <div className=\"pt-2\">\n                      <span className=\"text-sm text-muted-foreground\">Description:</span>\n                      <p className=\"mt-1\">{lead.description}</p>\n                    </div>\n                  )}\n                  {lead.notes && (\n                    <div className=\"pt-2\">\n                      <span className=\"text-sm text-muted-foreground\">Notes:</span>\n                      <p className=\"mt-1\">{lead.notes}</p>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"quotes\" className=\"mt-0 space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <h3 className=\"font-medium\">Associated Quotes</h3>\n                <Button size=\"sm\" onClick={onCreateQuote} data-testid=\"button-new-quote\">\n                  <Plus className=\"h-4 w-4 mr-1\" />\n                  New Quote\n                </Button>\n              </div>\n\n              {quotes.length === 0 ? (\n                <Card>\n                  <CardContent className=\"py-8 text-center\">\n                    <FileText className=\"h-12 w-12 mx-auto text-muted-foreground mb-3\" />\n                    <p className=\"text-muted-foreground\">No quotes created yet.</p>\n                    <Button size=\"sm\" className=\"mt-4\" onClick={onCreateQuote}>\n                      Create First Quote\n                    </Button>\n                  </CardContent>\n                </Card>\n              ) : (\n                <div className=\"space-y-2\">\n                  {quotes.map((quote) => (\n                    <Card\n                      key={quote.id}\n                      className={`hover-elevate ${(quote as any).isPrimary ? \"border-green-500 border-2\" : \"\"}`}\n                      data-testid={`quote-item-${quote.id}`}\n                    >\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-center justify-between\">\n                          <div \n                            className=\"cursor-pointer flex-1\"\n                            onClick={() => onViewQuote(quote)}\n                          >\n                            <div className=\"flex items-center gap-2\">\n                              <span className=\"font-medium\">{quote.quoteNumber}</span>\n                              {(quote as any).isPrimary && (\n                                <Badge variant=\"default\" className=\"bg-green-600 text-xs\">\n                                  <Star className=\"h-3 w-3 mr-1\" />\n                                  Primary\n                                </Badge>\n                              )}\n                            </div>\n                            <div className=\"text-sm text-muted-foreground\">\n                              {formatCurrency(quote.totalAmount)}\n                            </div>\n                          </div>\n                          <div className=\"flex items-center gap-2 flex-wrap justify-end\">\n                            <Badge\n                              variant={\n                                quote.status === \"approved\"\n                                  ? \"default\"\n                                  : quote.status === \"sent\"\n                                  ? \"secondary\"\n                                  : quote.status === \"rejected\"\n                                  ? \"destructive\"\n                                  : \"outline\"\n                              }\n                            >\n                              {quote.status}\n                            </Badge>\n                            {quote.status !== \"approved\" && quote.status !== \"rejected\" && !(quote as any).isPrimary && (\n                              <Button\n                                size=\"sm\"\n                                variant=\"ghost\"\n                                onClick={(e) => {\n                                  e.stopPropagation();\n                                  setPrimaryQuoteMutation.mutate(quote.id);\n                                }}\n                                disabled={setPrimaryQuoteMutation.isPending}\n                                data-testid={`button-set-primary-${quote.id}`}\n                              >\n                                <Star className=\"h-3 w-3 mr-1\" />\n                                Set Primary\n                              </Button>\n                            )}\n                            {quote.status === \"draft\" && (\n                              <Button\n                                size=\"sm\"\n                                variant=\"outline\"\n                                onClick={(e) => {\n                                  e.stopPropagation();\n                                  updateQuoteMutation.mutate({\n                                    quoteId: quote.id,\n                                    data: { status: \"sent\" },\n                                  });\n                                }}\n                                disabled={updateQuoteMutation.isPending}\n                                data-testid={`button-send-quote-${quote.id}`}\n                              >\n                                <Send className=\"h-3 w-3 mr-1\" />\n                                Send\n                              </Button>\n                            )}\n                            {quote.status === \"sent\" && (\n                              <Button\n                                size=\"sm\"\n                                variant=\"default\"\n                                onClick={(e) => {\n                                  e.stopPropagation();\n                                  convertToJobMutation.mutate({\n                                    quoteId: quote.id,\n                                    jobType: lead.jobFulfillmentType || \"supply_install\",\n                                  });\n                                }}\n                                disabled={convertToJobMutation.isPending}\n                                data-testid={`button-convert-to-job-${quote.id}`}\n                              >\n                                <ClipboardList className=\"h-3 w-3 mr-1\" />\n                                Accept Quote\n                              </Button>\n                            )}\n                            <ChevronRight \n                              className=\"h-4 w-4 text-muted-foreground cursor-pointer\" \n                              onClick={() => onViewQuote(quote)}\n                            />\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              )}\n            </TabsContent>\n\n            <TabsContent value=\"activity\" className=\"mt-0 space-y-4\">\n              <div className=\"flex items-center justify-end gap-2\">\n                <Button\n                  size=\"sm\"\n                  variant={showLogCallForm ? \"secondary\" : \"outline\"}\n                  onClick={() => setShowLogCallForm(!showLogCallForm)}\n                  data-testid=\"button-toggle-log-call\"\n                >\n                  <PhoneCall className=\"h-4 w-4 mr-1\" />\n                  Log Call\n                </Button>\n              </div>\n\n              {showLogCallForm && (\n                <Card className=\"border-primary/50\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-base flex items-center gap-2\">\n                      <PhoneCall className=\"h-4 w-4\" />\n                      Log a Call\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-3\">\n                    <div className=\"flex gap-2\">\n                      <Button\n                        size=\"sm\"\n                        variant={callDirection === \"inbound\" ? \"default\" : \"outline\"}\n                        onClick={() => setCallDirection(\"inbound\")}\n                        data-testid=\"button-call-inbound\"\n                      >\n                        <PhoneIncoming className=\"h-4 w-4 mr-1\" />\n                        Inbound\n                      </Button>\n                      <Button\n                        size=\"sm\"\n                        variant={callDirection === \"outbound\" ? \"default\" : \"outline\"}\n                        onClick={() => setCallDirection(\"outbound\")}\n                        data-testid=\"button-call-outbound\"\n                      >\n                        <PhoneOutgoing className=\"h-4 w-4 mr-1\" />\n                        Outbound\n                      </Button>\n                      <Button\n                        size=\"sm\"\n                        variant={callDirection === \"missed\" ? \"default\" : \"outline\"}\n                        onClick={() => setCallDirection(\"missed\")}\n                        data-testid=\"button-call-missed\"\n                      >\n                        <PhoneMissed className=\"h-4 w-4 mr-1\" />\n                        Missed\n                      </Button>\n                    </div>\n                    \n                    <div className=\"flex gap-2 items-end\">\n                      <div className=\"flex-1\">\n                        <label className=\"text-sm text-muted-foreground mb-1 block\">Duration (minutes)</label>\n                        <Input\n                          type=\"number\"\n                          placeholder=\"0\"\n                          min=\"0\"\n                          value={callDuration}\n                          onChange={(e) => setCallDuration(e.target.value)}\n                          className=\"w-24\"\n                          data-testid=\"input-call-duration\"\n                        />\n                      </div>\n                    </div>\n\n                    <div>\n                      <label className=\"text-sm text-muted-foreground mb-1 block\">Notes</label>\n                      <Textarea\n                        placeholder=\"Call notes...\"\n                        value={callNotes}\n                        onChange={(e) => setCallNotes(e.target.value)}\n                        className=\"min-h-[60px]\"\n                        data-testid=\"input-call-notes\"\n                      />\n                    </div>\n\n                    <div className=\"flex gap-2\">\n                      <Button\n                        size=\"sm\"\n                        onClick={handleLogCall}\n                        disabled={logCallMutation.isPending}\n                        data-testid=\"button-submit-call-log\"\n                      >\n                        {logCallMutation.isPending ? \"Saving...\" : \"Log Call\"}\n                      </Button>\n                      <Button\n                        size=\"sm\"\n                        variant=\"outline\"\n                        onClick={() => setShowLogCallForm(false)}\n                      >\n                        Cancel\n                      </Button>\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n\n              {linkingTaskToCallId && (\n                <Card className=\"border-blue-500/50\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-base flex items-center gap-2\">\n                      <CheckCircle2 className=\"h-4 w-4\" />\n                      Create Task from Call\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-2\">\n                    <Input\n                      placeholder=\"Task title...\"\n                      value={newTaskTitle}\n                      onChange={(e) => setNewTaskTitle(e.target.value)}\n                      data-testid=\"input-task-from-call\"\n                    />\n                    <div className=\"flex gap-2 flex-wrap\">\n                      <Select value={newTaskPriority} onValueChange={setNewTaskPriority}>\n                        <SelectTrigger className=\"w-[120px]\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"low\">Low</SelectItem>\n                          <SelectItem value=\"medium\">Medium</SelectItem>\n                          <SelectItem value=\"high\">High</SelectItem>\n                          <SelectItem value=\"urgent\">Urgent</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <Select value={newTaskAssignee} onValueChange={setNewTaskAssignee}>\n                        <SelectTrigger className=\"w-[160px]\" data-testid=\"select-task-assignee-call\">\n                          <SelectValue placeholder=\"Assign to...\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"unassigned\">Unassigned</SelectItem>\n                          {users.map((user) => (\n                            <SelectItem key={user.id} value={user.id}>\n                              {user.firstName} {user.lastName}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div className=\"flex gap-2\">\n                      <Button \n                        size=\"sm\" \n                        onClick={handleSubmitTaskFromCall}\n                        disabled={!newTaskTitle.trim() || addTaskWithCallLinkMutation.isPending}\n                        data-testid=\"button-submit-task-from-call\"\n                      >\n                        Create Task\n                      </Button>\n                      <Button\n                        size=\"sm\"\n                        variant=\"outline\"\n                        onClick={() => {\n                          setLinkingTaskToCallId(null);\n                          setNewTaskAssignee(\"\");\n                        }}\n                      >\n                        Cancel\n                      </Button>\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-base flex items-center gap-2\">\n                      <MessageSquare className=\"h-4 w-4\" />\n                      Add Note\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-2\">\n                    <Textarea\n                      placeholder=\"Add a note...\"\n                      value={newNote}\n                      onChange={(e) => setNewNote(e.target.value)}\n                      className=\"min-h-[80px]\"\n                      data-testid=\"input-new-note\"\n                    />\n                    <Button \n                      size=\"sm\" \n                      onClick={handleAddNote}\n                      disabled={!newNote.trim() || addActivityMutation.isPending}\n                      data-testid=\"button-add-note\"\n                    >\n                      Add Note\n                    </Button>\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-base flex items-center gap-2\">\n                      <CheckCircle2 className=\"h-4 w-4\" />\n                      Add Task\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-2\">\n                    <Input\n                      placeholder=\"Task title...\"\n                      value={newTaskTitle}\n                      onChange={(e) => setNewTaskTitle(e.target.value)}\n                      data-testid=\"input-new-task\"\n                    />\n                    <div className=\"flex gap-2 flex-wrap\">\n                      <Select value={newTaskPriority} onValueChange={setNewTaskPriority}>\n                        <SelectTrigger className=\"w-[120px]\" data-testid=\"select-task-priority\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"low\">Low</SelectItem>\n                          <SelectItem value=\"medium\">Medium</SelectItem>\n                          <SelectItem value=\"high\">High</SelectItem>\n                          <SelectItem value=\"urgent\">Urgent</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <Select value={newTaskAssignee} onValueChange={setNewTaskAssignee}>\n                        <SelectTrigger className=\"w-[160px]\" data-testid=\"select-task-assignee\">\n                          <SelectValue placeholder=\"Assign to...\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"unassigned\">Unassigned</SelectItem>\n                          {users.map((user) => (\n                            <SelectItem key={user.id} value={user.id}>\n                              {user.firstName} {user.lastName}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <Button \n                      size=\"sm\" \n                      onClick={handleAddTask}\n                      disabled={!newTaskTitle.trim() || addTaskMutation.isPending}\n                      data-testid=\"button-add-task\"\n                    >\n                      Add Task\n                    </Button>\n                  </CardContent>\n                </Card>\n              </div>\n\n              {tasks.length > 0 && (\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-base\">Tasks ({tasks.filter(t => t.status !== \"completed\").length} pending)</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-2\">\n                      {tasks.map((task) => {\n                        const assignee = task.assignedTo ? users.find(u => u.id === task.assignedTo) : null;\n                        return (\n                          <div\n                            key={task.id}\n                            className={`flex items-center justify-between p-2 border rounded-lg transition-all duration-300 ${focusedTaskId === task.id ? \"ring-2 ring-primary bg-primary/5\" : \"\"}`}\n                            data-testid={`task-item-${task.id}`}\n                            data-task-id={task.id}\n                          >\n                            <div className=\"flex items-center gap-2\">\n                              <Button\n                                variant=\"ghost\"\n                                size=\"icon\"\n                                className=\"h-6 w-6\"\n                                onClick={() => updateTaskMutation.mutate({\n                                  id: task.id,\n                                  status: task.status === \"completed\" ? \"pending\" : \"completed\"\n                                })}\n                              >\n                                {task.status === \"completed\" ? (\n                                  <CheckCircle2 className=\"h-4 w-4 text-green-600\" />\n                                ) : (\n                                  <CircleDashed className=\"h-4 w-4 text-muted-foreground\" />\n                                )}\n                              </Button>\n                              <div className=\"flex flex-col\">\n                                <span className={task.status === \"completed\" ? \"line-through text-muted-foreground\" : \"\"}>\n                                  {task.title}\n                                </span>\n                                {assignee && (\n                                  <span className=\"text-xs text-muted-foreground flex items-center gap-1\">\n                                    <User className=\"h-3 w-3\" />\n                                    {assignee.firstName} {assignee.lastName}\n                                  </span>\n                                )}\n                              </div>\n                            </div>\n                            <Badge className={priorityColors[task.priority || \"medium\"]}>\n                              {task.priority}\n                            </Badge>\n                          </div>\n                        );\n                      })}\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n\n              {activities.filter(a => isCallActivity(a)).length > 0 && (\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-base flex items-center gap-2\">\n                      <PhoneCall className=\"h-4 w-4\" />\n                      Call History\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-2\">\n                      {activities\n                        .filter(a => isCallActivity(a))\n                        .map((activity) => (\n                          <CallLogEntry\n                            key={activity.id}\n                            activity={activity}\n                            users={users}\n                            leadId={lead.id}\n                            onCreateTask={handleCreateTaskFromCall}\n                          />\n                        ))\n                      }\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-base\">Activity Log</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {activities.filter(a => !isCallActivity(a)).length === 0 ? (\n                    <p className=\"text-sm text-muted-foreground py-4 text-center\">No other activity recorded yet.</p>\n                  ) : (\n                    <div className=\"space-y-3\">\n                      {activities\n                        .filter(a => !isCallActivity(a))\n                        .map((activity) => {\n                          const typeInfo = activityTypeLabels[activity.activityType] || { label: activity.activityType, icon: MessageSquare };\n                          const Icon = typeInfo.icon;\n                          return (\n                            <div key={activity.id} className=\"flex gap-3 text-sm\" data-testid={`activity-item-${activity.id}`}>\n                              <div className=\"p-1.5 rounded-full bg-muted h-fit\">\n                                <Icon className=\"h-3 w-3\" />\n                              </div>\n                              <div className=\"flex-1\">\n                                <div className=\"font-medium\">{typeInfo.label}</div>\n                                {activity.description && (\n                                  <p className=\"text-muted-foreground\">{activity.description}</p>\n                                )}\n                                <div className=\"text-xs text-muted-foreground mt-1\">\n                                  {activity.createdAt && format(new Date(activity.createdAt), \"dd/MM/yyyy HH:mm\")}\n                                </div>\n                              </div>\n                            </div>\n                          );\n                        })\n                      }\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"document\" className=\"mt-0 space-y-4\">\n              {lead.jobFulfillmentType !== \"supply_install\" ? (\n                <Card>\n                  <CardContent className=\"py-8 text-center\">\n                    <AlertCircle className=\"h-12 w-12 mx-auto text-muted-foreground mb-3\" />\n                    <p className=\"text-muted-foreground\">\n                      Live documents are only available for Supply & Install jobs.\n                    </p>\n                    <p className=\"text-sm text-muted-foreground mt-2\">\n                      This lead is set as \"Supply Only\".\n                    </p>\n                  </CardContent>\n                </Card>\n              ) : existingDocument ? (\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-2\">\n                      <ClipboardList className=\"h-5 w-5 text-primary\" />\n                      <h3 className=\"font-medium\">Job Setup & Handover Document</h3>\n                    </div>\n                    <Badge variant=\"outline\">\n                      Created {existingDocument.createdAt && format(new Date(existingDocument.createdAt), \"dd/MM/yyyy\")}\n                    </Badge>\n                  </div>\n                  <JobSetupDocument\n                    leadId={lead.id}\n                    jobType=\"supply_install\"\n                  />\n                </div>\n              ) : (\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"text-base flex items-center gap-2\">\n                      <ClipboardList className=\"h-5 w-5\" />\n                      Create Live Document\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-4\">\n                    <p className=\"text-sm text-muted-foreground\">\n                      Select a template to create the Job Setup & Handover document for this lead.\n                      This document will follow the job through production, scheduling, and installation.\n                    </p>\n\n                    {activeTemplates.length === 0 ? (\n                      <div className=\"p-4 bg-muted/50 rounded-lg text-center\">\n                        <p className=\"text-sm text-muted-foreground\">\n                          No templates available. Please create a template first.\n                        </p>\n                      </div>\n                    ) : (\n                      <>\n                        <div>\n                          <label className=\"text-sm font-medium mb-2 block\">Select Template</label>\n                          <Select \n                            value={selectedTemplateId || defaultTemplate?.id || \"\"} \n                            onValueChange={setSelectedTemplateId}\n                          >\n                            <SelectTrigger data-testid=\"select-template\">\n                              <SelectValue placeholder=\"Choose a template...\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {activeTemplates.map((template) => (\n                                <SelectItem key={template.id} value={template.id}>\n                                  {template.name} {template.isDefault && \"(Default)\"}\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                        </div>\n\n                        <Button \n                          className=\"w-full\"\n                          onClick={() => {\n                            queryClient.invalidateQueries({ queryKey: [\"/api/leads\", lead.id, \"live-document\"] });\n                          }}\n                          data-testid=\"button-create-document\"\n                        >\n                          <ClipboardList className=\"h-4 w-4 mr-2\" />\n                          Create Document\n                        </Button>\n                      </>\n                    )}\n                  </CardContent>\n                </Card>\n              )}\n            </TabsContent>\n          </ScrollArea>\n        </Tabs>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":48691,"size_tokens":null},"client/src/hooks/use-auth.tsx":{"content":"import { createContext, useContext, useEffect, useState, useCallback, type ReactNode } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\ninterface AuthUser {\n  id: string;\n  username: string;\n  email: string;\n  firstName: string;\n  lastName: string;\n  role: string;\n  positionTitle: string | null;\n  profilePhotoUrl: string | null;\n}\n\ninterface AuthContextType {\n  user: AuthUser | null;\n  isLoading: boolean;\n  isAuthenticated: boolean;\n  login: (email: string, password: string) => Promise<void>;\n  logout: () => Promise<void>;\n  error: string | null;\n}\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\nexport function AuthProvider({ children }: { children: ReactNode }) {\n  const [error, setError] = useState<string | null>(null);\n  const queryClient = useQueryClient();\n\n  const { data: authData, isLoading, refetch } = useQuery<{ user: AuthUser }>({\n    queryKey: [\"/api/auth/me\"],\n    retry: false,\n    refetchOnWindowFocus: false,\n  });\n\n  const loginMutation = useMutation({\n    mutationFn: async ({ email, password }: { email: string; password: string }) => {\n      const response = await apiRequest(\"POST\", \"/api/auth/login\", { email, password });\n      return response.json();\n    },\n    onSuccess: (data) => {\n      queryClient.setQueryData([\"/api/auth/me\"], data);\n      setError(null);\n    },\n    onError: (err: any) => {\n      setError(err.message || \"Login failed\");\n    },\n  });\n\n  const logoutMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest(\"POST\", \"/api/auth/logout\", {});\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.setQueryData([\"/api/auth/me\"], null);\n      queryClient.clear();\n    },\n  });\n\n  const login = useCallback(async (email: string, password: string) => {\n    setError(null);\n    await loginMutation.mutateAsync({ email, password });\n  }, [loginMutation]);\n\n  const logout = useCallback(async () => {\n    await logoutMutation.mutateAsync();\n  }, [logoutMutation]);\n\n  const user = authData?.user || null;\n  const isAuthenticated = !!user;\n\n  return (\n    <AuthContext.Provider\n      value={{\n        user,\n        isLoading,\n        isAuthenticated,\n        login,\n        logout,\n        error,\n      }}\n    >\n      {children}\n    </AuthContext.Provider>\n  );\n}\n\nexport function useAuth() {\n  const context = useContext(AuthContext);\n  if (context === undefined) {\n    throw new Error(\"useAuth must be used within an AuthProvider\");\n  }\n  return context;\n}\n","path":null,"size_bytes":2591,"size_tokens":null},"client/src/pages/Login.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Loader2, AlertCircle } from \"lucide-react\";\n\nexport default function Login() {\n  const [, setLocation] = useLocation();\n  const { login, isLoading, error } = useAuth();\n  const [email, setEmail] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [localError, setLocalError] = useState<string | null>(null);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setLocalError(null);\n    \n    if (!email || !password) {\n      setLocalError(\"Please enter both email and password\");\n      return;\n    }\n    \n    setIsSubmitting(true);\n    try {\n      await login(email, password);\n      setLocation(\"/\");\n    } catch (err: any) {\n      setLocalError(err.message || \"Login failed\");\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  const displayError = localError || error;\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-background p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"space-y-1 text-center\">\n          <div className=\"flex justify-center mb-4\">\n            <div className=\"h-16 w-16 rounded-full bg-primary flex items-center justify-center\">\n              <span className=\"text-2xl font-bold text-primary-foreground\">P</span>\n            </div>\n          </div>\n          <CardTitle className=\"text-2xl font-bold\" data-testid=\"text-login-title\">\n            Probuild PVC\n          </CardTitle>\n          <CardDescription data-testid=\"text-login-description\">\n            Sign in to access your dashboard\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            {displayError && (\n              <Alert variant=\"destructive\" data-testid=\"alert-login-error\">\n                <AlertCircle className=\"h-4 w-4\" />\n                <AlertDescription>{displayError}</AlertDescription>\n              </Alert>\n            )}\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"email\">Email</Label>\n              <Input\n                id=\"email\"\n                type=\"email\"\n                placeholder=\"you@example.com\"\n                value={email}\n                onChange={(e) => setEmail(e.target.value)}\n                disabled={isSubmitting}\n                data-testid=\"input-email\"\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"password\">Password</Label>\n              <Input\n                id=\"password\"\n                type=\"password\"\n                placeholder=\"Enter your password\"\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                disabled={isSubmitting}\n                data-testid=\"input-password\"\n              />\n            </div>\n            \n            <Button \n              type=\"submit\" \n              className=\"w-full\" \n              disabled={isSubmitting}\n              data-testid=\"button-login\"\n            >\n              {isSubmitting ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Signing in...\n                </>\n              ) : (\n                \"Sign In\"\n              )}\n            </Button>\n          </form>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":3840,"size_tokens":null},"client/src/pages/MyDashboard.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { \n  CheckCircle2, Clock, AlertCircle, Bell, Calendar, Cloud, Sun, CloudRain,\n  Thermometer, Umbrella, FileText, Phone, Briefcase, Users, TrendingUp,\n  CalendarCheck, Target, ExternalLink, Plus, Package, Truck, ClipboardList,\n  Hammer, Settings, BarChart3, UserPlus, Boxes, Wrench, LayoutDashboard,\n  Gauge, LineChart, PieChart, Table, ListChecks\n} from \"lucide-react\";\nimport type { LeadTask, Notification, StaffLeaveBalance, DashboardWidget } from \"@shared/schema\";\nimport { formatDistanceToNow, isToday, isBefore, addDays, format } from \"date-fns\";\n\ninterface CustomLayoutWidget {\n  id: string;\n  widgetId: string;\n  positionX: number;\n  positionY: number;\n  width: number;\n  height: number;\n  config: Record<string, any> | null;\n  widget?: DashboardWidget;\n}\n\ninterface CustomLayout {\n  id: string;\n  name: string;\n  role: string;\n  isPublished: boolean;\n  instances: CustomLayoutWidget[];\n}\n\ninterface KpiItem {\n  label: string;\n  value: string | number;\n  trend?: string;\n}\n\ninterface DashboardData {\n  user: {\n    id: string;\n    firstName: string;\n    lastName: string;\n    role: string;\n    positionTitle: string | null;\n    profilePhotoUrl: string | null;\n  };\n  tasks: LeadTask[];\n  notifications: Notification[];\n  leaveBalance: StaffLeaveBalance | { annualLeaveBalanceHours: string; sickLeaveBalanceHours: string };\n  kpis: KpiItem[];\n}\n\nfunction getGreeting(): string {\n  const hour = new Date().getHours();\n  if (hour < 12) return \"Good morning\";\n  if (hour < 17) return \"Good afternoon\";\n  return \"Good evening\";\n}\n\nfunction formatRoleDisplay(role: string): string {\n  const roleMap: Record<string, string> = {\n    admin: \"Administrator\",\n    sales: \"Sales\",\n    scheduler: \"Scheduler\",\n    production_manager: \"Production Manager\",\n    warehouse: \"Warehouse\",\n    installer: \"Installer\",\n    trade_client: \"Trade Client\",\n  };\n  return roleMap[role] || role;\n}\n\nfunction TaskPriorityBadge({ priority }: { priority: string }) {\n  const variants: Record<string, \"destructive\" | \"secondary\" | \"outline\"> = {\n    urgent: \"destructive\",\n    high: \"destructive\",\n    medium: \"secondary\",\n    low: \"outline\",\n  };\n  return <Badge variant={variants[priority] || \"secondary\"}>{priority}</Badge>;\n}\n\nfunction TaskStatusIcon({ status }: { status: string }) {\n  if (status === \"completed\") return <CheckCircle2 className=\"h-4 w-4 text-green-500\" />;\n  if (status === \"in_progress\") return <Clock className=\"h-4 w-4 text-blue-500\" />;\n  return <AlertCircle className=\"h-4 w-4 text-muted-foreground\" />;\n}\n\nconst WEATHER_LOCATIONS = [\n  { id: \"malaga\", name: \"Malaga\" },\n  { id: \"perth\", name: \"Perth CBD\" },\n  { id: \"rockingham\", name: \"Rockingham\" },\n  { id: \"quinns\", name: \"Quinns Rock\" },\n];\n\nfunction WeatherWidget() {\n  const [selectedLocation, setSelectedLocation] = useState(() => {\n    return localStorage.getItem(\"weatherLocation\") || \"malaga\";\n  });\n\n  const { data: weather, isLoading } = useQuery<{\n    location: string;\n    temperature: number;\n    condition: string;\n    minTemp: number;\n    maxTemp: number;\n    humidity: number;\n  }>({\n    queryKey: [\"/api/weather\", selectedLocation],\n    retry: false,\n    staleTime: 1000 * 60 * 30,\n  });\n\n  const handleLocationChange = (newLocation: string) => {\n    setSelectedLocation(newLocation);\n    localStorage.setItem(\"weatherLocation\", newLocation);\n  };\n\n  if (isLoading) {\n    return (\n      <Card>\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-base flex items-center gap-2\">\n            <Cloud className=\"h-4 w-4\" />\n            Weather\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <Skeleton className=\"h-20 w-full\" />\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const weatherData = weather || {\n    location: \"Malaga\",\n    temperature: 24,\n    condition: \"Sunny\",\n    minTemp: 18,\n    maxTemp: 28,\n    humidity: 45,\n  };\n\n  const getWeatherIcon = (condition: string) => {\n    if (condition.toLowerCase().includes(\"rain\") || condition.toLowerCase().includes(\"shower\")) return <CloudRain className=\"h-10 w-10 text-blue-500\" />;\n    if (condition.toLowerCase().includes(\"cloud\") || condition.toLowerCase().includes(\"overcast\")) return <Cloud className=\"h-10 w-10 text-gray-500\" />;\n    if (condition.toLowerCase().includes(\"fog\")) return <Cloud className=\"h-10 w-10 text-gray-400\" />;\n    if (condition.toLowerCase().includes(\"thunder\")) return <CloudRain className=\"h-10 w-10 text-purple-500\" />;\n    return <Sun className=\"h-10 w-10 text-yellow-500\" />;\n  };\n\n  return (\n    <Card data-testid=\"widget-weather\">\n      <CardHeader className=\"pb-2 flex flex-row items-center justify-between gap-2\">\n        <CardTitle className=\"text-base flex items-center gap-2\">\n          <Cloud className=\"h-4 w-4\" />\n          Weather\n        </CardTitle>\n        <Select value={selectedLocation} onValueChange={handleLocationChange}>\n          <SelectTrigger className=\"w-[130px] h-7 text-xs\" data-testid=\"select-weather-location\">\n            <SelectValue />\n          </SelectTrigger>\n          <SelectContent>\n            {WEATHER_LOCATIONS.map((loc) => (\n              <SelectItem key={loc.id} value={loc.id} data-testid={`option-location-${loc.id}`}>\n                {loc.name}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </CardHeader>\n      <CardContent>\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            {getWeatherIcon(weatherData.condition)}\n            <div>\n              <p className=\"text-3xl font-bold\" data-testid=\"text-weather-temp\">{weatherData.temperature}C</p>\n              <p className=\"text-sm text-muted-foreground\">{weatherData.condition}</p>\n            </div>\n          </div>\n          <div className=\"text-right text-sm text-muted-foreground\">\n            <p className=\"flex items-center justify-end gap-1\">\n              <Thermometer className=\"h-3 w-3\" />\n              {weatherData.minTemp} / {weatherData.maxTemp}\n            </p>\n            <p className=\"flex items-center justify-end gap-1\">\n              <Umbrella className=\"h-3 w-3\" />\n              {weatherData.humidity}%\n            </p>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction LeaveBalanceWidget({ leaveBalance }: { leaveBalance: DashboardData[\"leaveBalance\"] }) {\n  const annualHours = parseFloat(leaveBalance.annualLeaveBalanceHours || \"0\");\n  const sickHours = parseFloat(leaveBalance.sickLeaveBalanceHours || \"0\");\n  const annualDays = annualHours / 8;\n  const sickDays = sickHours / 8;\n  \n  const upcomingLeave = \"upcomingLeaveStart\" in leaveBalance && leaveBalance.upcomingLeaveStart \n    ? leaveBalance \n    : null;\n\n  return (\n    <Card data-testid=\"widget-leave-balances\">\n      <CardHeader className=\"pb-2\">\n        <CardTitle className=\"text-base flex items-center gap-2\">\n          <Calendar className=\"h-4 w-4\" />\n          My Leave Balances\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-3\">\n        <div className=\"flex justify-between items-center\">\n          <span className=\"text-sm text-muted-foreground\">Annual Leave</span>\n          <span className=\"font-semibold\" data-testid=\"text-annual-leave\">{annualDays.toFixed(1)} days</span>\n        </div>\n        <div className=\"flex justify-between items-center\">\n          <span className=\"text-sm text-muted-foreground\">Sick Leave</span>\n          <span className=\"font-semibold\" data-testid=\"text-sick-leave\">{sickDays.toFixed(1)} days</span>\n        </div>\n        {upcomingLeave?.upcomingLeaveStart && upcomingLeave?.upcomingLeaveEnd && (\n          <div className=\"pt-2 border-t\">\n            <p className=\"text-xs text-muted-foreground\">Upcoming Leave</p>\n            <p className=\"text-sm font-medium\">\n              {format(new Date(upcomingLeave.upcomingLeaveStart), \"d MMM\")} - {format(new Date(upcomingLeave.upcomingLeaveEnd), \"d MMM\")}\n              <Badge variant=\"outline\" className=\"ml-2\">{upcomingLeave.upcomingLeaveType || \"Annual\"}</Badge>\n            </p>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction TasksWidget({ tasks }: { tasks: LeadTask[] }) {\n  const [, setLocation] = useLocation();\n  const [showCompleted, setShowCompleted] = useState(false);\n  \n  const updateTaskMutation = useMutation({\n    mutationFn: async ({ id, status }: { id: string; status: string }) => {\n      const response = await apiRequest(\"PATCH\", `/api/lead-tasks/${id}`, { \n        status,\n        completedAt: status === \"completed\" ? new Date().toISOString() : null,\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/my-dashboard\"] });\n    },\n  });\n\n  const now = new Date();\n  const activeTasks = tasks.filter(t => t.status !== \"completed\");\n  const completedTasks = tasks.filter(t => t.status === \"completed\");\n  const overdueTasks = activeTasks.filter(t => \n    t.dueDate && isBefore(new Date(t.dueDate), now)\n  );\n  const todayTasks = activeTasks.filter(t => \n    t.dueDate && isToday(new Date(t.dueDate))\n  );\n  const upcomingTasks = activeTasks.filter(t => {\n    if (!t.dueDate) return false;\n    const dueDate = new Date(t.dueDate);\n    return !isBefore(dueDate, now) && !isToday(dueDate) && isBefore(dueDate, addDays(now, 7));\n  });\n  const noDueDateTasks = activeTasks.filter(t => !t.dueDate);\n\n  const handleToggleComplete = async (task: LeadTask) => {\n    const newStatus = task.status === \"completed\" ? \"pending\" : \"completed\";\n    await updateTaskMutation.mutateAsync({ id: task.id, status: newStatus });\n  };\n\n  const renderTask = (task: LeadTask) => (\n    <div \n      key={task.id} \n      className=\"flex items-start gap-3 p-3 rounded-lg border bg-card hover-elevate cursor-pointer\"\n      data-testid={`task-item-${task.id}`}\n    >\n      <Checkbox\n        checked={task.status === \"completed\"}\n        onCheckedChange={() => handleToggleComplete(task)}\n        className=\"mt-1\"\n        data-testid={`checkbox-task-${task.id}`}\n      />\n      <div className=\"flex-1 min-w-0\">\n        <div className=\"flex items-center gap-2\">\n          <TaskStatusIcon status={task.status} />\n          <span className={`text-sm font-medium truncate ${task.status === \"completed\" ? \"line-through text-muted-foreground\" : \"\"}`}>\n            {task.title}\n          </span>\n        </div>\n        {task.description && (\n          <p className=\"text-xs text-muted-foreground mt-1 line-clamp-1\">{task.description}</p>\n        )}\n        <div className=\"flex items-center gap-2 mt-1\">\n          {task.dueDate && (\n            <span className=\"text-xs text-muted-foreground\">\n              Due: {format(new Date(task.dueDate), \"d MMM\")}\n            </span>\n          )}\n          <TaskPriorityBadge priority={task.priority} />\n        </div>\n      </div>\n      <Button\n        variant=\"ghost\"\n        size=\"icon\"\n        onClick={(e) => {\n          e.stopPropagation();\n          setLocation(`/leads?leadId=${task.leadId}&taskId=${task.id}&tab=activity`);\n        }}\n        data-testid={`button-open-task-${task.id}`}\n      >\n        <ExternalLink className=\"h-4 w-4\" />\n      </Button>\n    </div>\n  );\n\n  return (\n    <Card data-testid=\"widget-tasks\">\n      <CardHeader className=\"pb-2 flex flex-row items-center justify-between gap-2\">\n        <div>\n          <CardTitle className=\"text-base flex items-center gap-2\">\n            <CheckCircle2 className=\"h-4 w-4\" />\n            My To-Do List\n          </CardTitle>\n          <CardDescription>{activeTasks.length} active tasks{completedTasks.length > 0 && `  ${completedTasks.length} completed`}</CardDescription>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          {completedTasks.length > 0 && (\n            <Button \n              variant={showCompleted ? \"secondary\" : \"ghost\"} \n              size=\"sm\" \n              onClick={() => setShowCompleted(!showCompleted)}\n              data-testid=\"button-toggle-completed\"\n            >\n              {showCompleted ? \"Hide Completed\" : \"Show Completed\"}\n            </Button>\n          )}\n          <Button variant=\"outline\" size=\"sm\" onClick={() => setLocation(\"/leads\")} data-testid=\"button-view-all-tasks\">\n            View All\n          </Button>\n        </div>\n      </CardHeader>\n      <CardContent>\n        <ScrollArea className=\"h-[400px]\">\n          <div className=\"space-y-4\">\n            {overdueTasks.length > 0 && (\n              <div>\n                <h4 className=\"text-sm font-semibold text-destructive mb-2 flex items-center gap-1\">\n                  <AlertCircle className=\"h-4 w-4\" />\n                  Overdue ({overdueTasks.length})\n                </h4>\n                <div className=\"space-y-2\">\n                  {overdueTasks.slice(0, 5).map(renderTask)}\n                </div>\n              </div>\n            )}\n            \n            {todayTasks.length > 0 && (\n              <div>\n                <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-1\">\n                  <Clock className=\"h-4 w-4\" />\n                  Due Today ({todayTasks.length})\n                </h4>\n                <div className=\"space-y-2\">\n                  {todayTasks.slice(0, 5).map(renderTask)}\n                </div>\n              </div>\n            )}\n            \n            {upcomingTasks.length > 0 && (\n              <div>\n                <h4 className=\"text-sm font-semibold text-muted-foreground mb-2 flex items-center gap-1\">\n                  <Calendar className=\"h-4 w-4\" />\n                  Upcoming ({upcomingTasks.length})\n                </h4>\n                <div className=\"space-y-2\">\n                  {upcomingTasks.slice(0, 5).map(renderTask)}\n                </div>\n              </div>\n            )}\n\n            {noDueDateTasks.length > 0 && (\n              <div>\n                <h4 className=\"text-sm font-semibold text-muted-foreground mb-2 flex items-center gap-1\">\n                  <CheckCircle2 className=\"h-4 w-4\" />\n                  Other Tasks ({noDueDateTasks.length})\n                </h4>\n                <div className=\"space-y-2\">\n                  {noDueDateTasks.slice(0, 10).map(renderTask)}\n                </div>\n              </div>\n            )}\n            \n            {activeTasks.length === 0 && !showCompleted && (\n              <p className=\"text-sm text-muted-foreground text-center py-8\">\n                No active tasks. Great job!\n              </p>\n            )}\n\n            {showCompleted && completedTasks.length > 0 && (\n              <div>\n                <h4 className=\"text-sm font-semibold text-green-600 mb-2 flex items-center gap-1\">\n                  <CheckCircle2 className=\"h-4 w-4\" />\n                  Completed ({completedTasks.length})\n                </h4>\n                <div className=\"space-y-2\">\n                  {completedTasks.slice(0, 10).map(renderTask)}\n                </div>\n              </div>\n            )}\n          </div>\n        </ScrollArea>\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction NotificationsWidget({ notifications }: { notifications: Notification[] }) {\n  const [, setLocation] = useLocation();\n  \n  const markReadMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await apiRequest(\"PATCH\", `/api/notifications/${id}/read`, {});\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/my-dashboard\"] });\n    },\n  });\n\n  const unreadNotifications = notifications.filter(n => !n.isRead);\n  const recentNotifications = notifications.slice(0, 10);\n\n  const getNotificationIcon = (type: string) => {\n    if (type.includes(\"lead\")) return <Users className=\"h-4 w-4 text-blue-500\" />;\n    if (type.includes(\"quote\")) return <FileText className=\"h-4 w-4 text-green-500\" />;\n    if (type.includes(\"job\")) return <Briefcase className=\"h-4 w-4 text-purple-500\" />;\n    if (type.includes(\"call\")) return <Phone className=\"h-4 w-4 text-orange-500\" />;\n    return <Bell className=\"h-4 w-4 text-muted-foreground\" />;\n  };\n\n  const handleOpenNotification = async (notification: Notification) => {\n    if (!notification.isRead) {\n      await markReadMutation.mutateAsync(notification.id);\n    }\n    \n    if (notification.relatedEntityType && notification.relatedEntityId) {\n      const routes: Record<string, string> = {\n        lead: \"/leads\",\n        quote: \"/quotes\",\n        job: \"/jobs\",\n      };\n      const route = routes[notification.relatedEntityType];\n      if (route) {\n        setLocation(`${route}?id=${notification.relatedEntityId}`);\n      }\n    }\n  };\n\n  return (\n    <Card data-testid=\"widget-notifications\">\n      <CardHeader className=\"pb-2 flex flex-row items-center justify-between gap-2\">\n        <div>\n          <CardTitle className=\"text-base flex items-center gap-2\">\n            <Bell className=\"h-4 w-4\" />\n            My Notifications\n            {unreadNotifications.length > 0 && (\n              <Badge variant=\"destructive\" className=\"ml-1\">{unreadNotifications.length}</Badge>\n            )}\n          </CardTitle>\n        </div>\n      </CardHeader>\n      <CardContent>\n        <ScrollArea className=\"h-[300px]\">\n          <div className=\"space-y-2\">\n            {recentNotifications.length === 0 ? (\n              <p className=\"text-sm text-muted-foreground text-center py-8\">\n                No notifications\n              </p>\n            ) : (\n              recentNotifications.map((notification) => (\n                <div\n                  key={notification.id}\n                  className={`flex items-start gap-3 p-3 rounded-lg border cursor-pointer hover-elevate ${\n                    !notification.isRead ? \"bg-accent/50\" : \"bg-card\"\n                  }`}\n                  onClick={() => handleOpenNotification(notification)}\n                  data-testid={`notification-item-${notification.id}`}\n                >\n                  {getNotificationIcon(notification.type)}\n                  <div className=\"flex-1 min-w-0\">\n                    <p className={`text-sm ${!notification.isRead ? \"font-medium\" : \"\"}`}>\n                      {notification.title}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground line-clamp-1\">\n                      {notification.message}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground mt-1\">\n                      {formatDistanceToNow(new Date(notification.createdAt), { addSuffix: true })}\n                    </p>\n                  </div>\n                  {!notification.isRead && (\n                    <div className=\"h-2 w-2 rounded-full bg-primary\" />\n                  )}\n                </div>\n              ))\n            )}\n          </div>\n        </ScrollArea>\n      </CardContent>\n    </Card>\n  );\n}\n\ninterface QuickAction {\n  label: string;\n  icon: typeof Plus;\n  path: string;\n  variant?: \"default\" | \"outline\" | \"ghost\";\n}\n\nfunction getRoleQuickActions(role: string): QuickAction[] {\n  const commonActions: QuickAction[] = [];\n  \n  switch (role) {\n    case 'admin':\n      return [\n        { label: \"New Lead\", icon: UserPlus, path: \"/leads\", variant: \"default\" },\n        { label: \"Schedule\", icon: CalendarCheck, path: \"/schedule\", variant: \"outline\" },\n        { label: \"Business Dashboard\", icon: BarChart3, path: \"/business-dashboard\", variant: \"outline\" },\n        { label: \"Settings\", icon: Settings, path: \"/organisation\", variant: \"ghost\" },\n      ];\n    case 'sales':\n      return [\n        { label: \"New Lead\", icon: UserPlus, path: \"/leads\", variant: \"default\" },\n        { label: \"Quotes\", icon: FileText, path: \"/quotes\", variant: \"outline\" },\n        { label: \"My Clients\", icon: Users, path: \"/clients\", variant: \"outline\" },\n      ];\n    case 'scheduler':\n      return [\n        { label: \"Schedule\", icon: CalendarCheck, path: \"/schedule\", variant: \"default\" },\n        { label: \"Jobs\", icon: Briefcase, path: \"/jobs\", variant: \"outline\" },\n        { label: \"Installers\", icon: Users, path: \"/organisation\", variant: \"ghost\" },\n      ];\n    case 'production_manager':\n      return [\n        { label: \"Production Queue\", icon: ClipboardList, path: \"/production\", variant: \"default\" },\n        { label: \"Jobs\", icon: Briefcase, path: \"/jobs\", variant: \"outline\" },\n        { label: \"Inventory\", icon: Package, path: \"/inventory\", variant: \"outline\" },\n      ];\n    case 'warehouse':\n      return [\n        { label: \"Inventory\", icon: Boxes, path: \"/inventory\", variant: \"default\" },\n        { label: \"Low Stock\", icon: AlertCircle, path: \"/inventory?filter=low-stock\", variant: \"outline\" },\n        { label: \"Deliveries\", icon: Truck, path: \"/schedule\", variant: \"outline\" },\n      ];\n    case 'installer':\n      return [\n        { label: \"My Jobs\", icon: Hammer, path: \"/jobs?filter=mine\", variant: \"default\" },\n        { label: \"Schedule\", icon: CalendarCheck, path: \"/schedule\", variant: \"outline\" },\n        { label: \"Job Docs\", icon: FileText, path: \"/jobs\", variant: \"ghost\" },\n      ];\n    case 'trade_client':\n      return [\n        { label: \"My Orders\", icon: Package, path: \"/jobs\", variant: \"default\" },\n        { label: \"New Quote\", icon: FileText, path: \"/quotes\", variant: \"outline\" },\n        { label: \"Contact Us\", icon: Phone, path: \"/contact\", variant: \"ghost\" },\n      ];\n    default:\n      return [\n        { label: \"Dashboard\", icon: BarChart3, path: \"/\", variant: \"default\" },\n      ];\n  }\n}\n\nfunction RoleQuickActions({ role }: { role: string }) {\n  const [, setLocation] = useLocation();\n  const actions = getRoleQuickActions(role);\n  \n  return (\n    <div className=\"flex flex-wrap items-center gap-2\">\n      {actions.map((action, index) => (\n        <Button \n          key={index}\n          variant={action.variant || \"outline\"} \n          size=\"sm\" \n          onClick={() => setLocation(action.path)}\n          data-testid={`button-quick-${action.label.toLowerCase().replace(/\\s+/g, '-')}`}\n        >\n          <action.icon className=\"h-4 w-4 mr-2\" />\n          {action.label}\n        </Button>\n      ))}\n    </div>\n  );\n}\n\nfunction KPIsWidget({ kpis }: { kpis: KpiItem[] }) {\n  return (\n    <Card data-testid=\"widget-kpis\">\n      <CardHeader className=\"pb-2\">\n        <CardTitle className=\"text-base flex items-center gap-2\">\n          <TrendingUp className=\"h-4 w-4\" />\n          My Performance\n        </CardTitle>\n        <CardDescription>Role-based metrics</CardDescription>\n      </CardHeader>\n      <CardContent>\n        <div className=\"grid gap-3\">\n          {kpis.map((kpi, index) => (\n            <div\n              key={index}\n              className=\"flex items-center justify-between p-3 rounded-lg border bg-card\"\n              data-testid={`kpi-item-${index}`}\n            >\n              <div>\n                <p className=\"text-sm font-medium\">{kpi.label}</p>\n                {kpi.trend && (\n                  <p className=\"text-xs text-green-600\">{kpi.trend}</p>\n                )}\n              </div>\n              <p className=\"text-2xl font-bold\">{kpi.value}</p>\n            </div>\n          ))}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nconst WIDGET_ICONS: Record<string, typeof BarChart3> = {\n  \"bar_chart\": BarChart3,\n  \"line_chart\": LineChart,\n  \"pie_chart\": PieChart,\n  \"table\": Table,\n  \"kpi\": Gauge,\n  \"list\": ListChecks,\n};\n\nfunction CustomWidgetRenderer({ \n  widget, \n  dashboardData \n}: { \n  widget: CustomLayoutWidget; \n  dashboardData: DashboardData | undefined;\n}) {\n  const widgetInfo = widget.widget;\n  if (!widgetInfo) {\n    return (\n      <Card className=\"h-full\">\n        <CardContent className=\"flex items-center justify-center h-full min-h-[120px]\">\n          <p className=\"text-muted-foreground\">Widget not found</p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const Icon = WIDGET_ICONS[widgetInfo.widgetType] || LayoutDashboard;\n\n  switch (widgetInfo.componentKey) {\n    case \"tasks_widget\":\n      return <TasksWidget tasks={dashboardData?.tasks || []} />;\n    case \"notifications_widget\":\n      return <NotificationsWidget notifications={dashboardData?.notifications || []} />;\n    case \"kpis_widget\":\n      return <KPIsWidget kpis={dashboardData?.kpis || []} />;\n    case \"weather_widget\":\n      return <WeatherWidget />;\n    case \"leave_balance_widget\":\n      return <LeaveBalanceWidget leaveBalance={dashboardData?.leaveBalance || { annualLeaveBalanceHours: \"0\", sickLeaveBalanceHours: \"0\" }} />;\n    default:\n      return (\n        <Card data-testid={`custom-widget-${widget.id}`}>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-base flex items-center gap-2\">\n              <Icon className=\"h-4 w-4\" />\n              {widgetInfo.name}\n            </CardTitle>\n            <CardDescription>{widgetInfo.description}</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center justify-center py-8 text-muted-foreground\">\n              <div className=\"text-center\">\n                <Icon className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n                <p className=\"text-sm\">Widget preview coming soon</p>\n                <p className=\"text-xs mt-1\">Type: {widgetInfo.widgetType}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      );\n  }\n}\n\nfunction CustomDashboardLayout({ \n  layout, \n  dashboardData \n}: { \n  layout: CustomLayout; \n  dashboardData: DashboardData | undefined;\n}) {\n  const sortedInstances = [...layout.instances].sort((a, b) => a.positionY - b.positionY);\n\n  return (\n    <div className=\"space-y-4\" data-testid=\"custom-dashboard-layout\">\n      <div className=\"flex items-center gap-2 text-sm text-muted-foreground mb-2\">\n        <LayoutDashboard className=\"h-4 w-4\" />\n        <span>Custom Layout: {layout.name}</span>\n      </div>\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n        {sortedInstances.map((instance) => (\n          <div \n            key={instance.id} \n            className={`${instance.width >= 2 ? 'md:col-span-2' : ''} ${instance.width >= 3 ? 'lg:col-span-3' : ''}`}\n          >\n            <CustomWidgetRenderer widget={instance} dashboardData={dashboardData} />\n          </div>\n        ))}\n      </div>\n      {sortedInstances.length === 0 && (\n        <Card>\n          <CardContent className=\"py-12 text-center\">\n            <LayoutDashboard className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n            <h3 className=\"text-lg font-medium mb-2\">No widgets configured</h3>\n            <p className=\"text-muted-foreground\">\n              This dashboard layout has no widgets. Ask an admin to add widgets in the Dashboard Builder.\n            </p>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n\nexport default function MyDashboard() {\n  const { user } = useAuth();\n  const [, setLocation] = useLocation();\n\n  const { data: dashboardData, isLoading } = useQuery<DashboardData>({\n    queryKey: [\"/api/my-dashboard\"],\n    enabled: !!user,\n  });\n\n  const { data: customLayout, isLoading: layoutLoading } = useQuery<CustomLayout | null>({\n    queryKey: [\"/api/dashboard/my-layout\"],\n    enabled: !!user,\n  });\n\n  const todayFormatted = new Date().toLocaleDateString(\"en-AU\", {\n    weekday: \"long\",\n    day: \"numeric\",\n    month: \"long\",\n    year: \"numeric\",\n  });\n\n  if (isLoading || layoutLoading) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <Skeleton className=\"h-24 w-full\" />\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n          <div className=\"lg:col-span-2 space-y-6\">\n            <Skeleton className=\"h-96 w-full\" />\n            <Skeleton className=\"h-64 w-full\" />\n          </div>\n          <div className=\"space-y-6\">\n            <Skeleton className=\"h-32 w-full\" />\n            <Skeleton className=\"h-48 w-full\" />\n            <Skeleton className=\"h-32 w-full\" />\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  const displayUser = dashboardData?.user || user;\n  const tasks = dashboardData?.tasks || [];\n  const notifications = dashboardData?.notifications || [];\n  const leaveBalance = dashboardData?.leaveBalance || { annualLeaveBalanceHours: \"0\", sickLeaveBalanceHours: \"0\" };\n  const kpis = dashboardData?.kpis || [];\n\n  const hasCustomLayout = customLayout && customLayout.instances && customLayout.instances.length > 0;\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"page-my-dashboard\">\n      <div className=\"flex flex-col md:flex-row md:items-center md:justify-between gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-semibold\" data-testid=\"text-dashboard-greeting\">\n            {getGreeting()}, {displayUser?.firstName || \"User\"}\n          </h1>\n          <p className=\"text-sm text-muted-foreground\">\n            {displayUser?.positionTitle || formatRoleDisplay(displayUser?.role || \"staff\")}  {todayFormatted}\n          </p>\n        </div>\n        <RoleQuickActions role={displayUser?.role || \"staff\"} />\n      </div>\n\n      {hasCustomLayout ? (\n        <CustomDashboardLayout layout={customLayout} dashboardData={dashboardData} />\n      ) : (\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n          <div className=\"lg:col-span-2 space-y-6\">\n            <TasksWidget tasks={tasks} />\n            <NotificationsWidget notifications={notifications} />\n          </div>\n          <div className=\"space-y-6\">\n            <KPIsWidget kpis={kpis} />\n            <WeatherWidget />\n            <LeaveBalanceWidget leaveBalance={leaveBalance} />\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":30251,"size_tokens":null},"client/src/pages/Import.tsx":{"content":"import { useState, useCallback } from \"react\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport { \n  Upload, Download, FileSpreadsheet, Users, ClipboardList, Briefcase,\n  CheckCircle2, AlertCircle, Loader2, X, FileText, Package\n} from \"lucide-react\";\n\ninterface ParsedRow {\n  data: Record<string, string>;\n  errors: string[];\n  rowNumber: number;\n}\n\ninterface ImportResult {\n  success: number;\n  failed: number;\n  errors: string[];\n}\n\n// CSV Template definitions\nconst clientTemplate = {\n  headers: [\"name\", \"email\", \"phone\", \"address\", \"clientType\", \"companyName\", \"abn\"],\n  example: [\"John Smith\", \"john@example.com\", \"0412345678\", \"123 Main St, Perth WA 6000\", \"public\", \"\", \"\"],\n  required: [\"name\"],\n  description: \"Import your existing clients and contacts\",\n};\n\nconst leadTemplate = {\n  headers: [\"clientName\", \"clientEmail\", \"clientPhone\", \"siteAddress\", \"source\", \"leadType\", \"jobFulfillmentType\", \"description\", \"fenceStyle\", \"fenceLength\"],\n  example: [\"Jane Doe\", \"jane@example.com\", \"0423456789\", \"45 Beach Rd, Cottesloe WA 6011\", \"website\", \"public\", \"supply_install\", \"Front fence enquiry\", \"Hampton\", \"25\"],\n  required: [\"clientName\", \"siteAddress\"],\n  description: \"Import leads with client information\",\n};\n\nconst jobTemplate = {\n  headers: [\"clientName\", \"clientEmail\", \"clientPhone\", \"siteAddress\", \"jobType\", \"fenceStyle\", \"fenceLength\", \"status\", \"notes\"],\n  example: [\"Bob Wilson\", \"bob@example.com\", \"0434567890\", \"88 Ocean Dr, Scarborough WA 6019\", \"supply_install\", \"Colonial\", \"30\", \"pending\", \"Ready for scheduling\"],\n  required: [\"clientName\", \"siteAddress\"],\n  description: \"Import existing jobs\",\n};\n\nconst productsTemplate = {\n  headers: [\"sku\", \"name\", \"category\", \"costPrice\", \"sellPrice\", \"tradePrice\", \"stockOnHand\", \"reorderPoint\", \"description\", \"dimensions\", \"color\"],\n  example: [\"PVC-POST-100\", \"PVC Post 100mm x 2.4m\", \"fencing\", \"25.00\", \"45.00\", \"38.00\", \"50\", \"10\", \"Standard PVC fence post\", \"100x100x2400mm\", \"White\"],\n  required: [\"sku\", \"name\", \"category\", \"costPrice\", \"sellPrice\"],\n  description: \"Import products and inventory items. Categories: fencing, gates, hardware, accessories, other\",\n};\n\nfunction parseCSV(csvText: string): string[][] {\n  const lines = csvText.split(/\\r?\\n/).filter(line => line.trim());\n  return lines.map(line => {\n    const result: string[] = [];\n    let current = \"\";\n    let inQuotes = false;\n    \n    for (let i = 0; i < line.length; i++) {\n      const char = line[i];\n      const nextChar = line[i + 1];\n      \n      if (char === '\"') {\n        if (inQuotes && nextChar === '\"') {\n          current += '\"';\n          i++;\n        } else {\n          inQuotes = !inQuotes;\n        }\n      } else if (char === ',' && !inQuotes) {\n        result.push(current.trim());\n        current = \"\";\n      } else {\n        current += char;\n      }\n    }\n    result.push(current.trim());\n    return result;\n  });\n}\n\nfunction normalizeHeader(header: string): string {\n  const mapping: Record<string, string> = {\n    \"clientname\": \"clientName\",\n    \"clientemail\": \"clientEmail\",\n    \"clientphone\": \"clientPhone\",\n    \"siteaddress\": \"siteAddress\",\n    \"leadtype\": \"leadType\",\n    \"jobfulfillmenttype\": \"jobFulfillmentType\",\n    \"fencestyle\": \"fenceStyle\",\n    \"fencelength\": \"fenceLength\",\n    \"clienttype\": \"clientType\",\n    \"companyname\": \"companyName\",\n    \"jobtype\": \"jobType\",\n    \"costprice\": \"costPrice\",\n    \"sellprice\": \"sellPrice\",\n    \"tradeprice\": \"tradePrice\",\n    \"stockonhand\": \"stockOnHand\",\n    \"reorderpoint\": \"reorderPoint\",\n  };\n  const lower = header.toLowerCase().replace(/\\s+/g, \"\");\n  return mapping[lower] || lower;\n}\n\nfunction downloadTemplate(type: \"clients\" | \"leads\" | \"jobs\" | \"products\") {\n  const templates = { clients: clientTemplate, leads: leadTemplate, jobs: jobTemplate, products: productsTemplate };\n  const template = templates[type];\n  \n  const csvContent = [\n    template.headers.join(\",\"),\n    template.example.join(\",\"),\n  ].join(\"\\n\");\n  \n  const blob = new Blob([csvContent], { type: \"text/csv\" });\n  const url = URL.createObjectURL(blob);\n  const a = document.createElement(\"a\");\n  a.href = url;\n  a.download = `${type}_import_template.csv`;\n  a.click();\n  URL.revokeObjectURL(url);\n}\n\nfunction ImportTab({ \n  type, \n  template, \n  icon: Icon \n}: { \n  type: \"clients\" | \"leads\" | \"jobs\" | \"products\"; \n  template: typeof clientTemplate;\n  icon: typeof Users;\n}) {\n  const { toast } = useToast();\n  const [file, setFile] = useState<File | null>(null);\n  const [parsedData, setParsedData] = useState<ParsedRow[]>([]);\n  const [headers, setHeaders] = useState<string[]>([]);\n  const [isPreviewMode, setIsPreviewMode] = useState(false);\n\n  const importMutation = useMutation({\n    mutationFn: async (data: Record<string, string>[]) => {\n      const response = await apiRequest(\"POST\", `/api/import/${type}`, { data });\n      return response.json();\n    },\n    onSuccess: (result: ImportResult) => {\n      toast({\n        title: \"Import Complete\",\n        description: `Successfully imported ${result.success} ${type}. ${result.failed > 0 ? `${result.failed} failed.` : \"\"}`,\n      });\n      queryClient.invalidateQueries({ queryKey: [`/api/${type}`] });\n      if (type === \"leads\") {\n        queryClient.invalidateQueries({ queryKey: [\"/api/clients\"] });\n      }\n      resetState();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Import Failed\",\n        description: error.message || \"Failed to import data\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetState = () => {\n    setFile(null);\n    setParsedData([]);\n    setHeaders([]);\n    setIsPreviewMode(false);\n  };\n\n  const handleFileChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {\n    const selectedFile = e.target.files?.[0];\n    if (!selectedFile) return;\n\n    if (!selectedFile.name.endsWith(\".csv\")) {\n      toast({\n        title: \"Invalid File\",\n        description: \"Please upload a CSV file\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setFile(selectedFile);\n\n    const reader = new FileReader();\n    reader.onload = (event) => {\n      const text = event.target?.result as string;\n      const rows = parseCSV(text);\n      \n      if (rows.length < 2) {\n        toast({\n          title: \"Invalid File\",\n          description: \"CSV file must have a header row and at least one data row\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n\n      const rawHeaders = rows[0].map(h => h.toLowerCase().replace(/\\s+/g, \"\"));\n      const normalizedHeaders = rawHeaders.map(normalizeHeader);\n      setHeaders(normalizedHeaders);\n\n      const dataRows = rows.slice(1);\n      const parsed: ParsedRow[] = dataRows.map((row, index) => {\n        const data: Record<string, string> = {};\n        const errors: string[] = [];\n\n        normalizedHeaders.forEach((header, i) => {\n          data[header] = row[i] || \"\";\n        });\n\n        // Validate required fields\n        template.required.forEach(field => {\n          if (!data[field] || data[field].trim() === \"\") {\n            errors.push(`Missing required field: ${field}`);\n          }\n        });\n\n        return { data, errors, rowNumber: index + 2 };\n      });\n\n      setParsedData(parsed);\n      setIsPreviewMode(true);\n    };\n\n    reader.readAsText(selectedFile);\n  }, [template, toast]);\n\n  const validRows = parsedData.filter(row => row.errors.length === 0);\n  const invalidRows = parsedData.filter(row => row.errors.length > 0);\n\n  const handleImport = () => {\n    if (validRows.length === 0) {\n      toast({\n        title: \"No Valid Data\",\n        description: \"There are no valid rows to import\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    importMutation.mutate(validRows.map(row => row.data));\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Icon className=\"h-5 w-5\" />\n            Import {type.charAt(0).toUpperCase() + type.slice(1)}\n          </CardTitle>\n          <CardDescription>{template.description}</CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {/* Template Download */}\n          <div className=\"flex items-center justify-between p-4 border rounded-lg bg-muted/50\">\n            <div className=\"flex items-center gap-3\">\n              <FileSpreadsheet className=\"h-8 w-8 text-muted-foreground\" />\n              <div>\n                <p className=\"font-medium\">Download Template</p>\n                <p className=\"text-sm text-muted-foreground\">\n                  Start with our CSV template to ensure correct formatting\n                </p>\n              </div>\n            </div>\n            <Button \n              variant=\"outline\" \n              onClick={() => downloadTemplate(type)}\n              data-testid={`button-download-${type}-template`}\n            >\n              <Download className=\"h-4 w-4 mr-2\" />\n              Download\n            </Button>\n          </div>\n\n          {/* Required Fields Info */}\n          <Alert>\n            <FileText className=\"h-4 w-4\" />\n            <AlertTitle>Required Fields</AlertTitle>\n            <AlertDescription>\n              <span className=\"font-medium\">{template.required.join(\", \")}</span>\n              <br />\n              <span className=\"text-muted-foreground text-sm\">\n                Optional fields: {template.headers.filter(h => !template.required.includes(h)).join(\", \")}\n              </span>\n            </AlertDescription>\n          </Alert>\n\n          {/* File Upload */}\n          {!isPreviewMode ? (\n            <div className=\"border-2 border-dashed rounded-lg p-8 text-center\">\n              <input\n                type=\"file\"\n                accept=\".csv\"\n                onChange={handleFileChange}\n                className=\"hidden\"\n                id={`file-upload-${type}`}\n                data-testid={`input-file-${type}`}\n              />\n              <label \n                htmlFor={`file-upload-${type}`}\n                className=\"cursor-pointer flex flex-col items-center gap-2\"\n              >\n                <Upload className=\"h-10 w-10 text-muted-foreground\" />\n                <p className=\"font-medium\">Click to upload CSV file</p>\n                <p className=\"text-sm text-muted-foreground\">or drag and drop</p>\n              </label>\n            </div>\n          ) : (\n            <div className=\"space-y-4\">\n              {/* File Info */}\n              <div className=\"flex items-center justify-between p-3 border rounded-lg\">\n                <div className=\"flex items-center gap-2\">\n                  <FileSpreadsheet className=\"h-5 w-5 text-primary\" />\n                  <span className=\"font-medium\">{file?.name}</span>\n                  <Badge variant=\"secondary\">{parsedData.length} rows</Badge>\n                </div>\n                <Button variant=\"ghost\" size=\"icon\" onClick={resetState}>\n                  <X className=\"h-4 w-4\" />\n                </Button>\n              </div>\n\n              {/* Validation Summary */}\n              <div className=\"flex gap-4\">\n                <div className=\"flex items-center gap-2 text-green-600\">\n                  <CheckCircle2 className=\"h-4 w-4\" />\n                  <span>{validRows.length} valid</span>\n                </div>\n                {invalidRows.length > 0 && (\n                  <div className=\"flex items-center gap-2 text-destructive\">\n                    <AlertCircle className=\"h-4 w-4\" />\n                    <span>{invalidRows.length} with errors</span>\n                  </div>\n                )}\n              </div>\n\n              {/* Preview Table */}\n              <div className=\"border rounded-lg overflow-hidden\">\n                <ScrollArea className=\"h-[300px]\">\n                  <table className=\"w-full text-sm\">\n                    <thead className=\"bg-muted sticky top-0\">\n                      <tr>\n                        <th className=\"p-2 text-left font-medium\">Row</th>\n                        <th className=\"p-2 text-left font-medium\">Status</th>\n                        {headers.slice(0, 4).map((header, i) => (\n                          <th key={i} className=\"p-2 text-left font-medium capitalize\">\n                            {header}\n                          </th>\n                        ))}\n                        {headers.length > 4 && (\n                          <th className=\"p-2 text-left font-medium\">...</th>\n                        )}\n                      </tr>\n                    </thead>\n                    <tbody>\n                      {parsedData.slice(0, 50).map((row, index) => (\n                        <tr \n                          key={index} \n                          className={`border-t ${row.errors.length > 0 ? \"bg-destructive/5\" : \"\"}`}\n                        >\n                          <td className=\"p-2\">{row.rowNumber}</td>\n                          <td className=\"p-2\">\n                            {row.errors.length > 0 ? (\n                              <Badge variant=\"destructive\" className=\"text-xs\">\n                                {row.errors[0]}\n                              </Badge>\n                            ) : (\n                              <Badge variant=\"outline\" className=\"text-xs text-green-600 border-green-600\">\n                                Valid\n                              </Badge>\n                            )}\n                          </td>\n                          {headers.slice(0, 4).map((header, i) => (\n                            <td key={i} className=\"p-2 truncate max-w-[150px]\">\n                              {row.data[header] || \"-\"}\n                            </td>\n                          ))}\n                          {headers.length > 4 && (\n                            <td className=\"p-2 text-muted-foreground\">\n                              +{headers.length - 4} more\n                            </td>\n                          )}\n                        </tr>\n                      ))}\n                    </tbody>\n                  </table>\n                  {parsedData.length > 50 && (\n                    <p className=\"p-2 text-center text-sm text-muted-foreground border-t\">\n                      Showing first 50 of {parsedData.length} rows\n                    </p>\n                  )}\n                </ScrollArea>\n              </div>\n\n              {/* Import Actions */}\n              <div className=\"flex gap-3 justify-end\">\n                <Button variant=\"outline\" onClick={resetState}>\n                  Cancel\n                </Button>\n                <Button \n                  onClick={handleImport}\n                  disabled={validRows.length === 0 || importMutation.isPending}\n                  data-testid={`button-import-${type}`}\n                >\n                  {importMutation.isPending ? (\n                    <>\n                      <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                      Importing...\n                    </>\n                  ) : (\n                    <>\n                      <Upload className=\"h-4 w-4 mr-2\" />\n                      Import {validRows.length} {type}\n                    </>\n                  )}\n                </Button>\n              </div>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nexport default function Import() {\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"page-import\">\n      <div>\n        <h1 className=\"text-2xl font-semibold\">Import Data</h1>\n        <p className=\"text-muted-foreground\">\n          Bulk import your existing clients, leads, jobs, and products from CSV files\n        </p>\n      </div>\n\n      <Tabs defaultValue=\"clients\" className=\"w-full\">\n        <TabsList className=\"grid w-full grid-cols-4 max-w-lg\">\n          <TabsTrigger value=\"clients\" data-testid=\"tab-import-clients\">\n            <Users className=\"h-4 w-4 mr-2\" />\n            Clients\n          </TabsTrigger>\n          <TabsTrigger value=\"leads\" data-testid=\"tab-import-leads\">\n            <ClipboardList className=\"h-4 w-4 mr-2\" />\n            Leads\n          </TabsTrigger>\n          <TabsTrigger value=\"jobs\" data-testid=\"tab-import-jobs\">\n            <Briefcase className=\"h-4 w-4 mr-2\" />\n            Jobs\n          </TabsTrigger>\n          <TabsTrigger value=\"products\" data-testid=\"tab-import-products\">\n            <Package className=\"h-4 w-4 mr-2\" />\n            Products\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"clients\" className=\"mt-6\">\n          <ImportTab type=\"clients\" template={clientTemplate} icon={Users} />\n        </TabsContent>\n\n        <TabsContent value=\"leads\" className=\"mt-6\">\n          <ImportTab type=\"leads\" template={leadTemplate} icon={ClipboardList} />\n        </TabsContent>\n\n        <TabsContent value=\"jobs\" className=\"mt-6\">\n          <ImportTab type=\"jobs\" template={jobTemplate} icon={Briefcase} />\n        </TabsContent>\n\n        <TabsContent value=\"products\" className=\"mt-6\">\n          <ImportTab type=\"products\" template={productsTemplate} icon={Package} />\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":17654,"size_tokens":null},"client/src/pages/Unauthorized.tsx":{"content":"import { Link } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { ShieldX, Home } from \"lucide-react\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { getDefaultRoute, type UserRole } from \"@/lib/permissions\";\n\nexport default function Unauthorized() {\n  const { user } = useAuth();\n  const defaultRoute = getDefaultRoute(user?.role as UserRole | undefined);\n\n  return (\n    <div className=\"flex items-center justify-center min-h-screen bg-background p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"text-center\">\n          <div className=\"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-destructive/10\">\n            <ShieldX className=\"h-8 w-8 text-destructive\" />\n          </div>\n          <CardTitle className=\"text-2xl\" data-testid=\"text-unauthorized-title\">\n            Access Denied\n          </CardTitle>\n          <CardDescription data-testid=\"text-unauthorized-message\">\n            You don't have permission to access this page. Please contact your administrator if you believe this is an error.\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"flex justify-center\">\n          <Link href={defaultRoute}>\n            <Button data-testid=\"button-go-home\">\n              <Home className=\"mr-2 h-4 w-4\" />\n              Return to Dashboard\n            </Button>\n          </Link>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":1554,"size_tokens":null},"client/src/components/jobs/JobKanbanCard.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { JobStageProgress } from \"./JobStageProgress\";\nimport { \n  Calendar, \n  AlertTriangle, \n  Timer,\n  User\n} from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface KanbanJobData {\n  id: string;\n  jobNumber: string;\n  clientName: string;\n  siteAddress: string;\n  jobType: string;\n  hasGate: boolean;\n  totalAmount: string;\n  assignedInstallerName?: string;\n  scheduledStartDate?: string;\n  isDelayed: boolean;\n  isWaitingOnClient: boolean;\n  stagesCompleted: number[];\n  status: string;\n}\n\ninterface JobKanbanCardProps {\n  job: KanbanJobData;\n  onClick?: () => void;\n}\n\nfunction isThisWeek(dateString?: string): boolean {\n  if (!dateString) return false;\n  const date = new Date(dateString);\n  const now = new Date();\n  const startOfWeek = new Date(now);\n  startOfWeek.setDate(now.getDate() - now.getDay());\n  startOfWeek.setHours(0, 0, 0, 0);\n  const endOfWeek = new Date(startOfWeek);\n  endOfWeek.setDate(startOfWeek.getDate() + 7);\n  return date >= startOfWeek && date < endOfWeek;\n}\n\nfunction formatCurrency(amount: string | number): string {\n  const value = typeof amount === \"string\" ? parseFloat(amount) : amount;\n  return new Intl.NumberFormat(\"en-AU\", {\n    style: \"currency\",\n    currency: \"AUD\",\n    minimumFractionDigits: 0,\n    maximumFractionDigits: 0,\n  }).format(value);\n}\n\nexport function JobKanbanCard({ job, onClick }: JobKanbanCardProps) {\n  const isSupplyInstall = job.jobType === \"supply_install\";\n  const thisWeek = isThisWeek(job.scheduledStartDate);\n  \n  const borderColor = isSupplyInstall \n    ? \"border-l-4 border-l-yellow-500\" \n    : \"border-l-4 border-l-green-500\";\n\n  return (\n    <Card \n      className={cn(\n        \"cursor-pointer hover-elevate transition-all\",\n        borderColor\n      )}\n      onClick={onClick}\n      data-testid={`kanban-card-${job.id}`}\n    >\n      <CardContent className=\"p-3 space-y-2\">\n        <div className=\"flex items-start justify-between gap-2\">\n          <div className=\"flex-1 min-w-0\">\n            <p className=\"font-mono text-xs text-muted-foreground\" data-testid=\"kanban-job-number\">\n              {job.jobNumber}\n            </p>\n            <p className=\"font-medium text-sm break-words\" data-testid=\"kanban-client-name\">\n              {job.clientName}\n            </p>\n          </div>\n          <Badge \n            variant=\"secondary\" \n            className=\"text-xs shrink-0\"\n            data-testid=\"kanban-job-type\"\n          >\n            {isSupplyInstall ? \"S+I\" : \"Supply\"}\n          </Badge>\n        </div>\n\n        <p className=\"text-xs text-muted-foreground break-words\" data-testid=\"kanban-address\">\n          {job.siteAddress}\n        </p>\n\n        <div className=\"flex items-center justify-between gap-2 flex-wrap\">\n          {job.assignedInstallerName ? (\n            <div className=\"flex items-center gap-1 text-xs text-muted-foreground\">\n              <User className=\"h-3 w-3 shrink-0\" />\n              <span className=\"break-words\">{job.assignedInstallerName}</span>\n            </div>\n          ) : (\n            <span className=\"text-xs text-muted-foreground italic\">Unassigned</span>\n          )}\n          <span className=\"font-semibold text-sm shrink-0\" data-testid=\"kanban-amount\">\n            {formatCurrency(job.totalAmount)}\n          </span>\n        </div>\n\n        <div className=\"flex flex-wrap items-center gap-1.5\">\n          {thisWeek && (\n            <Badge \n              variant=\"outline\" \n              className=\"text-xs py-0 px-1.5 bg-blue-50 text-blue-700 border-blue-200\"\n              data-testid=\"badge-this-week\"\n            >\n              <Calendar className=\"h-3 w-3 mr-1\" />\n              THIS WEEK\n            </Badge>\n          )}\n          {job.isDelayed && (\n            <Badge \n              className=\"text-xs py-0 px-1.5 bg-red-600 text-white border-red-600\"\n              data-testid=\"badge-delayed\"\n            >\n              <AlertTriangle className=\"h-3 w-3 mr-1\" />\n              DELAYED\n            </Badge>\n          )}\n          {job.isWaitingOnClient && (\n            <Badge \n              variant=\"outline\" \n              className=\"text-xs py-0 px-1.5 bg-amber-50 text-amber-700 border-amber-200\"\n              data-testid=\"badge-waiting\"\n            >\n              <Timer className=\"h-3 w-3 mr-1\" />\n              Waiting On Client\n            </Badge>\n          )}\n        </div>\n\n        <div className=\"pt-1 border-t\">\n          <JobStageProgress\n            jobType={job.jobType}\n            hasGate={job.hasGate}\n            stagesCompleted={job.stagesCompleted}\n            size=\"sm\"\n          />\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":4718,"size_tokens":null},"client/src/pages/DashboardBuilder.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { Card, CardHeader, CardTitle, CardContent, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { \n  Plus, \n  Save, \n  Trash2, \n  Eye, \n  Edit2, \n  GripVertical, \n  LayoutGrid, \n  BarChart3, \n  LineChart, \n  PieChart,\n  Table,\n  Gauge,\n  ListChecks,\n  CheckCircle2,\n  XCircle,\n  Loader2,\n  Send,\n  Copy\n} from \"lucide-react\";\nimport type { DashboardWidget, RoleDashboardLayout, DashboardWidgetInstance } from \"@shared/schema\";\n\nconst ROLES = [\n  { value: \"admin\", label: \"Administrator\" },\n  { value: \"sales\", label: \"Sales\" },\n  { value: \"scheduler\", label: \"Scheduler\" },\n  { value: \"production_manager\", label: \"Production Manager\" },\n  { value: \"warehouse\", label: \"Warehouse\" },\n  { value: \"installer\", label: \"Installer\" },\n  { value: \"trade_client\", label: \"Trade Client\" },\n];\n\nconst WIDGET_ICONS: Record<string, typeof BarChart3> = {\n  \"bar_chart\": BarChart3,\n  \"line_chart\": LineChart,\n  \"pie_chart\": PieChart,\n  \"table\": Table,\n  \"kpi\": Gauge,\n  \"list\": ListChecks,\n};\n\nconst CATEGORY_COLORS: Record<string, string> = {\n  \"kpi\": \"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200\",\n  \"chart\": \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\",\n  \"table\": \"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200\",\n  \"analytics\": \"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200\",\n};\n\ninterface EnrichedWidgetInstance {\n  id: string;\n  layoutId: string;\n  widgetId: string;\n  positionX: number;\n  positionY: number;\n  width: number;\n  height: number;\n  config: Record<string, any> | null;\n  title?: string | null;\n  createdAt?: Date;\n  widget?: DashboardWidget;\n}\n\ninterface LayoutWithInstances extends RoleDashboardLayout {\n  instances: EnrichedWidgetInstance[];\n}\n\nexport default function DashboardBuilder() {\n  const [selectedRole, setSelectedRole] = useState<string>(\"admin\");\n  const [selectedLayoutId, setSelectedLayoutId] = useState<string | null>(null);\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [isAddWidgetDialogOpen, setIsAddWidgetDialogOpen] = useState(false);\n  const [newLayoutName, setNewLayoutName] = useState(\"\");\n  const [newLayoutDescription, setNewLayoutDescription] = useState(\"\");\n  const [editLayoutData, setEditLayoutData] = useState<{ id: string; name: string; description: string } | null>(null);\n  const [layoutInstances, setLayoutInstances] = useState<EnrichedWidgetInstance[]>([]);\n  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);\n  \n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const { data: widgets = [], isLoading: widgetsLoading } = useQuery<DashboardWidget[]>({\n    queryKey: [\"/api/dashboard-builder/widgets\"],\n  });\n\n  const { data: layouts = [], isLoading: layoutsLoading } = useQuery<RoleDashboardLayout[]>({\n    queryKey: [\"/api/dashboard-builder/layouts\"],\n  });\n\n  const { data: selectedLayout, isLoading: layoutLoading } = useQuery<LayoutWithInstances>({\n    queryKey: [\"/api/dashboard-builder/layouts\", selectedLayoutId],\n    enabled: !!selectedLayoutId,\n  });\n\n  const createLayoutMutation = useMutation({\n    mutationFn: async (data: { name: string; description: string; role: string }) => {\n      return apiRequest(\"POST\", \"/api/dashboard-builder/layouts\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard-builder/layouts\"] });\n      setIsCreateDialogOpen(false);\n      setNewLayoutName(\"\");\n      setNewLayoutDescription(\"\");\n      toast({ title: \"Layout created\", description: \"The dashboard layout has been created successfully.\" });\n    },\n    onError: (error) => {\n      toast({ title: \"Error\", description: \"Failed to create layout.\", variant: \"destructive\" });\n    },\n  });\n\n  const updateLayoutMutation = useMutation({\n    mutationFn: async (data: { id: string; name: string; description: string }) => {\n      return apiRequest(\"PATCH\", `/api/dashboard-builder/layouts/${data.id}`, { name: data.name, description: data.description });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard-builder/layouts\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard-builder/layouts\", selectedLayoutId] });\n      setIsEditDialogOpen(false);\n      setEditLayoutData(null);\n      toast({ title: \"Layout updated\", description: \"The dashboard layout has been updated successfully.\" });\n    },\n    onError: (error) => {\n      toast({ title: \"Error\", description: \"Failed to update layout.\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteLayoutMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/dashboard-builder/layouts/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard-builder/layouts\"] });\n      setSelectedLayoutId(null);\n      setLayoutInstances([]);\n      toast({ title: \"Layout deleted\", description: \"The dashboard layout has been deleted.\" });\n    },\n    onError: (error) => {\n      toast({ title: \"Error\", description: \"Failed to delete layout.\", variant: \"destructive\" });\n    },\n  });\n\n  const publishLayoutMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"POST\", `/api/dashboard-builder/layouts/${id}/publish`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard-builder/layouts\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard-builder/layouts\", selectedLayoutId] });\n      toast({ title: \"Layout published\", description: \"The dashboard layout is now active for this role.\" });\n    },\n    onError: (error) => {\n      toast({ title: \"Error\", description: \"Failed to publish layout.\", variant: \"destructive\" });\n    },\n  });\n\n  const saveInstancesMutation = useMutation({\n    mutationFn: async (data: { layoutId: string; instances: any[] }) => {\n      return apiRequest(\"PUT\", `/api/dashboard-builder/layouts/${data.layoutId}/instances`, { instances: data.instances });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard-builder/layouts\", selectedLayoutId] });\n      setHasUnsavedChanges(false);\n      toast({ title: \"Layout saved\", description: \"Widget positions have been saved.\" });\n    },\n    onError: (error) => {\n      toast({ title: \"Error\", description: \"Failed to save layout.\", variant: \"destructive\" });\n    },\n  });\n\n  const filteredLayouts = layouts.filter(l => l.role === selectedRole);\n\n  const handleSelectLayout = (layoutId: string) => {\n    if (hasUnsavedChanges) {\n      if (!confirm(\"You have unsaved changes. Are you sure you want to switch layouts?\")) {\n        return;\n      }\n    }\n    setSelectedLayoutId(layoutId);\n    setHasUnsavedChanges(false);\n  };\n\n  const handleCreateLayout = () => {\n    createLayoutMutation.mutate({\n      name: newLayoutName,\n      description: newLayoutDescription,\n      role: selectedRole,\n    });\n  };\n\n  const handleEditLayout = () => {\n    if (!editLayoutData) return;\n    updateLayoutMutation.mutate(editLayoutData);\n  };\n\n  const handleAddWidget = (widget: DashboardWidget) => {\n    if (!selectedLayoutId) return;\n\n    const maxY = layoutInstances.reduce((max, inst) => Math.max(max, inst.positionY + inst.height), 0);\n    \n    const newInstance: EnrichedWidgetInstance = {\n      id: `temp-${Date.now()}`,\n      layoutId: selectedLayoutId,\n      widgetId: widget.id,\n      positionX: 0,\n      positionY: maxY,\n      width: widget.defaultWidth,\n      height: widget.defaultHeight,\n      config: {},\n      widget: widget,\n    };\n\n    setLayoutInstances([...layoutInstances, newInstance]);\n    setHasUnsavedChanges(true);\n    setIsAddWidgetDialogOpen(false);\n  };\n\n  const handleRemoveWidget = (instanceId: string) => {\n    setLayoutInstances(layoutInstances.filter(i => i.id !== instanceId));\n    setHasUnsavedChanges(true);\n  };\n\n  const handleMoveWidget = (instanceId: string, direction: \"up\" | \"down\") => {\n    const index = layoutInstances.findIndex(i => i.id === instanceId);\n    if (index === -1) return;\n\n    const newInstances = [...layoutInstances];\n    if (direction === \"up\" && index > 0) {\n      [newInstances[index], newInstances[index - 1]] = [newInstances[index - 1], newInstances[index]];\n    } else if (direction === \"down\" && index < newInstances.length - 1) {\n      [newInstances[index], newInstances[index + 1]] = [newInstances[index + 1], newInstances[index]];\n    }\n\n    newInstances.forEach((inst, i) => {\n      inst.positionY = i;\n    });\n\n    setLayoutInstances(newInstances);\n    setHasUnsavedChanges(true);\n  };\n\n  const handleSaveLayout = () => {\n    if (!selectedLayoutId) return;\n    \n    const instancesData = layoutInstances.map((inst, index) => ({\n      widgetId: inst.widgetId,\n      positionX: inst.positionX,\n      positionY: index,\n      width: inst.width,\n      height: inst.height,\n      config: inst.config || {},\n    }));\n\n    saveInstancesMutation.mutate({\n      layoutId: selectedLayoutId,\n      instances: instancesData,\n    });\n  };\n\n  if (widgetsLoading || layoutsLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-full\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold\" data-testid=\"text-page-title\">Dashboard Builder</h1>\n          <p className=\"text-muted-foreground\">Configure role-specific dashboards with drag-and-drop widgets</p>\n        </div>\n      </div>\n\n      <div className=\"flex flex-wrap gap-4 items-center\">\n        <div className=\"flex items-center gap-2\">\n          <Label htmlFor=\"role-select\">Role:</Label>\n          <Select value={selectedRole} onValueChange={(value) => {\n            if (hasUnsavedChanges) {\n              if (!confirm(\"You have unsaved changes. Are you sure you want to switch roles?\")) {\n                return;\n              }\n            }\n            setSelectedRole(value);\n            setSelectedLayoutId(null);\n            setLayoutInstances([]);\n            setHasUnsavedChanges(false);\n          }}>\n            <SelectTrigger className=\"w-48\" data-testid=\"select-role\">\n              <SelectValue placeholder=\"Select role\" />\n            </SelectTrigger>\n            <SelectContent>\n              {ROLES.map((role) => (\n                <SelectItem key={role.value} value={role.value}>\n                  {role.label}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n\n        <div className=\"flex items-center gap-2\">\n          <Label htmlFor=\"layout-select\">Layout:</Label>\n          <Select \n            value={selectedLayoutId || \"\"} \n            onValueChange={handleSelectLayout}\n          >\n            <SelectTrigger className=\"w-64\" data-testid=\"select-layout\">\n              <SelectValue placeholder=\"Select or create a layout\" />\n            </SelectTrigger>\n            <SelectContent>\n              {filteredLayouts.map((layout) => (\n                <SelectItem key={layout.id} value={layout.id}>\n                  <div className=\"flex items-center gap-2\">\n                    {layout.name}\n                    {layout.isPublished && (\n                      <Badge variant=\"secondary\" className=\"ml-2\">Published</Badge>\n                    )}\n                  </div>\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n\n        <Button \n          onClick={() => setIsCreateDialogOpen(true)} \n          variant=\"outline\"\n          data-testid=\"button-create-layout\"\n        >\n          <Plus className=\"h-4 w-4 mr-2\" />\n          New Layout\n        </Button>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-4 gap-6\">\n        <div className=\"lg:col-span-1\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-lg flex items-center gap-2\">\n                <LayoutGrid className=\"h-5 w-5\" />\n                Widget Library\n              </CardTitle>\n              <CardDescription>\n                Drag widgets to add them to the layout\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-3 max-h-[calc(100vh-400px)] overflow-y-auto\">\n              {widgets.length === 0 ? (\n                <p className=\"text-sm text-muted-foreground text-center py-4\">\n                  No widgets available\n                </p>\n              ) : (\n                Object.entries(\n                  widgets.reduce((acc, widget) => {\n                    if (!acc[widget.category]) acc[widget.category] = [];\n                    acc[widget.category].push(widget);\n                    return acc;\n                  }, {} as Record<string, DashboardWidget[]>)\n                ).map(([category, categoryWidgets]) => (\n                  <div key={category} className=\"space-y-2\">\n                    <h4 className=\"text-sm font-medium capitalize text-muted-foreground\">{category}</h4>\n                    {categoryWidgets.map((widget) => {\n                      const Icon = WIDGET_ICONS[widget.widgetType] || LayoutGrid;\n                      return (\n                        <div\n                          key={widget.id}\n                          className=\"p-3 rounded-md border bg-card hover-elevate cursor-pointer\"\n                          onClick={() => {\n                            if (selectedLayoutId) {\n                              handleAddWidget(widget);\n                            } else {\n                              toast({\n                                title: \"Select a layout\",\n                                description: \"Please select or create a layout first.\",\n                                variant: \"destructive\",\n                              });\n                            }\n                          }}\n                          data-testid={`widget-${widget.id}`}\n                        >\n                          <div className=\"flex items-start gap-3\">\n                            <Icon className=\"h-5 w-5 text-primary mt-0.5\" />\n                            <div className=\"flex-1 min-w-0\">\n                              <p className=\"text-sm font-medium truncate\">{widget.name}</p>\n                              <p className=\"text-xs text-muted-foreground line-clamp-2\">{widget.description}</p>\n                              <div className=\"flex items-center gap-2 mt-1\">\n                                <Badge variant=\"outline\" className=\"text-xs\">\n                                  {widget.defaultWidth}x{widget.defaultHeight}\n                                </Badge>\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </div>\n                ))\n              )}\n            </CardContent>\n          </Card>\n        </div>\n\n        <div className=\"lg:col-span-3\">\n          {selectedLayoutId && selectedLayout ? (\n            <Card>\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      {selectedLayout.name}\n                      {selectedLayout.isPublished && (\n                        <Badge variant=\"secondary\">\n                          <CheckCircle2 className=\"h-3 w-3 mr-1\" />\n                          Published\n                        </Badge>\n                      )}\n                      {hasUnsavedChanges && (\n                        <Badge variant=\"outline\" className=\"text-orange-600 border-orange-300\">\n                          Unsaved Changes\n                        </Badge>\n                      )}\n                    </CardTitle>\n                    <CardDescription>\n                      {selectedLayout.description || \"No description\"}\n                    </CardDescription>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => {\n                        setEditLayoutData({\n                          id: selectedLayout.id,\n                          name: selectedLayout.name,\n                          description: selectedLayout.description || \"\",\n                        });\n                        setIsEditDialogOpen(true);\n                      }}\n                      data-testid=\"button-edit-layout\"\n                    >\n                      <Edit2 className=\"h-4 w-4 mr-2\" />\n                      Edit\n                    </Button>\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => {\n                        if (confirm(\"Are you sure you want to delete this layout?\")) {\n                          deleteLayoutMutation.mutate(selectedLayoutId);\n                        }\n                      }}\n                      data-testid=\"button-delete-layout\"\n                    >\n                      <Trash2 className=\"h-4 w-4 mr-2\" />\n                      Delete\n                    </Button>\n                    {!selectedLayout.isPublished && (\n                      <Button\n                        variant=\"default\"\n                        size=\"sm\"\n                        onClick={() => publishLayoutMutation.mutate(selectedLayoutId)}\n                        disabled={publishLayoutMutation.isPending}\n                        data-testid=\"button-publish-layout\"\n                      >\n                        <Send className=\"h-4 w-4 mr-2\" />\n                        Publish\n                      </Button>\n                    )}\n                    <Button\n                      onClick={handleSaveLayout}\n                      disabled={!hasUnsavedChanges || saveInstancesMutation.isPending}\n                      data-testid=\"button-save-layout\"\n                    >\n                      {saveInstancesMutation.isPending ? (\n                        <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                      ) : (\n                        <Save className=\"h-4 w-4 mr-2\" />\n                      )}\n                      Save Layout\n                    </Button>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent>\n                {layoutLoading ? (\n                  <div className=\"flex items-center justify-center py-12\">\n                    <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n                  </div>\n                ) : layoutInstances.length === 0 && selectedLayout.instances?.length === 0 ? (\n                  <div className=\"text-center py-12 border-2 border-dashed rounded-lg\">\n                    <LayoutGrid className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                    <h3 className=\"text-lg font-medium mb-2\">No widgets added</h3>\n                    <p className=\"text-muted-foreground mb-4\">\n                      Click on widgets from the library to add them to this layout\n                    </p>\n                  </div>\n                ) : (\n                  <div className=\"space-y-3\">\n                    {(layoutInstances.length > 0 ? layoutInstances : selectedLayout.instances || []).map((instance, index) => {\n                      const widget = instance.widget || widgets.find(w => w.id === instance.widgetId);\n                      const Icon = WIDGET_ICONS[widget?.widgetType || \"kpi\"] || LayoutGrid;\n                      \n                      if (!widget) return null;\n\n                      return (\n                        <div\n                          key={instance.id}\n                          className=\"flex items-center gap-3 p-4 rounded-lg border bg-card hover-elevate group\"\n                          data-testid={`widget-instance-${instance.id}`}\n                        >\n                          <div className=\"flex flex-col gap-1\">\n                            <Button\n                              variant=\"ghost\"\n                              size=\"icon\"\n                              className=\"h-6 w-6\"\n                              onClick={() => handleMoveWidget(instance.id, \"up\")}\n                              disabled={index === 0}\n                            >\n                              <GripVertical className=\"h-4 w-4 rotate-90\" />\n                            </Button>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"icon\"\n                              className=\"h-6 w-6\"\n                              onClick={() => handleMoveWidget(instance.id, \"down\")}\n                              disabled={index === layoutInstances.length - 1}\n                            >\n                              <GripVertical className=\"h-4 w-4 rotate-90\" />\n                            </Button>\n                          </div>\n                          \n                          <Icon className=\"h-8 w-8 text-primary\" />\n                          \n                          <div className=\"flex-1\">\n                            <p className=\"font-medium\">{widget.name}</p>\n                            <p className=\"text-sm text-muted-foreground\">{widget.description}</p>\n                            <div className=\"flex items-center gap-2 mt-1\">\n                              <Badge className={CATEGORY_COLORS[widget.category] || \"\"}>\n                                {widget.category}\n                              </Badge>\n                              <Badge variant=\"outline\">\n                                {instance.width}x{instance.height} grid\n                              </Badge>\n                            </div>\n                          </div>\n\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            className=\"opacity-0 group-hover:opacity-100 transition-opacity\"\n                            onClick={() => handleRemoveWidget(instance.id)}\n                            data-testid={`button-remove-widget-${instance.id}`}\n                          >\n                            <Trash2 className=\"h-4 w-4 text-destructive\" />\n                          </Button>\n                        </div>\n                      );\n                    })}\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          ) : (\n            <Card>\n              <CardContent className=\"py-12\">\n                <div className=\"text-center\">\n                  <LayoutGrid className=\"h-16 w-16 mx-auto text-muted-foreground mb-4\" />\n                  <h3 className=\"text-xl font-medium mb-2\">Select a Layout</h3>\n                  <p className=\"text-muted-foreground mb-4\">\n                    Choose an existing layout or create a new one to start building\n                  </p>\n                  <Button \n                    onClick={() => setIsCreateDialogOpen(true)}\n                    data-testid=\"button-create-layout-empty\"\n                  >\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Create New Layout\n                  </Button>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n        </div>\n      </div>\n\n      <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Create New Layout</DialogTitle>\n            <DialogDescription>\n              Create a new dashboard layout for the {ROLES.find(r => r.value === selectedRole)?.label} role.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"layout-name\">Layout Name</Label>\n              <Input\n                id=\"layout-name\"\n                value={newLayoutName}\n                onChange={(e) => setNewLayoutName(e.target.value)}\n                placeholder=\"e.g., Sales Dashboard v2\"\n                data-testid=\"input-layout-name\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"layout-description\">Description (optional)</Label>\n              <Textarea\n                id=\"layout-description\"\n                value={newLayoutDescription}\n                onChange={(e) => setNewLayoutDescription(e.target.value)}\n                placeholder=\"Describe what this layout is for...\"\n                data-testid=\"input-layout-description\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsCreateDialogOpen(false)}>\n              Cancel\n            </Button>\n            <Button \n              onClick={handleCreateLayout}\n              disabled={!newLayoutName.trim() || createLayoutMutation.isPending}\n              data-testid=\"button-confirm-create-layout\"\n            >\n              {createLayoutMutation.isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n              Create Layout\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Edit Layout</DialogTitle>\n            <DialogDescription>\n              Update the layout name and description.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-layout-name\">Layout Name</Label>\n              <Input\n                id=\"edit-layout-name\"\n                value={editLayoutData?.name || \"\"}\n                onChange={(e) => setEditLayoutData(prev => prev ? { ...prev, name: e.target.value } : null)}\n                placeholder=\"e.g., Sales Dashboard v2\"\n                data-testid=\"input-edit-layout-name\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-layout-description\">Description (optional)</Label>\n              <Textarea\n                id=\"edit-layout-description\"\n                value={editLayoutData?.description || \"\"}\n                onChange={(e) => setEditLayoutData(prev => prev ? { ...prev, description: e.target.value } : null)}\n                placeholder=\"Describe what this layout is for...\"\n                data-testid=\"input-edit-layout-description\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsEditDialogOpen(false)}>\n              Cancel\n            </Button>\n            <Button \n              onClick={handleEditLayout}\n              disabled={!editLayoutData?.name?.trim() || updateLayoutMutation.isPending}\n              data-testid=\"button-confirm-edit-layout\"\n            >\n              {updateLayoutMutation.isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n              Save Changes\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":28106,"size_tokens":null},"client/src/components/jobs/ViewToggle.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { List, LayoutGrid } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ntype ViewMode = \"list\" | \"kanban\";\n\ninterface ViewToggleProps {\n  viewMode: ViewMode;\n  onViewModeChange: (mode: ViewMode) => void;\n}\n\nexport function ViewToggle({ viewMode, onViewModeChange }: ViewToggleProps) {\n  return (\n    <div className=\"flex border rounded-md\">\n      <Button\n        variant=\"ghost\"\n        size=\"sm\"\n        className={cn(viewMode === \"list\" && \"bg-muted\")}\n        onClick={() => onViewModeChange(\"list\")}\n        data-testid=\"button-view-list\"\n      >\n        <List className=\"h-4 w-4\" />\n      </Button>\n      <Button\n        variant=\"ghost\"\n        size=\"sm\"\n        className={cn(viewMode === \"kanban\" && \"bg-muted\")}\n        onClick={() => onViewModeChange(\"kanban\")}\n        data-testid=\"button-view-kanban\"\n      >\n        <LayoutGrid className=\"h-4 w-4\" />\n      </Button>\n    </div>\n  );\n}\n","path":null,"size_bytes":958,"size_tokens":null},"client/src/components/jobs/JobKanbanBoard.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { JobKanbanCard } from \"./JobKanbanCard\";\nimport { cn } from \"@/lib/utils\";\nimport type { Job, Client, User, KanbanColumn as DBKanbanColumn } from \"@shared/schema\";\n\ninterface KanbanColumn {\n  id: string;\n  title: string;\n  statuses: string[];\n  defaultStatus: string;\n  color: string;\n}\n\nconst DEFAULT_KANBAN_COLUMNS: KanbanColumn[] = [\n  {\n    id: \"accepted\",\n    title: \"New Jobs\",\n    statuses: [\"accepted\", \"awaiting_deposit\"],\n    defaultStatus: \"accepted\",\n    color: \"bg-slate-100 dark:bg-slate-800\",\n  },\n  {\n    id: \"pipeline\",\n    title: \"Pipeline\",\n    statuses: [\"deposit_paid\", \"ready_for_production\"],\n    defaultStatus: \"deposit_paid\",\n    color: \"bg-blue-50 dark:bg-blue-950\",\n  },\n  {\n    id: \"production\",\n    title: \"Production\",\n    statuses: [\"manufacturing_posts\", \"manufacturing_panels\", \"manufacturing_gates\", \"qa_check\"],\n    defaultStatus: \"manufacturing_posts\",\n    color: \"bg-purple-50 dark:bg-purple-950\",\n  },\n  {\n    id: \"scheduling\",\n    title: \"Ready to Schedule\",\n    statuses: [\"ready_for_scheduling\"],\n    defaultStatus: \"ready_for_scheduling\",\n    color: \"bg-amber-50 dark:bg-amber-950\",\n  },\n  {\n    id: \"scheduled\",\n    title: \"Scheduled\",\n    statuses: [\"scheduled\", \"install_posts\", \"install_panels\", \"install_gates\"],\n    defaultStatus: \"scheduled\",\n    color: \"bg-green-50 dark:bg-green-950\",\n  },\n  {\n    id: \"complete\",\n    title: \"Completing\",\n    statuses: [\"install_complete\", \"awaiting_final_payment\", \"paid_in_full\"],\n    defaultStatus: \"install_complete\",\n    color: \"bg-emerald-50 dark:bg-emerald-950\",\n  },\n];\n\nfunction mapDbColumnsToKanban(dbColumns: DBKanbanColumn[]): KanbanColumn[] {\n  return dbColumns\n    .filter(col => col.isActive)\n    .sort((a, b) => a.sortOrder - b.sortOrder)\n    .map(col => ({\n      id: col.id.toString(),\n      title: col.title,\n      statuses: col.statuses as string[],\n      defaultStatus: col.defaultStatus,\n      color: col.color,\n    }));\n}\n\ninterface JobKanbanBoardProps {\n  jobs: Job[];\n  clients: Client[];\n  users: User[];\n  isLoading: boolean;\n  isUpdating?: boolean;\n  onJobClick: (job: Job) => void;\n  onJobStatusChange?: (jobId: string, newStatus: string) => void;\n}\n\nexport function JobKanbanBoard({ \n  jobs, \n  clients, \n  users, \n  isLoading, \n  isUpdating = false,\n  onJobClick,\n  onJobStatusChange \n}: JobKanbanBoardProps) {\n  const [draggedJob, setDraggedJob] = useState<Job | null>(null);\n  const [dragOverColumn, setDragOverColumn] = useState<string | null>(null);\n  \n  const { data: dbColumns } = useQuery<DBKanbanColumn[]>({\n    queryKey: [\"/api/kanban-columns\"],\n  });\n  \n  const kanbanColumns = dbColumns && dbColumns.length > 0 \n    ? mapDbColumnsToKanban(dbColumns) \n    : DEFAULT_KANBAN_COLUMNS;\n  \n  const canDrag = !isUpdating;\n\n  const getClientName = (clientId: string | null): string => {\n    if (!clientId) return \"Unknown\";\n    const client = clients.find(c => c.id === clientId);\n    return client?.name || \"Unknown\";\n  };\n\n  const getInstallerName = (installerId: string | null): string | undefined => {\n    if (!installerId) return undefined;\n    const user = users.find(u => u.id === installerId);\n    return user ? `${user.firstName} ${user.lastName}` : undefined;\n  };\n\n  const getJobsForColumn = (column: KanbanColumn): Job[] => {\n    return jobs.filter(job => column.statuses.includes(job.status));\n  };\n\n  const handleDragStart = (e: React.DragEvent, job: Job) => {\n    setDraggedJob(job);\n    e.dataTransfer.effectAllowed = \"move\";\n    e.dataTransfer.setData(\"text/plain\", job.id);\n  };\n\n  const handleDragOver = (e: React.DragEvent, columnId: string) => {\n    e.preventDefault();\n    e.dataTransfer.dropEffect = \"move\";\n    setDragOverColumn(columnId);\n  };\n\n  const handleDragLeave = () => {\n    setDragOverColumn(null);\n  };\n\n  const handleDrop = (e: React.DragEvent, column: KanbanColumn) => {\n    e.preventDefault();\n    setDragOverColumn(null);\n    \n    if (draggedJob && onJobStatusChange) {\n      const currentColumn = kanbanColumns.find(col => \n        col.statuses.includes(draggedJob.status)\n      );\n      \n      if (currentColumn?.id !== column.id) {\n        onJobStatusChange(draggedJob.id, column.defaultStatus);\n      }\n    }\n    \n    setDraggedJob(null);\n  };\n\n  const handleDragEnd = () => {\n    setDraggedJob(null);\n    setDragOverColumn(null);\n  };\n\n  const columnCount = kanbanColumns.length;\n  const minWidth = Math.max(1200, columnCount * 200);\n\n  if (isLoading) {\n    return (\n      <div className=\"grid gap-4 p-4 min-w-0\" style={{ gridTemplateColumns: `repeat(${columnCount}, minmax(0, 1fr))` }}>\n        {kanbanColumns.map((column) => (\n          <div key={column.id} className=\"min-w-0\">\n            <Card className=\"h-full\">\n              <CardHeader className=\"pb-2\">\n                <Skeleton className=\"h-6 w-32\" />\n              </CardHeader>\n              <CardContent className=\"space-y-3\">\n                <Skeleton className=\"h-32\" />\n                <Skeleton className=\"h-32\" />\n                <Skeleton className=\"h-32\" />\n              </CardContent>\n            </Card>\n          </div>\n        ))}\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"w-full p-4 overflow-x-auto\" data-testid=\"kanban-board\">\n      <div className=\"grid gap-4\" style={{ gridTemplateColumns: `repeat(${columnCount}, minmax(0, 1fr))`, minWidth: `${minWidth}px` }}>\n        {kanbanColumns.map((column) => {\n          const columnJobs = getJobsForColumn(column);\n          const columnTotal = columnJobs.reduce(\n            (sum, job) => sum + parseFloat(job.totalAmount || \"0\"), \n            0\n          );\n          const isDropTarget = dragOverColumn === column.id;\n\n          return (\n            <div \n              key={column.id} \n              className=\"min-w-0\"\n              data-testid={`kanban-column-${column.id}`}\n              onDragOver={(e) => handleDragOver(e, column.id)}\n              onDragLeave={handleDragLeave}\n              onDrop={(e) => handleDrop(e, column)}\n            >\n              <Card className={cn(\n                \"h-full transition-all duration-200\",\n                column.color,\n                isDropTarget && \"ring-2 ring-primary ring-offset-2\"\n              )}>\n                <CardHeader className=\"pb-2\">\n                  <div className=\"flex items-center justify-between gap-2\">\n                    <CardTitle className=\"text-sm font-medium\">\n                      {column.title}\n                    </CardTitle>\n                    <Badge variant=\"secondary\" className=\"font-normal\">\n                      {columnJobs.length}\n                    </Badge>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground\">\n                    {new Intl.NumberFormat(\"en-AU\", {\n                      style: \"currency\",\n                      currency: \"AUD\",\n                      minimumFractionDigits: 0,\n                    }).format(columnTotal)}\n                  </p>\n                </CardHeader>\n                <CardContent>\n                  <ScrollArea className=\"h-[calc(100vh-16rem)]\">\n                    <div className=\"space-y-3 pr-2\">\n                      {columnJobs.length === 0 ? (\n                        <div className={cn(\n                          \"text-center py-8 text-muted-foreground border-2 border-dashed rounded-lg\",\n                          isDropTarget && \"border-primary bg-primary/5\"\n                        )}>\n                          <p className=\"text-sm\">\n                            {isDropTarget ? \"Drop here\" : \"No jobs\"}\n                          </p>\n                        </div>\n                      ) : (\n                        columnJobs.map((job) => (\n                          <div\n                            key={job.id}\n                            draggable={canDrag}\n                            onDragStart={(e) => canDrag && handleDragStart(e, job)}\n                            onDragEnd={handleDragEnd}\n                            className={cn(\n                              canDrag ? \"cursor-grab active:cursor-grabbing\" : \"cursor-default\",\n                              draggedJob?.id === job.id && \"opacity-50\"\n                            )}\n                          >\n                            <JobKanbanCard\n                              job={{\n                                id: job.id,\n                                jobNumber: job.jobNumber,\n                                clientName: getClientName(job.clientId),\n                                siteAddress: job.siteAddress,\n                                jobType: job.jobType,\n                                hasGate: job.hasGate || false,\n                                totalAmount: job.totalAmount,\n                                assignedInstallerName: getInstallerName(job.assignedInstaller),\n                                scheduledStartDate: job.scheduledStartDate?.toString(),\n                                isDelayed: job.isDelayed || false,\n                                isWaitingOnClient: job.isWaitingOnClient || false,\n                                stagesCompleted: (job.stagesCompleted as number[]) || [],\n                                status: job.status,\n                              }}\n                              onClick={() => onJobClick(job)}\n                            />\n                          </div>\n                        ))\n                      )}\n                    </div>\n                  </ScrollArea>\n                </CardContent>\n              </Card>\n            </div>\n          );\n        })}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":9858,"size_tokens":null},"client/src/components/jobs/JobStageProgress.tsx":{"content":"import { \n  Hammer, \n  Truck, \n  Package, \n  CheckCircle2, \n  ClipboardList,\n  Wrench,\n  DoorOpen\n} from \"lucide-react\";\nimport { Tooltip, TooltipContent, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { cn } from \"@/lib/utils\";\n\nexport type JobStageType = \"supply_install\" | \"supply_install_gate\" | \"supply_only\";\n\nexport interface StageDefinition {\n  id: number;\n  name: string;\n  shortName: string;\n  icon: typeof Hammer;\n}\n\nexport const STAGE_DEFINITIONS: Record<JobStageType, StageDefinition[]> = {\n  supply_install: [\n    { id: 1, name: \"Manufacturing of Posts\", shortName: \"Mfg Posts\", icon: Hammer },\n    { id: 2, name: \"Installation of Posts\", shortName: \"Install Posts\", icon: Wrench },\n    { id: 3, name: \"Manufacturing of Panels\", shortName: \"Mfg Panels\", icon: Hammer },\n    { id: 4, name: \"Installation of Panels\", shortName: \"Install Panels\", icon: Wrench },\n    { id: 5, name: \"Complete\", shortName: \"Complete\", icon: CheckCircle2 },\n  ],\n  supply_install_gate: [\n    { id: 1, name: \"Order PO\", shortName: \"Order PO\", icon: ClipboardList },\n    { id: 2, name: \"Manufacturing of Posts\", shortName: \"Mfg Posts\", icon: Hammer },\n    { id: 3, name: \"Installation of Posts\", shortName: \"Install Posts\", icon: Wrench },\n    { id: 4, name: \"Manufacturing of Panels\", shortName: \"Mfg Panels\", icon: Hammer },\n    { id: 5, name: \"Installation of Panels\", shortName: \"Install Panels\", icon: Wrench },\n    { id: 6, name: \"Manufacturing of Gate\", shortName: \"Mfg Gate\", icon: DoorOpen },\n    { id: 7, name: \"Installation of Gate\", shortName: \"Install Gate\", icon: DoorOpen },\n    { id: 8, name: \"Complete\", shortName: \"Complete\", icon: CheckCircle2 },\n  ],\n  supply_only: [\n    { id: 1, name: \"Manufacturing of Posts\", shortName: \"Mfg Posts\", icon: Hammer },\n    { id: 2, name: \"Client Picked Up Posts\", shortName: \"Pickup Posts\", icon: Package },\n    { id: 3, name: \"Manufacturing of Panels\", shortName: \"Mfg Panels\", icon: Hammer },\n    { id: 4, name: \"Client Picks Up Panels\", shortName: \"Pickup Panels\", icon: Truck },\n  ],\n};\n\nexport function getJobStageType(jobType: string, hasGate: boolean): JobStageType {\n  if (jobType === \"supply_only\") {\n    return \"supply_only\";\n  }\n  return hasGate ? \"supply_install_gate\" : \"supply_install\";\n}\n\ninterface JobStageProgressProps {\n  jobType: string;\n  hasGate: boolean;\n  stagesCompleted: number[];\n  size?: \"sm\" | \"md\";\n  className?: string;\n}\n\nexport function JobStageProgress({ \n  jobType, \n  hasGate, \n  stagesCompleted = [], \n  size = \"sm\",\n  className \n}: JobStageProgressProps) {\n  const stageType = getJobStageType(jobType, hasGate);\n  const stages = STAGE_DEFINITIONS[stageType];\n  \n  const iconSize = size === \"sm\" ? \"h-4 w-4\" : \"h-5 w-5\";\n  const containerGap = size === \"sm\" ? \"gap-1\" : \"gap-2\";\n\n  return (\n    <div \n      className={cn(\"flex items-center\", containerGap, className)}\n      data-testid=\"job-stage-progress\"\n    >\n      {stages.map((stage) => {\n        const isCompleted = stagesCompleted.includes(stage.id);\n        const Icon = stage.icon;\n        \n        return (\n          <Tooltip key={stage.id}>\n            <TooltipTrigger asChild>\n              <div\n                className={cn(\n                  \"flex items-center justify-center rounded-sm p-0.5 transition-colors\",\n                  isCompleted \n                    ? \"text-green-600 dark:text-green-500\" \n                    : \"text-muted-foreground/30\"\n                )}\n                data-testid={`stage-${stage.id}-${isCompleted ? \"completed\" : \"pending\"}`}\n              >\n                <Icon className={iconSize} />\n              </div>\n            </TooltipTrigger>\n            <TooltipContent side=\"top\" className=\"text-xs\">\n              <p className=\"font-medium\">{stage.name}</p>\n              <p className=\"text-muted-foreground\">\n                {isCompleted ? \"Completed\" : \"Pending\"}\n              </p>\n            </TooltipContent>\n          </Tooltip>\n        );\n      })}\n    </div>\n  );\n}\n","path":null,"size_bytes":3965,"size_tokens":null},"client/src/lib/permissions.ts":{"content":"export type UserRole = \n  | \"admin\" \n  | \"sales\" \n  | \"scheduler\" \n  | \"production_manager\" \n  | \"warehouse\" \n  | \"installer\" \n  | \"trade_client\";\n\nexport const allInternalRoles: UserRole[] = [\"admin\", \"sales\", \"scheduler\", \"production_manager\", \"warehouse\", \"installer\"];\nexport const officeRoles: UserRole[] = [\"admin\", \"sales\", \"scheduler\", \"production_manager\"];\n\nexport interface RouteConfig {\n  path: string;\n  allowedRoles: UserRole[];\n}\n\nexport const routePermissions: RouteConfig[] = [\n  { path: \"/\", allowedRoles: allInternalRoles },\n  { path: \"/business-dashboard\", allowedRoles: allInternalRoles },\n  { path: \"/leads\", allowedRoles: allInternalRoles },\n  { path: \"/quotes\", allowedRoles: allInternalRoles },\n  { path: \"/jobs\", allowedRoles: allInternalRoles },\n  { path: \"/clients\", allowedRoles: allInternalRoles },\n  { path: \"/production\", allowedRoles: allInternalRoles },\n  { path: \"/schedule\", allowedRoles: allInternalRoles },\n  { path: \"/inventory\", allowedRoles: allInternalRoles },\n  { path: \"/financial\", allowedRoles: [\"admin\", \"scheduler\", \"production_manager\"] },\n  { path: \"/payments\", allowedRoles: [\"admin\"] },\n  { path: \"/messages\", allowedRoles: allInternalRoles },\n  { path: \"/calls\", allowedRoles: [\"admin\", \"sales\"] },\n  { path: \"/quote-analytics\", allowedRoles: allInternalRoles },\n  { path: \"/automation\", allowedRoles: [\"admin\"] },\n  { path: \"/installer\", allowedRoles: allInternalRoles },\n  { path: \"/trade\", allowedRoles: [\"admin\", \"trade_client\"] },\n  { path: \"/organisation/departments\", allowedRoles: [\"admin\"] },\n  { path: \"/organisation/workflows\", allowedRoles: allInternalRoles },\n  { path: \"/organisation/policies\", allowedRoles: allInternalRoles },\n  { path: \"/organisation/resources\", allowedRoles: allInternalRoles },\n  { path: \"/organisation/knowledge\", allowedRoles: allInternalRoles },\n  { path: \"/live-doc-templates\", allowedRoles: allInternalRoles },\n  { path: \"/import\", allowedRoles: [\"admin\"] },\n  { path: \"/dashboard-builder\", allowedRoles: [\"admin\"] },\n  { path: \"/job-stage-configuration\", allowedRoles: [\"admin\"] },\n  { path: \"/kanban-column-settings\", allowedRoles: [\"admin\"] },\n  { path: \"/sales-checklist-config\", allowedRoles: [\"admin\"] },\n  { path: \"/expense-category-config\", allowedRoles: [\"admin\"] },\n  { path: \"/staff-management\", allowedRoles: [\"admin\"] },\n  { path: \"/unauthorized\", allowedRoles: allInternalRoles },\n];\n\nexport function hasRouteAccess(role: UserRole | undefined, route: string): boolean {\n  if (!role) return false;\n  \n  if (role === \"admin\") return true;\n  \n  const matchedConfig = routePermissions.find(config => {\n    if (config.path === route) return true;\n    if (route.startsWith(config.path + \"/\")) return true;\n    return false;\n  });\n  \n  if (!matchedConfig) return false;\n  \n  return matchedConfig.allowedRoles.includes(role);\n}\n\nexport function getDefaultRoute(role: UserRole | undefined): string {\n  if (!role) return \"/login\";\n  if (role === \"trade_client\") return \"/trade\";\n  return \"/\";\n}\n\nexport function getRolesForRoute(route: string): UserRole[] {\n  const matchedConfig = routePermissions.find(config => {\n    if (config.path === route) return true;\n    if (route.startsWith(config.path + \"/\")) return true;\n    return false;\n  });\n  \n  return matchedConfig?.allowedRoles || [];\n}\n","path":null,"size_bytes":3289,"size_tokens":null},"client/src/components/ui/address-autocomplete.tsx":{"content":"import { useState, useEffect, useRef, useCallback } from \"react\";\nimport { Input } from \"@/components/ui/input\";\nimport { Loader2, MapPin, ImageOff, Mountain, AlertTriangle, CheckCircle } from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\n\ninterface AddressAutocompleteProps {\n  value: string;\n  onChange: (value: string) => void;\n  onCoordinatesChange?: (coords: { lat: number; lng: number } | null) => void;\n  placeholder?: string;\n  className?: string;\n  showStreetView?: boolean;\n  \"data-testid\"?: string;\n}\n\ninterface SoilData {\n  soilType: string;\n  region: string | null;\n  nearestTown: string | null;\n  naturalVegetation: string | null;\n  state: string | null;\n  ascOrder: string | null;\n  comments: string | null;\n  installationNotes: string | null;\n  geologyWarning: string | null;\n  source: string;\n}\n\ninterface Prediction {\n  place_id: string;\n  description: string;\n  structured_formatting: {\n    main_text: string;\n    secondary_text: string;\n  };\n}\n\ndeclare global {\n  interface Window {\n    google?: typeof google;\n    initGoogleMapsCallback?: () => void;\n  }\n}\n\nfunction loadGoogleMapsScript(): Promise<void> {\n  return new Promise((resolve) => {\n    // Check if already loaded (handles hot reload)\n    if (window.google?.maps?.places) {\n      resolve();\n      return;\n    }\n\n    const apiKey = import.meta.env.VITE_GOOGLE_MAPS_API_KEY;\n    if (!apiKey) {\n      console.warn(\"Google Maps API key not configured. Address autocomplete will be disabled.\");\n      return;\n    }\n\n    // Check if script is already being loaded\n    const existingScript = document.querySelector('script[src*=\"maps.googleapis.com/maps/api/js\"]');\n    if (existingScript) {\n      // Poll until loaded\n      const checkLoaded = setInterval(() => {\n        if (window.google?.maps?.places) {\n          clearInterval(checkLoaded);\n          resolve();\n        }\n      }, 100);\n      return;\n    }\n\n    // Create and load the script\n    const script = document.createElement(\"script\");\n    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places`;\n    script.async = true;\n    script.defer = true;\n    script.onload = () => {\n      // Poll until places is available\n      const checkLoaded = setInterval(() => {\n        if (window.google?.maps?.places) {\n          clearInterval(checkLoaded);\n          resolve();\n        }\n      }, 50);\n    };\n    document.head.appendChild(script);\n  });\n}\n\nexport function SitePreview({ address }: { address: string }) {\n  const [hasError, setHasError] = useState(false);\n  const [isLoading, setIsLoading] = useState(true);\n  const apiKey = import.meta.env.VITE_GOOGLE_MAPS_API_KEY;\n\n  useEffect(() => {\n    setHasError(false);\n    setIsLoading(true);\n  }, [address]);\n\n  if (!apiKey || !address || address.length < 10) {\n    return null;\n  }\n\n  const streetViewUrl = `https://maps.googleapis.com/maps/api/streetview?size=400x120&location=${encodeURIComponent(address)}&key=${apiKey}`;\n  // Open satellite view which always has imagery, with option to switch to Street View if available\n  const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}&basemap=satellite`;\n\n  return (\n    <div className=\"mt-2 rounded-md overflow-hidden border bg-muted/30\">\n      {isLoading && !hasError && (\n        <div className=\"h-[100px] flex items-center justify-center\">\n          <Loader2 className=\"h-5 w-5 animate-spin text-muted-foreground\" />\n        </div>\n      )}\n      {hasError ? (\n        <div className=\"h-[100px] flex flex-col items-center justify-center text-muted-foreground\">\n          <ImageOff className=\"h-6 w-6 mb-1\" />\n          <span className=\"text-xs\">Street View not available</span>\n        </div>\n      ) : (\n        <a \n          href={googleMapsUrl} \n          target=\"_blank\" \n          rel=\"noopener noreferrer\"\n          className=\"block cursor-pointer\"\n          title=\"Click to open in Google Maps\"\n        >\n          <img\n            src={streetViewUrl}\n            alt=\"Street View of address\"\n            className={`w-full h-[100px] object-cover hover:opacity-90 transition-opacity ${isLoading ? 'hidden' : 'block'}`}\n            onLoad={(e) => {\n              setIsLoading(false);\n              const img = e.target as HTMLImageElement;\n              if (img.naturalWidth === 600 && img.naturalHeight === 300) {\n                setHasError(true);\n              }\n            }}\n            onError={() => {\n              setIsLoading(false);\n              setHasError(true);\n            }}\n            data-testid=\"streetview-image\"\n          />\n        </a>\n      )}\n      <div className=\"px-2 py-1 text-[10px] text-muted-foreground text-right border-t flex items-center justify-between\">\n        <a \n          href={googleMapsUrl} \n          target=\"_blank\" \n          rel=\"noopener noreferrer\"\n          className=\"text-primary hover:underline\"\n        >\n          View in Google Maps\n        </a>\n        <span>Site Preview</span>\n      </div>\n    </div>\n  );\n}\n\nfunction SoilDataDisplay({ lat, lng }: { lat: number; lng: number }) {\n  const { data: soilData, isLoading, error } = useQuery<SoilData>({\n    queryKey: [\"/api/soil-data\", lat, lng],\n    queryFn: async () => {\n      const response = await fetch(`/api/soil-data?lat=${lat}&lng=${lng}`);\n      if (!response.ok) throw new Error(\"Failed to fetch soil data\");\n      return response.json();\n    },\n    enabled: !isNaN(lat) && !isNaN(lng),\n    staleTime: 1000 * 60 * 60, // Cache for 1 hour\n    retry: 1,\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"mt-2 rounded-md border bg-muted/30 p-2 flex items-center gap-2 text-sm text-muted-foreground\">\n        <Loader2 className=\"h-4 w-4 animate-spin\" />\n        <span>Loading soil data...</span>\n      </div>\n    );\n  }\n\n  if (error || !soilData || soilData.source === \"unavailable\" || !soilData.soilType) {\n    return (\n      <div className=\"mt-2 rounded-md border bg-muted/30 p-2\" data-testid=\"soil-data-display\">\n        <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n          <AlertTriangle className=\"h-4 w-4 text-amber-500\" />\n          <span data-testid=\"soil-type\">Soil data unavailable for this location</span>\n        </div>\n        <p className=\"text-xs text-muted-foreground mt-1\" data-testid=\"installation-notes\">\n          Site assessment recommended - contact office for soil evaluation\n        </p>\n      </div>\n    );\n  }\n\n  // Check if this is a limestone warning\n  const isLimestoneZone = soilData.geologyWarning?.includes(\"Limestone\") || \n                           soilData.installationNotes?.includes(\"LIMESTONE\");\n\n  // Determine the icon and color based on installation difficulty\n  const getInstallIcon = () => {\n    if (!soilData.installationNotes) return null;\n    const notes = soilData.installationNotes.toLowerCase();\n    if (notes.includes(\"limestone\") || notes.includes(\"core drill\")) {\n      return <AlertTriangle className=\"h-4 w-4 text-red-500\" />;\n    } else if (notes.includes(\"harder\")) {\n      return <AlertTriangle className=\"h-4 w-4 text-amber-500\" />;\n    } else if (notes.includes(\"easy\") || notes.includes(\"standard\")) {\n      return <CheckCircle className=\"h-4 w-4 text-green-600\" />;\n    }\n    return <Mountain className=\"h-4 w-4 text-muted-foreground\" />;\n  };\n\n  return (\n    <div className={`mt-2 rounded-md border ${isLimestoneZone ? 'border-red-300 bg-red-50 dark:bg-red-950/20' : 'bg-muted/30'}`} data-testid=\"soil-data-display\">\n      <div className={`px-3 py-2 border-b flex items-center gap-2 ${isLimestoneZone ? 'bg-red-100 dark:bg-red-900/30' : 'bg-muted/50'}`}>\n        {isLimestoneZone ? (\n          <AlertTriangle className=\"h-4 w-4 text-red-500\" />\n        ) : (\n          <Mountain className=\"h-4 w-4 text-primary\" />\n        )}\n        <span className={`text-sm font-medium ${isLimestoneZone ? 'text-red-700 dark:text-red-400' : ''}`}>\n          {isLimestoneZone ? 'Geology Warning' : 'Soil Information'}\n        </span>\n      </div>\n      {soilData.geologyWarning && (\n        <div className=\"px-3 py-2 bg-red-100 dark:bg-red-900/20 border-b text-sm font-medium text-red-700 dark:text-red-400\">\n          {soilData.geologyWarning}\n        </div>\n      )}\n      <div className=\"p-3 space-y-2 text-sm\">\n        <div className=\"flex items-center justify-between\">\n          <span className=\"text-muted-foreground\">Soil Type:</span>\n          <span className=\"font-medium\" data-testid=\"soil-type\">{soilData.soilType}</span>\n        </div>\n        {soilData.region && (\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-muted-foreground\">Region:</span>\n            <span className=\"text-right\">{soilData.region}</span>\n          </div>\n        )}\n        {soilData.installationNotes && (\n          <div className={`mt-2 pt-2 border-t flex items-start gap-2 ${isLimestoneZone ? 'border-red-200' : ''}`}>\n            {getInstallIcon()}\n            <span className={`text-xs ${isLimestoneZone ? 'font-medium text-red-700 dark:text-red-400' : ''}`} data-testid=\"installation-notes\">\n              {soilData.installationNotes}\n            </span>\n          </div>\n        )}\n      </div>\n      <div className=\"px-2 py-1 text-[10px] text-muted-foreground border-t text-right\">\n        Source: {soilData.source}\n      </div>\n    </div>\n  );\n}\n\nexport function AddressAutocomplete({\n  value,\n  onChange,\n  onCoordinatesChange,\n  placeholder = \"Enter address...\",\n  className,\n  showStreetView = false,\n  \"data-testid\": dataTestId,\n}: AddressAutocompleteProps) {\n  const [inputValue, setInputValue] = useState(value);\n  const [predictions, setPredictions] = useState<Prediction[]>([]);\n  const [isLoading, setIsLoading] = useState(false);\n  const [showDropdown, setShowDropdown] = useState(false);\n  const [isApiAvailable, setIsApiAvailable] = useState(false);\n  const [confirmedAddress, setConfirmedAddress] = useState(value);\n  const [coordinates, setCoordinates] = useState<{ lat: number; lng: number } | null>(null);\n  const [highlightedIndex, setHighlightedIndex] = useState(-1);\n  const autocompleteService = useRef<google.maps.places.AutocompleteService | null>(null);\n  const placesService = useRef<google.maps.places.PlacesService | null>(null);\n  const debounceTimer = useRef<NodeJS.Timeout | null>(null);\n  const containerRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    setInputValue(value);\n    if (value && value.length >= 10) {\n      setConfirmedAddress(value);\n      // If we have an address but no coordinates, geocode it\n      if (!coordinates && window.google?.maps?.Geocoder) {\n        const geocoder = new window.google.maps.Geocoder();\n        geocoder.geocode({ address: value }, (\n          results: google.maps.GeocoderResult[] | null, \n          status: google.maps.GeocoderStatus\n        ) => {\n          if (status === window.google!.maps.GeocoderStatus.OK && results?.[0]?.geometry?.location) {\n            const newCoords = {\n              lat: results[0].geometry.location.lat(),\n              lng: results[0].geometry.location.lng(),\n            };\n            setCoordinates(newCoords);\n            onCoordinatesChange?.(newCoords);\n          }\n        });\n      }\n    }\n  }, [value]);\n\n  useEffect(() => {\n    const initServices = () => {\n      if (window.google?.maps?.places) {\n        autocompleteService.current = new google.maps.places.AutocompleteService();\n        const dummyDiv = document.createElement(\"div\");\n        placesService.current = new google.maps.places.PlacesService(dummyDiv);\n        setIsApiAvailable(true);\n      }\n    };\n\n    loadGoogleMapsScript().then(initServices);\n  }, []);\n\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (containerRef.current && !containerRef.current.contains(event.target as Node)) {\n        setShowDropdown(false);\n      }\n    };\n\n    document.addEventListener(\"mousedown\", handleClickOutside);\n    return () => document.removeEventListener(\"mousedown\", handleClickOutside);\n  }, []);\n\n  const fetchPredictions = useCallback((input: string) => {\n    if (!autocompleteService.current || input.length < 3) {\n      setPredictions([]);\n      return;\n    }\n\n    setIsLoading(true);\n\n    autocompleteService.current.getPlacePredictions(\n      {\n        input,\n        componentRestrictions: { country: \"au\" },\n        types: [\"address\"],\n      },\n      (results, status) => {\n        setIsLoading(false);\n        if (status === google.maps.places.PlacesServiceStatus.OK && results) {\n          setPredictions(results);\n          setShowDropdown(true);\n        } else {\n          setPredictions([]);\n        }\n      }\n    );\n  }, []);\n\n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const newValue = e.target.value;\n    setInputValue(newValue);\n    onChange(newValue);\n    setHighlightedIndex(-1);\n\n    if (debounceTimer.current) {\n      clearTimeout(debounceTimer.current);\n    }\n\n    if (isApiAvailable && newValue.length >= 3) {\n      debounceTimer.current = setTimeout(() => {\n        fetchPredictions(newValue);\n      }, 300);\n    } else {\n      setPredictions([]);\n      setShowDropdown(false);\n    }\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {\n    if (!showDropdown || predictions.length === 0) return;\n\n    switch (e.key) {\n      case \"ArrowDown\":\n        e.preventDefault();\n        setHighlightedIndex((prev) =>\n          prev < predictions.length - 1 ? prev + 1 : 0\n        );\n        break;\n      case \"ArrowUp\":\n        e.preventDefault();\n        setHighlightedIndex((prev) =>\n          prev > 0 ? prev - 1 : predictions.length - 1\n        );\n        break;\n      case \"Enter\":\n        e.preventDefault();\n        if (highlightedIndex >= 0 && highlightedIndex < predictions.length) {\n          handleSelectPrediction(predictions[highlightedIndex]);\n        }\n        break;\n      case \"Escape\":\n        setShowDropdown(false);\n        setHighlightedIndex(-1);\n        break;\n    }\n  };\n\n  const handleSelectPrediction = (prediction: Prediction) => {\n    if (!placesService.current) {\n      setInputValue(prediction.description);\n      onChange(prediction.description);\n      setConfirmedAddress(prediction.description);\n      setShowDropdown(false);\n      setPredictions([]);\n      return;\n    }\n\n    placesService.current.getDetails(\n      {\n        placeId: prediction.place_id,\n        fields: [\"formatted_address\", \"geometry\"],\n      },\n      (place, status) => {\n        if (status === google.maps.places.PlacesServiceStatus.OK && place?.formatted_address) {\n          setInputValue(place.formatted_address);\n          onChange(place.formatted_address);\n          setConfirmedAddress(place.formatted_address);\n          \n          // Extract coordinates for soil data lookup\n          if (place.geometry?.location) {\n            const newCoords = {\n              lat: place.geometry.location.lat(),\n              lng: place.geometry.location.lng(),\n            };\n            setCoordinates(newCoords);\n            onCoordinatesChange?.(newCoords);\n          }\n        } else {\n          setInputValue(prediction.description);\n          onChange(prediction.description);\n          setConfirmedAddress(prediction.description);\n        }\n        setShowDropdown(false);\n        setPredictions([]);\n        setHighlightedIndex(-1);\n      }\n    );\n  };\n\n  return (\n    <div ref={containerRef} className=\"relative\">\n      <div className=\"relative\">\n        <Input\n          value={inputValue}\n          onChange={handleInputChange}\n          onKeyDown={handleKeyDown}\n          onFocus={() => {\n            if (predictions.length > 0) {\n              setShowDropdown(true);\n            }\n          }}\n          placeholder={placeholder}\n          className={className}\n          data-testid={dataTestId}\n        />\n        {isLoading && (\n          <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n            <Loader2 className=\"h-4 w-4 animate-spin text-muted-foreground\" />\n          </div>\n        )}\n      </div>\n\n      {showDropdown && predictions.length > 0 && (\n        <div className=\"absolute z-50 mt-1 w-full rounded-md border bg-popover shadow-lg\">\n          <ul className=\"max-h-60 overflow-auto py-1\">\n            {predictions.map((prediction, index) => (\n              <li\n                key={prediction.place_id}\n                onClick={() => handleSelectPrediction(prediction)}\n                className={`flex cursor-pointer items-center gap-2 px-3 py-2 text-sm hover:bg-accent ${\n                  highlightedIndex === index ? \"bg-accent\" : \"\"\n                }`}\n                data-testid={`address-suggestion-${prediction.place_id}`}\n              >\n                <MapPin className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\n                <div className=\"flex-1 overflow-hidden\">\n                  <div className=\"font-medium truncate\">\n                    {prediction.structured_formatting.main_text}\n                  </div>\n                  <div className=\"text-xs text-muted-foreground truncate\">\n                    {prediction.structured_formatting.secondary_text}\n                  </div>\n                </div>\n              </li>\n            ))}\n          </ul>\n          <div className=\"border-t px-3 py-1.5 text-[10px] text-muted-foreground text-right\">\n            Powered by Google\n          </div>\n        </div>\n      )}\n\n      {showStreetView && confirmedAddress && (\n        <>\n          <SitePreview address={confirmedAddress} />\n          {coordinates && (\n            <SoilDataDisplay lat={coordinates.lat} lng={coordinates.lng} />\n          )}\n        </>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":17644,"size_tokens":null},"server/services/basiq.ts":{"content":"import { db } from \"../db\";\nimport { bankConnections, bankAccounts, bankTransactions } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\n\nconst BASIQ_BASE_URL = \"https://au-api.basiq.io\";\n\n// Probuild PVC business details for CDR consent\nconst BUSINESS_DETAILS = {\n  businessName: \"Probuild PVC\",\n  businessIdNo: \"29688327479\",\n  organisationType: \"COMPANY\"\n};\n\ninterface BasiqToken {\n  accessToken: string;\n  expiresAt: number;\n}\n\nlet cachedToken: BasiqToken | null = null;\n\nexport class BasiqService {\n  private apiKey: string;\n\n  constructor() {\n    const apiKey = process.env.BASIQ_API_KEY;\n    if (!apiKey) {\n      throw new Error(\"BASIQ_API_KEY environment variable is not set\");\n    }\n    this.apiKey = apiKey;\n  }\n\n  private async getAccessToken(): Promise<string> {\n    const now = Date.now();\n    \n    if (cachedToken && cachedToken.expiresAt > now + 60000) {\n      return cachedToken.accessToken;\n    }\n\n    const response = await fetch(`${BASIQ_BASE_URL}/token`, {\n      method: \"POST\",\n      headers: {\n        \"Authorization\": `Basic ${this.apiKey}`,\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\n        \"basiq-version\": \"3.0\"\n      },\n      body: \"scope=SERVER_ACCESS\"\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(`Failed to get Basiq access token: ${response.status} - ${errorText}`);\n    }\n\n    const data = await response.json();\n    \n    console.log(\"Token response data:\", JSON.stringify(data, null, 2));\n    console.log(\"Access token type:\", typeof data.access_token);\n    console.log(\"Access token length:\", data.access_token?.length);\n    console.log(\"Access token first 50 chars:\", data.access_token?.substring(0, 50));\n    \n    cachedToken = {\n      accessToken: data.access_token,\n      expiresAt: now + (data.expires_in * 1000) - 60000\n    };\n\n    return cachedToken.accessToken;\n  }\n\n  private async makeRequest(endpoint: string, options: RequestInit = {}): Promise<any> {\n    // Get SERVER_ACCESS token for API calls\n    const token = await this.getAccessToken();\n    \n    console.log(\"Making request with Bearer token to:\", endpoint);\n    \n    const response = await fetch(`${BASIQ_BASE_URL}${endpoint}`, {\n      ...options,\n      headers: {\n        \"Authorization\": `Bearer ${token}`,\n        \"Accept\": \"application/json\",\n        \"Content-Type\": \"application/json\",\n        \"basiq-version\": \"3.0\",\n        ...options.headers\n      }\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(`Basiq API error: ${response.status} - ${errorText}`);\n    }\n\n    return response.json();\n  }\n\n  /**\n   * Get CLIENT_ACCESS token bound to a specific userId\n   * This is required for accessing the Consent UI\n   */\n  private async getClientAccessToken(userId: string): Promise<string> {\n    console.log(\"Getting CLIENT_ACCESS token for userId:\", userId);\n    \n    const response = await fetch(`${BASIQ_BASE_URL}/token`, {\n      method: \"POST\",\n      headers: {\n        \"Authorization\": `Basic ${this.apiKey}`,\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\n        \"basiq-version\": \"3.0\"\n      },\n      body: `scope=CLIENT_ACCESS&userId=${userId}`\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(`Failed to get client access token: ${response.status} - ${errorText}`);\n    }\n\n    const data = await response.json();\n    console.log(\"Client token obtained successfully\");\n    return data.access_token;\n  }\n\n  /**\n   * Create a Basiq user (required before consent)\n   * Requires email or mobile + businessName + businessIdNo\n   */\n  async createUser(\n    businessName?: string,\n    businessIdNo?: string,\n    email?: string,\n    mobile?: string,\n    organisationType?: string,\n    sharingDuration?: number,\n    businessIdNoType?: string,\n    businessAddress?: string\n  ): Promise<string> {\n    console.log(\"Creating Basiq user for business:\", businessName || BUSINESS_DETAILS.businessName);\n    \n    // Use provided values or fall back to environment variables\n    const contactEmail = email || process.env.BASIQ_CONTACT_EMAIL;\n    const contactMobile = mobile || process.env.BASIQ_CONTACT_MOBILE;\n    const contactBusinessName = businessName || BUSINESS_DETAILS.businessName;\n    const contactBusinessIdNo = businessIdNo || BUSINESS_DETAILS.businessIdNo;\n    const contactOrgType = organisationType || BUSINESS_DETAILS.organisationType;\n    const contactSharingDuration = sharingDuration || 365;\n    const contactBusinessIdNoType = businessIdNoType || \"ABN\";\n    const contactBusinessAddress = businessAddress || \"\";\n    \n    if (!contactEmail && !contactMobile) {\n      throw new Error(\"Basiq user creation requires either email or mobile. Set BASIQ_CONTACT_EMAIL or BASIQ_CONTACT_MOBILE environment variables.\");\n    }\n    \n    const userData: any = {\n      businessName: contactBusinessName,\n      businessIdNo: contactBusinessIdNo,\n      businessIdNoType: contactBusinessIdNoType,\n      businessAddress: contactBusinessAddress,\n      organisationType: contactOrgType,\n      sharingDuration: contactSharingDuration\n    };\n    if (contactEmail) userData.email = contactEmail;\n    if (contactMobile) userData.mobile = contactMobile;\n    \n    console.log(\"User data payload:\", userData);\n    \n    const user = await this.makeRequest(\"/users\", {\n      method: \"POST\",\n      body: JSON.stringify(userData)\n    });\n    \n    console.log(\"User created with ID:\", user.id);\n    return user.id;\n  }\n\n  /**\n   * Create a CDR consent for Open Banking access\n   * This uses the Basiq Consent UI flow:\n   * 1. Create a Basiq user\n   * 2. Get a CLIENT_ACCESS token bound to that user\n   * 3. Return the Consent UI URL for the user to complete consent\n   */\n  async createCDRConsent(\n    businessName?: string,\n    businessIdNo?: string,\n    businessIdNoType?: string,\n    businessAddress?: string,\n    organisationType?: string,\n    sharingDuration?: number,\n    email?: string\n  ): Promise<{ userId: string; connectUrl: string }> {\n    console.log(\"Starting CDR consent flow with params:\", {\n      businessName,\n      businessIdNo,\n      businessIdNoType,\n      businessAddress,\n      organisationType,\n      sharingDuration,\n      email\n    });\n    \n    const finalBusinessName = businessName || BUSINESS_DETAILS.businessName;\n    const finalBusinessIdNo = businessIdNo || BUSINESS_DETAILS.businessIdNo;\n    const finalBusinessIdNoType = businessIdNoType || \"ABN\";\n    const finalBusinessAddress = businessAddress || \"\";\n    const finalEmail = email || process.env.BASIQ_CONTACT_EMAIL;\n    const finalOrgType = organisationType || BUSINESS_DETAILS.organisationType;\n    const finalSharingDuration = sharingDuration || 365;\n    \n    // Step 1: Create a Basiq user with business name, ID, contact email, org type, and sharing duration\n    const userId = await this.createUser(finalBusinessName, finalBusinessIdNo, finalEmail, undefined, finalOrgType, finalSharingDuration, finalBusinessIdNoType, finalBusinessAddress);\n    console.log(\"Created Basiq user:\", userId);\n    \n    // Step 2: Get a CLIENT_ACCESS token bound to this user\n    const clientToken = await this.getClientAccessToken(userId);\n    console.log(\"Got client token for user\");\n    \n    // Step 3: Generate the Basiq Consent UI URL\n    // The Consent UI handles all the CDR complexity including bank selection\n    const connectUrl = `https://consent.basiq.io/home?token=${clientToken}`;\n    \n    console.log(\"Consent UI URL generated\");\n\n    return { userId, connectUrl };\n  }\n\n  /**\n   * Get the status of a consent\n   */\n  async getConsent(consentId: string): Promise<any> {\n    return this.makeRequest(`/consents/${consentId}`);\n  }\n\n  /**\n   * Get accounts associated with a consent\n   */\n  async getAccountsByConsent(consentId: string): Promise<any[]> {\n    const data = await this.makeRequest(`/consents/${consentId}/accounts`);\n    return data.data || [];\n  }\n\n  /**\n   * Get institutions list (for display purposes only)\n   */\n  async getInstitutions(): Promise<any[]> {\n    const data = await this.makeRequest(\"/institutions\");\n    return data.data || [];\n  }\n\n  /**\n   * Get transactions for a consent\n   */\n  async getTransactionsByConsent(consentId: string, filters?: {\n    accountId?: string;\n    fromDate?: string;\n    toDate?: string;\n    limit?: number;\n  }): Promise<any[]> {\n    let endpoint = `/consents/${consentId}/transactions`;\n    const queryParams: string[] = [];\n\n    if (filters?.accountId) {\n      queryParams.push(`filter=account.id.eq('${filters.accountId}')`);\n    }\n    if (filters?.fromDate) {\n      queryParams.push(`filter=transaction.postDate.gteq('${filters.fromDate}')`);\n    }\n    if (filters?.toDate) {\n      queryParams.push(`filter=transaction.postDate.lteq('${filters.toDate}')`);\n    }\n    if (filters?.limit) {\n      queryParams.push(`limit=${filters.limit}`);\n    }\n\n    if (queryParams.length > 0) {\n      endpoint += `?${queryParams.join(\"&\")}`;\n    }\n\n    const allTransactions: any[] = [];\n    let nextUrl: string | null = endpoint;\n\n    while (nextUrl) {\n      const data = await this.makeRequest(nextUrl);\n      allTransactions.push(...(data.data || []));\n      \n      nextUrl = data.links?.next ? new URL(data.links.next).pathname + new URL(data.links.next).search : null;\n      \n      if (filters?.limit && allTransactions.length >= filters.limit) {\n        break;\n      }\n    }\n\n    return allTransactions;\n  }\n\n  /**\n   * Sync accounts from Basiq to local database using consent ID\n   */\n  async syncAccountsToDatabase(connectionId: string): Promise<void> {\n    const connection = await db.select().from(bankConnections)\n      .where(eq(bankConnections.id, connectionId))\n      .limit(1);\n\n    if (!connection[0]) {\n      throw new Error(`Connection ${connectionId} not found`);\n    }\n\n    const { basiqConsentId } = connection[0];\n    if (!basiqConsentId) {\n      throw new Error(`Connection ${connectionId} has no consent ID`);\n    }\n\n    const accounts = await this.getAccountsByConsent(basiqConsentId);\n\n    for (const account of accounts) {\n      const existingAccount = await db.select().from(bankAccounts)\n        .where(eq(bankAccounts.basiqAccountId, account.id))\n        .limit(1);\n\n      const accountData = {\n        connectionId,\n        basiqAccountId: account.id,\n        name: account.name || \"Unknown Account\",\n        accountHolder: account.accountHolder,\n        accountNumberMasked: account.accountNo?.replace(/\\d(?=\\d{4})/g, \"*\"),\n        bsbMasked: account.bsb?.replace(/\\d(?=\\d{2})/g, \"*\"),\n        accountType: this.mapAccountType(account.class?.type),\n        currency: account.currency || \"AUD\",\n        balance: account.balance,\n        availableFunds: account.availableFunds,\n        lastUpdatedAt: account.lastUpdated ? new Date(account.lastUpdated) : new Date(),\n        isActive: account.status === \"available\"\n      };\n\n      if (existingAccount[0]) {\n        await db.update(bankAccounts)\n          .set(accountData)\n          .where(eq(bankAccounts.id, existingAccount[0].id));\n      } else {\n        await db.insert(bankAccounts).values(accountData);\n      }\n    }\n  }\n\n  /**\n   * Sync transactions from Basiq to local database\n   */\n  async syncTransactionsToDatabase(accountId: string, fromDate?: string): Promise<number> {\n    const account = await db.select().from(bankAccounts)\n      .where(eq(bankAccounts.id, accountId))\n      .limit(1);\n\n    if (!account[0]) {\n      throw new Error(`Account ${accountId} not found`);\n    }\n\n    const connection = await db.select().from(bankConnections)\n      .where(eq(bankConnections.id, account[0].connectionId))\n      .limit(1);\n\n    if (!connection[0]?.basiqConsentId) {\n      throw new Error(\"Connection has no consent ID\");\n    }\n\n    const transactions = await this.getTransactionsByConsent(connection[0].basiqConsentId, {\n      accountId: account[0].basiqAccountId,\n      fromDate,\n      limit: 500\n    });\n\n    let importedCount = 0;\n\n    for (const tx of transactions) {\n      const existingTx = await db.select().from(bankTransactions)\n        .where(eq(bankTransactions.basiqTransactionId, tx.id))\n        .limit(1);\n\n      if (existingTx[0]) {\n        continue;\n      }\n\n      const amount = parseFloat(tx.amount) || 0;\n      \n      await db.insert(bankTransactions).values({\n        accountId,\n        basiqTransactionId: tx.id,\n        description: tx.description || \"No description\",\n        amount: Math.abs(amount).toString(),\n        direction: amount < 0 ? \"debit\" : \"credit\",\n        status: tx.status || \"posted\",\n        transactionDate: tx.transactionDate ? new Date(tx.transactionDate) : null,\n        postDate: tx.postDate ? new Date(tx.postDate) : null,\n        category: tx.class?.category,\n        subCategory: tx.subClass?.title,\n        merchantName: tx.enrich?.merchant?.businessName,\n        merchantLocation: tx.enrich?.location?.formattedAddress,\n        runningBalance: tx.balance,\n        rawData: tx\n      });\n\n      importedCount++;\n    }\n\n    return importedCount;\n  }\n\n  private mapAccountType(basiqType?: string): \"transaction\" | \"savings\" | \"credit_card\" | \"loan\" | \"mortgage\" | \"investment\" | \"term_deposit\" | \"other\" {\n    const typeMap: Record<string, any> = {\n      \"transaction\": \"transaction\",\n      \"savings\": \"savings\",\n      \"credit-card\": \"credit_card\",\n      \"credit\": \"credit_card\",\n      \"loan\": \"loan\",\n      \"mortgage\": \"mortgage\",\n      \"investment\": \"investment\",\n      \"term-deposit\": \"term_deposit\",\n      \"term_deposit\": \"term_deposit\"\n    };\n\n    return typeMap[basiqType?.toLowerCase() || \"\"] || \"other\";\n  }\n}\n\nexport const basiqService = new BasiqService();\n","path":null,"size_bytes":13625,"size_tokens":null},"client/src/pages/Financial.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { format } from \"date-fns\";\nimport { useLocation } from \"wouter\";\nimport {\n  Landmark,\n  CreditCard,\n  TrendingUp,\n  TrendingDown,\n  RefreshCw,\n  ArrowDownRight,\n  ArrowUpRight,\n  Plus,\n  Building2,\n  Wallet,\n  DollarSign,\n  Search,\n  Filter,\n  Loader2,\n  CheckCircle2,\n  AlertCircle,\n  ExternalLink,\n  Users,\n  Receipt,\n  Eye,\n  Link2,\n  Copy,\n  UserCircle,\n  Calendar,\n  Tag,\n  Upload,\n  FileSpreadsheet,\n} from \"lucide-react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport { Label } from \"@/components/ui/label\";\nimport type { BankAccount, BankConnection, BankTransaction } from \"@shared/schema\";\n\ninterface FinancialOverview {\n  totalBalance: number;\n  totalAvailable: number;\n  monthlyIncome: number;\n  monthlyExpenses: number;\n  accountCount: number;\n  connectionCount: number;\n  recentTransactions: BankTransaction[];\n  lastSyncedAt: string | null;\n}\n\nfunction formatCurrency(amount: number | string | null | undefined): string {\n  const num = typeof amount === \"string\" ? parseFloat(amount) : amount;\n  if (num == null || isNaN(num)) return \"$0.00\";\n  return new Intl.NumberFormat(\"en-AU\", {\n    style: \"currency\",\n    currency: \"AUD\",\n  }).format(num);\n}\n\nfunction OverviewCard({ \n  title, \n  value, \n  icon: Icon, \n  trend,\n  trendValue,\n  description,\n  loading \n}: { \n  title: string; \n  value: string; \n  icon: any;\n  trend?: \"up\" | \"down\";\n  trendValue?: string;\n  description?: string;\n  loading?: boolean;\n}) {\n  if (loading) {\n    return (\n      <Card>\n        <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n          <Skeleton className=\"h-4 w-24\" />\n          <Skeleton className=\"h-8 w-8 rounded\" />\n        </CardHeader>\n        <CardContent>\n          <Skeleton className=\"h-8 w-32 mb-2\" />\n          <Skeleton className=\"h-4 w-20\" />\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card>\n      <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n        <CardTitle className=\"text-sm font-medium text-muted-foreground\">{title}</CardTitle>\n        <div className=\"h-8 w-8 rounded bg-muted flex items-center justify-center\">\n          <Icon className=\"h-4 w-4 text-muted-foreground\" />\n        </div>\n      </CardHeader>\n      <CardContent>\n        <div className=\"text-2xl font-bold\" data-testid={`value-${title.toLowerCase().replace(/\\s+/g, '-')}`}>{value}</div>\n        {trend && trendValue && (\n          <p className={`text-xs flex items-center gap-1 ${trend === \"up\" ? \"text-green-600\" : \"text-red-600\"}`}>\n            {trend === \"up\" ? <TrendingUp className=\"h-3 w-3\" /> : <TrendingDown className=\"h-3 w-3\" />}\n            {trendValue}\n          </p>\n        )}\n        {description && <p className=\"text-xs text-muted-foreground mt-1\">{description}</p>}\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction AccountCard({ account, onSync, isSyncing }: { account: BankAccount; onSync: (id: string) => void; isSyncing?: boolean }) {\n  const getAccountIcon = (type: string | null) => {\n    switch (type) {\n      case \"savings\": return Wallet;\n      case \"credit_card\": return CreditCard;\n      case \"investment\": return TrendingUp;\n      default: return Landmark;\n    }\n  };\n  const Icon = getAccountIcon(account.accountType);\n\n  return (\n    <Card className=\"hover-elevate cursor-pointer\">\n      <CardContent className=\"p-4\">\n        <div className=\"flex items-start justify-between gap-2\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"h-10 w-10 rounded-lg bg-primary/10 flex items-center justify-center\">\n              <Icon className=\"h-5 w-5 text-primary\" />\n            </div>\n            <div>\n              <h4 className=\"font-medium\" data-testid={`account-name-${account.id}`}>{account.name}</h4>\n              <p className=\"text-sm text-muted-foreground\">\n                {account.accountNumberMasked || \"\"}\n                {account.bsbMasked && ` | BSB ${account.bsbMasked}`}\n              </p>\n            </div>\n          </div>\n          <Badge variant=\"outline\">{account.accountType?.replace(\"_\", \" \")}</Badge>\n        </div>\n        <div className=\"mt-4 grid grid-cols-2 gap-4\">\n          <div>\n            <p className=\"text-xs text-muted-foreground\">Balance</p>\n            <p className=\"text-lg font-semibold\" data-testid={`account-balance-${account.id}`}>\n              {formatCurrency(account.balance)}\n            </p>\n          </div>\n          <div>\n            <p className=\"text-xs text-muted-foreground\">Available</p>\n            <p className=\"text-lg font-semibold text-green-600\">\n              {formatCurrency(account.availableFunds)}\n            </p>\n          </div>\n        </div>\n        <div className=\"mt-4 flex items-center justify-between\">\n          <p className=\"text-xs text-muted-foreground\">\n            {account.lastUpdatedAt ? `Updated ${format(new Date(account.lastUpdatedAt), \"dd MMM, h:mm a\")}` : \"Never synced\"}\n          </p>\n          <Button \n            size=\"sm\" \n            variant=\"ghost\" \n            onClick={(e) => { e.stopPropagation(); onSync(account.id); }}\n            disabled={isSyncing}\n            data-testid={`button-sync-${account.id}`}\n          >\n            <RefreshCw className={`h-4 w-4 ${isSyncing ? \"animate-spin\" : \"\"}`} />\n          </Button>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction TransactionRow({ transaction }: { transaction: BankTransaction }) {\n  const isCredit = transaction.direction === \"credit\";\n  \n  return (\n    <TableRow data-testid={`transaction-row-${transaction.id}`}>\n      <TableCell>\n        <div className=\"flex items-center gap-2\">\n          <div className={`h-8 w-8 rounded-full flex items-center justify-center ${isCredit ? \"bg-green-100\" : \"bg-red-100\"}`}>\n            {isCredit ? (\n              <ArrowDownRight className=\"h-4 w-4 text-green-600\" />\n            ) : (\n              <ArrowUpRight className=\"h-4 w-4 text-red-600\" />\n            )}\n          </div>\n          <div>\n            <p className=\"font-medium text-sm\">{transaction.merchantName || transaction.description?.slice(0, 40)}</p>\n            <p className=\"text-xs text-muted-foreground\">{transaction.category || \"Uncategorized\"}</p>\n          </div>\n        </div>\n      </TableCell>\n      <TableCell className=\"text-sm text-muted-foreground\">\n        {transaction.postDate ? format(new Date(transaction.postDate), \"dd MMM yyyy\") : \"-\"}\n      </TableCell>\n      <TableCell className=\"text-sm text-muted-foreground max-w-[200px] truncate\">\n        {transaction.description}\n      </TableCell>\n      <TableCell className={`text-right font-medium ${isCredit ? \"text-green-600\" : \"text-red-600\"}`}>\n        {isCredit ? \"+\" : \"-\"}{formatCurrency(Math.abs(parseFloat(transaction.amount || \"0\")))}\n      </TableCell>\n    </TableRow>\n  );\n}\n\ninterface ExpenseCategory {\n  id: string;\n  name: string;\n  color: string | null;\n}\n\nfunction TransactionRowCompact({ transaction }: { transaction: BankTransaction }) {\n  const { toast } = useToast();\n  const isCredit = transaction.direction === \"credit\";\n  \n  const { data: users = [] } = useQuery<{ id: string; firstName: string; lastName: string }[]>({\n    queryKey: [\"/api/users\"],\n  });\n  \n  const { data: categories = [] } = useQuery<ExpenseCategory[]>({\n    queryKey: [\"/api/expense-categories\"],\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: { allocatedStaffId?: string | null; expenseCategoryId?: string | null }) => {\n      return apiRequest(\"PATCH\", `/api/financial/transactions/${transaction.id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ predicate: (query) => \n        typeof query.queryKey[0] === 'string' && query.queryKey[0].startsWith('/api/financial')\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Update Failed\",\n        description: error.message || \"Failed to update transaction\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleStaffChange = (value: string) => {\n    updateMutation.mutate({ allocatedStaffId: value === \"unassigned\" ? null : value });\n  };\n\n  const handleCategoryChange = (value: string) => {\n    updateMutation.mutate({ expenseCategoryId: value === \"uncategorized\" ? null : value });\n  };\n\n  const staffMembers = users.filter(u => u.firstName && u.lastName);\n  const currentStaff = staffMembers.find(s => s.id === transaction.allocatedStaffId);\n  const currentCategory = categories.find(c => c.id === transaction.expenseCategoryId);\n  \n  return (\n    <TableRow className=\"text-xs\" data-testid={`transaction-row-${transaction.id}`}>\n      <TableCell className=\"py-1.5 text-muted-foreground\">\n        {transaction.postDate ? format(new Date(transaction.postDate), \"dd/MM\") : \"-\"}\n      </TableCell>\n      <TableCell className=\"py-1.5\">\n        <div className=\"flex items-center gap-1.5\">\n          <div className={`h-5 w-5 rounded-full flex items-center justify-center flex-shrink-0 ${isCredit ? \"bg-green-100\" : \"bg-red-100\"}`}>\n            {isCredit ? (\n              <ArrowDownRight className=\"h-3 w-3 text-green-600\" />\n            ) : (\n              <ArrowUpRight className=\"h-3 w-3 text-red-600\" />\n            )}\n          </div>\n          <span className=\"truncate\" title={transaction.description || \"\"}>\n            {transaction.description}\n          </span>\n        </div>\n      </TableCell>\n      <TableCell className=\"py-1.5\">\n        <Select\n          value={transaction.expenseCategoryId || \"uncategorized\"}\n          onValueChange={handleCategoryChange}\n        >\n          <SelectTrigger className=\"h-6 text-xs border-0 bg-transparent hover:bg-muted px-1 w-full\" data-testid={`select-category-${transaction.id}`}>\n            <SelectValue placeholder=\"Select category...\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"uncategorized\">\n              <span className=\"text-muted-foreground\">Uncategorized</span>\n            </SelectItem>\n            {categories.map(cat => (\n              <SelectItem key={cat.id} value={cat.id}>{cat.name}</SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </TableCell>\n      <TableCell className=\"py-1.5\">\n        <Select\n          value={transaction.allocatedStaffId || \"unassigned\"}\n          onValueChange={handleStaffChange}\n        >\n          <SelectTrigger className=\"h-6 text-xs border-0 bg-transparent hover:bg-muted px-1 w-full\" data-testid={`select-staff-${transaction.id}`}>\n            <SelectValue placeholder=\"Assign staff...\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"unassigned\">\n              <span className=\"text-muted-foreground\">Unassigned</span>\n            </SelectItem>\n            {staffMembers.map(staff => (\n              <SelectItem key={staff.id} value={staff.id}>\n                {staff.firstName} {staff.lastName}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </TableCell>\n      <TableCell className={`py-1.5 text-right font-medium ${isCredit ? \"text-green-600\" : \"text-red-600\"}`}>\n        {isCredit ? \"+\" : \"-\"}{formatCurrency(Math.abs(parseFloat(transaction.amount || \"0\")))}\n      </TableCell>\n    </TableRow>\n  );\n}\n\nfunction EmptyState({ type }: { type: \"accounts\" | \"transactions\" | \"connections\" }) {\n  const messages = {\n    accounts: {\n      title: \"No Bank Accounts\",\n      description: \"Connect your bank to see account balances and transactions.\",\n      icon: CreditCard,\n    },\n    transactions: {\n      title: \"No Transactions Yet\",\n      description: \"Transactions will appear here once you connect a bank account and sync.\",\n      icon: DollarSign,\n    },\n    connections: {\n      title: \"No Bank Connections\",\n      description: \"Connect to your bank using secure Open Banking to get started.\",\n      icon: Building2,\n    },\n  };\n\n  const { title, description, icon: Icon } = messages[type];\n\n  return (\n    <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n      <div className=\"h-16 w-16 rounded-full bg-muted flex items-center justify-center mb-4\">\n        <Icon className=\"h-8 w-8 text-muted-foreground\" />\n      </div>\n      <h3 className=\"font-semibold text-lg\">{title}</h3>\n      <p className=\"text-muted-foreground mt-1 max-w-sm\">{description}</p>\n    </div>\n  );\n}\n\nfunction ConnectionCard({ connection, onRefresh }: { connection: BankConnection; onRefresh: (id: string) => void }) {\n  const statusColors: Record<string, string> = {\n    active: \"bg-green-100 text-green-800\",\n    processing: \"bg-yellow-100 text-yellow-800\",\n    inactive: \"bg-gray-100 text-gray-800\",\n    invalid: \"bg-red-100 text-red-800\",\n  };\n\n  return (\n    <Card>\n      <CardContent className=\"p-4\">\n        <div className=\"flex items-center justify-between gap-3\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"h-10 w-10 rounded-lg bg-primary/10 flex items-center justify-center\">\n              <Building2 className=\"h-5 w-5 text-primary\" />\n            </div>\n            <div>\n              <h4 className=\"font-medium\">{connection.institutionName || \"Bank Connection\"}</h4>\n              <p className=\"text-xs text-muted-foreground\">\n                {connection.basiqConsentId ? `Consent: ${connection.basiqConsentId.slice(0, 8)}...` : \"Pending setup\"}\n              </p>\n            </div>\n          </div>\n          <Badge className={statusColors[connection.status || \"inactive\"]}>\n            {connection.status}\n          </Badge>\n        </div>\n        <div className=\"mt-4 flex items-center justify-between\">\n          <div className=\"text-xs text-muted-foreground\">\n            {connection.lastSyncedAt \n              ? `Last synced: ${format(new Date(connection.lastSyncedAt), \"dd MMM, h:mm a\")}`\n              : \"Never synced\"\n            }\n            {connection.consentExpiresAt && (\n              <span className=\"ml-2\">\n                | Expires: {format(new Date(connection.consentExpiresAt), \"dd MMM yyyy\")}\n              </span>\n            )}\n          </div>\n          {connection.status === \"active\" && (\n            <Button \n              size=\"sm\" \n              variant=\"ghost\"\n              onClick={() => onRefresh(connection.id)}\n              data-testid={`button-refresh-${connection.id}`}\n            >\n              <RefreshCw className=\"h-4 w-4\" />\n            </Button>\n          )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\n// Staff transaction summary interface\ninterface StaffSummary {\n  staffId: string;\n  staffName: string;\n  totalSpent: number;\n  transactionCount: number;\n}\n\n// Staff Expenses Tab Component\nfunction StaffExpensesTab() {\n  const { toast } = useToast();\n  const [selectedStaffId, setSelectedStaffId] = useState<string | null>(null);\n  \n  const { data: staffSummary = [], isLoading: summaryLoading } = useQuery<StaffSummary[]>({\n    queryKey: [\"/api/financial/staff-summary\"],\n  });\n  \n  const { data: staffTransactions = [], isLoading: transactionsLoading } = useQuery<BankTransaction[]>({\n    queryKey: [\"/api/financial/staff\", selectedStaffId, \"transactions\"],\n    enabled: !!selectedStaffId,\n  });\n\n  const autoAllocateMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"POST\", \"/api/financial/auto-allocate\");\n    },\n    onSuccess: (data: any) => {\n      toast({\n        title: \"Auto-Allocation Complete\",\n        description: data.message || `Allocated ${data.allocatedCount} transactions`,\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/financial/staff-summary\"] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Auto-Allocation Failed\",\n        description: error.message || \"Could not auto-allocate transactions\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const autoCategorizeMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"POST\", \"/api/financial/auto-categorize\");\n    },\n    onSuccess: (data: any) => {\n      toast({\n        title: \"Auto-Categorize Complete\",\n        description: data.message || `Categorized ${data.categorizedCount} transactions`,\n      });\n      queryClient.invalidateQueries({ predicate: (query) => \n        typeof query.queryKey[0] === 'string' && query.queryKey[0].startsWith('/api/financial')\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Auto-Categorize Failed\",\n        description: error.message || \"Could not auto-categorize transactions\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  if (summaryLoading) {\n    return (\n      <div className=\"space-y-4\">\n        <Skeleton className=\"h-12 w-full\" />\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n          {[1, 2, 3].map(i => <Skeleton key={i} className=\"h-32\" />)}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between gap-4\">\n        <div>\n          <h3 className=\"text-lg font-semibold flex items-center gap-2\">\n            <Users className=\"h-5 w-5\" />\n            Staff Expenses\n          </h3>\n          <p className=\"text-sm text-muted-foreground\">\n            View and allocate transactions by staff member\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Button\n            onClick={() => autoCategorizeMutation.mutate()}\n            disabled={autoCategorizeMutation.isPending}\n            variant=\"outline\"\n            data-testid=\"button-auto-categorize\"\n          >\n            {autoCategorizeMutation.isPending ? (\n              <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n            ) : (\n              <Tag className=\"h-4 w-4 mr-2\" />\n            )}\n            Auto-Categorize\n          </Button>\n          <Button\n            onClick={() => autoAllocateMutation.mutate()}\n            disabled={autoAllocateMutation.isPending}\n            data-testid=\"button-auto-allocate\"\n          >\n            {autoAllocateMutation.isPending ? (\n              <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n            ) : (\n              <RefreshCw className=\"h-4 w-4 mr-2\" />\n            )}\n            Auto-Allocate by Card\n          </Button>\n        </div>\n      </div>\n\n      {staffSummary.length === 0 ? (\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <UserCircle className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n              <p className=\"font-medium\">No Staff Allocations Yet</p>\n              <p className=\"text-sm mt-1\">\n                Assign staff bank card numbers to auto-allocate transactions, or manually allocate them.\n              </p>\n            </div>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {staffSummary.map((staff) => (\n            <Card \n              key={staff.staffId}\n              className={`cursor-pointer hover-elevate transition-all ${selectedStaffId === staff.staffId ? 'ring-2 ring-primary' : ''}`}\n              onClick={() => setSelectedStaffId(selectedStaffId === staff.staffId ? null : staff.staffId)}\n              data-testid={`card-staff-${staff.staffId}`}\n            >\n              <CardContent className=\"pt-6\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"h-10 w-10 rounded-full bg-muted flex items-center justify-center\">\n                    <UserCircle className=\"h-6 w-6 text-muted-foreground\" />\n                  </div>\n                  <div className=\"flex-1\">\n                    <h4 className=\"font-medium\">{staff.staffName}</h4>\n                    <p className=\"text-xs text-muted-foreground\">\n                      {staff.transactionCount} transaction{staff.transactionCount !== 1 ? 's' : ''}\n                    </p>\n                  </div>\n                  <div className=\"text-right\">\n                    <p className=\"font-semibold text-lg\">{formatCurrency(staff.totalSpent)}</p>\n                    <p className=\"text-xs text-muted-foreground\">Total spent</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n\n      {selectedStaffId && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-base\">\n              Transactions for {staffSummary.find(s => s.staffId === selectedStaffId)?.staffName}\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            {transactionsLoading ? (\n              <div className=\"space-y-2\">\n                {[1, 2, 3].map(i => <Skeleton key={i} className=\"h-12\" />)}\n              </div>\n            ) : staffTransactions.length === 0 ? (\n              <p className=\"text-center text-muted-foreground py-4\">No transactions found</p>\n            ) : (\n              <div className=\"overflow-x-auto\">\n                <Table className=\"text-sm\">\n                  <TableHeader>\n                    <TableRow className=\"text-xs\">\n                      <TableHead className=\"py-2 w-[80px]\">Date</TableHead>\n                      <TableHead className=\"py-2 min-w-[300px]\">Description</TableHead>\n                      <TableHead className=\"py-2 w-[120px]\">Category</TableHead>\n                      <TableHead className=\"py-2 w-[120px]\">Staff</TableHead>\n                      <TableHead className=\"py-2 text-right w-[100px]\">Amount</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {staffTransactions.map((tx) => (\n                      <TransactionRowCompact key={tx.id} transaction={tx} />\n                    ))}\n                  </TableBody>\n                </Table>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n\n// Receipt Inbox Tab Component\ninterface ReceiptSubmission {\n  id: string;\n  staffId: string | null;\n  imageUrl: string | null;\n  photoUrl: string | null;\n  expenseCategoryId: string | null;\n  actualAmount: string | null;\n  amount: string | null;\n  merchantName: string | null;\n  purchaseDate: string | null;\n  notes: string | null;\n  status: string;\n  submissionToken: string;\n  submittedAt: string | null;\n  createdAt: string;\n}\n\nfunction ReceiptInboxTab() {\n  const { toast } = useToast();\n  const [selectedReceipt, setSelectedReceipt] = useState<ReceiptSubmission | null>(null);\n  const [showCreateLinkDialog, setShowCreateLinkDialog] = useState(false);\n  const [linkDescription, setLinkDescription] = useState(\"\");\n  const [linkAmount, setLinkAmount] = useState(\"\");\n\n  const { data: receipts = [], isLoading: receiptsLoading } = useQuery<ReceiptSubmission[]>({\n    queryKey: [\"/api/receipts\"],\n  });\n\n  const { data: pendingReceipts = [] } = useQuery<ReceiptSubmission[]>({\n    queryKey: [\"/api/receipts/pending\"],\n  });\n\n  const createLinkMutation = useMutation({\n    mutationFn: async (data: { description: string; amount?: string }) => {\n      return apiRequest(\"POST\", \"/api/receipts/create-link\", data);\n    },\n    onSuccess: (data: any) => {\n      toast({\n        title: \"Receipt Link Created\",\n        description: \"Share this link with your staff member to upload their receipt.\",\n      });\n      // Copy URL to clipboard\n      if (data.submissionUrl) {\n        navigator.clipboard.writeText(data.submissionUrl);\n        toast({\n          title: \"Link Copied\",\n          description: \"The receipt submission link has been copied to your clipboard.\",\n        });\n      }\n      queryClient.invalidateQueries({ queryKey: [\"/api/receipts\"] });\n      setShowCreateLinkDialog(false);\n      setLinkDescription(\"\");\n      setLinkAmount(\"\");\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to Create Link\",\n        description: error.message || \"Could not create receipt link\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const getStatusBadge = (status: string) => {\n    const styles: Record<string, string> = {\n      pending: \"bg-yellow-100 text-yellow-800\",\n      submitted: \"bg-blue-100 text-blue-800\",\n      reviewed: \"bg-green-100 text-green-800\",\n      matched: \"bg-purple-100 text-purple-800\",\n      rejected: \"bg-red-100 text-red-800\",\n    };\n    return styles[status] || \"bg-gray-100 text-gray-800\";\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between gap-4\">\n        <div>\n          <h3 className=\"text-lg font-semibold flex items-center gap-2\">\n            <Receipt className=\"h-5 w-5\" />\n            Receipt Inbox\n          </h3>\n          <p className=\"text-sm text-muted-foreground\">\n            Review staff receipt submissions and match to transactions\n          </p>\n        </div>\n        <Button\n          onClick={() => setShowCreateLinkDialog(true)}\n          data-testid=\"button-create-receipt-link\"\n        >\n          <Link2 className=\"h-4 w-4 mr-2\" />\n          Create Receipt Link\n        </Button>\n      </div>\n\n      {/* Pending count alert */}\n      {pendingReceipts.length > 0 && (\n        <Alert>\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>Pending Receipts</AlertTitle>\n          <AlertDescription>\n            You have {pendingReceipts.length} receipt{pendingReceipts.length !== 1 ? 's' : ''} waiting for submission or review.\n          </AlertDescription>\n        </Alert>\n      )}\n\n      {receiptsLoading ? (\n        <div className=\"space-y-2\">\n          {[1, 2, 3].map(i => <Skeleton key={i} className=\"h-16\" />)}\n        </div>\n      ) : receipts.length === 0 ? (\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <Receipt className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n              <p className=\"font-medium\">No Receipts Yet</p>\n              <p className=\"text-sm mt-1\">\n                Create a receipt link to share with staff for uploading receipts.\n              </p>\n            </div>\n          </CardContent>\n        </Card>\n      ) : (\n        <Card>\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Date</TableHead>\n                <TableHead>Description</TableHead>\n                <TableHead>Amount</TableHead>\n                <TableHead>Status</TableHead>\n                <TableHead>Actions</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {receipts.map((receipt) => (\n                <TableRow key={receipt.id} data-testid={`row-receipt-${receipt.id}`}>\n                  <TableCell className=\"text-sm\">\n                    {format(new Date(receipt.createdAt), \"dd MMM yyyy\")}\n                  </TableCell>\n                  <TableCell>\n                    <div className=\"font-medium text-sm truncate max-w-[200px]\">\n                      {receipt.merchantName || receipt.notes || \"No description\"}\n                    </div>\n                  </TableCell>\n                  <TableCell>\n                    {receipt.actualAmount || receipt.amount ? formatCurrency(receipt.actualAmount || receipt.amount) : \"-\"}\n                  </TableCell>\n                  <TableCell>\n                    <Badge className={getStatusBadge(receipt.status)}>\n                      {receipt.status}\n                    </Badge>\n                  </TableCell>\n                  <TableCell>\n                    <div className=\"flex items-center gap-2\">\n                      {(receipt.imageUrl || receipt.photoUrl) && (\n                        <Button\n                          size=\"icon\"\n                          variant=\"ghost\"\n                          onClick={() => window.open(receipt.imageUrl || receipt.photoUrl || '', '_blank')}\n                          data-testid={`button-view-receipt-${receipt.id}`}\n                        >\n                          <Eye className=\"h-4 w-4\" />\n                        </Button>\n                      )}\n                      {receipt.status === 'pending' && (\n                        <Button\n                          size=\"icon\"\n                          variant=\"ghost\"\n                          onClick={() => {\n                            const url = `${window.location.origin}/submit-receipt/${receipt.submissionToken}`;\n                            navigator.clipboard.writeText(url);\n                            toast({ title: \"Link copied to clipboard\" });\n                          }}\n                          data-testid={`button-copy-link-${receipt.id}`}\n                        >\n                          <Copy className=\"h-4 w-4\" />\n                        </Button>\n                      )}\n                    </div>\n                  </TableCell>\n                </TableRow>\n              ))}\n            </TableBody>\n          </Table>\n        </Card>\n      )}\n\n      {/* Create Receipt Link Dialog */}\n      <Dialog open={showCreateLinkDialog} onOpenChange={setShowCreateLinkDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Create Receipt Submission Link</DialogTitle>\n            <DialogDescription>\n              Generate a shareable link for staff to upload their receipt photo\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div>\n              <Label htmlFor=\"linkDescription\">Description (optional)</Label>\n              <Input\n                id=\"linkDescription\"\n                placeholder=\"e.g., Fuel receipt for site visit\"\n                value={linkDescription}\n                onChange={(e) => setLinkDescription(e.target.value)}\n                data-testid=\"input-link-description\"\n              />\n            </div>\n            <div>\n              <Label htmlFor=\"linkAmount\">Expected Amount (optional)</Label>\n              <Input\n                id=\"linkAmount\"\n                type=\"number\"\n                step=\"0.01\"\n                placeholder=\"e.g., 85.50\"\n                value={linkAmount}\n                onChange={(e) => setLinkAmount(e.target.value)}\n                data-testid=\"input-link-amount\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowCreateLinkDialog(false)}>\n              Cancel\n            </Button>\n            <Button\n              onClick={() => createLinkMutation.mutate({\n                description: linkDescription,\n                amount: linkAmount || undefined,\n              })}\n              disabled={createLinkMutation.isPending}\n              data-testid=\"button-generate-link\"\n            >\n              {createLinkMutation.isPending ? (\n                <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n              ) : (\n                <Link2 className=\"h-4 w-4 mr-2\" />\n              )}\n              Generate Link\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n\nexport default function Financial() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [activeTab, setActiveTab] = useState(\"overview\");\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [directionFilter, setDirectionFilter] = useState<string>(\"all\");\n  const [dateFrom, setDateFrom] = useState<string>(\"\");\n  const [dateTo, setDateTo] = useState<string>(\"\");\n  const [minAmount, setMinAmount] = useState<string>(\"\");\n  const [maxAmount, setMaxAmount] = useState<string>(\"\");\n  const [showConnectDialog, setShowConnectDialog] = useState(false);\n  const [businessName, setBusinessName] = useState(\"\");\n  const [businessIdNo, setBusinessIdNo] = useState(\"\");\n  const [businessIdNoType, setBusinessIdNoType] = useState(\"\");\n  const [businessAddress, setBusinessAddress] = useState(\"\");\n  const [organisationType, setOrganisationType] = useState(\"\");\n  const [sharingDuration, setSharingDuration] = useState(\"\");\n  const [email, setEmail] = useState(\"\");\n  const [, setLocation] = useLocation();\n  const isAdmin = user?.role === \"admin\";\n  \n  // CSV Import state\n  const [showImportDialog, setShowImportDialog] = useState(false);\n  const [importFile, setImportFile] = useState<File | null>(null);\n  const [importPreview, setImportPreview] = useState<string[][]>([]);\n  const [columnMapping, setColumnMapping] = useState<Record<string, string>>({\n    date: \"\",\n    description: \"\",\n    amount: \"\",\n    debitAmount: \"\",\n    creditAmount: \"\",\n    direction: \"\",\n  });\n  const [importErrors, setImportErrors] = useState<string[]>([]);\n  const [importResult, setImportResult] = useState<{ count: number; errors: string[] } | null>(null);\n\n  // Check URL for success/error from Basiq callback\n  useEffect(() => {\n    const params = new URLSearchParams(window.location.search);\n    const success = params.get(\"success\");\n    const error = params.get(\"error\");\n    const consentId = params.get(\"consentId\");\n\n    if (success === \"true\") {\n      toast({\n        title: \"Bank Connected Successfully\",\n        description: consentId \n          ? \"Your bank account has been connected via Open Banking.\"\n          : \"Bank connection was successful.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/financial/connections\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/financial/accounts\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/financial/overview\"] });\n      // Clean up URL\n      window.history.replaceState({}, \"\", \"/financial\");\n    } else if (error) {\n      toast({\n        title: \"Connection Failed\",\n        description: error === \"callback_failed\" \n          ? \"There was an issue completing the bank connection.\"\n          : error,\n        variant: \"destructive\",\n      });\n      window.history.replaceState({}, \"\", \"/financial\");\n    }\n  }, [toast]);\n\n  const { data: overview, isLoading: overviewLoading } = useQuery<FinancialOverview>({\n    queryKey: [\"/api/financial/overview\"],\n  });\n\n  const { data: accounts = [], isLoading: accountsLoading } = useQuery<BankAccount[]>({\n    queryKey: [\"/api/financial/accounts\"],\n  });\n\n  const { data: connections = [], isLoading: connectionsLoading } = useQuery<BankConnection[]>({\n    queryKey: [\"/api/financial/connections\"],\n    enabled: isAdmin,\n  });\n\n  // Quick date filter helpers\n  const setQuickDateFilter = (preset: 'last7' | 'last30' | 'thisMonth' | 'clear') => {\n    const today = new Date();\n    if (preset === 'last7') {\n      const from = new Date(today);\n      from.setDate(from.getDate() - 7);\n      setDateFrom(from.toISOString().split('T')[0]);\n      setDateTo(today.toISOString().split('T')[0]);\n    } else if (preset === 'last30') {\n      const from = new Date(today);\n      from.setDate(from.getDate() - 30);\n      setDateFrom(from.toISOString().split('T')[0]);\n      setDateTo(today.toISOString().split('T')[0]);\n    } else if (preset === 'thisMonth') {\n      const from = new Date(today.getFullYear(), today.getMonth(), 1);\n      setDateFrom(from.toISOString().split('T')[0]);\n      setDateTo(today.toISOString().split('T')[0]);\n    } else {\n      setDateFrom(\"\");\n      setDateTo(\"\");\n    }\n  };\n\n  // Build the transactions URL with query parameters\n  const transactionsUrl = (() => {\n    const params = new URLSearchParams();\n    if (searchQuery) params.set(\"search\", searchQuery);\n    if (directionFilter !== \"all\") params.set(\"direction\", directionFilter);\n    if (dateFrom) params.set(\"fromDate\", dateFrom);\n    if (dateTo) params.set(\"toDate\", dateTo);\n    if (minAmount) params.set(\"minAmount\", minAmount);\n    if (maxAmount) params.set(\"maxAmount\", maxAmount);\n    const queryString = params.toString();\n    return queryString ? `/api/financial/transactions?${queryString}` : \"/api/financial/transactions\";\n  })();\n  \n  const { data: transactions = [], isLoading: transactionsLoading } = useQuery<BankTransaction[]>({\n    queryKey: [transactionsUrl],\n  });\n\n  const syncMutation = useMutation({\n    mutationFn: async (accountId: string) => {\n      return apiRequest(\"POST\", `/api/financial/accounts/${accountId}/sync`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/financial/accounts\"] });\n      queryClient.invalidateQueries({ predicate: (query) => \n        typeof query.queryKey[0] === 'string' && query.queryKey[0].startsWith('/api/financial/transactions')\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/financial/overview\"] });\n      toast({ title: \"Sync Complete\", description: \"Transactions have been synced successfully.\" });\n    },\n    onError: (error: any) => {\n      toast({ \n        title: \"Sync Failed\", \n        description: error.message || \"Failed to sync transactions.\",\n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const refreshMutation = useMutation({\n    mutationFn: async (connectionId: string) => {\n      return apiRequest(\"POST\", `/api/financial/connections/${connectionId}/refresh`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/financial/connections\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/financial/accounts\"] });\n      toast({ title: \"Connection Refreshed\", description: \"Account data has been updated.\" });\n    },\n    onError: (error: any) => {\n      toast({ \n        title: \"Refresh Failed\", \n        description: error.message || \"Failed to refresh connection.\",\n        variant: \"destructive\" \n      });\n    },\n  });\n\n  // CDR Consent Flow - Create consent and redirect to Basiq Connect\n  const connectBankMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"POST\", \"/api/financial/connect-bank\", {\n        businessName,\n        businessIdNo,\n        businessIdNoType,\n        businessAddress,\n        organisationType,\n        sharingDuration: parseInt(sharingDuration) || 365,\n        email\n      });\n    },\n    onSuccess: (data: any) => {\n      setShowConnectDialog(false);\n      setBusinessName(\"\");\n      setBusinessIdNo(\"\");\n      setBusinessIdNoType(\"\");\n      setBusinessAddress(\"\");\n      setOrganisationType(\"\");\n      setSharingDuration(\"\");\n      setEmail(\"\");\n      \n      if (data.connectUrl) {\n        toast({ \n          title: \"Opening Bank Connection\", \n          description: \"You will be redirected to your bank's secure login to authorize access.\" \n        });\n        // Open in same window to allow redirect back\n        window.location.href = data.connectUrl;\n      } else {\n        toast({ \n          title: \"Connection Started\", \n          description: \"Bank connection process has begun.\",\n          variant: \"destructive\"\n        });\n      }\n    },\n    onError: (error: any) => {\n      toast({ \n        title: \"Connection Failed\", \n        description: error.message || \"Failed to start bank connection.\",\n        variant: \"destructive\" \n      });\n    },\n  });\n\n  // CSV Import mutation\n  const importCsvMutation = useMutation({\n    mutationFn: async (data: { rows: Record<string, string>[] }) => {\n      const res = await apiRequest(\"POST\", \"/api/financial/transactions/import\", data);\n      return res.json();\n    },\n    onSuccess: (data: any) => {\n      queryClient.invalidateQueries({ predicate: (query) => \n        typeof query.queryKey[0] === 'string' && query.queryKey[0].startsWith('/api/financial/transactions')\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/financial/overview\"] });\n      \n      const hasErrors = data.errors && data.errors.length > 0;\n      const importCount = data.count || 0;\n      \n      // Store errors for display in dialog\n      if (hasErrors) {\n        setImportErrors(data.errors);\n      }\n      \n      // If there are ANY errors, keep dialog open so user can see what went wrong\n      if (hasErrors) {\n        if (importCount === 0) {\n          toast({\n            title: \"Import Failed\",\n            description: \"No transactions were imported. Check the errors below and adjust your column mapping.\",\n            variant: \"destructive\",\n          });\n        } else {\n          toast({\n            title: \"Partial Import\",\n            description: `Imported ${importCount} transactions. ${data.errors.length} row(s) had issues - see details below.`,\n          });\n        }\n        // Keep dialog open - don't reset state\n        return;\n      }\n      \n      // Full success - all rows imported without errors\n      toast({\n        title: \"Import Complete\",\n        description: `Successfully imported ${importCount} transactions.`,\n      });\n      \n      // Close dialog and reset on full success only\n      setShowImportDialog(false);\n      setImportFile(null);\n      setImportPreview([]);\n      setImportErrors([]);\n      setColumnMapping({ date: \"\", description: \"\", amount: \"\", direction: \"\" });\n    },\n    onError: (error: any) => {\n      // Keep dialog open and show error\n      setImportErrors([error.message || \"Failed to import transactions. Please try again.\"]);\n      toast({\n        title: \"Import Failed\",\n        description: error.message || \"Failed to import transactions.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Handle CSV file selection and preview\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (!file) return;\n    \n    setImportFile(file);\n    \n    const reader = new FileReader();\n    reader.onload = (event) => {\n      const text = event.target?.result as string;\n      const lines = text.split('\\n').filter(line => line.trim());\n      const parsed = lines.slice(0, 6).map(line => {\n        const result: string[] = [];\n        let current = '';\n        let inQuotes = false;\n        for (const char of line) {\n          if (char === '\"') {\n            inQuotes = !inQuotes;\n          } else if (char === ',' && !inQuotes) {\n            result.push(current.trim());\n            current = '';\n          } else {\n            current += char;\n          }\n        }\n        result.push(current.trim());\n        return result;\n      });\n      setImportPreview(parsed);\n      \n      // Auto-detect column mapping from headers\n      if (parsed.length > 0) {\n        const headers = parsed[0].map(h => h.toLowerCase());\n        const newMapping: Record<string, string> = { date: \"\", description: \"\", amount: \"\", debitAmount: \"\", creditAmount: \"\", direction: \"\" };\n        headers.forEach((header, index) => {\n          if (header.includes('date') || header.includes('posted') || header.includes('transaction')) {\n            if (!newMapping.date) newMapping.date = index.toString();\n          }\n          if (header.includes('description') || header.includes('memo') || header.includes('narrative')) {\n            if (!newMapping.description) newMapping.description = index.toString();\n          }\n          // Check for separate debit/credit amount columns first\n          if (header.includes('debit') && header.includes('amount')) {\n            if (!newMapping.debitAmount) newMapping.debitAmount = index.toString();\n          } else if (header.includes('credit') && header.includes('amount')) {\n            if (!newMapping.creditAmount) newMapping.creditAmount = index.toString();\n          } else if (header.includes('amount') || header.includes('value') || header.includes('total')) {\n            if (!newMapping.amount) newMapping.amount = index.toString();\n          }\n          if (header.includes('type') || header.includes('direction') || header.includes('dr/cr')) {\n            if (!newMapping.direction) newMapping.direction = index.toString();\n          }\n        });\n        setColumnMapping(newMapping);\n      }\n    };\n    reader.readAsText(file);\n  };\n\n  // Process and submit CSV import\n  const handleImportSubmit = () => {\n    if (!importFile || importPreview.length < 2) return;\n    \n    const headers = importPreview[0];\n    const dataRows = importPreview.slice(1);\n    \n    // Parse full file for import\n    const reader = new FileReader();\n    reader.onload = (event) => {\n      const text = event.target?.result as string;\n      const lines = text.split('\\n').filter(line => line.trim());\n      const allRows = lines.slice(1).map(line => {\n        const result: string[] = [];\n        let current = '';\n        let inQuotes = false;\n        for (const char of line) {\n          if (char === '\"') {\n            inQuotes = !inQuotes;\n          } else if (char === ',' && !inQuotes) {\n            result.push(current.trim());\n            current = '';\n          } else {\n            current += char;\n          }\n        }\n        result.push(current.trim());\n        return result;\n      });\n      \n      const mappedRows = allRows.map(row => {\n        let normalizedAmount = \"0\";\n        let direction = \"\";\n        \n        // Check if using separate debit/credit columns\n        if (columnMapping.debitAmount || columnMapping.creditAmount) {\n          const debitVal = columnMapping.debitAmount ? row[parseInt(columnMapping.debitAmount)] : \"\";\n          const creditVal = columnMapping.creditAmount ? row[parseInt(columnMapping.creditAmount)] : \"\";\n          \n          // Clean and parse both values\n          const cleanDebit = debitVal.replace(/[$A-Za-z,\\s]/g, '').replace(/\\(([0-9.]+)\\)/, '$1');\n          const cleanCredit = creditVal.replace(/[$A-Za-z,\\s]/g, '').replace(/\\(([0-9.]+)\\)/, '$1');\n          \n          const debitNum = parseFloat(cleanDebit) || 0;\n          const creditNum = parseFloat(cleanCredit) || 0;\n          \n          if (debitNum > 0) {\n            normalizedAmount = debitNum.toString();\n            direction = \"debit\";\n          } else if (creditNum > 0) {\n            normalizedAmount = creditNum.toString();\n            direction = \"credit\";\n          }\n        } else {\n          // Single amount column\n          const rawAmount = columnMapping.amount ? row[parseInt(columnMapping.amount)] : \"0\";\n          const rawDirection = columnMapping.direction ? row[parseInt(columnMapping.direction)] : \"\";\n          \n          // Normalize amount: strip currency symbols, spaces, handle parentheses for negatives\n          normalizedAmount = rawAmount\n            .replace(/[$A-Za-z,\\s]/g, '')  // Remove currency symbols, letters, commas, spaces\n            .replace(/\\(([0-9.]+)\\)/, '-$1'); // Convert (123.45) to -123.45\n          \n          const numAmount = parseFloat(normalizedAmount) || 0;\n          \n          // Derive direction from amount sign if not explicitly mapped\n          direction = rawDirection;\n          if (!direction && numAmount !== 0) {\n            direction = numAmount < 0 ? \"debit\" : \"credit\";\n          }\n        }\n        \n        return {\n          transactionDate: columnMapping.date ? row[parseInt(columnMapping.date)] : \"\",\n          description: columnMapping.description ? row[parseInt(columnMapping.description)] : \"\",\n          amount: normalizedAmount,\n          direction,\n        };\n      });\n      \n      // Clear any previous errors before submitting\n      setImportErrors([]);\n      \n      importCsvMutation.mutate({ rows: mappedRows });\n    };\n    reader.readAsText(importFile);\n  };\n\n  return (\n    <div className=\"flex-1 p-6 space-y-6\">\n      <div className=\"flex items-center justify-between gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold flex items-center gap-2\" data-testid=\"heading-financial\">\n            <Landmark className=\"h-6 w-6\" />\n            Banking\n          </h1>\n          <p className=\"text-muted-foreground mt-1\">\n            Monitor your bank accounts and transactions via secure Open Banking\n          </p>\n        </div>\n        {isAdmin && (\n          <Button \n            data-testid=\"button-connect-bank\" \n            onClick={() => setShowConnectDialog(true)}\n          >\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Connect Bank Account\n          </Button>\n        )}\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList>\n          <TabsTrigger value=\"overview\" data-testid=\"tab-overview\">Overview</TabsTrigger>\n          <TabsTrigger value=\"accounts\" data-testid=\"tab-accounts\">Accounts ({accounts.length})</TabsTrigger>\n          <TabsTrigger value=\"transactions\" data-testid=\"tab-transactions\">Transactions</TabsTrigger>\n          {isAdmin && (\n            <TabsTrigger value=\"staff\" data-testid=\"tab-staff\">Staff Expenses</TabsTrigger>\n          )}\n          {isAdmin && (\n            <TabsTrigger value=\"receipts\" data-testid=\"tab-receipts\">Receipt Inbox</TabsTrigger>\n          )}\n          {isAdmin && (\n            <TabsTrigger value=\"connections\" data-testid=\"tab-connections\">Connections</TabsTrigger>\n          )}\n        </TabsList>\n\n        <TabsContent value=\"overview\" className=\"space-y-6 mt-6\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n            <OverviewCard\n              title=\"Total Balance\"\n              value={formatCurrency(overview?.totalBalance)}\n              icon={DollarSign}\n              loading={overviewLoading}\n            />\n            <OverviewCard\n              title=\"Available Funds\"\n              value={formatCurrency(overview?.totalAvailable)}\n              icon={Wallet}\n              loading={overviewLoading}\n            />\n            <OverviewCard\n              title=\"Monthly Income\"\n              value={formatCurrency(overview?.monthlyIncome)}\n              icon={TrendingUp}\n              trend=\"up\"\n              trendValue=\"Credits (30 days)\"\n              loading={overviewLoading}\n            />\n            <OverviewCard\n              title=\"Monthly Expenses\"\n              value={formatCurrency(overview?.monthlyExpenses)}\n              icon={TrendingDown}\n              trend=\"down\"\n              trendValue=\"Debits (30 days)\"\n              loading={overviewLoading}\n            />\n          </div>\n\n          <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n            <Card className=\"lg:col-span-2\">\n              <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0\">\n                <div>\n                  <CardTitle>Recent Transactions</CardTitle>\n                  <CardDescription>Latest activity across all accounts</CardDescription>\n                </div>\n                <Button variant=\"outline\" size=\"sm\" onClick={() => setActiveTab(\"transactions\")}>\n                  View All\n                </Button>\n              </CardHeader>\n              <CardContent>\n                {overviewLoading ? (\n                  <div className=\"space-y-4\">\n                    {[1, 2, 3, 4, 5].map(i => (\n                      <div key={i} className=\"flex items-center gap-3\">\n                        <Skeleton className=\"h-10 w-10 rounded-full\" />\n                        <div className=\"flex-1\">\n                          <Skeleton className=\"h-4 w-32 mb-1\" />\n                          <Skeleton className=\"h-3 w-24\" />\n                        </div>\n                        <Skeleton className=\"h-5 w-20\" />\n                      </div>\n                    ))}\n                  </div>\n                ) : overview?.recentTransactions && overview.recentTransactions.length > 0 ? (\n                  <Table>\n                    <TableBody>\n                      {overview.recentTransactions.map((tx) => (\n                        <TransactionRow key={tx.id} transaction={tx} />\n                      ))}\n                    </TableBody>\n                  </Table>\n                ) : (\n                  <EmptyState type=\"transactions\" />\n                )}\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader>\n                <CardTitle>Accounts</CardTitle>\n                <CardDescription>Connected bank accounts</CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-3\">\n                {accountsLoading ? (\n                  <div className=\"space-y-3\">\n                    {[1, 2].map(i => (\n                      <Skeleton key={i} className=\"h-20 w-full rounded-lg\" />\n                    ))}\n                  </div>\n                ) : accounts.length > 0 ? (\n                  accounts.slice(0, 3).map(account => (\n                    <div key={account.id} className=\"flex items-center justify-between p-3 border rounded-lg\">\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"h-9 w-9 rounded bg-muted flex items-center justify-center\">\n                          <Landmark className=\"h-4 w-4 text-muted-foreground\" />\n                        </div>\n                        <div>\n                          <p className=\"font-medium text-sm\">{account.name}</p>\n                          <p className=\"text-xs text-muted-foreground\">\n                            {account.accountType?.replace(\"_\", \" \")}\n                          </p>\n                        </div>\n                      </div>\n                      <p className=\"font-semibold\">{formatCurrency(account.balance)}</p>\n                    </div>\n                  ))\n                ) : (\n                  <EmptyState type=\"accounts\" />\n                )}\n                {accounts.length > 3 && (\n                  <Button \n                    variant=\"ghost\" \n                    className=\"w-full\" \n                    size=\"sm\"\n                    onClick={() => setActiveTab(\"accounts\")}\n                  >\n                    View all {accounts.length} accounts\n                  </Button>\n                )}\n              </CardContent>\n            </Card>\n          </div>\n        </TabsContent>\n\n        <TabsContent value=\"accounts\" className=\"mt-6\">\n          {accountsLoading ? (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n              {[1, 2, 3].map(i => (\n                <Skeleton key={i} className=\"h-40 rounded-lg\" />\n              ))}\n            </div>\n          ) : accounts.length > 0 ? (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n              {accounts.map(account => (\n                <AccountCard \n                  key={account.id} \n                  account={account} \n                  onSync={(id) => syncMutation.mutate(id)}\n                  isSyncing={syncMutation.isPending}\n                />\n              ))}\n            </div>\n          ) : (\n            <Card>\n              <CardContent className=\"pt-6\">\n                <EmptyState type=\"accounts\" />\n              </CardContent>\n            </Card>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"transactions\" className=\"mt-6 space-y-4\">\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex flex-col gap-3\">\n                <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n                  <CardTitle>All Transactions</CardTitle>\n                  {isAdmin && (\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => setShowImportDialog(true)}\n                      data-testid=\"button-import-csv\"\n                    >\n                      <Upload className=\"h-4 w-4 mr-2\" />\n                      Import CSV\n                    </Button>\n                  )}\n                </div>\n                \n                {/* Quick date filters */}\n                <div className=\"flex items-center gap-2 flex-wrap\">\n                  <span className=\"text-sm text-muted-foreground\">Quick:</span>\n                  <Button\n                    variant={dateFrom && !dateTo ? \"default\" : \"outline\"}\n                    size=\"sm\"\n                    onClick={() => setQuickDateFilter('last7')}\n                    data-testid=\"button-last-7-days\"\n                  >\n                    Last 7 Days\n                  </Button>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => setQuickDateFilter('thisMonth')}\n                    data-testid=\"button-this-month\"\n                  >\n                    This Month\n                  </Button>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => setQuickDateFilter('last30')}\n                    data-testid=\"button-last-30-days\"\n                  >\n                    Last 30 Days\n                  </Button>\n                  {(dateFrom || dateTo) && (\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => setQuickDateFilter('clear')}\n                      data-testid=\"button-clear-date\"\n                    >\n                      Clear Dates\n                    </Button>\n                  )}\n                </div>\n\n                {/* Filters row */}\n                <div className=\"flex items-center gap-2 flex-wrap\">\n                  <div className=\"relative\">\n                    <Search className=\"absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                    <Input\n                      placeholder=\"Search...\"\n                      value={searchQuery}\n                      onChange={(e) => setSearchQuery(e.target.value)}\n                      className=\"pl-8 h-8 w-[180px] text-sm\"\n                      data-testid=\"input-search-transactions\"\n                    />\n                  </div>\n                  <Select value={directionFilter} onValueChange={setDirectionFilter}>\n                    <SelectTrigger className=\"w-[110px] h-8 text-sm\" data-testid=\"select-direction-filter\">\n                      <SelectValue placeholder=\"Type\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">All Types</SelectItem>\n                      <SelectItem value=\"credit\">Credits</SelectItem>\n                      <SelectItem value=\"debit\">Debits</SelectItem>\n                    </SelectContent>\n                  </Select>\n                  <Input\n                    type=\"date\"\n                    value={dateFrom}\n                    onChange={(e) => setDateFrom(e.target.value)}\n                    className=\"h-8 w-[130px] text-sm\"\n                    placeholder=\"From\"\n                    data-testid=\"input-date-from\"\n                  />\n                  <Input\n                    type=\"date\"\n                    value={dateTo}\n                    onChange={(e) => setDateTo(e.target.value)}\n                    className=\"h-8 w-[130px] text-sm\"\n                    placeholder=\"To\"\n                    data-testid=\"input-date-to\"\n                  />\n                  <Input\n                    type=\"number\"\n                    value={minAmount}\n                    onChange={(e) => setMinAmount(e.target.value)}\n                    placeholder=\"Min $\"\n                    className=\"h-8 w-[80px] text-sm\"\n                    data-testid=\"input-min-amount\"\n                  />\n                  <Input\n                    type=\"number\"\n                    value={maxAmount}\n                    onChange={(e) => setMaxAmount(e.target.value)}\n                    placeholder=\"Max $\"\n                    className=\"h-8 w-[80px] text-sm\"\n                    data-testid=\"input-max-amount\"\n                  />\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {transactionsLoading ? (\n                <div className=\"space-y-1\">\n                  {[1, 2, 3, 4, 5, 6, 7, 8].map(i => (\n                    <Skeleton key={i} className=\"h-8 w-full\" />\n                  ))}\n                </div>\n              ) : transactions.length > 0 ? (\n                <div className=\"overflow-x-auto\">\n                  <Table className=\"text-sm\">\n                    <TableHeader>\n                      <TableRow className=\"text-xs\">\n                        <TableHead className=\"py-2 w-[80px]\">Date</TableHead>\n                        <TableHead className=\"py-2 min-w-[300px]\">Description</TableHead>\n                        <TableHead className=\"py-2 w-[120px]\">Category</TableHead>\n                        <TableHead className=\"py-2 w-[120px]\">Staff</TableHead>\n                        <TableHead className=\"py-2 text-right w-[100px]\">Amount</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {transactions.map((tx) => (\n                        <TransactionRowCompact key={tx.id} transaction={tx} />\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              ) : (\n                <EmptyState type=\"transactions\" />\n              )}\n              {transactions.length > 0 && (\n                <div className=\"mt-3 text-sm text-muted-foreground\">\n                  Showing {transactions.length} transaction{transactions.length !== 1 ? 's' : ''}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        {isAdmin && (\n          <TabsContent value=\"connections\" className=\"mt-6 space-y-4\">\n            <Alert>\n              <AlertCircle className=\"h-4 w-4\" />\n              <AlertTitle>Secure Open Banking</AlertTitle>\n              <AlertDescription>\n                Bank connections use CDR (Consumer Data Right) Open Banking. Your credentials are never stored in this system - \n                you authenticate directly with your bank via their secure login.\n              </AlertDescription>\n            </Alert>\n\n            {connectionsLoading ? (\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {[1, 2].map(i => (\n                  <Skeleton key={i} className=\"h-32 rounded-lg\" />\n                ))}\n              </div>\n            ) : connections.length > 0 ? (\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {connections.map(connection => (\n                  <ConnectionCard \n                    key={connection.id} \n                    connection={connection}\n                    onRefresh={(id) => refreshMutation.mutate(id)}\n                  />\n                ))}\n              </div>\n            ) : (\n              <Card>\n                <CardContent className=\"pt-6\">\n                  <EmptyState type=\"connections\" />\n                  <div className=\"flex justify-center mt-4\">\n                    <Button onClick={() => setShowConnectDialog(true)}>\n                      <Plus className=\"h-4 w-4 mr-2\" />\n                      Connect Your First Bank\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n            )}\n          </TabsContent>\n        )}\n\n        {/* Staff Expenses Tab */}\n        {isAdmin && (\n          <TabsContent value=\"staff\" className=\"mt-6 space-y-4\">\n            <StaffExpensesTab />\n          </TabsContent>\n        )}\n\n        {/* Receipt Inbox Tab */}\n        {isAdmin && (\n          <TabsContent value=\"receipts\" className=\"mt-6 space-y-4\">\n            <ReceiptInboxTab />\n          </TabsContent>\n        )}\n      </Tabs>\n\n      {/* Connect Bank Dialog - Simple CDR Consent Flow */}\n      <Dialog open={showConnectDialog} onOpenChange={setShowConnectDialog}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Building2 className=\"h-5 w-5\" />\n              Connect Bank Account\n            </DialogTitle>\n            <DialogDescription>\n              Securely connect your business bank account using Open Banking\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4 py-4\">\n            <Alert>\n              <CheckCircle2 className=\"h-4 w-4 text-green-600\" />\n              <AlertTitle>Secure CDR Open Banking</AlertTitle>\n              <AlertDescription className=\"text-sm\">\n                You will be redirected to your bank&apos;s secure login page to authorize access. \n                Your credentials are never shared with us.\n              </AlertDescription>\n            </Alert>\n\n            <div className=\"space-y-3\">\n              <div>\n                <Label htmlFor=\"businessName\" className=\"text-sm font-medium\">Business Name</Label>\n                <Input \n                  id=\"businessName\"\n                  placeholder=\"e.g., Probuild PVC\" \n                  value={businessName}\n                  onChange={(e) => setBusinessName(e.target.value)}\n                  data-testid=\"input-business-name\"\n                />\n              </div>\n              \n              <div>\n                <Label htmlFor=\"businessIdNo\" className=\"text-sm font-medium\">ABN (Australian Business Number)</Label>\n                <Input \n                  id=\"businessIdNo\"\n                  placeholder=\"e.g., 29 688 327 479\" \n                  value={businessIdNo}\n                  onChange={(e) => setBusinessIdNo(e.target.value)}\n                  data-testid=\"input-business-id\"\n                />\n              </div>\n\n              <div>\n                <Label htmlFor=\"businessIdNoType\" className=\"text-sm font-medium\">Business ID Type</Label>\n                <Input \n                  id=\"businessIdNoType\"\n                  placeholder=\"e.g., ABN\" \n                  value={businessIdNoType}\n                  onChange={(e) => setBusinessIdNoType(e.target.value)}\n                  data-testid=\"input-business-id-type\"\n                />\n              </div>\n\n              <div>\n                <Label htmlFor=\"businessAddress\" className=\"text-sm font-medium\">Business Address</Label>\n                <Input \n                  id=\"businessAddress\"\n                  placeholder=\"e.g., 123 Main Street, Perth WA 6000\" \n                  value={businessAddress}\n                  onChange={(e) => setBusinessAddress(e.target.value)}\n                  data-testid=\"input-business-address\"\n                />\n              </div>\n\n              <div>\n                <Label htmlFor=\"organisationType\" className=\"text-sm font-medium\">Organisation Type</Label>\n                <Input \n                  id=\"organisationType\"\n                  placeholder=\"e.g., COMPANY\" \n                  value={organisationType}\n                  onChange={(e) => setOrganisationType(e.target.value)}\n                  data-testid=\"input-organisation-type\"\n                />\n              </div>\n\n              <div>\n                <Label htmlFor=\"sharingDuration\" className=\"text-sm font-medium\">Sharing Duration (days)</Label>\n                <Input \n                  id=\"sharingDuration\"\n                  placeholder=\"e.g., 365\" \n                  value={sharingDuration}\n                  onChange={(e) => setSharingDuration(e.target.value)}\n                  data-testid=\"input-sharing-duration\"\n                  type=\"number\"\n                />\n              </div>\n\n              <div>\n                <Label htmlFor=\"email\" className=\"text-sm font-medium\">Email</Label>\n                <Input \n                  id=\"email\"\n                  placeholder=\"e.g., vonnie@probuildpvc.com.au\" \n                  value={email}\n                  onChange={(e) => setEmail(e.target.value)}\n                  data-testid=\"input-email\"\n                  type=\"email\"\n                />\n              </div>\n            </div>\n\n            <div className=\"bg-muted/50 rounded-lg p-4 space-y-2\">\n              <p className=\"text-sm font-medium\">Data Access Requested</p>\n              <ul className=\"text-sm text-muted-foreground list-disc list-inside space-y-1\">\n                <li>Account details and balances</li>\n                <li>Transaction history</li>\n              </ul>\n              <p className=\"text-xs text-muted-foreground mt-2\">\n                Access is valid for 365 days and can be revoked at any time.\n              </p>\n            </div>\n          </div>\n\n          <DialogFooter className=\"flex-col sm:flex-row gap-2\">\n            <Button \n              variant=\"outline\" \n              onClick={() => {\n                setShowConnectDialog(false);\n                setBusinessName(\"\");\n                setBusinessIdNo(\"\");\n                setBusinessIdNoType(\"\");\n                setBusinessAddress(\"\");\n                setOrganisationType(\"\");\n                setSharingDuration(\"\");\n                setEmail(\"\");\n              }}\n              className=\"w-full sm:w-auto\"\n              data-testid=\"button-cancel-connection\"\n            >\n              Cancel\n            </Button>\n            <Button \n              onClick={() => connectBankMutation.mutate()}\n              disabled={connectBankMutation.isPending || !businessName || !businessIdNo || !businessIdNoType || !businessAddress || !organisationType || !sharingDuration || !email}\n              className=\"w-full sm:w-auto\"\n              data-testid=\"button-start-connection\"\n            >\n              {connectBankMutation.isPending ? (\n                <>\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  Connecting...\n                </>\n              ) : (\n                <>\n                  <ExternalLink className=\"h-4 w-4 mr-2\" />\n                  Connect to Bank\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* CSV Import Dialog */}\n      <Dialog open={showImportDialog} onOpenChange={setShowImportDialog}>\n        <DialogContent className=\"w-[min(90vw,900px)] max-w-4xl max-h-[85vh] flex flex-col overflow-hidden\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <FileSpreadsheet className=\"h-5 w-5\" />\n              Import Transactions from CSV\n            </DialogTitle>\n            <DialogDescription>\n              Upload a CSV file from your bank export. Map the columns to import transactions.\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"flex-1 overflow-y-auto space-y-4\">\n            <div>\n              <Label htmlFor=\"csv-file\" className=\"text-sm font-medium\">CSV File</Label>\n              <Input\n                id=\"csv-file\"\n                type=\"file\"\n                accept=\".csv\"\n                onChange={handleFileSelect}\n                className=\"mt-1\"\n                data-testid=\"input-csv-file\"\n              />\n            </div>\n\n            {importPreview.length > 0 && (\n              <>\n                <div className=\"space-y-3\">\n                  <Label className=\"text-sm font-medium\">Column Mapping</Label>\n                  <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3\">\n                    <div>\n                      <Label className=\"text-xs text-muted-foreground\">Date Column</Label>\n                      <Select value={columnMapping.date} onValueChange={(v) => setColumnMapping(prev => ({ ...prev, date: v }))}>\n                        <SelectTrigger data-testid=\"select-date-column\">\n                          <SelectValue placeholder=\"Select column\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {importPreview[0].map((header, idx) => (\n                            <SelectItem key={idx} value={idx.toString()}>{header}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div>\n                      <Label className=\"text-xs text-muted-foreground\">Description Column</Label>\n                      <Select value={columnMapping.description} onValueChange={(v) => setColumnMapping(prev => ({ ...prev, description: v }))}>\n                        <SelectTrigger data-testid=\"select-description-column\">\n                          <SelectValue placeholder=\"Select column\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {importPreview[0].map((header, idx) => (\n                            <SelectItem key={idx} value={idx.toString()}>{header}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div>\n                      <Label className=\"text-xs text-muted-foreground\">Amount Column (or leave empty if using Debit/Credit)</Label>\n                      <Select \n                        value={columnMapping.amount || \"__none__\"} \n                        onValueChange={(v) => setColumnMapping(prev => ({ ...prev, amount: v === \"__none__\" ? \"\" : v }))}\n                      >\n                        <SelectTrigger data-testid=\"select-amount-column\">\n                          <SelectValue placeholder=\"Select column\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"__none__\">None (use Debit/Credit columns)</SelectItem>\n                          {importPreview[0].map((header, idx) => (\n                            <SelectItem key={idx} value={idx.toString()}>{header}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div>\n                      <Label className=\"text-xs text-muted-foreground\">Debit Amount Column</Label>\n                      <Select \n                        value={columnMapping.debitAmount || \"__none__\"} \n                        onValueChange={(v) => setColumnMapping(prev => ({ ...prev, debitAmount: v === \"__none__\" ? \"\" : v }))}\n                      >\n                        <SelectTrigger data-testid=\"select-debit-column\">\n                          <SelectValue placeholder=\"Select column\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"__none__\">None</SelectItem>\n                          {importPreview[0].map((header, idx) => (\n                            <SelectItem key={idx} value={idx.toString()}>{header}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div>\n                      <Label className=\"text-xs text-muted-foreground\">Credit Amount Column</Label>\n                      <Select \n                        value={columnMapping.creditAmount || \"__none__\"} \n                        onValueChange={(v) => setColumnMapping(prev => ({ ...prev, creditAmount: v === \"__none__\" ? \"\" : v }))}\n                      >\n                        <SelectTrigger data-testid=\"select-credit-column\">\n                          <SelectValue placeholder=\"Select column\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"__none__\">None</SelectItem>\n                          {importPreview[0].map((header, idx) => (\n                            <SelectItem key={idx} value={idx.toString()}>{header}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  </div>\n                </div>\n\n                <div>\n                  <Label className=\"text-sm font-medium\">Preview (first 5 rows)</Label>\n                  <div className=\"mt-2 border rounded-lg overflow-x-auto\">\n                    <Table>\n                      <TableHeader>\n                        <TableRow>\n                          {importPreview[0].map((header, idx) => (\n                            <TableHead key={idx} className=\"whitespace-nowrap text-xs\">{header}</TableHead>\n                          ))}\n                        </TableRow>\n                      </TableHeader>\n                      <TableBody>\n                        {importPreview.slice(1, 5).map((row, rowIdx) => (\n                          <TableRow key={rowIdx}>\n                            {row.map((cell, cellIdx) => (\n                              <TableCell key={cellIdx} className=\"text-xs whitespace-nowrap\">{cell}</TableCell>\n                            ))}\n                          </TableRow>\n                        ))}\n                      </TableBody>\n                    </Table>\n                  </div>\n                </div>\n              </>\n            )}\n\n            {/* Error Display */}\n            {importErrors.length > 0 && (\n              <Alert variant=\"destructive\">\n                <AlertCircle className=\"h-4 w-4\" />\n                <AlertTitle>Import Errors</AlertTitle>\n                <AlertDescription>\n                  <ul className=\"list-disc list-inside text-xs mt-1 space-y-1 max-h-32 overflow-y-auto\">\n                    {importErrors.slice(0, 10).map((error, idx) => (\n                      <li key={idx}>{error}</li>\n                    ))}\n                    {importErrors.length > 10 && (\n                      <li className=\"text-muted-foreground\">...and {importErrors.length - 10} more errors</li>\n                    )}\n                  </ul>\n                </AlertDescription>\n              </Alert>\n            )}\n          </div>\n\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setShowImportDialog(false);\n                setImportFile(null);\n                setImportPreview([]);\n                setImportErrors([]);\n                setImportResult(null);\n                setColumnMapping({ date: \"\", description: \"\", amount: \"\", debitAmount: \"\", creditAmount: \"\", direction: \"\" });\n              }}\n              data-testid=\"button-cancel-import\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleImportSubmit}\n              disabled={importCsvMutation.isPending || !importFile || !columnMapping.date || !columnMapping.description || (!columnMapping.amount && !columnMapping.debitAmount && !columnMapping.creditAmount)}\n              data-testid=\"button-submit-import\"\n            >\n              {importCsvMutation.isPending ? (\n                <>\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  Importing...\n                </>\n              ) : (\n                <>\n                  <Upload className=\"h-4 w-4 mr-2\" />\n                  Import Transactions\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":79539,"size_tokens":null},"client/src/pages/JobStageConfiguration.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Plus,\n  Pencil,\n  Trash2,\n  GripVertical,\n  ChevronRight,\n  ChevronDown,\n  Settings2,\n  Workflow,\n  CheckCircle2,\n  Circle,\n  AlertCircle,\n} from \"lucide-react\";\nimport type { JobPipeline, JobPipelineStage } from \"@shared/schema\";\n\ninterface PipelineCardProps {\n  pipeline: JobPipeline;\n  isExpanded: boolean;\n  onToggleExpand: () => void;\n  onEditPipeline: (pipeline: JobPipeline) => void;\n  onDeletePipeline: (id: string) => void;\n  onAddStage: (pipelineId: string) => void;\n  onEditStage: (stage: JobPipelineStage) => void;\n  onDeleteStage: (id: string, pipelineId: string) => void;\n  deletePending: boolean;\n}\n\nfunction PipelineCard({\n  pipeline,\n  isExpanded,\n  onToggleExpand,\n  onEditPipeline,\n  onDeletePipeline,\n  onAddStage,\n  onEditStage,\n  onDeleteStage,\n  deletePending,\n}: PipelineCardProps) {\n  const { toast } = useToast();\n\n  const { data: stages = [] } = useQuery<JobPipelineStage[]>({\n    queryKey: [\"/api/job-pipelines\", pipeline.id, \"stages\"],\n    enabled: isExpanded,\n  });\n\n  const reorderStagesMutation = useMutation({\n    mutationFn: async ({ pipelineId, stageIds }: { pipelineId: string; stageIds: string[] }) => {\n      return apiRequest(\"POST\", `/api/job-pipelines/${pipelineId}/stages/reorder`, { stageIds });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/job-pipelines\", pipeline.id, \"stages\"] });\n    },\n    onError: () => {\n      toast({ title: \"Failed to reorder stages\", variant: \"destructive\" });\n    },\n  });\n\n  const moveStage = (fromIndex: number, direction: \"up\" | \"down\") => {\n    const toIndex = direction === \"up\" ? fromIndex - 1 : fromIndex + 1;\n    if (toIndex < 0 || toIndex >= stages.length) return;\n\n    const newStages = [...stages];\n    const temp = newStages[fromIndex];\n    newStages[fromIndex] = newStages[toIndex];\n    newStages[toIndex] = temp;\n\n    reorderStagesMutation.mutate({\n      pipelineId: pipeline.id,\n      stageIds: newStages.map((s) => s.id),\n    });\n  };\n\n  return (\n    <Card data-testid={`card-pipeline-${pipeline.id}`}>\n      <CardHeader className=\"pb-3\">\n        <div className=\"flex items-center justify-between gap-4\">\n          <div\n            className=\"flex items-center gap-3 cursor-pointer flex-1\"\n            onClick={onToggleExpand}\n            data-testid={`button-toggle-pipeline-${pipeline.id}`}\n          >\n            {isExpanded ? (\n              <ChevronDown className=\"h-5 w-5 text-muted-foreground\" />\n            ) : (\n              <ChevronRight className=\"h-5 w-5 text-muted-foreground\" />\n            )}\n            <div>\n              <CardTitle className=\"text-lg flex items-center gap-2\">\n                {pipeline.name}\n                {!pipeline.isActive && (\n                  <Badge variant=\"secondary\" className=\"text-xs\">\n                    Inactive\n                  </Badge>\n                )}\n              </CardTitle>\n              {pipeline.description && (\n                <CardDescription>{pipeline.description}</CardDescription>\n              )}\n            </div>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Badge variant=\"outline\" data-testid={`text-stage-count-${pipeline.id}`}>\n              {stages.length} stages\n            </Badge>\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              onClick={() => onEditPipeline(pipeline)}\n              data-testid={`button-edit-pipeline-${pipeline.id}`}\n            >\n              <Pencil className=\"h-4 w-4\" />\n            </Button>\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              disabled={deletePending}\n              onClick={() => {\n                if (confirm(\"Are you sure you want to delete this pipeline?\")) {\n                  onDeletePipeline(pipeline.id);\n                }\n              }}\n              data-testid={`button-delete-pipeline-${pipeline.id}`}\n            >\n              <Trash2 className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </div>\n      </CardHeader>\n\n      {isExpanded && (\n        <CardContent>\n          <div className=\"space-y-2\">\n            {stages.length === 0 ? (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <Circle className=\"h-8 w-8 mx-auto mb-2\" />\n                <p>No stages defined yet</p>\n              </div>\n            ) : (\n              stages.map((stage, index) => (\n                <div\n                  key={stage.id}\n                  className=\"flex items-center gap-3 p-3 rounded-lg border bg-card hover-elevate\"\n                  data-testid={`stage-${stage.id}`}\n                >\n                  <div className=\"flex flex-col gap-1\">\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      className=\"h-5 w-5\"\n                      disabled={index === 0 || reorderStagesMutation.isPending}\n                      onClick={() => moveStage(index, \"up\")}\n                      data-testid={`button-stage-up-${stage.id}`}\n                    >\n                      <ChevronRight className=\"h-3 w-3 -rotate-90\" />\n                    </Button>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      className=\"h-5 w-5\"\n                      disabled={index === stages.length - 1 || reorderStagesMutation.isPending}\n                      onClick={() => moveStage(index, \"down\")}\n                      data-testid={`button-stage-down-${stage.id}`}\n                    >\n                      <ChevronRight className=\"h-3 w-3 rotate-90\" />\n                    </Button>\n                  </div>\n                  <GripVertical className=\"h-4 w-4 text-muted-foreground\" />\n                  <span className=\"text-sm font-medium text-muted-foreground w-6\">\n                    {index + 1}\n                  </span>\n                  <div className=\"flex-1\">\n                    <span className=\"font-medium\" data-testid={`text-stage-name-${stage.id}`}>\n                      {stage.name}\n                    </span>\n                    <div className=\"flex items-center gap-2 mt-1\">\n                      {stage.completionType === \"automatic\" ? (\n                        <Badge variant=\"secondary\" className=\"text-xs\">\n                          <CheckCircle2 className=\"h-3 w-3 mr-1\" />\n                          Auto\n                        </Badge>\n                      ) : (\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          <Circle className=\"h-3 w-3 mr-1\" />\n                          Manual\n                        </Badge>\n                      )}\n                      {!stage.isActive && (\n                        <Badge variant=\"secondary\" className=\"text-xs\">\n                          <AlertCircle className=\"h-3 w-3 mr-1\" />\n                          Disabled\n                        </Badge>\n                      )}\n                      {stage.icon && (\n                        <span className=\"text-xs text-muted-foreground\">\n                          Icon: {stage.icon}\n                        </span>\n                      )}\n                    </div>\n                  </div>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    onClick={() => onEditStage(stage)}\n                    data-testid={`button-edit-stage-${stage.id}`}\n                  >\n                    <Pencil className=\"h-4 w-4\" />\n                  </Button>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    onClick={() => {\n                      if (confirm(\"Are you sure you want to delete this stage?\")) {\n                        onDeleteStage(stage.id, pipeline.id);\n                      }\n                    }}\n                    data-testid={`button-delete-stage-${stage.id}`}\n                  >\n                    <Trash2 className=\"h-4 w-4\" />\n                  </Button>\n                </div>\n              ))\n            )}\n            <Button\n              variant=\"outline\"\n              className=\"w-full mt-3\"\n              onClick={() => onAddStage(pipeline.id)}\n              data-testid={`button-add-stage-${pipeline.id}`}\n            >\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Add Stage\n            </Button>\n          </div>\n        </CardContent>\n      )}\n    </Card>\n  );\n}\n\nexport default function JobStageConfiguration() {\n  const { toast } = useToast();\n  const [expandedPipelines, setExpandedPipelines] = useState<Set<string>>(new Set());\n\n  const [showPipelineDialog, setShowPipelineDialog] = useState(false);\n  const [showStageDialog, setShowStageDialog] = useState(false);\n  const [editingPipeline, setEditingPipeline] = useState<JobPipeline | null>(null);\n  const [editingStage, setEditingStage] = useState<JobPipelineStage | null>(null);\n  const [stagePipelineId, setStagePipelineId] = useState<string | null>(null);\n\n  const [pipelineName, setPipelineName] = useState(\"\");\n  const [pipelineDescription, setPipelineDescription] = useState(\"\");\n  const [pipelineActive, setPipelineActive] = useState(true);\n\n  const [stageName, setStageName] = useState(\"\");\n  const [stageIcon, setStageIcon] = useState(\"\");\n  const [stageCompletionType, setStageCompletionType] = useState<\"manual\" | \"automatic\">(\"manual\");\n  const [stageActive, setStageActive] = useState(true);\n\n  const { data: pipelines = [], isLoading } = useQuery<JobPipeline[]>({\n    queryKey: [\"/api/job-pipelines\"],\n  });\n\n  const createPipelineMutation = useMutation({\n    mutationFn: async (data: { name: string; description: string; isActive: boolean }) => {\n      return apiRequest(\"POST\", \"/api/job-pipelines\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/job-pipelines\"] });\n      toast({ title: \"Pipeline created successfully\" });\n      setShowPipelineDialog(false);\n      resetPipelineForm();\n    },\n    onError: () => {\n      toast({ title: \"Failed to create pipeline\", variant: \"destructive\" });\n    },\n  });\n\n  const updatePipelineMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<JobPipeline> }) => {\n      return apiRequest(\"PATCH\", `/api/job-pipelines/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/job-pipelines\"] });\n      toast({ title: \"Pipeline updated successfully\" });\n      setShowPipelineDialog(false);\n      resetPipelineForm();\n    },\n    onError: () => {\n      toast({ title: \"Failed to update pipeline\", variant: \"destructive\" });\n    },\n  });\n\n  const deletePipelineMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/job-pipelines/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/job-pipelines\"] });\n      toast({ title: \"Pipeline deleted successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to delete pipeline\", variant: \"destructive\" });\n    },\n  });\n\n  const createStageMutation = useMutation({\n    mutationFn: async ({ pipelineId, data }: { pipelineId: string; data: { name: string; icon: string | null; completionType: string; isActive: boolean } }) => {\n      return apiRequest(\"POST\", `/api/job-pipelines/${pipelineId}/stages`, data);\n    },\n    onSuccess: (_, variables) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/job-pipelines\", variables.pipelineId, \"stages\"] });\n      toast({ title: \"Stage created successfully\" });\n      setShowStageDialog(false);\n      resetStageForm();\n    },\n    onError: () => {\n      toast({ title: \"Failed to create stage\", variant: \"destructive\" });\n    },\n  });\n\n  const updateStageMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: { name?: string; icon?: string | null; completionType?: string; isActive?: boolean } }) => {\n      return apiRequest(\"PATCH\", `/api/job-pipeline-stages/${id}`, data);\n    },\n    onSuccess: () => {\n      for (const pId of Array.from(expandedPipelines)) {\n        queryClient.invalidateQueries({ queryKey: [\"/api/job-pipelines\", pId, \"stages\"] });\n      }\n      toast({ title: \"Stage updated successfully\" });\n      setShowStageDialog(false);\n      resetStageForm();\n    },\n    onError: () => {\n      toast({ title: \"Failed to update stage\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteStageMutation = useMutation({\n    mutationFn: async ({ id }: { id: string; pipelineId: string }) => {\n      return apiRequest(\"DELETE\", `/api/job-pipeline-stages/${id}`);\n    },\n    onSuccess: (_, variables) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/job-pipelines\", variables.pipelineId, \"stages\"] });\n      toast({ title: \"Stage deleted successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to delete stage\", variant: \"destructive\" });\n    },\n  });\n\n  const resetPipelineForm = () => {\n    setPipelineName(\"\");\n    setPipelineDescription(\"\");\n    setPipelineActive(true);\n    setEditingPipeline(null);\n  };\n\n  const resetStageForm = () => {\n    setStageName(\"\");\n    setStageIcon(\"\");\n    setStageCompletionType(\"manual\");\n    setStageActive(true);\n    setEditingStage(null);\n    setStagePipelineId(null);\n  };\n\n  const openEditPipeline = (pipeline: JobPipeline) => {\n    setEditingPipeline(pipeline);\n    setPipelineName(pipeline.name);\n    setPipelineDescription(pipeline.description || \"\");\n    setPipelineActive(pipeline.isActive);\n    setShowPipelineDialog(true);\n  };\n\n  const openAddStage = (pipelineId: string) => {\n    resetStageForm();\n    setStagePipelineId(pipelineId);\n    setShowStageDialog(true);\n  };\n\n  const openEditStage = (stage: JobPipelineStage) => {\n    setEditingStage(stage);\n    setStagePipelineId(stage.pipelineId);\n    setStageName(stage.name);\n    setStageIcon(stage.icon || \"\");\n    setStageCompletionType(stage.completionType as \"manual\" | \"automatic\");\n    setStageActive(stage.isActive);\n    setShowStageDialog(true);\n  };\n\n  const handleSavePipeline = () => {\n    if (!pipelineName.trim()) {\n      toast({ title: \"Pipeline name is required\", variant: \"destructive\" });\n      return;\n    }\n\n    if (editingPipeline) {\n      updatePipelineMutation.mutate({\n        id: editingPipeline.id,\n        data: { name: pipelineName, description: pipelineDescription, isActive: pipelineActive },\n      });\n    } else {\n      createPipelineMutation.mutate({\n        name: pipelineName,\n        description: pipelineDescription,\n        isActive: pipelineActive,\n      });\n    }\n  };\n\n  const handleSaveStage = () => {\n    if (!stageName.trim()) {\n      toast({ title: \"Stage name is required\", variant: \"destructive\" });\n      return;\n    }\n\n    if (editingStage) {\n      updateStageMutation.mutate({\n        id: editingStage.id,\n        data: { name: stageName, icon: stageIcon || null, completionType: stageCompletionType, isActive: stageActive },\n      });\n    } else if (stagePipelineId) {\n      createStageMutation.mutate({\n        pipelineId: stagePipelineId,\n        data: { name: stageName, icon: stageIcon || null, completionType: stageCompletionType, isActive: stageActive },\n      });\n    }\n  };\n\n  const toggleExpanded = (pipelineId: string) => {\n    const newExpanded = new Set(expandedPipelines);\n    if (newExpanded.has(pipelineId)) {\n      newExpanded.delete(pipelineId);\n    } else {\n      newExpanded.add(pipelineId);\n    }\n    setExpandedPipelines(newExpanded);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"animate-pulse space-y-4\">\n          <div className=\"h-8 bg-muted rounded w-1/4\" />\n          <div className=\"h-32 bg-muted rounded\" />\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"page-job-stage-configuration\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-semibold flex items-center gap-2\">\n            <Settings2 className=\"h-6 w-6\" />\n            Job Stage Configuration\n          </h1>\n          <p className=\"text-muted-foreground\">\n            Create and manage job pipelines and their stages\n          </p>\n        </div>\n        <Button\n          onClick={() => {\n            resetPipelineForm();\n            setShowPipelineDialog(true);\n          }}\n          data-testid=\"button-create-pipeline\"\n        >\n          <Plus className=\"h-4 w-4 mr-2\" />\n          New Pipeline\n        </Button>\n      </div>\n\n      {pipelines.length === 0 ? (\n        <Card>\n          <CardContent className=\"py-12 text-center\">\n            <Workflow className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n            <h3 className=\"text-lg font-medium mb-2\">No Pipelines Yet</h3>\n            <p className=\"text-muted-foreground mb-4\">\n              Create your first job pipeline to define the stages jobs will go through.\n            </p>\n            <Button\n              onClick={() => {\n                resetPipelineForm();\n                setShowPipelineDialog(true);\n              }}\n              data-testid=\"button-create-first-pipeline\"\n            >\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Create Pipeline\n            </Button>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"space-y-4\">\n          {pipelines.map((pipeline) => (\n            <PipelineCard\n              key={pipeline.id}\n              pipeline={pipeline}\n              isExpanded={expandedPipelines.has(pipeline.id)}\n              onToggleExpand={() => toggleExpanded(pipeline.id)}\n              onEditPipeline={openEditPipeline}\n              onDeletePipeline={(id) => deletePipelineMutation.mutate(id)}\n              onAddStage={openAddStage}\n              onEditStage={openEditStage}\n              onDeleteStage={(id, pipelineId) => deleteStageMutation.mutate({ id, pipelineId })}\n              deletePending={deletePipelineMutation.isPending}\n            />\n          ))}\n        </div>\n      )}\n\n      <Dialog open={showPipelineDialog} onOpenChange={setShowPipelineDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>{editingPipeline ? \"Edit Pipeline\" : \"Create Pipeline\"}</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <Label htmlFor=\"pipeline-name\">Pipeline Name</Label>\n              <Input\n                id=\"pipeline-name\"\n                value={pipelineName}\n                onChange={(e) => setPipelineName(e.target.value)}\n                placeholder=\"e.g., Supply + Install\"\n                data-testid=\"input-pipeline-name\"\n              />\n            </div>\n            <div>\n              <Label htmlFor=\"pipeline-description\">Description (optional)</Label>\n              <Textarea\n                id=\"pipeline-description\"\n                value={pipelineDescription}\n                onChange={(e) => setPipelineDescription(e.target.value)}\n                placeholder=\"Describe when this pipeline should be used\"\n                data-testid=\"input-pipeline-description\"\n              />\n            </div>\n            <div className=\"flex items-center justify-between\">\n              <Label htmlFor=\"pipeline-active\">Active</Label>\n              <Switch\n                id=\"pipeline-active\"\n                checked={pipelineActive}\n                onCheckedChange={setPipelineActive}\n                data-testid=\"switch-pipeline-active\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowPipelineDialog(false)} data-testid=\"button-cancel-pipeline\">\n              Cancel\n            </Button>\n            <Button\n              onClick={handleSavePipeline}\n              disabled={createPipelineMutation.isPending || updatePipelineMutation.isPending}\n              data-testid=\"button-save-pipeline\"\n            >\n              {editingPipeline ? \"Save Changes\" : \"Create Pipeline\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showStageDialog} onOpenChange={setShowStageDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>{editingStage ? \"Edit Stage\" : \"Add Stage\"}</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <Label htmlFor=\"stage-name\">Stage Name</Label>\n              <Input\n                id=\"stage-name\"\n                value={stageName}\n                onChange={(e) => setStageName(e.target.value)}\n                placeholder=\"e.g., Posts Manufactured\"\n                data-testid=\"input-stage-name\"\n              />\n            </div>\n            <div>\n              <Label htmlFor=\"stage-icon\">Icon (optional)</Label>\n              <Input\n                id=\"stage-icon\"\n                value={stageIcon}\n                onChange={(e) => setStageIcon(e.target.value)}\n                placeholder=\"e.g., factory, check, truck\"\n                data-testid=\"input-stage-icon\"\n              />\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Enter a Lucide icon name (configured later)\n              </p>\n            </div>\n            <div>\n              <Label htmlFor=\"stage-completion\">Completion Type</Label>\n              <Select\n                value={stageCompletionType}\n                onValueChange={(v) => setStageCompletionType(v as \"manual\" | \"automatic\")}\n              >\n                <SelectTrigger data-testid=\"select-stage-completion\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"manual\">Manual - Staff marks as complete</SelectItem>\n                  <SelectItem value=\"automatic\">Automatic - System marks as complete</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"flex items-center justify-between\">\n              <Label htmlFor=\"stage-active\">Active</Label>\n              <Switch\n                id=\"stage-active\"\n                checked={stageActive}\n                onCheckedChange={setStageActive}\n                data-testid=\"switch-stage-active\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowStageDialog(false)} data-testid=\"button-cancel-stage\">\n              Cancel\n            </Button>\n            <Button\n              onClick={handleSaveStage}\n              disabled={createStageMutation.isPending || updateStageMutation.isPending}\n              data-testid=\"button-save-stage\"\n            >\n              {editingStage ? \"Save Changes\" : \"Add Stage\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":23690,"size_tokens":null},"client/src/hooks/use-debounce.ts":{"content":"import { useState, useEffect } from \"react\";\n\nexport function useDebounce<T>(value: T, delay: number): T {\n  const [debouncedValue, setDebouncedValue] = useState<T>(value);\n\n  useEffect(() => {\n    const handler = setTimeout(() => {\n      setDebouncedValue(value);\n    }, delay);\n\n    return () => {\n      clearTimeout(handler);\n    };\n  }, [value, delay]);\n\n  return debouncedValue;\n}\n","path":null,"size_bytes":386,"size_tokens":null},"client/src/components/clients/CreateClientDialog.tsx":{"content":"import { useState, useEffect, useCallback, useRef } from \"react\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { AlertCircle, X, User, Phone, Mail, Building2, Check } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Client } from \"@shared/schema\";\nimport { useDebounce } from \"@/hooks/use-debounce\";\n\ninterface CreateClientDialogProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  onClientCreated: (client: Client) => void;\n  onSelectExistingClient?: (client: Client) => void;\n}\n\nexport function CreateClientDialog({\n  open,\n  onOpenChange,\n  onClientCreated,\n  onSelectExistingClient,\n}: CreateClientDialogProps) {\n  const { toast } = useToast();\n  const [formData, setFormData] = useState({\n    name: \"\",\n    phone: \"\",\n    email: \"\",\n    address: \"\",\n    clientType: \"public\" as \"public\" | \"trade\",\n    companyName: \"\",\n    abn: \"\",\n  });\n  const [duplicates, setDuplicates] = useState<Client[]>([]);\n  const [viewingClient, setViewingClient] = useState<Client | null>(null);\n  const [isCheckingDuplicates, setIsCheckingDuplicates] = useState(false);\n  const requestCounterRef = useRef(0);\n\n  const debouncedName = useDebounce(formData.name, 500);\n  const debouncedEmail = useDebounce(formData.email, 500);\n  const debouncedPhone = useDebounce(formData.phone, 500);\n\n  const checkDuplicates = useCallback(async (name?: string, email?: string, phone?: string) => {\n    const currentRequest = ++requestCounterRef.current;\n    setIsCheckingDuplicates(true);\n    \n    try {\n      const response = await apiRequest(\"POST\", \"/api/clients/check-duplicate\", { name, email, phone });\n      const data = await response.json();\n      \n      if (currentRequest === requestCounterRef.current) {\n        setDuplicates(data.duplicates || []);\n        setIsCheckingDuplicates(false);\n      }\n    } catch (error) {\n      if (currentRequest === requestCounterRef.current) {\n        setIsCheckingDuplicates(false);\n      }\n    }\n  }, []);\n\n  const clearDuplicateSearch = useCallback(() => {\n    requestCounterRef.current++;\n    setDuplicates([]);\n    setIsCheckingDuplicates(false);\n  }, []);\n\n  useEffect(() => {\n    if (!open) {\n      requestCounterRef.current++;\n      setFormData({\n        name: \"\",\n        phone: \"\",\n        email: \"\",\n        address: \"\",\n        clientType: \"public\",\n        companyName: \"\",\n        abn: \"\",\n      });\n      setDuplicates([]);\n      setViewingClient(null);\n    }\n  }, [open]);\n\n  useEffect(() => {\n    const hasSearchableValue = \n      (debouncedName && debouncedName.length >= 2) ||\n      (debouncedEmail && debouncedEmail.length >= 3) ||\n      (debouncedPhone && debouncedPhone.replace(/\\D/g, '').length >= 6);\n\n    if (hasSearchableValue) {\n      checkDuplicates(\n        debouncedName || undefined,\n        debouncedEmail || undefined,\n        debouncedPhone || undefined\n      );\n    } else {\n      clearDuplicateSearch();\n    }\n  }, [debouncedName, debouncedEmail, debouncedPhone, checkDuplicates, clearDuplicateSearch]);\n\n  const createClientMutation = useMutation({\n    mutationFn: async (data: typeof formData) => {\n      const response = await apiRequest(\"POST\", \"/api/clients\", data);\n      return response.json();\n    },\n    onSuccess: async (client) => {\n      await queryClient.invalidateQueries({ queryKey: [\"/api/clients\"] });\n      toast({\n        title: \"Client Created\",\n        description: `${client.name} has been added successfully`,\n      });\n      onClientCreated(client);\n      onOpenChange(false);\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to create client\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!formData.name || !formData.phone) {\n      toast({\n        title: \"Error\",\n        description: \"Name and phone are required\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    createClientMutation.mutate(formData);\n  };\n\n  const handleUseExistingClient = (client: Client) => {\n    if (onSelectExistingClient) {\n      onSelectExistingClient(client);\n      onOpenChange(false);\n    }\n    setViewingClient(null);\n  };\n\n  const hasDuplicates = duplicates.length > 0;\n\n  if (viewingClient) {\n    return (\n      <Dialog open={open} onOpenChange={onOpenChange}>\n        <DialogContent className=\"sm:max-w-lg\">\n          <DialogHeader>\n            <div className=\"flex items-center justify-between\">\n              <DialogTitle>Existing Client Found</DialogTitle>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                onClick={() => setViewingClient(null)}\n                data-testid=\"button-close-client-view\"\n              >\n                <X className=\"h-4 w-4\" />\n              </Button>\n            </div>\n            <DialogDescription>\n              Is this the client you're looking for?\n            </DialogDescription>\n          </DialogHeader>\n\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <div className=\"flex items-center gap-2\">\n                <User className=\"h-5 w-5 text-muted-foreground\" />\n                <CardTitle className=\"text-lg\">{viewingClient.name}</CardTitle>\n                <Badge variant=\"secondary\">\n                  {viewingClient.clientType === \"trade\" ? \"Trade\" : \"Public\"}\n                </Badge>\n              </div>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              <div className=\"flex items-center gap-2 text-sm\">\n                <Phone className=\"h-4 w-4 text-muted-foreground\" />\n                <span>{viewingClient.phone}</span>\n              </div>\n              {viewingClient.email && (\n                <div className=\"flex items-center gap-2 text-sm\">\n                  <Mail className=\"h-4 w-4 text-muted-foreground\" />\n                  <span>{viewingClient.email}</span>\n                </div>\n              )}\n              {viewingClient.companyName && (\n                <div className=\"flex items-center gap-2 text-sm\">\n                  <Building2 className=\"h-4 w-4 text-muted-foreground\" />\n                  <span>{viewingClient.companyName}</span>\n                </div>\n              )}\n              {viewingClient.address && (\n                <div className=\"text-sm text-muted-foreground\">\n                  {viewingClient.address}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          <div className=\"flex gap-2 justify-end pt-4\">\n            <Button\n              variant=\"outline\"\n              onClick={() => setViewingClient(null)}\n              data-testid=\"button-not-this-client\"\n            >\n              Not This Client\n            </Button>\n            <Button\n              onClick={() => handleUseExistingClient(viewingClient)}\n              data-testid=\"button-use-this-client\"\n            >\n              <Check className=\"h-4 w-4 mr-2\" />\n              Use This Client\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n    );\n  }\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-md\">\n        <DialogHeader>\n          <DialogTitle>Create New Client</DialogTitle>\n          <DialogDescription>\n            Add a new client to the system\n          </DialogDescription>\n        </DialogHeader>\n\n        <form onSubmit={handleSubmit} className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"client-name\">Name *</Label>\n            <Input\n              id=\"client-name\"\n              placeholder=\"Enter client name\"\n              value={formData.name}\n              onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n              data-testid=\"input-client-name\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"client-phone\">Phone *</Label>\n            <Input\n              id=\"client-phone\"\n              placeholder=\"Enter phone number\"\n              value={formData.phone}\n              onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\n              data-testid=\"input-client-phone\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"client-email\">Email</Label>\n            <Input\n              id=\"client-email\"\n              type=\"email\"\n              placeholder=\"Enter email address\"\n              value={formData.email}\n              onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n              data-testid=\"input-client-email\"\n            />\n          </div>\n\n          {hasDuplicates && (\n            <div className=\"rounded-md border border-destructive/50 bg-destructive/10 p-3\">\n              <div className=\"flex items-center gap-2 text-destructive text-sm font-medium mb-2\">\n                <AlertCircle className=\"h-4 w-4\" />\n                <span>Similar client(s) found</span>\n              </div>\n              <ScrollArea className=\"max-h-32\">\n                <div className=\"space-y-2\">\n                  {duplicates.map((client) => (\n                    <div\n                      key={client.id}\n                      className=\"flex items-center justify-between p-2 bg-background rounded border cursor-pointer hover-elevate\"\n                      onClick={() => setViewingClient(client)}\n                      data-testid={`duplicate-client-${client.id}`}\n                    >\n                      <div className=\"text-sm\">\n                        <p className=\"font-medium\">{client.name}</p>\n                        <p className=\"text-muted-foreground text-xs\">\n                          {client.phone} {client.email && ` ${client.email}`}\n                        </p>\n                      </div>\n                      <Button\n                        type=\"button\"\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          setViewingClient(client);\n                        }}\n                        data-testid={`button-view-client-${client.id}`}\n                      >\n                        View\n                      </Button>\n                    </div>\n                  ))}\n                </div>\n              </ScrollArea>\n            </div>\n          )}\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"client-address\">Address</Label>\n            <Input\n              id=\"client-address\"\n              placeholder=\"Enter address\"\n              value={formData.address}\n              onChange={(e) => setFormData({ ...formData, address: e.target.value })}\n              data-testid=\"input-client-address\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"client-type\">Client Type</Label>\n            <Select\n              value={formData.clientType}\n              onValueChange={(value) => setFormData({ ...formData, clientType: value as \"public\" | \"trade\" })}\n            >\n              <SelectTrigger data-testid=\"select-client-type\">\n                <SelectValue placeholder=\"Select type\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"public\">Public</SelectItem>\n                <SelectItem value=\"trade\">Trade</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {formData.clientType === \"trade\" && (\n            <>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"client-company\">Company Name</Label>\n                <Input\n                  id=\"client-company\"\n                  placeholder=\"Enter company name\"\n                  value={formData.companyName}\n                  onChange={(e) => setFormData({ ...formData, companyName: e.target.value })}\n                  data-testid=\"input-client-company\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"client-abn\">ABN</Label>\n                <Input\n                  id=\"client-abn\"\n                  placeholder=\"Enter ABN\"\n                  value={formData.abn}\n                  onChange={(e) => setFormData({ ...formData, abn: e.target.value })}\n                  data-testid=\"input-client-abn\"\n                />\n              </div>\n            </>\n          )}\n\n          <div className=\"flex justify-end gap-2 pt-2\">\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={() => onOpenChange(false)}\n            >\n              Cancel\n            </Button>\n            <Button\n              type=\"submit\"\n              disabled={createClientMutation.isPending}\n              data-testid=\"button-create-client\"\n            >\n              {createClientMutation.isPending ? \"Creating...\" : \"Create Client\"}\n            </Button>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":13654,"size_tokens":null},"client/src/pages/KanbanColumnSettings.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from \"@/components/ui/dialog\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport {\n  Plus,\n  Pencil,\n  Trash2,\n  GripVertical,\n  Columns3,\n  ArrowUp,\n  ArrowDown,\n  ListTodo,\n  Link2,\n  AlertCircle,\n  Factory,\n} from \"lucide-react\";\nimport type { KanbanColumn, JobStatus, JobStatusDependency, ProductionStage } from \"@shared/schema\";\n\nconst COLOR_OPTIONS = [\n  { value: \"bg-slate-100 dark:bg-slate-800\", label: \"Gray\" },\n  { value: \"bg-blue-50 dark:bg-blue-950\", label: \"Blue\" },\n  { value: \"bg-purple-50 dark:bg-purple-950\", label: \"Purple\" },\n  { value: \"bg-amber-50 dark:bg-amber-950\", label: \"Amber\" },\n  { value: \"bg-green-50 dark:bg-green-950\", label: \"Green\" },\n  { value: \"bg-emerald-50 dark:bg-emerald-950\", label: \"Emerald\" },\n  { value: \"bg-red-50 dark:bg-red-950\", label: \"Red\" },\n  { value: \"bg-orange-50 dark:bg-orange-950\", label: \"Orange\" },\n  { value: \"bg-cyan-50 dark:bg-cyan-950\", label: \"Cyan\" },\n  { value: \"bg-pink-50 dark:bg-pink-950\", label: \"Pink\" },\n];\n\ninterface DependencyConfig {\n  prerequisiteKey: string;\n  dependencyType: string;\n}\n\nexport default function KanbanColumnSettings() {\n  const { toast } = useToast();\n  const [activeTab, setActiveTab] = useState(\"columns\");\n  \n  // Column dialog state\n  const [isColumnDialogOpen, setIsColumnDialogOpen] = useState(false);\n  const [editingColumn, setEditingColumn] = useState<KanbanColumn | null>(null);\n  const [columnFormData, setColumnFormData] = useState({\n    title: \"\",\n    statuses: [] as string[],\n    defaultStatus: \"\",\n    color: \"bg-slate-100 dark:bg-slate-800\",\n    isActive: true,\n  });\n\n  // Status dialog state\n  const [isStatusDialogOpen, setIsStatusDialogOpen] = useState(false);\n  const [editingStatus, setEditingStatus] = useState<JobStatus | null>(null);\n  const [statusFormData, setStatusFormData] = useState({\n    key: \"\",\n    label: \"\",\n    description: \"\",\n    isActive: true,\n  });\n  const [statusDependencies, setStatusDependencies] = useState<DependencyConfig[]>([]);\n\n  // Production stage dialog state\n  const [isProductionStageDialogOpen, setIsProductionStageDialogOpen] = useState(false);\n  const [editingProductionStage, setEditingProductionStage] = useState<ProductionStage | null>(null);\n  const [productionStageFormData, setProductionStageFormData] = useState({\n    key: \"\",\n    label: \"\",\n    description: \"\",\n    icon: \"Factory\",\n    color: \"bg-chart-1\",\n    isActive: true,\n  });\n\n  // Fetch columns, statuses, and all dependencies\n  const { data: columns = [], isLoading: columnsLoading } = useQuery<KanbanColumn[]>({\n    queryKey: [\"/api/kanban-columns\"],\n  });\n\n  const { data: jobStatuses = [], isLoading: statusesLoading } = useQuery<JobStatus[]>({\n    queryKey: [\"/api/job-statuses\"],\n  });\n\n  const { data: allDependencies = [] } = useQuery<JobStatusDependency[]>({\n    queryKey: [\"/api/job-status-dependencies\"],\n  });\n\n  const { data: productionStages = [], isLoading: productionStagesLoading } = useQuery<ProductionStage[]>({\n    queryKey: [\"/api/production-stages\"],\n  });\n\n  // Column mutations\n  const createColumnMutation = useMutation({\n    mutationFn: async (data: typeof columnFormData) => {\n      return apiRequest(\"POST\", \"/api/kanban-columns\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/kanban-columns\"] });\n      toast({ title: \"Column created successfully\" });\n      closeColumnDialog();\n    },\n    onError: () => {\n      toast({ title: \"Failed to create column\", variant: \"destructive\" });\n    },\n  });\n\n  const updateColumnMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: typeof columnFormData }) => {\n      return apiRequest(\"PATCH\", `/api/kanban-columns/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/kanban-columns\"] });\n      toast({ title: \"Column updated successfully\" });\n      closeColumnDialog();\n    },\n    onError: () => {\n      toast({ title: \"Failed to update column\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteColumnMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/kanban-columns/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/kanban-columns\"] });\n      toast({ title: \"Column deleted successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to delete column\", variant: \"destructive\" });\n    },\n  });\n\n  const reorderColumnMutation = useMutation({\n    mutationFn: async (columnIds: string[]) => {\n      return apiRequest(\"POST\", \"/api/kanban-columns/reorder\", { columnIds });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/kanban-columns\"] });\n    },\n    onError: () => {\n      toast({ title: \"Failed to reorder columns\", variant: \"destructive\" });\n    },\n  });\n\n  // Status mutations\n  const createStatusMutation = useMutation({\n    mutationFn: async (data: typeof statusFormData) => {\n      return apiRequest(\"POST\", \"/api/job-statuses\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/job-statuses\"] });\n      toast({ title: \"Status created successfully\" });\n      closeStatusDialog();\n    },\n    onError: () => {\n      toast({ title: \"Failed to create status\", variant: \"destructive\" });\n    },\n  });\n\n  const updateStatusMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: typeof statusFormData }) => {\n      return apiRequest(\"PATCH\", `/api/job-statuses/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/job-statuses\"] });\n      toast({ title: \"Status updated successfully\" });\n      closeStatusDialog();\n    },\n    onError: () => {\n      toast({ title: \"Failed to update status\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteStatusMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/job-statuses/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/job-statuses\"] });\n      toast({ title: \"Status deleted successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to delete status\", variant: \"destructive\" });\n    },\n  });\n\n  const reorderStatusMutation = useMutation({\n    mutationFn: async (statusIds: string[]) => {\n      return apiRequest(\"POST\", \"/api/job-statuses/reorder\", { statusIds });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/job-statuses\"] });\n    },\n    onError: () => {\n      toast({ title: \"Failed to reorder statuses\", variant: \"destructive\" });\n    },\n  });\n\n  const saveDependenciesMutation = useMutation({\n    mutationFn: async ({ statusKey, dependencies }: { statusKey: string; dependencies: DependencyConfig[] }) => {\n      return apiRequest(\"PUT\", `/api/job-status-dependencies/${statusKey}`, { dependencies });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/job-status-dependencies\"] });\n    },\n    onError: () => {\n      toast({ title: \"Failed to save dependencies\", variant: \"destructive\" });\n    },\n  });\n\n  // Production stage mutations\n  const createProductionStageMutation = useMutation({\n    mutationFn: async (data: typeof productionStageFormData) => {\n      return apiRequest(\"POST\", \"/api/production-stages\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/production-stages\"] });\n      toast({ title: \"Production stage created successfully\" });\n      closeProductionStageDialog();\n    },\n    onError: () => {\n      toast({ title: \"Failed to create production stage\", variant: \"destructive\" });\n    },\n  });\n\n  const updateProductionStageMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: typeof productionStageFormData }) => {\n      return apiRequest(\"PATCH\", `/api/production-stages/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/production-stages\"] });\n      toast({ title: \"Production stage updated successfully\" });\n      closeProductionStageDialog();\n    },\n    onError: () => {\n      toast({ title: \"Failed to update production stage\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteProductionStageMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/production-stages/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/production-stages\"] });\n      toast({ title: \"Production stage deleted successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to delete production stage\", variant: \"destructive\" });\n    },\n  });\n\n  const reorderProductionStageMutation = useMutation({\n    mutationFn: async (stageIds: string[]) => {\n      return apiRequest(\"POST\", \"/api/production-stages/reorder\", { stageIds });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/production-stages\"] });\n    },\n    onError: () => {\n      toast({ title: \"Failed to reorder production stages\", variant: \"destructive\" });\n    },\n  });\n\n  // Column dialog handlers\n  const openCreateColumnDialog = () => {\n    setEditingColumn(null);\n    setColumnFormData({\n      title: \"\",\n      statuses: [],\n      defaultStatus: \"\",\n      color: \"bg-slate-100 dark:bg-slate-800\",\n      isActive: true,\n    });\n    setIsColumnDialogOpen(true);\n  };\n\n  const openEditColumnDialog = (column: KanbanColumn) => {\n    setEditingColumn(column);\n    setColumnFormData({\n      title: column.title,\n      statuses: column.statuses || [],\n      defaultStatus: column.defaultStatus,\n      color: column.color,\n      isActive: column.isActive,\n    });\n    setIsColumnDialogOpen(true);\n  };\n\n  const closeColumnDialog = () => {\n    setIsColumnDialogOpen(false);\n    setEditingColumn(null);\n  };\n\n  const handleColumnSubmit = () => {\n    if (!columnFormData.title || columnFormData.statuses.length === 0 || !columnFormData.defaultStatus) {\n      toast({ title: \"Please fill in all required fields\", variant: \"destructive\" });\n      return;\n    }\n\n    if (editingColumn) {\n      updateColumnMutation.mutate({ id: editingColumn.id, data: columnFormData });\n    } else {\n      createColumnMutation.mutate(columnFormData);\n    }\n  };\n\n  const handleStatusToggle = (statusKey: string) => {\n    setColumnFormData((prev) => {\n      const newStatuses = prev.statuses.includes(statusKey)\n        ? prev.statuses.filter((s) => s !== statusKey)\n        : [...prev.statuses, statusKey];\n      \n      const newDefaultStatus = newStatuses.includes(prev.defaultStatus)\n        ? prev.defaultStatus\n        : newStatuses[0] || \"\";\n\n      return { ...prev, statuses: newStatuses, defaultStatus: newDefaultStatus };\n    });\n  };\n\n  const moveColumn = (index: number, direction: \"up\" | \"down\") => {\n    const newIndex = direction === \"up\" ? index - 1 : index + 1;\n    if (newIndex < 0 || newIndex >= columns.length) return;\n\n    const newColumns = [...columns];\n    const temp = newColumns[index];\n    newColumns[index] = newColumns[newIndex];\n    newColumns[newIndex] = temp;\n\n    reorderColumnMutation.mutate(newColumns.map((c) => c.id));\n  };\n\n  // Status dialog handlers\n  const openCreateStatusDialog = () => {\n    setEditingStatus(null);\n    setStatusFormData({\n      key: \"\",\n      label: \"\",\n      description: \"\",\n      isActive: true,\n    });\n    setStatusDependencies([]);\n    setIsStatusDialogOpen(true);\n  };\n\n  const openEditStatusDialog = (status: JobStatus) => {\n    setEditingStatus(status);\n    setStatusFormData({\n      key: status.key,\n      label: status.label,\n      description: status.description || \"\",\n      isActive: status.isActive,\n    });\n    const deps = allDependencies\n      .filter(d => d.statusKey === status.key)\n      .map(d => ({ prerequisiteKey: d.prerequisiteKey, dependencyType: d.dependencyType }));\n    setStatusDependencies(deps);\n    setIsStatusDialogOpen(true);\n  };\n\n  const closeStatusDialog = () => {\n    setIsStatusDialogOpen(false);\n    setEditingStatus(null);\n    setStatusDependencies([]);\n  };\n\n  const handleStatusSubmit = async () => {\n    if (!statusFormData.key || !statusFormData.label) {\n      toast({ title: \"Please fill in key and label\", variant: \"destructive\" });\n      return;\n    }\n\n    if (editingStatus) {\n      await updateStatusMutation.mutateAsync({ id: editingStatus.id, data: statusFormData });\n      await saveDependenciesMutation.mutateAsync({ \n        statusKey: statusFormData.key, \n        dependencies: statusDependencies \n      });\n    } else {\n      await createStatusMutation.mutateAsync(statusFormData);\n      if (statusDependencies.length > 0) {\n        await saveDependenciesMutation.mutateAsync({ \n          statusKey: statusFormData.key, \n          dependencies: statusDependencies \n        });\n      }\n    }\n  };\n\n  const moveStatus = (index: number, direction: \"up\" | \"down\") => {\n    const newIndex = direction === \"up\" ? index - 1 : index + 1;\n    if (newIndex < 0 || newIndex >= jobStatuses.length) return;\n\n    const newStatuses = [...jobStatuses];\n    const temp = newStatuses[index];\n    newStatuses[index] = newStatuses[newIndex];\n    newStatuses[newIndex] = temp;\n\n    reorderStatusMutation.mutate(newStatuses.map((s) => s.id));\n  };\n\n  const addDependency = () => {\n    const availableStatuses = jobStatuses.filter(\n      s => s.key !== statusFormData.key && !statusDependencies.some(d => d.prerequisiteKey === s.key)\n    );\n    if (availableStatuses.length > 0) {\n      setStatusDependencies([...statusDependencies, { \n        prerequisiteKey: availableStatuses[0].key, \n        dependencyType: \"mandatory\" \n      }]);\n    }\n  };\n\n  const removeDependency = (index: number) => {\n    setStatusDependencies(statusDependencies.filter((_, i) => i !== index));\n  };\n\n  const updateDependency = (index: number, field: keyof DependencyConfig, value: string) => {\n    const updated = [...statusDependencies];\n    updated[index] = { ...updated[index], [field]: value };\n    setStatusDependencies(updated);\n  };\n\n  const getStatusDependencyCount = (statusKey: string) => {\n    return allDependencies.filter(d => d.statusKey === statusKey).length;\n  };\n\n  // Production stage dialog handlers\n  const openCreateProductionStageDialog = () => {\n    setEditingProductionStage(null);\n    setProductionStageFormData({\n      key: \"\",\n      label: \"\",\n      description: \"\",\n      icon: \"Factory\",\n      color: \"bg-chart-1\",\n      isActive: true,\n    });\n    setIsProductionStageDialogOpen(true);\n  };\n\n  const openEditProductionStageDialog = (stage: ProductionStage) => {\n    setEditingProductionStage(stage);\n    setProductionStageFormData({\n      key: stage.key,\n      label: stage.label,\n      description: stage.description || \"\",\n      icon: stage.icon || \"Factory\",\n      color: stage.color || \"bg-chart-1\",\n      isActive: stage.isActive,\n    });\n    setIsProductionStageDialogOpen(true);\n  };\n\n  const closeProductionStageDialog = () => {\n    setIsProductionStageDialogOpen(false);\n    setEditingProductionStage(null);\n  };\n\n  const handleProductionStageSubmit = () => {\n    if (!productionStageFormData.key || !productionStageFormData.label) {\n      toast({ title: \"Please fill in key and label\", variant: \"destructive\" });\n      return;\n    }\n\n    if (editingProductionStage) {\n      updateProductionStageMutation.mutate({ id: editingProductionStage.id, data: productionStageFormData });\n    } else {\n      createProductionStageMutation.mutate(productionStageFormData);\n    }\n  };\n\n  const moveProductionStage = (index: number, direction: \"up\" | \"down\") => {\n    const newIndex = direction === \"up\" ? index - 1 : index + 1;\n    if (newIndex < 0 || newIndex >= productionStages.length) return;\n\n    const newStages = [...productionStages];\n    const temp = newStages[index];\n    newStages[index] = newStages[newIndex];\n    newStages[newIndex] = temp;\n\n    reorderProductionStageMutation.mutate(newStages.map((s) => s.id));\n  };\n\n  const isLoading = columnsLoading || statusesLoading || productionStagesLoading;\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"animate-pulse space-y-4\">\n          <div className=\"h-8 bg-muted rounded w-64\" />\n          <div className=\"h-32 bg-muted rounded\" />\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"page-kanban-column-settings\">\n      <div>\n        <h1 className=\"text-2xl font-bold flex items-center gap-2\">\n          <Columns3 className=\"h-6 w-6\" />\n          Kanban Settings\n        </h1>\n        <p className=\"text-muted-foreground\">\n          Configure kanban columns and job statuses\n        </p>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList>\n          <TabsTrigger value=\"columns\" className=\"flex items-center gap-2\">\n            <Columns3 className=\"h-4 w-4\" />\n            Columns\n          </TabsTrigger>\n          <TabsTrigger value=\"statuses\" className=\"flex items-center gap-2\">\n            <ListTodo className=\"h-4 w-4\" />\n            Job Statuses\n          </TabsTrigger>\n          <TabsTrigger value=\"production\" className=\"flex items-center gap-2\">\n            <Factory className=\"h-4 w-4\" />\n            Production Stages\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"columns\" className=\"space-y-4\">\n          <div className=\"flex justify-end\">\n            <Button onClick={openCreateColumnDialog} data-testid=\"button-add-column\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Add Column\n            </Button>\n          </div>\n\n          <div className=\"space-y-3\">\n            {columns.map((column, index) => (\n              <Card key={column.id} data-testid={`card-column-${column.id}`}>\n                <CardContent className=\"p-4\">\n                  <div className=\"flex items-center gap-4\">\n                    <div className=\"flex flex-col gap-1\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        className=\"h-6 w-6\"\n                        disabled={index === 0}\n                        onClick={() => moveColumn(index, \"up\")}\n                        data-testid={`button-move-up-${column.id}`}\n                      >\n                        <ArrowUp className=\"h-4 w-4\" />\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        className=\"h-6 w-6\"\n                        disabled={index === columns.length - 1}\n                        onClick={() => moveColumn(index, \"down\")}\n                        data-testid={`button-move-down-${column.id}`}\n                      >\n                        <ArrowDown className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                    <GripVertical className=\"h-5 w-5 text-muted-foreground\" />\n                    <div\n                      className={`w-4 h-12 rounded ${column.color}`}\n                      title=\"Column color\"\n                    />\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2\">\n                        <h3 className=\"font-medium\">{column.title}</h3>\n                        {!column.isActive && (\n                          <Badge variant=\"secondary\" className=\"text-xs\">\n                            Inactive\n                          </Badge>\n                        )}\n                      </div>\n                      <p className=\"text-sm text-muted-foreground\">\n                        {(column.statuses || []).length} status(es)  Default: {column.defaultStatus}\n                      </p>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={() => openEditColumnDialog(column)}\n                        data-testid={`button-edit-column-${column.id}`}\n                      >\n                        <Pencil className=\"h-4 w-4\" />\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={() => {\n                          if (confirm(\"Are you sure you want to delete this column?\")) {\n                            deleteColumnMutation.mutate(column.id);\n                          }\n                        }}\n                        data-testid={`button-delete-column-${column.id}`}\n                      >\n                        <Trash2 className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n\n            {columns.length === 0 && (\n              <Card>\n                <CardContent className=\"p-8 text-center text-muted-foreground\">\n                  <Columns3 className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>No kanban columns configured yet.</p>\n                  <p className=\"text-sm\">Click \"Add Column\" to create your first column.</p>\n                </CardContent>\n              </Card>\n            )}\n          </div>\n        </TabsContent>\n\n        <TabsContent value=\"statuses\" className=\"space-y-4\">\n          <div className=\"flex justify-end\">\n            <Button onClick={openCreateStatusDialog} data-testid=\"button-add-status\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Add Status\n            </Button>\n          </div>\n\n          <div className=\"space-y-3\">\n            {jobStatuses.map((status, index) => {\n              const depCount = getStatusDependencyCount(status.key);\n              return (\n                <Card key={status.id} data-testid={`card-status-${status.id}`}>\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-center gap-4\">\n                      <div className=\"flex flex-col gap-1\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          className=\"h-6 w-6\"\n                          disabled={index === 0}\n                          onClick={() => moveStatus(index, \"up\")}\n                          data-testid={`button-move-up-status-${status.id}`}\n                        >\n                          <ArrowUp className=\"h-4 w-4\" />\n                        </Button>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          className=\"h-6 w-6\"\n                          disabled={index === jobStatuses.length - 1}\n                          onClick={() => moveStatus(index, \"down\")}\n                          data-testid={`button-move-down-status-${status.id}`}\n                        >\n                          <ArrowDown className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                      <GripVertical className=\"h-5 w-5 text-muted-foreground\" />\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center gap-2 flex-wrap\">\n                          <h3 className=\"font-medium\">{status.label}</h3>\n                          <Badge variant=\"outline\" className=\"text-xs font-mono\">\n                            {status.key}\n                          </Badge>\n                          {!status.isActive && (\n                            <Badge variant=\"secondary\" className=\"text-xs\">\n                              Inactive\n                            </Badge>\n                          )}\n                          {depCount > 0 && (\n                            <Badge variant=\"outline\" className=\"text-xs flex items-center gap-1\">\n                              <Link2 className=\"h-3 w-3\" />\n                              {depCount} prerequisite{depCount > 1 ? 's' : ''}\n                            </Badge>\n                          )}\n                        </div>\n                        {status.description && (\n                          <p className=\"text-sm text-muted-foreground\">{status.description}</p>\n                        )}\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={() => openEditStatusDialog(status)}\n                          data-testid={`button-edit-status-${status.id}`}\n                        >\n                          <Pencil className=\"h-4 w-4\" />\n                        </Button>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={() => {\n                            if (confirm(\"Are you sure you want to delete this status? This may affect existing jobs.\")) {\n                              deleteStatusMutation.mutate(status.id);\n                            }\n                          }}\n                          data-testid={`button-delete-status-${status.id}`}\n                        >\n                          <Trash2 className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              );\n            })}\n\n            {jobStatuses.length === 0 && (\n              <Card>\n                <CardContent className=\"p-8 text-center text-muted-foreground\">\n                  <ListTodo className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>No job statuses configured yet.</p>\n                  <p className=\"text-sm\">Click \"Add Status\" to create your first status.</p>\n                </CardContent>\n              </Card>\n            )}\n          </div>\n        </TabsContent>\n\n        <TabsContent value=\"production\" className=\"space-y-4\">\n          <div className=\"flex justify-end\">\n            <Button onClick={openCreateProductionStageDialog} data-testid=\"button-add-production-stage\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Add Stage\n            </Button>\n          </div>\n\n          <div className=\"text-sm text-muted-foreground mb-4\">\n            Configure the manufacturing stages displayed in production widgets and the Production Manager page.\n            These stages track the progress of production tasks (e.g., Manufacturing Posts, Panels, Gates, QA Check).\n          </div>\n\n          <div className=\"space-y-2\">\n            {productionStages.map((stage, index) => (\n              <Card key={stage.id} data-testid={`card-production-stage-${stage.id}`}>\n                <CardContent className=\"p-4\">\n                  <div className=\"flex items-center gap-4\">\n                    <div className=\"cursor-move text-muted-foreground\">\n                      <GripVertical className=\"h-4 w-4\" />\n                    </div>\n                    <div className=\"flex flex-col gap-1\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        className=\"h-6 w-6\"\n                        onClick={() => moveProductionStage(index, \"up\")}\n                        disabled={index === 0}\n                        data-testid={`button-move-stage-up-${stage.id}`}\n                      >\n                        <ArrowUp className=\"h-3 w-3\" />\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        className=\"h-6 w-6\"\n                        onClick={() => moveProductionStage(index, \"down\")}\n                        disabled={index === productionStages.length - 1}\n                        data-testid={`button-move-stage-down-${stage.id}`}\n                      >\n                        <ArrowDown className=\"h-3 w-3\" />\n                      </Button>\n                    </div>\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center gap-2 flex-wrap\">\n                        <span className=\"font-medium\">{stage.label}</span>\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          {stage.key}\n                        </Badge>\n                        {!stage.isActive && (\n                          <Badge variant=\"secondary\" className=\"text-xs\">\n                            Inactive\n                          </Badge>\n                        )}\n                        {stage.icon && (\n                          <Badge variant=\"outline\" className=\"text-xs\">\n                            Icon: {stage.icon}\n                          </Badge>\n                        )}\n                      </div>\n                      {stage.description && (\n                        <p className=\"text-sm text-muted-foreground\">{stage.description}</p>\n                      )}\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={() => openEditProductionStageDialog(stage)}\n                        data-testid={`button-edit-production-stage-${stage.id}`}\n                      >\n                        <Pencil className=\"h-4 w-4\" />\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={() => {\n                          if (confirm(\"Are you sure you want to delete this production stage?\")) {\n                            deleteProductionStageMutation.mutate(stage.id);\n                          }\n                        }}\n                        data-testid={`button-delete-production-stage-${stage.id}`}\n                      >\n                        <Trash2 className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n\n            {productionStages.length === 0 && (\n              <Card>\n                <CardContent className=\"p-8 text-center text-muted-foreground\">\n                  <Factory className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>No production stages configured yet.</p>\n                  <p className=\"text-sm\">Click \"Add Stage\" to create your first production stage.</p>\n                </CardContent>\n              </Card>\n            )}\n          </div>\n        </TabsContent>\n      </Tabs>\n\n      {/* Column Dialog */}\n      <Dialog open={isColumnDialogOpen} onOpenChange={setIsColumnDialogOpen}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>\n              {editingColumn ? \"Edit Column\" : \"Add New Column\"}\n            </DialogTitle>\n            <DialogDescription>\n              Configure the kanban column settings\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"title\">Column Title</Label>\n              <Input\n                id=\"title\"\n                value={columnFormData.title}\n                onChange={(e) => setColumnFormData({ ...columnFormData, title: e.target.value })}\n                placeholder=\"e.g., New Jobs, Pipeline, Production\"\n                data-testid=\"input-column-title\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Column Color</Label>\n              <div className=\"flex flex-wrap gap-2\">\n                {COLOR_OPTIONS.map((color) => (\n                  <button\n                    key={color.value}\n                    type=\"button\"\n                    className={`w-8 h-8 rounded border-2 ${color.value} ${\n                      columnFormData.color === color.value\n                        ? \"border-primary ring-2 ring-primary ring-offset-2\"\n                        : \"border-transparent\"\n                    }`}\n                    onClick={() => setColumnFormData({ ...columnFormData, color: color.value })}\n                    title={color.label}\n                    data-testid={`button-color-${color.label.toLowerCase()}`}\n                  />\n                ))}\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Job Statuses in this Column</Label>\n              <p className=\"text-xs text-muted-foreground\">\n                Select which job statuses should appear in this column\n              </p>\n              <div className=\"grid grid-cols-2 gap-2 max-h-48 overflow-y-auto border rounded p-2\">\n                {jobStatuses.map((status) => (\n                  <label\n                    key={status.key}\n                    className=\"flex items-center gap-2 cursor-pointer\"\n                  >\n                    <input\n                      type=\"checkbox\"\n                      checked={columnFormData.statuses.includes(status.key)}\n                      onChange={() => handleStatusToggle(status.key)}\n                      className=\"rounded\"\n                      data-testid={`checkbox-status-${status.key}`}\n                    />\n                    <span className=\"text-sm\">{status.label}</span>\n                  </label>\n                ))}\n              </div>\n            </div>\n\n            {columnFormData.statuses.length > 0 && (\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"defaultStatus\">Default Status (for new jobs dropped here)</Label>\n                <select\n                  id=\"defaultStatus\"\n                  value={columnFormData.defaultStatus}\n                  onChange={(e) => setColumnFormData({ ...columnFormData, defaultStatus: e.target.value })}\n                  className=\"w-full border rounded px-3 py-2\"\n                  data-testid=\"select-default-status\"\n                >\n                  {columnFormData.statuses.map((statusKey) => (\n                    <option key={statusKey} value={statusKey}>\n                      {jobStatuses.find((s) => s.key === statusKey)?.label || statusKey}\n                    </option>\n                  ))}\n                </select>\n              </div>\n            )}\n\n            <div className=\"flex items-center gap-2\">\n              <Switch\n                id=\"isActive\"\n                checked={columnFormData.isActive}\n                onCheckedChange={(checked) => setColumnFormData({ ...columnFormData, isActive: checked })}\n                data-testid=\"switch-is-active\"\n              />\n              <Label htmlFor=\"isActive\">Active</Label>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={closeColumnDialog}>\n              Cancel\n            </Button>\n            <Button\n              onClick={handleColumnSubmit}\n              disabled={createColumnMutation.isPending || updateColumnMutation.isPending}\n              data-testid=\"button-save-column\"\n            >\n              {editingColumn ? \"Update\" : \"Create\"} Column\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Status Dialog */}\n      <Dialog open={isStatusDialogOpen} onOpenChange={setIsStatusDialogOpen}>\n        <DialogContent className=\"max-w-lg max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>\n              {editingStatus ? \"Edit Status\" : \"Add New Status\"}\n            </DialogTitle>\n            <DialogDescription>\n              Configure the job status settings and prerequisites\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"statusKey\">Status Key</Label>\n              <Input\n                id=\"statusKey\"\n                value={statusFormData.key}\n                onChange={(e) => setStatusFormData({ ...statusFormData, key: e.target.value.toLowerCase().replace(/\\s+/g, '_') })}\n                placeholder=\"e.g., awaiting_approval\"\n                disabled={!!editingStatus}\n                data-testid=\"input-status-key\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Unique identifier (lowercase, underscores). Cannot be changed after creation.\n              </p>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"statusLabel\">Display Label</Label>\n              <Input\n                id=\"statusLabel\"\n                value={statusFormData.label}\n                onChange={(e) => setStatusFormData({ ...statusFormData, label: e.target.value })}\n                placeholder=\"e.g., Awaiting Approval\"\n                data-testid=\"input-status-label\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"statusDescription\">Description (optional)</Label>\n              <Input\n                id=\"statusDescription\"\n                value={statusFormData.description}\n                onChange={(e) => setStatusFormData({ ...statusFormData, description: e.target.value })}\n                placeholder=\"Brief description of this status\"\n                data-testid=\"input-status-description\"\n              />\n            </div>\n\n            <div className=\"flex items-center gap-2\">\n              <Switch\n                id=\"statusIsActive\"\n                checked={statusFormData.isActive}\n                onCheckedChange={(checked) => setStatusFormData({ ...statusFormData, isActive: checked })}\n                data-testid=\"switch-status-is-active\"\n              />\n              <Label htmlFor=\"statusIsActive\">Active</Label>\n            </div>\n\n            {/* Dependencies Section */}\n            <div className=\"space-y-3 pt-4 border-t\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <Label className=\"flex items-center gap-2\">\n                    <Link2 className=\"h-4 w-4\" />\n                    Prerequisites\n                  </Label>\n                  <p className=\"text-xs text-muted-foreground\">\n                    Which statuses must be completed before this one?\n                  </p>\n                </div>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={addDependency}\n                  disabled={\n                    jobStatuses.filter(\n                      s => s.key !== statusFormData.key && !statusDependencies.some(d => d.prerequisiteKey === s.key)\n                    ).length === 0\n                  }\n                  data-testid=\"button-add-dependency\"\n                >\n                  <Plus className=\"h-4 w-4 mr-1\" />\n                  Add\n                </Button>\n              </div>\n\n              {statusDependencies.length === 0 ? (\n                <p className=\"text-sm text-muted-foreground italic py-2\">\n                  No prerequisites. This status can be reached at any time.\n                </p>\n              ) : (\n                <div className=\"space-y-2\">\n                  {statusDependencies.map((dep, index) => (\n                    <div key={index} className=\"flex items-center gap-2 p-2 border rounded bg-muted/30\">\n                      <Select\n                        value={dep.prerequisiteKey}\n                        onValueChange={(value) => updateDependency(index, 'prerequisiteKey', value)}\n                      >\n                        <SelectTrigger className=\"flex-1\" data-testid={`select-prerequisite-${index}`}>\n                          <SelectValue placeholder=\"Select status\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {jobStatuses\n                            .filter(s => s.key !== statusFormData.key)\n                            .map((s) => (\n                              <SelectItem \n                                key={s.key} \n                                value={s.key}\n                                disabled={statusDependencies.some((d, i) => i !== index && d.prerequisiteKey === s.key)}\n                              >\n                                {s.label}\n                              </SelectItem>\n                            ))}\n                        </SelectContent>\n                      </Select>\n                      <Select\n                        value={dep.dependencyType}\n                        onValueChange={(value) => updateDependency(index, 'dependencyType', value)}\n                      >\n                        <SelectTrigger className=\"w-32\" data-testid={`select-dep-type-${index}`}>\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"mandatory\">\n                            <span className=\"flex items-center gap-1\">\n                              <AlertCircle className=\"h-3 w-3 text-destructive\" />\n                              Required\n                            </span>\n                          </SelectItem>\n                          <SelectItem value=\"advisory\">Advisory</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <Button\n                        type=\"button\"\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={() => removeDependency(index)}\n                        data-testid={`button-remove-dependency-${index}`}\n                      >\n                        <Trash2 className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  ))}\n                </div>\n              )}\n\n              <div className=\"text-xs text-muted-foreground bg-muted/50 p-2 rounded\">\n                <strong>Required:</strong> Job cannot enter this status until prerequisite is done.<br />\n                <strong>Advisory:</strong> Shows a warning but allows override.\n              </div>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={closeStatusDialog}>\n              Cancel\n            </Button>\n            <Button\n              onClick={handleStatusSubmit}\n              disabled={createStatusMutation.isPending || updateStatusMutation.isPending || saveDependenciesMutation.isPending}\n              data-testid=\"button-save-status\"\n            >\n              {editingStatus ? \"Update\" : \"Create\"} Status\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Production Stage Dialog */}\n      <Dialog open={isProductionStageDialogOpen} onOpenChange={setIsProductionStageDialogOpen}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>\n              {editingProductionStage ? \"Edit Production Stage\" : \"Add New Production Stage\"}\n            </DialogTitle>\n            <DialogDescription>\n              Configure the production stage settings\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"stageKey\">Stage Key</Label>\n              <Input\n                id=\"stageKey\"\n                value={productionStageFormData.key}\n                onChange={(e) => setProductionStageFormData({ ...productionStageFormData, key: e.target.value.toLowerCase().replace(/\\s+/g, '_') })}\n                placeholder=\"e.g., manufacturing_posts\"\n                disabled={!!editingProductionStage}\n                data-testid=\"input-production-stage-key\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Unique identifier (lowercase, underscores). Cannot be changed after creation.\n              </p>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"stageLabel\">Display Label</Label>\n              <Input\n                id=\"stageLabel\"\n                value={productionStageFormData.label}\n                onChange={(e) => setProductionStageFormData({ ...productionStageFormData, label: e.target.value })}\n                placeholder=\"e.g., Manufacturing Posts\"\n                data-testid=\"input-production-stage-label\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"stageDescription\">Description (optional)</Label>\n              <Input\n                id=\"stageDescription\"\n                value={productionStageFormData.description}\n                onChange={(e) => setProductionStageFormData({ ...productionStageFormData, description: e.target.value })}\n                placeholder=\"Brief description of this stage\"\n                data-testid=\"input-production-stage-description\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"stageIcon\">Icon Name (Lucide)</Label>\n              <Input\n                id=\"stageIcon\"\n                value={productionStageFormData.icon}\n                onChange={(e) => setProductionStageFormData({ ...productionStageFormData, icon: e.target.value })}\n                placeholder=\"e.g., Factory, Columns, DoorOpen, CheckCircle\"\n                data-testid=\"input-production-stage-icon\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Enter a Lucide icon name (e.g., Factory, Columns, DoorOpen, CheckCircle)\n              </p>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Stage Color</Label>\n              <Select\n                value={productionStageFormData.color}\n                onValueChange={(value) => setProductionStageFormData({ ...productionStageFormData, color: value })}\n              >\n                <SelectTrigger data-testid=\"select-production-stage-color\">\n                  <SelectValue placeholder=\"Select color\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"bg-chart-1\">Chart 1 (Blue)</SelectItem>\n                  <SelectItem value=\"bg-chart-2\">Chart 2 (Green)</SelectItem>\n                  <SelectItem value=\"bg-chart-3\">Chart 3 (Orange)</SelectItem>\n                  <SelectItem value=\"bg-chart-4\">Chart 4 (Purple)</SelectItem>\n                  <SelectItem value=\"bg-chart-5\">Chart 5 (Pink)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"flex items-center gap-2\">\n              <Switch\n                id=\"stageIsActive\"\n                checked={productionStageFormData.isActive}\n                onCheckedChange={(checked) => setProductionStageFormData({ ...productionStageFormData, isActive: checked })}\n                data-testid=\"switch-production-stage-is-active\"\n              />\n              <Label htmlFor=\"stageIsActive\">Active</Label>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={closeProductionStageDialog}>\n              Cancel\n            </Button>\n            <Button\n              onClick={handleProductionStageSubmit}\n              disabled={createProductionStageMutation.isPending || updateProductionStageMutation.isPending}\n              data-testid=\"button-save-production-stage\"\n            >\n              {editingProductionStage ? \"Update\" : \"Create\"} Stage\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":48484,"size_tokens":null},"server/automation.ts":{"content":"import { storage } from './storage';\nimport { sendSMS } from './twilio';\nimport type { AutomationCampaign, Client, Lead, Quote, Job, Payment } from '@shared/schema';\n\ninterface ProcessingContext {\n  client: Client;\n  lead?: Lead;\n  quote?: Quote;\n  job?: Job;\n  payment?: Payment;\n}\n\nfunction replacePlaceholders(template: string, context: ProcessingContext): string {\n  let message = template;\n  \n  if (context.client) {\n    message = message.replace(/{client_name}/g, context.client.name || 'Valued Customer');\n    message = message.replace(/{client_phone}/g, context.client.phone || '');\n    message = message.replace(/{client_email}/g, context.client.email || '');\n  }\n  \n  if (context.lead) {\n    message = message.replace(/{lead_number}/g, context.lead.leadNumber || '');\n    message = message.replace(/{site_address}/g, context.lead.siteAddress || '');\n  }\n  \n  if (context.quote) {\n    message = message.replace(/{quote_number}/g, context.quote.quoteNumber || '');\n    message = message.replace(/{quote_amount}/g, context.quote.totalAmount ? `$${parseFloat(context.quote.totalAmount).toLocaleString()}` : '');\n  }\n  \n  if (context.job) {\n    message = message.replace(/{job_number}/g, context.job.jobNumber || '');\n    message = message.replace(/{job_address}/g, context.job.siteAddress || '');\n  }\n  \n  if (context.payment) {\n    message = message.replace(/{payment_amount}/g, context.payment.amount ? `$${parseFloat(context.payment.amount).toLocaleString()}` : '');\n    message = message.replace(/{invoice_number}/g, context.payment.invoiceNumber || '');\n  }\n  \n  return message;\n}\n\nfunction isWithinSendWindow(sendWindow: string | null): boolean {\n  if (!sendWindow) return true;\n  \n  const [startTime, endTime] = sendWindow.split('-');\n  if (!startTime || !endTime) return true;\n  \n  const now = new Date();\n  const perthTime = new Date(now.toLocaleString(\"en-US\", { timeZone: \"Australia/Perth\" }));\n  const currentHour = perthTime.getHours();\n  const currentMinute = perthTime.getMinutes();\n  const currentTimeMinutes = currentHour * 60 + currentMinute;\n  \n  const [startHour, startMin] = startTime.split(':').map(Number);\n  const [endHour, endMin] = endTime.split(':').map(Number);\n  const startMinutes = startHour * 60 + startMin;\n  const endMinutes = endHour * 60 + endMin;\n  \n  return currentTimeMinutes >= startMinutes && currentTimeMinutes <= endMinutes;\n}\n\nasync function processPaymentDueCampaigns(campaign: AutomationCampaign): Promise<number> {\n  let messagesSent = 0;\n  \n  try {\n    const payments = await storage.getPayments();\n    const pendingPayments = payments.filter(p => p.status === 'pending');\n    \n    for (const payment of pendingPayments) {\n      const createdAt = new Date(payment.createdAt);\n      const delayMs = (campaign.delayDays * 24 * 60 * 60 * 1000) + (campaign.delayHours * 60 * 60 * 1000);\n      const triggerTime = new Date(createdAt.getTime() + delayMs);\n      \n      if (new Date() < triggerTime) {\n        continue;\n      }\n      \n      const existingLogs = await storage.getSMSLogsByEntity('payment', payment.id);\n      const alreadySent = existingLogs.some(log => log.isOutbound);\n      \n      if (alreadySent) {\n        continue;\n      }\n      \n      const client = payment.clientId ? await storage.getClient(payment.clientId) : null;\n      if (!client || !client.phone) {\n        console.log(`Skipping payment ${payment.id} - no client phone number`);\n        continue;\n      }\n      \n      if (campaign.clientType && client.clientType !== campaign.clientType) {\n        continue;\n      }\n      \n      let quote: Quote | undefined;\n      let job: Job | undefined;\n      let lead: Lead | undefined;\n      \n      if (payment.quoteId) {\n        quote = await storage.getQuote(payment.quoteId) || undefined;\n      }\n      if (payment.jobId) {\n        job = await storage.getJob(payment.jobId) || undefined;\n        if (job?.leadId) {\n          lead = await storage.getLead(job.leadId) || undefined;\n        }\n      }\n      \n      const message = replacePlaceholders(campaign.messageTemplate, {\n        client,\n        lead,\n        quote,\n        job,\n        payment,\n      });\n      \n      try {\n        const result = await sendSMS(client.phone, message);\n        \n        await storage.createSMSLog({\n          recipientPhone: client.phone,\n          recipientName: client.name,\n          message,\n          isOutbound: true,\n          status: 'sent',\n          twilioMessageSid: result?.sid || null,\n          relatedEntityType: 'payment',\n          relatedEntityId: payment.id,\n          sentAt: new Date(),\n        });\n        \n        console.log(`Automation: Sent payment_due message to ${client.name} (${client.phone})`);\n        messagesSent++;\n      } catch (error) {\n        console.error(`Automation: Failed to send SMS to ${client.phone}:`, error);\n        \n        await storage.createSMSLog({\n          recipientPhone: client.phone,\n          recipientName: client.name,\n          message,\n          isOutbound: true,\n          status: 'failed',\n          twilioMessageSid: null,\n          relatedEntityType: 'payment',\n          relatedEntityId: payment.id,\n          errorMessage: error instanceof Error ? error.message : 'Unknown error',\n        });\n      }\n    }\n  } catch (error) {\n    console.error('Error processing payment_due campaigns:', error);\n  }\n  \n  return messagesSent;\n}\n\nasync function processQuoteSentCampaigns(campaign: AutomationCampaign): Promise<number> {\n  let messagesSent = 0;\n  \n  try {\n    const quotes = await storage.getQuotes();\n    const sentQuotes = quotes.filter(q => q.status === 'sent');\n    \n    for (const quote of sentQuotes) {\n      const sentAt = quote.sentAt ? new Date(quote.sentAt) : new Date(quote.createdAt);\n      const delayMs = (campaign.delayDays * 24 * 60 * 60 * 1000) + (campaign.delayHours * 60 * 60 * 1000);\n      const triggerTime = new Date(sentAt.getTime() + delayMs);\n      \n      if (new Date() < triggerTime) {\n        continue;\n      }\n      \n      const existingLogs = await storage.getSMSLogsByEntity('quote', quote.id);\n      const alreadySent = existingLogs.some(log => log.isOutbound);\n      \n      if (alreadySent) {\n        continue;\n      }\n      \n      const client = quote.clientId ? await storage.getClient(quote.clientId) : null;\n      if (!client || !client.phone) {\n        continue;\n      }\n      \n      if (campaign.clientType && client.clientType !== campaign.clientType) {\n        continue;\n      }\n      \n      let lead: Lead | undefined;\n      if (quote.leadId) {\n        lead = await storage.getLead(quote.leadId) || undefined;\n      }\n      \n      const message = replacePlaceholders(campaign.messageTemplate, {\n        client,\n        lead,\n        quote,\n      });\n      \n      try {\n        const result = await sendSMS(client.phone, message);\n        \n        await storage.createSMSLog({\n          recipientPhone: client.phone,\n          recipientName: client.name,\n          message,\n          isOutbound: true,\n          status: 'sent',\n          twilioMessageSid: result?.sid || null,\n          relatedEntityType: 'quote',\n          relatedEntityId: quote.id,\n          sentAt: new Date(),\n        });\n        \n        console.log(`Automation: Sent quote_sent message to ${client.name} (${client.phone})`);\n        messagesSent++;\n      } catch (error) {\n        console.error(`Automation: Failed to send SMS to ${client.phone}:`, error);\n      }\n    }\n  } catch (error) {\n    console.error('Error processing quote_sent campaigns:', error);\n  }\n  \n  return messagesSent;\n}\n\nasync function processNewLeadCampaigns(campaign: AutomationCampaign): Promise<number> {\n  let messagesSent = 0;\n  \n  try {\n    const leads = await storage.getLeads();\n    const newLeads = leads.filter(l => l.stage === 'new');\n    \n    for (const lead of newLeads) {\n      const createdAt = new Date(lead.createdAt);\n      const delayMs = (campaign.delayDays * 24 * 60 * 60 * 1000) + (campaign.delayHours * 60 * 60 * 1000);\n      const triggerTime = new Date(createdAt.getTime() + delayMs);\n      \n      if (new Date() < triggerTime) {\n        continue;\n      }\n      \n      const existingLogs = await storage.getSMSLogsByEntity('lead', lead.id);\n      const alreadySent = existingLogs.some(log => log.isOutbound);\n      \n      if (alreadySent) {\n        continue;\n      }\n      \n      const client = lead.clientId ? await storage.getClient(lead.clientId) : null;\n      if (!client || !client.phone) {\n        continue;\n      }\n      \n      if (campaign.clientType && client.clientType !== campaign.clientType) {\n        continue;\n      }\n      \n      const message = replacePlaceholders(campaign.messageTemplate, {\n        client,\n        lead,\n      });\n      \n      try {\n        const result = await sendSMS(client.phone, message);\n        \n        await storage.createSMSLog({\n          recipientPhone: client.phone,\n          recipientName: client.name,\n          message,\n          isOutbound: true,\n          status: 'sent',\n          twilioMessageSid: result?.sid || null,\n          relatedEntityType: 'lead',\n          relatedEntityId: lead.id,\n          sentAt: new Date(),\n        });\n        \n        console.log(`Automation: Sent lead_new message to ${client.name} (${client.phone})`);\n        messagesSent++;\n      } catch (error) {\n        console.error(`Automation: Failed to send SMS to ${client.phone}:`, error);\n      }\n    }\n  } catch (error) {\n    console.error('Error processing lead_new campaigns:', error);\n  }\n  \n  return messagesSent;\n}\n\nexport async function processAutomationCampaigns(): Promise<{ processed: number; sent: number }> {\n  console.log('Automation: Starting campaign processing...');\n  \n  let totalProcessed = 0;\n  let totalSent = 0;\n  \n  try {\n    const campaigns = await storage.getAutomationCampaigns();\n    const activeCampaigns = campaigns.filter(c => c.isActive);\n    \n    console.log(`Automation: Found ${activeCampaigns.length} active campaigns`);\n    \n    for (const campaign of activeCampaigns) {\n      if (!isWithinSendWindow(campaign.sendWindow)) {\n        console.log(`Automation: Campaign \"${campaign.name}\" outside send window (${campaign.sendWindow})`);\n        continue;\n      }\n      \n      totalProcessed++;\n      let sent = 0;\n      \n      switch (campaign.trigger) {\n        case 'payment_due':\n          sent = await processPaymentDueCampaigns(campaign);\n          break;\n        case 'quote_sent':\n          sent = await processQuoteSentCampaigns(campaign);\n          break;\n        case 'lead_new':\n          sent = await processNewLeadCampaigns(campaign);\n          break;\n        default:\n          console.log(`Automation: Trigger \"${campaign.trigger}\" not yet implemented`);\n      }\n      \n      totalSent += sent;\n    }\n  } catch (error) {\n    console.error('Automation: Error processing campaigns:', error);\n  }\n  \n  console.log(`Automation: Completed - processed ${totalProcessed} campaigns, sent ${totalSent} messages`);\n  \n  return { processed: totalProcessed, sent: totalSent };\n}\n\nlet automationInterval: NodeJS.Timeout | null = null;\n\nexport function startAutomationProcessor(intervalMinutes: number = 5) {\n  if (automationInterval) {\n    console.log('Automation: Processor already running');\n    return;\n  }\n  \n  console.log(`Automation: Starting processor (runs every ${intervalMinutes} minutes)`);\n  \n  processAutomationCampaigns();\n  \n  automationInterval = setInterval(() => {\n    processAutomationCampaigns();\n  }, intervalMinutes * 60 * 1000);\n}\n\nexport function stopAutomationProcessor() {\n  if (automationInterval) {\n    clearInterval(automationInterval);\n    automationInterval = null;\n    console.log('Automation: Processor stopped');\n  }\n}\n","path":null,"size_bytes":11662,"size_tokens":null},"client/src/components/coaching/LiveCallCoachPanel.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Progress } from \"@/components/ui/progress\";\nimport {\n  Mic,\n  Phone,\n  Clock,\n  CheckCircle2,\n  Circle,\n  AlertTriangle,\n  MessageSquare,\n  Lightbulb,\n  User,\n  Users,\n  X,\n  ChevronDown,\n  ChevronUp,\n} from \"lucide-react\";\nimport type { VoiceCall, CallTranscript, SalesChecklistItem, CallChecklistStatus, CallCoachingPrompt } from \"@shared/schema\";\n\ninterface ChecklistItemWithStatus extends SalesChecklistItem {\n  status?: CallChecklistStatus;\n}\n\ninterface LiveCallCoachPanelProps {\n  callId: string;\n  onClose?: () => void;\n}\n\nexport function LiveCallCoachPanel({ callId, onClose }: LiveCallCoachPanelProps) {\n  const [expandedSections, setExpandedSections] = useState({\n    transcript: true,\n    checklist: true,\n    prompts: true,\n  });\n  const transcriptEndRef = useRef<HTMLDivElement>(null);\n\n  const { data: callData, refetch } = useQuery<{\n    call: VoiceCall;\n    transcripts: CallTranscript[];\n    checklistStatus: CallChecklistStatus[];\n    coachingPrompts: CallCoachingPrompt[];\n  }>({\n    queryKey: [\"/api/voice-calls\", callId],\n    refetchInterval: 2000,\n  });\n\n  const { data: checklistItems = [] } = useQuery<SalesChecklistItem[]>({\n    queryKey: [\"/api/sales-checklist-items/active\"],\n  });\n\n  useEffect(() => {\n    transcriptEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  }, [callData?.transcripts.length]);\n\n  const call = callData?.call;\n  const transcripts = callData?.transcripts || [];\n  const checklistStatus = callData?.checklistStatus || [];\n  const coachingPrompts = callData?.coachingPrompts || [];\n\n  const checklistWithStatus: ChecklistItemWithStatus[] = checklistItems.map((item) => ({\n    ...item,\n    status: checklistStatus.find((s) => s.checklistItemId === item.id),\n  }));\n\n  const coveredCount = checklistWithStatus.filter((i) => i.status?.isCovered).length;\n  const requiredItems = checklistWithStatus.filter((i) => i.isRequired);\n  const requiredCoveredCount = requiredItems.filter((i) => i.status?.isCovered).length;\n  const progress = checklistItems.length > 0 ? (coveredCount / checklistItems.length) * 100 : 0;\n\n  const activePrompts = coachingPrompts.filter((p) => !p.wasAcknowledged);\n\n  const formatDuration = (startTime: Date | null, endTime?: Date | null) => {\n    if (!startTime) return \"0:00\";\n    const start = new Date(startTime);\n    const end = endTime ? new Date(endTime) : new Date();\n    const seconds = Math.floor((end.getTime() - start.getTime()) / 1000);\n    const mins = Math.floor(seconds / 60);\n    const secs = seconds % 60;\n    return `${mins}:${secs.toString().padStart(2, \"0\")}`;\n  };\n\n  const toggleSection = (section: keyof typeof expandedSections) => {\n    setExpandedSections((prev) => ({ ...prev, [section]: !prev[section] }));\n  };\n\n  if (!call) {\n    return (\n      <Card className=\"w-full max-w-md\">\n        <CardContent className=\"pt-6 text-center text-muted-foreground\">\n          Loading call data...\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const isCallActive = call.status === \"ringing\" || call.status === \"in_progress\";\n\n  return (\n    <Card className=\"w-full max-w-md flex flex-col h-[calc(100vh-8rem)] overflow-hidden\" data-testid=\"live-call-coach-panel\">\n      <CardHeader className=\"pb-3 flex-shrink-0\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <div className={`p-2 rounded-full ${isCallActive ? \"bg-green-500/20 animate-pulse\" : \"bg-muted\"}`}>\n              <Phone className={`h-4 w-4 ${isCallActive ? \"text-green-500\" : \"text-muted-foreground\"}`} />\n            </div>\n            <div>\n              <CardTitle className=\"text-base\">\n                {isCallActive ? \"Live Call Coach\" : \"Call Review\"}\n              </CardTitle>\n              <CardDescription className=\"flex items-center gap-2\">\n                <Clock className=\"h-3 w-3\" />\n                {formatDuration(call.startedAt, call.endedAt)}\n                {isCallActive && (\n                  <Badge variant=\"default\" className=\"text-xs bg-green-500\">\n                    <Mic className=\"h-3 w-3 mr-1\" />\n                    Live\n                  </Badge>\n                )}\n              </CardDescription>\n            </div>\n          </div>\n          {onClose && (\n            <Button variant=\"ghost\" size=\"icon\" onClick={onClose} data-testid=\"button-close-coach\">\n              <X className=\"h-4 w-4\" />\n            </Button>\n          )}\n        </div>\n        <Progress value={progress} className=\"h-2 mt-2\" />\n        <div className=\"flex justify-between text-xs text-muted-foreground mt-1\">\n          <span>{coveredCount}/{checklistItems.length} topics covered</span>\n          <span>{requiredCoveredCount}/{requiredItems.length} required</span>\n        </div>\n      </CardHeader>\n\n      <div className=\"flex-1 overflow-hidden flex flex-col\">\n        {activePrompts.length > 0 && (\n          <div className=\"px-4 pb-3 flex-shrink-0\">\n            <div className=\"bg-orange-500/10 border border-orange-500/30 rounded-lg p-3\">\n              <div className=\"flex items-start gap-2\">\n                <Lightbulb className=\"h-4 w-4 text-orange-500 mt-0.5 flex-shrink-0\" />\n                <div className=\"flex-1 min-w-0\">\n                  <p className=\"text-sm font-medium text-orange-700 dark:text-orange-300\">\n                    {activePrompts[0].message}\n                  </p>\n                  {activePrompts[0].relatedChecklistItemId && (\n                    <p className=\"text-xs text-muted-foreground mt-1\">\n                      {checklistItems.find((i) => i.id === activePrompts[0].relatedChecklistItemId)?.suggestedResponse}\n                    </p>\n                  )}\n                </div>\n              </div>\n              {activePrompts.length > 1 && (\n                <p className=\"text-xs text-muted-foreground mt-2\">\n                  +{activePrompts.length - 1} more suggestions\n                </p>\n              )}\n            </div>\n          </div>\n        )}\n\n        <Separator />\n\n        <div\n          className=\"flex items-center justify-between px-4 py-2 cursor-pointer hover:bg-muted/50\"\n          onClick={() => toggleSection(\"transcript\")}\n          data-testid=\"toggle-transcript-section\"\n        >\n          <div className=\"flex items-center gap-2\">\n            <MessageSquare className=\"h-4 w-4\" />\n            <span className=\"text-sm font-medium\">Transcript</span>\n            <Badge variant=\"secondary\" className=\"text-xs\">{transcripts.length}</Badge>\n          </div>\n          {expandedSections.transcript ? <ChevronUp className=\"h-4 w-4\" /> : <ChevronDown className=\"h-4 w-4\" />}\n        </div>\n\n        {expandedSections.transcript && (\n          <ScrollArea className=\"flex-1 px-4 min-h-0\">\n            <div className=\"space-y-2 py-2\">\n              {transcripts.length === 0 ? (\n                <p className=\"text-sm text-muted-foreground text-center py-4\">\n                  {isCallActive ? \"Waiting for conversation...\" : \"No transcript available\"}\n                </p>\n              ) : (\n                transcripts.map((t) => (\n                  <div\n                    key={t.id}\n                    className={`flex gap-2 ${t.speaker === \"staff\" ? \"justify-end\" : \"justify-start\"}`}\n                  >\n                    <div\n                      className={`max-w-[85%] rounded-lg px-3 py-2 text-sm ${\n                        t.speaker === \"staff\"\n                          ? \"bg-primary text-primary-foreground\"\n                          : \"bg-muted\"\n                      }`}\n                    >\n                      <div className=\"flex items-center gap-1 text-xs opacity-70 mb-1\">\n                        {t.speaker === \"staff\" ? <User className=\"h-3 w-3\" /> : <Users className=\"h-3 w-3\" />}\n                        {t.speaker === \"staff\" ? \"You\" : \"Customer\"}\n                      </div>\n                      <p>{t.text}</p>\n                    </div>\n                  </div>\n                ))\n              )}\n              <div ref={transcriptEndRef} />\n            </div>\n          </ScrollArea>\n        )}\n\n        <Separator />\n\n        <div\n          className=\"flex items-center justify-between px-4 py-2 cursor-pointer hover:bg-muted/50\"\n          onClick={() => toggleSection(\"checklist\")}\n          data-testid=\"toggle-checklist-section\"\n        >\n          <div className=\"flex items-center gap-2\">\n            <CheckCircle2 className=\"h-4 w-4\" />\n            <span className=\"text-sm font-medium\">Checklist</span>\n            <Badge variant=\"secondary\" className=\"text-xs\">\n              {coveredCount}/{checklistItems.length}\n            </Badge>\n          </div>\n          {expandedSections.checklist ? <ChevronUp className=\"h-4 w-4\" /> : <ChevronDown className=\"h-4 w-4\" />}\n        </div>\n\n        {expandedSections.checklist && (\n          <ScrollArea className=\"max-h-48 px-4\">\n            <div className=\"space-y-1 py-2\">\n              {checklistWithStatus.map((item) => {\n                const isCovered = item.status?.isCovered;\n                const isRequired = item.isRequired;\n                return (\n                  <div\n                    key={item.id}\n                    className={`flex items-start gap-2 p-2 rounded-lg ${\n                      isCovered ? \"bg-green-500/10\" : isRequired ? \"bg-orange-500/10\" : \"\"\n                    }`}\n                    data-testid={`checklist-item-status-${item.id}`}\n                  >\n                    {isCovered ? (\n                      <CheckCircle2 className=\"h-4 w-4 text-green-500 mt-0.5 flex-shrink-0\" />\n                    ) : isRequired ? (\n                      <AlertTriangle className=\"h-4 w-4 text-orange-500 mt-0.5 flex-shrink-0\" />\n                    ) : (\n                      <Circle className=\"h-4 w-4 text-muted-foreground mt-0.5 flex-shrink-0\" />\n                    )}\n                    <div className=\"flex-1 min-w-0\">\n                      <p className={`text-sm ${isCovered ? \"line-through text-muted-foreground\" : \"\"}`}>\n                        {item.question}\n                      </p>\n                      {!isCovered && item.suggestedResponse && (\n                        <p className=\"text-xs text-muted-foreground mt-1 italic\">\n                          Tip: {item.suggestedResponse}\n                        </p>\n                      )}\n                    </div>\n                    {isRequired && !isCovered && (\n                      <Badge variant=\"destructive\" className=\"text-xs flex-shrink-0\">Required</Badge>\n                    )}\n                  </div>\n                );\n              })}\n            </div>\n          </ScrollArea>\n        )}\n      </div>\n    </Card>\n  );\n}\n\nexport function MiniCallCoachBadge({ callId }: { callId: string }) {\n  const { data: checklistItems = [] } = useQuery<SalesChecklistItem[]>({\n    queryKey: [\"/api/sales-checklist-items/active\"],\n  });\n\n  const { data: callData } = useQuery<{\n    call: VoiceCall;\n    transcripts: CallTranscript[];\n    checklistStatus: CallChecklistStatus[];\n    coachingPrompts: CallCoachingPrompt[];\n  }>({\n    queryKey: [\"/api/voice-calls\", callId],\n    refetchInterval: 2000,\n  });\n\n  const checklistStatus = callData?.checklistStatus || [];\n  const coachingPrompts = callData?.coachingPrompts || [];\n  \n  const coveredCount = checklistStatus.filter((s) => s.isCovered).length;\n  const activePrompts = coachingPrompts.filter((p) => !p.wasAcknowledged);\n\n  return (\n    <div className=\"flex items-center gap-2\" data-testid=\"mini-call-coach-badge\">\n      <Badge variant=\"outline\" className=\"text-xs\">\n        <CheckCircle2 className=\"h-3 w-3 mr-1\" />\n        {coveredCount}/{checklistItems.length}\n      </Badge>\n      {activePrompts.length > 0 && (\n        <Badge variant=\"default\" className=\"text-xs bg-orange-500\">\n          <Lightbulb className=\"h-3 w-3 mr-1\" />\n          {activePrompts.length}\n        </Badge>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":12288,"size_tokens":null},"client/src/pages/SalesChecklistConfig.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Plus,\n  Pencil,\n  Trash2,\n  ChevronUp,\n  ChevronDown,\n  HelpCircle,\n  CheckCircle2,\n  MessageSquare,\n  Loader2,\n  Mic,\n} from \"lucide-react\";\nimport type { SalesChecklistItem } from \"@shared/schema\";\n\nconst CATEGORIES = [\n  { value: \"requirements\", label: \"Requirements\" },\n  { value: \"site_conditions\", label: \"Site Conditions\" },\n  { value: \"timeline\", label: \"Timeline\" },\n  { value: \"budget\", label: \"Budget\" },\n  { value: \"other\", label: \"Other\" },\n];\n\nexport default function SalesChecklistConfig() {\n  const { toast } = useToast();\n  const [dialogOpen, setDialogOpen] = useState(false);\n  const [editingItem, setEditingItem] = useState<SalesChecklistItem | null>(null);\n  const [formData, setFormData] = useState({\n    question: \"\",\n    description: \"\",\n    category: \"requirements\",\n    keywords: \"\",\n    suggestedResponse: \"\",\n    isRequired: false,\n    isActive: true,\n  });\n\n  const { data: items = [], isLoading } = useQuery<SalesChecklistItem[]>({\n    queryKey: [\"/api/sales-checklist-items\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: Partial<SalesChecklistItem>) => {\n      return apiRequest(\"POST\", \"/api/sales-checklist-items\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/sales-checklist-items\"] });\n      toast({ title: \"Checklist item created\" });\n      closeDialog();\n    },\n    onError: () => {\n      toast({ title: \"Failed to create checklist item\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<SalesChecklistItem> }) => {\n      return apiRequest(\"PATCH\", `/api/sales-checklist-items/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/sales-checklist-items\"] });\n      toast({ title: \"Checklist item updated\" });\n      closeDialog();\n    },\n    onError: () => {\n      toast({ title: \"Failed to update checklist item\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/sales-checklist-items/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/sales-checklist-items\"] });\n      toast({ title: \"Checklist item deleted\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to delete checklist item\", variant: \"destructive\" });\n    },\n  });\n\n  const reorderMutation = useMutation({\n    mutationFn: async (itemIds: string[]) => {\n      return apiRequest(\"POST\", \"/api/sales-checklist-items/reorder\", { itemIds });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/sales-checklist-items\"] });\n    },\n    onError: () => {\n      toast({ title: \"Failed to reorder items\", variant: \"destructive\" });\n    },\n  });\n\n  const openDialog = (item?: SalesChecklistItem) => {\n    if (item) {\n      setEditingItem(item);\n      setFormData({\n        question: item.question,\n        description: item.description || \"\",\n        category: item.category || \"requirements\",\n        keywords: Array.isArray(item.keywords) ? item.keywords.join(\", \") : \"\",\n        suggestedResponse: item.suggestedResponse || \"\",\n        isRequired: item.isRequired,\n        isActive: item.isActive,\n      });\n    } else {\n      setEditingItem(null);\n      setFormData({\n        question: \"\",\n        description: \"\",\n        category: \"requirements\",\n        keywords: \"\",\n        suggestedResponse: \"\",\n        isRequired: false,\n        isActive: true,\n      });\n    }\n    setDialogOpen(true);\n  };\n\n  const closeDialog = () => {\n    setDialogOpen(false);\n    setEditingItem(null);\n  };\n\n  const handleSubmit = () => {\n    const keywords = formData.keywords\n      .split(\",\")\n      .map((k) => k.trim().toLowerCase())\n      .filter((k) => k.length > 0);\n\n    const data = {\n      question: formData.question,\n      description: formData.description || null,\n      category: formData.category,\n      keywords,\n      suggestedResponse: formData.suggestedResponse || null,\n      isRequired: formData.isRequired,\n      isActive: formData.isActive,\n    };\n\n    if (editingItem) {\n      updateMutation.mutate({ id: editingItem.id, data });\n    } else {\n      createMutation.mutate(data);\n    }\n  };\n\n  const moveItem = (fromIndex: number, direction: \"up\" | \"down\") => {\n    const toIndex = direction === \"up\" ? fromIndex - 1 : fromIndex + 1;\n    if (toIndex < 0 || toIndex >= items.length) return;\n\n    const newItems = [...items];\n    const temp = newItems[fromIndex];\n    newItems[fromIndex] = newItems[toIndex];\n    newItems[toIndex] = temp;\n\n    reorderMutation.mutate(newItems.map((i) => i.id));\n  };\n\n  const getCategoryLabel = (value: string | null) => {\n    return CATEGORIES.find((c) => c.value === value)?.label || \"Other\";\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  const activeCount = items.filter((i) => i.isActive).length;\n  const requiredCount = items.filter((i) => i.isRequired).length;\n\n  return (\n    <div className=\"container max-w-4xl py-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-semibold flex items-center gap-2\">\n            <Mic className=\"h-6 w-6\" />\n            Sales Call Checklist\n          </h1>\n          <p className=\"text-muted-foreground mt-1\">\n            Configure questions staff should ask during sales calls. The AI coach will track coverage and prompt when items are missed.\n          </p>\n        </div>\n        <Button onClick={() => openDialog()} data-testid=\"button-add-checklist-item\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Add Question\n        </Button>\n      </div>\n\n      <div className=\"flex gap-4\">\n        <Card className=\"flex-1\">\n          <CardContent className=\"pt-4\">\n            <div className=\"text-2xl font-bold\">{activeCount}</div>\n            <div className=\"text-sm text-muted-foreground\">Active Questions</div>\n          </CardContent>\n        </Card>\n        <Card className=\"flex-1\">\n          <CardContent className=\"pt-4\">\n            <div className=\"text-2xl font-bold\">{requiredCount}</div>\n            <div className=\"text-sm text-muted-foreground\">Required Questions</div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Checklist Questions</CardTitle>\n          <CardDescription>\n            Questions will be tracked in real-time during calls. The AI analyzes the conversation to detect when each topic is covered.\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {items.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <HelpCircle className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n              <p className=\"text-lg font-medium\">No checklist items yet</p>\n              <p className=\"text-sm\">Add questions that staff should ask during sales calls.</p>\n              <Button className=\"mt-4\" onClick={() => openDialog()} data-testid=\"button-add-first-item\">\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Add First Question\n              </Button>\n            </div>\n          ) : (\n            <div className=\"space-y-2\">\n              {items.map((item, index) => (\n                <div\n                  key={item.id}\n                  className={`flex items-center gap-3 p-3 rounded-lg border hover-elevate ${\n                    !item.isActive ? \"opacity-50\" : \"\"\n                  }`}\n                  data-testid={`checklist-item-${item.id}`}\n                >\n                  <div className=\"flex flex-col gap-1\">\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      className=\"h-5 w-5\"\n                      disabled={index === 0 || reorderMutation.isPending}\n                      onClick={() => moveItem(index, \"up\")}\n                      data-testid={`button-item-up-${item.id}`}\n                    >\n                      <ChevronUp className=\"h-3 w-3\" />\n                    </Button>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      className=\"h-5 w-5\"\n                      disabled={index === items.length - 1 || reorderMutation.isPending}\n                      onClick={() => moveItem(index, \"down\")}\n                      data-testid={`button-item-down-${item.id}`}\n                    >\n                      <ChevronDown className=\"h-3 w-3\" />\n                    </Button>\n                  </div>\n\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"flex items-center gap-2 flex-wrap\">\n                      <span className=\"font-medium\">{item.question}</span>\n                      {item.isRequired && (\n                        <Badge variant=\"default\" className=\"text-xs\">\n                          Required\n                        </Badge>\n                      )}\n                      <Badge variant=\"outline\" className=\"text-xs\">\n                        {getCategoryLabel(item.category)}\n                      </Badge>\n                      {!item.isActive && (\n                        <Badge variant=\"secondary\" className=\"text-xs\">\n                          Inactive\n                        </Badge>\n                      )}\n                    </div>\n                    {item.description && (\n                      <p className=\"text-sm text-muted-foreground mt-1 truncate\">\n                        {item.description}\n                      </p>\n                    )}\n                    {item.keywords && item.keywords.length > 0 && (\n                      <div className=\"flex gap-1 mt-1 flex-wrap\">\n                        {(item.keywords as string[]).slice(0, 5).map((kw, i) => (\n                          <Badge key={i} variant=\"secondary\" className=\"text-xs\">\n                            {kw}\n                          </Badge>\n                        ))}\n                        {(item.keywords as string[]).length > 5 && (\n                          <span className=\"text-xs text-muted-foreground\">\n                            +{(item.keywords as string[]).length - 5} more\n                          </span>\n                        )}\n                      </div>\n                    )}\n                  </div>\n\n                  <div className=\"flex items-center gap-2\">\n                    {item.suggestedResponse && (\n                      <MessageSquare className=\"h-4 w-4 text-muted-foreground\" />\n                    )}\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      onClick={() => openDialog(item)}\n                      data-testid={`button-edit-item-${item.id}`}\n                    >\n                      <Pencil className=\"h-4 w-4\" />\n                    </Button>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      disabled={deleteMutation.isPending}\n                      onClick={() => {\n                        if (confirm(\"Delete this checklist item?\")) {\n                          deleteMutation.mutate(item.id);\n                        }\n                      }}\n                      data-testid={`button-delete-item-${item.id}`}\n                    >\n                      <Trash2 className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>\n              {editingItem ? \"Edit Checklist Question\" : \"Add Checklist Question\"}\n            </DialogTitle>\n          </DialogHeader>\n\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"question\">Question *</Label>\n              <Input\n                id=\"question\"\n                value={formData.question}\n                onChange={(e) => setFormData({ ...formData, question: e.target.value })}\n                placeholder=\"e.g., What fence height do you need?\"\n                data-testid=\"input-question\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"description\">Description</Label>\n              <Input\n                id=\"description\"\n                value={formData.description}\n                onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                placeholder=\"Brief explanation for staff\"\n                data-testid=\"input-description\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"category\">Category</Label>\n              <Select\n                value={formData.category}\n                onValueChange={(value) => setFormData({ ...formData, category: value })}\n              >\n                <SelectTrigger data-testid=\"select-category\">\n                  <SelectValue placeholder=\"Select category\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {CATEGORIES.map((cat) => (\n                    <SelectItem key={cat.value} value={cat.value}>\n                      {cat.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"keywords\">Keywords (comma-separated)</Label>\n              <Input\n                id=\"keywords\"\n                value={formData.keywords}\n                onChange={(e) => setFormData({ ...formData, keywords: e.target.value })}\n                placeholder=\"height, tall, high, 1.8m, 1.5m\"\n                data-testid=\"input-keywords\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Keywords help the AI detect when this topic is mentioned in the conversation\n              </p>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"suggestedResponse\">Suggested Response</Label>\n              <Textarea\n                id=\"suggestedResponse\"\n                value={formData.suggestedResponse}\n                onChange={(e) => setFormData({ ...formData, suggestedResponse: e.target.value })}\n                placeholder=\"A helpful response to show to staff if customer asks about this topic\"\n                className=\"min-h-[80px]\"\n                data-testid=\"input-suggested-response\"\n              />\n            </div>\n\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-2\">\n                <Switch\n                  id=\"isRequired\"\n                  checked={formData.isRequired}\n                  onCheckedChange={(checked) => setFormData({ ...formData, isRequired: checked })}\n                  data-testid=\"switch-required\"\n                />\n                <Label htmlFor=\"isRequired\">Required question</Label>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <Switch\n                  id=\"isActive\"\n                  checked={formData.isActive}\n                  onCheckedChange={(checked) => setFormData({ ...formData, isActive: checked })}\n                  data-testid=\"switch-active\"\n                />\n                <Label htmlFor=\"isActive\">Active</Label>\n              </div>\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={closeDialog} data-testid=\"button-cancel\">\n              Cancel\n            </Button>\n            <Button\n              onClick={handleSubmit}\n              disabled={!formData.question || createMutation.isPending || updateMutation.isPending}\n              data-testid=\"button-save\"\n            >\n              {createMutation.isPending || updateMutation.isPending ? (\n                <Loader2 className=\"h-4 w-4 animate-spin mr-2\" />\n              ) : null}\n              {editingItem ? \"Update\" : \"Create\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":17289,"size_tokens":null},"client/src/pages/Calls.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { format } from \"date-fns\";\nimport { Phone, PhoneIncoming, PhoneOutgoing, PhoneMissed, Clock, Play, Download } from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport type { VoiceCall } from \"@shared/schema\";\n\nfunction formatDuration(seconds: number | null): string {\n  if (!seconds) return \"0:00\";\n  const mins = Math.floor(seconds / 60);\n  const secs = seconds % 60;\n  return `${mins}:${secs.toString().padStart(2, \"0\")}`;\n}\n\nfunction CallStatusBadge({ status }: { status: string }) {\n  const variants: Record<string, \"default\" | \"secondary\" | \"destructive\" | \"outline\"> = {\n    completed: \"default\",\n    in_progress: \"secondary\",\n    ringing: \"secondary\",\n    failed: \"destructive\",\n    busy: \"destructive\",\n    no_answer: \"outline\",\n    canceled: \"outline\",\n  };\n  return <Badge variant={variants[status] || \"outline\"}>{status.replace(\"_\", \" \")}</Badge>;\n}\n\nfunction CallDirectionIcon({ direction }: { direction: string }) {\n  if (direction === \"inbound\") {\n    return <PhoneIncoming className=\"w-4 h-4 text-green-600\" />;\n  }\n  if (direction === \"outbound\") {\n    return <PhoneOutgoing className=\"w-4 h-4 text-blue-600\" />;\n  }\n  return <PhoneMissed className=\"w-4 h-4 text-red-600\" />;\n}\n\nexport default function Calls() {\n  const [selectedCall, setSelectedCall] = useState<VoiceCall | null>(null);\n\n  const { data: calls = [], isLoading } = useQuery<VoiceCall[]>({\n    queryKey: [\"/api/voice-calls\"],\n  });\n\n  const recentCalls = calls.slice(0, 50);\n  const activeCalls = calls.filter((c) => c.status === \"in_progress\" || c.status === \"ringing\");\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"page-calls\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-semibold\">Calls</h1>\n          <p className=\"text-muted-foreground\">View call history and recordings with AI coaching insights</p>\n        </div>\n        {activeCalls.length > 0 && (\n          <Badge variant=\"secondary\" className=\"animate-pulse\">\n            <Phone className=\"w-3 h-3 mr-1\" />\n            {activeCalls.length} Active Call{activeCalls.length > 1 ? \"s\" : \"\"}\n          </Badge>\n        )}\n      </div>\n\n      <Tabs defaultValue=\"recent\">\n        <TabsList>\n          <TabsTrigger value=\"recent\" data-testid=\"tab-recent-calls\">Recent Calls</TabsTrigger>\n          <TabsTrigger value=\"active\" data-testid=\"tab-active-calls\">\n            Active ({activeCalls.length})\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"recent\" className=\"mt-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-lg\">Call History</CardTitle>\n            </CardHeader>\n            <CardContent>\n              {isLoading ? (\n                <div className=\"text-center py-8 text-muted-foreground\">Loading calls...</div>\n              ) : recentCalls.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <Phone className=\"w-12 h-12 mx-auto mb-4 opacity-20\" />\n                  <p>No calls yet</p>\n                  <p className=\"text-sm\">Calls will appear here once you start receiving or making them</p>\n                </div>\n              ) : (\n                <ScrollArea className=\"h-[500px]\">\n                  <div className=\"space-y-2\">\n                    {recentCalls.map((call) => (\n                      <div\n                        key={call.id}\n                        className=\"flex items-center gap-4 p-3 rounded-lg border hover-elevate cursor-pointer\"\n                        onClick={() => setSelectedCall(call)}\n                        data-testid={`call-row-${call.id}`}\n                      >\n                        <CallDirectionIcon direction={call.direction} />\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className=\"font-medium truncate\">\n                              {call.direction === \"inbound\" ? call.fromNumber : call.toNumber}\n                            </span>\n                            <CallStatusBadge status={call.status} />\n                          </div>\n                          <div className=\"text-sm text-muted-foreground flex items-center gap-2\">\n                            <Clock className=\"w-3 h-3\" />\n                            {call.startedAt ? format(new Date(call.startedAt), \"MMM d, h:mm a\") : \"Pending\"}\n                            {call.duration && (\n                              <span className=\"ml-2\">{formatDuration(call.duration)}</span>\n                            )}\n                          </div>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          {call.recordingUrl && (\n                            <Button size=\"icon\" variant=\"ghost\" data-testid={`play-recording-${call.id}`}>\n                              <Play className=\"w-4 h-4\" />\n                            </Button>\n                          )}\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </ScrollArea>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"active\" className=\"mt-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-lg\">Active Calls</CardTitle>\n            </CardHeader>\n            <CardContent>\n              {activeCalls.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <Phone className=\"w-12 h-12 mx-auto mb-4 opacity-20\" />\n                  <p>No active calls</p>\n                </div>\n              ) : (\n                <div className=\"space-y-3\">\n                  {activeCalls.map((call) => (\n                    <div\n                      key={call.id}\n                      className=\"p-4 rounded-lg border-2 border-green-500 bg-green-50 dark:bg-green-950\"\n                      data-testid={`active-call-${call.id}`}\n                    >\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"w-3 h-3 bg-green-500 rounded-full animate-pulse\" />\n                          <CallDirectionIcon direction={call.direction} />\n                          <span className=\"font-medium\">\n                            {call.direction === \"inbound\" ? call.fromNumber : call.toNumber}\n                          </span>\n                        </div>\n                        <Badge variant=\"secondary\">{call.status.replace(\"_\", \" \")}</Badge>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n\n      {selectedCall && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <CallDirectionIcon direction={selectedCall.direction} />\n              Call Details\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n              <div>\n                <p className=\"text-sm text-muted-foreground\">From</p>\n                <p className=\"font-medium\">{selectedCall.fromNumber}</p>\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">To</p>\n                <p className=\"font-medium\">{selectedCall.toNumber}</p>\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Duration</p>\n                <p className=\"font-medium\">{formatDuration(selectedCall.duration)}</p>\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Status</p>\n                <CallStatusBadge status={selectedCall.status} />\n              </div>\n            </div>\n            {selectedCall.recordingUrl && (\n              <div>\n                <p className=\"text-sm text-muted-foreground mb-2\">Recording</p>\n                <div className=\"flex items-center gap-2\">\n                  <audio controls src={selectedCall.recordingUrl} className=\"flex-1\" />\n                  <Button size=\"icon\" variant=\"outline\" asChild>\n                    <a href={selectedCall.recordingUrl} download>\n                      <Download className=\"w-4 h-4\" />\n                    </a>\n                  </Button>\n                </div>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":9069,"size_tokens":null},"server/coaching.ts":{"content":"import OpenAI from \"openai\";\nimport { storage } from \"./storage\";\nimport type { SalesChecklistItem, CallTranscript, CallChecklistStatus } from \"@shared/schema\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n});\n\ninterface AnalysisResult {\n  coveredItems: Array<{\n    checklistItemId: string;\n    isCovered: boolean;\n    detectedText?: string;\n  }>;\n  suggestedPrompts: Array<{\n    promptType: string;\n    message: string;\n    relatedChecklistItemId?: string;\n    triggerText?: string;\n  }>;\n}\n\nexport async function analyzeTranscriptForChecklist(\n  callId: string,\n  transcripts: CallTranscript[],\n  checklistItems: SalesChecklistItem[],\n  currentStatus: CallChecklistStatus[]\n): Promise<AnalysisResult> {\n  if (transcripts.length === 0 || checklistItems.length === 0) {\n    return { coveredItems: [], suggestedPrompts: [] };\n  }\n\n  const conversationText = transcripts\n    .map((t) => `${t.speaker === \"staff\" ? \"STAFF\" : \"CUSTOMER\"}: ${t.text}`)\n    .join(\"\\n\");\n\n  const uncoveredItems = checklistItems.filter((item) => {\n    const status = currentStatus.find((s) => s.checklistItemId === item.id);\n    return !status?.isCovered;\n  });\n\n  if (uncoveredItems.length === 0) {\n    return { coveredItems: [], suggestedPrompts: [] };\n  }\n\n  const checklistSummary = uncoveredItems\n    .map((item) => ({\n      id: item.id,\n      question: item.question,\n      keywords: item.keywords,\n      isRequired: item.isRequired,\n      suggestedResponse: item.suggestedResponse,\n    }));\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o-mini\",\n      messages: [\n        {\n          role: \"system\",\n          content: `You are an AI sales coach for a PVC fencing company. Your job is to:\n1. Analyze sales call conversations to detect which topics from a checklist have been discussed\n2. Suggest prompts when important topics haven't been covered yet\n\nRules:\n- Be conservative about marking items as covered - only mark if the topic was clearly discussed\n- Prioritize required items in suggestions\n- Keep prompts short and actionable (under 50 words)\n- Consider context - if a customer mentions something related to a checklist item, it may count as covered\n\nRespond with JSON only:\n{\n  \"coveredItems\": [\n    { \"checklistItemId\": \"id\", \"isCovered\": true, \"detectedText\": \"the text that indicates coverage\" }\n  ],\n  \"suggestedPrompts\": [\n    { \"promptType\": \"reminder|suggestion|alert\", \"message\": \"what to say\", \"relatedChecklistItemId\": \"id\", \"triggerText\": \"what triggered this prompt\" }\n  ]\n}`\n        },\n        {\n          role: \"user\",\n          content: `Analyze this sales call conversation for PVC fencing:\n\nCONVERSATION:\n${conversationText}\n\nUNCOVERED CHECKLIST ITEMS:\n${JSON.stringify(checklistSummary, null, 2)}\n\nIdentify which items have now been covered and suggest prompts for important uncovered items. Prioritize required items.`\n        }\n      ],\n      temperature: 0.3,\n      response_format: { type: \"json_object\" },\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      return { coveredItems: [], suggestedPrompts: [] };\n    }\n\n    const result = JSON.parse(content) as AnalysisResult;\n    return result;\n  } catch (error) {\n    console.error(\"Error analyzing transcript:\", error);\n    return { coveredItems: [], suggestedPrompts: [] };\n  }\n}\n\nexport async function processTranscriptUpdate(callId: string): Promise<void> {\n  try {\n    const [transcripts, checklistItems, currentStatus] = await Promise.all([\n      storage.getCallTranscripts(callId),\n      storage.getActiveSalesChecklistItems(),\n      storage.getCallChecklistStatus(callId),\n    ]);\n\n    const analysis = await analyzeTranscriptForChecklist(\n      callId,\n      transcripts,\n      checklistItems,\n      currentStatus\n    );\n\n    for (const item of analysis.coveredItems) {\n      if (item.isCovered) {\n        await storage.updateCallChecklistItemStatus(\n          callId,\n          item.checklistItemId,\n          true,\n          item.detectedText\n        );\n      }\n    }\n\n    const existingPrompts = await storage.getCallCoachingPrompts(callId);\n    for (const prompt of analysis.suggestedPrompts) {\n      const alreadyExists = existingPrompts.some(\n        (p) => p.relatedChecklistItemId === prompt.relatedChecklistItemId && !p.wasAcknowledged\n      );\n      \n      if (!alreadyExists) {\n        await storage.createCallCoachingPrompt({\n          callId,\n          promptType: prompt.promptType,\n          message: prompt.message,\n          relatedChecklistItemId: prompt.relatedChecklistItemId,\n          triggerText: prompt.triggerText,\n        });\n      }\n    }\n  } catch (error) {\n    console.error(\"Error processing transcript update:\", error);\n  }\n}\n\nexport async function generateSuggestedResponse(\n  callId: string,\n  customerQuestion: string\n): Promise<string | null> {\n  try {\n    const [transcripts, checklistItems] = await Promise.all([\n      storage.getCallTranscripts(callId),\n      storage.getActiveSalesChecklistItems(),\n    ]);\n\n    const conversationContext = transcripts\n      .slice(-10)\n      .map((t) => `${t.speaker === \"staff\" ? \"STAFF\" : \"CUSTOMER\"}: ${t.text}`)\n      .join(\"\\n\");\n\n    const relevantItem = checklistItems.find((item) => {\n      if (!item.keywords) return false;\n      const keywords = item.keywords as string[];\n      const questionLower = customerQuestion.toLowerCase();\n      return keywords.some((kw) => questionLower.includes(kw.toLowerCase()));\n    });\n\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o-mini\",\n      messages: [\n        {\n          role: \"system\",\n          content: `You are a helpful sales assistant for Probuild PVC, a Western Australian PVC fencing manufacturer. \nGenerate a professional, friendly response to help the sales staff answer customer questions.\nKeep responses concise (2-3 sentences max) and focused on PVC fencing.\nUse Australian English spellings.`\n        },\n        {\n          role: \"user\",\n          content: `Recent conversation context:\n${conversationContext}\n\nCustomer just asked: \"${customerQuestion}\"\n\n${relevantItem?.suggestedResponse ? `Related product info: ${relevantItem.suggestedResponse}` : \"\"}\n\nGenerate a helpful response the staff member can use:`\n        }\n      ],\n      temperature: 0.7,\n      max_tokens: 150,\n    });\n\n    return response.choices[0]?.message?.content || null;\n  } catch (error) {\n    console.error(\"Error generating response:\", error);\n    return null;\n  }\n}\n\nexport function detectKeywordsInTranscript(\n  text: string,\n  checklistItems: SalesChecklistItem[]\n): SalesChecklistItem[] {\n  const textLower = text.toLowerCase();\n  \n  return checklistItems.filter((item) => {\n    if (!item.keywords) return false;\n    const keywords = item.keywords as string[];\n    return keywords.some((kw) => textLower.includes(kw.toLowerCase()));\n  });\n}\n","path":null,"size_bytes":6888,"size_tokens":null},"client/src/pages/ExpenseCategoryConfig.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { \n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { \n  Table, \n  TableBody, \n  TableCell, \n  TableHead, \n  TableHeader, \n  TableRow \n} from \"@/components/ui/table\";\nimport {\n  Tag,\n  Plus,\n  Pencil,\n  Trash2,\n  Loader2,\n  AlertCircle,\n} from \"lucide-react\";\n\ninterface ExpenseCategory {\n  id: string;\n  name: string;\n  description: string | null;\n  isActive: boolean;\n  createdAt: string;\n}\n\nexport default function ExpenseCategoryConfig() {\n  const { toast } = useToast();\n  const [showAddDialog, setShowAddDialog] = useState(false);\n  const [editingCategory, setEditingCategory] = useState<ExpenseCategory | null>(null);\n  const [categoryName, setCategoryName] = useState(\"\");\n  const [categoryDescription, setCategoryDescription] = useState(\"\");\n  const [categoryActive, setCategoryActive] = useState(true);\n\n  const { data: categories = [], isLoading } = useQuery<ExpenseCategory[]>({\n    queryKey: [\"/api/expense-categories\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: { name: string; description: string; isActive: boolean }) => {\n      const res = await apiRequest(\"POST\", \"/api/expense-categories\", data);\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Category Created\", description: \"Expense category added successfully\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/expense-categories\"] });\n      resetForm();\n    },\n    onError: (error: any) => {\n      toast({ \n        title: \"Error\", \n        description: error.message || \"Failed to create category\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: { name?: string; description?: string; isActive?: boolean } }) => {\n      const res = await apiRequest(\"PATCH\", `/api/expense-categories/${id}`, data);\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Category Updated\", description: \"Changes saved successfully\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/expense-categories\"] });\n      resetForm();\n    },\n    onError: (error: any) => {\n      toast({ \n        title: \"Error\", \n        description: error.message || \"Failed to update category\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await apiRequest(\"DELETE\", `/api/expense-categories/${id}`);\n    },\n    onSuccess: () => {\n      toast({ title: \"Category Deleted\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/expense-categories\"] });\n    },\n    onError: (error: any) => {\n      toast({ \n        title: \"Error\", \n        description: error.message || \"Failed to delete category\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const resetForm = () => {\n    setShowAddDialog(false);\n    setEditingCategory(null);\n    setCategoryName(\"\");\n    setCategoryDescription(\"\");\n    setCategoryActive(true);\n  };\n\n  const handleEdit = (category: ExpenseCategory) => {\n    setEditingCategory(category);\n    setCategoryName(category.name);\n    setCategoryDescription(category.description || \"\");\n    setCategoryActive(category.isActive);\n    setShowAddDialog(true);\n  };\n\n  const handleSubmit = () => {\n    if (!categoryName.trim()) return;\n\n    if (editingCategory) {\n      updateMutation.mutate({\n        id: editingCategory.id,\n        data: {\n          name: categoryName.trim(),\n          description: categoryDescription.trim() || undefined,\n          isActive: categoryActive,\n        },\n      });\n    } else {\n      createMutation.mutate({\n        name: categoryName.trim(),\n        description: categoryDescription.trim(),\n        isActive: categoryActive,\n      });\n    }\n  };\n\n  const handleToggleActive = (category: ExpenseCategory) => {\n    updateMutation.mutate({\n      id: category.id,\n      data: { isActive: !category.isActive },\n    });\n  };\n\n  return (\n    <div className=\"flex-1 p-6 space-y-6\">\n      <div className=\"flex items-center justify-between gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold flex items-center gap-2\" data-testid=\"heading-expense-categories\">\n            <Tag className=\"h-6 w-6\" />\n            Expense Categories\n          </h1>\n          <p className=\"text-muted-foreground mt-1\">\n            Configure expense categories for staff receipt submissions and transaction allocations\n          </p>\n        </div>\n        <Button \n          onClick={() => { resetForm(); setShowAddDialog(true); }}\n          data-testid=\"button-add-category\"\n        >\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Add Category\n        </Button>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-lg\">Categories</CardTitle>\n          <CardDescription>\n            Define expense categories that staff can select when submitting receipts\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"space-y-2\">\n              {[1, 2, 3].map(i => <Skeleton key={i} className=\"h-12\" />)}\n            </div>\n          ) : categories.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <Tag className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n              <p className=\"font-medium\">No Categories Yet</p>\n              <p className=\"text-sm mt-1\">\n                Add your first expense category to get started.\n              </p>\n            </div>\n          ) : (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Category Name</TableHead>\n                  <TableHead>Description</TableHead>\n                  <TableHead>Active</TableHead>\n                  <TableHead className=\"text-right\">Actions</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {categories.map((category) => (\n                  <TableRow key={category.id} data-testid={`row-category-${category.id}`}>\n                    <TableCell className=\"font-medium\">{category.name}</TableCell>\n                    <TableCell className=\"text-muted-foreground\">\n                      {category.description || \"-\"}\n                    </TableCell>\n                    <TableCell>\n                      <Switch\n                        checked={category.isActive}\n                        onCheckedChange={() => handleToggleActive(category)}\n                        data-testid={`switch-active-${category.id}`}\n                      />\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      <div className=\"flex items-center justify-end gap-2\">\n                        <Button\n                          size=\"icon\"\n                          variant=\"ghost\"\n                          onClick={() => handleEdit(category)}\n                          data-testid={`button-edit-${category.id}`}\n                        >\n                          <Pencil className=\"h-4 w-4\" />\n                        </Button>\n                        <Button\n                          size=\"icon\"\n                          variant=\"ghost\"\n                          onClick={() => deleteMutation.mutate(category.id)}\n                          disabled={deleteMutation.isPending}\n                          data-testid={`button-delete-${category.id}`}\n                        >\n                          <Trash2 className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Add/Edit Dialog */}\n      <Dialog open={showAddDialog} onOpenChange={setShowAddDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>\n              {editingCategory ? \"Edit Category\" : \"Add Category\"}\n            </DialogTitle>\n            <DialogDescription>\n              {editingCategory \n                ? \"Update the expense category details\" \n                : \"Create a new expense category for staff to use\"}\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"categoryName\">Category Name</Label>\n              <Input\n                id=\"categoryName\"\n                placeholder=\"e.g., Fuel, Office Supplies, Tools\"\n                value={categoryName}\n                onChange={(e) => setCategoryName(e.target.value)}\n                data-testid=\"input-category-name\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"categoryDescription\">Description (optional)</Label>\n              <Input\n                id=\"categoryDescription\"\n                placeholder=\"Brief description of this category\"\n                value={categoryDescription}\n                onChange={(e) => setCategoryDescription(e.target.value)}\n                data-testid=\"input-category-description\"\n              />\n            </div>\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <Label htmlFor=\"categoryActive\">Active</Label>\n                <p className=\"text-sm text-muted-foreground\">\n                  Only active categories appear in receipt forms\n                </p>\n              </div>\n              <Switch\n                id=\"categoryActive\"\n                checked={categoryActive}\n                onCheckedChange={setCategoryActive}\n                data-testid=\"switch-category-active\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={resetForm}>\n              Cancel\n            </Button>\n            <Button\n              onClick={handleSubmit}\n              disabled={!categoryName.trim() || createMutation.isPending || updateMutation.isPending}\n              data-testid=\"button-save-category\"\n            >\n              {(createMutation.isPending || updateMutation.isPending) && (\n                <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n              )}\n              {editingCategory ? \"Save Changes\" : \"Create Category\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":11059,"size_tokens":null},"client/src/pages/SubmitReceipt.tsx":{"content":"import { useState, useRef } from \"react\";\nimport { useParams } from \"wouter\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { \n  Receipt, \n  Camera, \n  Upload, \n  Loader2, \n  CheckCircle2, \n  AlertCircle,\n  X,\n  DollarSign,\n  Calendar,\n  Store,\n  Tag,\n} from \"lucide-react\";\nimport { format } from \"date-fns\";\n\ninterface ReceiptLinkData {\n  id: string;\n  status: string;\n  expectedAmount: string | null;\n  notes: string | null;\n  expiresAt: string | null;\n  createdAt: string;\n}\n\ninterface ExpenseCategory {\n  id: string;\n  name: string;\n  description: string | null;\n  isActive: boolean;\n}\n\nexport default function SubmitReceipt() {\n  const { token } = useParams<{ token: string }>();\n  const [selectedImage, setSelectedImage] = useState<File | null>(null);\n  const [previewUrl, setPreviewUrl] = useState<string | null>(null);\n  const [amount, setAmount] = useState(\"\");\n  const [merchantName, setMerchantName] = useState(\"\");\n  const [purchaseDate, setPurchaseDate] = useState(format(new Date(), \"yyyy-MM-dd\"));\n  const [notes, setNotes] = useState(\"\");\n  const [categoryId, setCategoryId] = useState(\"\");\n  const [isSubmitted, setIsSubmitted] = useState(false);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  const { data: linkData, isLoading: linkLoading, error: linkError } = useQuery<ReceiptLinkData>({\n    queryKey: [\"/api/receipts/validate\", token],\n    enabled: !!token,\n  });\n\n  const { data: categories = [] } = useQuery<ExpenseCategory[]>({\n    queryKey: [\"/api/expense-categories\"],\n  });\n\n  const activeCategories = categories.filter(c => c.isActive);\n\n  const submitMutation = useMutation({\n    mutationFn: async (formData: FormData) => {\n      const response = await fetch(`/api/receipts/submit/${token}`, {\n        method: \"POST\",\n        body: formData,\n      });\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to submit receipt\");\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      setIsSubmitted(true);\n    },\n  });\n\n  const handleImageSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      setSelectedImage(file);\n      const url = URL.createObjectURL(file);\n      setPreviewUrl(url);\n    }\n  };\n\n  const handleRemoveImage = () => {\n    setSelectedImage(null);\n    if (previewUrl) {\n      URL.revokeObjectURL(previewUrl);\n    }\n    setPreviewUrl(null);\n    if (fileInputRef.current) {\n      fileInputRef.current.value = \"\";\n    }\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!selectedImage) {\n      return;\n    }\n\n    const formData = new FormData();\n    formData.append(\"image\", selectedImage);\n    formData.append(\"amount\", amount);\n    formData.append(\"merchantName\", merchantName);\n    formData.append(\"purchaseDate\", purchaseDate);\n    formData.append(\"notes\", notes);\n    if (categoryId) {\n      formData.append(\"categoryId\", categoryId);\n    }\n\n    submitMutation.mutate(formData);\n  };\n\n  if (linkLoading) {\n    return (\n      <div className=\"min-h-screen bg-muted/30 flex items-center justify-center p-4\">\n        <Card className=\"w-full max-w-md\">\n          <CardContent className=\"pt-6 space-y-4\">\n            <Skeleton className=\"h-8 w-48 mx-auto\" />\n            <Skeleton className=\"h-4 w-64 mx-auto\" />\n            <Skeleton className=\"h-40 w-full\" />\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (linkError || !linkData) {\n    return (\n      <div className=\"min-h-screen bg-muted/30 flex items-center justify-center p-4\">\n        <Card className=\"w-full max-w-md\">\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center py-8\">\n              <AlertCircle className=\"h-12 w-12 mx-auto mb-4 text-destructive\" />\n              <h2 className=\"text-xl font-bold text-destructive\">Invalid or Expired Link</h2>\n              <p className=\"text-muted-foreground mt-2\">\n                This receipt submission link is no longer valid. Please contact your admin for a new link.\n              </p>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (linkData.status !== \"pending\") {\n    return (\n      <div className=\"min-h-screen bg-muted/30 flex items-center justify-center p-4\">\n        <Card className=\"w-full max-w-md\">\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center py-8\">\n              <CheckCircle2 className=\"h-12 w-12 mx-auto mb-4 text-green-600\" />\n              <h2 className=\"text-xl font-bold\">Receipt Already Submitted</h2>\n              <p className=\"text-muted-foreground mt-2\">\n                A receipt has already been submitted for this link.\n              </p>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (isSubmitted) {\n    return (\n      <div className=\"min-h-screen bg-muted/30 flex items-center justify-center p-4\">\n        <Card className=\"w-full max-w-md\">\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center py-8\">\n              <CheckCircle2 className=\"h-16 w-16 mx-auto mb-4 text-green-600\" />\n              <h2 className=\"text-2xl font-bold text-green-600\">Receipt Submitted!</h2>\n              <p className=\"text-muted-foreground mt-2\">\n                Thank you for submitting your receipt. Your admin will review it shortly.\n              </p>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-muted/30 flex items-center justify-center p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"text-center\">\n          <div className=\"mx-auto mb-2 h-12 w-12 rounded-full bg-primary/10 flex items-center justify-center\">\n            <Receipt className=\"h-6 w-6 text-primary\" />\n          </div>\n          <CardTitle className=\"text-xl\">Submit Receipt</CardTitle>\n          <CardDescription>\n            Upload a photo of your receipt\n          </CardDescription>\n        </CardHeader>\n\n        <CardContent>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            {linkData.notes && (\n              <Alert>\n                <Tag className=\"h-4 w-4\" />\n                <AlertTitle>Description</AlertTitle>\n                <AlertDescription>{linkData.notes}</AlertDescription>\n              </Alert>\n            )}\n\n            {linkData.expectedAmount && (\n              <Alert>\n                <DollarSign className=\"h-4 w-4\" />\n                <AlertTitle>Expected Amount</AlertTitle>\n                <AlertDescription>${parseFloat(linkData.expectedAmount).toFixed(2)}</AlertDescription>\n              </Alert>\n            )}\n\n            <div className=\"space-y-2\">\n              <Label>Receipt Photo</Label>\n              <input\n                ref={fileInputRef}\n                type=\"file\"\n                accept=\"image/*\"\n                capture=\"environment\"\n                onChange={handleImageSelect}\n                className=\"hidden\"\n                data-testid=\"input-receipt-image\"\n              />\n              \n              {previewUrl ? (\n                <div className=\"relative\">\n                  <img\n                    src={previewUrl}\n                    alt=\"Receipt preview\"\n                    className=\"w-full h-48 object-cover rounded-lg border\"\n                  />\n                  <Button\n                    type=\"button\"\n                    size=\"icon\"\n                    variant=\"destructive\"\n                    className=\"absolute top-2 right-2\"\n                    onClick={handleRemoveImage}\n                    data-testid=\"button-remove-image\"\n                  >\n                    <X className=\"h-4 w-4\" />\n                  </Button>\n                </div>\n              ) : (\n                <div\n                  onClick={() => fileInputRef.current?.click()}\n                  className=\"border-2 border-dashed rounded-lg p-8 text-center cursor-pointer hover-elevate transition-colors\"\n                  data-testid=\"upload-area\"\n                >\n                  <Camera className=\"h-10 w-10 mx-auto mb-2 text-muted-foreground\" />\n                  <p className=\"font-medium\">Tap to take photo</p>\n                  <p className=\"text-sm text-muted-foreground\">or upload from gallery</p>\n                </div>\n              )}\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"amount\">\n                <DollarSign className=\"h-4 w-4 inline mr-1\" />\n                Amount\n              </Label>\n              <Input\n                id=\"amount\"\n                type=\"number\"\n                step=\"0.01\"\n                placeholder=\"0.00\"\n                value={amount}\n                onChange={(e) => setAmount(e.target.value)}\n                required\n                data-testid=\"input-amount\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"merchantName\">\n                <Store className=\"h-4 w-4 inline mr-1\" />\n                Merchant / Store\n              </Label>\n              <Input\n                id=\"merchantName\"\n                placeholder=\"e.g., Shell, Bunnings\"\n                value={merchantName}\n                onChange={(e) => setMerchantName(e.target.value)}\n                required\n                data-testid=\"input-merchant\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"purchaseDate\">\n                <Calendar className=\"h-4 w-4 inline mr-1\" />\n                Purchase Date\n              </Label>\n              <Input\n                id=\"purchaseDate\"\n                type=\"date\"\n                value={purchaseDate}\n                onChange={(e) => setPurchaseDate(e.target.value)}\n                required\n                data-testid=\"input-date\"\n              />\n            </div>\n\n            {activeCategories.length > 0 && (\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"category\">\n                  <Tag className=\"h-4 w-4 inline mr-1\" />\n                  Category\n                </Label>\n                <Select value={categoryId} onValueChange={setCategoryId}>\n                  <SelectTrigger data-testid=\"select-category\">\n                    <SelectValue placeholder=\"Select a category\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {activeCategories.map((cat) => (\n                      <SelectItem key={cat.id} value={cat.id}>\n                        {cat.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            )}\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"notes\">Notes (optional)</Label>\n              <Textarea\n                id=\"notes\"\n                placeholder=\"Add any notes about this expense...\"\n                value={notes}\n                onChange={(e) => setNotes(e.target.value)}\n                rows={2}\n                data-testid=\"input-notes\"\n              />\n            </div>\n\n            <Button\n              type=\"submit\"\n              className=\"w-full\"\n              disabled={!selectedImage || submitMutation.isPending}\n              data-testid=\"button-submit-receipt\"\n            >\n              {submitMutation.isPending ? (\n                <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n              ) : (\n                <Upload className=\"h-4 w-4 mr-2\" />\n              )}\n              Submit Receipt\n            </Button>\n\n            {submitMutation.isError && (\n              <Alert variant=\"destructive\">\n                <AlertCircle className=\"h-4 w-4\" />\n                <AlertTitle>Error</AlertTitle>\n                <AlertDescription>\n                  {submitMutation.error?.message || \"Failed to submit receipt. Please try again.\"}\n                </AlertDescription>\n              </Alert>\n            )}\n          </form>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":12697,"size_tokens":null},"client/src/components/coaching/CallWidget.tsx":{"content":"import { useState, useEffect, useRef, useCallback } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Phone, PhoneOff, PhoneIncoming, Minimize2, Maximize2, X, Mic, Sparkles, CheckCircle2, Circle, ChevronDown, ChevronUp, Headphones, Delete, AlertCircle } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Card } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { cn } from \"@/lib/utils\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { VoiceCall, CallTranscript, CallChecklistStatus, CallCoachingPrompt, SalesChecklistItem } from \"@shared/schema\";\nimport { Device, Call } from \"@twilio/voice-sdk\";\n\ninterface CallData {\n  call: VoiceCall;\n  transcripts: CallTranscript[];\n  checklistStatus: CallChecklistStatus[];\n  coachingPrompts: CallCoachingPrompt[];\n}\n\ninterface VoiceTokenResponse {\n  configured: boolean;\n  token?: string;\n  identity?: string;\n  message?: string;\n}\n\nconst DIALPAD_KEYS = [\n  [\"1\", \"2\", \"3\"],\n  [\"4\", \"5\", \"6\"],\n  [\"7\", \"8\", \"9\"],\n  [\"*\", \"0\", \"#\"],\n];\n\n// Format phone number to E.164 for Twilio\nfunction formatPhoneNumberE164(phoneNumber: string): string {\n  let cleaned = phoneNumber.replace(/[^\\d+]/g, '');\n  if (cleaned.startsWith('+')) return cleaned;\n  if (cleaned.startsWith('0')) {\n    cleaned = '+61' + cleaned.substring(1);\n  } else if (cleaned.startsWith('61')) {\n    cleaned = '+' + cleaned;\n  } else if (cleaned.length === 9) {\n    cleaned = '+61' + cleaned;\n  } else {\n    cleaned = '+' + cleaned;\n  }\n  return cleaned;\n}\n\nexport function CallWidget() {\n  const [isExpanded, setIsExpanded] = useState(false);\n  const [isMinimized, setIsMinimized] = useState(true);\n  const [activeCallId, setActiveCallId] = useState<string | null>(null);\n  const [showChecklist, setShowChecklist] = useState(true);\n  const [showDialpad, setShowDialpad] = useState(true);\n  const [phoneNumber, setPhoneNumber] = useState(\"\");\n  const [voiceSdkConfigured, setVoiceSdkConfigured] = useState<boolean | null>(null);\n  const [sdkStatus, setSdkStatus] = useState<string>(\"initializing\");\n  const [activeConnection, setActiveConnection] = useState<Call | null>(null);\n  const transcriptEndRef = useRef<HTMLDivElement>(null);\n  const deviceRef = useRef<Device | null>(null);\n  const { toast } = useToast();\n\n  const { data: activeCalls = [] } = useQuery<VoiceCall[]>({\n    queryKey: [\"/api/voice-calls/active\"],\n    refetchInterval: 3000,\n  });\n\n  const { data: checklistItems = [] } = useQuery<SalesChecklistItem[]>({\n    queryKey: [\"/api/sales-checklist-items/active\"],\n  });\n\n  const { data: callData } = useQuery<CallData>({\n    queryKey: [\"/api/voice-calls\", activeCallId],\n    enabled: !!activeCallId,\n    refetchInterval: activeCallId ? 2000 : false,\n  });\n\n  const acknowledgeMutation = useMutation({\n    mutationFn: async (promptId: string) => {\n      await apiRequest(\"POST\", `/api/coaching-prompts/${promptId}/acknowledge`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/voice-calls\", activeCallId] });\n    },\n  });\n\n  // Initialize Twilio Voice SDK\n  const initializeVoiceSdk = useCallback(async () => {\n    try {\n      setSdkStatus(\"fetching token...\");\n      const response = await fetch(\"/api/voice/token\", { credentials: \"include\" });\n      const data: VoiceTokenResponse = await response.json();\n      \n      if (!data.configured) {\n        setVoiceSdkConfigured(false);\n        setSdkStatus(\"not configured\");\n        console.log(\"Voice SDK not configured:\", data.message);\n        return;\n      }\n      \n      if (!data.token) {\n        setSdkStatus(\"no token\");\n        return;\n      }\n      \n      setVoiceSdkConfigured(true);\n      setSdkStatus(\"initializing device...\");\n      \n      // Create and register the Device\n      const device = new Device(data.token, {\n        logLevel: 1,\n        codecPreferences: [Call.Codec.Opus, Call.Codec.PCMU],\n      });\n      \n      device.on(\"registered\", () => {\n        setSdkStatus(\"ready\");\n        console.log(\"Twilio Device registered and ready\");\n      });\n      \n      device.on(\"error\", (error) => {\n        console.error(\"Twilio Device error:\", error);\n        setSdkStatus(\"error\");\n        toast({ title: \"Voice SDK error\", description: error.message, variant: \"destructive\" });\n      });\n      \n      device.on(\"incoming\", (call) => {\n        console.log(\"Incoming call from:\", call.parameters.From);\n        setActiveConnection(call);\n        setIsMinimized(false);\n        \n        call.on(\"accept\", () => {\n          console.log(\"Call accepted\");\n          queryClient.invalidateQueries({ queryKey: [\"/api/voice-calls/active\"] });\n        });\n        \n        call.on(\"disconnect\", () => {\n          console.log(\"Call disconnected\");\n          setActiveConnection(null);\n          queryClient.invalidateQueries({ queryKey: [\"/api/voice-calls/active\"] });\n        });\n      });\n      \n      device.on(\"tokenWillExpire\", async () => {\n        console.log(\"Token will expire, refreshing...\");\n        const refreshResponse = await fetch(\"/api/voice/token\", { credentials: \"include\" });\n        const refreshData: VoiceTokenResponse = await refreshResponse.json();\n        if (refreshData.token) {\n          device.updateToken(refreshData.token);\n        }\n      });\n      \n      await device.register();\n      deviceRef.current = device;\n      \n    } catch (error) {\n      console.error(\"Failed to initialize Voice SDK:\", error);\n      setSdkStatus(\"error\");\n      setVoiceSdkConfigured(false);\n    }\n  }, [toast]);\n  \n  useEffect(() => {\n    initializeVoiceSdk();\n    \n    return () => {\n      if (deviceRef.current) {\n        deviceRef.current.destroy();\n        deviceRef.current = null;\n      }\n    };\n  }, [initializeVoiceSdk]);\n\n  const hangupMutation = useMutation({\n    mutationFn: async (callId: string) => {\n      await apiRequest(\"POST\", `/api/voice-calls/${callId}/hangup`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/voice-calls/active\"] });\n      toast({ title: \"Call ended\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Hangup failed\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const handleDialpadPress = (key: string) => {\n    setPhoneNumber((prev) => prev + key);\n  };\n\n  const handleBackspace = () => {\n    setPhoneNumber((prev) => prev.slice(0, -1));\n  };\n\n  const handleMakeCall = async () => {\n    if (phoneNumber.length < 8) {\n      toast({ title: \"Invalid number\", description: \"Please enter a valid phone number\", variant: \"destructive\" });\n      return;\n    }\n    \n    const formattedNumber = formatPhoneNumberE164(phoneNumber);\n    \n    // Use Voice SDK if available\n    if (deviceRef.current && voiceSdkConfigured) {\n      try {\n        const call = await deviceRef.current.connect({\n          params: {\n            To: formattedNumber,\n          },\n        });\n        \n        setActiveConnection(call);\n        setPhoneNumber(\"\");\n        toast({ title: \"Calling...\", description: `Dialing ${formattedNumber}` });\n        \n        call.on(\"accept\", () => {\n          console.log(\"Outbound call connected\");\n          queryClient.invalidateQueries({ queryKey: [\"/api/voice-calls/active\"] });\n        });\n        \n        call.on(\"disconnect\", () => {\n          console.log(\"Outbound call ended\");\n          setActiveConnection(null);\n          queryClient.invalidateQueries({ queryKey: [\"/api/voice-calls/active\"] });\n        });\n        \n        call.on(\"error\", (error) => {\n          console.error(\"Call error:\", error);\n          toast({ title: \"Call error\", description: error.message, variant: \"destructive\" });\n          setActiveConnection(null);\n        });\n        \n      } catch (error: any) {\n        console.error(\"Failed to make call:\", error);\n        toast({ title: \"Call failed\", description: error.message, variant: \"destructive\" });\n      }\n    } else {\n      // Fallback to API call (won't work for browser audio but logs the call)\n      toast({ \n        title: \"Voice SDK not ready\", \n        description: \"Browser calling requires additional Twilio configuration\", \n        variant: \"destructive\" \n      });\n    }\n  };\n\n  const handleHangup = () => {\n    // Hangup via Voice SDK if we have an active connection\n    if (activeConnection) {\n      activeConnection.disconnect();\n      setActiveConnection(null);\n    }\n    \n    // Also call the API to ensure the call is ended server-side\n    if (activeCallId) {\n      hangupMutation.mutate(activeCallId);\n    }\n  };\n\n  useEffect(() => {\n    if (activeCalls.length > 0) {\n      const inProgress = activeCalls.find(c => c.status === \"in_progress\");\n      const ringing = activeCalls.find(c => c.status === \"ringing\");\n      const newActiveId = inProgress?.id || ringing?.id || activeCalls[0].id;\n      setActiveCallId(newActiveId);\n      if (ringing || inProgress) {\n        setIsMinimized(false);\n      }\n    } else {\n      setActiveCallId(null);\n    }\n  }, [activeCalls]);\n\n  useEffect(() => {\n    if (transcriptEndRef.current) {\n      transcriptEndRef.current.scrollIntoView({ behavior: \"smooth\" });\n    }\n  }, [callData?.transcripts]);\n\n  const activeCall = callData?.call || activeCalls.find(c => c.id === activeCallId);\n  const transcripts = callData?.transcripts || [];\n  const checklistStatus = callData?.checklistStatus || [];\n  const coachingPrompts = callData?.coachingPrompts || [];\n\n  const unacknowledgedPrompts = coachingPrompts.filter(p => !p.wasAcknowledged);\n  const coveredCount = checklistStatus.filter(s => s.isCovered).length;\n  const totalChecklist = checklistItems.length;\n  const hasActiveCall = !!activeCall;\n\n  if (isMinimized) {\n    return (\n      <div \n        className=\"fixed bottom-4 right-4 z-50\"\n        data-testid=\"call-widget-minimized\"\n      >\n        <Button \n          size=\"lg\" \n          className={cn(\n            \"rounded-full h-14 w-14 shadow-lg\",\n            activeCall?.status === \"ringing\" && \"animate-pulse bg-green-600 hover:bg-green-700\",\n            activeCall?.status === \"in_progress\" && \"bg-green-600 hover:bg-green-700\"\n          )}\n          onClick={() => setIsMinimized(false)}\n          data-testid=\"button-open-widget\"\n        >\n          {activeCall?.status === \"ringing\" ? (\n            <PhoneIncoming className=\"h-6 w-6\" />\n          ) : activeCall?.status === \"in_progress\" ? (\n            <Phone className=\"h-6 w-6\" />\n          ) : (\n            <Headphones className=\"h-6 w-6\" />\n          )}\n        </Button>\n        {unacknowledgedPrompts.length > 0 && (\n          <Badge \n            variant=\"destructive\" \n            className=\"absolute -top-1 -right-1 h-5 w-5 p-0 flex items-center justify-center text-xs\"\n          >\n            {unacknowledgedPrompts.length}\n          </Badge>\n        )}\n        {hasActiveCall && (\n          <div className=\"absolute -top-1 -left-1 w-3 h-3 bg-green-500 rounded-full animate-pulse\" />\n        )}\n      </div>\n    );\n  }\n\n  return (\n    <Card \n      className={cn(\n        \"fixed bottom-4 right-4 z-50 shadow-2xl border-2 transition-all duration-300\",\n        isExpanded ? \"w-[500px] h-[700px]\" : \"w-[380px] h-[520px]\",\n        activeCall?.status === \"ringing\" && \"border-green-500\"\n      )}\n      data-testid=\"call-widget\"\n    >\n      <div className=\"flex flex-col h-full\">\n        <div className=\"flex items-center justify-between p-3 border-b bg-muted/50\">\n          <div className=\"flex items-center gap-2\">\n            {activeCall?.status === \"in_progress\" && (\n              <div className=\"w-2 h-2 bg-green-500 rounded-full animate-pulse\" />\n            )}\n            {activeCall?.status === \"ringing\" && (\n              <PhoneIncoming className=\"w-4 h-4 text-green-600 animate-bounce\" />\n            )}\n            {!activeCall && (\n              <Headphones className=\"w-4 h-4 text-muted-foreground\" />\n            )}\n            <span className=\"font-medium text-sm\">\n              {activeCall \n                ? `${activeCall.direction === \"inbound\" ? \"Incoming\" : \"Outgoing\"} Call`\n                : \"Call Coach\"\n              }\n            </span>\n            {activeCall && (\n              <span className=\"text-xs text-muted-foreground\">\n                {activeCall.direction === \"inbound\" ? activeCall.fromNumber : activeCall.toNumber}\n              </span>\n            )}\n          </div>\n          <div className=\"flex items-center gap-1\">\n            <Button \n              size=\"icon\" \n              variant=\"ghost\" \n              className=\"h-7 w-7\"\n              onClick={() => setIsExpanded(!isExpanded)}\n              data-testid=\"button-expand-widget\"\n            >\n              {isExpanded ? <Minimize2 className=\"h-3.5 w-3.5\" /> : <Maximize2 className=\"h-3.5 w-3.5\" />}\n            </Button>\n            <Button \n              size=\"icon\" \n              variant=\"ghost\" \n              className=\"h-7 w-7\"\n              onClick={() => setIsMinimized(true)}\n              data-testid=\"button-minimize-widget\"\n            >\n              <ChevronDown className=\"h-3.5 w-3.5\" />\n            </Button>\n          </div>\n        </div>\n\n        {unacknowledgedPrompts.length > 0 && (\n          <div className=\"p-2 bg-orange-50 dark:bg-orange-950 border-b border-orange-200 dark:border-orange-800\">\n            {unacknowledgedPrompts.slice(0, 2).map((prompt) => (\n              <div \n                key={prompt.id} \n                className=\"flex items-start gap-2 p-2 rounded-md bg-white dark:bg-background mb-1 last:mb-0\"\n              >\n                <Sparkles className=\"w-4 h-4 text-orange-500 mt-0.5 flex-shrink-0\" />\n                <div className=\"flex-1 min-w-0\">\n                  <p className=\"text-sm font-medium\">{prompt.message}</p>\n                  {prompt.triggerText && (\n                    <p className=\"text-xs text-muted-foreground truncate\">\n                      Triggered by: \"{prompt.triggerText}\"\n                    </p>\n                  )}\n                </div>\n                <Button \n                  size=\"icon\" \n                  variant=\"ghost\" \n                  className=\"h-6 w-6 flex-shrink-0\"\n                  onClick={() => acknowledgeMutation.mutate(prompt.id)}\n                  data-testid={`acknowledge-prompt-${prompt.id}`}\n                >\n                  <X className=\"h-3 w-3\" />\n                </Button>\n              </div>\n            ))}\n          </div>\n        )}\n\n        <div className=\"flex-1 flex flex-col min-h-0\">\n          <div \n            className=\"flex items-center justify-between px-3 py-2 border-b cursor-pointer hover-elevate\"\n            onClick={() => setShowChecklist(!showChecklist)}\n          >\n            <div className=\"flex items-center gap-2\">\n              <span className=\"text-xs font-medium\">Sales Checklist</span>\n              <Badge variant=\"secondary\" className=\"text-xs\">\n                {coveredCount}/{totalChecklist}\n              </Badge>\n            </div>\n            {showChecklist ? <ChevronUp className=\"h-3 w-3\" /> : <ChevronDown className=\"h-3 w-3\" />}\n          </div>\n\n          {showChecklist && (\n            <div className=\"px-3 py-2 border-b bg-muted/30 max-h-32 overflow-auto\">\n              <div className=\"grid grid-cols-2 gap-1\">\n                {checklistItems.map((item) => {\n                  const status = checklistStatus.find(s => s.checklistItemId === item.id);\n                  return (\n                    <div \n                      key={item.id} \n                      className=\"flex items-center gap-1.5 text-xs\"\n                      data-testid={`checklist-item-${item.id}`}\n                    >\n                      {status?.isCovered ? (\n                        <CheckCircle2 className=\"h-3 w-3 text-green-600 flex-shrink-0\" />\n                      ) : (\n                        <Circle className={cn(\n                          \"h-3 w-3 flex-shrink-0\",\n                          item.isRequired ? \"text-orange-500\" : \"text-muted-foreground\"\n                        )} />\n                      )}\n                      <span className={cn(\n                        \"truncate\",\n                        status?.isCovered && \"line-through text-muted-foreground\"\n                      )}>\n                        {item.question}\n                      </span>\n                    </div>\n                  );\n                })}\n              </div>\n            </div>\n          )}\n\n          <ScrollArea className=\"flex-1 px-3 py-2\">\n            <div className=\"space-y-2\">\n              {!activeCall ? (\n                <div className=\"text-center text-muted-foreground text-sm py-8\">\n                  <Phone className=\"h-8 w-8 mx-auto mb-2 opacity-30\" />\n                  <p>No active call</p>\n                  <p className=\"text-xs\">Start a call to see live transcription</p>\n                </div>\n              ) : transcripts.length === 0 ? (\n                <div className=\"text-center text-muted-foreground text-sm py-8\">\n                  <Mic className=\"h-8 w-8 mx-auto mb-2 opacity-30\" />\n                  <p>Waiting for conversation...</p>\n                  <p className=\"text-xs\">Transcription will appear here</p>\n                </div>\n              ) : (\n                transcripts.map((transcript) => (\n                  <div \n                    key={transcript.id}\n                    className={cn(\n                      \"p-2 rounded-lg text-sm\",\n                      transcript.speaker === \"staff\" \n                        ? \"bg-primary/10 ml-4\" \n                        : \"bg-muted mr-4\"\n                    )}\n                    data-testid={`transcript-${transcript.id}`}\n                  >\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <span className=\"text-xs font-medium capitalize text-muted-foreground\">\n                        {transcript.speaker}\n                      </span>\n                    </div>\n                    <p>{transcript.text}</p>\n                  </div>\n                ))\n              )}\n              <div ref={transcriptEndRef} />\n            </div>\n          </ScrollArea>\n        </div>\n\n        <div className=\"border-t bg-muted/50\">\n          {!activeCall && showDialpad && (\n            <div className=\"p-3 space-y-3\">\n              <div className=\"flex items-center gap-2\">\n                <Input\n                  value={phoneNumber}\n                  onChange={(e) => setPhoneNumber(e.target.value)}\n                  placeholder=\"Enter phone number\"\n                  className=\"text-center text-lg font-mono\"\n                  data-testid=\"input-phone-number\"\n                />\n                <Button\n                  size=\"icon\"\n                  variant=\"ghost\"\n                  onClick={handleBackspace}\n                  disabled={phoneNumber.length === 0}\n                  data-testid=\"button-backspace\"\n                >\n                  <Delete className=\"h-4 w-4\" />\n                </Button>\n              </div>\n              <div className=\"grid grid-cols-3 gap-2\">\n                {DIALPAD_KEYS.flat().map((key) => (\n                  <Button\n                    key={key}\n                    variant=\"outline\"\n                    className=\"h-10 text-lg font-medium\"\n                    onClick={() => handleDialpadPress(key)}\n                    data-testid={`dialpad-${key}`}\n                  >\n                    {key}\n                  </Button>\n                ))}\n              </div>\n              <Button\n                className=\"w-full bg-green-600 hover:bg-green-700\"\n                onClick={handleMakeCall}\n                disabled={phoneNumber.length < 8 || !!activeConnection}\n                data-testid=\"button-make-call\"\n              >\n                <Phone className=\"h-4 w-4 mr-2\" />\n                {activeConnection ? \"Calling...\" : voiceSdkConfigured === false ? \"SDK Not Configured\" : \"Call\"}\n              </Button>\n              {voiceSdkConfigured === false && (\n                <p className=\"text-xs text-muted-foreground text-center mt-1 flex items-center justify-center gap-1\">\n                  <AlertCircle className=\"h-3 w-3\" />\n                  Browser calling needs Twilio API Key setup\n                </p>\n              )}\n            </div>\n          )}\n\n          {!activeCall && !showDialpad && (\n            <div className=\"p-3 flex items-center justify-center\">\n              <Button\n                variant=\"outline\"\n                onClick={() => setShowDialpad(true)}\n                data-testid=\"button-show-dialpad\"\n              >\n                <Phone className=\"h-4 w-4 mr-2\" />\n                Show Dialpad\n              </Button>\n            </div>\n          )}\n\n          {activeCall?.status === \"ringing\" && activeCall.direction === \"inbound\" && (\n            <div className=\"p-3 flex items-center justify-center gap-3\">\n              <Button \n                size=\"lg\" \n                className=\"bg-green-600 hover:bg-green-700 rounded-full\"\n                data-testid=\"button-answer-call\"\n              >\n                <Phone className=\"h-5 w-5 mr-2\" />\n                Answer\n              </Button>\n              <Button \n                size=\"lg\" \n                variant=\"destructive\" \n                className=\"rounded-full\"\n                onClick={handleHangup}\n                disabled={hangupMutation.isPending}\n                data-testid=\"button-decline-call\"\n              >\n                <PhoneOff className=\"h-5 w-5\" />\n              </Button>\n            </div>\n          )}\n\n          {activeCall?.status === \"in_progress\" && (\n            <div className=\"p-3 flex items-center justify-center\">\n              <Button \n                size=\"lg\" \n                variant=\"destructive\" \n                className=\"rounded-full\"\n                onClick={handleHangup}\n                disabled={hangupMutation.isPending}\n                data-testid=\"button-end-call\"\n              >\n                <PhoneOff className=\"h-5 w-5 mr-2\" />\n                {hangupMutation.isPending ? \"Ending...\" : \"End Call\"}\n              </Button>\n            </div>\n          )}\n\n          {activeCall?.status === \"ringing\" && activeCall.direction === \"outbound\" && (\n            <div className=\"p-3 flex flex-col items-center justify-center gap-2\">\n              <span className=\"text-sm text-muted-foreground animate-pulse\">Ringing...</span>\n              <Button \n                size=\"lg\" \n                variant=\"destructive\" \n                className=\"rounded-full\"\n                onClick={handleHangup}\n                disabled={hangupMutation.isPending}\n                data-testid=\"button-cancel-call\"\n              >\n                <PhoneOff className=\"h-5 w-5 mr-2\" />\n                Cancel\n              </Button>\n            </div>\n          )}\n        </div>\n      </div>\n    </Card>\n  );\n}\n","path":null,"size_bytes":22965,"size_tokens":null},"server/deepgram.ts":{"content":"import WebSocket, { WebSocketServer } from \"ws\";\nimport { storage } from \"./storage\";\nimport { processTranscriptUpdate } from \"./coaching\";\nimport type { Server as HttpServer } from \"http\";\n\ninterface DeepgramConfig {\n  encoding?: string;\n  sample_rate?: number;\n  channels?: number;\n  model?: string;\n  language?: string;\n  punctuate?: boolean;\n  interim_results?: boolean;\n  diarize?: boolean;\n  smart_format?: boolean;\n}\n\n// Singleton WebSocket server for media streams\nlet mediaStreamWss: WebSocketServer | null = null;\n\ninterface DeepgramAlternative {\n  transcript: string;\n  confidence: number;\n  words?: Array<{\n    word: string;\n    start: number;\n    end: number;\n    confidence: number;\n    speaker?: number;\n  }>;\n}\n\ninterface DeepgramChannel {\n  alternatives: DeepgramAlternative[];\n}\n\ninterface DeepgramMessage {\n  type: string;\n  channel?: DeepgramChannel;\n  is_final?: boolean;\n  speech_final?: boolean;\n  start?: number;\n  duration?: number;\n  metadata?: {\n    request_id: string;\n    model_uuid: string;\n  };\n}\n\nexport class DeepgramTranscriber {\n  private ws: WebSocket | null = null;\n  private callId: string;\n  private isConnected: boolean = false;\n  private pendingAudio: Buffer[] = [];\n  private lastTranscriptTime: number = 0;\n  private analysisDebounceTimer: NodeJS.Timeout | null = null;\n\n  constructor(callId: string) {\n    this.callId = callId;\n  }\n\n  async connect(config: DeepgramConfig = {}, retryCount = 0): Promise<void> {\n    const apiKey = process.env.DEEPGRAM_API_KEY;\n    if (!apiKey) {\n      throw new Error(\"DEEPGRAM_API_KEY environment variable not set\");\n    }\n\n    const maxRetries = 3;\n    const baseDelay = 1000;\n\n    const defaultConfig: DeepgramConfig = {\n      encoding: \"mulaw\",\n      sample_rate: 8000,\n      channels: 1,\n      model: \"nova-2\",\n      language: \"en-AU\",\n      punctuate: true,\n      interim_results: true,\n      diarize: true,\n      smart_format: true,\n    };\n\n    const finalConfig = { ...defaultConfig, ...config };\n    \n    const queryParams = new URLSearchParams();\n    Object.entries(finalConfig).forEach(([key, value]) => {\n      if (value !== undefined) {\n        queryParams.append(key, String(value));\n      }\n    });\n\n    const url = `wss://api.deepgram.com/v1/listen?${queryParams.toString()}`;\n\n    return new Promise((resolve, reject) => {\n      this.ws = new WebSocket(url, {\n        headers: {\n          Authorization: `Token ${apiKey}`,\n        },\n      });\n\n      this.ws.on(\"open\", () => {\n        console.log(`Deepgram connected for call ${this.callId}`);\n        this.isConnected = true;\n        \n        // Send any pending audio\n        while (this.pendingAudio.length > 0) {\n          const audio = this.pendingAudio.shift();\n          if (audio && this.ws?.readyState === WebSocket.OPEN) {\n            this.ws.send(audio);\n          }\n        }\n        \n        resolve();\n      });\n\n      this.ws.on(\"message\", async (data: WebSocket.Data) => {\n        try {\n          const message: DeepgramMessage = JSON.parse(data.toString());\n          await this.handleMessage(message);\n        } catch (error) {\n          console.error(\"Error parsing Deepgram message:\", error);\n        }\n      });\n\n      this.ws.on(\"error\", async (error) => {\n        console.error(`Deepgram error for call ${this.callId}:`, error);\n        \n        // Retry with exponential backoff\n        if (retryCount < maxRetries) {\n          const delay = baseDelay * Math.pow(2, retryCount);\n          console.log(`Retrying Deepgram connection in ${delay}ms (attempt ${retryCount + 1}/${maxRetries})`);\n          \n          setTimeout(async () => {\n            try {\n              await this.connect(config, retryCount + 1);\n              resolve();\n            } catch (retryError) {\n              reject(retryError);\n            }\n          }, delay);\n        } else {\n          console.error(`Deepgram connection failed after ${maxRetries} retries for call ${this.callId}`);\n          reject(error);\n        }\n      });\n\n      this.ws.on(\"close\", (code, reason) => {\n        console.log(`Deepgram closed for call ${this.callId}: ${code} - ${reason}`);\n        this.isConnected = false;\n      });\n    });\n  }\n\n  sendAudio(audioData: Buffer): void {\n    if (this.isConnected && this.ws?.readyState === WebSocket.OPEN) {\n      this.ws.send(audioData);\n    } else {\n      // Buffer audio until connected\n      this.pendingAudio.push(audioData);\n    }\n  }\n\n  private async handleMessage(message: DeepgramMessage): Promise<void> {\n    if (message.type === \"Results\" && message.channel) {\n      const alternative = message.channel.alternatives[0];\n      const transcript = alternative?.transcript;\n      \n      if (transcript && transcript.trim().length > 0) {\n        const isFinal = message.is_final;\n        \n        // Determine speaker from diarization\n        const words = alternative?.words || [];\n        const speakerNum = words[0]?.speaker ?? 0;\n        // Speaker 0 is typically the first speaker (staff), Speaker 1 is second (customer)\n        const speaker = speakerNum === 0 ? \"staff\" : \"customer\";\n\n        // Only save final transcripts to database\n        if (isFinal) {\n          await storage.createCallTranscript({\n            callId: this.callId,\n            speaker,\n            text: transcript,\n            confidence: alternative?.confidence?.toString(),\n            startTime: message.start?.toString(),\n            endTime: message.start !== undefined && message.duration !== undefined \n              ? (message.start + message.duration).toString()\n              : undefined,\n          });\n\n          // Debounce AI analysis to avoid too many API calls\n          this.lastTranscriptTime = Date.now();\n          this.scheduleAnalysis();\n        }\n      }\n    }\n  }\n\n  private scheduleAnalysis(): void {\n    // Clear existing timer\n    if (this.analysisDebounceTimer) {\n      clearTimeout(this.analysisDebounceTimer);\n    }\n\n    // Wait 3 seconds of silence before running AI analysis\n    this.analysisDebounceTimer = setTimeout(async () => {\n      const timeSinceLastTranscript = Date.now() - this.lastTranscriptTime;\n      if (timeSinceLastTranscript >= 2900) {\n        try {\n          await processTranscriptUpdate(this.callId);\n        } catch (error) {\n          console.error(\"Error running AI analysis:\", error);\n        }\n      }\n    }, 3000);\n  }\n\n  async close(): Promise<void> {\n    if (this.analysisDebounceTimer) {\n      clearTimeout(this.analysisDebounceTimer);\n    }\n\n    if (this.ws) {\n      // Send close message to Deepgram\n      if (this.ws.readyState === WebSocket.OPEN) {\n        this.ws.send(JSON.stringify({ type: \"CloseStream\" }));\n      }\n      \n      this.ws.close();\n      this.ws = null;\n      this.isConnected = false;\n    }\n\n    // Run final analysis\n    try {\n      await processTranscriptUpdate(this.callId);\n    } catch (error) {\n      console.error(\"Error running final AI analysis:\", error);\n    }\n  }\n}\n\n// Active transcriber sessions by call SID\nconst activeTranscribers = new Map<string, DeepgramTranscriber>();\n\nexport function getTranscriber(callSid: string): DeepgramTranscriber | undefined {\n  return activeTranscribers.get(callSid);\n}\n\nexport async function startTranscriber(callId: string, callSid: string): Promise<DeepgramTranscriber> {\n  const transcriber = new DeepgramTranscriber(callId);\n  await transcriber.connect();\n  activeTranscribers.set(callSid, transcriber);\n  return transcriber;\n}\n\nexport async function stopTranscriber(callSid: string): Promise<void> {\n  const transcriber = activeTranscribers.get(callSid);\n  if (transcriber) {\n    await transcriber.close();\n    activeTranscribers.delete(callSid);\n  }\n}\n\n// Initialize singleton WebSocket server for Twilio Media Streams\nexport function initializeMediaStreamServer(httpServer: HttpServer): void {\n  if (mediaStreamWss) {\n    console.log(\"Media stream WebSocket server already initialized\");\n    return;\n  }\n\n  mediaStreamWss = new WebSocketServer({ noServer: true });\n  console.log(\"Media stream WebSocket server initialized\");\n\n  httpServer.on(\"upgrade\", (request, socket, head) => {\n    const url = new URL(request.url || \"\", `http://${request.headers.host}`);\n    \n    if (url.pathname === \"/api/twilio/media-stream\") {\n      const callSid = url.searchParams.get(\"callSid\");\n      const callId = url.searchParams.get(\"callId\");\n\n      if (!callSid || !callId) {\n        console.error(\"Missing callSid or callId in media stream request\");\n        socket.destroy();\n        return;\n      }\n\n      mediaStreamWss!.handleUpgrade(request, socket, head, (ws) => {\n        console.log(`Media stream WebSocket connected for call ${callSid}`);\n        handleTwilioMediaStream(ws, callSid, callId);\n      });\n    }\n  });\n}\n\n// Handle Twilio Media Stream WebSocket connection\nexport function handleTwilioMediaStream(ws: WebSocket, callSid: string, callId: string): void {\n  let transcriber: DeepgramTranscriber | null = null;\n  let streamSid: string | null = null;\n  let transcriptionFailed = false;\n\n  ws.on(\"message\", async (data: WebSocket.Data) => {\n    try {\n      const message = JSON.parse(data.toString());\n\n      switch (message.event) {\n        case \"connected\":\n          console.log(`Twilio Media Stream connected for call ${callSid}`);\n          break;\n\n        case \"start\":\n          streamSid = message.start.streamSid;\n          console.log(`Twilio Media Stream started: ${streamSid}`);\n          \n          // Start Deepgram transcriber with fallback handling\n          try {\n            transcriber = await startTranscriber(callId, callSid);\n          } catch (error) {\n            console.error(\"Failed to start Deepgram transcriber:\", error);\n            transcriptionFailed = true;\n            // Continue without transcription - call still works, just no AI coaching\n          }\n          break;\n\n        case \"media\":\n          // Forward audio to Deepgram (only if transcription is active)\n          if (!transcriptionFailed && transcriber && message.media?.payload) {\n            const audioBuffer = Buffer.from(message.media.payload, \"base64\");\n            transcriber.sendAudio(audioBuffer);\n          }\n          break;\n\n        case \"stop\":\n          console.log(`Twilio Media Stream stopped for call ${callSid}`);\n          if (transcriber) {\n            try {\n              await transcriber.close();\n            } catch (error) {\n              console.error(\"Error closing transcriber:\", error);\n            }\n            activeTranscribers.delete(callSid);\n          }\n          break;\n\n        default:\n          // Ignore other events\n          break;\n      }\n    } catch (error) {\n      console.error(\"Error handling Twilio media stream message:\", error);\n    }\n  });\n\n  ws.on(\"close\", async () => {\n    console.log(`Twilio Media Stream WebSocket closed for call ${callSid}`);\n    await stopTranscriber(callSid);\n  });\n\n  ws.on(\"error\", (error) => {\n    console.error(`Twilio Media Stream WebSocket error for call ${callSid}:`, error);\n  });\n}\n","path":null,"size_bytes":10964,"size_tokens":null},"client/src/pages/StaffManagement.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Users, CreditCard, Phone, Edit, Shield } from \"lucide-react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport type { User } from \"@shared/schema\";\n\nexport default function StaffManagement() {\n  const { toast } = useToast();\n  const [editingUser, setEditingUser] = useState<User | null>(null);\n  const [cardNumber, setCardNumber] = useState(\"\");\n  const [phone, setPhone] = useState(\"\");\n  const [positionTitle, setPositionTitle] = useState(\"\");\n  const [isActive, setIsActive] = useState(true);\n\n  const { data: users = [], isLoading } = useQuery<User[]>({\n    queryKey: [\"/api/users\"],\n  });\n\n  const updateUserMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<User> }) => {\n      const res = await apiRequest(\"PATCH\", `/api/users/${id}`, data);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      toast({ title: \"Staff Updated\", description: \"Staff member details have been updated.\" });\n      setEditingUser(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Update Failed\",\n        description: error.message || \"Failed to update staff member.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const openEditDialog = (staffMember: User) => {\n    setEditingUser(staffMember);\n    setCardNumber(staffMember.bankCardNumber || \"\");\n    setPhone(staffMember.phone || \"\");\n    setPositionTitle(staffMember.positionTitle || \"\");\n    setIsActive(staffMember.isActive);\n  };\n\n  const handleSave = () => {\n    if (!editingUser) return;\n    updateUserMutation.mutate({\n      id: editingUser.id,\n      data: {\n        bankCardNumber: cardNumber || null,\n        phone: phone || null,\n        positionTitle: positionTitle || null,\n        isActive,\n      },\n    });\n  };\n\n  const getRoleBadgeVariant = (role: string) => {\n    switch (role) {\n      case \"admin\": return \"destructive\";\n      case \"sales\": return \"default\";\n      case \"scheduler\": return \"secondary\";\n      case \"production_manager\": return \"outline\";\n      case \"warehouse\": return \"secondary\";\n      case \"installer\": return \"outline\";\n      default: return \"secondary\";\n    }\n  };\n\n  const formatRole = (role: string) => {\n    return role.replace(/_/g, \" \").replace(/\\b\\w/g, l => l.toUpperCase());\n  };\n\n  const staffMembers = users.filter(u => u.role !== \"trade_client\");\n\n  if (isLoading) {\n    return (\n      <div className=\"flex-1 p-6 space-y-6\">\n        <Skeleton className=\"h-8 w-64\" data-testid=\"skeleton-heading\" />\n        <Skeleton className=\"h-[400px] w-full\" data-testid=\"skeleton-table\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex-1 p-6 space-y-6\">\n      <div className=\"flex items-center justify-between gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold flex items-center gap-2\" data-testid=\"heading-staff-management\">\n            <Users className=\"h-6 w-6\" />\n            Staff Management\n          </h1>\n          <p className=\"text-muted-foreground mt-1\" data-testid=\"text-description\">\n            Manage staff details and assign bank card numbers for expense tracking\n          </p>\n        </div>\n      </div>\n\n      <Card data-testid=\"card-staff-list\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Shield className=\"h-5 w-5\" />\n            Staff Members\n          </CardTitle>\n          <CardDescription>\n            Assign card numbers to staff for automatic transaction allocation\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Table data-testid=\"table-staff\">\n            <TableHeader>\n              <TableRow>\n                <TableHead>Name</TableHead>\n                <TableHead>Role</TableHead>\n                <TableHead>Position</TableHead>\n                <TableHead>Email</TableHead>\n                <TableHead>Phone</TableHead>\n                <TableHead>Card Number (Last 6)</TableHead>\n                <TableHead>Status</TableHead>\n                <TableHead className=\"text-right\">Actions</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {staffMembers.map((staffMember) => (\n                <TableRow key={staffMember.id} data-testid={`row-staff-${staffMember.id}`}>\n                  <TableCell className=\"font-medium\" data-testid={`text-name-${staffMember.id}`}>\n                    {staffMember.firstName} {staffMember.lastName}\n                  </TableCell>\n                  <TableCell>\n                    <Badge variant={getRoleBadgeVariant(staffMember.role)} data-testid={`badge-role-${staffMember.id}`}>\n                      {formatRole(staffMember.role)}\n                    </Badge>\n                  </TableCell>\n                  <TableCell className=\"text-muted-foreground\" data-testid={`text-position-${staffMember.id}`}>\n                    {staffMember.positionTitle || \"-\"}\n                  </TableCell>\n                  <TableCell className=\"text-muted-foreground\" data-testid={`text-email-${staffMember.id}`}>\n                    {staffMember.email}\n                  </TableCell>\n                  <TableCell className=\"text-muted-foreground\" data-testid={`text-phone-${staffMember.id}`}>\n                    {staffMember.phone || \"-\"}\n                  </TableCell>\n                  <TableCell data-testid={`text-card-number-${staffMember.id}`}>\n                    {staffMember.bankCardNumber ? (\n                      <div className=\"flex items-center gap-1\">\n                        <CreditCard className=\"h-4 w-4 text-muted-foreground\" />\n                        <span className=\"font-mono\">****{staffMember.bankCardNumber}</span>\n                      </div>\n                    ) : (\n                      <span className=\"text-muted-foreground\">Not assigned</span>\n                    )}\n                  </TableCell>\n                  <TableCell data-testid={`status-active-${staffMember.id}`}>\n                    {staffMember.isActive ? (\n                      <Badge variant=\"outline\" className=\"text-green-600 border-green-600\">Active</Badge>\n                    ) : (\n                      <Badge variant=\"outline\" className=\"text-red-600 border-red-600\">Inactive</Badge>\n                    )}\n                  </TableCell>\n                  <TableCell className=\"text-right\">\n                    <Button\n                      size=\"icon\"\n                      variant=\"ghost\"\n                      onClick={() => openEditDialog(staffMember)}\n                      data-testid={`button-edit-${staffMember.id}`}\n                    >\n                      <Edit className=\"h-4 w-4\" />\n                    </Button>\n                  </TableCell>\n                </TableRow>\n              ))}\n            </TableBody>\n          </Table>\n        </CardContent>\n      </Card>\n\n      <Dialog open={!!editingUser} onOpenChange={() => setEditingUser(null)}>\n        <DialogContent data-testid=\"dialog-edit-staff\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\" data-testid=\"dialog-title\">\n              <Edit className=\"h-5 w-5\" />\n              Edit Staff Member\n            </DialogTitle>\n            <DialogDescription data-testid=\"dialog-description\">\n              Update details for {editingUser?.firstName} {editingUser?.lastName}\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"cardNumber\" className=\"flex items-center gap-2\">\n                <CreditCard className=\"h-4 w-4\" />\n                Bank Card Number (Last 6 Digits)\n              </Label>\n              <Input\n                id=\"cardNumber\"\n                value={cardNumber}\n                onChange={(e) => setCardNumber(e.target.value.replace(/\\D/g, \"\").slice(0, 6))}\n                placeholder=\"e.g. 639861\"\n                maxLength={6}\n                className=\"font-mono\"\n                data-testid=\"input-card-number\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Enter the last 6 digits of the staff member's bank card for automatic expense allocation\n              </p>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"phone\" className=\"flex items-center gap-2\">\n                <Phone className=\"h-4 w-4\" />\n                Phone Number\n              </Label>\n              <Input\n                id=\"phone\"\n                value={phone}\n                onChange={(e) => setPhone(e.target.value)}\n                placeholder=\"e.g. 0412 345 678\"\n                data-testid=\"input-phone\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"positionTitle\">Position Title</Label>\n              <Input\n                id=\"positionTitle\"\n                value={positionTitle}\n                onChange={(e) => setPositionTitle(e.target.value)}\n                placeholder=\"e.g. Production Manager\"\n                data-testid=\"input-position-title\"\n              />\n            </div>\n\n            <div className=\"flex items-center justify-between space-x-2 pt-2\">\n              <div>\n                <Label htmlFor=\"isActive\">Account Active</Label>\n                <p className=\"text-xs text-muted-foreground\">\n                  Inactive accounts cannot log in\n                </p>\n              </div>\n              <Switch\n                id=\"isActive\"\n                checked={isActive}\n                onCheckedChange={setIsActive}\n                data-testid=\"switch-is-active\"\n              />\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setEditingUser(null)}\n              data-testid=\"button-cancel\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleSave}\n              disabled={updateUserMutation.isPending}\n              data-testid=\"button-save\"\n            >\n              {updateUserMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":11079,"size_tokens":null}},"version":2}